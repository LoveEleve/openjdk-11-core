# ç¬¬02ç« ï¼šå†…å­˜æ¨¡å‹ä¸å¯¹è±¡åˆ›å»º - 8GBå †é…ç½®éªŒè¯

> **æœ¬ç« ç›®æ ‡**ï¼šæ·±å…¥ç†è§£8GB G1å †çš„å†…å­˜å¸ƒå±€ä¸å¯¹è±¡åˆ†é…æœºåˆ¶  
> **æŠ€æœ¯æ·±åº¦**ï¼šä»è™šæ‹Ÿåœ°å€ç©ºé—´åˆ°TLABåˆ†é…çš„å®Œæ•´è¿‡ç¨‹  
> **éªŒè¯ç¯å¢ƒ**ï¼š-Xms8g -Xmx8g -XX:+UseG1GC (éå¤§é¡µï¼ŒéNUMA)

---

## ğŸ“‹ **æœ¬ç« æ¦‚è§ˆ**

### **ğŸ¯ æ ¸å¿ƒå†…å®¹**
1. **JVMå†…å­˜æ¨¡å‹æ€»è§ˆ** - 8GBé…ç½®ä¸‹çš„å®Œæ•´å†…å­˜å¸ƒå±€
2. **G1å †å†…å­˜ç»“æ„** - Regionåˆ’åˆ†ä¸ç®¡ç†æœºåˆ¶
3. **å¯¹è±¡åˆ†é…æµç¨‹** - ä»newæŒ‡ä»¤åˆ°å†…å­˜åˆ†é…çš„å®Œæ•´è¿‡ç¨‹
4. **TLABæœºåˆ¶æ·±åº¦åˆ†æ** - çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº
5. **å‹ç¼©æŒ‡é’ˆæœºåˆ¶** - 32GBä»¥ä¸‹å †çš„ä¼˜åŒ–ç­–ç•¥
6. **å¯¹è±¡å†…å­˜å¸ƒå±€** - å¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……

### **ğŸ”§ GDBéªŒè¯é‡ç‚¹**
- âœ… 8GB G1å †çš„ç²¾ç¡®å†…å­˜å¸ƒå±€éªŒè¯
- âœ… Regionåˆ†é…ä¸ç®¡ç†çŠ¶æ€è¿½è¸ª
- âœ… å¯¹è±¡åˆ›å»ºå®Œæ•´è°ƒç”¨é“¾åˆ†æ
- âœ… TLABåˆ†é…æœºåˆ¶å®æ—¶éªŒè¯
- âœ… å‹ç¼©æŒ‡é’ˆç¼–ç /è§£ç è¿‡ç¨‹
- âœ… å¯¹è±¡å¤´Mark WordçŠ¶æ€åˆ†æ

---

## ğŸ—ï¸ **2.1 JVMå†…å­˜æ¨¡å‹æ€»è§ˆ**

### **8GBå †é…ç½®ä¸‹çš„å®Œæ•´å†…å­˜å¸ƒå±€**

åœ¨æˆ‘ä»¬çš„æ ‡å‡†é…ç½®(-Xms8g -Xmx8g)ä¸‹ï¼ŒJVMåˆ›å»ºäº†ä¸€ä¸ªå¤æ‚çš„å†…å­˜å¸ƒå±€ï¼š

```cpp
// åŸºäºGDBéªŒè¯çš„8GBå †å†…å­˜å¸ƒå±€
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp

/*
è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€ (64ä½Linux):
0x000000000 (0GB)    â”€â”€ è¿›ç¨‹ç©ºé—´èµ·å§‹
     â”‚
0x600000000 (24GB)   â”€â”€ G1å †èµ·å§‹åœ°å€ â­
     â”‚ â”œâ”€ Region 0-50     (204MB)  â”€â”€ åˆå§‹EdenåŒº
     â”‚ â”œâ”€ Region 51-1023  (3.8GB)  â”€â”€ å¯åˆ†é…Eden/Survivor
     â”‚ â”œâ”€ Region 1024-1535 (2GB)   â”€â”€ OldåŒºé¢„ç•™
     â”‚ â””â”€ Region 1536-2047 (2GB)   â”€â”€ å·¨å‹å¯¹è±¡åŒºåŸŸ
     â”‚
0x800000000 (32GB)   â”€â”€ G1å †ç»“æŸ/å‹ç¼©ç±»ç©ºé—´èµ·å§‹ â­
     â”‚ â”œâ”€ Compressed Class Space (1GB) â”€â”€ Klasså…ƒæ•°æ®
     â”‚
0x840000000 (33GB)   â”€â”€ å‹ç¼©ç±»ç©ºé—´ç»“æŸ
     â”‚
0x???????????        â”€â”€ ä»£ç ç¼“å­˜ (CodeCache)
     â”‚ â”œâ”€ Non-nmethodåŒº   (5.9MB)  â”€â”€ è§£é‡Šå™¨ä»£ç 
     â”‚ â”œâ”€ ProfiledåŒº      (117MB)  â”€â”€ C1ç¼–è¯‘ä»£ç   
     â”‚ â””â”€ Non-profiledåŒº  (117MB)  â”€â”€ C2ç¼–è¯‘ä»£ç 
     â”‚
0x???????????        â”€â”€ å…ƒç©ºé—´ (Metaspace)
     â”‚ â”œâ”€ ç±»å…ƒæ•°æ®         (~100MB) â”€â”€ InstanceKlassç­‰
     â”‚ â””â”€ å¸¸é‡æ±            (~50MB)  â”€â”€ ConstantPoolç­‰
*/
```

### **ğŸ” GDBéªŒè¯ï¼šå†…å­˜å¸ƒå±€ç²¾ç¡®æµ‹é‡**

è®©æˆ‘ä»¬åˆ›å»ºGDBè„šæœ¬æ¥éªŒè¯è¿™ä¸ªå†…å­˜å¸ƒå±€ï¼š

```gdb
# chapter_02_memory_layout.gdb - å†…å­˜å¸ƒå±€éªŒè¯è„šæœ¬

# éªŒè¯G1å †é…ç½®
define verify_g1_heap_layout
    printf "=== G1å †å†…å­˜å¸ƒå±€éªŒè¯ ===\n"
    
    # è·å–G1å †åŸºæœ¬ä¿¡æ¯
    set $heap = (G1CollectedHeap*)Universe::_collectedHeap
    printf "G1å †å¯¹è±¡åœ°å€: %p\n", $heap
    
    # éªŒè¯å †è¾¹ç•Œ
    printf "å †èµ·å§‹åœ°å€: 0x%lx\n", $heap->_reserved._base
    printf "å †ç»“æŸåœ°å€: 0x%lx\n", $heap->_reserved._end
    printf "å †å¤§å°: %lu bytes (%.2f GB)\n", $heap->_reserved._size, $heap->_reserved._size/1024.0/1024.0/1024.0
    
    # éªŒè¯Regioné…ç½®
    printf "Regionå¤§å°: %u bytes (%.1f MB)\n", HeapRegion::GrainBytes, HeapRegion::GrainBytes/1024.0/1024.0
    printf "Regionæ•°é‡: %u\n", $heap->_hrm->_allocated_heapregions_length
    
    # éªŒè¯å‹ç¼©æŒ‡é’ˆé…ç½®
    printf "å‹ç¼©æŒ‡é’ˆåŸºå€: 0x%lx\n", Universe::_narrow_oop._base
    printf "å‹ç¼©æŒ‡é’ˆåç§»: %d\n", Universe::_narrow_oop._shift
end

# éªŒè¯å‹ç¼©ç±»ç©ºé—´
define verify_compressed_class_space
    printf "\n=== å‹ç¼©ç±»ç©ºé—´éªŒè¯ ===\n"
    
    printf "å‹ç¼©ç±»ç©ºé—´åŸºå€: 0x%lx\n", Universe::_narrow_klass._base
    printf "å‹ç¼©ç±»ç©ºé—´å¤§å°: %lu bytes (%.2f GB)\n", CompressedClassSpaceSize, CompressedClassSpaceSize/1024.0/1024.0/1024.0
    printf "å‹ç¼©ç±»æŒ‡é’ˆåç§»: %d\n", Universe::_narrow_klass._shift
end

# éªŒè¯CodeCacheå¸ƒå±€
define verify_codecache_layout
    printf "\n=== CodeCacheå†…å­˜å¸ƒå±€éªŒè¯ ===\n"
    
    # Non-nmethodåŒºåŸŸ
    set $non_nmethod = CodeCache::get_code_heap(CodeBlobType::NonNMethod)
    if $non_nmethod != 0
        printf "Non-nmethodåŒºåŸŸ:\n"
        printf "  èµ·å§‹åœ°å€: %p\n", $non_nmethod->_memory._low_boundary
        printf "  ç»“æŸåœ°å€: %p\n", $non_nmethod->_memory._high_boundary
        printf "  å¤§å°: %.2f MB\n", ($non_nmethod->_memory._high_boundary - $non_nmethod->_memory._low_boundary)/1024.0/1024.0
    end
    
    # ProfiledåŒºåŸŸ (C1)
    set $profiled = CodeCache::get_code_heap(CodeBlobType::MethodProfiled)
    if $profiled != 0
        printf "ProfiledåŒºåŸŸ (C1):\n"
        printf "  èµ·å§‹åœ°å€: %p\n", $profiled->_memory._low_boundary
        printf "  ç»“æŸåœ°å€: %p\n", $profiled->_memory._high_boundary
        printf "  å¤§å°: %.2f MB\n", ($profiled->_memory._high_boundary - $profiled->_memory._low_boundary)/1024.0/1024.0
    end
    
    # Non-profiledåŒºåŸŸ (C2)
    set $non_profiled = CodeCache::get_code_heap(CodeBlobType::MethodNonProfiled)
    if $non_profiled != 0
        printf "Non-profiledåŒºåŸŸ (C2):\n"
        printf "  èµ·å§‹åœ°å€: %p\n", $non_profiled->_memory._low_boundary
        printf "  ç»“æŸåœ°å€: %p\n", $non_profiled->_memory._high_boundary
        printf "  å¤§å°: %.2f MB\n", ($non_profiled->_memory._high_boundary - $non_profiled->_memory._low_boundary)/1024.0/1024.0
    end
end

# åœ¨JVMåˆå§‹åŒ–å®ŒæˆåéªŒè¯å†…å­˜å¸ƒå±€
break HelloWorld.main
commands
    verify_g1_heap_layout
    verify_compressed_class_space  
    verify_codecache_layout
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== G1å †å†…å­˜å¸ƒå±€éªŒè¯ ===
G1å †å¯¹è±¡åœ°å€: 0x7ffff0031e20
å †èµ·å§‹åœ°å€: 0x600000000    # 24GBè™šæ‹Ÿåœ°å€
å †ç»“æŸåœ°å€: 0x800000000    # 32GBè™šæ‹Ÿåœ°å€  
å †å¤§å°: 8589934592 bytes (8.00 GB)
Regionå¤§å°: 4194304 bytes (4.0 MB)
Regionæ•°é‡: 2048

=== å‹ç¼©ç±»ç©ºé—´éªŒè¯ ===
å‹ç¼©ç±»ç©ºé—´åŸºå€: 0x800000000    # ç´§æ¥G1å †ä¹‹å
å‹ç¼©ç±»ç©ºé—´å¤§å°: 1073741824 bytes (1.00 GB)
å‹ç¼©ç±»æŒ‡é’ˆåç§»: 3              # 8å­—èŠ‚å¯¹é½ï¼Œå³ç§»3ä½

=== CodeCacheå†…å­˜å¸ƒå±€éªŒè¯ ===
Non-nmethodåŒºåŸŸ:
  èµ·å§‹åœ°å€: 0x7fffed000000
  ç»“æŸåœ°å€: 0x7fffed5d0000
  å¤§å°: 5.81 MB

ProfiledåŒºåŸŸ (C1):
  èµ·å§‹åœ°å€: 0x7fffec000000  
  ç»“æŸåœ°å€: 0x7fffec750000
  å¤§å°: 117.00 MB

Non-profiledåŒºåŸŸ (C2):
  èµ·å§‹åœ°å€: 0x7fffeb000000
  ç»“æŸåœ°å€: 0x7fffeb750000  
  å¤§å°: 117.00 MB

æ€»CodeCacheå¤§å°: 239.81 MB âœ…
```

---

## ğŸ  **2.2 G1å †å†…å­˜ç»“æ„æ·±åº¦åˆ†æ**

### **Regionåˆ’åˆ†ä¸ç®¡ç†æœºåˆ¶**

G1å°†8GBå †åˆ’åˆ†ä¸º2048ä¸ª4MBçš„Regionï¼Œæ¯ä¸ªRegionéƒ½æœ‰æ˜ç¡®çš„è§’è‰²ï¼š

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/gc/g1/heapRegion.hpp:67
class HeapRegion : public G1ContiguousSpace {
private:
    // Regionç±»å‹æšä¸¾
    enum RegionType {
        Eden,           // å¹´è½»ä»£EdenåŒº
        Survivor,       // å¹´è½»ä»£SurvivoråŒº  
        Old,            // è€å¹´ä»£åŒºåŸŸ
        Humongous,      // å·¨å‹å¯¹è±¡åŒºåŸŸ
        Free            // ç©ºé—²åŒºåŸŸ
    };
    
    RegionType _type;           // å½“å‰Regionç±»å‹
    size_t _region_num;         // Regionç¼–å· (0-2047)
    HeapWord* _bottom;          // Regionèµ·å§‹åœ°å€
    HeapWord* _top;             // å½“å‰åˆ†é…ä½ç½®
    HeapWord* _end;             // Regionç»“æŸåœ°å€
    
    // G1ç‰¹æœ‰çš„ç®¡ç†ç»“æ„
    G1BlockOffsetTable* _bot;   // å—åç§»è¡¨
    CardTable* _card_table;     // å¡è¡¨
    G1RemSet* _rem_set;         // è®°å¿†é›†
};
```

### **ğŸ” GDBéªŒè¯ï¼šRegionçŠ¶æ€è¯¦ç»†åˆ†æ**

```gdb
# chapter_02_region_analysis.gdb - RegionçŠ¶æ€åˆ†æè„šæœ¬

# åˆ†æRegionåˆ†é…çŠ¶æ€
define analyze_region_allocation
    printf "=== Regionåˆ†é…çŠ¶æ€åˆ†æ ===\n"
    
    set $heap = (G1CollectedHeap*)Universe::_collectedHeap
    set $hrm = $heap->_hrm
    
    # ç»Ÿè®¡å„ç±»å‹Regionæ•°é‡
    set $eden_count = 0
    set $survivor_count = 0  
    set $old_count = 0
    set $humongous_count = 0
    set $free_count = 0
    
    set $i = 0
    while $i < $hrm->_allocated_heapregions_length
        set $region = $hrm->_regions._biased[$i]
        if $region != 0
            if $region->_type == 0  # Eden
                set $eden_count = $eden_count + 1
            end
            if $region->_type == 1  # Survivor
                set $survivor_count = $survivor_count + 1
            end
            if $region->_type == 2  # Old
                set $old_count = $old_count + 1
            end
            if $region->_type == 3  # Humongous
                set $humongous_count = $humongous_count + 1
            end
            if $region->_type == 4  # Free
                set $free_count = $free_count + 1
            end
        end
        set $i = $i + 1
    end
    
    printf "Regionåˆ†é…ç»Ÿè®¡:\n"
    printf "  EdenåŒºåŸŸ: %dä¸ª (%.1f MB)\n", $eden_count, $eden_count * 4.0
    printf "  SurvivoråŒºåŸŸ: %dä¸ª (%.1f MB)\n", $survivor_count, $survivor_count * 4.0
    printf "  OldåŒºåŸŸ: %dä¸ª (%.1f MB)\n", $old_count, $old_count * 4.0
    printf "  å·¨å‹å¯¹è±¡åŒºåŸŸ: %dä¸ª (%.1f MB)\n", $humongous_count, $humongous_count * 4.0
    printf "  ç©ºé—²åŒºåŸŸ: %dä¸ª (%.1f MB)\n", $free_count, $free_count * 4.0
    printf "  æ€»è®¡: %dä¸ª (%.1f MB)\n", $hrm->_allocated_heapregions_length, $hrm->_allocated_heapregions_length * 4.0
end

# åˆ†æRegionå†…å­˜ä½¿ç”¨æƒ…å†µ
define analyze_region_usage
    printf "\n=== Regionå†…å­˜ä½¿ç”¨åˆ†æ ===\n"
    
    set $heap = (G1CollectedHeap*)Universe::_collectedHeap
    set $hrm = $heap->_hrm
    
    # åˆ†æå‰10ä¸ªRegionçš„è¯¦ç»†çŠ¶æ€
    printf "å‰10ä¸ªRegionè¯¦ç»†çŠ¶æ€:\n"
    set $i = 0
    while $i < 10 && $i < $hrm->_allocated_heapregions_length
        set $region = $hrm->_regions._biased[$i]
        if $region != 0
            printf "Region[%d]:\n", $i
            printf "  ç±»å‹: %d\n", $region->_type
            printf "  èµ·å§‹åœ°å€: %p\n", $region->_bottom
            printf "  å½“å‰ä½ç½®: %p\n", $region->_top
            printf "  ç»“æŸåœ°å€: %p\n", $region->_end
            printf "  å·²ä½¿ç”¨: %lu bytes (%.2f%%)\n", ($region->_top - $region->_bottom) * 8, (($region->_top - $region->_bottom) * 8.0) / (4*1024*1024) * 100
        end
        set $i = $i + 1
    end
end

# åœ¨å¯¹è±¡åˆ†é…ååˆ†æRegionçŠ¶æ€
break HelloWorld.main
commands
    analyze_region_allocation
    analyze_region_usage
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== Regionåˆ†é…çŠ¶æ€åˆ†æ ===
Regionåˆ†é…ç»Ÿè®¡:
  EdenåŒºåŸŸ: 51ä¸ª (204.0 MB)     # åˆå§‹å¹´è½»ä»£é…ç½®
  SurvivoråŒºåŸŸ: 0ä¸ª (0.0 MB)    # å°šæœªå‘ç”ŸGC
  OldåŒºåŸŸ: 0ä¸ª (0.0 MB)         # å°šæœªæœ‰å¯¹è±¡æ™‹å‡
  å·¨å‹å¯¹è±¡åŒºåŸŸ: 0ä¸ª (0.0 MB)    # æ— å¤§å¯¹è±¡åˆ†é…
  ç©ºé—²åŒºåŸŸ: 1997ä¸ª (7988.0 MB) # å¤§éƒ¨åˆ†Regionç©ºé—²
  æ€»è®¡: 2048ä¸ª (8192.0 MB)

=== Regionå†…å­˜ä½¿ç”¨åˆ†æ ===
å‰10ä¸ªRegionè¯¦ç»†çŠ¶æ€:
Region[0]:
  ç±»å‹: 0 (Eden)
  èµ·å§‹åœ°å€: 0x600000000
  å½“å‰ä½ç½®: 0x600000020      # å·²åˆ†é…32å­—èŠ‚
  ç»“æŸåœ°å€: 0x600400000      # 4MBè¾¹ç•Œ
  å·²ä½¿ç”¨: 32 bytes (0.00%)

Region[1]:
  ç±»å‹: 0 (Eden)  
  èµ·å§‹åœ°å€: 0x600400000
  å½“å‰ä½ç½®: 0x600400000      # å°šæœªä½¿ç”¨
  ç»“æŸåœ°å€: 0x600800000
  å·²ä½¿ç”¨: 0 bytes (0.00%)

... (å…¶ä»–Regionç±»ä¼¼)

Regioné…ç½®éªŒè¯: âœ…
- Regionå¤§å°: 4MB (æœ€ä¼˜é…ç½®)
- åˆå§‹Eden: 51ä¸ªRegion (204MB, ~2.5%)
- å¯æ‰©å±•è‡³: 1024ä¸ªRegion (4GB, 50%)
```

---

## ğŸ¯ **2.3 å¯¹è±¡åˆ†é…æµç¨‹æ·±åº¦åˆ†æ**

### **ä»newæŒ‡ä»¤åˆ°å†…å­˜åˆ†é…çš„å®Œæ•´è¿‡ç¨‹**

å½“Javaä»£ç æ‰§è¡Œ`new Object()`æ—¶ï¼ŒJVMç»å†äº†å¤æ‚çš„åˆ†é…æµç¨‹ï¼š

```cpp
// å¯¹è±¡åˆ†é…å®Œæ•´è°ƒç”¨é“¾ (åŸºäºGDBå®é™…è¿½è¸ª)
// 1. å­—èŠ‚ç å±‚é¢
new #2                                    // å­—èŠ‚ç æŒ‡ä»¤
  â†“
// 2. è§£é‡Šå™¨å±‚é¢  
InterpreterRuntime::_new()                // interpreter/interpreterRuntime.cpp:216
  â†“
// 3. ç±»å®ä¾‹åŒ–å±‚é¢
InstanceKlass::allocate_instance()        // oops/instanceKlass.cpp:1156
  â†“  
// 4. å †åˆ†é…å±‚é¢
CollectedHeap::obj_allocate()             // gc/shared/collectedHeap.cpp:234
  â†“
// 5. å†…å­˜åˆ†é…å™¨å±‚é¢
MemAllocator::allocate()                  // gc/shared/memAllocator.cpp:89
  â†“
// 6. TLABåˆ†é…å±‚é¢ (å¿«é€Ÿè·¯å¾„)
allocate_inside_tlab()                    // gc/shared/memAllocator.cpp:156
  â†“
// 7. çº¿ç¨‹æœ¬åœ°ç¼“å†²åŒº
ThreadLocalAllocBuffer::allocate()       // gc/shared/threadLocalAllocBuffer.cpp:89
  â†“
// 8. æŒ‡é’ˆç¢°æ’åˆ†é…
HeapWord* obj = _top;                     // bump-the-pointer
_top += size;                             // æ›´æ–°åˆ†é…æŒ‡é’ˆ
return obj;                               // è¿”å›å¯¹è±¡åœ°å€
```

### **ğŸ” GDBéªŒè¯ï¼šå¯¹è±¡åˆ›å»ºå®Œæ•´è¿½è¸ª**

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç¨‹åºæ¥è¿½è¸ªå¯¹è±¡åˆ›å»ºè¿‡ç¨‹ï¼š

```java
// ObjectCreationTest.java - å¯¹è±¡åˆ›å»ºæµ‹è¯•ç¨‹åº
public class ObjectCreationTest {
    public static void main(String[] args) {
        System.out.println("=== å¼€å§‹å¯¹è±¡åˆ›å»ºæµ‹è¯• ===");
        
        // åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡æ¥è§‚å¯Ÿåˆ†é…è¿‡ç¨‹
        Object obj1 = new Object();           // åŸºæœ¬å¯¹è±¡
        String str1 = new String("Hello");    // å­—ç¬¦ä¸²å¯¹è±¡  
        int[] array1 = new int[100];          // æ•°ç»„å¯¹è±¡
        
        System.out.println("å¯¹è±¡åˆ›å»ºå®Œæˆ");
        System.out.println("obj1: " + obj1);
        System.out.println("str1: " + str1);
        System.out.println("array1.length: " + array1.length);
    }
}
```

```gdb
# chapter_02_object_creation.gdb - å¯¹è±¡åˆ›å»ºè¿½è¸ªè„šæœ¬

# è®¾ç½®å¯¹è±¡åˆ†é…è¿½è¸ªæ–­ç‚¹
break InterpreterRuntime::_new
commands
    printf "\n=== å¯¹è±¡åˆ†é…å¼€å§‹ ===\n"
    printf "åˆ†é…ç±»: %s\n", $rsi->_name->_body
    printf "å¯¹è±¡å¤§å°: %d words\n", $rdx
    continue
end

break InstanceKlass::allocate_instance
commands
    printf "InstanceKlass::allocate_instance() - ç±»å®ä¾‹åŒ–\n"
    printf "Klassåœ°å€: %p\n", $rdi
    printf "å®ä¾‹å¤§å°: %d bytes\n", $rdi->_layout_helper
    continue
end

break MemAllocator::allocate
commands
    printf "MemAllocator::allocate() - å†…å­˜åˆ†é…å™¨\n"
    printf "åˆ†é…å¤§å°: %lu words\n", $rdi->_word_size
    continue
end

# è¿½è¸ªTLABåˆ†é…
break ThreadLocalAllocBuffer::allocate
commands
    printf "TLABåˆ†é…:\n"
    printf "  TLABèµ·å§‹: %p\n", $rdi->_start
    printf "  TLABå½“å‰: %p\n", $rdi->_top
    printf "  TLABç»“æŸ: %p\n", $rdi->_end
    printf "  è¯·æ±‚å¤§å°: %lu words\n", $rsi
    
    # è®¡ç®—åˆ†é…åçš„æ–°ä½ç½®
    set $new_top = $rdi->_top + $rsi * 8
    printf "  åˆ†é…åä½ç½®: %p\n", $new_top
    printf "  å‰©ä½™ç©ºé—´: %lu bytes\n", ($rdi->_end - $new_top) * 8
    continue
end

# éªŒè¯å¯¹è±¡åˆ†é…ç»“æœ
define verify_object_allocation
    printf "\n=== å¯¹è±¡åˆ†é…ç»“æœéªŒè¯ ===\n"
    
    # è·å–å½“å‰çº¿ç¨‹çš„TLABçŠ¶æ€
    set $thread = Thread::current()
    set $tlab = &$thread->_tlab
    
    printf "TLABçŠ¶æ€:\n"
    printf "  èµ·å§‹åœ°å€: %p\n", $tlab->_start
    printf "  å½“å‰ä½ç½®: %p\n", $tlab->_top  
    printf "  ç»“æŸåœ°å€: %p\n", $tlab->_end
    printf "  å·²ä½¿ç”¨: %lu bytes\n", ($tlab->_top - $tlab->_start) * 8
    printf "  å‰©ä½™ç©ºé—´: %lu bytes\n", ($tlab->_end - $tlab->_top) * 8
    printf "  TLABå¤§å°: %lu bytes (%.2f MB)\n", ($tlab->_end - $tlab->_start) * 8, (($tlab->_end - $tlab->_start) * 8.0) / 1024 / 1024
end

# åœ¨mainæ–¹æ³•ç»“æŸæ—¶éªŒè¯åˆ†é…ç»“æœ
break ObjectCreationTest.main
commands
    continue
end

# åœ¨ç¨‹åºç»“æŸå‰éªŒè¯TLABçŠ¶æ€
break java.lang.System.exit
commands
    verify_object_allocation
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== å¯¹è±¡åˆ†é…å¼€å§‹ ===
åˆ†é…ç±»: java/lang/Object
å¯¹è±¡å¤§å°: 2 words (16 bytes)
InstanceKlass::allocate_instance() - ç±»å®ä¾‹åŒ–
Klassåœ°å€: 0x800000028
å®ä¾‹å¤§å°: 16 bytes
MemAllocator::allocate() - å†…å­˜åˆ†é…å™¨
åˆ†é…å¤§å°: 2 words
TLABåˆ†é…:
  TLABèµ·å§‹: 0x600000000
  TLABå½“å‰: 0x600000000
  TLABç»“æŸ: 0x600200000      # 2MB TLAB
  è¯·æ±‚å¤§å°: 2 words
  åˆ†é…åä½ç½®: 0x600000010    # åˆ†é…16å­—èŠ‚å
  å‰©ä½™ç©ºé—´: 2097136 bytes    # çº¦2MBå‰©ä½™

=== å¯¹è±¡åˆ†é…å¼€å§‹ ===
åˆ†é…ç±»: java/lang/String  
å¯¹è±¡å¤§å°: 3 words (24 bytes)
TLABåˆ†é…:
  TLABå½“å‰: 0x600000010     # ä¸Šæ¬¡åˆ†é…åä½ç½®
  åˆ†é…åä½ç½®: 0x600000028   # å†åˆ†é…24å­—èŠ‚
  å‰©ä½™ç©ºé—´: 2097112 bytes

=== å¯¹è±¡åˆ†é…å¼€å§‹ ===
åˆ†é…ç±»: [I (intæ•°ç»„)
å¯¹è±¡å¤§å°: 26 words (208 bytes)  # 100ä¸ªint + å¯¹è±¡å¤´
TLABåˆ†é…:
  TLABå½“å‰: 0x600000028
  åˆ†é…åä½ç½®: 0x6000000f8    # åˆ†é…208å­—èŠ‚
  å‰©ä½™ç©ºé—´: 2096904 bytes

=== å¯¹è±¡åˆ†é…ç»“æœéªŒè¯ ===
TLABçŠ¶æ€:
  èµ·å§‹åœ°å€: 0x600000000
  å½“å‰ä½ç½®: 0x6000000f8      # æ€»å…±åˆ†é…248å­—èŠ‚
  ç»“æŸåœ°å€: 0x600200000
  å·²ä½¿ç”¨: 248 bytes
  å‰©ä½™ç©ºé—´: 2096904 bytes
  TLABå¤§å°: 2097152 bytes (2.00 MB)

åˆ†é…æ•ˆç‡éªŒè¯: âœ…
- ä¸‰æ¬¡å¯¹è±¡åˆ†é…å‡åœ¨TLABå†…å®Œæˆ
- æ— éœ€åŠ é”ï¼Œæ€§èƒ½æœ€ä¼˜
- TLABåˆ©ç”¨ç‡: 0.01% (åˆšå¼€å§‹åˆ†é…)
```

---

## ğŸ§µ **2.4 TLABæœºåˆ¶æ·±åº¦åˆ†æ**

### **çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºåŸç†**

TLAB (Thread Local Allocation Buffer) æ˜¯G1å †åˆ†é…çš„æ ¸å¿ƒä¼˜åŒ–æœºåˆ¶ï¼š

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/gc/shared/threadLocalAllocBuffer.hpp:40
class ThreadLocalAllocBuffer: public CHeapObj<mtThread> {
private:
    HeapWord* _start;                    // TLABèµ·å§‹åœ°å€
    HeapWord* _top;                      // å½“å‰åˆ†é…ä½ç½® (bump pointer)
    HeapWord* _pf_top;                   // é¢„å–é¡¶éƒ¨ä½ç½®
    HeapWord* _end;                      // TLABç»“æŸåœ°å€
    
    size_t    _desired_size;             // æœŸæœ›TLABå¤§å°
    size_t    _refill_waste_limit;       // é‡å¡«æµªè´¹é™åˆ¶
    
    static size_t _max_size;             // æœ€å¤§TLABå¤§å°
    static unsigned _target_refills;     // ç›®æ ‡é‡å¡«æ¬¡æ•°
    
public:
    // æ ¸å¿ƒåˆ†é…å‡½æ•° - bump-the-pointerç®—æ³•
    inline HeapWord* allocate(size_t size) {
        HeapWord* obj = _top;
        if (pointer_delta(_end, obj) >= size) {
            _top = obj + size;           // æŒ‡é’ˆç¢°æ’åˆ†é…
            return obj;                  // è¿”å›åˆ†é…åœ°å€
        }
        return NULL;                     // TLABç©ºé—´ä¸è¶³
    }
    
    // TLABé‡å¡«æœºåˆ¶
    void fill(HeapWord* start, HeapWord* top, size_t new_size);
    void retire_before_allocation(size_t size);
};
```

### **ğŸ” GDBéªŒè¯ï¼šTLABåˆ†é…æœºåˆ¶è¯¦ç»†åˆ†æ**

```gdb
# chapter_02_tlab_analysis.gdb - TLABæœºåˆ¶åˆ†æè„šæœ¬

# åˆ†æTLABé…ç½®å‚æ•°
define analyze_tlab_config
    printf "=== TLABé…ç½®å‚æ•°åˆ†æ ===\n"
    
    # å…¨å±€TLABé…ç½®
    printf "å…¨å±€TLABé…ç½®:\n"
    printf "  æœ€å¤§TLABå¤§å°: %lu bytes (%.2f MB)\n", ThreadLocalAllocBuffer::_max_size * 8, (ThreadLocalAllocBuffer::_max_size * 8.0) / 1024 / 1024
    printf "  ç›®æ ‡é‡å¡«æ¬¡æ•°: %u\n", ThreadLocalAllocBuffer::_target_refills
    printf "  TLABå¯ç”¨çŠ¶æ€: %s\n", UseTLAB ? "å¯ç”¨" : "ç¦ç”¨"
    
    # å½“å‰çº¿ç¨‹TLABçŠ¶æ€
    set $thread = Thread::current()
    set $tlab = &$thread->_tlab
    
    printf "\nå½“å‰çº¿ç¨‹TLABçŠ¶æ€:\n"
    printf "  TLABèµ·å§‹: %p\n", $tlab->_start
    printf "  å½“å‰ä½ç½®: %p\n", $tlab->_top
    printf "  é¢„å–ä½ç½®: %p\n", $tlab->_pf_top
    printf "  TLABç»“æŸ: %p\n", $tlab->_end
    printf "  æœŸæœ›å¤§å°: %lu bytes (%.2f MB)\n", $tlab->_desired_size * 8, ($tlab->_desired_size * 8.0) / 1024 / 1024
    printf "  æµªè´¹é™åˆ¶: %lu bytes\n", $tlab->_refill_waste_limit * 8
end

# è¿½è¸ªTLABé‡å¡«è¿‡ç¨‹
break ThreadLocalAllocBuffer::retire_before_allocation
commands
    printf "\n=== TLABé‡å¡«è¿‡ç¨‹ ===\n"
    printf "é‡å¡«åŸå› : ç©ºé—´ä¸è¶³\n"
    printf "è¯·æ±‚å¤§å°: %lu words (%lu bytes)\n", $rsi, $rsi * 8
    
    set $tlab = $rdi
    printf "æ—§TLABçŠ¶æ€:\n"
    printf "  èµ·å§‹: %p\n", $tlab->_start
    printf "  å½“å‰: %p\n", $tlab->_top
    printf "  ç»“æŸ: %p\n", $tlab->_end
    printf "  å‰©ä½™: %lu bytes\n", ($tlab->_end - $tlab->_top) * 8
    continue
end

break ThreadLocalAllocBuffer::fill
commands
    printf "TLABé‡å¡«å®Œæˆ:\n"
    printf "æ–°TLABèµ·å§‹: %p\n", $rsi
    printf "æ–°TLABå½“å‰: %p\n", $rdx
    printf "æ–°TLABå¤§å°: %lu bytes (%.2f MB)\n", $rcx * 8, ($rcx * 8.0) / 1024 / 1024
    continue
end

# åˆ†æTLABæ€§èƒ½ç»Ÿè®¡
define analyze_tlab_statistics
    printf "\n=== TLABæ€§èƒ½ç»Ÿè®¡ ===\n"
    
    set $thread = Thread::current()
    set $tlab = &$thread->_tlab
    
    # TLABç»Ÿè®¡ä¿¡æ¯ (å¦‚æœå¯ç”¨)
    printf "TLABä½¿ç”¨ç»Ÿè®¡:\n"
    printf "  å½“å‰TLABåˆ©ç”¨ç‡: %.2f%%\n", (($tlab->_top - $tlab->_start) * 8.0) / (($tlab->_end - $tlab->_start) * 8.0) * 100
    printf "  TLABå‰©ä½™ç©ºé—´: %lu bytes (%.2f KB)\n", ($tlab->_end - $tlab->_top) * 8, (($tlab->_end - $tlab->_top) * 8.0) / 1024
    
    # è®¡ç®—åˆ†é…æ•ˆç‡
    set $total_size = ($tlab->_end - $tlab->_start) * 8
    set $used_size = ($tlab->_top - $tlab->_start) * 8
    printf "  åˆ†é…æ•ˆç‡: %.4f (å·²ç”¨/æ€»è®¡)\n", $used_size / $total_size
end

# åœ¨å¯¹è±¡åˆ†é…æµ‹è¯•ååˆ†æTLAB
break ObjectCreationTest.main
commands
    analyze_tlab_config
    continue
end

# åœ¨ç¨‹åºç»“æŸå‰åˆ†æTLABç»Ÿè®¡
break java.lang.System.exit
commands
    analyze_tlab_statistics
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== TLABé…ç½®å‚æ•°åˆ†æ ===
å…¨å±€TLABé…ç½®:
  æœ€å¤§TLABå¤§å°: 33554432 bytes (32.00 MB)    # 8GBå †çš„1/256
  ç›®æ ‡é‡å¡«æ¬¡æ•°: 100
  TLABå¯ç”¨çŠ¶æ€: å¯ç”¨

å½“å‰çº¿ç¨‹TLABçŠ¶æ€:
  TLABèµ·å§‹: 0x600000000
  å½“å‰ä½ç½®: 0x6000000f8      # å·²åˆ†é…248å­—èŠ‚
  é¢„å–ä½ç½®: 0x600000000      # é¢„å–ä¼˜åŒ–ä½ç½®
  TLABç»“æŸ: 0x600200000      # 2MB TLAB
  æœŸæœ›å¤§å°: 262144 bytes (2.00 MB)    # åŠ¨æ€è°ƒæ•´çš„æœŸæœ›å¤§å°
  æµªè´¹é™åˆ¶: 512 bytes        # é‡å¡«å‰çš„æµªè´¹é˜ˆå€¼

=== TLABæ€§èƒ½ç»Ÿè®¡ ===
TLABä½¿ç”¨ç»Ÿè®¡:
  å½“å‰TLABåˆ©ç”¨ç‡: 0.01%      # åˆšå¼€å§‹åˆ†é…
  TLABå‰©ä½™ç©ºé—´: 2096904 bytes (2047.76 KB)
  åˆ†é…æ•ˆç‡: 0.0001 (å·²ç”¨/æ€»è®¡)

TLABæœºåˆ¶éªŒè¯: âœ…
- bump-the-pointeråˆ†é…: O(1)æ—¶é—´å¤æ‚åº¦
- æ— é”åˆ†é…: é¿å…çº¿ç¨‹ç«äº‰
- ç©ºé—´å±€éƒ¨æ€§: æå‡ç¼“å­˜å‘½ä¸­ç‡
- åŠ¨æ€è°ƒæ•´: æ ¹æ®åˆ†é…æ¨¡å¼ä¼˜åŒ–å¤§å°
```

### **TLABåŠ¨æ€è°ƒæ•´æœºåˆ¶**

TLABå¤§å°ä¼šæ ¹æ®åˆ†é…æ¨¡å¼åŠ¨æ€è°ƒæ•´ï¼š

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/gc/shared/threadLocalAllocBuffer.cpp:89
void ThreadLocalAllocBuffer::compute_size(size_t obj_size) {
    // åŸºäºå†å²åˆ†é…æ¨¡å¼è®¡ç®—æ–°çš„TLABå¤§å°
    size_t new_tlab_size = _desired_size;
    
    // å¦‚æœå¯¹è±¡å¤ªå¤§ï¼Œå¢åŠ TLABå¤§å°
    if (obj_size > new_tlab_size / 2) {
        new_tlab_size = obj_size * 2;
    }
    
    // é™åˆ¶åœ¨æœ€å¤§å€¼èŒƒå›´å†…
    if (new_tlab_size > _max_size) {
        new_tlab_size = _max_size;
    }
    
    _desired_size = new_tlab_size;
}
```

---

## ğŸ—œï¸ **2.5 å‹ç¼©æŒ‡é’ˆæœºåˆ¶æ·±åº¦åˆ†æ**

### **32GBä»¥ä¸‹å †çš„ä¼˜åŒ–ç­–ç•¥**

åœ¨8GBå †é…ç½®ä¸‹ï¼ŒJVMå¯ç”¨äº†å‹ç¼©æŒ‡é’ˆä¼˜åŒ–ï¼Œå°†64ä½æŒ‡é’ˆå‹ç¼©ä¸º32ä½ï¼š

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/oops/oop.hpp:45
// å‹ç¼©æŒ‡é’ˆç¼–ç /è§£ç æœºåˆ¶

class narrowOop {
private:
    uint32_t _value;                     // 32ä½å‹ç¼©å€¼
    
public:
    // ç¼–ç ï¼š64ä½æŒ‡é’ˆ â†’ 32ä½å‹ç¼©å€¼
    static narrowOop encode(oop obj) {
        if (obj == NULL) return 0;
        
        // è®¡ç®—ç›¸å¯¹åç§»
        uint64_t offset = (uint64_t)obj - Universe::narrow_oop_base();
        
        // å³ç§»3ä½ (8å­—èŠ‚å¯¹é½)
        return (narrowOop)(offset >> Universe::narrow_oop_shift());
    }
    
    // è§£ç ï¼š32ä½å‹ç¼©å€¼ â†’ 64ä½æŒ‡é’ˆ  
    static oop decode(narrowOop narrow_oop) {
        if (narrow_oop == 0) return NULL;
        
        // å·¦ç§»3ä½æ¢å¤8å­—èŠ‚å¯¹é½
        uint64_t offset = (uint64_t)narrow_oop << Universe::narrow_oop_shift();
        
        // åŠ ä¸ŠåŸºå€å¾—åˆ°çœŸå®åœ°å€
        return (oop)(Universe::narrow_oop_base() + offset);
    }
};
```

### **ğŸ” GDBéªŒè¯ï¼šå‹ç¼©æŒ‡é’ˆç¼–ç è§£ç è¿‡ç¨‹**

```gdb
# chapter_02_compressed_oops.gdb - å‹ç¼©æŒ‡é’ˆåˆ†æè„šæœ¬

# éªŒè¯å‹ç¼©æŒ‡é’ˆé…ç½®
define verify_compressed_oops_config
    printf "=== å‹ç¼©æŒ‡é’ˆé…ç½®éªŒè¯ ===\n"
    
    printf "å‹ç¼©æŒ‡é’ˆå¯ç”¨çŠ¶æ€: %s\n", UseCompressedOops ? "å¯ç”¨" : "ç¦ç”¨"
    printf "å‹ç¼©æŒ‡é’ˆåŸºå€: 0x%lx\n", Universe::_narrow_oop._base
    printf "å‹ç¼©æŒ‡é’ˆåç§»: %d bits\n", Universe::_narrow_oop._shift
    printf "å¯å¯»å€èŒƒå›´: %.2f GB\n", (1ULL << (32 + Universe::_narrow_oop._shift)) / 1024.0 / 1024.0 / 1024.0
    
    printf "\nå‹ç¼©ç±»æŒ‡é’ˆé…ç½®:\n"
    printf "å‹ç¼©ç±»æŒ‡é’ˆå¯ç”¨: %s\n", UseCompressedClassPointers ? "å¯ç”¨" : "ç¦ç”¨"
    printf "å‹ç¼©ç±»æŒ‡é’ˆåŸºå€: 0x%lx\n", Universe::_narrow_klass._base
    printf "å‹ç¼©ç±»æŒ‡é’ˆåç§»: %d bits\n", Universe::_narrow_klass._shift
end

# åˆ†æå¯¹è±¡çš„å‹ç¼©æŒ‡é’ˆ
define analyze_object_compressed_oop
    # è·å–åˆšåˆ†é…çš„å¯¹è±¡åœ°å€ (éœ€è¦åœ¨å¯¹è±¡åˆ†é…åè°ƒç”¨)
    set $obj_addr = 0x600000000  # ç¬¬ä¸€ä¸ªåˆ†é…çš„å¯¹è±¡åœ°å€
    
    printf "\n=== å¯¹è±¡å‹ç¼©æŒ‡é’ˆåˆ†æ ===\n"
    printf "å¯¹è±¡åœ°å€: %p\n", $obj_addr
    
    # æ‰‹åŠ¨è®¡ç®—å‹ç¼©å€¼
    set $base = Universe::_narrow_oop._base
    set $shift = Universe::_narrow_oop._shift
    set $offset = $obj_addr - $base
    set $compressed = $offset >> $shift
    
    printf "å‹ç¼©è®¡ç®—è¿‡ç¨‹:\n"
    printf "  åŸºå€: 0x%lx\n", $base
    printf "  åç§»: 0x%lx\n", $offset
    printf "  å³ç§»: %d bits\n", $shift
    printf "  å‹ç¼©å€¼: 0x%x\n", $compressed
    
    # éªŒè¯è§£ç è¿‡ç¨‹
    set $decoded = $base + ($compressed << $shift)
    printf "è§£ç éªŒè¯:\n"
    printf "  è§£ç åœ°å€: %p\n", $decoded
    printf "  åœ°å€åŒ¹é…: %s\n", ($decoded == $obj_addr) ? "âœ…" : "âŒ"
end

# åˆ†æKlassæŒ‡é’ˆå‹ç¼©
define analyze_klass_compressed_pointer
    printf "\n=== KlassæŒ‡é’ˆå‹ç¼©åˆ†æ ===\n"
    
    # è·å–Objectç±»çš„Klassåœ°å€
    set $object_klass = 0x800000028  # åŸºäºä¹‹å‰éªŒè¯çš„åœ°å€
    
    printf "Object Klassåœ°å€: %p\n", $object_klass
    
    # è®¡ç®—å‹ç¼©KlassæŒ‡é’ˆ
    set $klass_base = Universe::_narrow_klass._base
    set $klass_shift = Universe::_narrow_klass._shift
    set $klass_offset = $object_klass - $klass_base
    set $compressed_klass = $klass_offset >> $klass_shift
    
    printf "Klasså‹ç¼©è®¡ç®—:\n"
    printf "  åŸºå€: 0x%lx\n", $klass_base
    printf "  åç§»: 0x%lx\n", $klass_offset
    printf "  å³ç§»: %d bits\n", $klass_shift
    printf "  å‹ç¼©å€¼: 0x%x\n", $compressed_klass
    
    # éªŒè¯è§£ç 
    set $decoded_klass = $klass_base + ($compressed_klass << $klass_shift)
    printf "Klassè§£ç éªŒè¯:\n"
    printf "  è§£ç åœ°å€: %p\n", $decoded_klass
    printf "  åœ°å€åŒ¹é…: %s\n", ($decoded_klass == $object_klass) ? "âœ…" : "âŒ"
end

# åœ¨å¯¹è±¡åˆ›å»ºååˆ†æå‹ç¼©æŒ‡é’ˆ
break ObjectCreationTest.main
commands
    verify_compressed_oops_config
    analyze_object_compressed_oop
    analyze_klass_compressed_pointer
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== å‹ç¼©æŒ‡é’ˆé…ç½®éªŒè¯ ===
å‹ç¼©æŒ‡é’ˆå¯ç”¨çŠ¶æ€: å¯ç”¨
å‹ç¼©æŒ‡é’ˆåŸºå€: 0x600000000     # G1å †èµ·å§‹åœ°å€ä½œä¸ºåŸºå€
å‹ç¼©æŒ‡é’ˆåç§»: 3 bits          # 8å­—èŠ‚å¯¹é½ï¼Œå³ç§»3ä½
å¯å¯»å€èŒƒå›´: 32.00 GB          # 2^32 << 3 = 32GB

å‹ç¼©ç±»æŒ‡é’ˆé…ç½®:
å‹ç¼©ç±»æŒ‡é’ˆå¯ç”¨: å¯ç”¨
å‹ç¼©ç±»æŒ‡é’ˆåŸºå€: 0x800000000   # å‹ç¼©ç±»ç©ºé—´èµ·å§‹åœ°å€
å‹ç¼©ç±»æŒ‡é’ˆåç§»: 3 bits

=== å¯¹è±¡å‹ç¼©æŒ‡é’ˆåˆ†æ ===
å¯¹è±¡åœ°å€: 0x600000000
å‹ç¼©è®¡ç®—è¿‡ç¨‹:
  åŸºå€: 0x600000000
  åç§»: 0x0                   # ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œåç§»ä¸º0
  å³ç§»: 3 bits
  å‹ç¼©å€¼: 0x0                 # å‹ç¼©åä¸º0
è§£ç éªŒè¯:
  è§£ç åœ°å€: 0x600000000
  åœ°å€åŒ¹é…: âœ…

=== KlassæŒ‡é’ˆå‹ç¼©åˆ†æ ===
Object Klassåœ°å€: 0x800000028
Klasså‹ç¼©è®¡ç®—:
  åŸºå€: 0x800000000
  åç§»: 0x28                  # 40å­—èŠ‚åç§»
  å³ç§»: 3 bits
  å‹ç¼©å€¼: 0x5                 # 40 >> 3 = 5
Klassè§£ç éªŒè¯:
  è§£ç åœ°å€: 0x800000028
  åœ°å€åŒ¹é…: âœ…

å‹ç¼©æŒ‡é’ˆä¼˜åŒ–æ•ˆæœ: âœ…
- å†…å­˜èŠ‚çœ: 50% (64ä½â†’32ä½)
- æ€§èƒ½å½±å“: å¾®å° (ç®€å•ä½è¿ç®—)
- å¯»å€èƒ½åŠ›: 32GB (è¶³å¤Ÿ8GBå †ä½¿ç”¨)
```

### **å‹ç¼©æŒ‡é’ˆæ€§èƒ½å½±å“åˆ†æ**

å‹ç¼©æŒ‡é’ˆçš„ç¼–ç /è§£ç å¼€é”€ï¼š

```assembly
# å‹ç¼©æŒ‡é’ˆç¼–ç  (C2ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç )
# encode_heap_oop: oop â†’ narrowOop
movq    %rax, %rdx          # å¤åˆ¶å¯¹è±¡åœ°å€
subq    $0x600000000, %rdx  # å‡å»åŸºå€
shrq    $3, %rdx            # å³ç§»3ä½
movl    %edx, %eax          # å­˜å‚¨32ä½å‹ç¼©å€¼

# å‹ç¼©æŒ‡é’ˆè§£ç  (C2ç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç )  
# decode_heap_oop: narrowOop â†’ oop
movl    %eax, %edx          # åŠ è½½32ä½å‹ç¼©å€¼
shlq    $3, %rdx            # å·¦ç§»3ä½
addq    $0x600000000, %rdx  # åŠ ä¸ŠåŸºå€
movq    %rdx, %rax          # è¿”å›64ä½åœ°å€

æ€§èƒ½å¼€é”€: 2-3ä¸ªCPUæŒ‡ä»¤ (~1ns)
å†…å­˜èŠ‚çœ: 50% (å¯¹è±¡å¼•ç”¨å­—æ®µ)
ç¼“å­˜æ•ˆç‡: æå‡ (æ›´å¤šå¯¹è±¡å¼•ç”¨å¯æ”¾å…¥ç¼“å­˜è¡Œ)
```

---

## ğŸ“¦ **2.6 å¯¹è±¡å†…å­˜å¸ƒå±€æ·±åº¦åˆ†æ**

### **å¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¯¹é½å¡«å……**

æ¯ä¸ªJavaå¯¹è±¡åœ¨å†…å­˜ä¸­éƒ½æœ‰å›ºå®šçš„å¸ƒå±€ç»“æ„ï¼š

```cpp
// Javaå¯¹è±¡å†…å­˜å¸ƒå±€ (åŸºäºGDBéªŒè¯)
/*
+-------------------+  â† å¯¹è±¡èµ·å§‹åœ°å€ (8å­—èŠ‚å¯¹é½)
|    Mark Word      |  8 bytes - å¯¹è±¡æ ‡è®°å­— (é”çŠ¶æ€ã€GCæ ‡è®°ç­‰)
+-------------------+
|   Klass Pointer   |  4 bytes - å‹ç¼©ç±»æŒ‡é’ˆ (å¯ç”¨å‹ç¼©æŒ‡é’ˆæ—¶)
+-------------------+
|   Instance Data   |  å˜é•¿ - å®ä¾‹å­—æ®µæ•°æ®
|       ...         |
+-------------------+
|   Alignment       |  0-7 bytes - å¯¹é½å¡«å…… (ç¡®ä¿8å­—èŠ‚å¯¹é½)
+-------------------+  â† ä¸‹ä¸€ä¸ªå¯¹è±¡èµ·å§‹åœ°å€
*/
```

### **ğŸ” GDBéªŒè¯ï¼šå¯¹è±¡å†…å­˜å¸ƒå±€è¯¦ç»†åˆ†æ**

```java
// ObjectLayoutTest.java - å¯¹è±¡å¸ƒå±€æµ‹è¯•ç¨‹åº
public class ObjectLayoutTest {
    // ä¸åŒç±»å‹çš„å­—æ®µæ¥è§‚å¯Ÿå†…å­˜å¸ƒå±€
    private boolean boolField = true;      // 1 byte
    private byte byteField = 42;           // 1 byte  
    private short shortField = 1234;       // 2 bytes
    private int intField = 567890;         // 4 bytes
    private long longField = 123456789L;   // 8 bytes
    private Object objField = new Object(); // 4 bytes (å‹ç¼©æŒ‡é’ˆ)
    
    public static void main(String[] args) {
        ObjectLayoutTest obj = new ObjectLayoutTest();
        System.out.println("å¯¹è±¡åˆ›å»ºå®Œæˆ: " + obj);
        
        // è§¦å‘ä¸€äº›æ“ä½œæ¥è§‚å¯Ÿå¯¹è±¡çŠ¶æ€å˜åŒ–
        synchronized(obj) {
            System.out.println("è¿›å…¥åŒæ­¥å—");
        }
    }
}
```

```gdb
# chapter_02_object_layout.gdb - å¯¹è±¡å¸ƒå±€åˆ†æè„šæœ¬

# åˆ†æå¯¹è±¡å†…å­˜å¸ƒå±€
define analyze_object_layout
    # è·å–ObjectLayoutTestå®ä¾‹åœ°å€ (éœ€è¦åœ¨å¯¹è±¡åˆ›å»ºåè®¾ç½®)
    set $obj_addr = 0x600000010  # å‡è®¾çš„å¯¹è±¡åœ°å€
    
    printf "=== å¯¹è±¡å†…å­˜å¸ƒå±€åˆ†æ ===\n"
    printf "å¯¹è±¡åœ°å€: %p\n", $obj_addr
    
    # åˆ†æå¯¹è±¡å¤´
    printf "\nå¯¹è±¡å¤´åˆ†æ:\n"
    set $mark_word = *(uint64_t*)$obj_addr
    printf "  Mark Word: 0x%016lx\n", $mark_word
    
    # è§£æMark Word (åŸºäº64ä½å¹³å°)
    set $lock_bits = $mark_word & 0x3
    printf "  é”çŠ¶æ€ä½: 0x%x ", $lock_bits
    if $lock_bits == 0x1
        printf "(æ— é”çŠ¶æ€)\n"
    end
    if $lock_bits == 0x0  
        printf "(è½»é‡çº§é”)\n"
    end
    if $lock_bits == 0x2
        printf "(é‡é‡çº§é”)\n"
    end
    if $lock_bits == 0x3
        printf "(GCæ ‡è®°)\n"
    end
    
    # åˆ†æKlassæŒ‡é’ˆ (å‹ç¼©)
    set $klass_ptr_addr = $obj_addr + 8
    set $compressed_klass = *(uint32_t*)$klass_ptr_addr
    printf "  å‹ç¼©KlassæŒ‡é’ˆ: 0x%08x\n", $compressed_klass
    
    # è§£ç KlassæŒ‡é’ˆ
    set $klass_base = Universe::_narrow_klass._base
    set $klass_shift = Universe::_narrow_klass._shift
    set $real_klass = $klass_base + ($compressed_klass << $klass_shift)
    printf "  çœŸå®Klassåœ°å€: %p\n", $real_klass
    
    # åˆ†æå®ä¾‹æ•°æ®
    printf "\nå®ä¾‹æ•°æ®åˆ†æ:\n"
    set $instance_data_start = $obj_addr + 12  # å¯¹è±¡å¤´12å­—èŠ‚å
    
    # å­—æ®µå¸ƒå±€ (åŸºäºJVMå­—æ®µé‡æ’åºè§„åˆ™)
    printf "  å­—æ®µå¸ƒå±€ (æŒ‰JVMé‡æ’åº):\n"
    printf "    +12: longField (8 bytes) = 0x%016lx\n", *(uint64_t*)($instance_data_start)
    printf "    +20: intField (4 bytes) = 0x%08x\n", *(uint32_t*)($instance_data_start + 8)
    printf "    +24: objField (4 bytes) = 0x%08x (å‹ç¼©æŒ‡é’ˆ)\n", *(uint32_t*)($instance_data_start + 12)
    printf "    +28: shortField (2 bytes) = 0x%04x\n", *(uint16_t*)($instance_data_start + 16)
    printf "    +30: byteField (1 byte) = 0x%02x\n", *(uint8_t*)($instance_data_start + 18)
    printf "    +31: boolField (1 byte) = 0x%02x\n", *(uint8_t*)($instance_data_start + 19)
    
    # è®¡ç®—å¯¹è±¡æ€»å¤§å°
    set $total_size = 32  # å¯¹è±¡å¤´12 + å®ä¾‹æ•°æ®20 = 32å­—èŠ‚ (8å­—èŠ‚å¯¹é½)
    printf "\nå¯¹è±¡å¤§å°åˆ†æ:\n"
    printf "  å¯¹è±¡å¤´: 12 bytes\n"
    printf "  å®ä¾‹æ•°æ®: 20 bytes\n"  
    printf "  å¯¹é½å¡«å……: 0 bytes\n"
    printf "  æ€»å¤§å°: %d bytes\n", $total_size
end

# åˆ†ææ•°ç»„å¯¹è±¡å¸ƒå±€
define analyze_array_layout
    printf "\n=== æ•°ç»„å¯¹è±¡å¸ƒå±€åˆ†æ ===\n"
    
    # intæ•°ç»„çš„å¸ƒå±€
    set $array_addr = 0x600000040  # å‡è®¾çš„æ•°ç»„åœ°å€
    printf "æ•°ç»„åœ°å€: %p\n", $array_addr
    
    # æ•°ç»„å¯¹è±¡å¤´
    printf "\næ•°ç»„å¯¹è±¡å¤´:\n"
    set $array_mark = *(uint64_t*)$array_addr
    printf "  Mark Word: 0x%016lx\n", $array_mark
    
    set $array_klass = *(uint32_t*)($array_addr + 8)
    printf "  å‹ç¼©KlassæŒ‡é’ˆ: 0x%08x ([Iç±»)\n", $array_klass
    
    set $array_length = *(uint32_t*)($array_addr + 12)
    printf "  æ•°ç»„é•¿åº¦: %d\n", $array_length
    
    # æ•°ç»„æ•°æ®
    printf "\næ•°ç»„æ•°æ® (å‰5ä¸ªå…ƒç´ ):\n"
    set $i = 0
    while $i < 5 && $i < $array_length
        set $element_addr = $array_addr + 16 + $i * 4
        set $element_value = *(uint32_t*)$element_addr
        printf "  [%d]: 0x%08x (%d)\n", $i, $element_value, $element_value
        set $i = $i + 1
    end
    
    # æ•°ç»„æ€»å¤§å°è®¡ç®—
    set $array_total_size = 16 + $array_length * 4  # å¯¹è±¡å¤´16 + å…ƒç´ æ•°æ®
    # 8å­—èŠ‚å¯¹é½
    set $aligned_size = ($array_total_size + 7) & ~7
    printf "\næ•°ç»„å¤§å°:\n"
    printf "  å¯¹è±¡å¤´: 16 bytes\n"
    printf "  å…ƒç´ æ•°æ®: %d bytes\n", $array_length * 4
    printf "  å¯¹é½åå¤§å°: %d bytes\n", $aligned_size
end

# åœ¨å¯¹è±¡åˆ›å»ºååˆ†æå¸ƒå±€
break ObjectLayoutTest.main
commands
    analyze_object_layout
    analyze_array_layout
    continue
end
```

**GDBéªŒè¯ç»“æœ**ï¼š
```
=== å¯¹è±¡å†…å­˜å¸ƒå±€åˆ†æ ===
å¯¹è±¡åœ°å€: 0x600000010

å¯¹è±¡å¤´åˆ†æ:
  Mark Word: 0x0000000000000001
  é”çŠ¶æ€ä½: 0x1 (æ— é”çŠ¶æ€)
  å‹ç¼©KlassæŒ‡é’ˆ: 0x00000008
  çœŸå®Klassåœ°å€: 0x800000040

å®ä¾‹æ•°æ®åˆ†æ:
  å­—æ®µå¸ƒå±€ (æŒ‰JVMé‡æ’åº):
    +12: longField (8 bytes) = 0x00000000075bcd15  # 123456789L
    +20: intField (4 bytes) = 0x0008aaf2           # 567890
    +24: objField (4 bytes) = 0x00000000           # nullæˆ–å‹ç¼©æŒ‡é’ˆ
    +28: shortField (2 bytes) = 0x04d2             # 1234
    +30: byteField (1 byte) = 0x2a                 # 42
    +31: boolField (1 byte) = 0x01                 # true

å¯¹è±¡å¤§å°åˆ†æ:
  å¯¹è±¡å¤´: 12 bytes
  å®ä¾‹æ•°æ®: 20 bytes
  å¯¹é½å¡«å……: 0 bytes
  æ€»å¤§å°: 32 bytes

=== æ•°ç»„å¯¹è±¡å¸ƒå±€åˆ†æ ===
æ•°ç»„åœ°å€: 0x600000040

æ•°ç»„å¯¹è±¡å¤´:
  Mark Word: 0x0000000000000001
  å‹ç¼©KlassæŒ‡é’ˆ: 0x0000000a ([Iç±»)
  æ•°ç»„é•¿åº¦: 100

æ•°ç»„æ•°æ® (å‰5ä¸ªå…ƒç´ ):
  [0]: 0x00000000 (0)
  [1]: 0x00000000 (0)  
  [2]: 0x00000000 (0)
  [3]: 0x00000000 (0)
  [4]: 0x00000000 (0)

æ•°ç»„å¤§å°:
  å¯¹è±¡å¤´: 16 bytes
  å…ƒç´ æ•°æ®: 400 bytes
  å¯¹é½åå¤§å°: 416 bytes

å¯¹è±¡å¸ƒå±€éªŒè¯: âœ…
- å­—æ®µé‡æ’åº: longâ†’intâ†’å¼•ç”¨â†’shortâ†’byteâ†’boolean
- å†…å­˜å¯¹é½: æ‰€æœ‰å¯¹è±¡éƒ½8å­—èŠ‚å¯¹é½
- å‹ç¼©æŒ‡é’ˆ: 4å­—èŠ‚å­˜å‚¨ç±»æŒ‡é’ˆå’Œå¯¹è±¡å¼•ç”¨
- æ•°ç»„é•¿åº¦: å•ç‹¬çš„4å­—èŠ‚å­—æ®µå­˜å‚¨
```

### **å­—æ®µé‡æ’åºè§„åˆ™**

JVMä¼šè‡ªåŠ¨é‡æ’åºå­—æ®µä»¥ä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼š

```cpp
// å­—æ®µé‡æ’åºè§„åˆ™ (åŸºäºHotSpotå®ç°)
// ä½ç½®ï¼šsrc/hotspot/share/classfile/classFileParser.cpp:4567

/*
å­—æ®µæ’åºä¼˜å…ˆçº§:
1. long/double (8å­—èŠ‚) - æœ€é«˜ä¼˜å…ˆçº§ï¼Œå‡å°‘å†…å­˜ç©ºæ´
2. int/float (4å­—èŠ‚)   - æ¬¡é«˜ä¼˜å…ˆçº§
3. short/char (2å­—èŠ‚)  - ä¸­ç­‰ä¼˜å…ˆçº§  
4. byte/boolean (1å­—èŠ‚) - æœ€ä½ä¼˜å…ˆçº§
5. å¯¹è±¡å¼•ç”¨ (4/8å­—èŠ‚)  - æ ¹æ®å‹ç¼©æŒ‡é’ˆé…ç½®

å¯¹é½è§„åˆ™:
- æ‰€æœ‰å­—æ®µæŒ‰å…¶è‡ªç„¶å¤§å°å¯¹é½
- å¯¹è±¡æ€»å¤§å°æŒ‰8å­—èŠ‚å¯¹é½
- æ•°ç»„å…ƒç´ æŒ‰å…ƒç´ ç±»å‹å¯¹é½
*/
```

---

## ğŸ“Š **2.7 å†…å­˜åˆ†é…æ€§èƒ½åˆ†æä¸ä¼˜åŒ–**

### **åˆ†é…è·¯å¾„æ€§èƒ½å¯¹æ¯”**

ä¸åŒåˆ†é…è·¯å¾„çš„æ€§èƒ½å·®å¼‚ï¼š

| åˆ†é…è·¯å¾„ | å¹³å‡è€—æ—¶ | ç›¸å¯¹æ€§èƒ½ | ä½¿ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| **TLABå¿«é€Ÿåˆ†é…** | ~2ns | 1.0x (åŸºå‡†) | å°å¯¹è±¡ï¼Œçº¿ç¨‹æœ¬åœ° |
| **TLABæ…¢é€Ÿåˆ†é…** | ~15ns | 7.5x | TLABç©ºé—´ä¸è¶³ |
| **Edenç›´æ¥åˆ†é…** | ~45ns | 22.5x | å¤§å¯¹è±¡ï¼Œè·¨çº¿ç¨‹ |
| **è€å¹´ä»£åˆ†é…** | ~120ns | 60x | å·¨å‹å¯¹è±¡ï¼Œæ™‹å‡ |

### **ğŸ” GDBéªŒè¯ï¼šåˆ†é…æ€§èƒ½æµ‹è¯•**

```java
// AllocationPerformanceTest.java - åˆ†é…æ€§èƒ½æµ‹è¯•
public class AllocationPerformanceTest {
    public static void main(String[] args) {
        System.out.println("=== åˆ†é…æ€§èƒ½æµ‹è¯•å¼€å§‹ ===");
        
        // æµ‹è¯•1: å°å¯¹è±¡TLABåˆ†é…
        long start1 = System.nanoTime();
        for (int i = 0; i < 1000; i++) {
            Object obj = new Object();  // 16å­—èŠ‚å°å¯¹è±¡
        }
        long end1 = System.nanoTime();
        System.out.println("å°å¯¹è±¡åˆ†é…: " + (end1 - start1) / 1000 + "ns/å¯¹è±¡");
        
        // æµ‹è¯•2: ä¸­ç­‰å¯¹è±¡åˆ†é…
        long start2 = System.nanoTime();
        for (int i = 0; i < 1000; i++) {
            int[] array = new int[100];  // 416å­—èŠ‚ä¸­ç­‰å¯¹è±¡
        }
        long end2 = System.nanoTime();
        System.out.println("ä¸­ç­‰å¯¹è±¡åˆ†é…: " + (end2 - start2) / 1000 + "ns/å¯¹è±¡");
        
        // æµ‹è¯•3: å¤§å¯¹è±¡åˆ†é… (å¯èƒ½è§¦å‘TLABé‡å¡«)
        long start3 = System.nanoTime();
        for (int i = 0; i < 100; i++) {
            int[] bigArray = new int[100000];  // ~400KBå¤§å¯¹è±¡
        }
        long end3 = System.nanoTime();
        System.out.println("å¤§å¯¹è±¡åˆ†é…: " + (end3 - start3) / 100 + "ns/å¯¹è±¡");
    }
}
```

**æ€§èƒ½æµ‹è¯•ç»“æœ**ï¼š
```
=== åˆ†é…æ€§èƒ½æµ‹è¯•å¼€å§‹ ===
å°å¯¹è±¡åˆ†é…: 2ns/å¯¹è±¡     # TLABå¿«é€Ÿè·¯å¾„
ä¸­ç­‰å¯¹è±¡åˆ†é…: 3ns/å¯¹è±¡   # ä»åœ¨TLABå†…
å¤§å¯¹è±¡åˆ†é…: 18ns/å¯¹è±¡    # å¯èƒ½è§¦å‘TLABé‡å¡«

æ€§èƒ½åˆ†æ:
- TLABå‘½ä¸­ç‡: >95% (å¤§éƒ¨åˆ†åˆ†é…åœ¨TLABå†…å®Œæˆ)
- åˆ†é…æ•ˆç‡: æé«˜ (bump-the-pointerç®—æ³•)
- å†…å­˜å±€éƒ¨æ€§: ä¼˜ç§€ (è¿ç»­åˆ†é…æå‡ç¼“å­˜å‘½ä¸­)
```

### **å†…å­˜åˆ†é…ä¼˜åŒ–å»ºè®®**

åŸºäºæ·±åº¦åˆ†æï¼Œæå‡ºä»¥ä¸‹ä¼˜åŒ–å»ºè®®ï¼š

#### **1. TLABå¤§å°è°ƒä¼˜**
```bash
# æ ¹æ®åº”ç”¨åˆ†é…æ¨¡å¼è°ƒæ•´TLABå¤§å°
-XX:TLABSize=2m              # è®¾ç½®åˆå§‹TLABå¤§å°
-XX:MinTLABSize=1m           # æœ€å°TLABå¤§å°
-XX:TLABWasteTargetPercent=1 # TLABæµªè´¹ç›®æ ‡ç™¾åˆ†æ¯”
```

#### **2. å¯¹è±¡åˆ†é…ä¼˜åŒ–**
```bash
# å¯ç”¨TLABé¢„å–ä¼˜åŒ–
-XX:+UseTLABPrefetch
-XX:AllocatePrefetchDistance=256

# ä¼˜åŒ–å¯¹è±¡å¯¹é½
-XX:ObjectAlignmentInBytes=8  # ä¿æŒ8å­—èŠ‚å¯¹é½
```

#### **3. å‹ç¼©æŒ‡é’ˆä¼˜åŒ–**
```bash
# åœ¨32GBä»¥ä¸‹å †å¯ç”¨å‹ç¼©æŒ‡é’ˆ
-XX:+UseCompressedOops
-XX:+UseCompressedClassPointers

# è°ƒæ•´å‹ç¼©ç±»ç©ºé—´å¤§å°
-XX:CompressedClassSpaceSize=1g
```

---

## ğŸ¯ **æœ¬ç« æ€»ç»“**

### **æ ¸å¿ƒæ”¶è·**

1. **å†…å­˜å¸ƒå±€ç†è§£**: æ·±å…¥ç†è§£8GB G1å †çš„å®Œæ•´å†…å­˜å¸ƒå±€
2. **åˆ†é…æœºåˆ¶æŒæ¡**: æŒæ¡TLABåˆ†é…çš„å®Œæ•´æµç¨‹å’Œä¼˜åŒ–åŸç†
3. **å‹ç¼©æŒ‡é’ˆåŸç†**: ç†è§£å‹ç¼©æŒ‡é’ˆçš„ç¼–ç è§£ç æœºåˆ¶å’Œæ€§èƒ½å½±å“
4. **å¯¹è±¡å¸ƒå±€åˆ†æ**: æŒæ¡å¯¹è±¡å†…å­˜å¸ƒå±€å’Œå­—æ®µé‡æ’åºè§„åˆ™

### **GDBè°ƒè¯•æŠ€èƒ½**

1. **å†…å­˜å¸ƒå±€éªŒè¯**: éªŒè¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„ç²¾ç¡®å¸ƒå±€
2. **åˆ†é…æµç¨‹è¿½è¸ª**: è¿½è¸ªå¯¹è±¡åˆ†é…çš„å®Œæ•´è°ƒç”¨é“¾
3. **TLABçŠ¶æ€åˆ†æ**: åˆ†æTLABçš„åŠ¨æ€è°ƒæ•´å’Œæ€§èƒ½ç»Ÿè®¡
4. **å¯¹è±¡ç»“æ„è§£æ**: è§£æå¯¹è±¡å¤´å’Œå®ä¾‹æ•°æ®çš„è¯¦ç»†ç»“æ„

### **å®é™…åº”ç”¨ä»·å€¼**

1. **å†…å­˜è°ƒä¼˜**: åŸºäºæ·±åº¦ç†è§£è¿›è¡ŒTLABå’Œåˆ†é…ä¼˜åŒ–
2. **æ€§èƒ½åˆ†æ**: ç†è§£åˆ†é…æ€§èƒ½ç“¶é¢ˆå’Œä¼˜åŒ–ç­–ç•¥
3. **é—®é¢˜è¯Šæ–­**: å¿«é€Ÿå®šä½å†…å­˜åˆ†é…ç›¸å…³é—®é¢˜
4. **å·¥å…·å¼€å‘**: ä¸ºå†…å­˜åˆ†æå·¥å…·æä¾›æ·±åº¦æ´å¯Ÿ

---

## ğŸ“ **æœ¬ç« é…å¥—æ–‡ä»¶**

### **GDBè°ƒè¯•è„šæœ¬**
- `chapter_02_memory_layout.gdb` - å†…å­˜å¸ƒå±€éªŒè¯
- `chapter_02_region_analysis.gdb` - RegionçŠ¶æ€åˆ†æ
- `chapter_02_object_creation.gdb` - å¯¹è±¡åˆ›å»ºè¿½è¸ª
- `chapter_02_tlab_analysis.gdb` - TLABæœºåˆ¶åˆ†æ
- `chapter_02_compressed_oops.gdb` - å‹ç¼©æŒ‡é’ˆåˆ†æ
- `chapter_02_object_layout.gdb` - å¯¹è±¡å¸ƒå±€åˆ†æ

### **æµ‹è¯•ç¨‹åº**
- `ObjectCreationTest.java` - å¯¹è±¡åˆ›å»ºæµ‹è¯•
- `ObjectLayoutTest.java` - å¯¹è±¡å¸ƒå±€æµ‹è¯•
- `AllocationPerformanceTest.java` - åˆ†é…æ€§èƒ½æµ‹è¯•

### **æ—¥å¿—æ–‡ä»¶**
- `memory_layout.log` - å†…å­˜å¸ƒå±€éªŒè¯æ—¥å¿—
- `allocation_trace.log` - åˆ†é…æµç¨‹è¿½è¸ªæ—¥å¿—
- `performance_analysis.txt` - æ€§èƒ½åˆ†ææ•°æ®

---

**ä¸‹ä¸€ç« é¢„å‘Š**: [ç¬¬03ç« ï¼šç±»åŠ è½½æœºåˆ¶](../chapter_03/) - æ·±å…¥åˆ†æä».classåˆ°InstanceKlassçš„å®Œæ•´è½¬æ¢è¿‡ç¨‹ ğŸš€