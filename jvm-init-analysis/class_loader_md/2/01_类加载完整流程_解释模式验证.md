# JVM类加载完整流程 - 解释模式GDB验证

> **验证环境**: OpenJDK 11 slowdebug  
> **JVM参数**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint`  
> **目标类**: HelloWorld  
> **验证时间**: 2026-01-15

---

## 1. HelloWorld源码与字节码

### 1.1 源码

```java
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
```

### 1.2 字节码反编译 (javap -v)

```
Classfile /data/workspace/HelloWorld.class
  Last modified Jan 15, 2026; size 421 bytes
  MD5 checksum 92efcfe1eeea1091dc3ca152aba58af2
  
public class HelloWorld
  minor version: 0
  major version: 55  (Java 11)
  flags: (0x0021) ACC_PUBLIC, ACC_SUPER

Constant pool:
   #1 = Methodref    #6.#15     // java/lang/Object."<init>":()V
   #2 = Fieldref     #16.#17    // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String       #18        // Hello World
   #4 = Methodref    #19.#20    // java/io/PrintStream.println:(Ljava/lang/String;)V
   #5 = Class        #21        // HelloWorld
   #6 = Class        #22        // java/lang/Object
   ...

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: (0x0009) ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2    // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3    // String Hello World
         5: invokevirtual #4    // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
```

---

## 2. 类加载完整调用栈 (GDB验证)

### 2.1 第一阶段: 查找类 (Bootstrap ClassLoader尝试)

```
#0  SystemDictionary::load_instance_class
    at systemDictionary.cpp:1405
#1  SystemDictionary::resolve_instance_class_or_null
    at systemDictionary.cpp:821
#2  SystemDictionary::resolve_or_null
    at systemDictionary.cpp:256
#3  SystemDictionary::resolve_or_null (重载)
    at systemDictionary.cpp:261
#4  JVM_FindClassFromBootLoader
    at jvm.cpp:782
#5  Java_java_lang_ClassLoader_findBootstrapClass  ← JNI入口
    at ClassLoader.c:240
```

**说明**: Bootstrap ClassLoader 尝试从 `rt.jar`/模块中加载 HelloWorld，找不到后委托给 AppClassLoader。

### 2.2 第二阶段: 定义类 (AppClassLoader)

```
#0  KlassFactory::create_from_stream
    at klassFactory.cpp:172
#1  SystemDictionary::resolve_from_stream
    at systemDictionary.cpp:1088
#2  jvm_define_class_common
    at jvm.cpp:940
#3  JVM_DefineClassWithSource
    at jvm.cpp:966
#4  Java_java_lang_ClassLoader_defineClass1  ← JNI入口
    at ClassLoader.c:136

关键参数:
  stream: 0x7ffff7808f60 (ClassFileStream)
  name: "HelloWorld"
  loader_data: 0x7ffff0f00b90
  buf: 0x7ffff0f784e0 (class文件内容，421字节)
  source: "file:/data/workspace/"
```

### 2.3 第三阶段: 解析class文件

```
#0  ClassFileParser::create_instance_klass
    at classFileParser.cpp:5568
#1  KlassFactory::create_from_stream
    at klassFactory.cpp:206

解析结果 (GDB验证):
  _this_class_index: 5     (常量池#5 = HelloWorld)
  _super_class_index: 6    (常量池#6 = java/lang/Object)
  _itfs_len: 0             (无接口)
  _java_fields_count: 0    (无字段)
  _vtable_size: 5          (继承Object的5个虚方法)
  _itable_size: 2
  _num_miranda_methods: 0

  常量池:
    _cp: 0x7fffcefa6068
    _cp->length: 29

  方法:
    _methods: 0x7fffcefa61d8
    _methods->length: 2  (<init> + main)
```

### 2.4 第四阶段: 链接类 (link_class_impl)

```
#0  InstanceKlass::link_class_impl
    at instanceKlass.cpp:712
#1  InstanceKlass::link_class
    at instanceKlass.cpp:697

链接时的InstanceKlass状态:
  地址: 0x800092840
  sizeof: 472 bytes
  
  _layout_helper: 16
  _super_check_offset: 56
  _access_flags: 0x20000021 (ACC_PUBLIC | ACC_SUPER | 内部标志)
  _vtable_len: 5
  _itable_len: 2
  
  _super: 0x800001040 (java/lang/Object)
  _constants: 0x7fffcefa6068
  _class_loader_data: 0x7ffff0ef8ba0
```

### 2.5 第五阶段: 初始化类 (initialize_impl)

```
#0  InstanceKlass::initialize_impl
    at instanceKlass.cpp (调用<clinit>)

初始化后状态:
  _init_state: 2 → 6 (fully_initialized)
  
  vtable已填充:
    vtable[0]: 0x7fffceaf1f48 (finalize)
    vtable[1]: 0x7fffceaf18b8 (equals)
    vtable[2]: 0x7fffceaf1a68 (toString)
    vtable[3]: 0x7fffceaf17c0 (hashCode)
    vtable[4]: 0x7fffceaf1968 (clone)
```

---

## 3. 类加载流程图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                        HelloWorld 类加载完整流程                             │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────┐                                                       │
│  │ Class.forName() │  或  main()入口                                        │
│  └────────┬────────┘                                                       │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ JVM_FindClassFromCaller / JVM_FindClassFromBootLoader │                 │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ SystemDictionary::resolve_or_null           │ ← 双亲委派入口              │
│  │   class_name = "HelloWorld"                 │                           │
│  │   查询SystemDictionary缓存                   │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │ 未找到                                                          │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ SystemDictionary::load_instance_class       │                           │
│  │   1. Bootstrap尝试加载 → 失败                │                           │
│  │   2. 调用Java层ClassLoader.loadClass()      │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ ClassLoader.defineClass()                   │  (Java层)                  │
│  │   读取 HelloWorld.class 文件 (421 bytes)     │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ JVM_DefineClassWithSource                   │  (JNI)                    │
│  │   buf = 0x7ffff0f784e0 (class文件魔数CAFEBABE)│                          │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ KlassFactory::create_from_stream            │                           │
│  │   stream = ClassFileStream                  │                           │
│  │   loader_data = 0x7ffff0f00b90              │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ ClassFileParser::parse_stream               │  解析class文件              │
│  │   1. 解析常量池 (29项)                       │                           │
│  │   2. 解析字段 (0个)                          │                           │
│  │   3. 解析方法 (2个: <init>, main)           │                           │
│  │   4. 计算vtable/itable                      │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ ClassFileParser::create_instance_klass      │  创建InstanceKlass          │
│  │   在Metaspace中分配:                         │                           │
│  │   - InstanceKlass: 0x800092840 (472 bytes)  │                           │
│  │   - ConstantPool: 0x7fffcefa6068            │                           │
│  │   - Methods: 0x7fffcefa61d8                 │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ InstanceKlass::link_class_impl              │  链接阶段                   │
│  │   1. 验证字节码                              │                           │
│  │   2. 准备 (分配静态变量内存)                  │                           │
│  │   3. 解析符号引用 (创建CPCache)              │                           │
│  │   4. 重写字节码 (quicken)                    │                           │
│  │   5. 填充vtable                             │                           │
│  │   6. 设置解释器入口                          │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ InstanceKlass::initialize_impl              │  初始化阶段                 │
│  │   执行<clinit> (如果有)                      │                           │
│  │   _init_state: 2 → 6 (fully_initialized)   │                           │
│  └────────┬────────────────────────────────────┘                           │
│           │                                                                │
│           ▼                                                                │
│  ┌─────────────────────────────────────────────┐                           │
│  │ 类加载完成，可以创建实例/调用方法             │                           │
│  └─────────────────────────────────────────────┘                           │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 类加载三阶段总结

| 阶段 | 入口函数 | 主要工作 | GDB验证数据 |
|------|----------|----------|-------------|
| **加载** | `KlassFactory::create_from_stream` | 读取class文件，创建InstanceKlass | stream=421 bytes |
| **链接** | `InstanceKlass::link_class_impl` | 验证、准备、解析、重写字节码 | CPCache创建 |
| **初始化** | `InstanceKlass::initialize_impl` | 执行`<clinit>`，设置init_state=6 | vtable填充完成 |

---

## 5. 关键源码位置

| 功能 | 源文件 | 行号 |
|------|--------|------|
| 类解析入口 | `systemDictionary.cpp` | 256 |
| 加载实例类 | `systemDictionary.cpp` | 1405 |
| 创建Klass | `klassFactory.cpp` | 172 |
| 解析class文件 | `classFileParser.cpp` | 5568 |
| 链接类 | `instanceKlass.cpp` | 712 |
| 初始化类 | `instanceKlass.cpp` | (initialize_impl) |
| JNI入口 | `jvm.cpp` | 940 |
| ClassLoader JNI | `ClassLoader.c` | 136 |
