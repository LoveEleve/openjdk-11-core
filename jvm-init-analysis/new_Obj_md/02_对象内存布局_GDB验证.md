# 对象内存布局详解 - GDB验证

> **验证环境**: OpenJDK 11 slowdebug  
> **JVM参数**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint`  
> **目标对象**: HelloWorld实例

---

## 1. 对象内存布局概览

### 1.1 普通对象布局 (64位JVM, 压缩指针)

```
┌────────────────────────────────────────────────────────────────────┐
│ 普通对象内存布局 (Ordinary Object Pointer, OOP)                     │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ ┌──────────────────────────────────────────────────────────────┐   │
│ │ Object Header (对象头)                                        │   │
│ │ ├─ mark word (8 bytes)                                        │   │
│ │ └─ compressed klass pointer (4 bytes)                         │   │
│ └──────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ ┌──────────────────────────────────────────────────────────────┐   │
│ │ Instance Data (实例数据)                                      │   │
│ │ └─ 字段按类型排序存储                                          │   │
│ └──────────────────────────────────────────────────────────────┘   │
│                                                                    │
│ ┌──────────────────────────────────────────────────────────────┐   │
│ │ Padding (填充)                                                │   │
│ │ └─ 对齐到8字节边界                                            │   │
│ └──────────────────────────────────────────────────────────────┘   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 1.2 HelloWorld对象布局 (GDB验证)

```
┌────────────────────────────────────────────────────────────────────┐
│ HelloWorld对象 @ 0x7ff41f2b0 (16 bytes)                            │
├───────┬────────────────────────────────────────────────────────────┤
│ 偏移  │ 内容                                                        │
├───────┼────────────────────────────────────────────────────────────┤
│ +0    │ mark word: 0x0000000000000005 (8 bytes)                    │
│       │   - 偏向锁状态                                              │
├───────┼────────────────────────────────────────────────────────────┤
│ +8    │ compressed klass: 0x00092840 (4 bytes)                     │
│       │   - 解压后: 0x800092840 (HelloWorld InstanceKlass)         │
├───────┼────────────────────────────────────────────────────────────┤
│ +12   │ padding: 0x00000000 (4 bytes)                              │
│       │   - 对齐填充                                                │
└───────┴────────────────────────────────────────────────────────────┘
```

---

## 2. Mark Word详解

### 2.1 Mark Word结构 (64位)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ mark word (64 bits)                                                              │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ 无锁状态 (001):                                                                  │
│ ┌─────────────────────────────────────────────────┬─────┬────┬───┬───┬───┐      │
│ │ unused (25) │ hashcode (31)   │ unused (1) │ age (4) │ 0 │ 0 │ 1 │      │
│ └─────────────────────────────────────────────────┴─────┴────┴───┴───┴───┘      │
│                                                                                  │
│ 偏向锁状态 (101):                                                                │
│ ┌─────────────────────────────────────────────────┬─────┬────┬───┬───┬───┐      │
│ │ thread_id (54)            │ epoch (2) │ unused (1) │ age (4) │ 1 │ 0 │ 1 │   │
│ └─────────────────────────────────────────────────┴─────┴────┴───┴───┴───┘      │
│                                                                                  │
│ 轻量级锁状态 (00):                                                               │
│ ┌───────────────────────────────────────────────────────────────────┬───┬───┐   │
│ │ ptr_to_lock_record (62)                                           │ 0 │ 0 │   │
│ └───────────────────────────────────────────────────────────────────┴───┴───┘   │
│                                                                                  │
│ 重量级锁状态 (10):                                                               │
│ ┌───────────────────────────────────────────────────────────────────┬───┬───┐   │
│ │ ptr_to_heavyweight_monitor (62)                                   │ 1 │ 0 │   │
│ └───────────────────────────────────────────────────────────────────┴───┴───┘   │
│                                                                                  │
│ GC标记状态 (11):                                                                 │
│ ┌───────────────────────────────────────────────────────────────────┬───┬───┐   │
│ │ forwarding_address / gc_info (62)                                 │ 1 │ 1 │   │
│ └───────────────────────────────────────────────────────────────────┴───┴───┘   │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 HelloWorld对象的Mark Word (GDB验证)

```
mark word = 0x0000000000000005

二进制: 0000...0000 0101

低3位分析:
  bit 0: 1 (lock bit)
  bit 1: 0 (biased_lock bit)
  bit 2: 1 

组合: 101 = 偏向锁可用状态

完整解读:
┌────────────────────────────────────────────────────────────────────┐
│ 0x0000000000000005                                                 │
├────────────────────────────────────────────────────────────────────┤
│ thread_id: 0 (未偏向任何线程)                                       │
│ epoch: 0                                                           │
│ age: 0 (GC年龄)                                                    │
│ biased_lock: 1 (偏向锁标志位)                                       │
│ lock: 01                                                           │
│                                                                    │
│ 状态: 可偏向，但尚未偏向任何线程                                     │
└────────────────────────────────────────────────────────────────────┘
```

### 2.3 锁状态转换

```
┌─────────────────────────────────────────────────────────────────────┐
│ 锁状态转换图                                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│     ┌───────────────┐                                               │
│     │  新创建对象    │                                               │
│     │  mark = 0x5   │                                               │
│     │  (可偏向)      │                                               │
│     └───────┬───────┘                                               │
│             │ 第一次加锁                                             │
│             ▼                                                       │
│     ┌───────────────┐                                               │
│     │   偏向锁      │ mark = thread_id | epoch | age | 101          │
│     └───────┬───────┘                                               │
│             │ 其他线程竞争                                           │
│             ▼                                                       │
│     ┌───────────────┐                                               │
│     │  轻量级锁     │ mark = lock_record_ptr | 00                   │
│     └───────┬───────┘                                               │
│             │ 自旋失败                                               │
│             ▼                                                       │
│     ┌───────────────┐                                               │
│     │  重量级锁     │ mark = monitor_ptr | 10                       │
│     └───────────────┘                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Compressed Klass Pointer详解

### 3.1 压缩类指针原理

```
┌────────────────────────────────────────────────────────────────────┐
│ Compressed Class Pointer 工作原理                                   │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 存储值 (4字节):                                                     │
│   compressed_klass = 0x00092840                                    │
│                                                                    │
│ 解压计算:                                                           │
│   base = CompressedKlassPointers::base = 0x800000000               │
│   shift = CompressedKlassPointers::shift = 0                       │
│                                                                    │
│   real_klass = base + (compressed_klass << shift)                  │
│              = 0x800000000 + 0x92840                               │
│              = 0x800092840                                         │
│                                                                    │
│ 验证:                                                               │
│   0x800092840 = HelloWorld InstanceKlass 地址 ✓                    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 3.2 Compressed Class Space布局

```
┌────────────────────────────────────────────────────────────────────┐
│ Compressed Class Space (8GB堆配置)                                  │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│ 0x800000000 ──┬── Compressed Class Space 起始                      │
│               │                                                    │
│               │   系统类 InstanceKlass:                             │
│               │     java/lang/Object   @ 0x800001040               │
│               │     java/lang/String   @ 0x800001868               │
│               │     ...                                            │
│               │                                                    │
│               │   用户类 InstanceKlass:                             │
│               │     HelloWorld         @ 0x800092840               │
│               │                                                    │
│ 0x840000000 ──┴── Compressed Class Space 结束 (1GB)                │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

GDB验证:
  HelloWorld InstanceKlass: 0x800092840
  java/lang/Object:         0x800001040
```

---

## 4. 对象大小计算

### 4.1 计算公式

```
对象大小 = 对象头 + 实例数据 + 对齐填充

其中:
  对象头 = mark word (8) + compressed klass (4) = 12 bytes
  实例数据 = 各字段大小之和
  对齐填充 = 补齐到8字节边界

最终大小必须是8的倍数
```

### 4.2 HelloWorld对象计算

```
HelloWorld类:
  - 无实例字段

计算:
  对象头 = 12 bytes
  实例数据 = 0 bytes
  小计 = 12 bytes

  对齐到8字节: ceil(12/8) * 8 = 16 bytes

验证 (_layout_helper):
  InstanceKlass._layout_helper = 16 ✓
```

### 4.3 不同类的对象大小示例

```
┌─────────────────────────────────────────────────────────────────────┐
│ 对象大小示例                                                         │
├────────────────┬─────────────────────────────────────────────────────┤
│ 类             │ 大小计算                                            │
├────────────────┼─────────────────────────────────────────────────────┤
│ Object         │ 12 + 0 + 4(padding) = 16 bytes                     │
├────────────────┼─────────────────────────────────────────────────────┤
│ HelloWorld     │ 12 + 0 + 4(padding) = 16 bytes                     │
├────────────────┼─────────────────────────────────────────────────────┤
│ 有1个int字段   │ 12 + 4 + 0 = 16 bytes                               │
├────────────────┼─────────────────────────────────────────────────────┤
│ 有1个long字段  │ 12 + 4(padding) + 8 = 24 bytes                      │
├────────────────┼─────────────────────────────────────────────────────┤
│ 有1个引用字段  │ 12 + 4 + 0 = 16 bytes (压缩引用)                    │
├────────────────┼─────────────────────────────────────────────────────┤
│ String         │ 12 + 4(value) + 4(hash) + 1(coder) + 3(pad) = 24   │
└────────────────┴─────────────────────────────────────────────────────┘
```

---

## 5. GDB内存查看

### 5.1 查看对象内存

```bash
# 设置对象地址
set $obj = 0x7ff41f2b0

# 查看完整对象 (16字节)
x/2gx $obj
# 输出:
# 0x7ff41f2b0: 0x0000000000000005  0x0000000000092840
#              └─ mark word        └─ klass + padding

# 单独查看mark word
x/1gx $obj
# 输出: 0x0000000000000005

# 单独查看compressed klass
x/1wx $obj+8
# 输出: 0x00092840

# 查看padding
x/1wx $obj+12
# 输出: 0x00000000
```

### 5.2 验证类指针

```bash
# 解压compressed klass
set $cklass = *(unsigned int*)($obj+8)
print/x $cklass
# 输出: 0x92840

# 计算真实地址
print/x $cklass + 0x800000000
# 输出: 0x800092840

# 验证InstanceKlass
set $klass = (InstanceKlass*)0x800092840
print $klass->_name->_body
# 输出: "HelloWorld"
```

### 5.3 查看mark word状态

```bash
# 获取mark word
set $mark = *(unsigned long*)$obj
print/x $mark
# 输出: 0x5

# 分析锁状态
print/x $mark & 0x7
# 输出: 0x5 (偏向锁可用)

# 获取GC年龄
print ($mark >> 3) & 0xf
# 输出: 0
```

---

## 6. 数据结构定义

### 6.1 oopDesc (对象基类)

```cpp
// oopsHierarchy.hpp
class oopDesc {
  volatile markOop _mark;           // mark word (8 bytes)
  union _metadata {
    Klass*      _klass;             // 未压缩时 (8 bytes)
    narrowKlass _compressed_klass;  // 压缩时 (4 bytes)
  } _metadata;
};
```

### 6.2 markOopDesc (Mark Word)

```cpp
// markOop.hpp
class markOopDesc: public oopDesc {
  // 常量定义
  enum {
    lock_mask_in_place    = 0x3,     // 低2位锁标志
    biased_lock_mask      = 0x7,     // 低3位偏向锁标志
    biased_lock_pattern   = 0x5,     // 偏向锁模式 101
  };
  
  // 状态判断
  bool is_unlocked() const { return (value() & 0x3) == 0x01; }
  bool is_biased() const   { return (value() & 0x7) == 0x05; }
  bool is_locked() const   { return (value() & 0x3) == 0x00; }
};
```

---

## 7. 关键数据汇总

| 项目 | GDB值 | 说明 |
|------|-------|------|
| 对象地址 | 0x7ff41f2b0 | Java堆中 |
| 对象大小 | 16 bytes | _layout_helper |
| mark word | 0x5 | 偏向锁可用 |
| 锁状态位 | 101 | biased_lock_pattern |
| compressed klass | 0x92840 | 4字节 |
| 解压后klass | 0x800092840 | HelloWorld |
| 对齐填充 | 4 bytes | 补齐到16 |
