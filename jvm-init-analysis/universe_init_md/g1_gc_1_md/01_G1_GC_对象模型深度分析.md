# G1 GC å¯¹è±¡æ¨¡å‹æ·±åº¦åˆ†æ

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æ `universe_init()` ä¸­åˆå§‹åŒ–çš„ G1 GC ç›¸å…³å¯¹è±¡æ¨¡å‹ï¼ŒåŒ…æ‹¬æ¯ä¸ªå¯¹è±¡çš„å±æ€§ã€ä½œç”¨åŠå¯¹è±¡ä¹‹é—´çš„å…³ç³»ã€‚

**æµ‹è¯•æ¡ä»¶**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages`

---

## 1. G1 GC æ ¸å¿ƒå¯¹è±¡æ€»è§ˆ

### 1.1 GDBéªŒè¯çš„æ ¸å¿ƒå¯¹è±¡

| å¯¹è±¡ | ç±»å‹ | GDBåœ°å€ | ä½œç”¨ |
|-----|------|---------|------|
| G1CollectedHeap | å †ç®¡ç†å™¨ | `0x7ffff00326b0` | G1å †çš„æ ¸å¿ƒç®¡ç†å¯¹è±¡ |
| G1Allocator | åˆ†é…å™¨ | `0x7ffff0041520` | ç®¡ç†å†…å­˜åˆ†é… |
| G1CardTable | å¡è¡¨ | `0x7ffff0042c60` | è·Ÿè¸ªè·¨Regionå¼•ç”¨ |
| G1Policy | ç­–ç•¥ | `0x7ffff0038b00` | GCå†³ç­–ï¼ˆä½•æ—¶GCã€å›æ”¶å“ªäº›Regionï¼‰ |
| G1BlockOffsetTable | å—åç§»è¡¨ | `0x7ffff0059180` | å¿«é€Ÿå®šä½å¯¹è±¡èµ·å§‹ä½ç½® |
| G1HotCardCache | çƒ­å¡ç¼“å­˜ | `0x7ffff0042ed0` | ç¼“å­˜é¢‘ç¹ä¿®æ”¹çš„å¡ |
| G1RemSet | è®°å¿†é›† | `0x7ffff004c670` | è®°å½•è·¨Regionå¼•ç”¨ |
| G1ConcurrentMark | å¹¶å‘æ ‡è®° | `0x7ffff005a360` | å¹¶å‘æ ‡è®°ç®¡ç† |
| G1ConcurrentRefine | å¹¶å‘ç»†åŒ– | `0x7ffff0c7e460` | åå°å¤„ç†è„å¡ |
| WorkGang | å·¥ä½œçº¿ç¨‹æ±  | `0x7ffff003f610` | 13ä¸ªå¹¶è¡ŒGCçº¿ç¨‹ |

### 1.2 HeapRegion é™æ€é…ç½®

| å±æ€§ | GDBå€¼ | è¯´æ˜ |
|-----|-------|------|
| `GrainBytes` | 4194304 (4MB) | Regionå¤§å° |
| `LogOfHRGrainBytes` | 22 | log2(4MB) = 22 |
| `GrainWords` | 524288 | 4MB / 8 = 524288 words |
| `CardsPerRegion` | 8192 | 4MB / 512B = 8192 cards |

### 1.3 å †å†…å­˜åŒºåŸŸ

```
_reserved = {
  _start = 0x600000000    (24GB)
  _word_size = 1073741824 (8GB / 8 bytes per word)
}

Regionæ•°é‡: 2048ä¸ª
æ¯ä¸ªRegion: 4MB
æ€»å †å¤§å°: 2048 Ã— 4MB = 8GB
```

---

## 2. G1CollectedHeap è¯¦è§£

### 2.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1CollectedHeap.hpp:130
class G1CollectedHeap : public CollectedHeap {
private:
    // === æ ¸å¿ƒç»„ä»¶ ===
    G1CollectorPolicy*    _collector_policy;     // GCç­–ç•¥é…ç½®
    G1CardTable*          _card_table;           // å¡è¡¨(å†™å±éšœ)
    HeapRegionManager     _hrm;                  // Regionç®¡ç†å™¨
    G1Allocator*          _allocator;            // å†…å­˜åˆ†é…å™¨
    G1ConcurrentMark*     _cm;                   // å¹¶å‘æ ‡è®°
    G1ConcurrentRefine*   _cr;                   // å¹¶å‘ç»†åŒ–
    G1RemSet*             _g1_rem_set;           // è®°å¿†é›†
    G1Policy*             _g1_policy;            // ç­–ç•¥
    G1HotCardCache*       _hot_card_cache;       // çƒ­å¡ç¼“å­˜
    G1BlockOffsetTable*   _bot;                  // å—åç§»è¡¨
    
    // === å·¥ä½œçº¿ç¨‹ ===
    WorkGang*             _workers;              // å¹¶è¡ŒGCå·¥ä½œçº¿ç¨‹
    G1YoungRemSetSamplingThread* _young_gen_sampling_thread; // å¹´è½»ä»£é‡‡æ ·
    
    // === å †åˆ†åŒºé›†åˆ ===
    G1EdenRegions         _eden;                 // EdenåŒºRegionåˆ—è¡¨
    G1SurvivorRegions     _survivor;             // SurvivoråŒºRegionåˆ—è¡¨
    HeapRegionSet         _old_set;              // è€å¹´ä»£Regioné›†åˆ
    HeapRegionSet         _humongous_set;        // å·¨å‹å¯¹è±¡Regioné›†åˆ
    
    // === æ”¶é›†é›† ===
    G1CollectionSet       _collection_set;       // å¾…å›æ”¶Regioné›†åˆ
    
    // === å¼•ç”¨å¤„ç† ===
    ReferenceProcessor*   _ref_processor_stw;    // STWå¼•ç”¨å¤„ç†å™¨
    ReferenceProcessor*   _ref_processor_cm;     // å¹¶å‘æ ‡è®°å¼•ç”¨å¤„ç†å™¨
    
    // === è„å¡é˜Ÿåˆ— ===
    DirtyCardQueueSet     _dirty_card_queue_set; // è„å¡é˜Ÿåˆ—é›†
    
    // === ç»Ÿè®¡ ===
    size_t                _summary_bytes_used;   // å·²ä½¿ç”¨å­—èŠ‚æ•°
    G1EvacStats           _survivor_evac_stats;  // Survivor PLABç»Ÿè®¡
    G1EvacStats           _old_evac_stats;       // Old PLABç»Ÿè®¡
    
    // === çŠ¶æ€ ===
    G1CollectorState      _collector_state;      // æ”¶é›†å™¨çŠ¶æ€
};
```

### 2.2 å…³é”®å±æ€§è¯¦è§£

| å±æ€§ | GDBå€¼ | ä½œç”¨ |
|-----|-------|------|
| `_hrm._num_committed` | 2048 | å·²æäº¤çš„Regionæ•°é‡ |
| `_hrm._allocated_heapregions_length` | 2048 | å·²åˆ†é…çš„HeapRegionå¯¹è±¡æ•°é‡ |
| `_humongous_object_threshold_in_words` | 262144 | å·¨å‹å¯¹è±¡é˜ˆå€¼ = 2MB (Region/2) |
| `ParallelGCThreads` | 13 | å¹¶è¡ŒGCçº¿ç¨‹æ•° |

### 2.3 CollectorState (GDBéªŒè¯)

```cpp
_collector_state = {
  _in_young_only_phase = true,           // å½“å‰å¤„äºYoung GCé˜¶æ®µ
  _in_young_gc_before_mixed = false,     // ä¸åœ¨Mixed GCå‰çš„Young GC
  _in_initial_mark_gc = false,           // ä¸åœ¨åˆå§‹æ ‡è®°
  _initiate_conc_mark_if_possible = false, // ä¸éœ€è¦è§¦å‘å¹¶å‘æ ‡è®°
  _mark_or_rebuild_in_progress = false,  // æ— æ ‡è®°æˆ–é‡å»ºè¿›è¡Œä¸­
  _clearing_next_bitmap = false,         // ä¸åœ¨æ¸…ç†bitmap
  _in_full_gc = false                    // ä¸åœ¨Full GC
}
```

---

## 3. HeapRegion è¯¦è§£

### 3.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/heapRegion.hpp:191
class HeapRegion: public G1ContiguousSpace {
private:
    HeapRegionRemSet* _rem_set;          // è®°å¿†é›†
    uint              _hrm_index;        // Regionç´¢å¼•å·
    HeapRegionType    _type;             // Regionç±»å‹
    HeapRegion*       _humongous_start_region; // å·¨å‹å¯¹è±¡èµ·å§‹Region
    bool              _evacuation_failed;      // ç–æ•£å¤±è´¥æ ‡è®°
    
    // === é“¾è¡¨æŒ‡é’ˆ ===
    HeapRegion*       _next;             // ä¸‹ä¸€ä¸ªRegion
    HeapRegion*       _prev;             // ä¸Šä¸€ä¸ªRegion
    
    // === æ ‡è®°ä¿¡æ¯ ===
    size_t            _prev_marked_bytes;     // ä¸Šæ¬¡æ ‡è®°çš„å­˜æ´»å­—èŠ‚
    size_t            _next_marked_bytes;     // æœ¬æ¬¡æ ‡è®°çš„å­˜æ´»å­—èŠ‚
    HeapWord*         _prev_top_at_mark_start; // ä¸Šæ¬¡æ ‡è®°å¼€å§‹æ—¶çš„top
    HeapWord*         _next_top_at_mark_start; // æœ¬æ¬¡æ ‡è®°å¼€å§‹æ—¶çš„top
    
    // === GCæ•ˆç‡ ===
    double            _gc_efficiency;    // GCæ•ˆç‡è¯„åˆ†
    
    // === ç”Ÿå­˜ç‡ ===
    SurvRateGroup*    _surv_rate_group;  // ç”Ÿå­˜ç‡ç»„
    int               _age_index;        // å¹´é¾„ç´¢å¼•
    
public:
    // é™æ€é…ç½®
    static int    LogOfHRGrainBytes;     // log2(Regionå¤§å°)
    static int    LogOfHRGrainWords;
    static size_t GrainBytes;            // Regionå¤§å°(å­—èŠ‚)
    static size_t GrainWords;            // Regionå¤§å°(words)
    static size_t CardsPerRegion;        // æ¯ä¸ªRegionçš„å¡æ•°
};
```

### 3.2 Regionç±»å‹

```cpp
// HeapRegionType å®šä¹‰çš„RegionçŠ¶æ€
enum class Tag : uint8_t {
    FreeTag        = 0,  // ç©ºé—²
    EdenTag        = 1,  // EdenåŒº
    SurvTag        = 2,  // SurvivoråŒº
    OldTag         = 3,  // è€å¹´ä»£
    HumStartsTag   = 4,  // å·¨å‹å¯¹è±¡èµ·å§‹
    HumContTag     = 5,  // å·¨å‹å¯¹è±¡å»¶ç»­
    ArchiveTag     = 6,  // å½’æ¡£åŒº
    OpenArchiveTag = 7   // å¼€æ”¾å½’æ¡£åŒº
};
```

### 3.3 Regionå¤§å°è®¡ç®—

```cpp
// å¯¹äº -Xms8g -Xmx8g:
size_t initial_heap_size = 8589934592;  // 8GB
size_t max_heap_size = 8589934592;       // 8GB
size_t average_heap_size = 8GB;

// TARGET_REGION_NUMBER = 2048
size_t region_size = MAX(average_heap_size / 2048, 1MB)
                   = MAX(4MB, 1MB) = 4MB

// å¯¹é½åˆ°2çš„å¹‚
GrainBytes = 4194304;           // 4MB
LogOfHRGrainBytes = 22;         // log2(4MB)
GrainWords = 4194304 / 8 = 524288;
CardsPerRegion = 4194304 / 512 = 8192;

// æ€»Regionæ•°
total_regions = 8GB / 4MB = 2048ä¸ª
```

---

## 4. HeapRegionManager è¯¦è§£

### 4.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/heapRegionManager.hpp:70
class HeapRegionManager: public CHeapObj<mtGC> {
private:
    G1HeapRegionTable      _regions;           // Regionæ•°ç»„(åç½®æ˜ å°„)
    G1RegionToSpaceMapper* _heap_mapper;       // å †å†…å­˜æ˜ å°„å™¨
    G1RegionToSpaceMapper* _prev_bitmap_mapper; // å‰ä¸€bitmapæ˜ å°„å™¨
    G1RegionToSpaceMapper* _next_bitmap_mapper; // ä¸‹ä¸€bitmapæ˜ å°„å™¨
    G1RegionToSpaceMapper* _bot_mapper;        // BOTæ˜ å°„å™¨
    G1RegionToSpaceMapper* _cardtable_mapper;  // å¡è¡¨æ˜ å°„å™¨
    G1RegionToSpaceMapper* _card_counts_mapper; // å¡è®¡æ•°æ˜ å°„å™¨
    
    FreeRegionList         _free_list;         // ç©ºé—²Regioné“¾è¡¨
    CHeapBitMap            _available_map;     // å¯ç”¨Regionä½å›¾
    uint                   _num_committed;     // å·²æäº¤Regionæ•°
    uint                   _allocated_heapregions_length; // å·²åˆ†é…HeapRegionæ•°
    
public:
    uint length() const { return _num_committed; }      // 2048
    uint max_length() const { return _regions.length(); } // 2048
    uint num_free_regions() const { return _free_list.length(); }
};
```

### 4.2 GDBéªŒè¯

```
_hrm._num_committed = 2048
_hrm._allocated_heapregions_length = 2048
```

---

## 5. G1Allocator è¯¦è§£

### 5.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1Allocator.hpp:38
class G1Allocator : public CHeapObj<mtGC> {
private:
    G1CollectedHeap*      _g1h;                // å †å¼•ç”¨
    bool                  _survivor_is_full;   // SurvivoråŒºå·²æ»¡
    bool                  _old_is_full;        // è€å¹´ä»£å·²æ»¡
    
    // === åˆ†é…Region ===
    MutatorAllocRegion    _mutator_alloc_region;    // åº”ç”¨çº¿ç¨‹åˆ†é…Region
    SurvivorGCAllocRegion _survivor_gc_alloc_region; // GCæ—¶Survivoråˆ†é…
    OldGCAllocRegion      _old_gc_alloc_region;     // GCæ—¶è€å¹´ä»£åˆ†é…
    
    HeapRegion*           _retained_old_gc_alloc_region; // ä¿ç•™çš„è€å¹´ä»£Region
    
public:
    HeapWord* attempt_allocation(size_t min_word_size,
                                 size_t desired_word_size,
                                 size_t* actual_word_size);
};
```

### 5.2 åˆ†é…æµç¨‹

```
åº”ç”¨çº¿ç¨‹åˆ†é…:
1. å°è¯•ä» _mutator_alloc_region å¿«é€Ÿåˆ†é… (æ— é”)
2. å¤±è´¥åˆ™è·å– Heap_lockï¼Œå°è¯•æ…¢é€Ÿåˆ†é…
3. ä»å¤±è´¥åˆ™è§¦å‘ Young GC

GCæœŸé—´åˆ†é…:
1. Survivoråˆ†é… â†’ _survivor_gc_alloc_region
2. Oldåˆ†é… â†’ _old_gc_alloc_region
```

---

## 6. G1CardTable è¯¦è§£

### 6.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1CardTable.hpp:47
class G1CardTable: public CardTable {
private:
    G1CardTableChangedListener _listener; // Regionæäº¤ç›‘å¬å™¨
    
public:
    enum G1CardValues {
        g1_young_gen = CT_MR_BS_last_reserved << 1 // å¹´è½»ä»£å¡å€¼
    };
    
    // æ¯512å­—èŠ‚å †å†…å­˜å¯¹åº”1å­—èŠ‚å¡è¡¨
    static size_t heap_map_factor() { return card_size; } // 512
    
    // å¡è¡¨å¤§å°è®¡ç®—
    // 8GB / 512B = 16MB
};
```

### 6.2 å¡çŠ¶æ€

```cpp
enum CardValues {
    clean_card        = -1,   // å¹²å‡€å¡
    dirty_card        = 0,    // è„å¡
    deferred_card     = 4,    // å»¶è¿Ÿå¤„ç†å¡
    claimed_card      = 8,    // å·²è®¤é¢†å¡
    g1_young_gen      = 16    // å¹´è½»ä»£å¡
};
```

### 6.3 å†…å­˜å¸ƒå±€

```
å¯¹äº8GBå †:
å¡è¡¨å¤§å° = 8GB / 512B = 16MB
æ¯ä¸ªRegionå¯¹åº” = 4MB / 512B = 8192 cards
```

---

## 7. G1Policy è¯¦è§£

### 7.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1Policy.hpp:55
class G1Policy: public CHeapObj<mtGC> {
private:
    G1Predictions          _predictor;          // é¢„æµ‹å™¨
    G1Analytics*           _analytics;          // åˆ†æå™¨
    G1RemSetTrackingPolicy _remset_tracker;     // RSetè·Ÿè¸ªç­–ç•¥
    G1MMUTracker*          _mmu_tracker;        // MMUè·Ÿè¸ªå™¨
    G1OldGenAllocationTracker _old_gen_alloc_tracker; // è€å¹´ä»£åˆ†é…è·Ÿè¸ª
    G1IHOPControl*         _ihop_control;       // IHOPæ§åˆ¶
    GCPolicyCounters*      _policy_counters;    // ç­–ç•¥è®¡æ•°å™¨
    
    // === å¹´è½»ä»£å¤§å° ===
    uint                   _young_list_target_length; // ç›®æ ‡YoungåŒºå¤§å°
    uint                   _young_list_fixed_length;  // å›ºå®šYoungåŒºå¤§å°
    uint                   _young_list_max_length;    // æœ€å¤§YoungåŒºå¤§å°
    
    // === ç”Ÿå­˜ç‡ç»„ ===
    SurvRateGroup*         _short_lived_surv_rate_group; // çŸ­å‘½å¯¹è±¡
    SurvRateGroup*         _survivor_surv_rate_group;    // Survivorå¯¹è±¡
    
    // === é¢„ç•™ ===
    double                 _reserve_factor;     // é¢„ç•™å› å­
    uint                   _reserve_regions;    // é¢„ç•™Regionæ•°
    
    G1YoungGenSizer        _young_gen_sizer;    // å¹´è½»ä»£å¤§å°è°ƒæ•´å™¨
};
```

### 7.2 æ ¸å¿ƒåŠŸèƒ½

- **å†³å®šä½•æ—¶GC**: åŸºäºå †å ç”¨ã€åˆ†é…é€Ÿç‡ã€æš‚åœæ—¶é—´ç›®æ ‡
- **é€‰æ‹©CSet**: æ ¹æ®å›æ”¶æ•ˆç‡é€‰æ‹©è¦å›æ”¶çš„Region
- **é¢„æµ‹æš‚åœæ—¶é—´**: åŸºäºå†å²æ•°æ®é¢„æµ‹GCæš‚åœæ—¶é—´
- **IHOPæ§åˆ¶**: å†³å®šä½•æ—¶å¼€å§‹å¹¶å‘æ ‡è®°

---

## 8. G1RemSet è¯¦è§£

### 8.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1RemSet.hpp:57
class G1RemSet: public CHeapObj<mtGC> {
private:
    G1RemSetScanState*     _scan_state;         // æ‰«æçŠ¶æ€
    G1RemSetSummary        _prev_period_summary; // ä¸Šä¸€å‘¨æœŸæ‘˜è¦
    G1CollectedHeap*       _g1h;                // å †å¼•ç”¨
    size_t                 _num_conc_refined_cards; // å¹¶å‘ç»†åŒ–çš„å¡æ•°
    G1CardTable*           _ct;                 // å¡è¡¨
    G1Policy*              _g1p;                // ç­–ç•¥
    G1HotCardCache*        _hot_card_cache;     // çƒ­å¡ç¼“å­˜
    
public:
    void scan_rem_set(G1ParScanThreadState* pss, uint worker_i);
    void update_rem_set(G1ParScanThreadState* pss, uint worker_i);
};
```

### 8.2 åŠŸèƒ½

- **è®°å½•è·¨Regionå¼•ç”¨**: æ¯ä¸ªRegionæœ‰è‡ªå·±çš„RSet
- **æ‰«æCSetçš„RSet**: GCæ—¶æ‰¾å‡ºæŒ‡å‘CSetçš„å¼•ç”¨
- **æ›´æ–°RSet**: å¤„ç†è„å¡é˜Ÿåˆ—ï¼Œæ›´æ–°RSet

---

## 9. HeapRegionRemSet è¯¦è§£

### 9.1 ä¸‰çº§å­˜å‚¨ç»“æ„

```cpp
// src/hotspot/share/gc/g1/heapRegionRemSet.hpp:74
class OtherRegionsTable {
private:
    G1CollectedHeap* _g1h;
    Mutex*           _m;
    HeapRegion*      _hr;
    
    // === ä¸‰çº§å­˜å‚¨ ===
    // 1. ç²—ç²’åº¦ä½å›¾ (Coarse Map)
    CHeapBitMap      _coarse_map;        // æ¯ä¸ªRegion 1ä½
    size_t           _n_coarse_entries;  // ç²—ç²’åº¦æ¡ç›®æ•°
    
    // 2. ç»†ç²’åº¦Per-Regionè¡¨ (Fine-grain PRT)
    PerRegionTable** _fine_grain_regions; // å“ˆå¸Œè¡¨
    size_t           _n_fine_entries;     // ç»†ç²’åº¦æ¡ç›®æ•°
    PerRegionTable*  _first_all_fine_prts; // é“¾è¡¨å¤´
    PerRegionTable*  _last_all_fine_prts;  // é“¾è¡¨å°¾
    
    // 3. ç¨€ç–è¡¨ (Sparse PRT) - åœ¨PerRegionTableå†…éƒ¨
};
```

### 9.2 å­˜å‚¨ç­–ç•¥

```
1. Sparse PRT: å¼•ç”¨æ¥æºå°‘æ—¶ï¼Œå­˜å‚¨æ¯ä¸ªç²¾ç¡®çš„å¡
2. Fine-grain PRT: å¼•ç”¨å¢å¤šæ—¶ï¼Œå‡çº§ä¸ºä½å›¾
3. Coarse Map: å¼•ç”¨å¤ªå¤šæ—¶ï¼Œä»…è®°å½•"æŸRegionæŒ‡å‘æ­¤Region"
```

---

## 10. G1ConcurrentMark è¯¦è§£

### 10.1 ç±»å®šä¹‰

```cpp
// src/hotspot/share/gc/g1/g1ConcurrentMark.hpp
class G1ConcurrentMark : public CHeapObj<mtGC> {
private:
    G1CollectedHeap*       _g1h;           // å †å¼•ç”¨
    G1CMBitMap             _prev_mark_bitmap; // å‰ä¸€æ ‡è®°ä½å›¾
    G1CMBitMap             _next_mark_bitmap; // å½“å‰æ ‡è®°ä½å›¾
    G1CMMarkStack          _global_mark_stack; // å…¨å±€æ ‡è®°æ ˆ
    
    // === å¹¶å‘æ ‡è®°çº¿ç¨‹ ===
    G1ConcurrentMarkThread* _cm_thread;     // å¹¶å‘æ ‡è®°çº¿ç¨‹
    
    // === ä»»åŠ¡é˜Ÿåˆ— ===
    G1CMTaskQueueSet*      _task_queues;    // ä»»åŠ¡é˜Ÿåˆ—é›†
    
    // === æ ¹åŒºåŸŸæ‰«æ ===
    HeapRegion*            _finger;         // æ‰«æè¿›åº¦æŒ‡é’ˆ
    
public:
    void checkpoint_roots_initial();        // åˆå§‹æ ‡è®°
    void mark_from_roots();                 // ä»æ ¹å¼€å§‹æ ‡è®°
    void checkpoint_roots_final(bool clear_all_soft_refs); // æœ€ç»ˆæ ‡è®°
    void cleanup();                         // æ¸…ç†é˜¶æ®µ
};
```

### 10.2 å¹¶å‘æ ‡è®°é˜¶æ®µ

```
1. åˆå§‹æ ‡è®° (STW): æ ‡è®°æ ¹ç›´æ¥å¯è¾¾å¯¹è±¡
2. æ ¹åŒºåŸŸæ‰«æ: æ‰«æSurvivoråŒº
3. å¹¶å‘æ ‡è®°: å¹¶å‘éå†å¯¹è±¡å›¾
4. é‡æ–°æ ‡è®° (STW): å¤„ç†SATBæ—¥å¿—
5. æ¸…ç† (STW): è®¡ç®—å­˜æ´»å­—èŠ‚ï¼Œè¯†åˆ«ç©ºRegion
6. å¹¶å‘æ¸…ç†: å›æ”¶ç©ºRegion
```

---

## 11. G1ConcurrentRefine è¯¦è§£

### 11.1 åŠŸèƒ½

```cpp
// G1 å¹¶å‘ç»†åŒ–
class G1ConcurrentRefine : public CHeapObj<mtGC> {
private:
    G1ConcurrentRefineThread** _threads;  // ç»†åŒ–çº¿ç¨‹æ•°ç»„
    uint                       _n_threads; // çº¿ç¨‹æ•°
    
public:
    // å¤„ç†è„å¡é˜Ÿåˆ—ï¼Œæ›´æ–°RSet
    void threads_do(ThreadClosure* tc);
};
```

### 11.2 å·¥ä½œåŸç†

```
åº”ç”¨çº¿ç¨‹:
  å†™å¼•ç”¨ â†’ å†™å±éšœ â†’ è„å¡é˜Ÿåˆ—

å¹¶å‘ç»†åŒ–çº¿ç¨‹:
  ä»è„å¡é˜Ÿåˆ—å–å¡ â†’ æ›´æ–°å¯¹åº”Regionçš„RSet
```

---

## 12. å¯¹è±¡å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            G1CollectedHeap (0x7ffff00326b0)                         â”‚
â”‚                               G1 GC æ ¸å¿ƒç®¡ç†å¯¹è±¡                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ HeapRegionManager (_hrm)                                                    â”‚   â”‚
â”‚  â”‚  _num_committed = 2048                                                      â”‚   â”‚
â”‚  â”‚  _free_list: ç©ºé—²Regioné“¾è¡¨                                                 â”‚   â”‚
â”‚  â”‚  _regions: HeapRegion* æ•°ç»„ [0..2047]                                       â”‚   â”‚
â”‚  â”‚      â”‚                                                                      â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ HeapRegion[0]: bottom=0x600000000, type=?                         â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ HeapRegion[1]: bottom=0x600400000, type=?                         â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ ...                                                               â”‚   â”‚
â”‚  â”‚      â””â”€â”€ HeapRegion[2047]: bottom=0x7FC00000, type=?                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ G1Allocator          â”‚  â”‚ G1CardTable          â”‚  â”‚ G1BlockOffsetTable   â”‚      â”‚
â”‚  â”‚ (0x7ffff0041520)     â”‚  â”‚ (0x7ffff0042c60)     â”‚  â”‚ (0x7ffff0059180)     â”‚      â”‚
â”‚  â”‚ - å†…å­˜åˆ†é…å™¨         â”‚  â”‚ - 16MBå¡è¡¨           â”‚  â”‚ - 16MB BOT           â”‚      â”‚
â”‚  â”‚ - mutator_alloc      â”‚  â”‚ - æ¯512Bâ†’1å­—èŠ‚       â”‚  â”‚ - å¿«é€Ÿå®šä½å¯¹è±¡       â”‚      â”‚
â”‚  â”‚ - survivor_alloc     â”‚  â”‚ - è„å¡è·Ÿè¸ª           â”‚  â”‚                      â”‚      â”‚
â”‚  â”‚ - old_alloc          â”‚  â”‚                      â”‚  â”‚                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ G1Policy             â”‚  â”‚ G1RemSet             â”‚  â”‚ G1HotCardCache       â”‚      â”‚
â”‚  â”‚ (0x7ffff0038b00)     â”‚  â”‚ (0x7ffff004c670)     â”‚  â”‚ (0x7ffff0042ed0)     â”‚      â”‚
â”‚  â”‚ - GCå†³ç­–             â”‚  â”‚ - è·¨Regionå¼•ç”¨       â”‚  â”‚ - çƒ­å¡ç¼“å­˜           â”‚      â”‚
â”‚  â”‚ - æš‚åœæ—¶é—´é¢„æµ‹       â”‚  â”‚ - RSetæ›´æ–°           â”‚  â”‚ - é¿å…é‡å¤å¤„ç†       â”‚      â”‚
â”‚  â”‚ - CSeté€‰æ‹©           â”‚  â”‚ - è„å¡å¤„ç†           â”‚  â”‚                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ G1ConcurrentMark     â”‚  â”‚ G1ConcurrentRefine   â”‚  â”‚ WorkGang             â”‚      â”‚
â”‚  â”‚ (0x7ffff005a360)     â”‚  â”‚ (0x7ffff0c7e460)     â”‚  â”‚ (0x7ffff003f610)     â”‚      â”‚
â”‚  â”‚ - å¹¶å‘æ ‡è®°           â”‚  â”‚ - å¹¶å‘ç»†åŒ–           â”‚  â”‚ - 13ä¸ªGCçº¿ç¨‹         â”‚      â”‚
â”‚  â”‚ - prev/nextä½å›¾      â”‚  â”‚ - åå°RSetæ›´æ–°       â”‚  â”‚ - å¹¶è¡ŒGCä»»åŠ¡         â”‚      â”‚
â”‚  â”‚ - æ ‡è®°æ ˆ             â”‚  â”‚                      â”‚  â”‚                      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Regioné›†åˆ                                                                   â”‚  â”‚
â”‚  â”‚ _eden: length=0          (åˆå§‹åŒ–åä¸ºç©º)                                      â”‚  â”‚
â”‚  â”‚ _survivor: ç©º            (åˆå§‹åŒ–åä¸ºç©º)                                      â”‚  â”‚
â”‚  â”‚ _old_set: length=0       (åˆå§‹åŒ–åä¸ºç©º)                                      â”‚  â”‚
â”‚  â”‚ _humongous_set: length=0 (åˆå§‹åŒ–åä¸ºç©º)                                      â”‚  â”‚
â”‚  â”‚ _collection_set: å¾…å›æ”¶Regioné›†åˆ                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ CollectorState                                                               â”‚  â”‚
â”‚  â”‚ _in_young_only_phase = true      (å½“å‰å¤„äºYoung GCé˜¶æ®µ)                      â”‚  â”‚
â”‚  â”‚ _in_initial_mark_gc = false                                                  â”‚  â”‚
â”‚  â”‚ _mark_or_rebuild_in_progress = false                                         â”‚  â”‚
â”‚  â”‚ _in_full_gc = false                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HeapRegion å†…éƒ¨ç»“æ„ (æ¯ä¸ªRegion 4MB)                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ HeapRegion                                                             â”‚         â”‚
â”‚  â”‚ _hrm_index: Regionç´¢å¼• (0~2047)                                        â”‚         â”‚
â”‚  â”‚ _type: Free/Eden/Survivor/Old/HumStart/HumCont                         â”‚         â”‚
â”‚  â”‚ _rem_set â†’ HeapRegionRemSet (è®°å½•æŒ‡å‘æœ¬Regionçš„å¼•ç”¨)                   â”‚         â”‚
â”‚  â”‚     â””â”€â”€ OtherRegionsTable                                             â”‚         â”‚
â”‚  â”‚         â”œâ”€â”€ _coarse_map: ç²—ç²’åº¦ä½å›¾ (2048ä½)                           â”‚         â”‚
â”‚  â”‚         â”œâ”€â”€ _fine_grain_regions: PerRegionTable* å“ˆå¸Œè¡¨               â”‚         â”‚
â”‚  â”‚         â””â”€â”€ (å†…éƒ¨) SparsePRT: ç¨€ç–å¡è¡¨                                â”‚         â”‚
â”‚  â”‚                                                                        â”‚         â”‚
â”‚  â”‚ å†…å­˜å¸ƒå±€:                                                              â”‚         â”‚
â”‚  â”‚ bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ end          â”‚         â”‚
â”‚  â”‚ â”‚ å·²åˆ†é…å¯¹è±¡ â”‚ top â”‚       ç©ºé—²ç©ºé—´                      â”‚             â”‚         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. å†…å­˜å¸ƒå±€ (8GB G1GC)

```
64ä½è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€:

0x000000000         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ NULLé¡µ (ä¸å¯è®¿é—®)                  â”‚ 4KB
0x000001000         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                    â”‚
                    â”‚ ç³»ç»Ÿä¿ç•™åŒºåŸŸ                       â”‚ ~2GB
                    â”‚ (å…±äº«åº“ã€æ ˆç©ºé—´ç­‰)                 â”‚
                    â”‚                                    â”‚
0x600000000 (24GB)  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â—„â”€â”€ å †èµ·å§‹
                    â•‘ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â•‘
                    â•‘ â–“â–“    Javaå † (8GB)              â–“â–“ â•‘
                    â•‘ â–“â–“  2048ä¸ªRegion Ã— 4MB/Region   â–“â–“ â•‘
                    â•‘ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘ Region[0]: 0x600000000 ~ 0x600400000â•‘
                    â•‘ Region[1]: 0x600400000 ~ 0x600800000â•‘
                    â•‘ ...                                â•‘
                    â•‘ Region[2047]: 0x7FC00000 ~ 0x800000000â•‘
0x800000000 (32GB)  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â—„â”€â”€ å †ç»“æŸ/ç±»ç©ºé—´èµ·å§‹
                    â•‘ å‹ç¼©ç±»ç©ºé—´ (1GB)                   â•‘
                    â•‘ Narrow Klass Base = 0x800000000    â•‘
0x840000000 (33GB)  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â—„â”€â”€ ç±»ç©ºé—´ç»“æŸ
                    â”‚                                    â”‚
                    â”‚ è¾…åŠ©æ•°æ®ç»“æ„:                      â”‚
                    â”‚ - G1CardTable: 16MB                â”‚
                    â”‚ - G1BlockOffsetTable: 16MB         â”‚
                    â”‚ - prev_bitmap: 16MB                â”‚
                    â”‚ - next_bitmap: 16MB                â”‚
                    â”‚ - card_counts: 4MB                 â”‚
                    â”‚                                    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                    â”‚
                    â”‚ JVMå†…éƒ¨æ•°æ®ç»“æ„                    â”‚
                    â”‚ (CodeCache, ç›´æ¥å†…å­˜ç­‰)            â”‚
                    â”‚                                    â”‚
0x7FFFFFFFFFFF      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. å‹ç¼©æŒ‡é’ˆé…ç½® (GDBéªŒè¯)

### 14.1 Narrow Oop (å‹ç¼©å¯¹è±¡æŒ‡é’ˆ)

```
Universe::_narrow_oop = {
  _base = 0x0,                    // Zero-basedæ¨¡å¼
  _shift = 3,                     // å·¦ç§»3ä½(Ã—8)
  _use_implicit_null_checks = true
}
```

**è§£ç å…¬å¼**: `å®é™…åœ°å€ = narrow_oop << 3`

### 14.2 Narrow Klass (å‹ç¼©ç±»æŒ‡é’ˆ)

```
Universe::_narrow_klass = {
  _base = 0x800000000,            // 32GBä½ç½®
  _shift = 0,                     // æ— éœ€ä½ç§»
  _use_implicit_null_checks = true
}
```

**è§£ç å…¬å¼**: `å®é™…åœ°å€ = narrow_klass + 0x800000000`

---

## 15. å…³é”®æ•°å€¼æ€»ç»“

| é¡¹ç›® | å€¼ | è®¡ç®—å…¬å¼ |
|-----|-----|---------|
| å †å¤§å° | 8GB | -Xms8g -Xmx8g |
| å †èµ·å§‹åœ°å€ | 0x600000000 (24GB) | Zero-basedæ¨¡å¼è‡ªåŠ¨é€‰æ‹© |
| å †ç»“æŸåœ°å€ | 0x800000000 (32GB) | 24GB + 8GB |
| Regionå¤§å° | 4MB | MAX(8GB/2048, 1MB) |
| Regionæ•°é‡ | 2048 | 8GB / 4MB |
| å¡è¡¨å¤§å° | 16MB | 8GB / 512B |
| BOTå¤§å° | 16MB | 8GB / 512B |
| æ¯ä¸ªRegionçš„å¡æ•° | 8192 | 4MB / 512B |
| å·¨å‹å¯¹è±¡é˜ˆå€¼ | 2MB | Region/2 = 4MB/2 |
| å·¨å‹å¯¹è±¡é˜ˆå€¼(words) | 262144 | 2MB / 8B |
| å¹¶è¡ŒGCçº¿ç¨‹ | 13 | åŸºäºCPUæ ¸å¿ƒæ•° |
| ç±»ç©ºé—´å¤§å° | 1GB | é»˜è®¤ |
| ç±»ç©ºé—´èµ·å§‹ | 0x800000000 | å †ç»“æŸåœ°å€ |

---

## 16. é™„å½•: GDBè°ƒè¯•è„šæœ¬

è¯¦ç»†çš„GDBè°ƒè¯•è„šæœ¬å’Œè¾“å‡ºæ–‡ä»¶ä½äºæœ¬ç›®å½•:
- `g1_complete_debug.gdb` - å®Œæ•´è°ƒè¯•è„šæœ¬
- `g1_complete_output.txt` - è°ƒè¯•è¾“å‡º
- `HelloWorld.java` / `HelloWorld.class` - æµ‹è¯•ç¨‹åº
