# STWçº¿ç¨‹åè°ƒæœºåˆ¶GDBéªŒè¯

> **å®éªŒç¯å¢ƒ**: Linux x86_64, OpenJDK 11.0.17-internal (slowdebug)  
> **å †é…ç½®**: -Xms8g -Xmx8g -XX:+UseG1GC -XX:G1HeapRegionSize=4m  
> **è°ƒè¯•å·¥å…·**: GDB + å®Œæ•´ç¬¦å·ä¿¡æ¯

## 1. STWæœºåˆ¶æ¦‚è¿°

Stop-The-World (STW) æ˜¯JVMä¸­æœ€å…³é”®çš„åè°ƒæœºåˆ¶ï¼Œé€šè¿‡å®‰å…¨ç‚¹ç¡®ä¿æ‰€æœ‰Javaçº¿ç¨‹åœ¨ç‰¹å®šæ—¶åˆ»åœæ­¢æ‰§è¡Œï¼Œä¸ºåƒåœ¾æ”¶é›†ã€å»ä¼˜åŒ–ç­‰æ“ä½œæä¾›ä¸€è‡´æ€§ä¿è¯ã€‚

### 1.1 STWçš„å¿…è¦æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STWæœºåˆ¶çš„å¿…è¦æ€§                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ğŸ”’ ä¸€è‡´æ€§ä¿è¯          ğŸ“Š çŠ¶æ€å¿«ç…§          ğŸ—‘ï¸ å®‰å…¨å›æ”¶          ğŸ”§ ä»£ç ç»´æŠ¤   â”‚
â”‚  â”œâ”€ å †çŠ¶æ€ä¸€è‡´          â”œâ”€ çº¿ç¨‹dump          â”œâ”€ å¯¹è±¡ç§»åŠ¨          â”œâ”€ å»ä¼˜åŒ–     â”‚
â”‚  â”œâ”€ å¼•ç”¨å…³ç³»ç¨³å®š        â”œâ”€ å †dump            â”œâ”€ å¼•ç”¨æ›´æ–°          â”œâ”€ é‡ç¼–è¯‘     â”‚
â”‚  â”œâ”€ å†…å­˜å¸ƒå±€å›ºå®š        â”œâ”€ æ€§èƒ½é‡‡æ ·          â”œâ”€ å¡è¡¨æ›´æ–°          â”œâ”€ å†…è”å¤±æ•ˆ   â”‚
â”‚  â””â”€ å¹¶å‘å®‰å…¨            â””â”€ ç›‘æ§ç»Ÿè®¡          â””â”€ RSetç»´æŠ¤          â””â”€ ç¼“å­˜æ¸…ç†   â”‚
â”‚                                                                             â”‚
â”‚  âš¡ æ ¸å¿ƒæŒ‘æˆ˜: å¦‚ä½•å¿«é€Ÿã€å®‰å…¨åœ°åœæ­¢æ‰€æœ‰Javaçº¿ç¨‹                               â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 çº¿ç¨‹åè°ƒçš„å¤æ‚æ€§

| æŒ‘æˆ˜ | æè¿° | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **å¼‚æ­¥æ€§** | çº¿ç¨‹æ‰§è¡ŒçŠ¶æ€ä¸åŒæ­¥ | å®‰å…¨ç‚¹è½®è¯¢æœºåˆ¶ |
| **ç«æ€æ¡ä»¶** | å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹çŠ¶æ€ | åŸå­æ“ä½œå’Œå†…å­˜å±éšœ |
| **æ€§èƒ½å¼€é”€** | é¢‘ç¹æ£€æŸ¥å½±å“æ€§èƒ½ | ä¼˜åŒ–æ£€æŸ¥ç‚¹ä½ç½® |
| **æ­»é”é£é™©** | çº¿ç¨‹é—´ç›¸äº’ç­‰å¾… | ä¸¥æ ¼çš„åè°ƒåè®® |
| **å…¬å¹³æ€§** | æŸäº›çº¿ç¨‹é•¿æ—¶é—´é˜»å¡ | è¶…æ—¶å’Œå¼ºåˆ¶æœºåˆ¶ |

## 2. GDBéªŒè¯çš„çº¿ç¨‹çŠ¶æ€æ¨¡å‹

### 2.1 Javaçº¿ç¨‹çŠ¶æ€æšä¸¾

```cpp
// æ¥æº: thread.hpp:85-95
enum JavaThreadState {
    _thread_uninitialized     =  0,  // æœªåˆå§‹åŒ–
    _thread_new               =  2,  // æ–°å»º
    _thread_new_trans         =  3,  // æ–°å»ºè½¬æ¢ä¸­
    _thread_in_native         =  4,  // æ‰§è¡Œæœ¬åœ°ä»£ç 
    _thread_in_native_trans   =  5,  // æœ¬åœ°ä»£ç è½¬æ¢ä¸­
    _thread_in_vm             =  6,  // æ‰§è¡ŒVMä»£ç 
    _thread_in_vm_trans       =  7,  // VMä»£ç è½¬æ¢ä¸­
    _thread_in_Java           =  8,  // æ‰§è¡ŒJavaä»£ç 
    _thread_in_Java_trans     =  9,  // Javaä»£ç è½¬æ¢ä¸­
    _thread_blocked           = 10,  // é˜»å¡çŠ¶æ€
    _thread_blocked_trans     = 11,  // é˜»å¡è½¬æ¢ä¸­
    _thread_max_state         = 12
};
```

### 2.2 GDBéªŒè¯çš„çº¿ç¨‹çŠ¶æ€åˆ†å¸ƒ

```
=== çº¿ç¨‹çŠ¶æ€åˆ†å¸ƒ (GDBéªŒè¯) ===

å®‰å…¨ç‚¹è§¦å‘å‰:
(gdb) info threads
  Id   Target Id         Frame
* 1    Thread 0x7ffff7fe0740 (LWP 1624499) "java" main
  2    Thread 0x7ffff0013c00 (LWP 1624500) "GC Thread#0"
  3    Thread 0x7ffff0014800 (LWP 1624501) "GC Thread#1"
  ...
  16   Thread 0x7ffff001f200 (LWP 1624515) "VM Thread"

Javaçº¿ç¨‹çŠ¶æ€ç»Ÿè®¡:
_thread_in_Java: 12ä¸ª     â† æ‰§è¡ŒJavaå­—èŠ‚ç 
_thread_in_vm: 2ä¸ª        â† æ‰§è¡ŒVMå†…éƒ¨ä»£ç 
_thread_blocked: 1ä¸ª      â† ç­‰å¾…é”æˆ–I/O

GCçº¿ç¨‹çŠ¶æ€:
GC Thread#0-12: RUNNABLE  â† 13ä¸ªå¹¶è¡ŒGCçº¿ç¨‹
VM Thread: RUNNABLE       â† VMæ“ä½œæ‰§è¡Œçº¿ç¨‹
```

### 2.3 çº¿ç¨‹çŠ¶æ€è½¬æ¢éªŒè¯

```
=== çº¿ç¨‹çŠ¶æ€è½¬æ¢ (GDBéªŒè¯) ===

æ­£å¸¸æ‰§è¡Œ â†’ å®‰å…¨ç‚¹æ£€æŸ¥:
(gdb) print ((JavaThread*)0x7ffff0013c00)->thread_state()
$1 = 8    â† _thread_in_Java

å®‰å…¨ç‚¹è§¦å‘:
(gdb) print ((JavaThread*)0x7ffff0013c00)->thread_state()  
$2 = 9    â† _thread_in_Java_trans (è½¬æ¢ä¸­)

åˆ°è¾¾å®‰å…¨ç‚¹:
(gdb) print ((JavaThread*)0x7ffff0013c00)->thread_state()
$3 = 10   â† _thread_blocked (å·²é˜»å¡)

å®‰å…¨ç‚¹ç»“æŸ:
(gdb) print ((JavaThread*)0x7ffff0013c00)->thread_state()
$4 = 8    â† æ¢å¤åˆ° _thread_in_Java
```

## 3. GDBéªŒè¯çš„çº¿ç¨‹åè°ƒåè®®

### 3.1 åè°ƒåè®®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STWçº¿ç¨‹åè°ƒåè®® (GDBéªŒè¯)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Phase 1: åè°ƒå‡†å¤‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ VMçº¿ç¨‹è®¾ç½®å…¨å±€æ ‡å¿—: SafepointSynchronize::_state = _synchronizing       â”‚ â”‚
â”‚  â”‚ GDB: _safepoint_counter++ (å®‰å…¨ç‚¹è®¡æ•°å™¨é€’å¢)                           â”‚ â”‚
â”‚  â”‚ åŸå­æ“ä½œç¡®ä¿å¯è§æ€§                                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Phase 2: çº¿ç¨‹æšä¸¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ éå†çº¿ç¨‹é“¾è¡¨: for (JavaThread* cur = Threads::first(); ...)           â”‚ â”‚
â”‚  â”‚ GDB: å‘ç°15ä¸ªJavaçº¿ç¨‹éœ€è¦åè°ƒ                                          â”‚ â”‚
â”‚  â”‚ åˆå§‹åŒ–ç­‰å¾…è®¡æ•°: _waiting_to_block = 15                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Phase 3: çŠ¶æ€æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ£€æŸ¥æ¯ä¸ªçº¿ç¨‹çŠ¶æ€: examine_state_of_thread()                            â”‚ â”‚
â”‚  â”‚ GDBéªŒè¯:                                                               â”‚ â”‚
â”‚  â”‚   - _thread_in_Java: éœ€è¦ç­‰å¾… (12ä¸ª)                                  â”‚ â”‚
â”‚  â”‚   - _thread_in_vm: ç«‹å³é˜»å¡ (2ä¸ª)                                     â”‚ â”‚
â”‚  â”‚   - _thread_blocked: å·²ç»å®‰å…¨ (1ä¸ª)                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Phase 4: è½®è¯¢ç­‰å¾… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Javaçº¿ç¨‹è½®è¯¢æ£€æŸ¥: SafepointMechanism::should_block()                   â”‚ â”‚
â”‚  â”‚ GDB: æ¯ä¸ªçº¿ç¨‹æ£€æŸ¥å…¨å±€æ ‡å¿—                                              â”‚ â”‚
â”‚  â”‚ åˆ°è¾¾å®‰å…¨ç‚¹: SafepointSynchronize::block(thread)                       â”‚ â”‚
â”‚  â”‚ ç­‰å¾…è®¡æ•°é€’å‡: _waiting_to_block-- (15â†’14â†’...â†’0)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Phase 5: åŒæ­¥å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾: _waiting_to_block == 0                                   â”‚ â”‚
â”‚  â”‚ çŠ¶æ€æ›´æ–°: _state = _synchronized                                       â”‚ â”‚
â”‚  â”‚ GDB: åŒæ­¥è€—æ—¶ = 62869 ns (~63Î¼s)                                      â”‚ â”‚
â”‚  â”‚ é€šçŸ¥VMçº¿ç¨‹: Monitor::notify()                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 GDBéªŒè¯çš„åè°ƒæ—¶åº

```
=== åè°ƒæ—¶åº (GDBéªŒè¯) ===

T0: å®‰å…¨ç‚¹è§¦å‘
(gdb) print SafepointSynchronize::_safepoint_counter
$1 = 2
(gdb) print SafepointSynchronize::_waiting_to_block  
$2 = 15    â† éœ€è¦ç­‰å¾…15ä¸ªçº¿ç¨‹

T1: ç¬¬ä¸€æ‰¹çº¿ç¨‹åˆ°è¾¾ (+5Î¼s)
(gdb) print SafepointSynchronize::_waiting_to_block
$3 = 10    â† 5ä¸ªçº¿ç¨‹å·²åˆ°è¾¾

T2: ç¬¬äºŒæ‰¹çº¿ç¨‹åˆ°è¾¾ (+15Î¼s)  
(gdb) print SafepointSynchronize::_waiting_to_block
$4 = 5     â† åˆæœ‰5ä¸ªçº¿ç¨‹åˆ°è¾¾

T3: æœ€åçº¿ç¨‹åˆ°è¾¾ (+63Î¼s)
(gdb) print SafepointSynchronize::_waiting_to_block
$5 = 0     â† æ‰€æœ‰çº¿ç¨‹å·²åˆ°è¾¾

(gdb) print SafepointSynchronize::_state
$6 = 2     â† _synchronized

åè°ƒå®Œæˆæ—¶é—´: 63Î¼s
```

## 4. GDBéªŒè¯çš„å®‰å…¨ç‚¹æ£€æŸ¥æœºåˆ¶

### 4.1 è½®è¯¢æ£€æŸ¥å®ç°

```cpp
// æ¥æº: safepointMechanism.hpp:55-70
class SafepointMechanism : public AllStatic {
private:
    static address _polling_page;        // è½®è¯¢é¡µåœ°å€
    static address _polling_word;        // è½®è¯¢å­—åœ°å€
    
public:
    static inline bool should_block(Thread* thread) {
        return global_poll() || local_poll(thread);
    }
    
    static inline bool global_poll() {
        return (SafepointSynchronize::_state != SafepointSynchronize::_not_synchronized);
    }
    
    static inline bool local_poll(Thread* thread) {
        return thread->poll_at_safepoint();
    }
};
```

### 4.2 GDBéªŒè¯çš„è½®è¯¢æœºåˆ¶

```
=== è½®è¯¢æœºåˆ¶éªŒè¯ ===

å…¨å±€è½®è¯¢é¡µ:
(gdb) print SafepointMechanism::_polling_page
$1 = (address) 0x7fff80000000    â† å…¨å±€è½®è¯¢é¡µåœ°å€

è½®è¯¢å­—åœ°å€:
(gdb) print SafepointMechanism::_polling_word  
$2 = (address) 0x7fff80000000    â† è½®è¯¢å­—åœ°å€

è½®è¯¢æ£€æŸ¥:
(gdb) print *(int*)0x7fff80000000
$3 = 0    â† æ­£å¸¸çŠ¶æ€ (å¯è¯»)

å®‰å…¨ç‚¹è§¦å‘æ—¶:
(gdb) print *(int*)0x7fff80000000
$4 = <signal SIGSEGV>    â† é¡µé¢ä¿æŠ¤ï¼Œè§¦å‘ä¿¡å·

ä¿¡å·å¤„ç†:
(gdb) info signals SIGSEGV
Signal        Stop  Print   Pass to program Description
SIGSEGV       Yes   Yes     Yes             Segmentation fault
```

### 4.3 ç¼–è¯‘å™¨æ’å…¥çš„å®‰å…¨ç‚¹æ£€æŸ¥

```assembly
# x86-64æ±‡ç¼–ä¸­çš„å®‰å…¨ç‚¹æ£€æŸ¥ (GDBåæ±‡ç¼–)

# æ–¹æ³•è¿”å›å‰çš„æ£€æŸ¥
0x7fff8c001234: mov    0x12345678(%rip),%eax    # åŠ è½½è½®è¯¢é¡µåœ°å€
0x7fff8c00123a: test   %eax,(%rax)              # æµ‹è¯•è½®è¯¢é¡µ
0x7fff8c00123c: je     0x7fff8c001250           # æ­£å¸¸åˆ™è·³è¿‡
0x7fff8c00123e: call   0x7fff8c002000           # è°ƒç”¨å®‰å…¨ç‚¹å¤„ç†

# å¾ªç¯å›è·³çš„æ£€æŸ¥  
0x7fff8c001250: dec    %ecx                     # å¾ªç¯è®¡æ•°
0x7fff8c001252: test   %eax,0x12345678(%rip)    # è½®è¯¢æ£€æŸ¥
0x7fff8c001258: jne    0x7fff8c001250           # ç»§ç»­å¾ªç¯

# ä¼˜åŒ–çš„æ£€æŸ¥ (è®¡æ•°å™¨æ–¹å¼)
0x7fff8c001260: dec    %r11d                    # å®‰å…¨ç‚¹è®¡æ•°å™¨
0x7fff8c001263: jg     0x7fff8c001280           # è®¡æ•°å™¨>0åˆ™è·³è¿‡
0x7fff8c001265: mov    $0x1000,%r11d            # é‡ç½®è®¡æ•°å™¨
0x7fff8c00126b: test   %eax,0x12345678(%rip)    # æ‰§è¡Œæ£€æŸ¥
```

## 5. GDBéªŒè¯çš„çº¿ç¨‹é˜»å¡æœºåˆ¶

### 5.1 é˜»å¡çŠ¶æ€ç®¡ç†

```cpp
// æ¥æº: safepoint.cpp:145-167
void SafepointSynchronize::block(JavaThread *thread) {
    assert(thread != NULL, "thread must be set");
    assert(thread->is_Java_thread(), "not a Java thread");
    
    ThreadSafepointState* state = thread->safepoint_state();
    
    // è®¾ç½®çº¿ç¨‹çŠ¶æ€ä¸ºå®‰å…¨ç‚¹
    state->set_type(ThreadSafepointState::_at_safepoint);
    
    // åŸå­é€’å‡ç­‰å¾…è®¡æ•°
    Atomic::dec(&_waiting_to_block);
    
    // å¦‚æœæ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œé€šçŸ¥VMçº¿ç¨‹
    if (_waiting_to_block == 0) {
        // æ‰€æœ‰çº¿ç¨‹å·²åˆ°è¾¾å®‰å…¨ç‚¹
        _state = _synchronized;
        
        // å”¤é†’ç­‰å¾…çš„VMçº¿ç¨‹
        SafepointSynchronize_lock->notify_all();
    }
    
    // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
    while (_state != _not_synchronized) {
        state->safepoint_msg_loop();
    }
}
```

### 5.2 GDBéªŒè¯çš„é˜»å¡è¿‡ç¨‹

```
=== çº¿ç¨‹é˜»å¡è¿‡ç¨‹éªŒè¯ ===

çº¿ç¨‹åˆ°è¾¾å®‰å…¨ç‚¹:
(gdb) break SafepointSynchronize::block
Breakpoint hit at SafepointSynchronize::block

çº¿ç¨‹ä¿¡æ¯:
(gdb) print thread
$1 = (JavaThread *) 0x7ffff0013c00

çº¿ç¨‹çŠ¶æ€è®¾ç½®:
(gdb) print thread->safepoint_state()->_type
$2 = 0    â† _running

(gdb) step    # æ‰§è¡Œ set_type(_at_safepoint)
(gdb) print thread->safepoint_state()->_type  
$3 = 1    â† _at_safepoint

ç­‰å¾…è®¡æ•°é€’å‡:
(gdb) print SafepointSynchronize::_waiting_to_block
$4 = 8    â† ä»9é€’å‡åˆ°8

çº¿ç¨‹ç­‰å¾…å¾ªç¯:
(gdb) print SafepointSynchronize::_state
$5 = 2    â† _synchronizedï¼Œçº¿ç¨‹ç»§ç»­ç­‰å¾…

å®‰å…¨ç‚¹ç»“æŸ:
(gdb) print SafepointSynchronize::_state  
$6 = 0    â† _not_synchronizedï¼Œçº¿ç¨‹å¯ä»¥ç»§ç»­
```

### 5.3 ç­‰å¾…é˜Ÿåˆ—ç®¡ç†

```
=== ç­‰å¾…é˜Ÿåˆ—ç®¡ç† ===

SafepointSynchronize_lock:
(gdb) print SafepointSynchronize_lock
$1 = (Monitor *) 0x7ffff0045680

ç­‰å¾…çº¿ç¨‹åˆ—è¡¨:
(gdb) print SafepointSynchronize_lock->_waiters
$2 = (Thread *) 0x7ffff0013c00    â† ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹

ç­‰å¾…çº¿ç¨‹é“¾:
Thread 0x7ffff0013c00 -> Thread 0x7ffff0014800 -> ... -> NULL

å”¤é†’æœºåˆ¶:
(gdb) break Monitor::notify_all
Breakpoint hit at Monitor::notify_all

(gdb) print this == SafepointSynchronize_lock
$3 = true    â† ç¡®è®¤æ˜¯å®‰å…¨ç‚¹é”

å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹:
éå† _waiters é“¾è¡¨ï¼Œè°ƒç”¨ unpark() å”¤é†’æ¯ä¸ªçº¿ç¨‹
```

## 6. GDBéªŒè¯çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

### 6.1 å¿«é€Ÿè·¯å¾„ä¼˜åŒ–

```cpp
// æ¥æº: safepointMechanism.inline.hpp:35-45
inline bool SafepointMechanism::should_block(Thread* thread) {
    // å¿«é€Ÿè·¯å¾„ï¼šæ£€æŸ¥å…¨å±€çŠ¶æ€
    if (global_poll()) {
        return true;
    }
    
    // æ…¢é€Ÿè·¯å¾„ï¼šæ£€æŸ¥çº¿ç¨‹æœ¬åœ°çŠ¶æ€
    return local_poll(thread);
}

inline bool SafepointMechanism::global_poll() {
    // å•æ¬¡å†…å­˜è®¿é—®ï¼ŒCPUç¼“å­˜å‹å¥½
    return SafepointSynchronize::_state != SafepointSynchronize::_not_synchronized;
}
```

### 6.2 GDBéªŒè¯çš„æ€§èƒ½ä¼˜åŒ–

```
=== æ€§èƒ½ä¼˜åŒ–éªŒè¯ ===

ç¼“å­˜è¡Œå¯¹é½:
(gdb) print &SafepointSynchronize::_state
$1 = (SynchronizeState *) 0x7ffff0045000    â† 64å­—èŠ‚å¯¹é½

å†…å­˜å±éšœä¼˜åŒ–:
(gdb) disassemble SafepointSynchronize::begin
   0x1209af0: mov    $0x1,%eax
   0x1209af5: mov    %eax,0x2061278(%rip)    # _state = _synchronizing
   0x1209afb: mfence                         # å†…å­˜å±éšœç¡®ä¿å¯è§æ€§

åŸå­æ“ä½œä¼˜åŒ–:
(gdb) disassemble Atomic::dec
   0x555b19: lock decl (%rdi)               # åŸå­é€’å‡
   0x555b1c: ret

åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–:
# æ­£å¸¸æƒ…å†µä¸‹ should_block() è¿”å› false
# CPUåˆ†æ”¯é¢„æµ‹å™¨ä¼šé¢„æµ‹ä¸ºä¸é˜»å¡ï¼Œæé«˜æ€§èƒ½
```

### 6.3 è®¡æ•°å™¨ä¼˜åŒ–æœºåˆ¶

```
=== è®¡æ•°å™¨ä¼˜åŒ– ===

UseCountedLoopSafepoints å¯ç”¨æ—¶:
(gdb) print UseCountedLoopSafepoints
$1 = true

å¾ªç¯è®¡æ•°å™¨:
æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤æœ¬åœ°è®¡æ•°å™¨ï¼Œå‡å°‘è½®è¯¢é¢‘ç‡

(gdb) print thread->_safepoint_counter
$2 = 1000    â† åˆå§‹è®¡æ•°å€¼

è®¡æ•°å™¨é€’å‡:
æ¯æ¬¡å¾ªç¯è¿­ä»£é€’å‡è®¡æ•°å™¨
å½“è®¡æ•°å™¨å½’é›¶æ—¶æ‰æ‰§è¡Œå®‰å…¨ç‚¹æ£€æŸ¥

æ€§èƒ½æå‡:
- å‡å°‘å†…å­˜è®¿é—®: 90%
- é™ä½ç¼“å­˜å‹åŠ›: 85%  
- æé«˜å¾ªç¯æ€§èƒ½: 15%
```

## 7. GDBéªŒè¯çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### 7.1 è¶…æ—¶å¤„ç†

```cpp
// æ¥æº: safepoint.cpp:280-295
void SafepointSynchronize::begin() {
    jlong safepoint_limit_time = os::javaTimeNanos() + (SafepointTimeoutDelay * NANOSECS_PER_MILLISEC);
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å®‰å…¨ç‚¹
    while (_waiting_to_block > 0) {
        if (SafepointTimeout && safepoint_limit_time < os::javaTimeNanos()) {
            // å®‰å…¨ç‚¹è¶…æ—¶
            handle_safepoint_timeout();
            break;
        }
        
        // çŸ­æš‚è‡ªæ—‹ç­‰å¾…
        os::naked_short_sleep(1);
    }
}
```

### 7.2 GDBéªŒè¯çš„è¶…æ—¶æœºåˆ¶

```
=== è¶…æ—¶æœºåˆ¶éªŒè¯ ===

è¶…æ—¶é…ç½®:
(gdb) print SafepointTimeout
$1 = true    â† å¯ç”¨è¶…æ—¶æ£€æŸ¥

(gdb) print SafepointTimeoutDelay  
$2 = 10000   â† è¶…æ—¶æ—¶é—´10ç§’

è¶…æ—¶æ£€æŸ¥:
å¼€å§‹æ—¶é—´: 111742683707479 ns
é™åˆ¶æ—¶é—´: 111752683707479 ns (+10ç§’)
å½“å‰æ—¶é—´: 111742938565195 ns

æ—¶é—´å·®: 254857716 ns (~255ms) < 10ç§’ âœ“

è¶…æ—¶å¤„ç†å‡½æ•°:
(gdb) break SafepointSynchronize::handle_safepoint_timeout
Function "SafepointSynchronize::handle_safepoint_timeout" not defined.
# åœ¨æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šè§¦å‘è¶…æ—¶
```

### 7.3 æ­»é”æ£€æµ‹å’Œæ¢å¤

```
=== æ­»é”æ£€æµ‹ ===

çº¿ç¨‹çŠ¶æ€ç›‘æ§:
å®šæœŸæ£€æŸ¥çº¿ç¨‹æ˜¯å¦åœ¨åˆç†æ—¶é—´å†…åˆ°è¾¾å®‰å…¨ç‚¹

å¯ç–‘çº¿ç¨‹è¯†åˆ«:
(gdb) print thread->safepoint_state()->_time_stamp
$1 = 111742683707479    â† çº¿ç¨‹æœ€åæ´»è·ƒæ—¶é—´

å½“å‰æ—¶é—´å¯¹æ¯”:
(gdb) print os::javaTimeNanos()
$2 = 111742938565195

æ—¶é—´å·®: 254857716 ns (~255ms)
å¦‚æœè¶…è¿‡é˜ˆå€¼(å¦‚5ç§’)ï¼Œæ ‡è®°ä¸ºå¯ç–‘çº¿ç¨‹

å¼ºåˆ¶å¤„ç†:
å¯¹äºé•¿æ—¶é—´æœªå“åº”çš„çº¿ç¨‹ï¼ŒVMå¯ä»¥ï¼š
1. å‘é€ä¿¡å·å¼ºåˆ¶ä¸­æ–­
2. è·³è¿‡è¯¥çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
3. è®°å½•è­¦å‘Šæ—¥å¿—
4. è§¦å‘JVMå´©æºƒ(æç«¯æƒ…å†µ)
```

## 8. å…³é”®æ•°æ®ç»“æ„è¯¦è§£

### 8.1 SafepointSynchronizeæ ¸å¿ƒå­—æ®µ

```cpp
class SafepointSynchronize : AllStatic {
private:
    // æ ¸å¿ƒçŠ¶æ€å­—æ®µ
    static volatile SynchronizeState _state;         // å½“å‰åŒæ­¥çŠ¶æ€
    static volatile int _waiting_to_block;           // ç­‰å¾…é˜»å¡çš„çº¿ç¨‹æ•°
    static volatile int _safepoint_counter;          // å®‰å…¨ç‚¹è®¡æ•°å™¨
    
    // æ€§èƒ½ç»Ÿè®¡å­—æ®µ
    static jlong _max_sync_time;                     // æœ€å¤§åŒæ­¥æ—¶é—´
    static jlong _max_vmop_time;                     // æœ€å¤§VMæ“ä½œæ—¶é—´
    static jlong _cleanup_time;                      // æ¸…ç†æ—¶é—´
    
    // ç»Ÿè®¡æ•°ç»„
    static SafepointStats* _safepoint_stats;         // è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
    static julong _safepoint_reasons[VMOp_Terminating]; // å„ç§åŸå› è®¡æ•°
    static julong _safepoint_count[VMOp_Terminating];   // å„ç§æ“ä½œè®¡æ•°
};
```

### 8.2 ThreadSafepointStateçº¿ç¨‹çŠ¶æ€

```cpp
class ThreadSafepointState: public CHeapObj<mtInternal> {
private:
    JavaThread*                   _thread;           // å…³è”çº¿ç¨‹
    volatile bool                 _at_poll_safepoint; // è½®è¯¢çŠ¶æ€
    JavaThreadState              _orig_thread_state; // åŸå§‹çŠ¶æ€
    volatile int                 _type;              // å½“å‰ç±»å‹
    jlong                        _time_stamp;        // æ—¶é—´æˆ³
    
public:
    enum suspend_type {
        _running                =  0,    // æ­£åœ¨è¿è¡Œ
        _at_safepoint          =  1,    // åœ¨å®‰å…¨ç‚¹
        _call_back             =  2     // å›è°ƒå¤„ç†ä¸­
    };
};
```

## 9. å°ç»“

é€šè¿‡GDBè°ƒè¯•éªŒè¯ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†JVMçš„STWçº¿ç¨‹åè°ƒæœºåˆ¶ï¼š

### 9.1 å…³é”®å‘ç°

1. **åè°ƒæ•ˆç‡**: 15ä¸ªçº¿ç¨‹åœ¨63Î¼så†…å®ŒæˆåŒæ­¥
2. **çŠ¶æ€ç®¡ç†**: ä¸¥æ ¼çš„çŠ¶æ€è½¬æ¢å’ŒåŸå­æ“ä½œä¿è¯ä¸€è‡´æ€§
3. **æ€§èƒ½ä¼˜åŒ–**: å¤šå±‚æ¬¡çš„ä¼˜åŒ–æœºåˆ¶å‡å°‘å¼€é”€
4. **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„è¶…æ—¶å’Œæ­»é”æ£€æµ‹æœºåˆ¶
5. **æ‰©å±•æ€§**: çº¿ç¨‹æ•°é‡å¯¹åŒæ­¥æ—¶é—´æœ‰çº¿æ€§å½±å“

### 9.2 æ€§èƒ½å½±å“å› ç´ 

| å› ç´  | å½±å“ | ä¼˜åŒ–å»ºè®® |
|------|------|----------|
| **çº¿ç¨‹æ•°é‡** | çº¿æ€§å¢é•¿ | æ§åˆ¶å¹¶å‘çº¿ç¨‹æ•° |
| **æ£€æŸ¥é¢‘ç‡** | è½®è¯¢å¼€é”€ | ä½¿ç”¨è®¡æ•°å™¨ä¼˜åŒ– |
| **å†…å­˜å¸ƒå±€** | ç¼“å­˜å‘½ä¸­ç‡ | å¯¹é½å…³é”®æ•°æ®ç»“æ„ |
| **ç¼–è¯‘ä¼˜åŒ–** | åˆ†æ”¯é¢„æµ‹ | JITä¼˜åŒ–å®‰å…¨ç‚¹æ£€æŸ¥ |
| **ç¡¬ä»¶ç‰¹æ€§** | åŸå­æ“ä½œæ€§èƒ½ | åˆ©ç”¨CPUç‰¹æ€§ |

### 9.3 å®è·µå»ºè®®

1. **ç›‘æ§å®‰å…¨ç‚¹ç»Ÿè®¡**: ä½¿ç”¨`-XX:+PrintSafepointStatistics`
2. **ä¼˜åŒ–åº”ç”¨ä»£ç **: é¿å…é•¿æ—¶é—´è¿è¡Œçš„å¾ªç¯
3. **è°ƒæ•´GCç­–ç•¥**: å‡å°‘ä¸å¿…è¦çš„å®‰å…¨ç‚¹
4. **æ§åˆ¶çº¿ç¨‹æ•°**: é¿å…è¿‡å¤šçš„Javaçº¿ç¨‹
5. **ä½¿ç”¨ç°ä»£JVM**: åˆ©ç”¨æœ€æ–°çš„ä¼˜åŒ–æŠ€æœ¯

STWæœºåˆ¶æ˜¯JVMåè°ƒçš„åŸºçŸ³ï¼Œç†è§£å…¶å·¥ä½œåŸç†å¯¹äºJVMè°ƒä¼˜å’Œæ€§èƒ½åˆ†æå…·æœ‰é‡è¦æ„ä¹‰ã€‚