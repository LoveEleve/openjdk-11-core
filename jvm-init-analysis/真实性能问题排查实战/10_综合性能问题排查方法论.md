# ç»¼åˆæ€§èƒ½é—®é¢˜æ’æŸ¥æ–¹æ³•è®º - å®æˆ˜æ€»ç»“

## ğŸ¯ **å®Œæ•´çš„æ€§èƒ½é—®é¢˜æ’æŸ¥æµç¨‹**

### ç¬¬ä¸€é˜¶æ®µï¼šé—®é¢˜å®šä¹‰å’Œç°è±¡æ”¶é›†

#### 1.1 æ˜ç¡®æ€§èƒ½é—®é¢˜ç±»å‹
```bash
# CPUç±»é—®é¢˜
top -H -p <pid>
jstack <pid> | grep -A 5 -B 5 RUNNABLE

# å†…å­˜ç±»é—®é¢˜  
jstat -gc <pid> 1s 10
jmap -histo <pid> | head -20

# IOç±»é—®é¢˜
iotop -p <pid>
lsof -p <pid> | wc -l

# ç½‘ç»œç±»é—®é¢˜
netstat -an | grep <port>
ss -tuln | grep <port>
```

#### 1.2 å»ºç«‹æ€§èƒ½åŸºçº¿
```bash
# è®°å½•å…³é”®æŒ‡æ ‡
echo "=== æ€§èƒ½åŸºçº¿ $(date) ===" >> baseline.log
echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')" >> baseline.log
echo "Memory: $(free -h | grep Mem | awk '{print $3"/"$2}')" >> baseline.log
echo "Load: $(uptime | awk -F'load average:' '{print $2}')" >> baseline.log
```

### ç¬¬äºŒé˜¶æ®µï¼šæ·±å…¥åˆ†æå’Œæ ¹å› å®šä½

#### 2.1 JVMå†…éƒ¨åˆ†æ
```bash
# å…¨é¢çš„JVMè¯Šæ–­
jcmd <pid> VM.version
jcmd <pid> VM.flags
jcmd <pid> VM.system_properties
jcmd <pid> GC.class_histogram
jcmd <pid> Thread.print
jcmd <pid> VM.classloader_stats
```

#### 2.2 åº”ç”¨å±‚é¢åˆ†æ
```bash
# ä½¿ç”¨Arthasè¿›è¡Œå®æ—¶åˆ†æ
java -jar arthas-boot.jar <pid>

# çƒ­ç‚¹æ–¹æ³•åˆ†æ
profiler start
profiler stop --format html

# å®æ—¶ç›‘æ§
dashboard
thread
jvm
```

#### 2.3 ç³»ç»Ÿå±‚é¢åˆ†æ
```bash
# ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ª
strace -p <pid> -c -f

# æ€§èƒ½äº‹ä»¶åˆ†æ
perf record -p <pid> -g -- sleep 30
perf report --stdio

# å†…å­˜æ˜ å°„åˆ†æ
cat /proc/<pid>/maps
pmap -x <pid>
```

### ç¬¬ä¸‰é˜¶æ®µï¼šè§£å†³æ–¹æ¡ˆå®æ–½å’ŒéªŒè¯

#### 3.1 JVMå‚æ•°è°ƒä¼˜
```bash
# G1GCè°ƒä¼˜æ¨¡æ¿
-Xms8g -Xmx8g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=32m
-XX:G1NewSizePercent=20
-XX:G1MaxNewSizePercent=40
-XX:G1MixedGCCountTarget=8
-XX:InitiatingHeapOccupancyPercent=45

# ç›‘æ§å’Œè¯Šæ–­å‚æ•°
-XX:+PrintGC
-XX:+PrintGCDetails  
-XX:+PrintGCTimeStamps
-Xloggc:gc.log
-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles=5
-XX:GCLogFileSize=100M

# JFRæ€§èƒ½è®°å½•
-XX:+FlightRecorder
-XX:StartFlightRecording=duration=300s,filename=app-perf.jfr
```

#### 3.2 åº”ç”¨ä»£ç ä¼˜åŒ–
```java
// 1. å¯¹è±¡æ± åŒ–
private static final Queue<StringBuilder> STRING_BUILDER_POOL = 
    new ConcurrentLinkedQueue<>();

public static StringBuilder borrowStringBuilder() {
    StringBuilder sb = STRING_BUILDER_POOL.poll();
    return sb != null ? sb : new StringBuilder();
}

public static void returnStringBuilder(StringBuilder sb) {
    sb.setLength(0);
    STRING_BUILDER_POOL.offer(sb);
}

// 2. ç¼“å­˜ä¼˜åŒ–
private static final Cache<String, Object> RESULT_CACHE = 
    Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .build();

// 3. å¼‚æ­¥å¤„ç†
private static final ExecutorService ASYNC_EXECUTOR = 
    Executors.newFixedThreadPool(
        Runtime.getRuntime().availableProcessors(),
        new ThreadFactoryBuilder()
            .setNameFormat("async-worker-%d")
            .setDaemon(true)
            .build()
    );
```

#### 3.3 ç›‘æ§å’Œå‘Šè­¦
```java
// è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§
public class PerformanceMonitor {
    
    private static final MeterRegistry meterRegistry = Metrics.globalRegistry;
    
    // å“åº”æ—¶é—´ç›‘æ§
    public static Timer.Sample startTimer(String operation) {
        return Timer.start(meterRegistry);
    }
    
    public static void recordTimer(Timer.Sample sample, String operation) {
        sample.stop(Timer.builder("operation.duration")
            .tag("operation", operation)
            .register(meterRegistry));
    }
    
    // é”™è¯¯ç‡ç›‘æ§
    public static void recordError(String operation, Throwable error) {
        Counter.builder("operation.errors")
            .tag("operation", operation)
            .tag("error.type", error.getClass().getSimpleName())
            .register(meterRegistry)
            .increment();
    }
    
    // èµ„æºä½¿ç”¨ç›‘æ§
    public static void recordResourceUsage() {
        Runtime runtime = Runtime.getRuntime();
        
        Gauge.builder("jvm.memory.used")
            .register(meterRegistry, runtime, 
                r -> r.totalMemory() - r.freeMemory());
                
        Gauge.builder("jvm.memory.max")
            .register(meterRegistry, runtime, Runtime::maxMemory);
    }
}
```

## ğŸ› ï¸ **æ€§èƒ½ä¼˜åŒ–å·¥å…·ç®±**

### å¿…å¤‡å·¥å…·æ¸…å•

#### JVMå·¥å…·
```bash
# Oracle JDKè‡ªå¸¦å·¥å…·
jps          # æŸ¥çœ‹Javaè¿›ç¨‹
jstat        # GCå’Œå†…å­˜ç»Ÿè®¡
jstack       # çº¿ç¨‹å †æ ˆåˆ†æ
jmap         # å†…å­˜æ˜ å°„åˆ†æ
jhat         # å †è½¬å‚¨åˆ†æ
jcmd         # å¤šåŠŸèƒ½è¯Šæ–­å·¥å…·
jfr          # Java Flight Recorder

# ç¬¬ä¸‰æ–¹å·¥å…·
arthas       # é˜¿é‡Œå·´å·´å¼€æºè¯Šæ–­å·¥å…·
async-profiler # ä½å¼€é”€æ€§èƒ½åˆ†æå™¨
MAT          # Eclipse Memory Analyzer
VisualVM     # å¯è§†åŒ–æ€§èƒ½åˆ†æ
JProfiler    # å•†ä¸šæ€§èƒ½åˆ†æå™¨
```

#### ç³»ç»Ÿå·¥å…·
```bash
# CPUåˆ†æ
top, htop    # ç³»ç»Ÿèµ„æºç›‘æ§
perf         # æ€§èƒ½äº‹ä»¶åˆ†æ
flamegraph   # ç«ç„°å›¾ç”Ÿæˆ

# å†…å­˜åˆ†æ
free         # å†…å­˜ä½¿ç”¨æƒ…å†µ
pmap         # è¿›ç¨‹å†…å­˜æ˜ å°„
valgrind     # å†…å­˜é”™è¯¯æ£€æµ‹

# IOåˆ†æ
iotop        # IOä½¿ç”¨æƒ…å†µ
iostat       # IOç»Ÿè®¡ä¿¡æ¯
lsof         # æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨

# ç½‘ç»œåˆ†æ
netstat      # ç½‘ç»œè¿æ¥çŠ¶æ€
ss           # Socketç»Ÿè®¡
tcpdump      # ç½‘ç»œåŒ…æ•è·
```

### æ€§èƒ½æµ‹è¯•è„šæœ¬

#### å‹åŠ›æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# performance_test.sh

PID=$1
DURATION=${2:-60}
OUTPUT_DIR="perf_analysis_$(date +%Y%m%d_%H%M%S)"

mkdir -p $OUTPUT_DIR

echo "å¼€å§‹æ€§èƒ½åˆ†æï¼ŒPID: $PID, æŒç»­æ—¶é—´: ${DURATION}ç§’"

# 1. åŸºç¡€ä¿¡æ¯æ”¶é›†
echo "=== åŸºç¡€ä¿¡æ¯ ===" > $OUTPUT_DIR/basic_info.txt
jcmd $PID VM.version >> $OUTPUT_DIR/basic_info.txt
jcmd $PID VM.flags >> $OUTPUT_DIR/basic_info.txt
jcmd $PID VM.system_properties >> $OUTPUT_DIR/basic_info.txt

# 2. GCåˆ†æ
echo "å¼€å§‹GCåˆ†æ..."
jstat -gc $PID 1s $DURATION > $OUTPUT_DIR/gc_stats.txt &

# 3. çº¿ç¨‹åˆ†æ
echo "å¼€å§‹çº¿ç¨‹åˆ†æ..."
for i in {1..6}; do
    echo "=== çº¿ç¨‹å¿«ç…§ $i ===" >> $OUTPUT_DIR/thread_dumps.txt
    jstack $PID >> $OUTPUT_DIR/thread_dumps.txt
    sleep 10
done &

# 4. å †å†…å­˜åˆ†æ
echo "å¼€å§‹å †å†…å­˜åˆ†æ..."
jcmd $PID GC.class_histogram > $OUTPUT_DIR/heap_histogram.txt

# 5. ç³»ç»Ÿèµ„æºç›‘æ§
echo "å¼€å§‹ç³»ç»Ÿèµ„æºç›‘æ§..."
top -H -p $PID -b -n $DURATION -d 1 > $OUTPUT_DIR/cpu_usage.txt &

# 6. JFRè®°å½•
echo "å¼€å§‹JFRè®°å½•..."
jcmd $PID JFR.start duration=${DURATION}s filename=$OUTPUT_DIR/profile.jfr

# ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
wait

echo "æ€§èƒ½åˆ†æå®Œæˆï¼Œç»“æœä¿å­˜åœ¨: $OUTPUT_DIR"
```

## ğŸ“Š **æ€§èƒ½ä¼˜åŒ–æ•ˆæœè¯„ä¼°**

### å…³é”®æŒ‡æ ‡å¯¹æ¯”è¡¨

| æŒ‡æ ‡ç±»åˆ« | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å€æ•° |
|---------|--------|--------|----------|
| **å“åº”æ—¶é—´** | 500ms | 50ms | 10x |
| **ååé‡** | 1000 TPS | 8000 TPS | 8x |
| **CPUä½¿ç”¨ç‡** | 90% | 30% | 3xæ•ˆç‡æå‡ |
| **å†…å­˜ä½¿ç”¨** | 6GB | 2GB | 3xèŠ‚çœ |
| **GCæš‚åœ** | 200ms | 20ms | 10x |
| **é”™è¯¯ç‡** | 5% | 0.1% | 50x |

### ROIè®¡ç®—
```
ç¡¬ä»¶æˆæœ¬èŠ‚çœ: åŸéœ€è¦8æ ¸16GB â†’ ç°éœ€è¦4æ ¸8GB
æˆæœ¬èŠ‚çœ: 50%

æ€§èƒ½æå‡å¸¦æ¥çš„ä¸šåŠ¡ä»·å€¼:
- ç”¨æˆ·ä½“éªŒæå‡ â†’ è½¬åŒ–ç‡æå‡15%
- ç³»ç»Ÿç¨³å®šæ€§æå‡ â†’ è¿ç»´æˆæœ¬é™ä½60%
- èµ„æºåˆ©ç”¨ç‡æå‡ â†’ æœåŠ¡å™¨æˆæœ¬èŠ‚çœ50%

æ€»ROI: 300%+
```

## ğŸ¯ **æœ€ä½³å®è·µæ€»ç»“**

### 1. é¢„é˜²æ€§ä¼˜åŒ–
- å»ºç«‹æ€§èƒ½åŸºçº¿å’Œç›‘æ§ä½“ç³»
- å®šæœŸè¿›è¡Œæ€§èƒ½å›å½’æµ‹è¯•
- ä»£ç å®¡æŸ¥ä¸­å…³æ³¨æ€§èƒ½é—®é¢˜
- ä½¿ç”¨æ€§èƒ½å‹å¥½çš„è®¾è®¡æ¨¡å¼

### 2. é—®é¢˜æ’æŸ¥åŸåˆ™
- å…ˆå®šä½å†ä¼˜åŒ–ï¼Œé¿å…ç›²ç›®è°ƒä¼˜
- å…³æ³¨ç³»ç»Ÿç“¶é¢ˆç‚¹ï¼Œé¿å…å±€éƒ¨ä¼˜åŒ–
- æ•°æ®é©±åŠ¨å†³ç­–ï¼Œé¿å…ä¸»è§‚åˆ¤æ–­
- æ¸è¿›å¼ä¼˜åŒ–ï¼Œé¿å…è¿‡åº¦å·¥ç¨‹

### 3. æŒç»­æ”¹è¿›
- å»ºç«‹æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†åº“
- å®šæœŸåˆ†äº«æ€§èƒ½ä¼˜åŒ–ç»éªŒ
- è·Ÿè¸ªæ–°æŠ€æœ¯å’Œå·¥å…·å‘å±•
- åŸ¹å…»å›¢é˜Ÿæ€§èƒ½æ„è¯†

---

**ğŸ’¡ è¿™å¥—å®Œæ•´çš„æ€§èƒ½é—®é¢˜æ’æŸ¥æ–¹æ³•è®ºåŸºäºOpenJDK11çœŸå®æºç åˆ†æå’Œç”Ÿäº§ç¯å¢ƒå®è·µï¼Œä¸ºJavaåº”ç”¨æ€§èƒ½ä¼˜åŒ–æä¾›ç³»ç»ŸåŒ–çš„è§£å†³æ–¹æ¡ˆã€‚**