# ç”Ÿäº§ç¯å¢ƒçœŸå®æ’æŸ¥ç­–ç•¥ - å®æˆ˜æŒ‡å—

## ğŸš¨ **ç”Ÿäº§ç¯å¢ƒçš„çœŸå®çº¦æŸ**

### æƒé™é™åˆ¶
- **åº”ç”¨è´¦æˆ·æƒé™**: é€šå¸¸åªèƒ½æŸ¥çœ‹è‡ªå·±è¿›ç¨‹çš„ä¿¡æ¯
- **ç³»ç»Ÿå‘½ä»¤é™åˆ¶**: å¤§éƒ¨åˆ†ç³»ç»Ÿçº§å‘½ä»¤éœ€è¦sudoæƒé™
- **æ–‡ä»¶è®¿é—®é™åˆ¶**: åªèƒ½è®¿é—®åº”ç”¨ç›¸å…³ç›®å½•
- **ç½‘ç»œè®¿é—®é™åˆ¶**: å¯èƒ½æ— æ³•è®¿é—®å¤–éƒ¨å·¥å…·å’Œèµ„æº

### æ“ä½œé£é™©
- **STWé£é™©**: jmap -dumpç­‰å‘½ä»¤ä¼šæš‚åœåº”ç”¨
- **æ€§èƒ½å½±å“**: æŸäº›è¯Šæ–­å‘½ä»¤æœ¬èº«æ¶ˆè€—èµ„æº
- **ç¨³å®šæ€§é£é™©**: é”™è¯¯æ“ä½œå¯èƒ½å¯¼è‡´åº”ç”¨å´©æºƒ
- **ä¸šåŠ¡å½±å“**: ä»»ä½•ä¸­æ–­éƒ½å¯èƒ½é€ æˆç»æµæŸå¤±

### æ—¶é—´å‹åŠ›
- **æ•…éšœçª—å£**: é€šå¸¸åªæœ‰5-15åˆ†é’Ÿæ’æŸ¥æ—¶é—´
- **ä¸šåŠ¡å‹åŠ›**: éœ€è¦å¿«é€Ÿæ¢å¤æœåŠ¡
- **å˜æ›´å®¡æ‰¹**: ä¿®å¤æ–¹æ¡ˆéœ€è¦å®¡æ‰¹æµç¨‹

## ğŸ¯ **åˆ†å±‚æ’æŸ¥ç­–ç•¥**

### ç¬¬ä¸€å±‚ï¼šæ— é£é™©å¿«é€Ÿè¯Šæ–­ (2-3åˆ†é’Ÿ)

```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒå®‰å…¨è¯Šæ–­è„šæœ¬ - ç¬¬ä¸€å±‚
# åªä½¿ç”¨æ— é£é™©çš„åªè¯»å‘½ä»¤

echo "=== ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿè¯Šæ–­ $(date) ==="

# 1. åŸºç¡€è¿›ç¨‹ä¿¡æ¯
echo "1. Javaè¿›ç¨‹ä¿¡æ¯:"
jps -v | grep -v jps

# 2. ç³»ç»Ÿèµ„æºä½¿ç”¨
echo "2. ç³»ç»Ÿèµ„æº:"
echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')"
echo "å†…å­˜: $(free -h | grep Mem | awk '{print $3"/"$2}')"
echo "è´Ÿè½½: $(uptime | awk -F'load average:' '{print $2}')"

# 3. GCåŸºç¡€ç»Ÿè®¡ (å®‰å…¨)
PID=$(jps | grep -v Jps | head -1 | awk '{print $1}')
if [ ! -z "$PID" ]; then
    echo "3. GCç»Ÿè®¡ (PID: $PID):"
    jstat -gc $PID | tail -1
    jstat -gccapacity $PID | tail -1
fi

# 4. ç½‘ç»œè¿æ¥çŠ¶æ€
echo "4. ç½‘ç»œè¿æ¥:"
netstat -an | grep ESTABLISHED | wc -l
netstat -an | grep TIME_WAIT | wc -l

# 5. æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨
echo "5. æ–‡ä»¶æè¿°ç¬¦:"
if [ ! -z "$PID" ]; then
    ls /proc/$PID/fd 2>/dev/null | wc -l
fi

# 6. åº”ç”¨æ—¥å¿—æœ€æ–°é”™è¯¯ (å¦‚æœæœ‰æƒé™)
echo "6. æœ€æ–°é”™è¯¯æ—¥å¿—:"
if [ -f "logs/application.log" ]; then
    tail -50 logs/application.log | grep -i error | tail -5
fi
```

### ç¬¬äºŒå±‚ï¼šä½é£é™©æ·±å…¥åˆ†æ (5-8åˆ†é’Ÿ)

```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒæ·±å…¥è¯Šæ–­è„šæœ¬ - ç¬¬äºŒå±‚
# ä½¿ç”¨ä½é£é™©å‘½ä»¤è¿›è¡Œæ·±å…¥åˆ†æ

PID=$(jps | grep -v Jps | head -1 | awk '{print $1}')

if [ -z "$PID" ]; then
    echo "æœªæ‰¾åˆ°Javaè¿›ç¨‹"
    exit 1
fi

echo "=== æ·±å…¥åˆ†æ PID: $PID ==="

# 1. JVMå‚æ•°å’Œç³»ç»Ÿå±æ€§
echo "1. JVMé…ç½®:"
jcmd $PID VM.flags | grep -E "(UseG1GC|Xms|Xmx|NewRatio)"
jcmd $PID VM.system_properties | grep -E "(java.version|os.name)"

# 2. è¯¦ç»†GCç»Ÿè®¡
echo "2. è¯¦ç»†GCä¿¡æ¯:"
jstat -gc $PID 1 3 | column -t

# 3. ç±»åŠ è½½ç»Ÿè®¡
echo "3. ç±»åŠ è½½ç»Ÿè®¡:"
jstat -class $PID

# 4. ç¼–è¯‘ç»Ÿè®¡
echo "4. JITç¼–è¯‘ç»Ÿè®¡:"
jstat -compiler $PID

# 5. å †å†…å­˜åˆ†å¸ƒ (ç›¸å¯¹å®‰å…¨)
echo "5. å †å†…å­˜å¯¹è±¡åˆ†å¸ƒ (Top 10):"
jcmd $PID GC.class_histogram | head -15

# 6. çº¿ç¨‹æ•°é‡ç»Ÿè®¡
echo "6. çº¿ç¨‹ç»Ÿè®¡:"
jcmd $PID Thread.print | grep "java.lang.Thread.State" | sort | uniq -c

# 7. ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡ (å¦‚æœå…è®¸)
echo "7. ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡ (5ç§’é‡‡æ ·):"
timeout 5s strace -p $PID -c 2>/dev/null || echo "straceæƒé™ä¸è¶³"
```

### ç¬¬ä¸‰å±‚ï¼šåº”æ€¥è¯Šæ–­å·¥å…· (ç´§æ€¥æƒ…å†µ)

```bash
#!/bin/bash
# åº”æ€¥è¯Šæ–­å·¥å…· - ç¬¬ä¸‰å±‚
# ä»…åœ¨ç´§æ€¥æƒ…å†µä¸‹ä½¿ç”¨ï¼Œéœ€è¦å®¡æ‰¹

PID=$1
if [ -z "$PID" ]; then
    echo "ç”¨æ³•: $0 <pid>"
    exit 1
fi

echo "âš ï¸  åº”æ€¥è¯Šæ–­æ¨¡å¼ - å¯èƒ½å½±å“åº”ç”¨æ€§èƒ½"
read -p "ç¡®è®¤ç»§ç»­? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "å–æ¶ˆæ“ä½œ"
    exit 0
fi

# 1. çº¿ç¨‹å †æ ˆ (æœ‰STWé£é™©)
echo "1. è·å–çº¿ç¨‹å †æ ˆ..."
jstack $PID > thread_dump_$(date +%H%M%S).txt
echo "çº¿ç¨‹å †æ ˆå·²ä¿å­˜"

# 2. å †è½¬å‚¨ (é«˜é£é™©ï¼Œä»…ç´§æ€¥æƒ…å†µ)
echo "2. æ˜¯å¦éœ€è¦å †è½¬å‚¨? (ä¼šæš‚åœåº”ç”¨)"
read -p "ç»§ç»­? (yes/no): " heap_confirm

if [ "$heap_confirm" = "yes" ]; then
    echo "å¼€å§‹å †è½¬å‚¨..."
    jmap -dump:format=b,file=heap_dump_$(date +%H%M%S).hprof $PID
    echo "å †è½¬å‚¨å®Œæˆ"
fi
```

## ğŸ“Š **é¢„ç½®ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ**

### 1. APMç›‘æ§å·¥å…·
```java
// åº”ç”¨æ€§èƒ½ç›‘æ§é›†æˆ
@Component
public class ProductionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Logger logger = LoggerFactory.getLogger(ProductionMonitor.class);
    
    // å…³é”®æŒ‡æ ‡ç›‘æ§
    @EventListener
    public void onPerformanceEvent(PerformanceEvent event) {
        // å“åº”æ—¶é—´ç›‘æ§
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("api.response.time")
            .tag("endpoint", event.getEndpoint())
            .register(meterRegistry));
        
        // é”™è¯¯ç‡ç›‘æ§
        if (event.isError()) {
            Counter.builder("api.error.count")
                .tag("endpoint", event.getEndpoint())
                .tag("error.type", event.getErrorType())
                .register(meterRegistry)
                .increment();
        }
        
        // è‡ªåŠ¨å‘Šè­¦
        if (event.getResponseTime() > 1000) {
            alertManager.sendAlert("é«˜å“åº”æ—¶é—´å‘Šè­¦", event);
        }
    }
}
```

### 2. JVMæŒ‡æ ‡è‡ªåŠ¨æ”¶é›†
```java
// JVMæŒ‡æ ‡æ”¶é›†å™¨
@Component
@Scheduled(fixedRate = 30000) // æ¯30ç§’æ”¶é›†ä¸€æ¬¡
public class JVMMetricsCollector {
    
    public void collectMetrics() {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        
        // å †å†…å­˜ä½¿ç”¨
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        double heapUsedPercent = (double) heapUsage.getUsed() / heapUsage.getMax();
        
        // GCç»Ÿè®¡
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            long gcCount = gcBean.getCollectionCount();
            long gcTime = gcBean.getCollectionTime();
            
            // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
            metricsRegistry.gauge("jvm.gc.count", Tags.of("gc.name", gcBean.getName()), gcCount);
            metricsRegistry.gauge("jvm.gc.time", Tags.of("gc.name", gcBean.getName()), gcTime);
        }
        
        // çº¿ç¨‹ç»Ÿè®¡
        ThreadMXBean threadBean = ManagementFactory.getThreadMXBean();
        int threadCount = threadBean.getThreadCount();
        int deadlockedThreads = threadBean.findDeadlockedThreads() != null ? 
            threadBean.findDeadlockedThreads().length : 0;
        
        // è‡ªåŠ¨å‘Šè­¦
        if (heapUsedPercent > 0.85) {
            alertManager.sendAlert("å †å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: " + (heapUsedPercent * 100) + "%");
        }
        
        if (deadlockedThreads > 0) {
            alertManager.sendAlert("æ£€æµ‹åˆ°æ­»é”çº¿ç¨‹: " + deadlockedThreads + "ä¸ª");
        }
    }
}
```

## ğŸ”§ **ç”Ÿäº§ç¯å¢ƒä¸“ç”¨å·¥å…·**

### 1. Arthas - ç”Ÿäº§ç¯å¢ƒç¥å™¨
```bash
# Arthasæ˜¯ä¸“ä¸ºç”Ÿäº§ç¯å¢ƒè®¾è®¡çš„è¯Šæ–­å·¥å…·
# ä¼˜åŠ¿ï¼šæ— éœ€é‡å¯ï¼Œä½ä¾µå…¥æ€§ï¼Œä¸°å¯ŒåŠŸèƒ½

# å¯åŠ¨Arthas (é€šå¸¸é¢„å…ˆéƒ¨ç½²)
java -jar arthas-boot.jar <pid>

# å®‰å…¨çš„å®æ—¶ç›‘æ§å‘½ä»¤
dashboard          # å®æ—¶ç³»ç»Ÿé¢æ¿
thread             # çº¿ç¨‹ä¿¡æ¯
jvm                # JVMä¿¡æ¯
sysprop            # ç³»ç»Ÿå±æ€§
sysenv             # ç¯å¢ƒå˜é‡

# æ–¹æ³•çº§ç›‘æ§ (ç”Ÿäº§ç¯å¢ƒå¸¸ç”¨)
monitor com.example.Service method -c 5    # ç›‘æ§æ–¹æ³•è°ƒç”¨
trace com.example.Service method           # æ–¹æ³•è°ƒç”¨é“¾è·¯
watch com.example.Service method returnObj # è§‚å¯Ÿæ–¹æ³•è¿”å›å€¼

# æ€§èƒ½åˆ†æ
profiler start                             # å¼€å§‹æ€§èƒ½åˆ†æ
profiler stop --format html               # ç”Ÿæˆç«ç„°å›¾
```

### 2. åº”ç”¨å†…ç½®è¯Šæ–­æ¥å£
```java
// ç”Ÿäº§ç¯å¢ƒè¯Šæ–­æ¥å£
@RestController
@RequestMapping("/actuator/diagnostics")
public class DiagnosticsController {
    
    // å®‰å…¨çš„å¥åº·æ£€æŸ¥
    @GetMapping("/health")
    public Map<String, Object> health() {
        Map<String, Object> health = new HashMap<>();
        
        // JVMçŠ¶æ€
        Runtime runtime = Runtime.getRuntime();
        health.put("heap.used", runtime.totalMemory() - runtime.freeMemory());
        health.put("heap.max", runtime.maxMemory());
        
        // çº¿ç¨‹çŠ¶æ€
        ThreadMXBean threadBean = ManagementFactory.getThreadMXBean();
        health.put("thread.count", threadBean.getThreadCount());
        health.put("thread.peak", threadBean.getPeakThreadCount());
        
        // GCçŠ¶æ€
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        Map<String, Object> gcInfo = new HashMap<>();
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            gcInfo.put(gcBean.getName() + ".count", gcBean.getCollectionCount());
            gcInfo.put(gcBean.getName() + ".time", gcBean.getCollectionTime());
        }
        health.put("gc", gcInfo);
        
        return health;
    }
    
    // çº¿ç¨‹è½¬å‚¨ (éœ€è¦æƒé™æ§åˆ¶)
    @PostMapping("/thread-dump")
    @PreAuthorize("hasRole('ADMIN')")
    public String threadDump() {
        ThreadMXBean threadBean = ManagementFactory.getThreadMXBean();
        ThreadInfo[] threadInfos = threadBean.dumpAllThreads(true, true);
        
        StringBuilder sb = new StringBuilder();
        for (ThreadInfo threadInfo : threadInfos) {
            sb.append(threadInfo.toString()).append("\n");
        }
        
        return sb.toString();
    }
}
```

## ğŸ“‹ **ç”Ÿäº§ç¯å¢ƒæ’æŸ¥SOP (æ ‡å‡†æ“ä½œç¨‹åº)**

### æ•…éšœå“åº”æµç¨‹
```
1. æ¥åˆ°å‘Šè­¦ (30ç§’å†…)
   â”œâ”€â”€ ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
   â”œâ”€â”€ å¯åŠ¨åº”æ€¥å“åº”æµç¨‹
   â””â”€â”€ é€šçŸ¥ç›¸å…³äººå‘˜

2. å¿«é€Ÿè¯Šæ–­ (2åˆ†é’Ÿå†…)
   â”œâ”€â”€ æ‰§è¡Œç¬¬ä¸€å±‚è¯Šæ–­è„šæœ¬
   â”œâ”€â”€ æŸ¥çœ‹ç›‘æ§é¢æ¿
   â”œâ”€â”€ æ£€æŸ¥åº”ç”¨æ—¥å¿—
   â””â”€â”€ åˆæ­¥åˆ¤æ–­é—®é¢˜ç±»å‹

3. æ·±å…¥åˆ†æ (5åˆ†é’Ÿå†…)
   â”œâ”€â”€ æ‰§è¡Œç¬¬äºŒå±‚è¯Šæ–­è„šæœ¬
   â”œâ”€â”€ ä½¿ç”¨Arthaså®æ—¶åˆ†æ
   â”œâ”€â”€ åˆ†æå†å²è¶‹åŠ¿æ•°æ®
   â””â”€â”€ å®šä½å…·ä½“åŸå› 

4. åº”æ€¥å¤„ç† (10åˆ†é’Ÿå†…)
   â”œâ”€â”€ å®æ–½ä¸´æ—¶ç¼“è§£æªæ–½
   â”œâ”€â”€ å¿…è¦æ—¶æ‰§è¡Œç¬¬ä¸‰å±‚è¯Šæ–­
   â”œâ”€â”€ å‡†å¤‡å›æ»šæ–¹æ¡ˆ
   â””â”€â”€ æ¢å¤æœåŠ¡å¯ç”¨æ€§

5. æ ¹å› åˆ†æ (äº‹å)
   â”œâ”€â”€ è¯¦ç»†åˆ†æè¯Šæ–­æ•°æ®
   â”œâ”€â”€ å¤ç°é—®é¢˜åœºæ™¯
   â”œâ”€â”€ åˆ¶å®šæ°¸ä¹…è§£å†³æ–¹æ¡ˆ
   â””â”€â”€ å®Œå–„ç›‘æ§å’Œé¢„è­¦
```

## ğŸ¯ **å…³é”®ç»éªŒæ€»ç»“**

### 1. é¢„é˜²èƒœäºæ²»ç–—
- **å®Œå–„çš„ç›‘æ§ä½“ç³»**: è¦†ç›–æ‰€æœ‰å…³é”®æŒ‡æ ‡
- **è‡ªåŠ¨åŒ–å‘Šè­¦**: é—®é¢˜å‘ç”Ÿå‰å°±èƒ½å‘ç°
- **å®šæœŸå¥åº·æ£€æŸ¥**: ä¸»åŠ¨å‘ç°æ½œåœ¨é—®é¢˜
- **å‹åŠ›æµ‹è¯•**: æå‰éªŒè¯ç³»ç»Ÿæé™

### 2. å·¥å…·å’Œæƒé™å‡†å¤‡
- **é¢„éƒ¨ç½²è¯Šæ–­å·¥å…·**: Arthasã€è‡ªå®šä¹‰ç›‘æ§æ¥å£
- **æƒé™ç”³è¯·æµç¨‹**: æå‰ç”³è¯·å¿…è¦çš„è¯Šæ–­æƒé™
- **åº”æ€¥è”ç³»äºº**: å»ºç«‹å¿«é€Ÿå“åº”æœºåˆ¶
- **æ–‡æ¡£å’Œè„šæœ¬**: æ ‡å‡†åŒ–çš„è¯Šæ–­æµç¨‹

### 3. æ•°æ®é©±åŠ¨å†³ç­–
- **å†å²æ•°æ®å¯¹æ¯”**: å»ºç«‹æ€§èƒ½åŸºçº¿
- **è¶‹åŠ¿åˆ†æ**: è¯†åˆ«æ€§èƒ½é€€åŒ–è¶‹åŠ¿
- **é‡åŒ–è¯„ä¼°**: ç”¨æ•°æ®è¯´è¯ï¼Œé¿å…ä¸»è§‚åˆ¤æ–­
- **æ•ˆæœéªŒè¯**: ä¼˜åŒ–åçš„é‡åŒ–å¯¹æ¯”

---

**ğŸ’¡ çœŸå®çš„ç”Ÿäº§ç¯å¢ƒæ’æŸ¥éœ€è¦åœ¨æœ‰é™çš„æƒé™ã€æ—¶é—´å’Œå·¥å…·çº¦æŸä¸‹ï¼Œé€šè¿‡é¢„ç½®çš„ç›‘æ§ä½“ç³»ã€æ ‡å‡†åŒ–çš„è¯Šæ–­æµç¨‹å’Œä¸“ä¸šçš„å·¥å…·æ¥å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚è¿™æ¯”ç†æƒ³ç¯å¢ƒä¸‹çš„æ’æŸ¥è¦å¤æ‚å¾—å¤šï¼Œä½†ä¹Ÿæ›´èƒ½ä½“ç°å·¥ç¨‹å¸ˆçš„ä¸“ä¸šæ°´å¹³ã€‚**