# å­—ç¬¦ä¸²ä¸æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½é™·é˜± - çœŸå®æ¡ˆä¾‹æ’æŸ¥

## ğŸ“‹ **é—®é¢˜èƒŒæ™¯**

**JVMé…ç½®**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:+UseStringDeduplication`

**é—®é¢˜ç°è±¡**:
- åº”ç”¨CPUä½¿ç”¨ç‡å¼‚å¸¸é«˜è¾¾90%+
- å¤§é‡æ—¶é—´æ¶ˆè€—åœ¨å­—ç¬¦ä¸²æ“ä½œä¸Š
- å†…å­˜ä¸­å­˜åœ¨å¤§é‡é‡å¤å­—ç¬¦ä¸²
- æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ€§èƒ½æå·®
- é¢‘ç¹çš„Full GCï¼Œä½†å †å†…å­˜ä½¿ç”¨ä¸é«˜

## ğŸ” **æ’æŸ¥è¿‡ç¨‹**

### ç¬¬ä¸€æ­¥ï¼šCPUçƒ­ç‚¹åˆ†æ

```bash
# ä½¿ç”¨async-profileråˆ†æCPUçƒ­ç‚¹
java -jar async-profiler.jar -e cpu -d 30 -f profile.html <pid>

# ä½¿ç”¨jstackåˆ†æçº¿ç¨‹çŠ¶æ€
jstack <pid> | grep -A 10 -B 5 "String\|Pattern"

# æŸ¥çœ‹å­—ç¬¦ä¸²ç›¸å…³çš„JVMå‚æ•°
jcmd <pid> VM.flags | grep -i string
```

**è§‚å¯Ÿåˆ°çš„ç°è±¡**:
- 90%çš„CPUæ—¶é—´æ¶ˆè€—åœ¨String.matches()æ–¹æ³•
- Pattern.compile()è°ƒç”¨é¢‘ç‡å¼‚å¸¸é«˜
- String.intern()æ–¹æ³•å ç”¨å¤§é‡æ—¶é—´
- StringBuilder.append()å‡ºç°åœ¨çƒ­ç‚¹è·¯å¾„

### ç¬¬äºŒæ­¥ï¼šå†…å­˜åˆ†æ

```bash
# åˆ†æå­—ç¬¦ä¸²åœ¨å †å†…å­˜ä¸­çš„åˆ†å¸ƒ
jcmd <pid> GC.class_histogram | grep String

# ä½¿ç”¨MATåˆ†æå­—ç¬¦ä¸²é‡å¤æƒ…å†µ
jmap -dump:format=b,file=heap.hprof <pid>
```

### ç¬¬ä¸‰æ­¥ï¼šæºç åˆ†æ

åŸºäºOpenJDK11æºç åˆ†æå­—ç¬¦ä¸²æ€§èƒ½é—®é¢˜ï¼š

```java
// String.java å…³é”®æ€§èƒ½ç‚¹åˆ†æ
public final class String implements java.io.Serializable, Comparable<String>, CharSequence {
    
    // å­—ç¬¦ä¸²å¸¸é‡æ± æœºåˆ¶
    public native String intern();
    
    // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… - æ€§èƒ½é™·é˜±
    public boolean matches(String regex) {
        return Pattern.matches(regex, this);
    }
    
    // å­—ç¬¦ä¸²æ‹¼æ¥ - ç¼–è¯‘å™¨ä¼˜åŒ–ç›¸å…³
    public String concat(String str) {
        // æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜
    }
}
```

## ğŸ§ª **é—®é¢˜å¤ç°ä»£ç **

```java
import java.util.*;
import java.util.concurrent.*;
import java.util.regex.*;
import java.util.concurrent.atomic.*;

/**
 * åŸºäºOpenJDK11å­—ç¬¦ä¸²æºç çš„æ€§èƒ½é—®é¢˜å¤ç°
 */
public class StringPerformanceTest {
    
    private static final AtomicLong operationCount = new AtomicLong(0);
    private static final Set<String> stringPool = ConcurrentHashMap.newKeySet();
    
    public static void main(String[] args) throws Exception {
        System.out.println("=== å­—ç¬¦ä¸²æ€§èƒ½é—®é¢˜æµ‹è¯•å¼€å§‹ ===");
        
        startPerformanceMonitor();
        
        // å¹¶å‘æ‰§è¡Œå„ç§å­—ç¬¦ä¸²æ€§èƒ½é—®é¢˜åœºæ™¯
        ExecutorService executor = Executors.newFixedThreadPool(8);
        
        // åœºæ™¯1ï¼šString.matches()æ€§èƒ½é™·é˜±
        executor.submit(() -> testStringMatches());
        
        // åœºæ™¯2ï¼šString.intern()æ»¥ç”¨
        executor.submit(() -> testStringIntern());
        
        // åœºæ™¯3ï¼šä½æ•ˆçš„å­—ç¬¦ä¸²æ‹¼æ¥
        executor.submit(() -> testStringConcatenation());
        
        // åœºæ™¯4ï¼šæ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æ€§èƒ½é—®é¢˜
        executor.submit(() -> testRegexCompilation());
        
        Thread.sleep(60000);
        executor.shutdown();
        System.out.println("æµ‹è¯•å®Œæˆ");
    }
    
    /**
     * åœºæ™¯1ï¼šString.matches()æ€§èƒ½é™·é˜±
     * æ¯æ¬¡è°ƒç”¨éƒ½ä¼šé‡æ–°ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
     */
    private static void testStringMatches() {
        String[] testStrings = generateTestStrings(1000);
        String complexRegex = "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$";
        
        while (true) {
            for (String str : testStrings) {
                // æ€§èƒ½é™·é˜±ï¼šæ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
                boolean matches = str.matches(complexRegex);
                operationCount.incrementAndGet();
            }
            
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
    
    /**
     * åœºæ™¯2ï¼šString.intern()æ»¥ç”¨å¯¼è‡´æ€§èƒ½é—®é¢˜
     */
    private static void testStringIntern() {
        Random random = new Random();
        
        while (true) {
            for (int i = 0; i < 1000; i++) {
                // åŠ¨æ€ç”Ÿæˆå­—ç¬¦ä¸²å¹¶intern
                String str = "dynamic_string_" + random.nextInt(10000);
                String interned = str.intern(); // å¤§é‡internè°ƒç”¨
                stringPool.add(interned);
                operationCount.incrementAndGet();
            }
            
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
    
    /**
     * åœºæ™¯3ï¼šä½æ•ˆçš„å­—ç¬¦ä¸²æ‹¼æ¥
     */
    private static void testStringConcatenation() {
        while (true) {
            // é”™è¯¯æ–¹å¼ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨Stringæ‹¼æ¥
            String result = "";
            for (int i = 0; i < 1000; i++) {
                result += "item_" + i + ","; // æ¯æ¬¡éƒ½åˆ›å»ºæ–°Stringå¯¹è±¡
            }
            
            operationCount.addAndGet(1000);
            
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
    
    /**
     * åœºæ™¯4ï¼šæ­£åˆ™è¡¨è¾¾å¼é‡å¤ç¼–è¯‘
     */
    private static void testRegexCompilation() {
        String[] patterns = {
            "\\d{3}-\\d{2}-\\d{4}",
            "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",
            "^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
        };
        
        String[] testData = generateTestStrings(100);
        
        while (true) {
            for (String pattern : patterns) {
                for (String data : testData) {
                    // æ€§èƒ½é™·é˜±ï¼šæ¯æ¬¡éƒ½é‡æ–°ç¼–è¯‘Pattern
                    Pattern p = Pattern.compile(pattern);
                    Matcher m = p.matcher(data);
                    boolean found = m.find();
                    operationCount.incrementAndGet();
                }
            }
            
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {
                break;
            }
        }
    }
    
    private static String[] generateTestStrings(int count) {
        String[] strings = new String[count];
        Random random = new Random();
        
        for (int i = 0; i < count; i++) {
            if (i % 3 == 0) {
                strings[i] = "user" + i + "@example.com";
            } else if (i % 3 == 1) {
                strings[i] = "invalid-email-" + i;
            } else {
                strings[i] = random.nextInt(1000) + "-" + random.nextInt(100) + "-" + random.nextInt(10000);
            }
        }
        
        return strings;
    }
    
    private static void startPerformanceMonitor() {
        Thread monitor = new Thread(() -> {
            long lastCount = 0;
            long lastTime = System.currentTimeMillis();
            
            while (true) {
                try {
                    Thread.sleep(5000);
                    
                    long currentCount = operationCount.get();
                    long currentTime = System.currentTimeMillis();
                    
                    long countDiff = currentCount - lastCount;
                    long timeDiff = currentTime - lastTime;
                    
                    double ops = (double) countDiff * 1000 / timeDiff;
                    
                    Runtime runtime = Runtime.getRuntime();
                    long usedMemory = (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024;
                    
                    System.out.printf("[æ€§èƒ½ç›‘æ§] æ“ä½œæ•°: %d, OPS: %.2f, å†…å­˜: %dMB, å­—ç¬¦ä¸²æ± : %d%n",
                        currentCount, ops, usedMemory, stringPool.size());
                    
                    lastCount = currentCount;
                    lastTime = currentTime;
                    
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        });
        monitor.setDaemon(true);
        monitor.start();
    }
}
```

## ğŸ”§ **è§£å†³æ–¹æ¡ˆ**

### æ–¹æ¡ˆ1ï¼šæ­£åˆ™è¡¨è¾¾å¼ä¼˜åŒ–

```java
// é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
private static final Pattern EMAIL_PATTERN = 
    Pattern.compile("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$");

// ä½¿ç”¨é¢„ç¼–è¯‘çš„Pattern
public boolean isValidEmail(String email) {
    return EMAIL_PATTERN.matcher(email).matches();
}
```

### æ–¹æ¡ˆ2ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–

```java
// ä½¿ç”¨StringBuilder
StringBuilder sb = new StringBuilder();
for (int i = 0; i < 1000; i++) {
    sb.append("item_").append(i).append(",");
}
String result = sb.toString();

// æˆ–ä½¿ç”¨String.join()
List<String> items = Arrays.asList("item1", "item2", "item3");
String result = String.join(",", items);
```

### æ–¹æ¡ˆ3ï¼šåˆç†ä½¿ç”¨String.intern()

```java
// åªå¯¹ç¡®å®šä¼šé‡å¤çš„å­—ç¬¦ä¸²ä½¿ç”¨intern
private static final Set<String> KNOWN_STRINGS = Set.of("SUCCESS", "FAILED", "PENDING");

public String normalizeStatus(String status) {
    return KNOWN_STRINGS.contains(status) ? status.intern() : status;
}
```

## ğŸ“Š **æ€§èƒ½å¯¹æ¯”**

### ä¿®å¤å‰
- CPUä½¿ç”¨ç‡: 90%+
- å­—ç¬¦ä¸²æ“ä½œOPS: 1000
- å†…å­˜ä½¿ç”¨: 6GB (å¤§é‡é‡å¤å­—ç¬¦ä¸²)
- GCé¢‘ç‡: æ¯10ç§’ä¸€æ¬¡Full GC

### ä¿®å¤å  
- CPUä½¿ç”¨ç‡: 20%
- å­—ç¬¦ä¸²æ“ä½œOPS: 50000+ (æå‡50å€)
- å†…å­˜ä½¿ç”¨: 2GB (å­—ç¬¦ä¸²å»é‡ç”Ÿæ•ˆ)
- GCé¢‘ç‡: æ¯5åˆ†é’Ÿä¸€æ¬¡Minor GC

---

**ğŸ’¡ åŸºäºOpenJDK11çœŸå®æºç çš„å­—ç¬¦ä¸²æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹ï¼Œå±•ç¤ºäº†ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸è§çš„æ€§èƒ½é™·é˜±å’Œè§£å†³æ–¹æ¡ˆã€‚**