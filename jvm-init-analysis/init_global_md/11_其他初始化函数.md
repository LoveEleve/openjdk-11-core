# init_globals() 其他初始化函数

## 调试环境

| 配置项 | 值 |
|--------|-----|
| **JVM参数** | `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages` |
| **测试程序** | HelloWorld.java |

---

## 1. invocationCounter_init() - 调用计数器初始化

### 源码位置
- 文件：`src/hotspot/share/interpreter/invocationCounter.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 11, invocationCounter_init () 
at invocationCounter.cpp:170
170	  InvocationCounter::reinitialize(DelayCompilationDuringStartup);
```

### InvocationCounter最终状态

| 属性 | 值 | 说明 |
|------|-----|------|
| `_init` | {0, 0} | 初始化值 |
| `InterpreterInvocationLimit` | 80000 | 解释器调用限制 |
| `InterpreterBackwardBranchLimit` | 10700 | 回边限制 |
| `InterpreterProfileLimit` | 26400 | profiling限制 |

### 功能说明

- 跟踪方法调用次数
- 跟踪循环回边次数
- 达到阈值时触发JIT编译

---

## 2. templateTable_init() - 模板表初始化

### 源码位置
- 文件：`src/hotspot/share/interpreter/templateTable.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 12, templateTable_init () 
at templateTable.cpp:548
548	  TemplateTable::initialize();
```

### TemplateTable最终状态

| 属性 | 值 |
|------|-----|
| `_is_initialized` | true |

### 功能说明

- 为每个字节码定义模板
- 模板用于生成解释器代码
- 包含字节码的语义实现

---

## 3. SharedRuntime::generate_stubs() - 共享运行时桩

### 源码位置
- 文件：`src/hotspot/share/runtime/sharedRuntime.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 13, SharedRuntime::generate_stubs () 
at sharedRuntime.cpp:101
```

### SharedRuntime桩最终状态

| 桩名称 | 地址 | 说明 |
|--------|------|------|
| `_ic_miss_blob` | 0x7fffe1114090 | IC miss处理 |
| `_wrong_method_blob` | 0x7fffe1008190 | 错误方法处理 |
| `_wrong_method_abstract_blob` | 0x7fffe1114390 | 抽象方法处理 |
| `_resolve_opt_virtual_call_blob` | 0x7fffe1113d90 | 优化虚调用解析 |
| `_resolve_virtual_call_blob` | 0x7fffe1113a90 | 虚调用解析 |
| `_resolve_static_call_blob` | 0x7fffe1113790 | 静态调用解析 |
| `_polling_page_vectors_safepoint_handler_blob` | 0x7fffe1114690 | 安全点向量处理 |
| `_polling_page_return_handler_blob` | 0x7fffe1112790 | 安全点返回处理 |

---

## 4. jni_handles_init() - JNI句柄初始化

### 源码位置
- 文件：`src/hotspot/share/runtime/jniHandles.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 17, jni_handles_init () 
at jniHandles.cpp:342
342	    JNIHandles::initialize();
```

### JNIHandles最终状态

| 属性 | 地址 | 说明 |
|------|------|------|
| `_global_handles` | 0x7ffff0d162a0 | 全局句柄存储 |
| `_weak_global_handles` | 0x7ffff0d16450 | 弱全局句柄存储 |

### OopStorage详情

```gdb
JNI Global: {
  _name = "JNI Global",
  _allocation_count = 2,
}

JNI Weak: {
  _name = "JNI Weak",
  _allocation_count = 0,
}
```

---

## 5. InlineCacheBuffer_init() - 内联缓存缓冲

### 源码位置
- 文件：`src/hotspot/share/code/icBuffer.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 19, InlineCacheBuffer_init () 
at icBuffer.cpp:168
168	  InlineCacheBuffer::initialize();
```

### InlineCacheBuffer最终状态

```gdb
$1 = (StubQueue *) 0x7ffff0cb15a0
$2 = (StubQueue) {
  _stub_buffer = 0x7fffe110ff20,
  _buffer_size = 10240,        // 10KB
  _buffer_limit = 10240,
  _queue_begin = 0,
  _queue_end = 64,
  _number_of_stubs = 1,
}
```

### 功能说明

- 存储内联缓存转换桩
- 用于多态调用优化
- 支持IC miss时的方法查找

---

## 6. compileBroker_init() - 编译代理初始化

### 源码位置
- 文件：`src/hotspot/share/compiler/compileBroker.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 21, compileBroker_init () 
at compileBroker.cpp:236
236	  if (LogEvents) {
```

### CompileBroker最终状态

| 属性 | 值 | 说明 |
|------|-----|------|
| `_c1_count` | 0 | C1编译器数（延迟创建） |
| `_c2_count` | 0 | C2编译器数（延迟创建） |
| `_should_block` | false | 是否阻塞 |
| `_should_compile_new_jobs` | 1 | 是否编译新任务 |
| `UseCompiler` | true | 启用编译器 |
| `BackgroundCompilation` | true | 后台编译 |
| `_compilers[0]` | 0x0 | C1编译器（延迟） |
| `_compilers[1]` | 0x0 | C2编译器（延迟） |
| `_c1_compile_queue` | 0x0 | C1编译队列（延迟） |
| `_c2_compile_queue` | 0x0 | C2编译队列（延迟） |

### 说明

编译器线程在首次需要编译时才创建，而非在init_globals()期间。

---

## 7. Metaspace::global_initialize() - 元空间初始化

### 源码位置
- 文件：`src/hotspot/share/memory/metaspace.cpp`

### GDB调试结果

```gdb
Thread 2 "java" hit Breakpoint 8, Metaspace::global_initialize () 
at metaspace.cpp:1293
```

### Metaspace最终状态

| 参数 | 值 | 换算 |
|------|-----|------|
| `MaxMetaspaceSize` | 18446744073709547520 | 无限制 |
| `MetaspaceSize` | 21807104 | ~21MB |
| `CompressedClassSpaceSize` | 1073741824 | **1GB** |
| `UseCompressedOops` | true | 压缩指针 |
| `UseCompressedClassPointers` | true | 压缩类指针 |
| `_first_chunk_word_size` | 524288 | 2MB |
| `_first_class_chunk_word_size` | 49152 | 192KB |

---

## 8. 其他小型初始化函数

| 函数 | 文件 | 说明 |
|------|------|------|
| `accessFlags_init()` | accessFlags.cpp | 访问标志初始化 |
| `InterfaceSupport_init()` | interfaceSupport.cpp | 接口支持检查 |
| `VMRegImpl::set_regName()` | vmreg.cpp | 设置寄存器名 |
| `referenceProcessor_init()` | referenceProcessor.cpp | 引用处理器 |
| `vtableStubs_init()` | vtableStubs.cpp | 虚表桩 |
| `compilerOracle_init()` | compilerOracle.cpp | 编译器Oracle |
| `dependencyContext_init()` | dependencyContext.cpp | 依赖上下文 |

---

## init_globals() 完整执行顺序

| 序号 | 函数 | 说明 |
|------|------|------|
| 1 | management_init() | JMX管理接口 |
| 2 | bytecodes_init() | 字节码表 |
| 3 | classLoader_init1() | 类加载器(空) |
| 4 | compilationPolicy_init() | 编译策略 |
| 5 | codeCache_init() | 代码缓存 |
| 6 | VM_Version_init() | CPU特性 |
| 7 | stubRoutines_init1() | 桩代码Phase1 |
| 8 | universe_init() | 宇宙初始化 |
| 9 | gc_barrier_stubs_init() | GC屏障桩 |
| 10 | interpreter_init() | 解释器 |
| 11 | invocationCounter_init() | 调用计数器 |
| 12 | accessFlags_init() | 访问标志 |
| 13 | templateTable_init() | 模板表 |
| 14 | SharedRuntime::generate_stubs() | 共享运行时桩 |
| 15 | universe2_init() | 宇宙初始化Phase2 |
| 16 | javaClasses_init() | Java类偏移量 |
| 17 | referenceProcessor_init() | 引用处理器 |
| 18 | jni_handles_init() | JNI句柄 |
| 19 | vtableStubs_init() | 虚表桩 |
| 20 | InlineCacheBuffer_init() | 内联缓存 |
| 21 | compilerOracle_init() | 编译器Oracle |
| 22 | dependencyContext_init() | 依赖上下文 |
| 23 | compileBroker_init() | 编译代理 |
| 24 | universe_post_init() | 宇宙后初始化 |
| 25 | stubRoutines_init2() | 桩代码Phase2 |
| 26 | MethodHandles::generate_adapters() | 方法句柄适配器 |
