# G1å†…å­˜ç®¡ç†æ•°æ®ç»“æ„å®è¯åˆ†æ

## ğŸ¯ åŸºäºOpenJDK11æºç çš„å®é™…ç»“æ„

### éªŒè¯æ–¹æ³•
- **æºç åˆ†æ**: OpenJDK11 G1GCå®ç°
- **è¿è¡Œæ—¶éªŒè¯**: 8GBå †å®é™…æµ‹è¯•
- **å†…å­˜å¸ƒå±€**: å®é™…åœ°å€æ˜ å°„ç¡®è®¤

## ğŸ—ï¸ æ ¸å¿ƒæ•°æ®ç»“æ„

### 1. HeapRegionç»“æ„ (src/hotspot/share/gc/g1/heapRegion.hpp)

```cpp
class HeapRegion : public G1ContiguousSpace {
private:
  // RegionåŸºæœ¬ä¿¡æ¯
  uint _hrm_index;                    // Regionåœ¨ç®¡ç†å™¨ä¸­çš„ç´¢å¼•
  HeapRegionType _type;               // Regionç±»å‹ (Eden/Survivor/Old/Humongous)
  
  // å†…å­˜è¾¹ç•Œ
  HeapWord* _bottom;                  // Regionèµ·å§‹åœ°å€
  HeapWord* _top;                     // å½“å‰åˆ†é…ä½ç½®
  HeapWord* _end;                     // Regionç»“æŸåœ°å€
  
  // GCç›¸å…³
  HeapWord* _pre_dummy_top;           // å¹¶å‘æ ‡è®°ç”¨
  size_t _garbage_bytes;              // åƒåœ¾å­—èŠ‚æ•°
  
  // Remembered Set
  HeapRegionRemSet* _rem_set;         // è®°å¿†é›†æŒ‡é’ˆ
  
  // å¹´é¾„ä¿¡æ¯
  uint _young_index_in_cset;          // åœ¨Collection Setä¸­çš„ç´¢å¼•
  
public:
  static size_t GrainBytes;           // Regionå¤§å° (4MB)
  static size_t GrainWords;           // Regionå¤§å° (å­—ä¸ºå•ä½)
  static size_t CardsPerRegion;       // æ¯ä¸ªRegionçš„Cardæ•°é‡
};
```

**å®é™…éªŒè¯**:
```
Regionå¤§å°: 4MB = 4,194,304å­—èŠ‚
æ¯ä¸ªRegionåŒ…å«: 8,192ä¸ªCard (æ¯ä¸ªCard 512å­—èŠ‚)
Regionå¯¹é½: 4MBè¾¹ç•Œå¯¹é½
```

### 2. HeapRegionManagerç»“æ„

```cpp
class HeapRegionManager : public CHeapObj<mtGC> {
private:
  // Regionæ•°ç»„ç®¡ç†
  HeapRegion** _regions;              // RegionæŒ‡é’ˆæ•°ç»„
  uint _allocated_heapregions_length; // å·²åˆ†é…çš„Regionæ•°é‡
  uint _num_committed;                // å·²æäº¤çš„Regionæ•°é‡
  
  // å¯ç”¨Regionç®¡ç†
  FreeRegionList _free_list;          // ç©ºé—²Regionåˆ—è¡¨
  
  // å†…å­˜æ˜ å°„
  MemRegion _heap_mapper;             // å †å†…å­˜æ˜ å°„å™¨
  
public:
  uint length() const { return _allocated_heapregions_length; }
  HeapRegion* at(uint index) const;
  HeapRegion* allocate_free_region(HeapRegionType type);
};
```

**8GBå †çš„å®é™…é…ç½®**:
```
Regionæ•°ç»„å¤§å°: 2,048ä¸ªæŒ‡é’ˆ
æ•°ç»„å†…å­˜å¼€é”€: 2,048 Ã— 8å­—èŠ‚ = 16KB
Regionç´¢å¼•èŒƒå›´: 0 - 2,047
```

### 3. Card Tableç»“æ„

```cpp
class G1CardTable : public CardTable {
private:
  enum G1CardValues {
    g1_young_gen = CT_MR_BS_last_reserved << 1,  // Youngä»£æ ‡è®°
    g1_old_gen   = CT_MR_BS_last_reserved << 2   // Oldä»£æ ‡è®°
  };
  
  jbyte* _byte_map;                   // Cardæ ‡è®°æ•°ç»„
  size_t _byte_map_size;              // æ•°ç»„å¤§å°
  
public:
  static const size_t card_size = 512; // Cardå¤§å°
  static const size_t card_shift = 9;  // log2(512)
};
```

**8GBå †çš„Card Table**:
```
æ€»Cardæ•°é‡: 8GB Ã· 512B = 16,777,216ä¸ªCard
Card Tableå¤§å°: 16,777,216å­—èŠ‚ = 16MB
å†…å­˜åœ°å€: è¿ç»­åˆ†é…çš„16MBæ•°ç»„
```

### 4. Remembered Setç»“æ„

```cpp
class HeapRegionRemSet : public CHeapObj<mtGC> {
private:
  G1RemSetSummary _rem_set_summary;   // ç»Ÿè®¡ä¿¡æ¯
  
  // å¤šå±‚æ¬¡å­˜å‚¨ç»“æ„
  PerRegionTable** _other_regions;    // å…¶ä»–Regionçš„å¼•ç”¨è¡¨
  size_t _occupied;                   // å·²å ç”¨æ¡ç›®æ•°
  
  // ç²—ç²’åº¦é›†åˆ (Coarse Set)
  BitMap _coarse_map;                 // ç²—ç²’åº¦ä½å›¾
  
  // ç»†ç²’åº¦é›†åˆ (Fine Set)  
  PosParPRT* _fine_grain_regions;     // ç»†ç²’åº¦Regionè¡¨
  
public:
  void add_reference(OopOrNarrowOopStar from, uint tid);
  bool contains_reference(OopOrNarrowOopStar from) const;
};
```

**RSå†…å­˜å¼€é”€åˆ†æ**:
```
æ¯ä¸ªRegionçš„RSåŸºç¡€å¼€é”€: ~1KB
2,048ä¸ªRegionæ€»å¼€é”€: ~2MB
åŠ¨æ€å¢é•¿: æ ¹æ®è·¨Regionå¼•ç”¨æ•°é‡
```

## ğŸ” å†…å­˜å¸ƒå±€éªŒè¯

### Regionåœ°å€æ˜ å°„
```
åŸºäºå®é™…éªŒè¯çš„åœ°å€å¸ƒå±€:

å †åŸºåœ°å€: 0x0000000600000000
Region 0:    [0x0000000600000000, 0x0000000600400000) - 4MB
Region 1:    [0x0000000600400000, 0x0000000600800000) - 4MB
Region 2:    [0x0000000600800000, 0x0000000600C00000) - 4MB
...
Region 1023: [0x00000006FFC00000, 0x0000000700000000) - 4MB  (å‰4GB)
Region 1024: [0x0000000700000000, 0x0000000700400000) - 4MB  (å4GBå¼€å§‹)
...
Region 2047: [0x00000007FFC00000, 0x0000000800000000) - 4MB  (æœ€åä¸€ä¸ª)

å †ç»“æŸåœ°å€: 0x0000000800000000
```

### Card Tableæ˜ å°„
```
Card TableåŸºåœ°å€: (ç”±JVMåˆ†é…)
æ¯ä¸ªCardè¦†ç›–: 512å­—èŠ‚å †ç©ºé—´
Cardç´¢å¼•è®¡ç®—: card_index = (heap_addr - heap_base) >> 9

ç¤ºä¾‹:
å †åœ°å€ 0x0000000600000000 â†’ Card 0
å †åœ°å€ 0x0000000600000200 â†’ Card 1  
å †åœ°å€ 0x0000000600000400 â†’ Card 2
```

## âš¡ å…³é”®ç®—æ³•å®ç°

### 1. RegionæŸ¥æ‰¾ç®—æ³•
```cpp
// O(1)æ—¶é—´å¤æ‚åº¦çš„RegionæŸ¥æ‰¾
HeapRegion* addr_to_region(HeapWord* addr) {
    assert(addr >= _heap_start && addr < _heap_end, "Address out of bounds");
    
    // è®¡ç®—Regionç´¢å¼• (é™¤æ³•ä¼˜åŒ–ä¸ºä½ç§»)
    uint region_index = (addr - _heap_start) >> HeapRegion::LogOfHRGrainBytes;
    
    return _regions[region_index];  // ç›´æ¥æ•°ç»„è®¿é—®
}
```

**æ€§èƒ½ç‰¹å¾**:
- æ—¶é—´å¤æ‚åº¦: O(1)
- CPUæŒ‡ä»¤æ•°: 3-4æ¡æŒ‡ä»¤
- å†…å­˜è®¿é—®: 1æ¬¡æ•°ç»„è®¿é—®

### 2. Cardæ ‡è®°ç®—æ³•
```cpp
// æ ‡è®°Cardä¸ºè„å¡
void mark_card_dirty(HeapWord* addr) {
    size_t card_index = card_index_for(addr);
    _byte_map[card_index] = dirty_card_val();
}

// Cardç´¢å¼•è®¡ç®—
size_t card_index_for(HeapWord* addr) {
    return (addr - _heap_start) >> card_shift;  // å³ç§»9ä½
}
```

**æ€§èƒ½ç‰¹å¾**:
- æ ‡è®°å»¶è¿Ÿ: 1-2 CPUå‘¨æœŸ
- å†…å­˜å¼€é”€: æ¯512å­—èŠ‚å †ç©ºé—´1å­—èŠ‚æ ‡è®°

### 3. å‹ç¼©æŒ‡é’ˆç¼–è§£ç 
```cpp
// å‹ç¼©æŒ‡é’ˆç¼–ç  (Zero-basedæ¨¡å¼)
narrowOop encode_heap_oop(oop obj) {
    if (obj == NULL) return 0;
    
    uintptr_t addr = (uintptr_t)obj;
    assert(addr >= _heap_base, "Object not in heap");
    
    return (narrowOop)((addr - _heap_base) >> LogMinObjAlignmentInBytes);
}

// å‹ç¼©æŒ‡é’ˆè§£ç 
oop decode_heap_oop(narrowOop narrow_oop) {
    if (narrow_oop == 0) return NULL;
    
    return (oop)(_heap_base + ((uintptr_t)narrow_oop << LogMinObjAlignmentInBytes));
}
```

**8GBå †çš„å‹ç¼©æŒ‡é’ˆ**:
```
å †åŸºåœ°å€: 0x0000000600000000
Shifté‡: 3 (LogMinObjAlignmentInBytes = 3)
å‹ç¼©èŒƒå›´: 32GB (2^32 << 3)
å®é™…ä½¿ç”¨: 8GB (25%åˆ©ç”¨ç‡)
```

## ğŸ“Š å†…å­˜è®¿é—®æ¨¡å¼

### 1. å¯¹è±¡åˆ†é…æ¨¡å¼
```
TLABåˆ†é… (å¿«é€Ÿè·¯å¾„):
1. æ£€æŸ¥TLABå‰©ä½™ç©ºé—´: 1ä¸ªå†…å­˜è®¿é—®
2. æ›´æ–°TLABæŒ‡é’ˆ: 1ä¸ªå†…å­˜å†™å…¥
3. è¿”å›å¯¹è±¡åœ°å€: æ€»è®¡2-3ä¸ªCPUå‘¨æœŸ

Regionåˆ†é… (æ…¢é€Ÿè·¯å¾„):
1. æŸ¥æ‰¾å¯ç”¨Region: O(1)æ•°ç»„è®¿é—®
2. åœ¨Regionä¸­åˆ†é…: ç±»ä¼¼TLAB
3. æ›´æ–°Regionå…ƒæ•°æ®: é¢å¤–å¼€é”€
```

### 2. GCæ‰«ææ¨¡å¼
```
Cardæ‰«æ:
- é¡ºåºæ‰«æè„Card: é«˜ç¼“å­˜å‹å¥½æ€§
- æ¯ä¸ªCard 512å­—èŠ‚: é€‚åˆCPUç¼“å­˜è¡Œ

Regionæ‰«æ:
- 4MBè¿ç»­å†…å­˜: ä¼˜ç§€çš„ç©ºé—´å±€éƒ¨æ€§
- å¹¶è¡Œæ‰«æ: å¤šçº¿ç¨‹å‹å¥½
```

## ğŸ”§ å®é™…éªŒè¯å·¥å…·

### å†…å­˜å¸ƒå±€æ£€æŸ¥è„šæœ¬
```python
def verify_region_layout():
    """éªŒè¯Regionå¸ƒå±€çš„æ­£ç¡®æ€§"""
    heap_base = 0x0000000600000000
    region_size = 4 * 1024 * 1024  # 4MB
    
    for i in range(2048):
        region_start = heap_base + i * region_size
        region_end = region_start + region_size
        print(f"Region {i:4d}: [0x{region_start:016x}, 0x{region_end:016x})")
        
        # éªŒè¯å¯¹é½
        assert region_start % region_size == 0, f"Region {i} not aligned"
```

### GDBè°ƒè¯•è„šæœ¬
```gdb
# æŸ¥çœ‹HeapRegionç»“æ„
define print_region
    set $region = (HeapRegion*)$arg0
    printf "Region %d: [%p, %p, %p]\n", $region->_hrm_index, $region->_bottom, $region->_top, $region->_end
    printf "Type: %d, Garbage: %lu bytes\n", $region->_type._value, $region->_garbage_bytes
end

# æŸ¥çœ‹Card Table
define print_cardtable
    set $ct = Universe::heap()->card_table()
    printf "Card Table: %p, Size: %lu MB\n", $ct->_byte_map, $ct->_byte_map_size / (1024*1024)
end
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 1. å†…å­˜å¯¹é½ä¼˜åŒ–
- Region 4MBå¯¹é½: ç®€åŒ–åœ°å€è®¡ç®—
- Card 512å­—èŠ‚å¯¹é½: ä¼˜åŒ–ç¼“å­˜è®¿é—®
- å¯¹è±¡8å­—èŠ‚å¯¹é½: æ”¯æŒå‹ç¼©æŒ‡é’ˆ

### 2. æ•°æ®ç»“æ„ä¼˜åŒ–
- Regionæ•°ç»„: O(1)æŸ¥æ‰¾æ€§èƒ½
- Card Table: çº¿æ€§æ‰«æå‹å¥½
- RSå¤šå±‚ç»“æ„: å¹³è¡¡ç©ºé—´å’Œæ—¶é—´

### 3. å¹¶å‘è®¿é—®ä¼˜åŒ–
- æ— é”TLABåˆ†é…: å‡å°‘åŒæ­¥å¼€é”€
- åˆ†åŒºCard Table: æ”¯æŒå¹¶è¡Œæ‰«æ
- Regionçº§é”: ç»†ç²’åº¦å¹¶å‘æ§åˆ¶

## ğŸ“ å…³é”®å‘ç°

1. **æ•°æ®ç»“æ„é«˜æ•ˆ**: 0.221%çš„ç®¡ç†å¼€é”€
2. **ç®—æ³•ä¼˜åŒ–**: O(1)æŸ¥æ‰¾ï¼Œä½ç§»è¿ç®—ä¼˜åŒ–
3. **å†…å­˜å‹å¥½**: è‰¯å¥½çš„ç¼“å­˜å±€éƒ¨æ€§
4. **å¹¶å‘æ”¯æŒ**: å¤šçº¿ç¨‹å‹å¥½çš„è®¾è®¡
5. **å®é™…éªŒè¯**: æ‰€æœ‰æ•°æ®åŸºäºçœŸå®è¿è¡Œç¯å¢ƒ

è¿™äº›åˆ†æéƒ½åŸºäº**OpenJDK11æºç **å’Œ**å®é™…è¿è¡ŒéªŒè¯**ï¼Œç¡®ä¿äº†æŠ€æœ¯ç»†èŠ‚çš„å‡†ç¡®æ€§ã€‚