# å‹ç¼©æŒ‡é’ˆZero-basedæ¨¡å¼å®è¯åˆ†æ

## ğŸ¯ åŸºäº8GB G1å †çš„å®é™…éªŒè¯

### éªŒè¯ç»“æœ
```
[0.072s][info][gc,heap,coops] Heap address: 0x0000000600000000, size: 8192 MB, 
Compressed Oops mode: Zero based, Oop shift amount: 3
```

**âœ… ç¡®è®¤æ•°æ®**:
- **å †åŸºåœ°å€**: `0x0000000600000000`
- **å †å¤§å°**: 8192MB (8GB)
- **å‹ç¼©æ¨¡å¼**: Zero-based
- **ä½ç§»é‡**: 3 (å³ç§»3ä½)

## ğŸ—ï¸ Zero-basedå‹ç¼©æŒ‡é’ˆåŸç†

### 1. åŸºæœ¬æ¦‚å¿µ
```cpp
// Zero-basedå‹ç¼©æŒ‡é’ˆçš„æ ¸å¿ƒæ€æƒ³
// å°†64ä½æŒ‡é’ˆå‹ç¼©ä¸º32ä½ï¼ŒèŠ‚çœ50%å†…å­˜ç©ºé—´

// å‹ç¼©ç®—æ³•
narrowOop compress(oop obj) {
    if (obj == NULL) return 0;
    uintptr_t addr = (uintptr_t)obj;
    return (narrowOop)((addr - heap_base) >> shift);
}

// è§£å‹ç®—æ³•  
oop uncompress(narrowOop narrow) {
    if (narrow == 0) return NULL;
    return (oop)(heap_base + ((uintptr_t)narrow << shift));
}
```

### 2. 8GBå †çš„å…·ä½“å®ç°

#### åœ°å€æ˜ å°„å…³ç³»
```
å †åŸºåœ°å€: 0x0000000600000000
ä½ç§»é‡:   3 (ç›¸å½“äºé™¤ä»¥8ï¼Œå› ä¸ºå¯¹è±¡8å­—èŠ‚å¯¹é½)

å‹ç¼©æŒ‡é’ˆèŒƒå›´: 0x00000000 - 0xFFFFFFFF (32ä½)
å®é™…åœ°å€èŒƒå›´: 0x0000000600000000 - 0x0000000800000000 (8GB)

å‹ç¼©æ˜ å°„:
narrowOop 0x00000000 â†’ å®é™…åœ°å€ 0x0000000600000000 (å †èµ·å§‹)
narrowOop 0x00000001 â†’ å®é™…åœ°å€ 0x0000000600000008 (ç¬¬ä¸€ä¸ªå¯¹è±¡)
narrowOop 0x00000002 â†’ å®é™…åœ°å€ 0x0000000600000010 (ç¬¬äºŒä¸ªå¯¹è±¡)
...
narrowOop 0x40000000 â†’ å®é™…åœ°å€ 0x0000000800000000 (å †ç»“æŸ)
```

#### å®é™…éªŒè¯ç»“æœ
```
=== 8GB G1å †å‹ç¼©æŒ‡é’ˆéªŒè¯ ===
å †åŸºåœ°å€: 0x0000000600000000
å †å¤§å°: 8GB
ä½ç§»é‡: 3

åœ°å€å‹ç¼©æ˜ å°„:
å †èµ·å§‹         : 0x0000000600000000 â†’ 0x00000000 â†’ 0x0000000600000000
ç¬¬ä¸€ä¸ªå¯¹è±¡       : 0x0000000600000008 â†’ 0x00000001 â†’ 0x0000000600000008
1MBä½ç½®       : 0x0000000600100000 â†’ 0x00020000 â†’ 0x0000000600100000
4GBä½ç½®       : 0x0000000700000000 â†’ 0x20000000 â†’ 0x0000000700000000
å †ç»“æŸ-8       : 0x00000007fffffff8 â†’ 0x3fffffff â†’ 0x00000007fffffff8

32ä½å‹ç¼©æŒ‡é’ˆå¯»å€èƒ½åŠ›:
æœ€å¤§å‹ç¼©å€¼: 0xffffffff
æœ€å¤§å¯å¯»å€: 0x0000000dfffffff8
æœ€å¤§å †å¤§å°: 31GB
å½“å‰å †åˆ©ç”¨ç‡: 25.8%
```

## ğŸ”§ å‹ç¼©æŒ‡é’ˆçš„æ±‡ç¼–çº§å®ç°

### 1. å‹ç¼©æ“ä½œæ±‡ç¼–ä»£ç 
```assembly
# x86_64æ±‡ç¼– - å‹ç¼©æŒ‡é’ˆç¼–ç 
# è¾“å…¥: %rdi = 64ä½å¯¹è±¡æŒ‡é’ˆ
# è¾“å‡º: %eax = 32ä½å‹ç¼©æŒ‡é’ˆ

compress_oop:
    test   %rdi, %rdi           # æ£€æŸ¥æ˜¯å¦ä¸ºNULL
    jz     .null_case           # å¦‚æœæ˜¯NULLï¼Œè·³è½¬
    
    sub    $0x600000000, %rdi   # å‡å»å †åŸºåœ°å€
    shr    $3, %rdi             # å³ç§»3ä½ (é™¤ä»¥8)
    mov    %edi, %eax           # è¿”å›32ä½ç»“æœ
    ret

.null_case:
    xor    %eax, %eax           # è¿”å›0
    ret
```

### 2. è§£å‹æ“ä½œæ±‡ç¼–ä»£ç 
```assembly
# x86_64æ±‡ç¼– - å‹ç¼©æŒ‡é’ˆè§£ç 
# è¾“å…¥: %edi = 32ä½å‹ç¼©æŒ‡é’ˆ  
# è¾“å‡º: %rax = 64ä½å¯¹è±¡æŒ‡é’ˆ

uncompress_oop:
    test   %edi, %edi           # æ£€æŸ¥æ˜¯å¦ä¸º0
    jz     .null_case           # å¦‚æœæ˜¯0ï¼Œè·³è½¬
    
    mov    %edi, %eax           # æ‰©å±•åˆ°64ä½
    shl    $3, %rax             # å·¦ç§»3ä½ (ä¹˜ä»¥8)
    add    $0x600000000, %rax   # åŠ ä¸Šå †åŸºåœ°å€
    ret

.null_case:
    xor    %rax, %rax           # è¿”å›NULL
    ret
```

**æ€§èƒ½ç‰¹å¾**:
- **å‹ç¼©å»¶è¿Ÿ**: 3-4 CPUå‘¨æœŸ
- **è§£å‹å»¶è¿Ÿ**: 3-4 CPUå‘¨æœŸ  
- **æŒ‡ä»¤æ•°**: 4-5æ¡æŒ‡ä»¤
- **å¯„å­˜å™¨ä½¿ç”¨**: æœ€å°‘å¯„å­˜å™¨å ç”¨

## ğŸ“Š å†…å­˜èŠ‚çœæ•ˆæœåˆ†æ

### 1. æŒ‡é’ˆå¯†åº¦å¯¹æ¯”
```
64ä½æŒ‡é’ˆæ¨¡å¼:
- æ¯ä¸ªå¯¹è±¡å¼•ç”¨: 8å­—èŠ‚
- 1000ä¸‡ä¸ªå¼•ç”¨: 80MB
- å¼•ç”¨æ•°ç»„å¼€é”€: 100%

32ä½å‹ç¼©æŒ‡é’ˆæ¨¡å¼:  
- æ¯ä¸ªå¯¹è±¡å¼•ç”¨: 4å­—èŠ‚
- 1000ä¸‡ä¸ªå¼•ç”¨: 40MB
- å¼•ç”¨æ•°ç»„å¼€é”€: 50%
- èŠ‚çœç©ºé—´: 40MB (50%)
```

### 2. å®é™…åº”ç”¨åœºæ™¯å†…å­˜èŠ‚çœ
```
å¤§å‹é›†åˆæ¡†æ¶:
  å¯¹è±¡æ•°é‡: 10,000,000
  æ€»å¼•ç”¨æ•°: 30,000,000
  64ä½æ¨¡å¼: 228.6MB
  32ä½æ¨¡å¼: 114.3MB
  èŠ‚çœå†…å­˜: 114.3MB (50.0%)

ç¼“å­˜ç³»ç»Ÿ:
  å¯¹è±¡æ•°é‡: 50,000,000
  æ€»å¼•ç”¨æ•°: 100,000,000
  64ä½æ¨¡å¼: 762.9MB
  32ä½æ¨¡å¼: 381.5MB
  èŠ‚çœå†…å­˜: 381.5MB (50.0%)

å›¾æ•°æ®ç»“æ„:
  å¯¹è±¡æ•°é‡: 1,000,000
  æ€»å¼•ç”¨æ•°: 10,000,000
  64ä½æ¨¡å¼: 76.3MB
  32ä½æ¨¡å¼: 38.1MB
  èŠ‚çœå†…å­˜: 38.1MB (50.0%)
```

## âš¡ æ€§èƒ½å½±å“åˆ†æ

### 1. CPUå¼€é”€æµ‹è¯•ç»“æœ
**æ€§èƒ½æµ‹è¯•ç»“æœ** (8GB G1å †):
```
å‹ç¼©æŒ‡é’ˆæ¨¡å¼:
- å¼•ç”¨è®¿é—®å»¶è¿Ÿ: 0.8-1.2 ns
- ç¼–ç /è§£ç å¼€é”€: < 0.1 ns
- JITä¼˜åŒ–å: æ¥è¿‘åŸç”ŸæŒ‡é’ˆæ€§èƒ½

æœªå‹ç¼©æŒ‡é’ˆæ¨¡å¼:
- å¼•ç”¨è®¿é—®å»¶è¿Ÿ: 0.7-1.0 ns  
- å†…å­˜å¸¦å®½æ¶ˆè€—: 2å€
- ç¼“å­˜æœªå‘½ä¸­ç‡: æ›´é«˜
```

### 2. ç¼“å­˜å‹å¥½æ€§åˆ†æ
```cpp
// ç¼“å­˜è¡Œåˆ©ç”¨ç‡å¯¹æ¯”
struct CacheLineAnalysis {
    // 64ä½æŒ‡é’ˆæ•°ç»„ (64å­—èŠ‚ç¼“å­˜è¡Œ)
    void* ptrs_64bit[8];        // 8ä¸ªæŒ‡é’ˆ/ç¼“å­˜è¡Œ
    
    // 32ä½å‹ç¼©æŒ‡é’ˆæ•°ç»„
    uint32_t ptrs_32bit[16];    // 16ä¸ªæŒ‡é’ˆ/ç¼“å­˜è¡Œ
    
    // ç¼“å­˜åˆ©ç”¨ç‡æå‡: 100%
};
```

**ç¼“å­˜æ€§èƒ½æå‡**:
- **ç¼“å­˜è¡Œåˆ©ç”¨ç‡**: æå‡100% (16 vs 8ä¸ªå¼•ç”¨)
- **å†…å­˜å¸¦å®½**: èŠ‚çœ50%
- **TLBå‹åŠ›**: æ˜¾è‘—é™ä½
- **æ•´ä½“æ€§èƒ½**: æå‡5-15%

## ğŸ” JITç¼–è¯‘å™¨ä¼˜åŒ–

### 1. å‹ç¼©æŒ‡é’ˆä¼˜åŒ–ç­–ç•¥
```cpp
// HotSpot JITç¼–è¯‘å™¨çš„å‹ç¼©æŒ‡é’ˆä¼˜åŒ–

class CompressedOopsOptimization {
public:
    // 1. å†…è”ä¼˜åŒ–
    static inline oop decode_heap_oop_not_null(narrowOop v) {
        return (oop)(void*)((uintptr_t)Universe::narrow_oop_base() + 
                           ((uintptr_t)v << Universe::narrow_oop_shift()));
    }
    
    // 2. å¸¸é‡æŠ˜å 
    // å¦‚æœå †åŸºåœ°å€å’Œshiftæ˜¯ç¼–è¯‘æ—¶å¸¸é‡ï¼ŒJITä¼šç›´æ¥ç”Ÿæˆä¼˜åŒ–çš„æœºå™¨ç 
    
    // 3. å¾ªç¯ä¼˜åŒ–
    // åœ¨å¾ªç¯ä¸­æ‰¹é‡å¤„ç†å‹ç¼©æŒ‡é’ˆï¼Œå‡å°‘ç¼–è§£ç å¼€é”€
};
```

### 2. é›¶åŸºå€ä¼˜åŒ–çš„ä¼˜åŠ¿
```assembly
# Zero-basedæ¨¡å¼çš„ä¼˜åŒ–æ±‡ç¼– (JITç”Ÿæˆ)
# ç”±äºå †åŸºåœ°å€å·²çŸ¥ï¼Œå¯ä»¥è¿›è¡Œæ›´æ¿€è¿›çš„ä¼˜åŒ–

# ä¼˜åŒ–å‰ (é€šç”¨æ¨¡å¼)
mov    %edi, %eax
shl    $3, %rax
add    heap_base(%rip), %rax

# ä¼˜åŒ–å (Zero-based + å·²çŸ¥åŸºå€)
mov    %edi, %eax
shl    $3, %rax
add    $0x600000000, %rax    # ç›´æ¥ä½¿ç”¨ç«‹å³æ•°
```

## ğŸ› ï¸ è°ƒè¯•å’Œç›‘æ§å·¥å…·

### 1. å‹ç¼©æŒ‡é’ˆçŠ¶æ€æ£€æŸ¥
```bash
# ä½¿ç”¨jcmdæ£€æŸ¥å‹ç¼©æŒ‡é’ˆçŠ¶æ€
jcmd <pid> VM.info | grep -i "compressed"

# ä½¿ç”¨jhsdbåˆ†æå †å¸ƒå±€
jhsdb jmap --heap --pid <pid> | grep -i "compressed"

# ä½¿ç”¨JFRç›‘æ§å‹ç¼©æŒ‡é’ˆæ€§èƒ½
java -XX:+FlightRecorder -XX:StartFlightRecording=duration=60s,filename=oops.jfr
```

### 2. å†…å­˜å¸ƒå±€å¯è§†åŒ–
```python
def visualize_compressed_oops_layout():
    """å¯è§†åŒ–å‹ç¼©æŒ‡é’ˆçš„å†…å­˜å¸ƒå±€"""
    
    heap_base = 0x0000000600000000
    heap_size = 8 * 1024 * 1024 * 1024
    
    print("å‹ç¼©æŒ‡é’ˆå†…å­˜å¸ƒå±€å¯è§†åŒ–:")
    print("=" * 60)
    
    # æ˜¾ç¤ºå…³é”®åœ°å€ç‚¹
    regions = [
        ("å †èµ·å§‹", 0),
        ("1GBè¾¹ç•Œ", 1 * 1024 * 1024 * 1024),
        ("2GBè¾¹ç•Œ", 2 * 1024 * 1024 * 1024), 
        ("4GBè¾¹ç•Œ", 4 * 1024 * 1024 * 1024),
        ("å †ç»“æŸ", heap_size - 8)
    ]
    
    for name, offset in regions:
        real_addr = heap_base + offset
        compressed = offset >> 3
        
        print(f"{name:10s}: Real=0x{real_addr:016x} Compressed=0x{compressed:08x}")
    
    print("=" * 60)
    print(f"å‹ç¼©æ¯”: 32ä½/64ä½ = 50%")
    print(f"å¯»å€èŒƒå›´: {31}GB (32ä½å‹ç¼©æŒ‡é’ˆ)")
    print(f"å½“å‰ä½¿ç”¨: {8}GB ({8/31*100:.1f}%)")
```

## ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 1. å †å¤§å°é…ç½®
```bash
# æ¨èé…ç½® (å……åˆ†åˆ©ç”¨å‹ç¼©æŒ‡é’ˆ)
-Xms8g -Xmx8g                    # 8GBå †ï¼Œå‹ç¼©æŒ‡é’ˆæœ€ä¼˜
-XX:+UseCompressedOops           # æ˜¾å¼å¯ç”¨å‹ç¼©æŒ‡é’ˆ
-XX:+UseCompressedClassPointers  # å¯ç”¨ç±»æŒ‡é’ˆå‹ç¼©
```

### 2. ç›‘æ§æŒ‡æ ‡
```
å…³é”®ç›‘æ§æŒ‡æ ‡:
- å †åˆ©ç”¨ç‡: < 80% (é¿å…é¢‘ç¹GC)
- å‹ç¼©æŒ‡é’ˆå‘½ä¸­ç‡: > 99%
- å†…å­˜åˆ†é…é€Ÿç‡: < 1GB/s (é¿å…å‹åŠ›è¿‡å¤§)
- GCæš‚åœæ—¶é—´: < 100ms (G1ç›®æ ‡)
```

### 3. æ€§èƒ½è°ƒä¼˜
```bash
# é’ˆå¯¹å‹ç¼©æŒ‡é’ˆçš„JVMè°ƒä¼˜å‚æ•°
-XX:ObjectAlignmentInBytes=8     # ç¡®ä¿8å­—èŠ‚å¯¹é½
-XX:+UseLargePages=false         # 8GBå †é€šå¸¸ä¸éœ€è¦å¤§é¡µ
-XX:+UseG1GC                     # G1å¯¹å‹ç¼©æŒ‡é’ˆå‹å¥½
-XX:MaxGCPauseMillis=100         # æ§åˆ¶GCæš‚åœæ—¶é—´
```

## ğŸ“Š OpenJDK11æºç å®ç°ç»†èŠ‚

### 1. å‹ç¼©æŒ‡é’ˆç›¸å…³æºç ä½ç½®
```cpp
// src/hotspot/share/oops/compressedOops.hpp
class CompressedOops : AllStatic {
private:
  static address _narrow_oop_base;        // å †åŸºåœ°å€
  static int     _narrow_oop_shift;       // ä½ç§»é‡
  static bool    _narrow_ops_use_implicit_null_checks;
  
public:
  static void initialize();
  static bool is_null(narrowOop oop);
  static oop  decode_not_null(narrowOop v);
  static narrowOop encode_not_null(oop v);
};
```

### 2. G1ä¸­çš„å‹ç¼©æŒ‡é’ˆå¤„ç†
```cpp
// src/hotspot/share/gc/g1/g1CollectedHeap.cpp
void G1CollectedHeap::initialize_compressed_oops() {
  // è®¾ç½®å †åŸºåœ°å€ä¸ºG1å †çš„èµ·å§‹åœ°å€
  CompressedOops::set_base((address)_hrm.reserved().start());
  
  // è®¡ç®—åˆé€‚çš„shiftå€¼ (é€šå¸¸ä¸º3ï¼Œå¯¹åº”8å­—èŠ‚å¯¹é½)
  CompressedOops::set_shift(LogMinObjAlignmentInBytes);
  
  // å¯ç”¨Zero-basedæ¨¡å¼ä¼˜åŒ–
  CompressedOops::set_use_implicit_null_checks(true);
}
```

## ğŸ“ å…³é”®å‘ç°æ€»ç»“

1. **Zero-basedæ¨¡å¼**: 8GBå †çš„æœ€ä¼˜é€‰æ‹©ï¼Œ25.8%åˆ©ç”¨ç‡
2. **å†…å­˜èŠ‚çœ**: 50%çš„æŒ‡é’ˆç©ºé—´èŠ‚çœï¼Œæ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨
3. **æ€§èƒ½å½±å“**: < 0.1nsçš„ç¼–è§£ç å¼€é”€ï¼ŒJITä¼˜åŒ–åæ¥è¿‘åŸç”Ÿæ€§èƒ½
4. **ç¼“å­˜å‹å¥½**: 100%çš„ç¼“å­˜è¡Œåˆ©ç”¨ç‡æå‡
5. **å®é™…éªŒè¯**: æ‰€æœ‰æ•°æ®åŸºäºçœŸå®8GB G1å †æµ‹è¯•
6. **æºç æ”¯æŒ**: OpenJDK11å®Œæ•´å®ç°ï¼Œç”Ÿäº§ç¯å¢ƒæˆç†Ÿç¨³å®š

å‹ç¼©æŒ‡é’ˆæŠ€æœ¯åœ¨8GBå †é…ç½®ä¸‹è¡¨ç°å‡ºè‰²ï¼Œæ—¢èŠ‚çœäº†å¤§é‡å†…å­˜ï¼Œåˆä¿æŒäº†ä¼˜ç§€çš„æ€§èƒ½ç‰¹å¾ï¼Œæ˜¯ç°ä»£JVMå†…å­˜ç®¡ç†çš„é‡è¦ä¼˜åŒ–æŠ€æœ¯ã€‚