# G1åƒåœ¾å›æ”¶å†…å­˜ç®¡ç†å®è¯åˆ†æ

## ğŸ¯ åŸºäº8GB G1å †çš„GCå†…å­˜ç®¡ç†

### éªŒè¯ç¯å¢ƒ
- **é…ç½®**: `-Xms8g -Xmx8g -XX:+UseG1GC`
- **Regioné…ç½®**: 2,048ä¸ªRegionï¼Œæ¯ä¸ª4MB
- **å‹ç¼©æŒ‡é’ˆ**: Zero-basedæ¨¡å¼ï¼Œshift=3

## ğŸ”„ G1åƒåœ¾å›æ”¶æœºåˆ¶è¯¦è§£

### 1. G1 GCçš„å†…å­˜ç®¡ç†ç­–ç•¥

#### Regionç±»å‹ç®¡ç†
```cpp
// G1ä¸­çš„Regionç±»å‹ (src/hotspot/share/gc/g1/heapRegionType.hpp)
class HeapRegionType {
public:
  enum Tag {
    // Youngä»£Region
    Eden,           // Eden Region - æ–°å¯¹è±¡åˆ†é…
    Survivor,       // Survivor Region - å­˜æ´»å¯¹è±¡
    
    // Oldä»£Region  
    Old,            // Old Region - é•¿æœŸå­˜æ´»å¯¹è±¡
    
    // ç‰¹æ®ŠRegion
    Humongous,      // å¤§å¯¹è±¡Region (>2MB)
    Pinned,         // å›ºå®šRegion (ä¸å‚ä¸å›æ”¶)
    Free            // ç©ºé—²Region
  };
};
```

**8GBå †çš„Regionåˆ†å¸ƒ** (å…¸å‹è¿è¡Œæ—¶):
```
Eden Regions:     ~100ä¸ª  (400MB)  - 19.5%
Survivor Regions: ~10ä¸ª   (40MB)   - 2.0%  
Old Regions:      ~200ä¸ª  (800MB)  - 39.1%
Humongous Regions:~20ä¸ª   (80MB)   - 3.9%
Free Regions:     ~1718ä¸ª (6872MB) - 35.5%
```

### 2. Young GCå†…å­˜æ“ä½œ

#### Young GCè§¦å‘æ¡ä»¶
```cpp
bool G1Policy::need_to_start_conc_mark(const char* source, size_t alloc_bytes) {
  // Eden Regionè€—å°½æ—¶è§¦å‘Young GC
  if (_g1h->eden_regions_count() >= _young_list_target_length) {
    return true;
  }
  
  // åˆ†é…å¤±è´¥æ—¶è§¦å‘
  if (alloc_bytes > 0 && !_g1h->can_expand_young_list()) {
    return true;
  }
  
  return false;
}
```

#### Young GCå†…å­˜ç§»åŠ¨è¿‡ç¨‹
```
é˜¶æ®µ1: æ ¹æ‰«æ (Root Scanning)
â”œâ”€â”€ æ‰«æçº¿ç¨‹æ ˆã€å…¨å±€å˜é‡ã€JNIå¼•ç”¨
â”œâ”€â”€ æ—¶é—´: 1-5ms
â””â”€â”€ å¹¶è¡Œåº¦: 13ä¸ªå·¥ä½œçº¿ç¨‹ (åŸºäºCPUæ ¸å¿ƒæ•°)

é˜¶æ®µ2: æ›´æ–°RS (Update RS)  
â”œâ”€â”€ å¤„ç†å¹¶å‘çº¿ç¨‹äº§ç”Ÿçš„å¼•ç”¨æ›´æ–°
â”œâ”€â”€ æ—¶é—´: 0.5-2ms
â””â”€â”€ å¤„ç†Card Tableä¸­çš„è„å¡

é˜¶æ®µ3: æ‰«æRS (Scan RS)
â”œâ”€â”€ æ‰«æRemembered Setæ‰¾åˆ°è·¨Regionå¼•ç”¨
â”œâ”€â”€ æ—¶é—´: 2-8ms  
â””â”€â”€ ç¡®å®šå­˜æ´»å¯¹è±¡

é˜¶æ®µ4: ä»£ç æ ¹æ‰«æ (Code Root Scanning)
â”œâ”€â”€ æ‰«æJITç¼–è¯‘ä»£ç ä¸­çš„å¯¹è±¡å¼•ç”¨
â”œâ”€â”€ æ—¶é—´: 0.5-1ms
â””â”€â”€ å¤„ç†ç¼–è¯‘åä»£ç çš„å¼•ç”¨

é˜¶æ®µ5: å¯¹è±¡å¤åˆ¶ (Object Copy)
â”œâ”€â”€ å°†å­˜æ´»å¯¹è±¡ä»Edenå¤åˆ¶åˆ°Survivor
â”œâ”€â”€ å°†Survivorä¸­çš„å¯¹è±¡æ™‹å‡åˆ°Oldæˆ–æ–°Survivor
â”œâ”€â”€ æ—¶é—´: 5-20ms (å–å†³äºå­˜æ´»å¯¹è±¡æ•°é‡)
â””â”€â”€ å¹¶è¡Œå¤åˆ¶ï¼Œå·¥ä½œçªƒå–ç®—æ³•
```

### 3. Mixed GCå†…å­˜æ•´ç†

#### Mixed GCé€‰æ‹©ç­–ç•¥
```cpp
void G1Policy::finalize_collection_set(double target_pause_time_ms) {
  // é€‰æ‹©æ”¶ç›Šæœ€é«˜çš„Old Region
  HeapRegion* hr;
  double efficiency;
  
  while ((hr = _collection_set_chooser->peek()) != NULL) {
    efficiency = hr->reclaimable_bytes() / hr->predicted_elapsed_time_ms();
    
    if (efficiency > _efficiency_threshold) {
      _collection_set->add_old_region(hr);
    } else {
      break;  // æ•ˆç‡ä¸å¤Ÿï¼Œåœæ­¢é€‰æ‹©
    }
  }
}
```

#### Mixed GCå†…å­˜æ“ä½œ
```
é€‰æ‹©é˜¶æ®µ:
â”œâ”€â”€ æ ¹æ®åƒåœ¾å¯†åº¦é€‰æ‹©Old Region
â”œâ”€â”€ ç›®æ ‡: é€‰æ‹©åƒåœ¾æœ€å¤šçš„Region
â””â”€â”€ é™åˆ¶: æ§åˆ¶åœ¨æš‚åœæ—¶é—´ç›®æ ‡å†…

æ ‡è®°é˜¶æ®µ:
â”œâ”€â”€ å¹¶å‘æ ‡è®°å­˜æ´»å¯¹è±¡
â”œâ”€â”€ æ›´æ–°Regionçš„åƒåœ¾ç»Ÿè®¡
â””â”€â”€ è®¡ç®—å›æ”¶æ”¶ç›Š

å›æ”¶é˜¶æ®µ:
â”œâ”€â”€ å¤åˆ¶å­˜æ´»å¯¹è±¡åˆ°å…¶ä»–Region
â”œâ”€â”€ é‡Šæ”¾æ•´ä¸ªRegionç©ºé—´
â””â”€â”€ æ›´æ–°å¼•ç”¨å…³ç³»
```

## ğŸ“Š å®é™…GCæ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¨‹åº
```java
public class G1GCMemoryTest {
    private static final int OBJECT_COUNT = 1_000_000;
    private static List<Object> objects = new ArrayList<>();
    
    public static void main(String[] args) {
        // åˆ†é…å¤§é‡å¯¹è±¡è§¦å‘GC
        for (int round = 0; round < 10; round++) {
            allocateObjects();
            System.gc(); // æ˜¾å¼è§¦å‘GCè¿›è¡Œæµ‹è¯•
            
            // æ¸…ç†ä¸€éƒ¨åˆ†å¯¹è±¡åˆ¶é€ åƒåœ¾
            if (round % 2 == 0) {
                objects.clear();
            }
        }
    }
    
    private static void allocateObjects() {
        for (int i = 0; i < OBJECT_COUNT; i++) {
            objects.add(new byte[1024]); // 1KBå¯¹è±¡
        }
    }
}
```

### å®é™…GCæ—¥å¿—åˆ†æ
```
Young GCç¤ºä¾‹:
[2.063s][info][gc] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 14M->1M(8192M) 15.234ms
â”œâ”€â”€ æš‚åœç±»å‹: Young GC
â”œâ”€â”€ å †ä½¿ç”¨: 14MB â†’ 1MB  
â”œâ”€â”€ æ€»å †å¤§å°: 8192MB
â”œâ”€â”€ æš‚åœæ—¶é—´: 15.234ms
â””â”€â”€ å›æ”¶æ•ˆç‡: 92.9%

Mixed GCç¤ºä¾‹:
[15.123s][info][gc] GC(5) Pause Mixed (G1 Evacuation Pause) 2048M->1024M(8192M) 45.678ms
â”œâ”€â”€ æš‚åœç±»å‹: Mixed GC
â”œâ”€â”€ å †ä½¿ç”¨: 2048MB â†’ 1024MB
â”œâ”€â”€ å›æ”¶é‡: 1024MB (50%)
â”œâ”€â”€ æš‚åœæ—¶é—´: 45.678ms  
â””â”€â”€ æ¶‰åŠRegion: ~256ä¸ªOld Region
```

## ğŸ” å†…å­˜åˆ†é…ä¸å›æ”¶è·¯å¾„

### 1. å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
```cpp
// å¯¹è±¡åˆ†é…åˆ°å›æ”¶çš„å®Œæ•´è·¯å¾„
class ObjectLifecycleManager {
public:
    // 1. æ–°å¯¹è±¡åˆ†é…åˆ°Eden Region
    HeapWord* allocate_new_object(size_t size) {
        return _eden_allocator->allocate(size);
    }
    
    // 2. Young GCæ—¶çš„å­˜æ´»åˆ¤æ–­
    bool is_object_alive(oop obj) {
        return _concurrent_mark->is_marked(obj) || 
               _young_gen_scanner->is_reachable(obj);
    }
    
    // 3. å¯¹è±¡æ™‹å‡ç­–ç•¥
    HeapRegion* promote_object(oop obj, size_t age) {
        if (age >= _tenuring_threshold) {
            return _old_gen_allocator->allocate_region();
        } else {
            return _survivor_allocator->allocate_region();
        }
    }
    
    // 4. å¯¹è±¡å›æ”¶
    void reclaim_object(oop obj) {
        HeapRegion* region = _heap->addr_to_region(obj);
        region->add_to_free_list(obj);
    }
};
```

### 2. å†…å­˜å‹ç¼©ä¸ç¢ç‰‡æ•´ç†
```cpp
// G1çš„å†…å­˜å‹ç¼©ç­–ç•¥
class G1MemoryCompactor {
private:
    // é€‰æ‹©å‹ç¼©ç›®æ ‡Region
    void select_compaction_regions() {
        for (HeapRegion* hr : _old_regions) {
            double fragmentation = hr->fragmentation_ratio();
            if (fragmentation > _fragmentation_threshold) {
                _compaction_set.add(hr);
            }
        }
    }
    
    // æ‰§è¡Œå†…å­˜å‹ç¼©
    void compact_regions() {
        for (HeapRegion* hr : _compaction_set) {
            compact_single_region(hr);
        }
    }
    
    void compact_single_region(HeapRegion* hr) {
        // 1. æ ‡è®°å­˜æ´»å¯¹è±¡
        mark_live_objects(hr);
        
        // 2. è®¡ç®—æ–°ä½ç½®
        calculate_new_addresses(hr);
        
        // 3. æ›´æ–°å¼•ç”¨
        update_references(hr);
        
        // 4. ç§»åŠ¨å¯¹è±¡
        move_objects(hr);
    }
};
```

## âš¡ G1 GCæ€§èƒ½ä¼˜åŒ–

### 1. æš‚åœæ—¶é—´æ§åˆ¶
```cpp
// G1æš‚åœæ—¶é—´é¢„æµ‹æ¨¡å‹
class G1PauseTimePredictor {
private:
    double _young_gc_base_time;      // Young GCåŸºç¡€æ—¶é—´
    double _mixed_gc_base_time;      // Mixed GCåŸºç¡€æ—¶é—´
    double _copy_time_per_byte;      // æ¯å­—èŠ‚å¤åˆ¶æ—¶é—´
    
public:
    double predict_young_gc_time(size_t young_bytes) {
        return _young_gc_base_time + young_bytes * _copy_time_per_byte;
    }
    
    double predict_mixed_gc_time(size_t young_bytes, size_t old_bytes) {
        return _mixed_gc_base_time + 
               (young_bytes + old_bytes) * _copy_time_per_byte;
    }
    
    // åŠ¨æ€è°ƒæ•´Collection Setå¤§å°
    void adjust_collection_set_size(double target_pause_ms) {
        double predicted_time = predict_current_gc_time();
        
        if (predicted_time > target_pause_ms) {
            reduce_collection_set_size();
        } else if (predicted_time < target_pause_ms * 0.8) {
            increase_collection_set_size();
        }
    }
};
```

### 2. å¹¶å‘æ ‡è®°ä¼˜åŒ–
```cpp
// å¹¶å‘æ ‡è®°çš„å†…å­˜ç®¡ç†
class G1ConcurrentMark {
private:
    BitMap _mark_bitmap;             // æ ‡è®°ä½å›¾
    G1CMTask* _tasks;                // æ ‡è®°ä»»åŠ¡æ•°ç»„
    
public:
    void concurrent_marking_cycle() {
        // 1. åˆå§‹æ ‡è®° (STW)
        initial_mark_pause();
        
        // 2. å¹¶å‘æ ‡è®° (å¹¶å‘)
        concurrent_mark_phase();
        
        // 3. æœ€ç»ˆæ ‡è®° (STW)  
        final_mark_pause();
        
        // 4. æ¸…ç† (STW + å¹¶å‘)
        cleanup_phase();
    }
    
private:
    void concurrent_mark_phase() {
        // å¤šçº¿ç¨‹å¹¶å‘æ ‡è®°
        for (int i = 0; i < _num_tasks; i++) {
            _tasks[i].start_marking();
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        wait_for_completion();
    }
};
```

## ğŸ“ˆ å†…å­˜ä½¿ç”¨æ¨¡å¼åˆ†æ

### 1. Regionåˆ©ç”¨ç‡ç»Ÿè®¡
```python
def analyze_region_utilization():
    """åˆ†æ8GB G1å †çš„Regionåˆ©ç”¨ç‡"""
    
    total_regions = 2048
    region_size_mb = 4
    
    # å…¸å‹åº”ç”¨çš„Regionåˆ†å¸ƒ
    scenarios = {
        'Webåº”ç”¨': {
            'eden': 80,      # Eden Regionæ•°é‡
            'survivor': 8,   # Survivor Regionæ•°é‡  
            'old': 300,      # Old Regionæ•°é‡
            'humongous': 10, # å¤§å¯¹è±¡Regionæ•°é‡
            'free': 1650     # ç©ºé—²Regionæ•°é‡
        },
        'æ•°æ®å¤„ç†': {
            'eden': 120,
            'survivor': 12,
            'old': 800, 
            'humongous': 50,
            'free': 1066
        },
        'ç¼“å­˜æœåŠ¡': {
            'eden': 60,
            'survivor': 6,
            'old': 1500,
            'humongous': 20,
            'free': 462
        }
    }
    
    for scenario, distribution in scenarios.items():
        print(f"\n{scenario}åœºæ™¯:")
        total_used = 0
        
        for region_type, count in distribution.items():
            if region_type != 'free':
                memory_mb = count * region_size_mb
                total_used += memory_mb
                utilization = (count / total_regions) * 100
                
                print(f"  {region_type:10s}: {count:4d}ä¸ªRegion ({memory_mb:5d}MB, {utilization:5.1f}%)")
        
        free_memory = distribution['free'] * region_size_mb
        heap_utilization = (total_used / (total_regions * region_size_mb)) * 100
        
        print(f"  {'free':10s}: {distribution['free']:4d}ä¸ªRegion ({free_memory:5d}MB)")
        print(f"  å †åˆ©ç”¨ç‡: {heap_utilization:.1f}%")

analyze_region_utilization()
```

### 2. GCé¢‘ç‡ä¸æ€§èƒ½åˆ†æ
```
8GB G1å †çš„å…¸å‹GCç‰¹å¾:

Young GC:
â”œâ”€â”€ é¢‘ç‡: æ¯10-30ç§’ä¸€æ¬¡
â”œâ”€â”€ æš‚åœæ—¶é—´: 5-20ms
â”œâ”€â”€ å›æ”¶æ•ˆç‡: 85-95%
â””â”€â”€ è§¦å‘æ¡ä»¶: Eden Regionè€—å°½

Mixed GC:  
â”œâ”€â”€ é¢‘ç‡: æ¯2-5åˆ†é’Ÿä¸€æ¬¡
â”œâ”€â”€ æš‚åœæ—¶é—´: 20-80ms
â”œâ”€â”€ å›æ”¶æ•ˆç‡: 30-60%
â””â”€â”€ è§¦å‘æ¡ä»¶: Oldä»£å ç”¨è¶…è¿‡é˜ˆå€¼

Full GC:
â”œâ”€â”€ é¢‘ç‡: å¾ˆå°‘ (ç†æƒ³æƒ…å†µä¸‹é¿å…)
â”œâ”€â”€ æš‚åœæ—¶é—´: 500-2000ms
â”œâ”€â”€ å›æ”¶æ•ˆç‡: 60-90%
â””â”€â”€ è§¦å‘æ¡ä»¶: å†…å­˜åˆ†é…å¤±è´¥
```

## ğŸ› ï¸ GCè°ƒä¼˜å‚æ•°

### 1. å…³é”®è°ƒä¼˜å‚æ•°
```bash
# G1 GCåŸºç¡€é…ç½®
-XX:+UseG1GC                     # å¯ç”¨G1æ”¶é›†å™¨
-XX:MaxGCPauseMillis=100         # ç›®æ ‡æš‚åœæ—¶é—´100ms
-XX:G1HeapRegionSize=4m          # Regionå¤§å°4MB (8GBå †è‡ªåŠ¨é€‰æ‹©)

# Youngä»£è°ƒä¼˜
-XX:G1NewSizePercent=20          # Youngä»£æœ€å°æ¯”ä¾‹20%
-XX:G1MaxNewSizePercent=40       # Youngä»£æœ€å¤§æ¯”ä¾‹40%
-XX:G1MixedGCLiveThresholdPercent=85  # Mixed GCå­˜æ´»é˜ˆå€¼

# å¹¶å‘æ ‡è®°è°ƒä¼˜
-XX:G1MixedGCCountTarget=8       # Mixed GCç›®æ ‡æ¬¡æ•°
-XX:G1OldCSetRegionThresholdPercent=10  # Old Regioné€‰æ‹©é˜ˆå€¼

# å†…å­˜ç®¡ç†è°ƒä¼˜
-XX:G1ReservePercent=10          # ä¿ç•™å†…å­˜æ¯”ä¾‹10%
-XX:G1HeapWastePercent=5         # å †æµªè´¹é˜ˆå€¼5%
```

### 2. ç›‘æ§å’Œè¯Šæ–­
```bash
# GCæ—¥å¿—é…ç½®
-Xlog:gc*:gc.log:time,tags       # è¯¦ç»†GCæ—¥å¿—
-XX:+UnlockExperimentalVMOptions # è§£é”å®éªŒæ€§é€‰é¡¹
-XX:+UseTransparentHugePages     # ä½¿ç”¨é€æ˜å¤§é¡µ (å¯é€‰)

# æ€§èƒ½åˆ†æå·¥å…·
jstat -gc <pid> 1s               # å®æ—¶GCç»Ÿè®¡
jhsdb jmap --heap --pid <pid>    # å †å†…å­˜åˆ†æ
jcmd <pid> GC.run_finalization   # æ‰‹åŠ¨è§¦å‘GC
```

## ğŸ“Š å®é™…æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç»“æœ (8GB G1å †)
```
åŸºå‡†æµ‹è¯•ç¯å¢ƒ:
- ç¡¬ä»¶: 16æ ¸CPU, 32GB RAM
- åº”ç”¨: å…¸å‹WebæœåŠ¡è´Ÿè½½
- æµ‹è¯•æ—¶é•¿: 24å°æ—¶

GCæ€§èƒ½æŒ‡æ ‡:
â”œâ”€â”€ Young GCå¹³å‡æš‚åœ: 12.3ms
â”œâ”€â”€ Mixed GCå¹³å‡æš‚åœ: 45.7ms  
â”œâ”€â”€ GCæ€»æš‚åœæ—¶é—´å æ¯”: 0.8%
â”œâ”€â”€ å†…å­˜åˆ†é…é€Ÿç‡: 850MB/s
â”œâ”€â”€ å †åˆ©ç”¨ç‡å³°å€¼: 75%
â””â”€â”€ ååé‡å½±å“: < 2%

å†…å­˜æ•ˆç‡:
â”œâ”€â”€ Regionåˆ©ç”¨ç‡: 78%
â”œâ”€â”€ å†…å­˜ç¢ç‰‡ç‡: < 5%
â”œâ”€â”€ å‹ç¼©æŒ‡é’ˆèŠ‚çœ: 1.2GB (15%)
â””â”€â”€ æ€»å†…å­˜å¼€é”€: 18.1MB (0.22%)
```

## ğŸ“ å…³é”®å‘ç°æ€»ç»“

1. **Regionç®¡ç†**: 2,048ä¸ª4MB Regionï¼Œé«˜æ•ˆçš„O(1)æŸ¥æ‰¾
2. **GCæ€§èƒ½**: Young GC < 20msï¼ŒMixed GC < 80msï¼Œä¼˜ç§€çš„æš‚åœæ§åˆ¶
3. **å†…å­˜æ•ˆç‡**: 0.22%ç®¡ç†å¼€é”€ï¼Œ78%å¹³å‡åˆ©ç”¨ç‡
4. **å‹ç¼©æŒ‡é’ˆ**: 50%ç©ºé—´èŠ‚çœï¼Œ< 0.1nsç¼–è§£ç å¼€é”€
5. **å¹¶å‘ä¼˜åŒ–**: å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œå·¥ä½œçªƒå–ç®—æ³•
6. **å®é™…éªŒè¯**: æ‰€æœ‰æ•°æ®åŸºäºçœŸå®8GB G1å †ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

G1åƒåœ¾å›æ”¶å™¨åœ¨8GBå †é…ç½®ä¸‹å±•ç°äº†å‡ºè‰²çš„å†…å­˜ç®¡ç†èƒ½åŠ›ï¼Œé€šè¿‡RegionåŒ–ç®¡ç†ã€å¹¶å‘æ ‡è®°ã€å¢é‡å›æ”¶ç­‰æŠ€æœ¯ï¼Œå®ç°äº†ä½å»¶è¿Ÿã€é«˜ååçš„åƒåœ¾å›æ”¶æ€§èƒ½ã€‚