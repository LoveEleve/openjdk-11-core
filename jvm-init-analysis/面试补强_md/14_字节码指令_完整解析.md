# å­—èŠ‚ç æŒ‡ä»¤å®Œæ•´è§£æ - JVMåº•å±‚æœºåˆ¶

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±åº¦è§£æJavaå­—èŠ‚ç æŒ‡ä»¤é›†ï¼Œæ¶µç›–æŒ‡ä»¤åˆ†ç±»ã€æ‰§è¡Œæœºåˆ¶å’ŒASMæ¡†æ¶ä½¿ç”¨ï¼Œä¸ºé¢è¯•å’Œæ·±åº¦ç†è§£JVMæä¾›å®Œæ•´çš„å­—èŠ‚ç çŸ¥è¯†ä½“ç³»ã€‚

## ğŸ¯ é¢è¯•æ ¸å¿ƒè¦ç‚¹

### **é¢è¯•å®˜å¸¸é—®é—®é¢˜**
1. "åŠ¨æ€ä»£ç†å¦‚ä½•å®ç°ï¼Ÿå­—èŠ‚ç å¦‚ä½•ä¿®æ”¹ï¼Ÿ"
2. "JVMæŒ‡ä»¤é›†æœ‰å“ªäº›ç±»å‹ï¼Ÿæ‰§è¡ŒåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"
3. "ASMæ¡†æ¶å¦‚ä½•ä½¿ç”¨ï¼Ÿæœ‰ä»€ä¹ˆåº”ç”¨åœºæ™¯ï¼Ÿ"
4. "å­—èŠ‚ç å¢å¼ºæŠ€æœ¯åœ¨å“ªäº›æ¡†æ¶ä¸­ä½¿ç”¨ï¼Ÿ"

---

## ğŸ” **1. JVMæŒ‡ä»¤é›†åˆ†ç±»**

### 1.1 æŒ‡ä»¤æ ¼å¼å’Œæ“ä½œæ•°æ ˆ

**æŒ‡ä»¤æ ¼å¼**ï¼š
```
opcode [operand1] [operand2] ...

ä¾‹å¦‚ï¼š
bipush 10    // å°†å¸¸é‡10æ¨å…¥æ“ä½œæ•°æ ˆ
iload_1      // å°†å±€éƒ¨å˜é‡è¡¨ç´¢å¼•1çš„intå€¼æ¨å…¥æ ˆ
iadd         // å¼¹å‡ºæ ˆé¡¶ä¸¤ä¸ªintå€¼ï¼Œç›¸åŠ åæ¨å…¥æ ˆ
```

**æ“ä½œæ•°æ ˆæ¨¡å‹**ï¼š
```
æ ˆå¸§ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ“ä½œæ•°æ ˆ      â”‚ â† æŒ‡ä»¤æ“ä½œçš„ä¸»è¦åŒºåŸŸ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å±€éƒ¨å˜é‡è¡¨    â”‚ â† å­˜å‚¨æ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åŠ¨æ€é“¾æ¥      â”‚ â† è¿è¡Œæ—¶å¸¸é‡æ± å¼•ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ–¹æ³•è¿”å›åœ°å€  â”‚ â† æ–¹æ³•è°ƒç”¨è¿”å›ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åŠ è½½å’Œå­˜å‚¨æŒ‡ä»¤

**å¸¸é‡åŠ è½½æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
int a = 5;
long b = 100L;
float c = 3.14f;
double d = 2.718;
String s = "Hello";

// å¯¹åº”å­—èŠ‚ç 
bipush 5        // åŠ è½½å°æ•´æ•°(-128åˆ°127)
ldc2_w #2       // åŠ è½½longå¸¸é‡100L
ldc #3          // åŠ è½½floatå¸¸é‡3.14f  
ldc2_w #4       // åŠ è½½doubleå¸¸é‡2.718
ldc #5          // åŠ è½½Stringå¸¸é‡"Hello"
```

**å±€éƒ¨å˜é‡æ“ä½œæŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
public void test(int param) {
    int local1 = param;
    int local2 = 10;
    int result = local1 + local2;
}

// å¯¹åº”å­—èŠ‚ç 
iload_1         // åŠ è½½å‚æ•°param (ç´¢å¼•1ï¼Œç´¢å¼•0æ˜¯this)
istore_2        // å­˜å‚¨åˆ°local1 (ç´¢å¼•2)
bipush 10       // åŠ è½½å¸¸é‡10
istore_3        // å­˜å‚¨åˆ°local2 (ç´¢å¼•3)
iload_2         // åŠ è½½local1
iload_3         // åŠ è½½local2
iadd            // ç›¸åŠ 
istore 4        // å­˜å‚¨åˆ°result (ç´¢å¼•4)
```

### 1.3 è¿ç®—æŒ‡ä»¤

**ç®—æœ¯è¿ç®—æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
int a = 10, b = 3;
int add = a + b;      // iadd
int sub = a - b;      // isub  
int mul = a * b;      // imul
int div = a / b;      // idiv
int rem = a % b;      // irem
int neg = -a;         // ineg

// ä½è¿ç®—
int and = a & b;      // iand
int or = a | b;       // ior
int xor = a ^ b;      // ixor
int shl = a << 2;     // ishl (å·¦ç§»)
int shr = a >> 2;     // ishr (ç®—æœ¯å³ç§»)
int ushr = a >>> 2;   // iushr (é€»è¾‘å³ç§»)
```

**ç±»å‹è½¬æ¢æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
int i = 100;
long l = i;           // i2l (int to long)
float f = i;          // i2f (int to float)
double d = i;         // i2d (int to double)

long l2 = 1000L;
int i2 = (int)l2;     // l2i (long to intï¼Œå¯èƒ½ä¸¢å¤±ç²¾åº¦)

// å¯¹åº”å­—èŠ‚ç 
bipush 100
istore_1              // i = 100
iload_1
i2l                   // è½¬æ¢ä¸ºlong
lstore_2              // l = (long)i
```

### 1.4 å¯¹è±¡æ“ä½œæŒ‡ä»¤

**å¯¹è±¡åˆ›å»ºå’Œè®¿é—®**ï¼š
```java
// Javaä»£ç 
public class Person {
    private String name;
    private int age;
    
    public Person(String name, int age) {
        this.name = name;
        this.age = age;
    }
}

Person p = new Person("Alice", 25);

// å¯¹åº”å­—èŠ‚ç 
new #2              // åˆ›å»ºPersonå¯¹è±¡
dup                 // å¤åˆ¶å¯¹è±¡å¼•ç”¨
ldc #3              // åŠ è½½"Alice"
bipush 25           // åŠ è½½25
invokespecial #4    // è°ƒç”¨æ„é€ æ–¹æ³•Person.<init>
astore_1            // å­˜å‚¨å¯¹è±¡å¼•ç”¨åˆ°å±€éƒ¨å˜é‡p
```

**å­—æ®µè®¿é—®æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
String name = p.name;    // getfield
p.age = 30;             // putfield

// é™æ€å­—æ®µ
System.out.println();   // getstatic, putstatic

// å¯¹åº”å­—èŠ‚ç 
aload_1                 // åŠ è½½å¯¹è±¡å¼•ç”¨p
getfield #5             // è·å–nameå­—æ®µ
astore_2                // å­˜å‚¨åˆ°nameå˜é‡

aload_1                 // åŠ è½½å¯¹è±¡å¼•ç”¨p  
bipush 30               // åŠ è½½30
putfield #6             // è®¾ç½®ageå­—æ®µ

getstatic #7            // è·å–System.outé™æ€å­—æ®µ
```

### 1.5 æ–¹æ³•è°ƒç”¨æŒ‡ä»¤

**æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ç±»å‹**ï¼š
```java
// Javaä»£ç ç¤ºä¾‹
public class MethodCallExample {
    public void instanceMethod() {}
    public static void staticMethod() {}
    private void privateMethod() {}
    public final void finalMethod() {}
}

interface MyInterface {
    void interfaceMethod();
}

// å¯¹åº”çš„è°ƒç”¨æŒ‡ä»¤ï¼š
obj.instanceMethod();     // invokevirtual (è™šæ–¹æ³•è°ƒç”¨)
MethodCallExample.staticMethod();  // invokestatic (é™æ€æ–¹æ³•è°ƒç”¨)
this.privateMethod();     // invokespecial (ç‰¹æ®Šæ–¹æ³•è°ƒç”¨)
obj.finalMethod();        // invokespecial (finalæ–¹æ³•)
myInterface.interfaceMethod();  // invokeinterface (æ¥å£æ–¹æ³•è°ƒç”¨)

// Java 8+ Lambdaè¡¨è¾¾å¼
Runnable r = () -> {};    // invokedynamic (åŠ¨æ€æ–¹æ³•è°ƒç”¨)
```

**æ–¹æ³•è°ƒç”¨å­—èŠ‚ç åˆ†æ**ï¼š
```java
// Javaä»£ç 
public void testMethodCall() {
    String s = "Hello";
    int len = s.length();
    System.out.println(len);
}

// å¯¹åº”å­—èŠ‚ç 
ldc #2              // åŠ è½½"Hello"
astore_1            // å­˜å‚¨åˆ°s
aload_1             // åŠ è½½s
invokevirtual #3    // è°ƒç”¨String.length()æ–¹æ³•
istore_2            // å­˜å‚¨è¿”å›å€¼åˆ°len
getstatic #4        // è·å–System.out
iload_2             // åŠ è½½len
invokevirtual #5    // è°ƒç”¨PrintStream.println(int)
```

### 1.6 æ§åˆ¶è½¬ç§»æŒ‡ä»¤

**æ¡ä»¶è·³è½¬æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
public void testCondition(int x) {
    if (x > 0) {
        System.out.println("Positive");
    } else {
        System.out.println("Non-positive");
    }
}

// å¯¹åº”å­—èŠ‚ç 
iload_1             // åŠ è½½å‚æ•°x
ifle L1             // å¦‚æœx <= 0ï¼Œè·³è½¬åˆ°L1
getstatic #2        // System.out
ldc #3              // "Positive"
invokevirtual #4    // println
goto L2             // è·³è½¬åˆ°L2
L1:
getstatic #2        // System.out
ldc #5              // "Non-positive"  
invokevirtual #4    // println
L2:
return
```

**å¾ªç¯æŒ‡ä»¤**ï¼š
```java
// Javaä»£ç 
public void testLoop() {
    for (int i = 0; i < 10; i++) {
        System.out.println(i);
    }
}

// å¯¹åº”å­—èŠ‚ç 
iconst_0            // i = 0
istore_1
goto L2             // è·³è½¬åˆ°æ¡ä»¶æ£€æŸ¥
L1:                 // å¾ªç¯ä½“å¼€å§‹
getstatic #2        // System.out
iload_1             // åŠ è½½i
invokevirtual #3    // println(i)
iinc 1, 1           // i++
L2:                 // æ¡ä»¶æ£€æŸ¥
iload_1             // åŠ è½½i
bipush 10           // åŠ è½½10
if_icmplt L1        // å¦‚æœi < 10ï¼Œè·³è½¬åˆ°L1
return
```

---

## ğŸ› ï¸ **2. ASMæ¡†æ¶æ·±åº¦åº”ç”¨**

### 2.1 ASMæ ¸å¿ƒAPI

**ASMè®¿é—®è€…æ¨¡å¼**ï¼š
```java
// ClassVisitor - è®¿é—®ç±»çš„å„ä¸ªéƒ¨åˆ†
public abstract class ClassVisitor {
    public void visit(int version, int access, String name, 
                     String signature, String superName, String[] interfaces);
    public MethodVisitor visitMethod(int access, String name, String desc, 
                                   String signature, String[] exceptions);
    public FieldVisitor visitField(int access, String name, String desc, 
                                 String signature, Object value);
    public void visitEnd();
}

// MethodVisitor - è®¿é—®æ–¹æ³•çš„å„ä¸ªéƒ¨åˆ†
public abstract class MethodVisitor {
    public void visitCode();
    public void visitInsn(int opcode);
    public void visitIntInsn(int opcode, int operand);
    public void visitVarInsn(int opcode, int var);
    public void visitMethodInsn(int opcode, String owner, String name, String desc);
    public void visitMaxs(int maxStack, int maxLocals);
    public void visitEnd();
}
```

### 2.2 å­—èŠ‚ç ç”Ÿæˆç¤ºä¾‹

**åŠ¨æ€ç”Ÿæˆç±»**ï¼š
```java
import org.objectweb.asm.*;
import static org.objectweb.asm.Opcodes.*;

public class DynamicClassGenerator {
    
    public static byte[] generateHelloWorldClass() {
        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
        
        // å®šä¹‰ç±»
        cw.visit(V1_8, ACC_PUBLIC, "HelloWorld", null, "java/lang/Object", null);
        
        // ç”Ÿæˆé»˜è®¤æ„é€ æ–¹æ³•
        MethodVisitor constructor = cw.visitMethod(ACC_PUBLIC, "<init>", "()V", null, null);
        constructor.visitCode();
        constructor.visitVarInsn(ALOAD, 0);  // this
        constructor.visitMethodInsn(INVOKESPECIAL, "java/lang/Object", "<init>", "()V", false);
        constructor.visitInsn(RETURN);
        constructor.visitMaxs(1, 1);
        constructor.visitEnd();
        
        // ç”ŸæˆsayHelloæ–¹æ³•
        MethodVisitor method = cw.visitMethod(ACC_PUBLIC, "sayHello", "()V", null, null);
        method.visitCode();
        method.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
        method.visitLdcInsn("Hello, World!");
        method.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);
        method.visitInsn(RETURN);
        method.visitMaxs(2, 1);
        method.visitEnd();
        
        cw.visitEnd();
        return cw.toByteArray();
    }
    
    public static void main(String[] args) throws Exception {
        byte[] classBytes = generateHelloWorldClass();
        
        // ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½ç”Ÿæˆçš„ç±»
        ClassLoader loader = new ClassLoader() {
            @Override
            protected Class<?> findClass(String name) throws ClassNotFoundException {
                if ("HelloWorld".equals(name)) {
                    return defineClass(name, classBytes, 0, classBytes.length);
                }
                return super.findClass(name);
            }
        };
        
        Class<?> clazz = loader.loadClass("HelloWorld");
        Object instance = clazz.newInstance();
        clazz.getMethod("sayHello").invoke(instance);
    }
}
```

### 2.3 å­—èŠ‚ç ä¿®æ”¹ç¤ºä¾‹

**æ–¹æ³•å¢å¼º - æ·»åŠ æ‰§è¡Œæ—¶é—´ç»Ÿè®¡**ï¼š
```java
public class MethodTimingTransformer extends ClassVisitor {
    
    public MethodTimingTransformer(ClassVisitor cv) {
        super(ASM7, cv);
    }
    
    @Override
    public MethodVisitor visitMethod(int access, String name, String desc, 
                                   String signature, String[] exceptions) {
        MethodVisitor mv = super.visitMethod(access, name, desc, signature, exceptions);
        
        // åªå¢å¼ºpublicæ–¹æ³•ï¼Œæ’é™¤æ„é€ æ–¹æ³•
        if (mv != null && (access & ACC_PUBLIC) != 0 && !"<init>".equals(name)) {
            return new TimingMethodVisitor(mv, name);
        }
        return mv;
    }
    
    private static class TimingMethodVisitor extends MethodVisitor {
        private String methodName;
        
        public TimingMethodVisitor(MethodVisitor mv, String methodName) {
            super(ASM7, mv);
            this.methodName = methodName;
        }
        
        @Override
        public void visitCode() {
            super.visitCode();
            
            // åœ¨æ–¹æ³•å¼€å§‹æ·»åŠ ï¼šlong startTime = System.currentTimeMillis();
            super.visitMethodInsn(INVOKESTATIC, "java/lang/System", 
                                "currentTimeMillis", "()J", false);
            super.visitVarInsn(LSTORE, getFirstAvailableLocal());
        }
        
        @Override
        public void visitInsn(int opcode) {
            // åœ¨returnæŒ‡ä»¤å‰æ·»åŠ æ—¶é—´ç»Ÿè®¡
            if (opcode >= IRETURN && opcode <= RETURN) {
                addTimingCode();
            }
            super.visitInsn(opcode);
        }
        
        private void addTimingCode() {
            // long endTime = System.currentTimeMillis();
            super.visitMethodInsn(INVOKESTATIC, "java/lang/System", 
                                "currentTimeMillis", "()J", false);
            super.visitVarInsn(LSTORE, getFirstAvailableLocal() + 2);
            
            // System.out.println("Method " + methodName + " took: " + (endTime - startTime) + "ms");
            super.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
            super.visitTypeInsn(NEW, "java/lang/StringBuilder");
            super.visitInsn(DUP);
            super.visitMethodInsn(INVOKESPECIAL, "java/lang/StringBuilder", "<init>", "()V", false);
            super.visitLdcInsn("Method " + methodName + " took: ");
            super.visitMethodInsn(INVOKEVIRTUAL, "java/lang/StringBuilder", "append", 
                                "(Ljava/lang/String;)Ljava/lang/StringBuilder;", false);
            super.visitVarInsn(LLOAD, getFirstAvailableLocal() + 2);  // endTime
            super.visitVarInsn(LLOAD, getFirstAvailableLocal());      // startTime
            super.visitInsn(LSUB);
            super.visitMethodInsn(INVOKEVIRTUAL, "java/lang/StringBuilder", "append", 
                                "(J)Ljava/lang/StringBuilder;", false);
            super.visitLdcInsn("ms");
            super.visitMethodInsn(INVOKEVIRTUAL, "java/lang/StringBuilder", "append", 
                                "(Ljava/lang/String;)Ljava/lang/StringBuilder;", false);
            super.visitMethodInsn(INVOKEVIRTUAL, "java/lang/StringBuilder", "toString", 
                                "()Ljava/lang/String;", false);
            super.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", 
                                "(Ljava/lang/String;)V", false);
        }
        
        private int getFirstAvailableLocal() {
            // ç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥è®¡ç®—æ–¹æ³•çš„å±€éƒ¨å˜é‡è¡¨å¤§å°
            return 10;
        }
    }
}
```

### 2.4 åŠ¨æ€ä»£ç†å®ç°

**åŸºäºASMçš„åŠ¨æ€ä»£ç†**ï¼š
```java
public class ASMProxyGenerator {
    
    public static <T> T createProxy(Class<T> interfaceClass, InvocationHandler handler) {
        String proxyClassName = interfaceClass.getName() + "$ASMProxy";
        byte[] proxyBytes = generateProxyClass(interfaceClass, proxyClassName);
        
        // åŠ è½½ä»£ç†ç±»
        ClassLoader loader = new ClassLoader(interfaceClass.getClassLoader()) {
            @Override
            protected Class<?> findClass(String name) throws ClassNotFoundException {
                if (proxyClassName.equals(name)) {
                    return defineClass(name, proxyBytes, 0, proxyBytes.length);
                }
                return super.findClass(name);
            }
        };
        
        try {
            Class<?> proxyClass = loader.loadClass(proxyClassName);
            Constructor<?> constructor = proxyClass.getConstructor(InvocationHandler.class);
            return (T) constructor.newInstance(handler);
        } catch (Exception e) {
            throw new RuntimeException("Failed to create proxy", e);
        }
    }
    
    private static byte[] generateProxyClass(Class<?> interfaceClass, String proxyClassName) {
        ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
        String proxyInternalName = proxyClassName.replace('.', '/');
        String interfaceInternalName = interfaceClass.getName().replace('.', '/');
        
        // å®šä¹‰ä»£ç†ç±»
        cw.visit(V1_8, ACC_PUBLIC, proxyInternalName, null, "java/lang/Object", 
                new String[]{interfaceInternalName});
        
        // æ·»åŠ InvocationHandlerå­—æ®µ
        cw.visitField(ACC_PRIVATE | ACC_FINAL, "handler", 
                     "Ljava/lang/reflect/InvocationHandler;", null, null).visitEnd();
        
        // ç”Ÿæˆæ„é€ æ–¹æ³•
        generateConstructor(cw, proxyInternalName);
        
        // ä¸ºæ¥å£çš„æ¯ä¸ªæ–¹æ³•ç”Ÿæˆä»£ç†å®ç°
        for (Method method : interfaceClass.getMethods()) {
            generateProxyMethod(cw, method, proxyInternalName, interfaceClass);
        }
        
        cw.visitEnd();
        return cw.toByteArray();
    }
    
    private static void generateConstructor(ClassWriter cw, String proxyInternalName) {
        MethodVisitor mv = cw.visitMethod(ACC_PUBLIC, "<init>", 
                                        "(Ljava/lang/reflect/InvocationHandler;)V", null, null);
        mv.visitCode();
        mv.visitVarInsn(ALOAD, 0);  // this
        mv.visitMethodInsn(INVOKESPECIAL, "java/lang/Object", "<init>", "()V", false);
        mv.visitVarInsn(ALOAD, 0);  // this
        mv.visitVarInsn(ALOAD, 1);  // handlerå‚æ•°
        mv.visitFieldInsn(PUTFIELD, proxyInternalName, "handler", 
                         "Ljava/lang/reflect/InvocationHandler;");
        mv.visitInsn(RETURN);
        mv.visitMaxs(2, 2);
        mv.visitEnd();
    }
    
    private static void generateProxyMethod(ClassWriter cw, Method method, 
                                          String proxyInternalName, Class<?> interfaceClass) {
        String methodName = method.getName();
        String methodDesc = Type.getMethodDescriptor(method);
        
        MethodVisitor mv = cw.visitMethod(ACC_PUBLIC, methodName, methodDesc, null, null);
        mv.visitCode();
        
        // è°ƒç”¨handler.invoke(this, method, args)
        mv.visitVarInsn(ALOAD, 0);  // this
        mv.visitFieldInsn(GETFIELD, proxyInternalName, "handler", 
                         "Ljava/lang/reflect/InvocationHandler;");
        mv.visitVarInsn(ALOAD, 0);  // thisä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
        
        // è·å–Methodå¯¹è±¡
        mv.visitLdcInsn(Type.getType(interfaceClass));
        mv.visitLdcInsn(methodName);
        // ... ç”Ÿæˆè·å–Methodå¯¹è±¡çš„ä»£ç 
        
        // åˆ›å»ºå‚æ•°æ•°ç»„
        Class<?>[] paramTypes = method.getParameterTypes();
        mv.visitIntInsn(BIPUSH, paramTypes.length);
        mv.visitTypeInsn(ANEWARRAY, "java/lang/Object");
        
        // å°†å‚æ•°è£…ç®±å¹¶æ”¾å…¥æ•°ç»„
        for (int i = 0; i < paramTypes.length; i++) {
            mv.visitInsn(DUP);
            mv.visitIntInsn(BIPUSH, i);
            mv.visitVarInsn(getLoadOpcode(paramTypes[i]), i + 1);
            if (paramTypes[i].isPrimitive()) {
                // åŸºæœ¬ç±»å‹è£…ç®±
                boxPrimitive(mv, paramTypes[i]);
            }
            mv.visitInsn(AASTORE);
        }
        
        // è°ƒç”¨handler.invoke
        mv.visitMethodInsn(INVOKEINTERFACE, "java/lang/reflect/InvocationHandler", 
                          "invoke", "(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object;", true);
        
        // å¤„ç†è¿”å›å€¼
        Class<?> returnType = method.getReturnType();
        if (returnType == void.class) {
            mv.visitInsn(POP);
            mv.visitInsn(RETURN);
        } else {
            if (returnType.isPrimitive()) {
                unboxPrimitive(mv, returnType);
            } else {
                mv.visitTypeInsn(CHECKCAST, Type.getInternalName(returnType));
            }
            mv.visitInsn(getReturnOpcode(returnType));
        }
        
        mv.visitMaxs(0, 0);  // ASMä¼šè‡ªåŠ¨è®¡ç®—
        mv.visitEnd();
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šè·å–åŠ è½½æŒ‡ä»¤
    private static int getLoadOpcode(Class<?> type) {
        if (type == int.class || type == boolean.class || type == byte.class || 
            type == char.class || type == short.class) {
            return ILOAD;
        } else if (type == long.class) {
            return LLOAD;
        } else if (type == float.class) {
            return FLOAD;
        } else if (type == double.class) {
            return DLOAD;
        } else {
            return ALOAD;
        }
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šè·å–è¿”å›æŒ‡ä»¤
    private static int getReturnOpcode(Class<?> type) {
        if (type == int.class || type == boolean.class || type == byte.class || 
            type == char.class || type == short.class) {
            return IRETURN;
        } else if (type == long.class) {
            return LRETURN;
        } else if (type == float.class) {
            return FRETURN;
        } else if (type == double.class) {
            return DRETURN;
        } else {
            return ARETURN;
        }
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šåŸºæœ¬ç±»å‹è£…ç®±
    private static void boxPrimitive(MethodVisitor mv, Class<?> primitiveType) {
        if (primitiveType == int.class) {
            mv.visitMethodInsn(INVOKESTATIC, "java/lang/Integer", "valueOf", "(I)Ljava/lang/Integer;", false);
        } else if (primitiveType == long.class) {
            mv.visitMethodInsn(INVOKESTATIC, "java/lang/Long", "valueOf", "(J)Ljava/lang/Long;", false);
        }
        // ... å…¶ä»–åŸºæœ¬ç±»å‹çš„è£…ç®±
    }
    
    // è¾…åŠ©æ–¹æ³•ï¼šåŸºæœ¬ç±»å‹æ‹†ç®±
    private static void unboxPrimitive(MethodVisitor mv, Class<?> primitiveType) {
        if (primitiveType == int.class) {
            mv.visitTypeInsn(CHECKCAST, "java/lang/Integer");
            mv.visitMethodInsn(INVOKEVIRTUAL, "java/lang/Integer", "intValue", "()I", false);
        } else if (primitiveType == long.class) {
            mv.visitTypeInsn(CHECKCAST, "java/lang/Long");
            mv.visitMethodInsn(INVOKEVIRTUAL, "java/lang/Long", "longValue", "()J", false);
        }
        // ... å…¶ä»–åŸºæœ¬ç±»å‹çš„æ‹†ç®±
    }
}
```

---

## ğŸª **3. é¢è¯•å®æˆ˜é—®ç­”**

### Q1: "åŠ¨æ€ä»£ç†å¦‚ä½•å®ç°ï¼Ÿ"

**JDKåŠ¨æ€ä»£ç† vs CGLibå¯¹æ¯”**ï¼š
```java
// JDKåŠ¨æ€ä»£ç† - åŸºäºæ¥å£
interface UserService {
    void save(User user);
}

UserService proxy = (UserService) Proxy.newProxyInstance(
    UserService.class.getClassLoader(),
    new Class[]{UserService.class},
    new InvocationHandler() {
        public Object invoke(Object proxy, Method method, Object[] args) {
            System.out.println("Before " + method.getName());
            Object result = method.invoke(target, args);
            System.out.println("After " + method.getName());
            return result;
        }
    }
);

// CGLibåŠ¨æ€ä»£ç† - åŸºäºç»§æ‰¿
public class UserServiceImpl {
    public void save(User user) {
        // å®ç°
    }
}

Enhancer enhancer = new Enhancer();
enhancer.setSuperclass(UserServiceImpl.class);
enhancer.setCallback(new MethodInterceptor() {
    public Object intercept(Object obj, Method method, Object[] args, MethodProxy proxy) {
        System.out.println("Before " + method.getName());
        Object result = proxy.invokeSuper(obj, args);
        System.out.println("After " + method.getName());
        return result;
    }
});
UserServiceImpl proxy = (UserServiceImpl) enhancer.create();
```

**åº•å±‚å®ç°åŸç†**ï¼š
- JDKåŠ¨æ€ä»£ç†ï¼šç”Ÿæˆå®ç°æ¥å£çš„ä»£ç†ç±»ï¼Œé€šè¿‡InvocationHandleråˆ†å‘è°ƒç”¨
- CGLibï¼šç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼Œé‡å†™æ–¹æ³•æ·»åŠ å¢å¼ºé€»è¾‘
- ASMï¼šç›´æ¥æ“ä½œå­—èŠ‚ç ï¼Œæ€§èƒ½æœ€é«˜ä½†å¤æ‚åº¦æœ€å¤§

### Q2: "å­—èŠ‚ç å¢å¼ºåœ¨å“ªäº›æ¡†æ¶ä¸­ä½¿ç”¨ï¼Ÿ"

**åº”ç”¨åœºæ™¯**ï¼š
1. **Spring AOP**ï¼šä½¿ç”¨CGLibæˆ–JDKåŠ¨æ€ä»£ç†å®ç°åˆ‡é¢
2. **MyBatis**ï¼šä½¿ç”¨åŠ¨æ€ä»£ç†ç”ŸæˆMapperæ¥å£å®ç°
3. **Hibernate**ï¼šä½¿ç”¨å­—èŠ‚ç å¢å¼ºå®ç°å»¶è¿ŸåŠ è½½
4. **APMå·¥å…·**ï¼šå¦‚SkyWalkingä½¿ç”¨å­—èŠ‚ç å¢å¼ºè¿›è¡Œé“¾è·¯è¿½è¸ª
5. **Mockæ¡†æ¶**ï¼šå¦‚Mockitoä½¿ç”¨å­—èŠ‚ç ç”ŸæˆMockå¯¹è±¡

**Spring AOPå®ç°åŸç†**ï¼š
```java
// Spring AOPçš„ä»£ç†åˆ›å»ºè¿‡ç¨‹
public class DefaultAopProxyFactory implements AopProxyFactory {
    
    public AopProxy createAopProxy(AdvisedSupport config) {
        if (config.isOptimize() || config.isProxyTargetClass() || 
            hasNoUserSuppliedProxyInterfaces(config)) {
            // ä½¿ç”¨CGLibä»£ç†
            return new CglibAopProxy(config);
        } else {
            // ä½¿ç”¨JDKåŠ¨æ€ä»£ç†
            return new JdkDynamicAopProxy(config);
        }
    }
}
```

### Q3: "å¦‚ä½•åˆ†æå­—èŠ‚ç ï¼Ÿ"

**åˆ†æå·¥å…·**ï¼š
1. **javap**ï¼šJDKè‡ªå¸¦çš„åæ±‡ç¼–å·¥å…·
2. **ASM Bytecode Viewer**ï¼šå¯è§†åŒ–å­—èŠ‚ç åˆ†æ
3. **JClassLib**ï¼šå­—èŠ‚ç æŸ¥çœ‹å™¨
4. **IDEAæ’ä»¶**ï¼šASM Bytecode Viewer Plugin

**javapä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# ç¼–è¯‘Javaæ–‡ä»¶
javac Example.java

# æŸ¥çœ‹å­—èŠ‚ç 
javap -c Example

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
javap -c -v Example

# æŸ¥çœ‹ç§æœ‰æˆå‘˜
javap -c -p Example
```

### Q4: "å­—èŠ‚ç ä¼˜åŒ–æœ‰å“ªäº›æŠ€æœ¯ï¼Ÿ"

**ç¼–è¯‘å™¨ä¼˜åŒ–**ï¼š
1. **å¸¸é‡æŠ˜å **ï¼šç¼–è¯‘æ—¶è®¡ç®—å¸¸é‡è¡¨è¾¾å¼
2. **æ­»ä»£ç æ¶ˆé™¤**ï¼šç§»é™¤æ°¸è¿œä¸ä¼šæ‰§è¡Œçš„ä»£ç 
3. **å†…è”ä¼˜åŒ–**ï¼šå°†æ–¹æ³•è°ƒç”¨æ›¿æ¢ä¸ºæ–¹æ³•ä½“
4. **å¾ªç¯ä¼˜åŒ–**ï¼šå¾ªç¯å±•å¼€ã€å¾ªç¯ä¸å˜é‡å¤–æ

**JITä¼˜åŒ–**ï¼š
1. **æ–¹æ³•å†…è”**ï¼šæ¶ˆé™¤æ–¹æ³•è°ƒç”¨å¼€é”€
2. **é€ƒé€¸åˆ†æ**ï¼šæ ˆä¸Šåˆ†é…ã€é”æ¶ˆé™¤ã€æ ‡é‡æ›¿æ¢
3. **å¾ªç¯ä¼˜åŒ–**ï¼šå¾ªç¯å±•å¼€ã€å‘é‡åŒ–
4. **åˆ†æ”¯é¢„æµ‹**ï¼šä¼˜åŒ–æ¡ä»¶è·³è½¬

---

## ğŸš€ **4. å­—èŠ‚ç åº”ç”¨å®æˆ˜**

### 4.1 æ€§èƒ½ç›‘æ§ä»£ç†

```java
// ä½¿ç”¨ASMå®ç°æ–¹æ³•æ‰§è¡Œæ—¶é—´ç›‘æ§
public class PerformanceMonitorAgent {
    
    public static void premain(String agentArgs, Instrumentation inst) {
        inst.addTransformer(new PerformanceTransformer());
    }
    
    private static class PerformanceTransformer implements ClassFileTransformer {
        
        public byte[] transform(ClassLoader loader, String className, 
                              Class<?> classBeingRedefined, ProtectionDomain protectionDomain, 
                              byte[] classfileBuffer) {
            
            if (className.startsWith("com/example/")) {
                ClassReader cr = new ClassReader(classfileBuffer);
                ClassWriter cw = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
                ClassVisitor cv = new PerformanceClassVisitor(cw);
                cr.accept(cv, ClassReader.EXPAND_FRAMES);
                return cw.toByteArray();
            }
            return classfileBuffer;
        }
    }
}
```

### 4.2 ç¼“å­˜ä»£ç†ç”Ÿæˆ

```java
// è‡ªåŠ¨ç”Ÿæˆç¼“å­˜ä»£ç†
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface Cacheable {
    String key() default "";
    int expireSeconds() default 300;
}

public class CacheProxyGenerator {
    
    public static <T> T createCacheProxy(T target, Class<T> interfaceClass) {
        return ASMProxyGenerator.createProxy(interfaceClass, new CacheInvocationHandler(target));
    }
    
    private static class CacheInvocationHandler implements InvocationHandler {
        private final Object target;
        private final Map<String, CacheEntry> cache = new ConcurrentHashMap<>();
        
        public CacheInvocationHandler(Object target) {
            this.target = target;
        }
        
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            Cacheable cacheable = method.getAnnotation(Cacheable.class);
            if (cacheable != null) {
                String cacheKey = generateCacheKey(method, args, cacheable.key());
                CacheEntry entry = cache.get(cacheKey);
                
                if (entry != null && !entry.isExpired()) {
                    return entry.getValue();
                }
                
                Object result = method.invoke(target, args);
                cache.put(cacheKey, new CacheEntry(result, cacheable.expireSeconds()));
                return result;
            }
            
            return method.invoke(target, args);
        }
        
        private String generateCacheKey(Method method, Object[] args, String keyTemplate) {
            if (keyTemplate.isEmpty()) {
                return method.getName() + ":" + Arrays.toString(args);
            }
            // è§£ækeyæ¨¡æ¿ï¼Œæ”¯æŒSpELè¡¨è¾¾å¼
            return keyTemplate;
        }
    }
    
    private static class CacheEntry {
        private final Object value;
        private final long expireTime;
        
        public CacheEntry(Object value, int expireSeconds) {
            this.value = value;
            this.expireTime = System.currentTimeMillis() + expireSeconds * 1000L;
        }
        
        public boolean isExpired() {
            return System.currentTimeMillis() > expireTime;
        }
        
        public Object getValue() {
            return value;
        }
    }
}
```

---

## ğŸ“Š **5. æ€»ç»“**

### 5.1 å­—èŠ‚ç çŸ¥è¯†ä½“ç³»

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- JVMæŒ‡ä»¤é›†åˆ†ç±»å’Œæ‰§è¡ŒåŸç†
- æ“ä½œæ•°æ ˆå’Œå±€éƒ¨å˜é‡è¡¨æ“ä½œ
- æ–¹æ³•è°ƒç”¨å’Œå¯¹è±¡æ“ä½œæœºåˆ¶
- æ§åˆ¶æµå’Œå¼‚å¸¸å¤„ç†

**å®ç”¨æŠ€èƒ½**ï¼š
- ASMæ¡†æ¶çš„ä½¿ç”¨æ–¹æ³•
- åŠ¨æ€ä»£ç†çš„å®ç°åŸç†
- å­—èŠ‚ç å¢å¼ºæŠ€æœ¯åº”ç”¨
- æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§å®ç°

### 5.2 é¢è¯•æ ¸å¿ƒè¦ç‚¹

**å¿…é¡»æŒæ¡çš„çŸ¥è¯†**ï¼š
- å¸¸ç”¨å­—èŠ‚ç æŒ‡ä»¤çš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯
- JDKåŠ¨æ€ä»£ç† vs CGLibçš„åŒºåˆ«å’Œé€‰æ‹©
- ASMæ¡†æ¶çš„æ ¸å¿ƒAPIå’Œä½¿ç”¨æ–¹æ³•
- å­—èŠ‚ç å¢å¼ºåœ¨ä¸»æµæ¡†æ¶ä¸­çš„åº”ç”¨

**åŠ åˆ†é¡¹**ï¼š
- èƒ½å¤Ÿæ‰‹å†™ç®€å•çš„å­—èŠ‚ç ç”Ÿæˆä»£ç 
- ç†è§£JITç¼–è¯‘å™¨çš„ä¼˜åŒ–ç­–ç•¥
- ç†Ÿæ‚‰å­—èŠ‚ç åˆ†æå·¥å…·çš„ä½¿ç”¨
- æœ‰å®é™…çš„å­—èŠ‚ç å¢å¼ºé¡¹ç›®ç»éªŒ

---

**æ€»ç»“**ï¼šæŒæ¡å­—èŠ‚ç å’ŒASMæŠ€æœ¯ï¼Œä½ å°±èƒ½åœ¨é¢è¯•ä¸­å±•ç°å‡ºçœŸæ­£çš„JVMåº•å±‚ä¸“å®¶æ°´å¹³ï¼Œä¸ä»…èƒ½å›ç­”ç†è®ºé—®é¢˜ï¼Œè¿˜èƒ½æä¾›å®é™…çš„ä»£ç å®ç°å’Œåº”ç”¨æ¡ˆä¾‹ã€‚è¿™äº›æŠ€èƒ½åœ¨é«˜çº§Javaå¼€å‘å’Œæ¡†æ¶è®¾è®¡ä¸­éƒ½æœ‰é‡è¦åº”ç”¨ä»·å€¼ã€‚