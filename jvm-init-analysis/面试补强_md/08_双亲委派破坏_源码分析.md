# åŒäº²å§”æ´¾ç ´åæœºåˆ¶ - OpenJDK 11æºç åˆ†æ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºOpenJDK 11æºç ï¼Œæ·±åº¦åˆ†æåŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°åŸç†ã€ç ´ååœºæ™¯å’Œè§£å†³æ–¹æ¡ˆï¼Œæä¾›é¢è¯•å¿…å¤‡çš„ç±»åŠ è½½é«˜çº§çŸ¥è¯†ã€‚

## ğŸ¯ é¢è¯•æ ¸å¿ƒè¦ç‚¹

### **é¢è¯•å®˜å¸¸é—®é—®é¢˜**
1. "å¦‚ä½•å®ç°çƒ­éƒ¨ç½²ï¼ŸåŒäº²å§”æ´¾ä»€ä¹ˆæ—¶å€™ä¼šè¢«ç ´åï¼Ÿ"
2. "Tomcatçš„ç±»åŠ è½½æœºåˆ¶æ˜¯æ€æ ·çš„ï¼Ÿ"
3. "OSGiå¦‚ä½•å®ç°æ¨¡å—åŒ–ç±»åŠ è½½ï¼Ÿ"
4. "SPIæœºåˆ¶å¦‚ä½•ç ´ååŒäº²å§”æ´¾ï¼Ÿ"

---

## ğŸ” **1. åŒäº²å§”æ´¾æ¨¡å‹æºç åˆ†æ**

### 1.1 ClassLoader.loadClass()å®ç°

```java
// æ–‡ä»¶ï¼šjava.base/java/lang/ClassLoader.java
// åŒäº²å§”æ´¾çš„æ ¸å¿ƒå®ç°

protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        // 1. æ£€æŸ¥ç±»æ˜¯å¦å·²ç»åŠ è½½
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            long t0 = System.nanoTime();
            try {
                // 2. å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨
                if (parent != null) {
                    c = parent.loadClass(name, false);
                } else {
                    // 3. çˆ¶ç±»ä¸ºnullï¼Œå§”æ´¾ç»™Bootstrap ClassLoader
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // çˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½ï¼Œç»§ç»­æ‰§è¡Œ
            }

            if (c == null) {
                // 4. çˆ¶ç±»æ— æ³•åŠ è½½ï¼Œè‡ªå·±å°è¯•åŠ è½½
                long t1 = System.nanoTime();
                c = findClass(name);

                // ç»Ÿè®¡ä¿¡æ¯
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            resolveClass(c);
        }
        return c;
    }
}
```

### 1.2 SystemDictionaryä¸­çš„ç±»åŠ è½½

```cpp
// æ–‡ä»¶ï¼šsrc/hotspot/share/classfile/systemDictionary.cpp
// JVMå±‚é¢çš„ç±»åŠ è½½å®ç°

Klass* SystemDictionary::resolve_or_fail(Symbol* class_name,
                                         Handle class_loader,
                                         Handle protection_domain,
                                         bool throw_error,
                                         TRAPS) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
  Klass* klass = find(class_name, class_loader, protection_domain, THREAD);
  
  if (klass != NULL) {
    return klass;
  }
  
  // 2. å°è¯•åŠ è½½ç±»
  return resolve_instance_class_or_null(class_name, class_loader, 
                                       protection_domain, THREAD);
}

Klass* SystemDictionary::resolve_instance_class_or_null(Symbol* name,
                                                        Handle class_loader,
                                                        Handle protection_domain,
                                                        TRAPS) {
  // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿç±»
  if (class_loader.is_null()) {
    // Bootstrapç±»åŠ è½½å™¨å¤„ç†
    return resolve_bootstrap_class(name, THREAD);
  }
  
  // è°ƒç”¨Javaå±‚çš„ClassLoader.loadClass()
  return resolve_from_stream(name, class_loader, protection_domain, 
                           NULL, false, THREAD);
}
```

### 1.3 ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„

```cpp
// JVMä¸­çš„ç±»åŠ è½½å™¨å±‚æ¬¡
// Bootstrap ClassLoader (C++å®ç°)
//   â””â”€â”€ Platform ClassLoader (ExtClassLoader)
//       â””â”€â”€ Application ClassLoader (AppClassLoader)
//           â””â”€â”€ Custom ClassLoader

// æºç ä¸­çš„ç±»åŠ è½½å™¨æ£€æŸ¥
bool SystemDictionary::is_system_class_loader(oop class_loader) {
  return (class_loader == _java_system_loader);
}

bool SystemDictionary::is_platform_class_loader(oop class_loader) {
  return (class_loader == _java_platform_loader);
}
```

**GDBéªŒè¯ - åŒäº²å§”æ´¾è¿‡ç¨‹**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•ç±»
cat > ClassLoadTest.java << 'EOF'
public class ClassLoadTest {
    public static void main(String[] args) throws Exception {
        // è§¦å‘ç±»åŠ è½½
        Class<?> clazz = Class.forName("java.util.HashMap");
        System.out.println("Loaded: " + clazz.getName());
        System.out.println("ClassLoader: " + clazz.getClassLoader());
    }
}
EOF

javac ClassLoadTest.java
gdb --args java ClassLoadTest

(gdb) b SystemDictionary::resolve_or_fail
(gdb) run
# è§‚å¯Ÿç±»åŠ è½½çš„å®Œæ•´è¿‡ç¨‹
(gdb) p class_name->as_C_string()
# è¾“å‡ºï¼šjava/util/HashMap
```

---

## ğŸš« **2. åŒäº²å§”æ´¾ç ´ååœºæ™¯åˆ†æ**

### 2.1 SPIæœºåˆ¶ç ´ååŒäº²å§”æ´¾

**é—®é¢˜åœºæ™¯**ï¼š
- Bootstrap ClassLoaderåŠ è½½java.sql.DriverManager
- DriverManageréœ€è¦åŠ è½½å…·ä½“çš„æ•°æ®åº“é©±åŠ¨(å¦‚MySQLé©±åŠ¨)
- MySQLé©±åŠ¨åœ¨åº”ç”¨ç±»è·¯å¾„ä¸­ï¼ŒBootstrap ClassLoaderæ— æ³•è®¿é—®

**è§£å†³æ–¹æ¡ˆ - çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨**ï¼š
```java
// æ–‡ä»¶ï¼šjava.base/java/sql/DriverManager.java
// SPIæœºåˆ¶çš„å®ç°

public class DriverManager {
    static {
        loadInitialDrivers();
    }
    
    private static void loadInitialDrivers() {
        // ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
        AccessController.doPrivileged(new PrivilegedAction<Void>() {
            public Void run() {
                ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator<Driver> driversIterator = loadedDrivers.iterator();
                
                try {
                    while(driversIterator.hasNext()) {
                        driversIterator.next();
                    }
                } catch(Throwable t) {
                    // å¿½ç•¥å¼‚å¸¸
                }
                return null;
            }
        });
    }
}

// ServiceLoaderä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
public static <S> ServiceLoader<S> load(Class<S> service) {
    ClassLoader cl = Thread.currentThread().getContextClassLoader();
    return ServiceLoader.load(service, cl);
}
```

### 2.2 Tomcatç±»åŠ è½½æœºåˆ¶

**Tomcatç±»åŠ è½½å™¨å±‚æ¬¡**ï¼š
```
Bootstrap ClassLoader
    â””â”€â”€ System ClassLoader  
        â””â”€â”€ Common ClassLoader
            â”œâ”€â”€ Catalina ClassLoader (Tomcatå†…éƒ¨ç±»)
            â”œâ”€â”€ Shared ClassLoader (å…±äº«ç±»)
            â””â”€â”€ WebApp ClassLoader (Webåº”ç”¨ç±»)
                â””â”€â”€ Jsp ClassLoader (JSPç±»)
```

**WebAppClassLoaderç ´ååŒäº²å§”æ´¾**ï¼š
```java
// Tomcatçš„WebappClassLoaderå®ç°
public Class<?> loadClass(String name, boolean resolve) throws ClassNotFoundException {
    synchronized (getClassLoadingLock(name)) {
        Class<?> clazz = null;
        
        // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
        clazz = findLoadedClass0(name);
        if (clazz != null) {
            if (resolve) resolveClass(clazz);
            return clazz;
        }
        
        // 2. æ£€æŸ¥ç³»ç»Ÿç±»ç¼“å­˜
        clazz = findLoadedClass(name);
        if (clazz != null) {
            if (resolve) resolveClass(clazz);
            return clazz;
        }
        
        // 3. ç³»ç»Ÿç±»å§”æ´¾ç»™ç³»ç»Ÿç±»åŠ è½½å™¨
        String resourceName = binaryNameToPath(name, false);
        ClassLoader javaseLoader = getJavaseClassLoader();
        boolean tryLoadingFromJavaseLoader;
        try {
            URL url;
            if (securityManager != null) {
                PrivilegedAction<URL> dp = new PrivilegedJavaseGetResource(resourceName);
                url = AccessController.doPrivileged(dp);
            } else {
                url = javaseLoader.getResource(resourceName);
            }
            tryLoadingFromJavaseLoader = (url != null);
        } catch (Throwable t) {
            tryLoadingFromJavaseLoader = true;
        }
        
        if (tryLoadingFromJavaseLoader) {
            try {
                clazz = javaseLoader.loadClass(name);
                if (clazz != null) {
                    if (resolve) resolveClass(clazz);
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // å¿½ç•¥
            }
        }
        
        // 4. å…ˆå°è¯•è‡ªå·±åŠ è½½ (ç ´ååŒäº²å§”æ´¾)
        if (delegate || filter(name, true)) {
            // å§”æ´¾æ¨¡å¼æˆ–è¿‡æ»¤ç±»ï¼Œä½¿ç”¨æ ‡å‡†åŒäº²å§”æ´¾
            try {
                clazz = Class.forName(name, false, parent);
                if (clazz != null) {
                    if (resolve) resolveClass(clazz);
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // å¿½ç•¥
            }
        }
        
        // 5. è‡ªå·±åŠ è½½
        try {
            clazz = findClass(name);
            if (clazz != null) {
                if (resolve) resolveClass(clazz);
                return clazz;
            }
        } catch (ClassNotFoundException e) {
            // å¿½ç•¥
        }
        
        // 6. æœ€åå§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨
        if (!delegate && !filter(name, false)) {
            try {
                clazz = Class.forName(name, false, parent);
                if (clazz != null) {
                    if (resolve) resolveClass(clazz);
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // å¿½ç•¥
            }
        }
        
        throw new ClassNotFoundException(name);
    }
}
```

### 2.3 OSGiæ¨¡å—åŒ–ç±»åŠ è½½

**OSGiç±»åŠ è½½ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªBundleæœ‰ç‹¬ç«‹çš„ç±»åŠ è½½å™¨
- æ”¯æŒç±»çš„ç‰ˆæœ¬ç®¡ç†å’Œå¹¶è¡ŒåŠ è½½
- å®Œå…¨ç ´ååŒäº²å§”æ´¾ï¼Œä½¿ç”¨ç½‘çŠ¶ç»“æ„

```java
// OSGi Bundleç±»åŠ è½½å™¨ç¤ºä¾‹
public class BundleClassLoader extends ClassLoader {
    private Bundle bundle;
    private BundleWiring bundleWiring;
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
            throws ClassNotFoundException {
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        Class<?> clazz = findLoadedClass(name);
        if (clazz != null) {
            return clazz;
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿç±»
        if (isSystemClass(name)) {
            return getSystemClassLoader().loadClass(name);
        }
        
        // 3. æ£€æŸ¥Import-Package
        BundleWire wire = findImportWire(name);
        if (wire != null) {
            return wire.getProviderWiring().getClassLoader().loadClass(name);
        }
        
        // 4. æ£€æŸ¥Require-Bundle
        for (BundleWire requireWire : getRequireWires()) {
            try {
                return requireWire.getProviderWiring().getClassLoader().loadClass(name);
            } catch (ClassNotFoundException e) {
                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
            }
        }
        
        // 5. ä»è‡ªå·±çš„Bundleä¸­åŠ è½½
        return findClass(name);
    }
}
```

---

## ğŸ”§ **3. è‡ªå®šä¹‰ç±»åŠ è½½å™¨å®ç°**

### 3.1 çƒ­éƒ¨ç½²ç±»åŠ è½½å™¨

```java
// æ”¯æŒçƒ­éƒ¨ç½²çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨
public class HotSwapClassLoader extends ClassLoader {
    private String classPath;
    private Set<String> loadedClasses;
    
    public HotSwapClassLoader(String classPath) {
        super(null); // ä¸è®¾ç½®çˆ¶ç±»åŠ è½½å™¨ï¼Œå®Œå…¨è‡ªä¸»åŠ è½½
        this.classPath = classPath;
        this.loadedClasses = new HashSet<>();
    }
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
            throws ClassNotFoundException {
        // 1. ç³»ç»Ÿç±»å§”æ´¾ç»™ç³»ç»Ÿç±»åŠ è½½å™¨
        if (name.startsWith("java.") || name.startsWith("javax.") || 
            name.startsWith("sun.") || name.startsWith("com.sun.")) {
            return getSystemClassLoader().loadClass(name);
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        Class<?> clazz = findLoadedClass(name);
        if (clazz != null) {
            return clazz;
        }
        
        // 3. è‡ªå·±åŠ è½½åº”ç”¨ç±»
        try {
            clazz = findClass(name);
            loadedClasses.add(name);
            if (resolve) {
                resolveClass(clazz);
            }
            return clazz;
        } catch (ClassNotFoundException e) {
            // 4. æœ€åå§”æ´¾ç»™ç³»ç»Ÿç±»åŠ è½½å™¨
            return getSystemClassLoader().loadClass(name);
        }
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            String fileName = name.replace('.', '/') + ".class";
            Path classFile = Paths.get(classPath, fileName);
            byte[] classData = Files.readAllBytes(classFile);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException("Could not load class " + name, e);
        }
    }
    
    // çƒ­éƒ¨ç½²ï¼šé‡æ–°åŠ è½½æŒ‡å®šç±»
    public Class<?> reloadClass(String name) throws ClassNotFoundException {
        loadedClasses.remove(name);
        return loadClass(name);
    }
}
```

### 3.2 ç½‘ç»œç±»åŠ è½½å™¨

```java
// ä»ç½‘ç»œåŠ è½½ç±»çš„ç±»åŠ è½½å™¨
public class NetworkClassLoader extends ClassLoader {
    private String baseUrl;
    private Map<String, Class<?>> classCache;
    
    public NetworkClassLoader(String baseUrl) {
        super();
        this.baseUrl = baseUrl;
        this.classCache = new ConcurrentHashMap<>();
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // æ£€æŸ¥ç¼“å­˜
        Class<?> clazz = classCache.get(name);
        if (clazz != null) {
            return clazz;
        }
        
        try {
            // ä»ç½‘ç»œä¸‹è½½ç±»æ–‡ä»¶
            String classUrl = baseUrl + "/" + name.replace('.', '/') + ".class";
            byte[] classData = downloadClass(classUrl);
            
            // å®šä¹‰ç±»
            clazz = defineClass(name, classData, 0, classData.length);
            classCache.put(name, clazz);
            return clazz;
        } catch (Exception e) {
            throw new ClassNotFoundException("Could not load class from network: " + name, e);
        }
    }
    
    private byte[] downloadClass(String url) throws IOException {
        try (InputStream in = new URL(url).openStream();
             ByteArrayOutputStream out = new ByteArrayOutputStream()) {
            byte[] buffer = new byte[4096];
            int bytesRead;
            while ((bytesRead = in.read(buffer)) != -1) {
                out.write(buffer, 0, bytesRead);
            }
            return out.toByteArray();
        }
    }
}
```

### 3.3 åŠ å¯†ç±»åŠ è½½å™¨

```java
// æ”¯æŒåŠ å¯†ç±»æ–‡ä»¶çš„ç±»åŠ è½½å™¨
public class EncryptedClassLoader extends ClassLoader {
    private String classPath;
    private String secretKey;
    
    public EncryptedClassLoader(String classPath, String secretKey) {
        super();
        this.classPath = classPath;
        this.secretKey = secretKey;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            String fileName = name.replace('.', '/') + ".class";
            Path classFile = Paths.get(classPath, fileName);
            
            // è¯»å–åŠ å¯†çš„ç±»æ–‡ä»¶
            byte[] encryptedData = Files.readAllBytes(classFile);
            
            // è§£å¯†ç±»æ–‡ä»¶
            byte[] classData = decrypt(encryptedData, secretKey);
            
            // å®šä¹‰ç±»
            return defineClass(name, classData, 0, classData.length);
        } catch (Exception e) {
            throw new ClassNotFoundException("Could not load encrypted class " + name, e);
        }
    }
    
    private byte[] decrypt(byte[] encryptedData, String key) {
        // ç®€å•çš„XORè§£å¯†ç¤ºä¾‹
        byte[] keyBytes = key.getBytes();
        byte[] decrypted = new byte[encryptedData.length];
        
        for (int i = 0; i < encryptedData.length; i++) {
            decrypted[i] = (byte) (encryptedData[i] ^ keyBytes[i % keyBytes.length]);
        }
        
        return decrypted;
    }
}
```

---

## ğŸ” **4. ç±»åŠ è½½å™¨éš”ç¦»æœºåˆ¶**

### 4.1 ç±»åŠ è½½å™¨å‘½åç©ºé—´

```java
// æ¼”ç¤ºç±»åŠ è½½å™¨éš”ç¦»
public class ClassLoaderIsolationDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºä¸¤ä¸ªä¸åŒçš„ç±»åŠ è½½å™¨
        HotSwapClassLoader loader1 = new HotSwapClassLoader("/path/to/classes1");
        HotSwapClassLoader loader2 = new HotSwapClassLoader("/path/to/classes2");
        
        // åŠ è½½ç›¸åŒåç§°çš„ç±»
        Class<?> class1 = loader1.loadClass("com.example.MyClass");
        Class<?> class2 = loader2.loadClass("com.example.MyClass");
        
        // éªŒè¯ç±»éš”ç¦»
        System.out.println("Same class name: " + class1.getName().equals(class2.getName()));
        System.out.println("Same class object: " + (class1 == class2));
        System.out.println("Same class loader: " + (class1.getClassLoader() == class2.getClassLoader()));
        
        // åˆ›å»ºå®ä¾‹
        Object instance1 = class1.newInstance();
        Object instance2 = class2.newInstance();
        
        // ç±»å‹æ£€æŸ¥
        System.out.println("instance1 instanceof class1: " + class1.isInstance(instance1));
        System.out.println("instance1 instanceof class2: " + class2.isInstance(instance1));
        System.out.println("instance2 instanceof class1: " + class1.isInstance(instance2));
    }
}
```

### 4.2 ç±»å¸è½½æœºåˆ¶

```java
// æ¼”ç¤ºç±»å¸è½½
public class ClassUnloadingDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºç±»åŠ è½½å™¨å¹¶åŠ è½½ç±»
        HotSwapClassLoader loader = new HotSwapClassLoader("/path/to/classes");
        Class<?> clazz = loader.loadClass("com.example.MyClass");
        Object instance = clazz.newInstance();
        
        System.out.println("Class loaded: " + clazz.getName());
        System.out.println("ClassLoader: " + clazz.getClassLoader());
        
        // æ¸…é™¤å¼•ç”¨
        clazz = null;
        instance = null;
        loader = null;
        
        // å¼ºåˆ¶åƒåœ¾å›æ”¶
        System.gc();
        System.gc();
        
        // ç­‰å¾…ç±»å¸è½½
        Thread.sleep(1000);
        
        System.out.println("References cleared, class should be unloaded");
    }
}
```

**ç±»å¸è½½æ¡ä»¶**ï¼š
1. è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹éƒ½è¢«å›æ”¶
2. åŠ è½½è¯¥ç±»çš„ClassLoaderè¢«å›æ”¶
3. è¯¥ç±»çš„Classå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨
4. æ²¡æœ‰é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•

---

## ğŸª **5. é¢è¯•å®æˆ˜é—®ç­”**

### Q1: "Tomcatå¦‚ä½•å®ç°åº”ç”¨éš”ç¦»ï¼Ÿ"

**æŠ€æœ¯å›ç­”**ï¼š
1. **ç‹¬ç«‹ç±»åŠ è½½å™¨**ï¼šæ¯ä¸ªWebåº”ç”¨æœ‰ç‹¬ç«‹çš„WebAppClassLoader
2. **ç ´ååŒäº²å§”æ´¾**ï¼šä¼˜å…ˆåŠ è½½åº”ç”¨ç±»ï¼Œé¿å…ç‰ˆæœ¬å†²çª
3. **å…±äº«æœºåˆ¶**ï¼šCommon ClassLoaderåŠ è½½å…±äº«ç±»åº“
4. **çƒ­éƒ¨ç½²**ï¼šé‡æ–°åˆ›å»ºç±»åŠ è½½å™¨å®ç°åº”ç”¨é‡æ–°éƒ¨ç½²

**æ·±åº¦åˆ†æ**ï¼š
- "WebAppClassLoaderå…ˆå°è¯•è‡ªå·±åŠ è½½ï¼Œå†å§”æ´¾ç»™çˆ¶ç±»"
- "é€šè¿‡ç±»åŠ è½½å™¨éš”ç¦»å®ç°ä¸åŒç‰ˆæœ¬jaråŒ…å…±å­˜"
- "JSPç±»åŠ è½½å™¨æ”¯æŒJSPæ–‡ä»¶çš„çƒ­æ›´æ–°"

### Q2: "å¦‚ä½•å®ç°çƒ­éƒ¨ç½²ï¼Ÿ"

**å®ç°æ€è·¯**ï¼š
1. **ç›‘æ§æ–‡ä»¶å˜åŒ–**ï¼šä½¿ç”¨WatchServiceç›‘æ§classæ–‡ä»¶
2. **é‡æ–°åˆ›å»ºç±»åŠ è½½å™¨**ï¼šä¸¢å¼ƒæ—§çš„ç±»åŠ è½½å™¨ï¼Œåˆ›å»ºæ–°çš„
3. **é‡æ–°åŠ è½½ç±»**ï¼šä½¿ç”¨æ–°çš„ç±»åŠ è½½å™¨åŠ è½½ä¿®æ”¹åçš„ç±»
4. **å®ä¾‹æ›¿æ¢**ï¼šæ›¿æ¢æ—§å®ä¾‹ä¸ºæ–°ç±»çš„å®ä¾‹

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public class HotDeployManager {
    private HotSwapClassLoader classLoader;
    private WatchService watchService;
    
    public void startMonitoring(String classPath) throws IOException {
        watchService = FileSystems.getDefault().newWatchService();
        Path path = Paths.get(classPath);
        path.register(watchService, StandardWatchEventKinds.ENTRY_MODIFY);
        
        while (true) {
            WatchKey key = watchService.take();
            for (WatchEvent<?> event : key.pollEvents()) {
                if (event.kind() == StandardWatchEventKinds.ENTRY_MODIFY) {
                    String fileName = event.context().toString();
                    if (fileName.endsWith(".class")) {
                        reloadClass(fileName);
                    }
                }
            }
            key.reset();
        }
    }
    
    private void reloadClass(String fileName) {
        // é‡æ–°åˆ›å»ºç±»åŠ è½½å™¨
        classLoader = new HotSwapClassLoader(classPath);
        String className = fileName.replace(".class", "").replace("/", ".");
        
        try {
            Class<?> newClass = classLoader.loadClass(className);
            // é€šçŸ¥åº”ç”¨æ›´æ–°å®ä¾‹
            notifyClassReloaded(newClass);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        }
    }
}
```

### Q3: "SPIæœºåˆ¶å¦‚ä½•ç ´ååŒäº²å§”æ´¾ï¼Ÿ"

**é—®é¢˜åˆ†æ**ï¼š
- Bootstrap ClassLoaderåŠ è½½SPIæ¥å£
- å…·ä½“å®ç°ç±»åœ¨åº”ç”¨ç±»è·¯å¾„ä¸­
- Bootstrap ClassLoaderæ— æ³•è®¿é—®åº”ç”¨ç±»

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
Thread.currentThread().setContextClassLoader(appClassLoader);

// ServiceLoaderä½¿ç”¨ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
ClassLoader cl = Thread.currentThread().getContextClassLoader();
ServiceLoader<Driver> loader = ServiceLoader.load(Driver.class, cl);
```

### Q4: "OSGiå¦‚ä½•å®ç°æ¨¡å—åŒ–ï¼Ÿ"

**æ ¸å¿ƒæœºåˆ¶**ï¼š
1. **Bundleéš”ç¦»**ï¼šæ¯ä¸ªBundleæœ‰ç‹¬ç«‹çš„ç±»åŠ è½½å™¨
2. **å¯¼å…¥å¯¼å‡º**ï¼šé€šè¿‡Import-Packageå’ŒExport-Packageæ§åˆ¶å¯è§æ€§
3. **ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒåŒä¸€ä¸ªåŒ…çš„å¤šä¸ªç‰ˆæœ¬å¹¶å­˜
4. **åŠ¨æ€æ€§**ï¼šæ”¯æŒBundleçš„åŠ¨æ€å®‰è£…ã€å¯åŠ¨ã€åœæ­¢ã€å¸è½½

---

## ğŸš€ **6. æºç éªŒè¯æ€»ç»“**

### 6.1 å…³é”®æºç æ–‡ä»¶

```
åŒäº²å§”æ´¾å®ç°ï¼š  java.base/java/lang/ClassLoader.java
JVMç±»åŠ è½½ï¼š    src/hotspot/share/classfile/systemDictionary.cpp
ç±»åŠ è½½å™¨æ•°æ®ï¼š src/hotspot/share/classfile/classLoaderData.cpp
ç±»å­—å…¸ï¼š       src/hotspot/share/classfile/dictionary.cpp
```

### 6.2 ç ´ååŒäº²å§”æ´¾çš„åœºæ™¯

1. **SPIæœºåˆ¶**ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
2. **Tomcat**ï¼šWebAppClassLoaderä¼˜å…ˆè‡ªå·±åŠ è½½
3. **OSGi**ï¼šç½‘çŠ¶ç±»åŠ è½½å™¨ç»“æ„
4. **çƒ­éƒ¨ç½²**ï¼šé‡æ–°åˆ›å»ºç±»åŠ è½½å™¨

### 6.3 é¢è¯•æ ¸å¿ƒè¦ç‚¹

**å¿…é¡»æŒæ¡çš„çŸ¥è¯†ç‚¹**ï¼š
- åŒäº²å§”æ´¾çš„å®ç°åŸç†å’Œæºç 
- ç ´ååŒäº²å§”æ´¾çš„å…¸å‹åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆ
- è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°æ–¹æ³•
- ç±»åŠ è½½å™¨éš”ç¦»å’Œç±»å¸è½½æœºåˆ¶
- Tomcatã€OSGiç­‰æ¡†æ¶çš„ç±»åŠ è½½ç­–ç•¥

---

**æ€»ç»“**ï¼šæŒæ¡è¿™äº›ç±»åŠ è½½é«˜çº§æœºåˆ¶ï¼Œä½ å°±èƒ½åœ¨é¢è¯•ä¸­å±•ç°å‡ºçœŸæ­£çš„Javaç±»åŠ è½½ä¸“å®¶æ°´å¹³ï¼Œä¸ä»…èƒ½å›ç­”åŸºç¡€çš„åŒäº²å§”æ´¾é—®é¢˜ï¼Œè¿˜èƒ½æ·±å…¥åˆ†æå„ç§ç ´ååœºæ™¯çš„å®ç°åŸç†å’Œè§£å†³æ–¹æ¡ˆã€‚