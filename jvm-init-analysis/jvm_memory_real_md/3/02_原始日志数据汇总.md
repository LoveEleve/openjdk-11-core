# JVM 内存布局原始日志数据汇总（第三次验证）

> 本文档保存所有用于验证的原始JVM日志输出

---

## 一、NMT 完整输出

```log
Native Memory Tracking:

Total: reserved=10360591563, committed=9018533067

-                 Java Heap (reserved=8589934592, committed=8589934592)
                            (mmap: reserved=8589934592, committed=8589934592)

-                     Class (reserved=1082380651, committed=7197035)
                            (mmap: reserved=1082130432, committed=6946816)
                            (    reserved=8388608, committed=6291456)
                            (    reserved=1073741824, committed=655360)

-                    Thread (reserved=23177120, committed=1144736)
                            (stack: reserved=23068672, committed=1036288)

-                      Code (reserved=254936025, committed=10093529)
                            (mmap: reserved=253628416, committed=8785920)

-                        GC (reserved=392629063, committed=392629063)
                            (mmap: reserved=353128448, committed=353128448)

-                  Compiler (reserved=1662234, committed=1662234)

-                  Internal (reserved=604603, committed=604603)
                            (mmap: reserved=32768, committed=32768)

-                    Symbol (reserved=2626280, committed=2626280)

-    Native Memory Tracking (reserved=961736, committed=961736)

-               Arena Chunk (reserved=11520872, committed=11520872)

-                   Tracing (reserved=120, committed=120)

-                   Logging (reserved=6276, committed=6276)

-                 Arguments (reserved=20639, committed=20639)

-                    Module (reserved=77344, committed=77344)

-              Synchronizer (reserved=45816, committed=45816)

-                 Safepoint (reserved=8192, committed=8192)
                            (mmap: reserved=8192, committed=8192)
```

---

## 二、GC 内存详细分布 (NMT detail)

```log
(reserved=134217728, committed=134217728 Type=GC)  # Prev Bitmap (128MB)
(reserved=134217728, committed=134217728 Type=GC)  # Next Bitmap (128MB)
(reserved=33554432, committed=33554432 Type=GC)    # Marking结构 (32MB)
(reserved=16777216, committed=16777216 Type=GC)    # G1结构1 (16MB)
(reserved=16777216, committed=16777216 Type=GC)    # G1结构2 (16MB)
(reserved=16777216, committed=16777216 Type=GC)    # G1结构3 (16MB)
(reserved=806912, committed=806912 Type=GC)        # G1FromCardCache (~788KB)
```

**汇总**:
```
128MB + 128MB + 32MB + 16MB + 16MB + 16MB + 0.8MB = 336.8MB (mmap部分)
总GC: 374.51MB (含malloc部分)
```

---

## 三、Heap 和 Region 信息

### 3.1 Heap 基本信息

```log
[0.007s][info][gc,heap] Heap region size: 4M
[0.009s][debug][gc,heap] Minimum heap 8589934592  Initial heap 8589934592  Maximum heap 8589934592
[0.016s][trace][gc,heap,coops] Trying to allocate at address 0x0000000600000000 heap of size 0x200000000
[0.061s][info][gc,heap,coops] Heap address: 0x0000000600000000, size: 8192 MB, 
                              Compressed Oops mode: Zero based, Oop shift amount: 3
```

### 3.2 Region 分配日志

```log
# 第一个 Region
G1HR COMMIT(FREE) [0x0000000600000000, 0x0000000600000000, 0x0000000600400000]

# 最后三个 Region
G1HR COMMIT(FREE) [0x00000007ff400000, 0x00000007ff400000, 0x00000007ff800000]
G1HR COMMIT(FREE) [0x00000007ff800000, 0x00000007ff800000, 0x00000007ffc00000]
G1HR COMMIT(FREE) [0x00000007ffc00000, 0x00000007ffc00000, 0x0000000800000000]

# Region 总数统计
$ grep "G1HR COMMIT" | wc -l
2048
```

---

## 四、G1 辅助数据结构

### 4.1 G1CardTable

```log
[0.016s][trace][gc,barrier] G1CardTable::G1CardTable:
[0.016s][trace][gc,barrier]     &_byte_map[0]: 0x00007f4d5c908000
[0.016s][trace][gc,barrier]     &_byte_map[_last_valid_index]: 0x00007f4d5d907fff
[0.016s][trace][gc,barrier]     _byte_map_base: 0x00007f4d59908000
```

**验证计算**:
```
大小 = 0x7f4d5d907fff - 0x7f4d5c908000 + 1 = 0x1000000 = 16,777,216 bytes (16MB)
理论值 = 8GB / 512 = 16,777,216 bytes ✓
```

### 4.2 G1BlockOffsetTable

```log
[0.016s][trace][gc,bot] G1BlockOffsetTable::G1BlockOffsetTable:
[0.016s][trace][gc,bot]     rs.base(): 0x00007f4d5d908000
[0.016s][trace][gc,bot]     rs.size(): 16777216
[0.016s][trace][gc,bot]     rs end(): 0x00007f4d5e908000
```

**验证计算**:
```
大小 = rs.size() = 16,777,216 bytes (16MB)
0x7f4d5e908000 - 0x7f4d5d908000 = 0x1000000 = 16MB ✓
```

---

## 五、Metaspace 信息

### 5.1 Compressed Class Space

```log
[0.063s][trace][gc,metaspace] node @0x00007f0e48c8b960: reserved=1048576.00 KB, committed=0.00 KB
[0.063s][trace][gc,metaspace]    [0x0000000800000000, 0x0000000800000000, 0x0000000800000000, 0x0000000840000000)
[0.063s][trace][gc,metaspace] Narrow klass base: 0x0000000800000000, Narrow klass shift: 0
[0.063s][trace][gc,metaspace] Compressed class space size: 1073741824 Address: 0x0000000800000000
```

**验证**:
```
Class Space = 1048576 KB = 1GB ✓
地址范围 = [0x800000000, 0x840000000) = 1GB ✓
紧跟 Heap 结束地址 ✓
```

### 5.2 Non-class Metaspace

```log
[0.063s][trace][gc,metaspace] node @0x00007f0e48c8bda0: reserved=8192.00 KB, committed=0.00 KB
[0.063s][trace][gc,metaspace]    [0x00007f0e194fb000, 0x00007f0e194fb000, 0x00007f0e194fb000, 0x00007f0e19cfb000)
```

**验证**:
```
Non-class space = 8192 KB = 8MB ✓
地址范围 = 0x7f0e19cfb000 - 0x7f0e194fb000 = 0x800000 = 8MB ✓
```

### 5.3 Metaspace 使用统计

```log
Metaspace:
Usage:
  Non-class:  6100992 bytes capacity, 6035040 bytes ( 99%) used, 56544 bytes ( <1%) free+waste,  9408 bytes ( <1%) overhead.
      Class:  634880 bytes capacity, 572008 bytes ( 90%) used, 57944 bytes (  9%) free+waste,  4928 bytes ( <1%) overhead.
       Both:  6735872 bytes capacity, 6607048 bytes ( 98%) used, 114488 bytes (  2%) free+waste, 14336 bytes ( <1%) overhead.

Virtual space:
  Non-class space:  8388608 bytes reserved, 6291456 bytes ( 75%) committed
      Class space:  1073741824 bytes reserved,  655360 bytes ( <1%) committed
             Both:  1082130432 bytes reserved, 6946816 bytes ( <1%) committed

Chunk freelists:
   Non-Class:  6144 bytes
       Class:  20480 bytes
        Both:  26624 bytes

MaxMetaspaceSize: unlimited
CompressedClassSpaceSize: 1073741824 bytes
Initial GC threshold: 21807104 bytes
Current GC threshold: 21807104 bytes
CDS: off
```

---

## 六、CodeCache 信息

```log
CodeHeap 'non-nmethods': size=7420Kb used=3433Kb max_used=3455Kb free=3986Kb
 bounds [0x00007f79c9000000, 0x00007f79c9370000, 0x00007f79c973f000]

CodeHeap 'profiled nmethods': size=119168Kb used=902Kb max_used=902Kb free=118265Kb
 bounds [0x00007f79c973f000, 0x00007f79c99af000, 0x00007f79d0b9f000]

CodeHeap 'non-profiled nmethods': size=119172Kb used=255Kb max_used=255Kb free=118916Kb
 bounds [0x00007f79d0b9f000, 0x00007f79d0e0f000, 0x00007f79d8000000]

total_blobs=1386 nmethods=511 adapters=794
```

**汇总**:
```
区域                    大小          已用        地址范围
non-nmethods           7,420 KB     3,433 KB    [0x7f79c9000000, 0x7f79c973f000)
profiled nmethods    119,168 KB       902 KB    [0x7f79c973f000, 0x7f79d0b9f000)
non-profiled         119,172 KB       255 KB    [0x7f79d0b9f000, 0x7f79d8000000)
总计                  ~245 MB       ~4.5 MB
```

---

## 七、数学验证汇总

| 项目 | 计算公式 | 理论值 | 实际值 | 验证 |
|------|----------|--------|--------|------|
| Heap 大小 | 8 × 1024³ | 8,589,934,592 | 8,589,934,592 | ✓ |
| Region 数量 | 8GB / 4MB | 2,048 | 2,048 | ✓ |
| CardTable 大小 | 8GB / 512 | 16,777,216 | 16,777,216 | ✓ |
| BOT 大小 | 8GB / 512 | 16,777,216 | 16,777,216 | ✓ |
| Bitmap (每个) | 8GB / 64 | 134,217,728 | 134,217,728 | ✓ |
| Class Space | 默认1GB | 1,073,741,824 | 1,073,741,824 | ✓ |
| Heap 起始地址 | - | 0x600000000 | 0x600000000 | ✓ |
| Heap 结束地址 | 0x600000000 + 8GB | 0x800000000 | 0x800000000 | ✓ |
| Class Space 起始 | Heap结束地址 | 0x800000000 | 0x800000000 | ✓ |

---

## 八、三次验证数据对比

| 数据项 | 第1次 | 第2次 | 第3次 | 差异说明 |
|--------|-------|-------|-------|----------|
| Total Reserved | 10,359,276,889 | 10,360,132,708 | 10,360,591,563 | 正常波动 |
| Total Committed | 9,017,218,393 | 9,018,074,212 | 9,018,533,067 | 正常波动 |
| Java Heap | 8,589,934,592 | 8,589,934,592 | 8,589,934,592 | 完全一致 |
| Class | 1,082,380,651 | 1,082,380,587 | 1,082,380,651 | ±64B |
| Thread | 23,177,120 | 23,177,120 | 23,177,120 | 完全一致 |
| Code | 254,935,735 | 254,930,300 | 254,936,025 | ±6KB |
| GC | 392,628,487 | 392,629,063 | 392,629,063 | 第2/3次一致 |
| Compiler | 187,802 | 2,549,106 | 1,662,234 | 动态分配 |
| Arena Chunk | 11,683,200 | 9,879,800 | 11,520,872 | 动态分配 |
| NMT | 961,096 | 1,262,720 | 961,736 | 追踪开销 |

**波动原因**:
- Compiler/Arena Chunk: JIT编译过程动态分配
- NMT: detail模式比summary开销大
- 其他: 每次运行加载类略有不同

---

## 九、使用的 JVM 参数

```bash
# NMT Summary
java -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages \
     -XX:NativeMemoryTracking=summary -XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics \
     HelloWorld

# NMT Detail (GC分布)
java -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages \
     -XX:NativeMemoryTracking=detail -XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics \
     HelloWorld

# GC/Heap 日志
java -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages \
     -Xlog:gc+heap*=trace,gc+metaspace*=trace,gc+bot*=trace,gc+barrier*=trace,gc+region*=trace \
     HelloWorld

# CodeCache
java -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages \
     -XX:+PrintCodeCache \
     HelloWorld
```

---

*数据采集时间: 2026-01-15*
*OpenJDK版本: 11.0.17-internal (slowdebug)*
