# JVM 内存布局原始日志数据汇总

> 本文档保存所有用于验证的原始JVM日志输出

---

## 一、Heap 和 Region 信息

### 1.1 Heap 地址和压缩指针

```log
[0.008s][info][gc,heap] Heap region size: 4M
[0.009s][debug][gc,heap] Minimum heap 8589934592  Initial heap 8589934592  Maximum heap 8589934592
[0.016s][trace][gc,heap,coops] Trying to allocate at address 0x0000000600000000 heap of size 0x200000000
[0.063s][info][gc,heap,coops] Heap address: 0x0000000600000000, size: 8192 MB, 
                              Compressed Oops mode: Zero based, Oop shift amount: 3
```

### 1.2 Region 分配日志（部分）

```log
# 统计总数: 2048 个 Region

# 起始 Region
[0.058s][trace][gc,region] G1HR COMMIT(FREE) [0x0000000600000000, 0x0000000600000000, 0x0000000600400000]
[0.058s][trace][gc,region] G1HR COMMIT(FREE) [0x0000000600400000, 0x0000000600400000, 0x0000000600800000]
[0.058s][trace][gc,region] G1HR COMMIT(FREE) [0x0000000600800000, 0x0000000600800000, 0x0000000600c00000]
[0.058s][trace][gc,region] G1HR COMMIT(FREE) [0x0000000600c00000, 0x0000000600c00000, 0x0000000601000000]
...

# 结束 Region
[0.069s][trace][gc,region] G1HR COMMIT(FREE) [0x00000007fec00000, 0x00000007fec00000, 0x00000007ff000000]
[0.069s][trace][gc,region] G1HR COMMIT(FREE) [0x00000007ff000000, 0x00000007ff000000, 0x00000007ff400000]
[0.069s][trace][gc,region] G1HR COMMIT(FREE) [0x00000007ff400000, 0x00000007ff400000, 0x00000007ff800000]
[0.069s][trace][gc,region] G1HR COMMIT(FREE) [0x00000007ff800000, 0x00000007ff800000, 0x00000007ffc00000]
[0.069s][trace][gc,region] G1HR COMMIT(FREE) [0x00000007ffc00000, 0x00000007ffc00000, 0x0000000800000000]
```

---

## 二、G1 辅助数据结构

### 2.1 G1CardTable

```log
[0.015s][trace][gc,barrier] G1CardTable::G1CardTable:
[0.015s][trace][gc,barrier]     &_byte_map[0]: 0x00007f7448000000  &_byte_map[_last_valid_index]: 0x00007f7448ffffff
[0.015s][trace][gc,barrier]     _byte_map_base: 0x00007f7445000000
```

**验证计算:**
```
CardTable 大小 = &_byte_map[_last_valid_index] - &_byte_map[0] + 1
             = 0x7f7448ffffff - 0x7f7448000000 + 1
             = 0x1000000
             = 16,777,216 bytes (16MB)

理论值: 8GB / 512 = 16,777,216 bytes ✓
```

### 2.2 G1BlockOffsetTable

```log
[0.016s][trace][gc,bot] G1BlockOffsetTable::G1BlockOffsetTable:
[0.016s][trace][gc,bot]     rs.base(): 0x00007f745cd08000  rs.size(): 16777216  rs end(): 0x00007f745dd08000
```

**验证计算:**
```
BOT 大小 = rs.size() = 16,777,216 bytes (16MB)
理论值: 8GB / 512 = 16,777,216 bytes ✓
```

---

## 三、Metaspace 信息

### 3.1 Compressed Class Space

```log
[0.064s][trace][gc,metaspace] node @0x00007f7e64c8b960: reserved=1048576.00 KB, committed=0.00 KB (  0%), used=0.00 KB (  0%)
[0.064s][trace][gc,metaspace]    [0x0000000800000000, 0x0000000800000000, 0x0000000800000000, 0x0000000840000000)
[0.064s][trace][gc,metaspace] Narrow klass base: 0x0000000800000000, Narrow klass shift: 0
[0.064s][trace][gc,metaspace] Compressed class space size: 1073741824 Address: 0x0000000800000000 Req Addr: 0x0000000800000000
```

**验证:**
```
Class Space 大小 = 0x840000000 - 0x800000000 = 0x40000000 = 1,073,741,824 bytes (1GB) ✓
Class Space 紧跟 Heap 结束地址 (0x800000000) ✓
```

### 3.2 Non-class Metaspace

```log
[0.064s][trace][gc,metaspace] node @0x00007f7e64c8bda0: reserved=8192.00 KB, committed=0.00 KB (  0%), used=0.00 KB (  0%)
[0.064s][trace][gc,metaspace]    [0x00007f7e352f9000, 0x00007f7e352f9000, 0x00007f7e352f9000, 0x00007f7e35af9000)
```

### 3.3 程序结束时的 Metaspace 统计

```log
Metaspace:
Usage:
  Non-class:  6100992 bytes capacity, 6060080 bytes (>99%) used, 31504 bytes ( <1%) free+waste,  9408 bytes ( <1%) overhead.
      Class:  634880 bytes capacity, 572008 bytes ( 90%) used, 57944 bytes (  9%) free+waste,  4928 bytes ( <1%) overhead.
       Both:  6735872 bytes capacity, 6632088 bytes ( 98%) used, 89448 bytes (  1%) free+waste, 14336 bytes ( <1%) overhead.

Virtual space:
  Non-class space:  8388608 bytes reserved, 6291456 bytes ( 75%) committed
      Class space:  1073741824 bytes reserved,  655360 bytes ( <1%) committed
             Both:  1082130432 bytes reserved, 6946816 bytes ( <1%) committed

Chunk freelists:
   Non-Class:  30720 bytes
       Class:  20480 bytes
        Both:  51200 bytes

MaxMetaspaceSize: unlimited
CompressedClassSpaceSize: 1073741824 bytes
Initial GC threshold: 21807104 bytes
Current GC threshold: 21807104 bytes
CDS: off
```

---

## 四、CodeCache 信息

```log
CodeHeap 'non-profiled nmethods': size=119172Kb used=262Kb max_used=262Kb free=118909Kb
 bounds [0x00007fd5c4b9f000, 0x00007fd5c4e0f000, 0x00007fd5cc000000]
 
CodeHeap 'profiled nmethods': size=119168Kb used=891Kb max_used=891Kb free=118276Kb
 bounds [0x00007fd5bd73f000, 0x00007fd5bd9af000, 0x00007fd5c4b9f000]
 
CodeHeap 'non-nmethods': size=7420Kb used=3433Kb max_used=3461Kb free=3986Kb
 bounds [0x00007fd5bd000000, 0x00007fd5bd370000, 0x00007fd5bd73f000]

total_blobs=1384 nmethods=509 adapters=794
compilation: enabled
             stopped_count=0, restarted_count=0
full_count=0
```

**汇总:**
```
区域                    大小          已用       地址范围
non-nmethods           7,420 KB     3,433 KB   [0x7fd5bd000000, 0x7fd5bd73f000)
profiled nmethods    119,168 KB       891 KB   [0x7fd5bd73f000, 0x7fd5c4b9f000)
non-profiled nmethods 119,172 KB      262 KB   [0x7fd5c4b9f000, 0x7fd5cc000000)
总计                  ~245 MB
```

---

## 五、NMT (Native Memory Tracking) 完整输出

```log
Native Memory Tracking:

Total: reserved=10360132708, committed=9018074212

-                 Java Heap (reserved=8589934592, committed=8589934592)
                            (mmap: reserved=8589934592, committed=8589934592)
 
-                     Class (reserved=1082380587, committed=7196971)
                            (mmap: reserved=1082130432, committed=6946816)
                            (    reserved=8388608, committed=6291456)
                            (    reserved=1073741824, committed=655360)
 
-                    Thread (reserved=23177120, committed=1144736)
                            (stack: reserved=23068672, committed=1036288)
 
-                      Code (reserved=254930300, committed=10087804)
                            (mmap: reserved=253628416, committed=8785920)
 
-                        GC (reserved=392629063, committed=392629063)
                            (mmap: reserved=353128448, committed=353128448)
 
-                  Compiler (reserved=2549106, committed=2549106)

-                  Internal (reserved=604601, committed=604601)
                            (mmap: reserved=32768, committed=32768)
 
-                    Symbol (reserved=2626280, committed=2626280)

-    Native Memory Tracking (reserved=1262720, committed=1262720)

-               Arena Chunk (reserved=9879800, committed=9879800)

-                   Tracing (reserved=120, committed=120)

-                   Logging (reserved=6276, committed=6276)

-                 Arguments (reserved=20639, committed=20639)

-                    Module (reserved=77344, committed=77344)

-              Synchronizer (reserved=45968, committed=45968)

-                 Safepoint (reserved=8192, committed=8192)
                            (mmap: reserved=8192, committed=8192)
```

### GC 内存详细分布

```log
(reserved=8589934592, committed=8589934592 Type=Java Heap)
(reserved=1073741824, committed=655360 Type=Class)
(reserved=251658240, committed=8716288 Type=Code)
(reserved=134217728, committed=134217728 Type=GC)  # Bitmap 1
(reserved=134217728, committed=134217728 Type=GC)  # Bitmap 2
(reserved=33554432, committed=33554432 Type=GC)    # Marking
(reserved=22020096, committed=892928 Type=Thread Stack)
(reserved=16777216, committed=16777216 Type=GC)    # CardTable/BOT
(reserved=16777216, committed=16777216 Type=GC)    # CardTable/BOT
(reserved=16777216, committed=16777216 Type=GC)    # 其他G1结构
(reserved=8388608, committed=6291456 Type=Class)
(reserved=1970176, committed=69632 Type=Code)
(reserved=1048576, committed=143360 Type=Thread Stack)
(reserved=806912, committed=806912 Type=GC)        # G1FromCardCache
(reserved=32768, committed=32768 Type=Internal)
(reserved=8192, committed=8192 Type=Safepoint)
```

---

## 六、数学验证汇总

| 项目 | 计算公式 | 理论值 | 实际值 | 结果 |
|------|----------|--------|--------|------|
| Heap 大小 | 8 × 1024³ | 8,589,934,592 | 8,589,934,592 | ✓ |
| Region 数量 | 8GB / 4MB | 2,048 | 2,048 | ✓ |
| CardTable 大小 | 8GB / 512 | 16,777,216 | 16,777,216 | ✓ |
| BOT 大小 | 8GB / 512 | 16,777,216 | 16,777,216 | ✓ |
| Bitmap 大小(每个) | 8GB / 64 | 134,217,728 | 134,217,728 | ✓ |
| Class Space | 默认1GB | 1,073,741,824 | 1,073,741,824 | ✓ |
| Heap 起始地址 | - | 0x600000000 | 0x600000000 | ✓ |
| Heap 结束地址 | 0x600000000 + 8GB | 0x800000000 | 0x800000000 | ✓ |

---

## 七、使用的 JVM 参数

```bash
# 完整 GC 日志
-Xlog:gc+heap*=trace,gc+metaspace*=trace,gc+bot*=trace,gc+barrier*=trace,gc+region*=trace

# NMT 统计
-XX:NativeMemoryTracking=detail -XX:+UnlockDiagnosticVMOptions -XX:+PrintNMTStatistics

# CodeCache 信息
-XX:+PrintCodeCache

# 堆配置
-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages
```
