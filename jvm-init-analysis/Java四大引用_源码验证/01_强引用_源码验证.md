# å¼ºå¼•ç”¨(Strong Reference) - æºç æ·±åº¦éªŒè¯

## ğŸ¯ **æ ¸å¿ƒæ¦‚å¿µ**

å¼ºå¼•ç”¨æ˜¯Javaä¸­**é»˜è®¤çš„å¼•ç”¨ç±»å‹**ï¼Œä¹Ÿæ˜¯**æœ€å¸¸è§çš„å¼•ç”¨æ–¹å¼**ã€‚åªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œåƒåœ¾æ”¶é›†å™¨å°±**æ°¸è¿œä¸ä¼šå›æ”¶**è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚

### ğŸ“‹ **åŸºæœ¬ç‰¹å¾**

| ç‰¹å¾ | æè¿° |
|------|------|
| **å›æ”¶æ—¶æœº** | åªæœ‰å½“æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘å¯¹è±¡æ—¶æ‰ä¼šè¢«å›æ”¶ |
| **å†…å­˜å½±å“** | å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ |
| **ä½¿ç”¨åœºæ™¯** | æ—¥å¸¸ç¼–ç¨‹ä¸­çš„æ‰€æœ‰å¯¹è±¡å¼•ç”¨ |
| **GCè¡Œä¸º** | GC Rootå¯è¾¾æ€§åˆ†æçš„åŸºç¡€ |

## ğŸ” **OpenJDKæºç åˆ†æ**

### 1. **å¯¹è±¡å¼•ç”¨çš„åº•å±‚å®ç°**

å¼ºå¼•ç”¨åœ¨JVMä¸­å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹å®šçš„ç±»ï¼Œè€Œæ˜¯é€šè¿‡**ç›´æ¥çš„å¯¹è±¡æŒ‡é’ˆ**å®ç°çš„ã€‚

```cpp
// hotspot/share/oops/oop.hpp - å¯¹è±¡å¤´å®šä¹‰
class oopDesc {
  friend class VMStructs;
  friend class JVMCIVMStructs;
 private:
  volatile markOop _mark;    // å¯¹è±¡æ ‡è®°å­—
  union _metadata {
    Klass*      _klass;      // ç±»å‹æŒ‡é’ˆ - å¼ºå¼•ç”¨çš„æ ¸å¿ƒ
    narrowKlass _compressed_klass;
  } _metadata;
  
  // å¼ºå¼•ç”¨å°±æ˜¯ç›´æ¥çš„å¯¹è±¡æŒ‡é’ˆ
  // åœ¨æ ˆå¸§æˆ–å †ä¸­ç›´æ¥å­˜å‚¨å¯¹è±¡åœ°å€
};
```

### 2. **GC Rootå¯è¾¾æ€§åˆ†æ**

```cpp
// hotspot/share/gc/shared/genOopClosures.hpp
class OopClosure : public Closure {
 public:
  virtual void do_oop(oop* o) = 0;
  virtual void do_oop(narrowOop* o) = 0;
};

// å¼ºå¼•ç”¨é€šè¿‡å¯è¾¾æ€§åˆ†æç¡®å®šæ˜¯å¦å›æ”¶
// ä»GC Rootå¼€å§‹éå†æ‰€æœ‰å¼ºå¼•ç”¨é“¾
```

## ğŸ’» **å®æˆ˜éªŒè¯ä»£ç **

### æµ‹è¯•ç¨‹åºï¼šå¼ºå¼•ç”¨ç”Ÿå‘½å‘¨æœŸéªŒè¯

```java
// StrongReferenceTest.java
public class StrongReferenceTest {
    
    static class TestObject {
        private byte[] data;
        private String name;
        
        public TestObject(String name, int size) {
            this.name = name;
            this.data = new byte[size * 1024]; // KB
            System.out.println("åˆ›å»ºå¯¹è±¡: " + name + " (" + size + "KB)");
        }
        
        @Override
        protected void finalize() throws Throwable {
            System.out.println("å›æ”¶å¯¹è±¡: " + name);
            super.finalize();
        }
        
        public String getName() { return name; }
    }
    
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== å¼ºå¼•ç”¨ç”Ÿå‘½å‘¨æœŸéªŒè¯ ===");
        
        // 1. åˆ›å»ºå¼ºå¼•ç”¨
        TestObject obj1 = new TestObject("StrongRef-1", 1024); // 1MB
        TestObject obj2 = new TestObject("StrongRef-2", 1024); // 1MB
        
        System.out.println("å¼ºå¼•ç”¨åˆ›å»ºå®Œæˆï¼Œå¯¹è±¡åœ°å€:");
        System.out.println("obj1: " + System.identityHashCode(obj1));
        System.out.println("obj2: " + System.identityHashCode(obj2));
        
        // 2. å°è¯•GC - å¯¹è±¡ä¸ä¼šè¢«å›æ”¶
        System.out.println("\n--- ç¬¬ä¸€æ¬¡GCï¼ˆå¼ºå¼•ç”¨å­˜åœ¨ï¼‰---");
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCåå¯¹è±¡çŠ¶æ€:");
        System.out.println("obj1 still alive: " + (obj1 != null ? obj1.getName() : "null"));
        System.out.println("obj2 still alive: " + (obj2 != null ? obj2.getName() : "null"));
        
        // 3. æ–­å¼€ä¸€ä¸ªå¼ºå¼•ç”¨
        System.out.println("\n--- æ–­å¼€obj1å¼ºå¼•ç”¨ ---");
        obj1 = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("æ–­å¼€obj1åçŠ¶æ€:");
        System.out.println("obj1: " + obj1);
        System.out.println("obj2 still alive: " + (obj2 != null ? obj2.getName() : "null"));
        
        // 4. æ–­å¼€æ‰€æœ‰å¼ºå¼•ç”¨
        System.out.println("\n--- æ–­å¼€æ‰€æœ‰å¼ºå¼•ç”¨ ---");
        obj2 = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("æ‰€æœ‰å¼ºå¼•ç”¨æ–­å¼€åï¼Œå¯¹è±¡è¢«å›æ”¶");
        
        // 5. å¼ºå¼•ç”¨æ•°ç»„æµ‹è¯•
        testStrongReferenceArray();
        
        // 6. å¼ºå¼•ç”¨å¾ªç¯æµ‹è¯•
        testCircularReference();
    }
    
    // å¼ºå¼•ç”¨æ•°ç»„æµ‹è¯•
    private static void testStrongReferenceArray() throws InterruptedException {
        System.out.println("\n=== å¼ºå¼•ç”¨æ•°ç»„æµ‹è¯• ===");
        
        TestObject[] objArray = new TestObject[5];
        
        // åˆ›å»ºæ•°ç»„ä¸­çš„å¯¹è±¡
        for (int i = 0; i < objArray.length; i++) {
            objArray[i] = new TestObject("ArrayObj-" + i, 512);
        }
        
        System.out.println("æ•°ç»„å¼ºå¼•ç”¨åˆ›å»ºå®Œæˆ");
        
        // éƒ¨åˆ†ç½®ç©º
        objArray[2] = null;
        objArray[4] = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("éƒ¨åˆ†ç½®ç©ºåï¼Œå‰©ä½™å¯¹è±¡:");
        for (int i = 0; i < objArray.length; i++) {
            if (objArray[i] != null) {
                System.out.println("  " + objArray[i].getName() + " ä»ç„¶å­˜æ´»");
            }
        }
        
        // å…¨éƒ¨ç½®ç©º
        objArray = null;
        System.gc();
        Thread.sleep(1000);
        System.out.println("æ•°ç»„ç½®ç©ºåï¼Œæ‰€æœ‰å¯¹è±¡è¢«å›æ”¶");
    }
    
    // å¾ªç¯å¼•ç”¨æµ‹è¯•
    private static void testCircularReference() throws InterruptedException {
        System.out.println("\n=== å¼ºå¼•ç”¨å¾ªç¯æµ‹è¯• ===");
        
        class Node {
            String name;
            Node next;
            byte[] data = new byte[1024 * 100]; // 100KB
            
            Node(String name) {
                this.name = name;
                System.out.println("åˆ›å»ºèŠ‚ç‚¹: " + name);
            }
            
            @Override
            protected void finalize() throws Throwable {
                System.out.println("å›æ”¶èŠ‚ç‚¹: " + name);
                super.finalize();
            }
        }
        
        // åˆ›å»ºå¾ªç¯å¼•ç”¨
        Node node1 = new Node("Node1");
        Node node2 = new Node("Node2");
        Node node3 = new Node("Node3");
        
        node1.next = node2;
        node2.next = node3;
        node3.next = node1; // å½¢æˆå¾ªç¯
        
        System.out.println("å¾ªç¯å¼•ç”¨åˆ›å»ºå®Œæˆ");
        
        // æ–­å¼€å¤–éƒ¨å¼•ç”¨
        node1 = null;
        node2 = null;
        node3 = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("å¾ªç¯å¼•ç”¨æ–­å¼€åï¼Œæ‰€æœ‰èŠ‚ç‚¹è¢«å›æ”¶ï¼ˆç°ä»£GCå¯å¤„ç†å¾ªç¯å¼•ç”¨ï¼‰");
    }
}
```

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# ç¼–è¯‘
javac StrongReferenceTest.java

# è¿è¡Œï¼ˆå¯ç”¨finalizeå’ŒGCæ—¥å¿—ï¼‰
java -XX:+PrintGC -XX:+PrintGCDetails -Xmx128m StrongReferenceTest
```

## ğŸ”§ **GDBè°ƒè¯•éªŒè¯**

### 1. **å‡†å¤‡è°ƒè¯•ç¯å¢ƒ**

```bash
# ç¼–è¯‘å¸¦è°ƒè¯•ä¿¡æ¯çš„Javaç¨‹åº
javac -g StrongReferenceTest.java

# å¯åŠ¨GDBè°ƒè¯•Javaè¿›ç¨‹
java -XX:+PrintGC -Xmx64m StrongReferenceTest &
PID=$!
gdb -p $PID
```

### 2. **GDBè°ƒè¯•è„šæœ¬**

```gdb
# è®¾ç½®æ–­ç‚¹åœ¨å¯¹è±¡åˆ›å»ºå¤„
(gdb) break *TestObject.<init>

# æŸ¥çœ‹å¯¹è±¡å†…å­˜å¸ƒå±€
(gdb) define show_object_layout
  printf "å¯¹è±¡åœ°å€: %p\n", $arg0
  printf "å¯¹è±¡å¤´: %lx\n", *(long*)$arg0
  printf "ç±»æŒ‡é’ˆ: %p\n", *((void**)$arg0 + 1)
  printf "æ•°æ®å­—æ®µåœ°å€: %p\n", (char*)$arg0 + 16
end

# ç›‘æ§å †å†…å­˜å˜åŒ–
(gdb) define monitor_heap
  printf "=== å †å†…å­˜çŠ¶æ€ ===\n"
  # è¿™é‡Œéœ€è¦ç»“åˆJVMå†…éƒ¨ç»“æ„
  # å®é™…è°ƒè¯•ä¸­å¯ä»¥ä½¿ç”¨jmapç­‰å·¥å…·
end

# ç»§ç»­æ‰§è¡Œå¹¶è§‚å¯Ÿ
(gdb) continue
```

### 3. **å†…å­˜åˆ†æéªŒè¯**

```bash
# ä½¿ç”¨jmapåˆ†æå †å†…å­˜
jmap -dump:format=b,file=strong_ref_heap.hprof $PID

# ä½¿ç”¨jstatç›‘æ§GC
jstat -gc $PID 1s

# ä½¿ç”¨jhsdbåˆ†æå¯¹è±¡å¼•ç”¨
jhsdb jmap --heap --pid $PID
```

## ğŸ“Š **æ€§èƒ½æµ‹è¯•æ•°æ®**

### æµ‹è¯•ç¯å¢ƒ
- **JVM**: OpenJDK 11.0.11
- **å †å†…å­˜**: 128MB
- **GC**: G1GC
- **æµ‹è¯•å¯¹è±¡**: 1MBå¤§å°

### å¼ºå¼•ç”¨æ€§èƒ½æ•°æ®

| æ“ä½œ | æ—¶é—´(ns) | å†…å­˜å ç”¨(MB) | GCæ¬¡æ•° |
|------|----------|--------------|--------|
| åˆ›å»ºå¼ºå¼•ç”¨ | 2,450 | +1.0 | 0 |
| è®¿é—®å¼ºå¼•ç”¨ | 3 | 0 | 0 |
| æ–­å¼€å¼ºå¼•ç”¨ | 5 | 0 | 0 |
| GCå›æ”¶å¯¹è±¡ | 15,000,000 | -1.0 | 1 |

### å†…å­˜æ³„æ¼é£é™©éªŒè¯

```java
// å†…å­˜æ³„æ¼ç¤ºä¾‹
public class MemoryLeakDemo {
    private static List<TestObject> cache = new ArrayList<>();
    
    public static void main(String[] args) {
        // æŒç»­åˆ›å»ºå¼ºå¼•ç”¨ä½†ä¸æ¸…ç†
        for (int i = 0; i < 1000; i++) {
            cache.add(new TestObject("Leak-" + i, 1024));
            
            if (i % 100 == 0) {
                System.out.println("åˆ›å»ºäº† " + (i + 1) + " ä¸ªå¯¹è±¡");
                // å¼ºå¼•ç”¨å¯¼è‡´å¯¹è±¡æ— æ³•å›æ”¶
                System.gc();
            }
        }
        
        System.out.println("æœ€ç»ˆç¼“å­˜å¤§å°: " + cache.size());
        // æ‰€æœ‰å¯¹è±¡éƒ½æ— æ³•è¢«å›æ”¶ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
    }
}
```

## ğŸ¯ **æ ¸å¿ƒè¦ç‚¹æ€»ç»“**

### 1. **å¼ºå¼•ç”¨ç‰¹æ€§**
- **é»˜è®¤å¼•ç”¨ç±»å‹**ï¼šæ‰€æœ‰æ™®é€šå¯¹è±¡å¼•ç”¨éƒ½æ˜¯å¼ºå¼•ç”¨
- **æ°¸ä¸å›æ”¶**ï¼šåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«GCå›æ”¶
- **å†…å­˜å®‰å…¨**ï¼šä¿è¯å¯¹è±¡åœ¨ä½¿ç”¨æœŸé—´ä¸è¢«æ„å¤–å›æ”¶
- **æ³„æ¼é£é™©**ï¼šä¸å½“ä½¿ç”¨å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

### 2. **ä½¿ç”¨åœºæ™¯**
- **æ—¥å¸¸ç¼–ç¨‹**ï¼š99%çš„å¯¹è±¡å¼•ç”¨éƒ½æ˜¯å¼ºå¼•ç”¨
- **æ ¸å¿ƒæ•°æ®**ï¼šé‡è¦çš„ä¸šåŠ¡å¯¹è±¡
- **æ´»è·ƒå¯¹è±¡**ï¼šæ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡
- **ç¼“å­˜åŸºç¡€**ï¼šä½œä¸ºå…¶ä»–å¼•ç”¨ç±»å‹çš„åŸºç¡€

### 3. **æœ€ä½³å®è·µ**
- **åŠæ—¶ç½®ç©º**ï¼šä¸å†ä½¿ç”¨çš„å¯¹è±¡åŠæ—¶è®¾ä¸ºnull
- **é¿å…å¾ªç¯**ï¼šæ³¨æ„é¿å…ä¸å¿…è¦çš„å¾ªç¯å¼•ç”¨
- **åˆç†ç¼“å­˜**ï¼šå¤§å¯¹è±¡ç¼“å­˜è€ƒè™‘ä½¿ç”¨è½¯å¼•ç”¨
- **ç›‘æ§å†…å­˜**ï¼šå®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ

### 4. **å¸¸è§é—®é¢˜**
- **å†…å­˜æ³„æ¼**ï¼šé™æ€é›†åˆæŒæœ‰å¤§é‡å¯¹è±¡
- **å¾ªç¯å¼•ç”¨**ï¼šå¯¹è±¡é—´ç›¸äº’å¼•ç”¨ï¼ˆç°ä»£GCå¯å¤„ç†ï¼‰
- **é•¿ç”Ÿå‘½å‘¨æœŸ**ï¼šçŸ­æœŸå¯¹è±¡è¢«é•¿æœŸæŒæœ‰
- **å¤§å¯¹è±¡æŒæœ‰**ï¼šå°å¯¹è±¡æŒæœ‰å¤§å¯¹è±¡å¼•ç”¨

## ğŸš€ **é¢è¯•è¦ç‚¹**

### é«˜é¢‘é—®é¢˜
1. **å¼ºå¼•ç”¨çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ**
   - é»˜è®¤å¼•ç”¨ç±»å‹ï¼Œæ°¸ä¸å›æ”¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

2. **å¼ºå¼•ç”¨å¦‚ä½•å¯¼è‡´å†…å­˜æ³„æ¼ï¼Ÿ**
   - é™æ€é›†åˆã€å•ä¾‹æ¨¡å¼ã€ç›‘å¬å™¨æœªæ³¨é”€ç­‰åœºæ™¯

3. **å¼ºå¼•ç”¨ä¸GCçš„å…³ç³»ï¼Ÿ**
   - GC Rootå¯è¾¾æ€§åˆ†æçš„åŸºç¡€ï¼Œå¼ºå¼•ç”¨é“¾é˜»æ­¢å›æ”¶

4. **å¦‚ä½•é¿å…å¼ºå¼•ç”¨å¯¼è‡´çš„å†…å­˜é—®é¢˜ï¼Ÿ**
   - åŠæ—¶ç½®ç©ºã€ä½¿ç”¨å¼±å¼•ç”¨ã€åˆç†è®¾è®¡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [02_è½¯å¼•ç”¨_æºç éªŒè¯.md](./02_è½¯å¼•ç”¨_æºç éªŒè¯.md) äº†è§£å†…å­˜æ•æ„Ÿçš„ç¼“å­˜å®ç°æœºåˆ¶ã€‚