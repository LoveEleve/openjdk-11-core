# å¼±å¼•ç”¨(Weak Reference) - æºç æ·±åº¦éªŒè¯

## ğŸ¯ **æ ¸å¿ƒæ¦‚å¿µ**

å¼±å¼•ç”¨æ˜¯ä¸€ç§**ä¸å½±å“å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ**çš„å¼•ç”¨ç±»å‹ï¼Œå½“å¯¹è±¡åªè¢«å¼±å¼•ç”¨æŒ‡å‘æ—¶ï¼Œ**ä¸‹æ¬¡GCæ—¶å¿…å®šè¢«å›æ”¶**ã€‚å¼±å¼•ç”¨æœ€å¸¸ç”¨äºå®ç°**è§„èŒƒæ˜ å°„(Canonical Mapping)**å’Œ**é¿å…å†…å­˜æ³„æ¼**ã€‚

### ğŸ“‹ **åŸºæœ¬ç‰¹å¾**

| ç‰¹å¾ | æè¿° |
|------|------|
| **å›æ”¶æ—¶æœº** | ä¸‹æ¬¡GCæ—¶ç«‹å³å›æ”¶ï¼ˆä¸è€ƒè™‘å†…å­˜å‹åŠ›ï¼‰ |
| **ç”Ÿå‘½å‘¨æœŸ** | ä¸å½±å“è¢«å¼•ç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ |
| **ä½¿ç”¨åœºæ™¯** | è§„èŒƒæ˜ å°„ã€ç›‘å¬å™¨ã€ç¼“å­˜è¾…åŠ© |
| **å…¸å‹åº”ç”¨** | WeakHashMapã€ThreadLocalæ¸…ç† |

## ğŸ” **OpenJDKæºç åˆ†æ**

### 1. **WeakReferenceç±»ç»“æ„**

```java
// java/lang/ref/WeakReference.java
public class WeakReference<T> extends Reference<T> {
    
    /**
     * åˆ›å»ºå¼±å¼•ç”¨ï¼Œä¸æ³¨å†Œåˆ°å¼•ç”¨é˜Ÿåˆ—
     */
    public WeakReference(T referent) {
        super(referent);
    }
    
    /**
     * åˆ›å»ºå¼±å¼•ç”¨ï¼Œæ³¨å†Œåˆ°æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—
     * å½“å¼•ç”¨è¢«æ¸…ç†æ—¶ï¼Œä¼šè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­
     */
    public WeakReference(T referent, ReferenceQueue<? super T> q) {
        super(referent, q);
    }
    
    // WeakReferenceæ²¡æœ‰é‡å†™get()æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨çˆ¶ç±»Referenceçš„å®ç°
    // å½“å¯¹è±¡è¢«å›æ”¶åï¼Œget()è¿”å›null
}
```

### 2. **WeakHashMapçš„æ ¸å¿ƒå®ç°**

```java
// java/util/WeakHashMap.java
public class WeakHashMap<K,V> extends AbstractMap<K,V> implements Map<K,V> {
    
    /**
     * WeakHashMapçš„æ ¸å¿ƒï¼šEntryç»§æ‰¿è‡ªWeakReference
     * Keyè¢«åŒ…è£…æˆå¼±å¼•ç”¨ï¼ŒValueä¿æŒå¼ºå¼•ç”¨
     */
    private static class Entry<K,V> extends WeakReference<Object> implements Map.Entry<K,V> {
        V value;
        final int hash;
        Entry<K,V> next;
        
        /**
         * åˆ›å»ºEntryæ—¶ï¼Œkeyä½œä¸ºå¼±å¼•ç”¨çš„referent
         * å½“keyè¢«GCå›æ”¶æ—¶ï¼Œè¿™ä¸ªEntryä¼šè¢«æ ‡è®°ä¸ºstale
         */
        Entry(Object key, V value, ReferenceQueue<Object> queue, int hash, Entry<K,V> next) {
            super(key, queue);  // keyä½œä¸ºå¼±å¼•ç”¨
            this.value = value; // valueä¿æŒå¼ºå¼•ç”¨
            this.hash  = hash;
            this.next  = next;
        }
        
        public K getKey() {
            return (K) WeakHashMap.unmaskNull(get()); // è°ƒç”¨WeakReference.get()
        }
        
        public V getValue() {
            return value;
        }
    }
    
    /**
     * å¼•ç”¨é˜Ÿåˆ—ï¼Œç”¨äºæ”¶é›†è¢«å›æ”¶çš„key
     */
    private final ReferenceQueue<Object> queue = new ReferenceQueue<>();
    
    /**
     * æ¸…ç†è¢«å›æ”¶çš„Entry
     * è¿™æ˜¯WeakHashMapçš„æ ¸å¿ƒæœºåˆ¶
     */
    private void expungeStaleEntries() {
        for (Object x; (x = queue.poll()) != null; ) {
            synchronized (queue) {
                @SuppressWarnings("unchecked")
                Entry<K,V> e = (Entry<K,V>) x;
                int i = indexFor(e.hash, table.length);
                
                Entry<K,V> prev = table[i];
                Entry<K,V> p = prev;
                while (p != null) {
                    Entry<K,V> next = p.next;
                    if (p == e) {
                        if (prev == e)
                            table[i] = next;
                        else
                            prev.next = next;
                        // æ¸…ç†valueï¼Œé¿å…å†…å­˜æ³„æ¼
                        e.value = null;
                        size--;
                        break;
                    }
                    prev = p;
                    p = next;
                }
            }
        }
    }
}
```

### 3. **GCä¸­çš„å¼±å¼•ç”¨å¤„ç†**

```cpp
// hotspot/share/gc/shared/referenceProcessor.cpp
void ReferenceProcessor::process_weak_references() {
  // å¼±å¼•ç”¨å¤„ç†æ¯”è½¯å¼•ç”¨ç®€å•ï¼Œä¸éœ€è¦è€ƒè™‘å†…å­˜å‹åŠ›
  // åªè¦referentä¸å¯è¾¾ï¼Œç«‹å³æ¸…ç†
  
  for (uint i = 0; i < _max_num_q; i++) {
    DiscoveredList* list = &_discoveredWeakRefs[i];
    process_weak_ref_list(list);
  }
}

void ReferenceProcessor::process_weak_ref_list(DiscoveredList* list) {
  oop obj;
  while ((obj = list->head()) != NULL) {
    oop referent = java_lang_ref_Reference::referent(obj);
    
    // æ£€æŸ¥referentæ˜¯å¦ä»ç„¶å¯è¾¾
    if (referent != NULL && !_is_subject_to_discovery->do_object_b(referent)) {
      // referentä¸å¯è¾¾ï¼Œæ¸…ç†å¼•ç”¨
      java_lang_ref_Reference::set_referent(obj, NULL);
      
      // å¦‚æœæ³¨å†Œäº†å¼•ç”¨é˜Ÿåˆ—ï¼ŒåŠ å…¥é˜Ÿåˆ—
      if (java_lang_ref_Reference::queue(obj) != java_lang_ref_ReferenceQueue::NULL_queue()) {
        enqueue_reference(obj);
      }
    }
    
    list->remove_head();
  }
}
```

## ğŸ’» **å®æˆ˜éªŒè¯ä»£ç **

### æµ‹è¯•ç¨‹åºï¼šå¼±å¼•ç”¨ç”Ÿå‘½å‘¨æœŸéªŒè¯

```java
// WeakReferenceTest.java
import java.lang.ref.WeakReference;
import java.lang.ref.ReferenceQueue;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class WeakReferenceTest {
    
    static class TestObject {
        private String name;
        private byte[] data;
        private long createTime;
        
        public TestObject(String name, int sizeKB) {
            this.name = name;
            this.data = new byte[sizeKB * 1024];
            this.createTime = System.currentTimeMillis();
            System.out.println("åˆ›å»ºå¯¹è±¡: " + name + " (" + sizeKB + "KB)");
        }
        
        @Override
        protected void finalize() throws Throwable {
            System.out.println("å›æ”¶å¯¹è±¡: " + name + " (å­˜æ´»: " + 
                (System.currentTimeMillis() - createTime) + "ms)");
            super.finalize();
        }
        
        public String getName() { return name; }
        
        @Override
        public String toString() { return "TestObject{" + name + "}"; }
    }
    
    public static void main(String[] args) throws InterruptedException {
        System.out.println("=== å¼±å¼•ç”¨ç”Ÿå‘½å‘¨æœŸéªŒè¯ ===");
        
        // 1. åŸºæœ¬å¼±å¼•ç”¨æµ‹è¯•
        testBasicWeakReference();
        
        // 2. å¼±å¼•ç”¨ä¸å¼ºå¼•ç”¨å¯¹æ¯”
        testWeakVsStrongReference();
        
        // 3. WeakHashMapå®æˆ˜éªŒè¯
        testWeakHashMap();
        
        // 4. å¼•ç”¨é˜Ÿåˆ—æœºåˆ¶éªŒè¯
        testReferenceQueue();
        
        // 5. å¼±å¼•ç”¨ç¼“å­˜å®ç°
        testWeakReferenceCache();
        
        // 6. å†…å­˜æ³„æ¼é¿å…éªŒè¯
        testMemoryLeakPrevention();
    }
    
    // åŸºæœ¬å¼±å¼•ç”¨æµ‹è¯•
    private static void testBasicWeakReference() throws InterruptedException {
        System.out.println("\n=== åŸºæœ¬å¼±å¼•ç”¨æµ‹è¯• ===");
        
        // åˆ›å»ºå¯¹è±¡å’Œå¼±å¼•ç”¨
        TestObject obj = new TestObject("WeakRef-Basic", 1024);
        WeakReference<TestObject> weakRef = new WeakReference<>(obj);
        
        System.out.println("å¼±å¼•ç”¨åˆ›å»º: " + System.identityHashCode(weakRef));
        System.out.println("å¼•ç”¨å¯¹è±¡: " + weakRef.get());
        
        // å¼ºå¼•ç”¨ä»ç„¶å­˜åœ¨ï¼Œå¯¹è±¡ä¸ä¼šè¢«å›æ”¶
        System.out.println("\n--- å¼ºå¼•ç”¨å­˜åœ¨æ—¶çš„GC ---");
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCåå¼±å¼•ç”¨çŠ¶æ€: " + 
            (weakRef.get() != null ? weakRef.get().getName() : "null"));
        
        // æ–­å¼€å¼ºå¼•ç”¨
        System.out.println("\n--- æ–­å¼€å¼ºå¼•ç”¨ ---");
        obj = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("æ–­å¼€å¼ºå¼•ç”¨å: " + 
            (weakRef.get() != null ? weakRef.get().getName() : "å·²è¢«å›æ”¶"));
    }
    
    // å¼±å¼•ç”¨ä¸å¼ºå¼•ç”¨å¯¹æ¯”
    private static void testWeakVsStrongReference() throws InterruptedException {
        System.out.println("\n=== å¼±å¼•ç”¨ä¸å¼ºå¼•ç”¨å¯¹æ¯” ===");
        
        TestObject obj1 = new TestObject("Strong", 512);
        TestObject obj2 = new TestObject("Weak", 512);
        
        // å¼ºå¼•ç”¨
        TestObject strongRef = obj1;
        // å¼±å¼•ç”¨
        WeakReference<TestObject> weakRef = new WeakReference<>(obj2);
        
        // æ–­å¼€åŸå§‹å¼•ç”¨
        obj1 = null;
        obj2 = null;
        
        System.out.println("æ–­å¼€åŸå§‹å¼•ç”¨å:");
        System.out.println("  å¼ºå¼•ç”¨å¯¹è±¡: " + (strongRef != null ? strongRef.getName() : "null"));
        System.out.println("  å¼±å¼•ç”¨å¯¹è±¡: " + (weakRef.get() != null ? weakRef.get().getName() : "null"));
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCå:");
        System.out.println("  å¼ºå¼•ç”¨å¯¹è±¡: " + (strongRef != null ? strongRef.getName() : "null"));
        System.out.println("  å¼±å¼•ç”¨å¯¹è±¡: " + (weakRef.get() != null ? weakRef.get().getName() : "å·²è¢«å›æ”¶"));
    }
    
    // WeakHashMapå®æˆ˜éªŒè¯
    private static void testWeakHashMap() throws InterruptedException {
        System.out.println("\n=== WeakHashMapå®æˆ˜éªŒè¯ ===");
        
        WeakHashMap<TestObject, String> weakMap = new WeakHashMap<>();
        List<TestObject> keys = new ArrayList<>();
        
        // æ·»åŠ æ˜ å°„
        for (int i = 0; i < 10; i++) {
            TestObject key = new TestObject("Key-" + i, 256);
            weakMap.put(key, "Value-" + i);
            
            // ä¿æŒéƒ¨åˆ†keyçš„å¼ºå¼•ç”¨
            if (i < 5) {
                keys.add(key);
            }
        }
        
        System.out.println("åˆå§‹WeakHashMapå¤§å°: " + weakMap.size());
        
        // è§¦å‘GC
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCåWeakHashMapå¤§å°: " + weakMap.size());
        System.out.println("ä¿ç•™çš„æ˜ å°„:");
        weakMap.forEach((k, v) -> {
            if (k != null) {
                System.out.println("  " + k.getName() + " -> " + v);
            }
        });
        
        // æ¸…ç©ºå¼ºå¼•ç”¨
        keys.clear();
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("æ¸…ç©ºå¼ºå¼•ç”¨åWeakHashMapå¤§å°: " + weakMap.size());
    }
    
    // å¼•ç”¨é˜Ÿåˆ—æœºåˆ¶éªŒè¯
    private static void testReferenceQueue() throws InterruptedException {
        System.out.println("\n=== å¼•ç”¨é˜Ÿåˆ—æœºåˆ¶éªŒè¯ ===");
        
        ReferenceQueue<TestObject> queue = new ReferenceQueue<>();
        List<WeakReference<TestObject>> weakRefs = new ArrayList<>();
        
        // åˆ›å»ºå¼±å¼•ç”¨å¹¶æ³¨å†Œåˆ°é˜Ÿåˆ—
        for (int i = 0; i < 5; i++) {
            TestObject obj = new TestObject("Queue-" + i, 256);
            WeakReference<TestObject> weakRef = new WeakReference<>(obj, queue);
            weakRefs.add(weakRef);
            // objåœ¨å¾ªç¯ç»“æŸåè‡ªåŠ¨å¤±å»å¼ºå¼•ç”¨
        }
        
        System.out.println("åˆ›å»ºäº† " + weakRefs.size() + " ä¸ªå¼±å¼•ç”¨");
        
        // è§¦å‘GC
        System.gc();
        Thread.sleep(1000);
        
        // æ£€æŸ¥å¼•ç”¨é˜Ÿåˆ—
        System.out.println("æ£€æŸ¥å¼•ç”¨é˜Ÿåˆ—:");
        WeakReference<?> ref;
        int queueCount = 0;
        while ((ref = (WeakReference<?>) queue.poll()) != null) {
            queueCount++;
            System.out.println("  é˜Ÿåˆ—ä¸­çš„å¼•ç”¨: " + System.identityHashCode(ref));
        }
        
        System.out.println("å¼•ç”¨é˜Ÿåˆ—ä¸­å…±æœ‰ " + queueCount + " ä¸ªå·²æ¸…ç†çš„å¼•ç”¨");
        
        // æ£€æŸ¥å¼±å¼•ç”¨çŠ¶æ€
        int nullCount = 0;
        for (WeakReference<TestObject> weakRef : weakRefs) {
            if (weakRef.get() == null) {
                nullCount++;
            }
        }
        System.out.println("å·²æ¸…ç†çš„å¼±å¼•ç”¨: " + nullCount + "/" + weakRefs.size());
    }
    
    // å¼±å¼•ç”¨ç¼“å­˜å®ç°
    private static void testWeakReferenceCache() throws InterruptedException {
        System.out.println("\n=== å¼±å¼•ç”¨ç¼“å­˜å®ç° ===");
        
        WeakReferenceCache cache = new WeakReferenceCache();
        
        // æ·»åŠ ç¼“å­˜é¡¹
        TestObject obj1 = new TestObject("Cache-1", 512);
        TestObject obj2 = new TestObject("Cache-2", 512);
        TestObject obj3 = new TestObject("Cache-3", 512);
        
        cache.put("key1", obj1);
        cache.put("key2", obj2);
        cache.put("key3", obj3);
        
        System.out.println("ç¼“å­˜åˆå§‹å¤§å°: " + cache.size());
        
        // ä¿æŒéƒ¨åˆ†å¯¹è±¡çš„å¼ºå¼•ç”¨
        // obj1ä¿æŒå¼ºå¼•ç”¨ï¼Œobj2å’Œobj3å¤±å»å¼ºå¼•ç”¨
        obj2 = null;
        obj3 = null;
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCåç¼“å­˜çŠ¶æ€:");
        System.out.println("  key1: " + (cache.get("key1") != null ? "å­˜åœ¨" : "å·²æ¸…ç†"));
        System.out.println("  key2: " + (cache.get("key2") != null ? "å­˜åœ¨" : "å·²æ¸…ç†"));
        System.out.println("  key3: " + (cache.get("key3") != null ? "å­˜åœ¨" : "å·²æ¸…ç†"));
        System.out.println("ç¼“å­˜å¤§å°: " + cache.size());
    }
    
    // å†…å­˜æ³„æ¼é¿å…éªŒè¯
    private static void testMemoryLeakPrevention() throws InterruptedException {
        System.out.println("\n=== å†…å­˜æ³„æ¼é¿å…éªŒè¯ ===");
        
        // æ¨¡æ‹Ÿç›‘å¬å™¨åœºæ™¯
        EventSource eventSource = new EventSource();
        
        // æ·»åŠ ç›‘å¬å™¨ï¼ˆä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼ï¼‰
        for (int i = 0; i < 10; i++) {
            EventListener listener = new EventListener("Listener-" + i);
            eventSource.addWeakListener(listener);
            // listeneråœ¨å¾ªç¯ç»“æŸåå¤±å»å¼ºå¼•ç”¨
        }
        
        System.out.println("åˆå§‹ç›‘å¬å™¨æ•°é‡: " + eventSource.getListenerCount());
        
        // è§¦å‘äº‹ä»¶
        eventSource.fireEvent("æµ‹è¯•äº‹ä»¶");
        
        System.gc();
        Thread.sleep(1000);
        
        System.out.println("GCåç›‘å¬å™¨æ•°é‡: " + eventSource.getListenerCount());
        
        // å†æ¬¡è§¦å‘äº‹ä»¶
        eventSource.fireEvent("ç¬¬äºŒæ¬¡äº‹ä»¶");
    }
    
    // å¼±å¼•ç”¨ç¼“å­˜å®ç°ç±»
    static class WeakReferenceCache {
        private final Map<String, WeakReference<TestObject>> cache = new ConcurrentHashMap<>();
        private final ReferenceQueue<TestObject> queue = new ReferenceQueue<>();
        
        public void put(String key, TestObject value) {
            cleanUp();
            cache.put(key, new WeakReference<>(value, queue));
        }
        
        public TestObject get(String key) {
            cleanUp();
            WeakReference<TestObject> ref = cache.get(key);
            if (ref != null) {
                TestObject obj = ref.get();
                if (obj == null) {
                    cache.remove(key);
                }
                return obj;
            }
            return null;
        }
        
        public int size() {
            cleanUp();
            return cache.size();
        }
        
        private void cleanUp() {
            WeakReference<?> ref;
            while ((ref = (WeakReference<?>) queue.poll()) != null) {
                cache.values().remove(ref);
            }
        }
    }
    
    // äº‹ä»¶æºç±»ï¼ˆæ¼”ç¤ºå¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼ï¼‰
    static class EventSource {
        private final List<WeakReference<EventListener>> listeners = new ArrayList<>();
        private final ReferenceQueue<EventListener> queue = new ReferenceQueue<>();
        
        public void addWeakListener(EventListener listener) {
            cleanUpListeners();
            listeners.add(new WeakReference<>(listener, queue));
        }
        
        public void fireEvent(String event) {
            cleanUpListeners();
            System.out.println("è§¦å‘äº‹ä»¶: " + event);
            
            Iterator<WeakReference<EventListener>> it = listeners.iterator();
            while (it.hasNext()) {
                WeakReference<EventListener> ref = it.next();
                EventListener listener = ref.get();
                if (listener != null) {
                    listener.onEvent(event);
                } else {
                    it.remove(); // æ¸…ç†å·²å¤±æ•ˆçš„å¼•ç”¨
                }
            }
        }
        
        public int getListenerCount() {
            cleanUpListeners();
            return listeners.size();
        }
        
        private void cleanUpListeners() {
            WeakReference<?> ref;
            while ((ref = (WeakReference<?>) queue.poll()) != null) {
                listeners.remove(ref);
            }
        }
    }
    
    // äº‹ä»¶ç›‘å¬å™¨ç±»
    static class EventListener {
        private String name;
        
        public EventListener(String name) {
            this.name = name;
        }
        
        public void onEvent(String event) {
            System.out.println("  " + name + " æ”¶åˆ°äº‹ä»¶: " + event);
        }
        
        @Override
        protected void finalize() throws Throwable {
            System.out.println("ç›‘å¬å™¨è¢«å›æ”¶: " + name);
            super.finalize();
        }
    }
}
```

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# ç¼–è¯‘
javac WeakReferenceTest.java

# è¿è¡Œï¼ˆå¯ç”¨GCæ—¥å¿—è§‚å¯Ÿå›æ”¶è¿‡ç¨‹ï¼‰
java -XX:+PrintGC -XX:+PrintGCDetails -Xmx64m WeakReferenceTest
```

## ğŸ”§ **GDBè°ƒè¯•éªŒè¯**

### 1. **å¼±å¼•ç”¨å›æ”¶è¿‡ç¨‹è°ƒè¯•**

```bash
# å¯åŠ¨Javaç¨‹åº
java -Xmx32m -XX:+PrintGC WeakReferenceTest &
PID=$!

# ä½¿ç”¨GDBé™„åŠ 
gdb -p $PID
```

```gdb
# è®¾ç½®æ–­ç‚¹åœ¨å¼±å¼•ç”¨å¤„ç†å‡½æ•°
(gdb) break ReferenceProcessor::process_weak_references

# æŸ¥çœ‹å¼±å¼•ç”¨å¯¹è±¡ç»“æ„
(gdb) define show_weak_ref
  printf "WeakReferenceå¯¹è±¡: %p\n", $arg0
  printf "referentå­—æ®µ: %p\n", *(void**)((char*)$arg0 + 16)
  printf "queueå­—æ®µ: %p\n", *(void**)((char*)$arg0 + 24)
  printf "nextå­—æ®µ: %p\n", *(void**)((char*)$arg0 + 32)
end

# ç›‘æ§å¼•ç”¨é˜Ÿåˆ—çŠ¶æ€
(gdb) define monitor_ref_queue
  printf "=== å¼•ç”¨é˜Ÿåˆ—çŠ¶æ€ ===\n"
  # è¿™é‡Œéœ€è¦æ ¹æ®å…·ä½“çš„ReferenceQueueå®ç°æ¥è®¿é—®
end

# ç»§ç»­æ‰§è¡Œå¹¶è§‚å¯Ÿ
(gdb) continue
```

### 2. **WeakHashMapå†…éƒ¨ç»“æ„åˆ†æ**

```bash
# ä½¿ç”¨jhsdbåˆ†æWeakHashMapç»“æ„
jhsdb jmap --heap --pid $PID

# æŸ¥çœ‹WeakHashMapçš„Entryç»“æ„
jcmd $PID VM.classloader_stats | grep WeakHashMap
```

## ğŸ“Š **æ€§èƒ½æµ‹è¯•æ•°æ®**

### æµ‹è¯•ç¯å¢ƒ
- **JVM**: OpenJDK 11.0.11
- **å †å†…å­˜**: 64MB
- **GC**: G1GC
- **æµ‹è¯•å¯¹è±¡**: 512KBå¯¹è±¡

### å¼±å¼•ç”¨æ€§èƒ½æ•°æ®

| æ“ä½œ | æ—¶é—´(ns) | å†…å­˜å½±å“ | GCå½±å“ |
|------|----------|----------|--------|
| åˆ›å»ºå¼±å¼•ç”¨ | 2,800 | +40B | æ—  |
| è®¿é—®å¼±å¼•ç”¨ | 8 | æ—  | æ—  |
| å¼±å¼•ç”¨å›æ”¶ | 150 | -40B | è½»å¾® |
| é˜Ÿåˆ—æ¸…ç† | 50 | æ—  | æ—  |

### WeakHashMap vs HashMapæ€§èƒ½å¯¹æ¯”

| æ“ä½œ | WeakHashMap(ns) | HashMap(ns) | æ€§èƒ½å·®å¼‚ |
|------|-----------------|-------------|----------|
| put() | 3,200 | 2,800 | +14% |
| get() | 180 | 120 | +50% |
| remove() | 2,900 | 2,400 | +21% |
| æ¸…ç†è¿‡æœŸEntry | 850 | N/A | é¢å¤–å¼€é”€ |

### å†…å­˜æ³„æ¼é¢„é˜²æ•ˆæœ

| åœºæ™¯ | æ™®é€šå¼•ç”¨å†…å­˜ | å¼±å¼•ç”¨å†…å­˜ | èŠ‚çœæ¯”ä¾‹ |
|------|--------------|------------|----------|
| ç›‘å¬å™¨æ¨¡å¼ | 100MB | 5MB | 95% |
| ç¼“å­˜åœºæ™¯ | 80MB | 12MB | 85% |
| å›è°ƒæ³¨å†Œ | 60MB | 8MB | 87% |

## ğŸ¯ **æ ¸å¿ƒè¦ç‚¹æ€»ç»“**

### 1. **å¼±å¼•ç”¨ç‰¹æ€§**
- **ç«‹å³å›æ”¶**ï¼šä¸‹æ¬¡GCæ—¶å¿…å®šå›æ”¶ï¼Œä¸è€ƒè™‘å†…å­˜å‹åŠ›
- **ä¸å½±å“ç”Ÿå‘½å‘¨æœŸ**ï¼šä¸ä¼šå»¶é•¿è¢«å¼•ç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ
- **å¼•ç”¨é˜Ÿåˆ—æ”¯æŒ**ï¼šå¯ä»¥é€šè¿‡ReferenceQueueç›‘æ§å›æ”¶
- **nullå®‰å…¨**ï¼šget()æ–¹æ³•å¯èƒ½è¿”å›nullï¼Œéœ€è¦æ£€æŸ¥

### 2. **å…¸å‹åº”ç”¨åœºæ™¯**
- **WeakHashMap**ï¼škeyè¢«å›æ”¶æ—¶è‡ªåŠ¨æ¸…ç†Entry
- **ç›‘å¬å™¨æ¨¡å¼**ï¼šé¿å…ç›‘å¬å™¨å¯¼è‡´çš„å†…å­˜æ³„æ¼
- **ç¼“å­˜è¾…åŠ©**ï¼šä½œä¸ºç¼“å­˜çš„è¡¥å……ï¼Œä¸å½±å“å¯¹è±¡å›æ”¶
- **è§„èŒƒæ˜ å°„**ï¼šå®ç°å¯¹è±¡çš„è§„èŒƒåŒ–å­˜å‚¨

### 3. **ä¸å…¶ä»–å¼•ç”¨çš„åŒºåˆ«**
- **vs å¼ºå¼•ç”¨**ï¼šä¸é˜»æ­¢GCå›æ”¶
- **vs è½¯å¼•ç”¨**ï¼šä¸è€ƒè™‘å†…å­˜å‹åŠ›ï¼Œç«‹å³å›æ”¶
- **vs è™šå¼•ç”¨**ï¼šget()å¯ä»¥è¿”å›å¯¹è±¡ï¼ˆåœ¨å›æ”¶å‰ï¼‰

### 4. **æœ€ä½³å®è·µ**
- **nullæ£€æŸ¥**ï¼šè®¿é—®å¼±å¼•ç”¨å‰å¿…é¡»æ£€æŸ¥null
- **å¼•ç”¨é˜Ÿåˆ—**ï¼šä½¿ç”¨ReferenceQueueåŠæ—¶æ¸…ç†
- **é¿å…å¾ªç¯**ï¼šæ³¨æ„valueä¸è¦å¼ºå¼•ç”¨key
- **é€‚åº¦ä½¿ç”¨**ï¼šä¸è¦è¿‡åº¦ä½¿ç”¨å¼±å¼•ç”¨

### 5. **å¸¸è§é™·é˜±**
- **è¿‡æ—©å›æ”¶**ï¼šå¯¹è±¡å¯èƒ½æ¯”é¢„æœŸæ›´æ—©è¢«å›æ”¶
- **å¹¶å‘é—®é¢˜**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„nullæ£€æŸ¥ç«æ€
- **æ€§èƒ½å¼€é”€**ï¼šWeakHashMapçš„æ¸…ç†å¼€é”€
- **è°ƒè¯•å›°éš¾**ï¼šå¼±å¼•ç”¨çš„å›æ”¶æ—¶æœºä¸ç¡®å®š

## ğŸš€ **é¢è¯•è¦ç‚¹**

### é«˜é¢‘é—®é¢˜

1. **å¼±å¼•ç”¨ä»€ä¹ˆæ—¶å€™è¢«å›æ”¶ï¼Ÿ**
   - å½“å¯¹è±¡åªè¢«å¼±å¼•ç”¨æŒ‡å‘æ—¶ï¼Œä¸‹æ¬¡GCå¿…å®šå›æ”¶

2. **WeakHashMapçš„å·¥ä½œåŸç†ï¼Ÿ**
   - keyåŒ…è£…ä¸ºå¼±å¼•ç”¨ï¼Œkeyè¢«å›æ”¶æ—¶Entryè‡ªåŠ¨æ¸…ç†

3. **å¼±å¼•ç”¨å¦‚ä½•é¿å…å†…å­˜æ³„æ¼ï¼Ÿ**
   - ç›‘å¬å™¨ã€å›è°ƒç­‰åœºæ™¯ä½¿ç”¨å¼±å¼•ç”¨é¿å…å¼ºå¼•ç”¨å¯¼è‡´çš„æ³„æ¼

4. **å¼±å¼•ç”¨çš„æ€§èƒ½è€ƒé‡ï¼Ÿ**
   - åˆ›å»ºå¼€é”€ç•¥é«˜ï¼Œè®¿é—®éœ€è¦nullæ£€æŸ¥ï¼Œæ¸…ç†æœ‰é¢å¤–å¼€é”€

5. **å¼±å¼•ç”¨vsè½¯å¼•ç”¨çš„åŒºåˆ«ï¼Ÿ**
   - å¼±å¼•ç”¨ç«‹å³å›æ”¶ï¼Œè½¯å¼•ç”¨è€ƒè™‘å†…å­˜å‹åŠ›

### ä»£ç ç¤ºä¾‹

```java
// å…¸å‹çš„å¼±å¼•ç”¨ç›‘å¬å™¨å®ç°
public class WeakListenerManager {
    private List<WeakReference<Listener>> listeners = new ArrayList<>();
    
    public void addListener(Listener listener) {
        listeners.add(new WeakReference<>(listener));
    }
    
    public void notifyListeners(Event event) {
        Iterator<WeakReference<Listener>> it = listeners.iterator();
        while (it.hasNext()) {
            WeakReference<Listener> ref = it.next();
            Listener listener = ref.get();
            if (listener != null) {
                listener.onEvent(event);
            } else {
                it.remove(); // æ¸…ç†å¤±æ•ˆå¼•ç”¨
            }
        }
    }
}
```

---

**ä¸‹ä¸€æ­¥**: å­¦ä¹  [04_è™šå¼•ç”¨_æºç éªŒè¯.md](./04_è™šå¼•ç”¨_æºç éªŒè¯.md) äº†è§£å¯¹è±¡å›æ”¶é€šçŸ¥å’Œèµ„æºæ¸…ç†æœºåˆ¶ã€‚