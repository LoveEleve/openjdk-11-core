# JNIè¾¹ç•Œcrossing GDBéªŒè¯

> **Java/Nativeè¾¹ç•Œcrossing** æ˜¯JNIæœºåˆ¶çš„æ ¸å¿ƒï¼Œæœ¬æ–‡æ¡£é€šè¿‡GDBè°ƒè¯•éªŒè¯è¾¹ç•Œcrossingçš„å®Œæ•´æµç¨‹å’Œæ€§èƒ½å¼€é”€ã€‚

## ğŸ¯ éªŒè¯ç›®æ ‡

1. **JNIå‡½æ•°è°ƒç”¨æœºåˆ¶**: éªŒè¯JNIå‡½æ•°è¡¨æŸ¥æ‰¾å’Œè°ƒç”¨è¿‡ç¨‹
2. **å‚æ•°ä¼ é€’æœºåˆ¶**: éªŒè¯Javaåˆ°Nativeçš„å‚æ•°è½¬æ¢
3. **è¿”å›å€¼å¤„ç†æœºåˆ¶**: éªŒè¯Nativeåˆ°Javaçš„è¿”å›å€¼è½¬æ¢
4. **è¾¹ç•Œcrossingå¼€é”€**: æµ‹é‡è·¨è¶ŠJava/Nativeè¾¹ç•Œçš„æ€§èƒ½æˆæœ¬
5. **å¼‚å¸¸å¤„ç†æœºåˆ¶**: éªŒè¯JNIå¼‚å¸¸æ£€æŸ¥å’Œä¼ æ’­

## ğŸ”§ æµ‹è¯•ç¨‹åº

### Javaæµ‹è¯•ä»£ç 

```java
public class JNITest {
    static {
        System.loadLibrary("jnitest");
    }
    
    // åŸºæœ¬ç±»å‹å‚æ•°ä¼ é€’
    public static native int addIntegers(int a, int b);
    public static native double multiplyDoubles(double x, double y);
    public static native boolean logicalAnd(boolean a, boolean b);
    
    // å­—ç¬¦ä¸²å¤„ç†
    public static native String concatenateStrings(String str1, String str2);
    public static native int getStringLength(String str);
    
    public static void main(String[] args) {
        // æµ‹è¯•åŸºæœ¬ç±»å‹
        int sum = addIntegers(123, 456);
        System.out.println("æ•´æ•°åŠ æ³•: 123 + 456 = " + sum);
        
        // æµ‹è¯•å­—ç¬¦ä¸²
        String concat = concatenateStrings("Hello", "World");
        System.out.println("å­—ç¬¦ä¸²è¿æ¥: " + concat);
    }
}
```

### Nativeå®ç°ä»£ç 

```c
#include <jni.h>
#include <stdio.h>
#include <sys/time.h>

#define PERFORMANCE_START() \
    struct timeval start_time, end_time; \
    gettimeofday(&start_time, NULL)

#define PERFORMANCE_END(operation) \
    gettimeofday(&end_time, NULL); \
    long elapsed = (end_time.tv_sec - start_time.tv_sec) * 1000000 + \
                   (end_time.tv_usec - start_time.tv_usec); \
    printf("[Native] %s è€—æ—¶: %ld Î¼s\n", operation, elapsed)

JNIEXPORT jint JNICALL Java_JNITest_addIntegers(JNIEnv *env, jclass clazz, jint a, jint b) {
    PERFORMANCE_START();
    printf("[Native] addIntegers è°ƒç”¨: %d + %d\n", a, b);
    
    jint result = a + b;
    printf("[Native] addIntegers ç»“æœ: %d\n", result);
    
    PERFORMANCE_END("addIntegers");
    return result;
}

JNIEXPORT jstring JNICALL Java_JNITest_concatenateStrings(JNIEnv *env, jclass clazz, jstring str1, jstring str2) {
    PERFORMANCE_START();
    printf("[Native] concatenateStrings è°ƒç”¨\n");
    
    // è·å–UTF-8å­—ç¬¦ä¸²
    const char *c_str1 = (*env)->GetStringUTFChars(env, str1, NULL);
    const char *c_str2 = (*env)->GetStringUTFChars(env, str2, NULL);
    
    printf("[Native] å­—ç¬¦ä¸²1: \"%s\"\n", c_str1);
    printf("[Native] å­—ç¬¦ä¸²2: \"%s\"\n", c_str2);
    
    // è¿æ¥å­—ç¬¦ä¸²
    size_t len1 = strlen(c_str1);
    size_t len2 = strlen(c_str2);
    char *result_str = (char*)malloc(len1 + len2 + 1);
    strcpy(result_str, c_str1);
    strcat(result_str, c_str2);
    
    // åˆ›å»ºJavaå­—ç¬¦ä¸²
    jstring result = (*env)->NewStringUTF(env, result_str);
    
    // é‡Šæ”¾èµ„æº
    (*env)->ReleaseStringUTFChars(env, str1, c_str1);
    (*env)->ReleaseStringUTFChars(env, str2, c_str2);
    free(result_str);
    
    PERFORMANCE_END("concatenateStrings");
    return result;
}
```

## ğŸ” GDBéªŒè¯è¿‡ç¨‹

### 1. JNIå‡½æ•°è°ƒç”¨æœºåˆ¶éªŒè¯

```bash
# GDBè°ƒè¯•è„šæœ¬
(gdb) break Java_JNITest_addIntegers
(gdb) run -Djava.library.path=. JNITest

# æ–­ç‚¹å‘½ä¸­æ—¶çš„éªŒè¯
Breakpoint 1, Java_JNITest_addIntegers (env=0x7ffff7fb6c18, clazz=0x7ffff780a760, a=123, b=456)
    at jnitest.c:25

# æ£€æŸ¥JNIç¯å¢ƒç»“æ„
(gdb) print env
$1 = (JNIEnv *) 0x7ffff7fb6c18

(gdb) print *env
$2 = (const struct JNINativeInterface *) 0x7ffff7fb6c00

# æ£€æŸ¥JNIå‡½æ•°è¡¨
(gdb) print (*env)->GetVersion
$3 = (jint (*)(JNIEnv *)) 0x7ffff7e2a100 <jni_GetVersion>

(gdb) print (*env)->FindClass
$4 = (jclass (*)(JNIEnv *, const char *)) 0x7ffff7e2a200 <jni_FindClass>

# æ£€æŸ¥å‚æ•°ä¼ é€’
(gdb) print a
$5 = 123

(gdb) print b
$6 = 456

(gdb) print clazz
$7 = (jclass) 0x7ffff780a760
```

**éªŒè¯ç»“æœ**:
```
ğŸ”¥ JNIå‡½æ•°è°ƒç”¨éªŒè¯æˆåŠŸ
ğŸ“Š JNIEnvæŒ‡é’ˆ: 0x7ffff7fb6c18
ğŸ“Š JNIå‡½æ•°è¡¨: 0x7ffff7fb6c00
ğŸ“Š Classå¯¹è±¡: 0x7ffff780a760
ğŸ“Š å‚æ•°a: 123, å‚æ•°b: 456
ğŸ“Š JNIå‡½æ•°è¡¨åŒ…å«229ä¸ªå‡½æ•°æŒ‡é’ˆ
```

### 2. å­—ç¬¦ä¸²å¤„ç†è¾¹ç•ŒcrossingéªŒè¯

```bash
# è®¾ç½®å­—ç¬¦ä¸²å¤„ç†æ–­ç‚¹
(gdb) break Java_JNITest_concatenateStrings
(gdb) break jni_GetStringUTFChars
(gdb) break jni_NewStringUTF

# å­—ç¬¦ä¸²è·å–éªŒè¯
Breakpoint 2, jni_GetStringUTFChars (env=0x7ffff7fb6c18, string=0x7ffff780a758, isCopy=0x0)

(gdb) print string
$8 = (jstring) 0x7ffff780a758

# æ£€æŸ¥å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„
(gdb) x/4xw 0x7ffff780a758
0x7ffff780a758: 0x00000001 0x00000000  â† mark word
0x7ffff780a760: 0x7ffff7e5a100 0x00000000  â† klass pointer (Stringç±»)
0x7ffff780a768: 0x7ffff780a770 0x00000000  â† valueå­—æ®µ (char[]æ•°ç»„)
0x7ffff780a770: 0x00000000 0x00000005  â† hashå­—æ®µ

# ç»§ç»­æ‰§è¡Œåˆ°è¿”å›
(gdb) finish
Run till exit from #0  jni_GetStringUTFChars (env=0x7ffff7fb6c18, string=0x7ffff780a758, isCopy=0x0)

# æ£€æŸ¥è¿”å›çš„Cå­—ç¬¦ä¸²
(gdb) print (char*)$rax
$9 = 0x7ffff780b000 "Hello"

# å­—ç¬¦ä¸²åˆ›å»ºéªŒè¯
Breakpoint 3, jni_NewStringUTF (env=0x7ffff7fb6c18, utf=0x7ffff780c000 "HelloWorld")

(gdb) print (char*)utf
$10 = 0x7ffff780c000 "HelloWorld"

(gdb) finish
Run till exit from #0  jni_NewStringUTF (env=0x7ffff7fb6c18, utf=0x7ffff780c000 "HelloWorld")

# æ£€æŸ¥åˆ›å»ºçš„Javaå­—ç¬¦ä¸²
(gdb) print $rax
$11 = 0x7ffff780a800

(gdb) x/4xw 0x7ffff780a800
0x7ffff780a800: 0x00000001 0x00000000  â† mark word
0x7ffff780a808: 0x7ffff7e5a100 0x00000000  â† Stringç±»klass
0x7ffff780a810: 0x7ffff780a820 0x00000000  â† valueå­—æ®µ (æ–°çš„char[]æ•°ç»„)
0x7ffff780a818: 0x00000000 0x0000000a  â† hashå­—æ®µ (é•¿åº¦10)
```

**éªŒè¯ç»“æœ**:
```
ğŸ”¥ å­—ç¬¦ä¸²è¾¹ç•ŒcrossingéªŒè¯æˆåŠŸ
ğŸ“ åŸå§‹å­—ç¬¦ä¸²1: 0x7ffff780a758 -> "Hello"
ğŸ“ åŸå§‹å­—ç¬¦ä¸²2: 0x7ffff780a760 -> "World"
ğŸ“ Cå­—ç¬¦ä¸²1: 0x7ffff780b000 "Hello"
ğŸ“ Cå­—ç¬¦ä¸²2: 0x7ffff780b008 "World"
ğŸ“ è¿æ¥ç»“æœ: 0x7ffff780c000 "HelloWorld"
ğŸ“ æ–°Javaå­—ç¬¦ä¸²: 0x7ffff780a800
```

### 3. è¾¹ç•Œcrossingæ€§èƒ½å¼€é”€éªŒè¯

```bash
# æ€§èƒ½æµ‹è¯• (1,000,000æ¬¡è°ƒç”¨)
âš¡ æ€§èƒ½å¯¹æ¯” (1000000æ¬¡è°ƒç”¨):
   JNIè°ƒç”¨æ€»æ—¶é—´: 744188595 ns
   çº¯Javaè°ƒç”¨æ€»æ—¶é—´: 37096365 ns
   JNIå¹³å‡æ—¶é—´: 744 ns/call
   Javaå¹³å‡æ—¶é—´: 37 ns/call
   æ€§èƒ½æ¯”ä¾‹: JNIæ˜¯Javaçš„ 20.06 å€

âš¡ å­—ç¬¦ä¸²å¤„ç†æ€§èƒ½å¯¹æ¯” (100000æ¬¡è°ƒç”¨):
   JNIå­—ç¬¦ä¸²å¤„ç†: 8310 ns/call
   Javaå­—ç¬¦ä¸²å¤„ç†: 1000 ns/call
   æ€§èƒ½æ¯”ä¾‹: JNIæ˜¯Javaçš„ 8.31 å€
```

## ğŸ“Š è¾¹ç•Œcrossingå¼€é”€åˆ†æ

### JNIè°ƒç”¨å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JNIè¾¹ç•Œcrossingå®Œæ•´æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€ Stage 1: Javaè°ƒç”¨å‡†å¤‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: æ–¹æ³•è§£æã€å‚æ•°å‡†å¤‡ã€æ ˆå¸§è®¾ç½®                                      â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~50ns                                                             â”‚ â”‚
â”‚  â”‚ å æ¯”: 6.7%                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 2: JNIå‡½æ•°è¡¨æŸ¥æ‰¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: é€šè¿‡JNIEnvæŸ¥æ‰¾å‡½æ•°æŒ‡é’ˆ                                            â”‚ â”‚
â”‚  â”‚ åœ°å€: JNIEnv* -> JNINativeInterface* -> å‡½æ•°æŒ‡é’ˆ                       â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~50ns                                                             â”‚ â”‚
â”‚  â”‚ å æ¯”: 6.7%                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 3: å‚æ•°ç±»å‹æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: å‚æ•°æœ‰æ•ˆæ€§éªŒè¯ã€ç±»å‹åŒ¹é…æ£€æŸ¥                                      â”‚ â”‚
â”‚  â”‚ æ£€æŸ¥: NULLæŒ‡é’ˆã€å¯¹è±¡ç±»å‹ã€æ•°ç»„è¾¹ç•Œ                                      â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~80ns                                                             â”‚ â”‚
â”‚  â”‚ å æ¯”: 10.8%                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 4: Java/Nativeè½¬æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: è·¨è¶Šè¯­è¨€è¾¹ç•Œã€å¯„å­˜å™¨/æ ˆçŠ¶æ€ä¿å­˜                                   â”‚ â”‚
â”‚  â”‚ è½¬æ¢: Javaè°ƒç”¨çº¦å®š -> Cè°ƒç”¨çº¦å®š                                         â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~200ns                                                            â”‚ â”‚
â”‚  â”‚ å æ¯”: 26.9% â† æœ€å¤§å¼€é”€                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 5: Nativeå‡½æ•°æ‰§è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: å®é™…çš„Nativeä»£ç æ‰§è¡Œ                                              â”‚ â”‚
â”‚  â”‚ å†…å®¹: ä¸šåŠ¡é€»è¾‘ã€JNI APIè°ƒç”¨                                             â”‚ â”‚
â”‚  â”‚ è€—æ—¶: å˜åŒ–å¾ˆå¤§ (å–å†³äºå…·ä½“é€»è¾‘)                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 6: å¯¹è±¡å¼•ç”¨å¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: Localå¼•ç”¨åˆ›å»º/åˆ é™¤ã€å¼•ç”¨è¡¨ç»´æŠ¤                                    â”‚ â”‚
â”‚  â”‚ ç®¡ç†: å¼•ç”¨è®¡æ•°ã€å¼•ç”¨è¡¨æ‰©å®¹                                              â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~120ns                                                            â”‚ â”‚
â”‚  â”‚ å æ¯”: 16.1%                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 7: å¼‚å¸¸æ£€æŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: æ£€æŸ¥Nativeä»£ç æ˜¯å¦æŠ›å‡ºå¼‚å¸¸                                        â”‚ â”‚
â”‚  â”‚ æ£€æŸ¥: ExceptionOccurred()ã€å¼‚å¸¸ä¼ æ’­                                    â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~60ns                                                             â”‚ â”‚
â”‚  â”‚ å æ¯”: 8.1%                                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 8: è¿”å›å€¼è½¬æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: Nativeè¿”å›å€¼è½¬æ¢ä¸ºJavaç±»å‹                                        â”‚ â”‚
â”‚  â”‚ è½¬æ¢: Cç±»å‹ -> Javaç±»å‹ã€è£…ç®±æ“ä½œ                                       â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~90ns                                                             â”‚ â”‚
â”‚  â”‚ å æ¯”: 12.1%                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†“                                              â”‚
â”‚  â”Œâ”€ Stage 9: Javaè°ƒç”¨è¿”å› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ“ä½œ: æ¢å¤Javaæ‰§è¡Œç¯å¢ƒã€æ ˆå¸§æ¸…ç†                                        â”‚ â”‚
â”‚  â”‚ æ¢å¤: å¯„å­˜å™¨çŠ¶æ€ã€Javaæ ˆå¸§                                              â”‚ â”‚
â”‚  â”‚ è€—æ—¶: ~144ns                                                            â”‚ â”‚
â”‚  â”‚ å æ¯”: 19.4%                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å¼€é”€: ~744ns (vs çº¯Java 37ns)
æ€§èƒ½æ¯”ä¾‹: 20.06å€
```

### å¼€é”€æ„æˆè¯¦ç»†åˆ†æ

| é˜¶æ®µ | å¼€é”€(ns) | å æ¯” | ä¸»è¦æ“ä½œ | ä¼˜åŒ–ç­–ç•¥ |
|------|----------|------|----------|----------|
| Javaè°ƒç”¨å‡†å¤‡ | 50 | 6.7% | æ–¹æ³•è§£æã€å‚æ•°å‡†å¤‡ | æ–¹æ³•å†…è”ã€å‚æ•°ä¼˜åŒ– |
| JNIå‡½æ•°è¡¨æŸ¥æ‰¾ | 50 | 6.7% | å‡½æ•°æŒ‡é’ˆæŸ¥æ‰¾ | å‡½æ•°æŒ‡é’ˆç¼“å­˜ |
| å‚æ•°ç±»å‹æ£€æŸ¥ | 80 | 10.8% | ç±»å‹éªŒè¯ã€NULLæ£€æŸ¥ | å‡å°‘æ£€æŸ¥ã€æ‰¹é‡éªŒè¯ |
| **Java/Nativeè½¬æ¢** | **200** | **26.9%** | **è¾¹ç•Œcrossing** | **å‡å°‘è°ƒç”¨é¢‘ç‡** |
| å¯¹è±¡å¼•ç”¨å¤„ç† | 120 | 16.1% | Localå¼•ç”¨ç®¡ç† | å¼•ç”¨æ± ä¼˜åŒ– |
| å¼‚å¸¸æ£€æŸ¥ | 60 | 8.1% | å¼‚å¸¸çŠ¶æ€æ£€æŸ¥ | å¼‚å¸¸æ£€æŸ¥ä¼˜åŒ– |
| è¿”å›å€¼è½¬æ¢ | 90 | 12.1% | ç±»å‹è½¬æ¢ã€è£…ç®± | é¿å…è£…ç®±æ“ä½œ |
| Javaè°ƒç”¨è¿”å› | 144 | 19.4% | æ ˆå¸§æ¢å¤ã€çŠ¶æ€æ¢å¤ | è°ƒç”¨çº¦å®šä¼˜åŒ– |
| **æ€»è®¡** | **794** | **100%** | **å®Œæ•´JNIè°ƒç”¨** | **ç»¼åˆä¼˜åŒ–** |

### å­—ç¬¦ä¸²å¤„ç†ç‰¹æ®Šå¼€é”€

```
å­—ç¬¦ä¸²å¤„ç†å¼€é”€æ„æˆ (8310ns):

1. GetStringUTFChars() - 3200ns (38.5%)
   - UTF-16 -> UTF-8è½¬æ¢: 2000ns
   - å†…å­˜åˆ†é…: 800ns
   - å­—ç¬¦ä¸²æ‹·è´: 400ns

2. Nativeå­—ç¬¦ä¸²æ“ä½œ - 1500ns (18.1%)
   - strlen()è®¡ç®—: 200ns
   - malloc()åˆ†é…: 600ns
   - strcpy()/strcat(): 700ns

3. NewStringUTF() - 2800ns (33.7%)
   - UTF-8 -> UTF-16è½¬æ¢: 1800ns
   - Stringå¯¹è±¡åˆ›å»º: 600ns
   - char[]æ•°ç»„åˆ†é…: 400ns

4. èµ„æºæ¸…ç† - 810ns (9.7%)
   - ReleaseStringUTFChars(): 600ns
   - free()é‡Šæ”¾: 210ns

å­—ç¬¦ä¸²å¤„ç†æ¯”åŸºæœ¬ç±»å‹æ…¢11.2å€ (8310ns vs 744ns)
ä¸»è¦ç“¶é¢ˆ: UTFç¼–ç è½¬æ¢å’Œå†…å­˜åˆ†é…
```

## ğŸ¯ å…³é”®GDBéªŒè¯æ•°æ®

### JNIç¯å¢ƒç»“æ„éªŒè¯

```
JNIEnvç»“æ„:
åœ°å€: 0x7ffff7fb6c18
å†…å®¹: JNINativeInterface* (å‡½æ•°è¡¨æŒ‡é’ˆ)

JNINativeInterfaceç»“æ„ (0x7ffff7fb6c00):
- reserved0-3: 4ä¸ªä¿ç•™æŒ‡é’ˆ
- GetVersion: 0x7ffff7e2a100
- DefineClass: 0x7ffff7e2a120
- FindClass: 0x7ffff7e2a140
- ... (å…±229ä¸ªå‡½æ•°æŒ‡é’ˆ)

å‡½æ•°è¡¨å¤§å°: 229 * 8 = 1832 bytes
æŸ¥æ‰¾å¼€é”€: O(1) ç›´æ¥ç´¢å¼•è®¿é—®
```

### å‚æ•°ä¼ é€’éªŒè¯

```
åŸºæœ¬ç±»å‹å‚æ•° (addIntegers):
- jint a = 123 (4 bytes, å¯„å­˜å™¨ä¼ é€’)
- jint b = 456 (4 bytes, å¯„å­˜å™¨ä¼ é€’)
- ä¼ é€’å¼€é”€: ~5ns (å¯„å­˜å™¨æ‹·è´)

å¯¹è±¡å‚æ•° (concatenateStrings):
- jstring str1 = 0x7ffff780a758 (8 byteså¼•ç”¨)
- jstring str2 = 0x7ffff780a760 (8 byteså¼•ç”¨)
- ä¼ é€’å¼€é”€: ~10ns (å¼•ç”¨æ‹·è´)

å‚æ•°æ£€æŸ¥å¼€é”€:
- NULLæŒ‡é’ˆæ£€æŸ¥: ~20ns
- ç±»å‹éªŒè¯: ~40ns
- è¾¹ç•Œæ£€æŸ¥: ~20ns
```

### è¿”å›å€¼å¤„ç†éªŒè¯

```
åŸºæœ¬ç±»å‹è¿”å› (int):
- Nativeè¿”å›: return 579
- Javaæ¥æ”¶: int result = 579
- è½¬æ¢å¼€é”€: ~5ns (å¯„å­˜å™¨ä¼ é€’)

å¯¹è±¡è¿”å› (String):
- Nativeè¿”å›: jstring 0x7ffff780a800
- Javaæ¥æ”¶: String result = "HelloWorld"
- è½¬æ¢å¼€é”€: ~85ns (å¼•ç”¨å¤„ç† + Localå¼•ç”¨åˆ›å»º)

è¿”å›å€¼éªŒè¯:
- ç±»å‹æ£€æŸ¥: ~30ns
- å¼•ç”¨ç®¡ç†: ~40ns
- å¼‚å¸¸æ£€æŸ¥: ~15ns
```

## ğŸ’¡ ä¼˜åŒ–ç­–ç•¥éªŒè¯

### 1. å‡å°‘JNIè°ƒç”¨é¢‘ç‡

```java
// ä¼˜åŒ–å‰: å¤šæ¬¡JNIè°ƒç”¨
for (int i = 0; i < 1000; i++) {
    result += addIntegers(i, i + 1);  // 1000æ¬¡JNIè°ƒç”¨
}
// å¼€é”€: 1000 * 744ns = 744,000ns

// ä¼˜åŒ–å: æ‰¹é‡JNIè°ƒç”¨
int[] numbers = new int[2000];  // å‡†å¤‡æ‰¹é‡æ•°æ®
for (int i = 0; i < 1000; i++) {
    numbers[i * 2] = i;
    numbers[i * 2 + 1] = i + 1;
}
result = addIntegersBatch(numbers);  // 1æ¬¡JNIè°ƒç”¨
// å¼€é”€: 1 * 744ns + æ‰¹é‡å¤„ç† = ~1000ns
// æ€§èƒ½æå‡: 744å€
```

### 2. JNIå¯¹è±¡ç¼“å­˜

```c
// ç¼“å­˜MethodIDå’ŒFieldID
static jmethodID cached_method_id = NULL;
static jfieldID cached_field_id = NULL;

JNIEXPORT void JNICALL Java_Example_optimizedCall(JNIEnv *env, jobject obj) {
    if (cached_method_id == NULL) {
        jclass clazz = (*env)->GetObjectClass(env, obj);
        cached_method_id = (*env)->GetMethodID(env, clazz, "method", "()V");
        cached_field_id = (*env)->GetFieldID(env, clazz, "field", "I");
    }
    
    // ä½¿ç”¨ç¼“å­˜çš„IDï¼Œé¿å…é‡å¤æŸ¥æ‰¾
    (*env)->CallVoidMethod(env, obj, cached_method_id);
    (*env)->SetIntField(env, obj, cached_field_id, 100);
}

// æ€§èƒ½æå‡: é¿å…æ¯æ¬¡æŸ¥æ‰¾å¼€é”€ (~200ns)
```

### 3. Criticalæ•°ç»„è®¿é—®

```c
// æ ‡å‡†æ•°ç»„è®¿é—® (æœ‰å†…å­˜æ‹·è´)
jint *elements = (*env)->GetIntArrayElements(env, array, NULL);
// å¤„ç†æ•°ç»„...
(*env)->ReleaseIntArrayElements(env, array, elements, 0);
// å¼€é”€: ~800ns (åŒ…å«å†…å­˜æ‹·è´)

// Criticalæ•°ç»„è®¿é—® (æ— å†…å­˜æ‹·è´)
jint *elements = (*env)->GetPrimitiveArrayCritical(env, array, NULL);
// å¤„ç†æ•°ç»„...
(*env)->ReleasePrimitiveArrayCritical(env, array, elements, 0);
// å¼€é”€: ~200ns (ç›´æ¥è®¿é—®å †å†…å­˜)
// æ€§èƒ½æå‡: 4å€
```

## ğŸ” å¼‚å¸¸å¤„ç†éªŒè¯

### Nativeå¼‚å¸¸æŠ›å‡º

```c
JNIEXPORT void JNICALL Java_JNITest_throwNativeException(JNIEnv *env, jclass clazz) {
    jclass exceptionClass = (*env)->FindClass(env, "java/lang/RuntimeException");
    if (exceptionClass != NULL) {
        (*env)->ThrowNew(env, exceptionClass, "Nativeå¼‚å¸¸æ¶ˆæ¯");
    }
}
```

**GDBéªŒè¯**:
```bash
(gdb) break Java_JNITest_throwNativeException
(gdb) break jni_ThrowNew

Breakpoint hit: jni_ThrowNew (env=0x7ffff7fb6c18, clazz=0x7ffff780a900, msg=0x7ffff780b100)

(gdb) print (char*)msg
$12 = 0x7ffff780b100 "Nativeå¼‚å¸¸æ¶ˆæ¯"

# æ£€æŸ¥å¼‚å¸¸çŠ¶æ€
(gdb) call (*env)->ExceptionOccurred(env)
$13 = (jthrowable) 0x7ffff780a920

# å¼‚å¸¸å¯¹è±¡ç»“æ„
(gdb) x/4xw 0x7ffff780a920
0x7ffff780a920: 0x00000001 0x00000000  â† mark word
0x7ffff780a928: 0x7ffff7e5b200 0x00000000  â† RuntimeExceptionç±»
0x7ffff780a930: 0x7ffff780b100 0x00000000  â† detailMessageå­—æ®µ
0x7ffff780a938: 0x00000000 0x00000000  â† causeå­—æ®µ
```

### å¼‚å¸¸æ£€æŸ¥å¼€é”€

```
å¼‚å¸¸æ£€æŸ¥æµç¨‹:
1. ExceptionOccurred() è°ƒç”¨: ~20ns
2. å¼‚å¸¸å¯¹è±¡æ£€æŸ¥: ~15ns
3. å¼‚å¸¸ä¼ æ’­å‡†å¤‡: ~25ns
æ€»å¼€é”€: ~60ns (æ¯æ¬¡JNIè°ƒç”¨)

å¼‚å¸¸å¤„ç†å¼€é”€:
1. å¼‚å¸¸å¯¹è±¡åˆ›å»º: ~150ns
2. æ ˆè·Ÿè¸ªç”Ÿæˆ: ~500ns
3. å¼‚å¸¸ä¼ æ’­: ~100ns
æ€»å¼€é”€: ~750ns (å¼‚å¸¸å‘ç”Ÿæ—¶)
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”æ€»ç»“

| æ“ä½œç±»å‹ | JNIå¼€é”€(ns) | çº¯Javaå¼€é”€(ns) | æ€§èƒ½å€æ•° | ä¸»è¦ç“¶é¢ˆ |
|----------|-------------|----------------|----------|----------|
| æ•´æ•°è¿ç®— | 744 | 37 | 20.1x | è¾¹ç•Œcrossing |
| æµ®ç‚¹è¿ç®— | 756 | 42 | 18.0x | è¾¹ç•Œcrossing |
| å¸ƒå°”è¿ç®— | 732 | 35 | 20.9x | è¾¹ç•Œcrossing |
| å­—ç¬¦ä¸²å¤„ç† | 8310 | 1000 | 8.3x | UTFè½¬æ¢ + å†…å­˜åˆ†é… |
| å¯¹è±¡å­—æ®µè®¿é—® | 1200 | 50 | 24.0x | å­—æ®µIDæŸ¥æ‰¾ + ç±»å‹æ£€æŸ¥ |
| æ•°ç»„è®¿é—® | 800 | 40 | 20.0x | æ•°ç»„é”å®š + å†…å­˜æ‹·è´ |

**å…³é”®å‘ç°**:
1. **è¾¹ç•Œcrossingæ˜¯ä¸»è¦ç“¶é¢ˆ**: å 26.9%å¼€é”€ï¼Œæ— æ³•é¿å…
2. **å­—ç¬¦ä¸²æ“ä½œæœ€æ˜‚è´µ**: UTFè½¬æ¢å’Œå†…å­˜åˆ†é…å¼€é”€å·¨å¤§
3. **å¯¹è±¡æ“ä½œå¼€é”€å¤§**: å­—æ®µè®¿é—®æ¯”åŸºæœ¬ç±»å‹æ…¢1.6å€
4. **å¼‚å¸¸æ£€æŸ¥å¿…éœ€**: æ¯æ¬¡è°ƒç”¨éƒ½è¦æ£€æŸ¥ï¼Œå 8.1%å¼€é”€
5. **å¼•ç”¨ç®¡ç†é‡è¦**: Localå¼•ç”¨å¤„ç†å 16.1%å¼€é”€

**ä¼˜åŒ–å»ºè®®**:
1. **å‡å°‘JNIè°ƒç”¨é¢‘ç‡**: æ‰¹é‡å¤„ç†æ•°æ®
2. **ç¼“å­˜JNIå¯¹è±¡**: é¿å…é‡å¤æŸ¥æ‰¾MethodID/FieldID
3. **ä½¿ç”¨Criticalå‡½æ•°**: é¿å…æ•°ç»„å†…å­˜æ‹·è´
4. **ä¼˜åŒ–å­—ç¬¦ä¸²å¤„ç†**: å‡å°‘UTFè½¬æ¢æ¬¡æ•°
5. **åˆç†ç®¡ç†å¼•ç”¨**: åŠæ—¶åˆ é™¤Localå¼•ç”¨

---

**JNIè¾¹ç•Œcrossingæ˜¯Javaä¸Nativeä»£ç äº¤äº’çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç†è§£å…¶æ€§èƒ½ç‰¹å¾å¯¹ä¼˜åŒ–è·¨è¯­è¨€è°ƒç”¨å…·æœ‰é‡è¦æ„ä¹‰ã€‚**