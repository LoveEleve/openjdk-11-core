# JVMæŠ€æœ¯ä¸“å®¶é¢è¯•ä¸“é¡¹ - G1åƒåœ¾å›æ”¶æ‰§è¡Œæµç¨‹

> **ç¯å¢ƒ**: Linux, -Xms8g -Xmx8g, G1GC, Region=4MB, éå¤§é¡µ, éNUMA
> **éš¾åº¦**: â­â­â­â­â­ JVMæŠ€æœ¯ä¸“å®¶çº§

---

## é¢è¯•é—®é¢˜ 1ï¼šG1æœ‰å“ªå‡ ç§GCç±»å‹ï¼Ÿè§¦å‘æ¡ä»¶åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "è¯·è¯¦ç»†è¯´æ˜G1çš„GCç±»å‹ã€è§¦å‘æ¡ä»¶ä»¥åŠæºç å…¥å£ã€‚"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. G1çš„å››ç§GCç±»å‹

| GCç±»å‹ | åœé¡¿ç±»å‹ | è§¦å‘æ¡ä»¶ | å›æ”¶èŒƒå›´ |
|--------|----------|----------|----------|
| **Young GC** | STW | EdenåŒºæ»¡ | Eden + Survivor |
| **Mixed GC** | STW | å¹¶å‘æ ‡è®°å | Eden + Survivor + éƒ¨åˆ†Old |
| **Concurrent Mark** | å¹¶å‘ | IHOPé˜ˆå€¼ | æ ‡è®°å­˜æ´»å¯¹è±¡ |
| **Full GC** | STW | OOMæˆ–æ˜¾å¼è°ƒç”¨ | å…¨å † |

#### 2. æºç å…¥å£

```cpp
// vm_operations_g1.cpp - GCè§¦å‘å…¥å£
void VM_G1CollectForAllocation::doit() {
  G1CollectedHeap* g1h = G1CollectedHeap::heap();
  
  // å°è¯•è¿›è¡ŒGC
  _pause_succeeded = g1h->do_collection_pause_at_safepoint(_target_pause_time_ms);
}
```

**æ ¸å¿ƒæ–¹æ³•** (`g1CollectedHeap.cpp:3035`):

```cpp
bool G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
  // 1. ç­‰å¾…æ ¹åŒºåŸŸæ‰«æå®Œæˆ
  wait_for_root_region_scanning();
  
  // 2. å†³å®šæ˜¯å¦å¼€å§‹å¹¶å‘æ ‡è®°
  g1_policy()->decide_on_conc_mark_initiation();
  
  // 3. æ ¹æ®çŠ¶æ€å†³å®šGCç±»å‹
  if (collector_state()->in_initial_mark_gc()) {
    gc_string.append("(Concurrent Start)");  // è§¦å‘å¹¶å‘æ ‡è®°
  } else if (collector_state()->in_young_only_phase()) {
    gc_string.append("(Normal)");            // æ™®é€šYoung GC
  } else {
    gc_string.append("(Mixed)");             // Mixed GC
  }
}
```

#### 3. IHOPè§¦å‘å¹¶å‘æ ‡è®°

**IHOP (Initiating Heap Occupancy Percent)**:

```cpp
// g1Policy.cpp
bool G1Policy::need_to_start_conc_mark() {
  // å½“è€å¹´ä»£ä½¿ç”¨è¶…è¿‡IHOPé˜ˆå€¼æ—¶è§¦å‘
  return _ihop_control->should_start_marking(
    old_gen_size, 
    _g1h->total_heap_size()
  );
}
```

**8GBå †IHOPè®¡ç®—**:
- é»˜è®¤IHOP = 45%
- è§¦å‘é˜ˆå€¼ = 8GB Ã— 45% = **3.6GB**

---

## é¢è¯•é—®é¢˜ 2ï¼šYoung GCçš„ä¸‰ä¸ªé˜¶æ®µåˆ†åˆ«åšä»€ä¹ˆï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "Young GCçš„Pre Evacuateã€Evacuateã€Post Evacuateä¸‰ä¸ªé˜¶æ®µå„åšä»€ä¹ˆï¼Ÿå“ªä¸ªé˜¶æ®µæœ€è€—æ—¶ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. ä¸‰é˜¶æ®µæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Young GC STW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pre Evacuate â”‚      Evacuate        â”‚     Post Evacuate       â”‚
â”‚   (~0.2ms)   â”‚     (~341ms)â˜…        â”‚      (~140ms)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Prepare TLABâ”‚ - Root Scanning     â”‚ - Code Roots Fixup      â”‚
â”‚ - Choose CSet â”‚ - Object Copy â˜…     â”‚ - Reference Processing  â”‚
â”‚ - Humongous  â”‚ - Termination        â”‚ - Free Collection Set   â”‚
â”‚   Register   â”‚                      â”‚ - Humongous Reclaim     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. çœŸå®GCæ—¥å¿—åˆ†æ

```
[gc,phases] GC(0)   Pre Evacuate Collection Set: 0.2ms
[gc,phases] GC(0)   Evacuate Collection Set: 341.2ms   â˜… ä¸»è¦è€—æ—¶
[gc,phases] GC(0)   Post Evacuate Collection Set: 140.4ms
[gc,phases] GC(0)   Other: 6.3ms
```

#### 3. å„é˜¶æ®µè¯¦ç»†åˆ†æ

**Phase 1: Pre Evacuate (0.2ms)**

| å­é˜¶æ®µ | è€—æ—¶ | ä½œç”¨ |
|--------|------|------|
| Prepare TLABs | 0.9ms | å‡†å¤‡çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†² |
| Choose Collection Set | 0.0ms | é€‰æ‹©å¾…å›æ”¶Region |
| Humongous Register | 0.2ms | æ³¨å†Œå¤§å¯¹è±¡å¼•ç”¨ |

**Phase 2: Evacuate (341.2ms)** â˜…æ ¸å¿ƒé˜¶æ®µ

| å­é˜¶æ®µ | è€—æ—¶ | Workerç»Ÿè®¡ | ä½œç”¨ |
|--------|------|------------|------|
| Ext Root Scanning | 4.8ms avg | Min:0.9, Max:49.7 | æ‰«æå¤–éƒ¨æ ¹ |
| Update RS | 0.0ms | - | æ›´æ–°è®°å¿†é›†ï¼ˆé¦–æ¬¡GCä¸º0ï¼‰|
| Scan RS | 0.0ms | - | æ‰«æè®°å¿†é›† |
| **Object Copy** | **335.2ms avg** | Min:290.3, Max:339.6 | â˜…**å¤åˆ¶å­˜æ´»å¯¹è±¡** |
| Termination | 0.5ms | Min:0.0, Max:0.9 | å·¥ä½œçªƒå–ç»ˆæ­¢ |

**Phase 3: Post Evacuate (140.4ms)**

| å­é˜¶æ®µ | è€—æ—¶ | ä½œç”¨ |
|--------|------|------|
| Code Roots Fixup | 0.1ms | ä¿®å¤ä»£ç æ ¹å¼•ç”¨ |
| Reference Processing | 0.1ms | å¤„ç†è½¯/å¼±/è™šå¼•ç”¨ |
| **Free Collection Set** | **139.0ms** | â˜…é‡Šæ”¾CSetä¸­çš„Region |
| Humongous Reclaim | 0.2ms | å›æ”¶æ— å¼•ç”¨çš„å¤§å¯¹è±¡ |

#### 4. å…³é”®å‘ç°

1. **Object Copyå 70%**: å¯¹è±¡å¤åˆ¶æ˜¯ä¸»è¦ç“¶é¢ˆ
2. **Free CSetå 28%**: é‡Šæ”¾Regionä¹Ÿå¾ˆè€—æ—¶
3. **é¦–æ¬¡GCæ— RSæ›´æ–°**: Update RS/Scan RSä¸º0

---

## é¢è¯•é—®é¢˜ 3ï¼šObject Copyé˜¶æ®µæ˜¯å¦‚ä½•å¹¶è¡Œçš„ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "Object Copyé˜¶æ®µ13ä¸ªWorkerçº¿ç¨‹æ˜¯å¦‚ä½•å¹¶è¡Œå·¥ä½œçš„ï¼Ÿè´Ÿè½½å‡è¡¡å¦‚ä½•å®ç°ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. å¹¶è¡Œæ¨¡å‹

```cpp
// g1CollectedHeap.cpp - å¹¶è¡ŒEvacuation
void G1CollectedHeap::evacuate_collection_set(G1ParScanThreadStateSet* per_thread_states) {
  // åˆ›å»ºå¹¶è¡Œä»»åŠ¡
  G1ParTask g1_par_task(this, per_thread_states, ...);
  
  // ä½¿ç”¨WorkGangæ‰§è¡Œ
  workers()->run_task(&g1_par_task);
}
```

#### 2. Workerçº¿ç¨‹ç»Ÿè®¡

```
Object Copy (ms): Min:290.3, Avg:335.2, Max:339.6, Sum:4357.8, Workers:13
```

| ç»Ÿè®¡é¡¹ | å€¼ | åˆ†æ |
|--------|-----|------|
| æœ€å°è€—æ—¶ | 290.3ms | æœ€å¿«Worker |
| å¹³å‡è€—æ—¶ | 335.2ms | å¹³å‡è´Ÿè½½ |
| æœ€å¤§è€—æ—¶ | 339.6ms | æœ€æ…¢Workerï¼ˆå†³å®šæ€»æ—¶é—´ï¼‰|
| æ€»CPUæ—¶é—´ | 4357.8ms | 13Ã—335â‰ˆ4355 |
| **è´Ÿè½½ä¸å‡è¡¡åº¦** | **17%** | (Max-Min)/Avg |

#### 3. å·¥ä½œçªƒå–æœºåˆ¶

```cpp
// å·¥ä½œçªƒå–é˜Ÿåˆ—
class G1ParScanThreadState {
  RefToScanQueue* _refs;  // æœ¬åœ°ä»»åŠ¡é˜Ÿåˆ—
  
  void do_object_work() {
    while (!_refs->is_empty() || steal_work()) {
      process_reference(_refs->pop());
    }
  }
  
  bool steal_work() {
    // ä»å…¶ä»–Workerçªƒå–ä»»åŠ¡
    return queue_set->steal(worker_id, &stolen_ref);
  }
};
```

**Terminationç»Ÿè®¡**:
```
Termination (ms): Min:0.0, Avg:0.5, Max:0.9
```
- ç»ˆæ­¢æ—¶é—´æçŸ­ï¼Œè¯´æ˜å·¥ä½œçªƒå–æ•ˆæœå¥½

#### 4. PLAB (Promotion LAB)

æ¯ä¸ªWorkeræœ‰ç‹¬ç«‹çš„PLABç”¨äºå¯¹è±¡åˆ†é…ï¼š

```cpp
class G1PLABAllocator {
  PLAB _survivor_plab;  // Survivoråˆ†é…ç¼“å†²
  PLAB _old_plab;       // Oldåˆ†é…ç¼“å†²
  
  HeapWord* allocate_in_plab(size_t word_size, bool in_old_region) {
    PLAB* plab = in_old_region ? &_old_plab : &_survivor_plab;
    return plab->allocate(word_size);
  }
};
```

---

## é¢è¯•é—®é¢˜ 4ï¼šå¹¶å‘æ ‡è®°çš„äº”ä¸ªé˜¶æ®µæ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "G1çš„å¹¶å‘æ ‡è®°æœ‰å“ªå‡ ä¸ªé˜¶æ®µï¼Ÿå“ªäº›æ˜¯STWï¼Œå“ªäº›æ˜¯å¹¶å‘ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. äº”é˜¶æ®µæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¹¶å‘æ ‡è®°å‘¨æœŸ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Initial  â”‚  Root Region  â”‚ Concurrent â”‚  Remark  â”‚  Cleanup   â”‚
â”‚   Mark    â”‚     Scan      â”‚    Mark    â”‚          â”‚            â”‚
â”‚  (STW)    â”‚   (å¹¶å‘)      â”‚   (å¹¶å‘)    â”‚  (STW)   â”‚ (STW+å¹¶å‘) â”‚
â”‚  ~5ms     â”‚   ~22ms       â”‚  ~624ms    â”‚  ~15ms   â”‚   ~8ms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. å„é˜¶æ®µè¯¦è§£

| é˜¶æ®µ | ç±»å‹ | è€—æ—¶ | ä¸»è¦å·¥ä½œ |
|------|------|------|----------|
| **Initial Mark** | STW | ~5ms | æ ‡è®°GC Rootsç›´æ¥å¼•ç”¨çš„å¯¹è±¡ |
| **Root Region Scan** | å¹¶å‘ | ~22ms | æ‰«æSurvivoråŒºå¼•ç”¨çš„Oldå¯¹è±¡ |
| **Concurrent Mark** | å¹¶å‘ | ~624ms | éå†å †æ ‡è®°æ‰€æœ‰å­˜æ´»å¯¹è±¡ |
| **Remark** | STW | ~15ms | SATBå¤„ç†ã€å¼•ç”¨å¤„ç† |
| **Cleanup** | æ··åˆ | ~8ms | ç»Ÿè®¡Regionå­˜æ´»ç‡ã€æ¸…ç†ç©ºRegion |

#### 3. æºç å…¥å£

```cpp
// g1ConcurrentMarkThread.cpp
void G1ConcurrentMarkThread::run_service() {
  while (!should_terminate()) {
    // Phase 1: Initial Mark (åœ¨Young GCä¸­piggyback)
    // Phase 2: Root Region Scan
    cm()->scan_root_regions();
    
    // Phase 3: Concurrent Mark
    cm()->mark_from_roots();
    
    // Phase 4: Remark (éœ€è¦STW)
    VM_CGC_Operation op_remark(..);
    VMThread::execute(&op_remark);
    
    // Phase 5: Cleanup
    cm()->cleanup();
  }
}
```

#### 4. çœŸå®GCæ—¥å¿—

```
[2.235s][info ][gc] GC(4) Concurrent Cycle
[2.240s][debug][gc,marking] GC(4) Concurrent Clear Claimed Marks
[2.242s][debug][gc,marking] GC(4) Concurrent Scan Root Regions
[2.264s][info ][gc,marking] GC(4) Concurrent Mark From Roots
[2.264s][debug][gc,marking] GC(4)   Using 3 workers of 3 for marking
[2.889s][info ][gc,marking] GC(4) Concurrent Mark From Roots 624.538ms
[2.891s][info ][gc] GC(4) Pause Remark 14.623ms
```

---

## é¢è¯•é—®é¢˜ 5ï¼šSATBæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "SATBï¼ˆSnapshot-At-The-Beginningï¼‰æ˜¯ä»€ä¹ˆï¼Ÿå®ƒè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. å¹¶å‘æ ‡è®°çš„é—®é¢˜

**ä¸‰è‰²æ ‡è®°æ³•çš„æ¼æ ‡é—®é¢˜**ï¼š

```
                æ—¶åˆ»1                    æ—¶åˆ»2
              â”Œâ”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”
 GCçº¿ç¨‹æ ‡è®°   â”‚  A  â”‚ â† é»‘è‰²(å·²æ‰«æ)    â”‚  A  â”‚ â† é»‘è‰²
              â””â”€â”€â”¬â”€â”€â”˜                  â””â”€â”€â”¬â”€â”€â”˜
                 â”‚                        â”‚
              â”Œâ”€â”€â–¼â”€â”€â”                  â”Œâ”€â”€â–¼â”€â”€â”
              â”‚  B  â”‚ â† ç°è‰²(æ‰«æä¸­)    â”‚  B  â”‚ â† ç°è‰²
              â””â”€â”€â”¬â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”˜
                 â”‚                        â†“ åº”ç”¨çº¿ç¨‹åˆ é™¤Bâ†’Cå¼•ç”¨
              â”Œâ”€â”€â–¼â”€â”€â”                  
              â”‚  C  â”‚ â† ç™½è‰²(æœªæ‰«æ)    Cè¢«æ¼æ ‡ï¼
              â””â”€â”€â”€â”€â”€â”˜                  
                                       
 åº”ç”¨çº¿ç¨‹æ‰§è¡Œ: A.field = C;  // Aç›´æ¥å¼•ç”¨C
              B.field = null; // åˆ é™¤Bâ†’C
              
 ç»“æœ: Cè¢«é”™è¯¯å›æ”¶ï¼
```

#### 2. SATBè§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒæ€æƒ³**ï¼šè®°å½•å¹¶å‘æ ‡è®°å¼€å§‹æ—¶çš„å¯¹è±¡å›¾å¿«ç…§ï¼Œä»»ä½•å¼•ç”¨åˆ é™¤éƒ½ä¼šè¢«è®°å½•ã€‚

```cpp
// g1SATBMarkQueueSet.hpp
class G1SATBMarkQueueSet {
  // æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªSATBé˜Ÿåˆ—
  SATBMarkQueue* _satb_queues;
  
  // å†™å±éšœï¼šè®°å½•æ—§å¼•ç”¨
  void enqueue(oop old_value) {
    if (old_value != NULL) {
      get_thread_queue()->enqueue(old_value);
    }
  }
};
```

**å†™å±éšœå®ç°**ï¼š

```cpp
// ä¼ªä»£ç 
void pre_write_barrier(oop* field, oop new_value) {
  oop old_value = *field;
  // SATBå†™å±éšœï¼šè®°å½•æ—§å€¼
  if (old_value != NULL && marking_active) {
    satb_queue.enqueue(old_value);
  }
  *field = new_value;
}
```

#### 3. SATB vs Incremental Update

| ç‰¹æ€§ | SATB (G1) | Incremental Update (CMS) |
|------|-----------|--------------------------|
| è®°å½•å†…å®¹ | è¢«åˆ é™¤çš„å¼•ç”¨(æ—§å€¼) | æ–°å¢çš„å¼•ç”¨(æ–°å€¼) |
| å†™å±éšœ | Pre-write barrier | Post-write barrier |
| Remarkæ—¶é—´ | çŸ­ï¼ˆåªå¤„ç†SATBé˜Ÿåˆ—ï¼‰| é•¿ï¼ˆéœ€è¦é‡æ–°æ‰«æï¼‰|
| å†…å­˜å¼€é”€ | è¾ƒé«˜ï¼ˆSATBé˜Ÿåˆ—ï¼‰| è¾ƒä½ |
| æµ®åŠ¨åƒåœ¾ | å¯èƒ½è¾ƒå¤š | è¾ƒå°‘ |

#### 4. å¤„ç†æµç¨‹

```cpp
// g1ConcurrentMark.cpp - Remarké˜¶æ®µå¤„ç†SATB
void G1ConcurrentMark::drain_satb_buffers() {
  while (satb_queue_set.apply_closure_to_completed_buffer()) {
    // å¤„ç†SATBç¼“å†²åŒºä¸­çš„å¼•ç”¨
    // æ ‡è®°è¿™äº›å¯¹è±¡ä¸ºå­˜æ´»
  }
}
```

---

## é¢è¯•é—®é¢˜ 6ï¼šMixed GCæ˜¯å¦‚ä½•é€‰æ‹©å›æ”¶Regionçš„ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "Mixed GCå¦‚ä½•å†³å®šå›æ”¶å“ªäº›Old Regionï¼Ÿé€‰æ‹©ç®—æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. Collection Seté€‰æ‹©ç­–ç•¥

```cpp
// collectionSetChooser.cpp
void CollectionSetChooser::sort_regions() {
  // æŒ‰ç…§åƒåœ¾æ¯”ä¾‹æ’åºï¼ˆé™åºï¼‰
  // gc_efficiency = garbage_bytes / region_time
  _regions.sort(compare_gc_efficiency);
}

// é€‰æ‹©æ¡ä»¶
bool region_eligible_for_collection(HeapRegion* hr) {
  size_t live_bytes = hr->live_bytes();
  size_t threshold = HeapRegion::GrainBytes * G1MixedGCLiveThresholdPercent / 100;
  
  // å­˜æ´»å¯¹è±¡æ¯”ä¾‹ < é˜ˆå€¼æ‰ä¼šè¢«é€‰ä¸­
  return live_bytes < threshold;  // é»˜è®¤85%
}
```

#### 2. é€‰æ‹©å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ |
|------|--------|------|
| `G1MixedGCLiveThresholdPercent` | 85% | Regionå­˜æ´»ç‡é˜ˆå€¼ |
| `G1MixedGCCountTarget` | 8 | ç›®æ ‡Mixed GCæ¬¡æ•° |
| `G1OldCSetRegionThresholdPercent` | 10% | æ¯æ¬¡æœ€å¤§Old Regionæ¯”ä¾‹ |

#### 3. çœŸå®GCæ—¥å¿—

```
[3.456s][debug][gc,ergo,cset] GC(8) Finish choosing CSet. 
    old: 45 regions, predicted old region time: 12.34ms

[3.484s][info ][gc] GC(8) 512M->384M(8192M) 28.456ms
    Eden: 64 regions -> 0 regions
    Survivor: 8 regions -> 12 regions  
    Old: 420 regions -> 379 regions    â† å›æ”¶41ä¸ªOld Region
```

#### 4. é€‰æ‹©æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Mixed GC CSeté€‰æ‹©                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. è·å–æ‰€æœ‰å€™é€‰Old Regionï¼ˆå­˜æ´»ç‡<85%ï¼‰                         â”‚
â”‚                     â†“                                          â”‚
â”‚  2. æŒ‰gc_efficiencyæ’åºï¼ˆåƒåœ¾å¤šã€å›æ”¶å¿«çš„ä¼˜å…ˆï¼‰                   â”‚
â”‚                     â†“                                          â”‚
â”‚  3. æ ¹æ®ç›®æ ‡æš‚åœæ—¶é—´é€‰æ‹©æ•°é‡                                     â”‚
â”‚     - é¢„æµ‹æ¯ä¸ªRegionå›æ”¶æ—¶é—´                                    â”‚
â”‚     - ç´¯åŠ ç›´åˆ°æ¥è¿‘MaxGCPauseMillis                             â”‚
â”‚                     â†“                                          â”‚
â”‚  4. é™åˆ¶æœ€å¤§Old Regionæ•°é‡ï¼ˆä¸è¶…è¿‡æ€»æ•°10%ï¼‰                      â”‚
â”‚                     â†“                                          â”‚
â”‚  5. åŠ å…¥Young Regionç»„æˆæœ€ç»ˆCSet                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é¢è¯•é—®é¢˜ 7ï¼šä¸ºä»€ä¹ˆé¦–æ¬¡GCæ—¶Update RS/Scan RSä¸º0ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "GCæ—¥å¿—æ˜¾ç¤ºé¦–æ¬¡GCçš„Update RSå’ŒScan RSéƒ½æ˜¯0msï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. GCæ—¥å¿—

```
[gc,phases] GC(0)     Update RS (ms):  Min:0.0, Avg:0.0, Max:0.0
[gc,phases] GC(0)     Scan RS (ms):    Min:0.0, Avg:0.0, Max:0.0
```

#### 2. åŸå› åˆ†æ

**Remembered Set (RS) è®°å½•çš„æ˜¯è·¨Regionå¼•ç”¨**ï¼š
- Old â†’ Youngå¼•ç”¨
- Young â†’ Youngè·¨Regionå¼•ç”¨

**é¦–æ¬¡GCæ—¶**ï¼š
1. æ‰€æœ‰å¯¹è±¡éƒ½åœ¨EdenåŒºï¼ˆYoungï¼‰
2. æ²¡æœ‰Old Regionå­˜åœ¨
3. æ²¡æœ‰Old â†’ Youngçš„è·¨ä»£å¼•ç”¨
4. å› æ­¤RSä¸ºç©ºï¼Œæ‰«ææ—¶é—´ä¸º0

#### 3. RSå†™å±éšœè§¦å‘æ¡ä»¶

```cpp
// g1BarrierSet.cpp
void G1BarrierSet::write_ref_field_post(oop* field, oop new_value) {
  // åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°RS
  if (!is_in_young(field) && is_in_young(new_value)) {
    // Old â†’ Youngå¼•ç”¨ï¼Œéœ€è¦è®°å½•
    dirty_card_queue().enqueue(field);
  }
}
```

#### 4. åç»­GCçš„RSç»Ÿè®¡

```
[GC(5)][gc,phases]     Update RS (ms): Min:2.1, Avg:3.5, Max:5.2
[GC(5)][gc,phases]     Scan RS (ms):   Min:1.8, Avg:2.9, Max:4.1
```

**æœ‰äº†Old Regionå**ï¼ŒRSå¼€å§‹å‘æŒ¥ä½œç”¨ã€‚

---

## å®æˆ˜éªŒè¯ï¼šGDBè°ƒè¯•GCæµç¨‹

### 1. æ–­ç‚¹è®¾ç½®

```gdb
# è®¾ç½®GCå…¥å£æ–­ç‚¹
break g1CollectedHeap.cpp:3035  # do_collection_pause_at_safepoint

# è®¾ç½®Evacuationæ–­ç‚¹
break g1CollectedHeap.cpp:3180  # pre_evacuate_collection_set
break g1CollectedHeap.cpp:3200  # evacuate_collection_set
break g1CollectedHeap.cpp:3220  # post_evacuate_collection_set
```

### 2. GCçŠ¶æ€æŸ¥çœ‹

```gdb
(gdb) p _collector_state._state
$1 = G1CollectorState::_in_young_only_phase

(gdb) p g1_policy()->_young_list_target_length
$2 = 89

(gdb) p _collection_set._bytes_used_before
$3 = 427819008  # ~408MB
```

### 3. CSetä¿¡æ¯

```gdb
(gdb) p _collection_set._eden_region_length
$4 = 102

(gdb) p _collection_set._survivor_region_length  
$5 = 0

(gdb) p _collection_set._old_region_length
$6 = 0  # Young GCä¸åŒ…å«Old
```

---

## æ€»ç»“ï¼šé«˜é¢‘è€ƒç‚¹

| è€ƒç‚¹ | ç­”æ¡ˆè¦ç‚¹ |
|------|----------|
| GCç±»å‹ | Young/Mixed/Concurrent Mark/Full GC |
| ä¸‰é˜¶æ®µ | Pre Evacuate/Evacuateâ˜…/Post Evacuate |
| Object Copy | å 70%æ—¶é—´ï¼Œ13 Workerå¹¶è¡Œ+å·¥ä½œçªƒå– |
| å¹¶å‘æ ‡è®° | 5é˜¶æ®µï¼šInitial/Root Region/Mark/Remark/Cleanup |
| SATB | è®°å½•åˆ é™¤çš„å¼•ç”¨ï¼Œè§£å†³æ¼æ ‡é—®é¢˜ |
| Mixed GCé€‰æ‹© | æŒ‰gc_efficiencyæ’åºï¼Œå­˜æ´»ç‡<85% |
| RSä¸º0åŸå›  | é¦–æ¬¡GCæ— Old Regionï¼Œæ— è·¨ä»£å¼•ç”¨ |

---

**ä¸‹ä¸€ç¯‡**: [03-å¯¹è±¡åˆ†é…ä¸TLABæœºåˆ¶](./03-å¯¹è±¡åˆ†é…ä¸TLABæœºåˆ¶.md)
