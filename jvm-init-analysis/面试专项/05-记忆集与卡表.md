# JVMæŠ€æœ¯ä¸“å®¶é¢è¯•ä¸“é¡¹ - è®°å¿†é›†ä¸å¡è¡¨

> **ç¯å¢ƒ**: Linux, -Xms8g -Xmx8g, G1GC, Region=4MB, éå¤§é¡µ, éNUMA
> **éš¾åº¦**: â­â­â­â­â­ JVMæŠ€æœ¯ä¸“å®¶çº§

---

## é¢è¯•é—®é¢˜ 1ï¼šä¸ºä»€ä¹ˆG1éœ€è¦è®°å¿†é›†ï¼ˆRSetï¼‰ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "G1æ˜¯åˆ†Regionçš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸ºä»€ä¹ˆéœ€è¦è®°å¿†é›†ï¼Ÿä¸ç”¨è¡Œä¸è¡Œï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. é—®é¢˜èƒŒæ™¯

G1çš„è®¾è®¡ç›®æ ‡æ˜¯**ç‹¬ç«‹å›æ”¶å•ä¸ªRegion**ï¼Œä¸éœ€è¦æ‰«ææ•´ä¸ªå †ã€‚ä½†å­˜åœ¨**è·¨Regionå¼•ç”¨**é—®é¢˜ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        8GBå † (2048ä¸ªRegion)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Region 0 â”‚  Region 1 â”‚  Region 2 â”‚  Region 3 â”‚    ...     â”‚
â”‚  (Eden)   â”‚  (Eden)   â”‚   (Old)   â”‚   (Old)   â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   obj_A   â”‚   obj_B   â”‚   obj_C   â”‚   obj_D   â”‚            â”‚
â”‚     â†‘     â”‚           â”‚     â”‚     â”‚     â”‚     â”‚            â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚                    â”‚
â”‚           è·¨Regionå¼•ç”¨           â””â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                 è·¨Regionå¼•ç”¨                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æ²¡æœ‰RSetä¼šæ€æ ·ï¼Ÿ

```
åœºæ™¯ï¼šå›æ”¶Region 0 (Eden)

æ²¡æœ‰RSet:
  1. éœ€è¦æ‰«ææ•´ä¸ªå †æ‰¾åˆ°è°å¼•ç”¨äº†Region 0ä¸­çš„å¯¹è±¡
  2. 8GBå †æ‰«æ â†’ åœé¡¿æ—¶é—´ä¸å¯æ§
  
æœ‰RSet:
  1. ç›´æ¥æŸ¥è¯¢Region 0çš„RSet
  2. RSetè®°å½•äº†"å“ªäº›Regionçš„å“ªäº›å¡ç‰‡å¼•ç”¨äº†æˆ‘"
  3. åªæ‰«æRSetæŒ‡å‘çš„å¡ç‰‡ â†’ åœé¡¿æ—¶é—´å¯æ§
```

#### 3. RSetæ ¸å¿ƒä»·å€¼

| ç‰¹æ€§ | æ²¡æœ‰RSet | æœ‰RSet |
|------|----------|--------|
| æ‰«æèŒƒå›´ | æ•´ä¸ªå † | ä»…ç›¸å…³å¡ç‰‡ |
| åœé¡¿æ—¶é—´ | O(å †å¤§å°) | O(å¼•ç”¨æ•°é‡) |
| å¯é¢„æµ‹æ€§ | ä¸å¯é¢„æµ‹ | å¯é¢„æµ‹ |

---

## é¢è¯•é—®é¢˜ 2ï¼šRSetçš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "è¯·è¯¦ç»†è¯´æ˜G1 RSetçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. RSetä¸‰å±‚ç»“æ„

```cpp
// heapRegionRemSet.hpp:170
class HeapRegionRemSet : public CHeapObj<mtGC> {
  OtherRegionsTable _other_regions;  // ä¸»è¦å­˜å‚¨ç»“æ„
  G1CodeRootSet _code_roots;         // ä»£ç æ ¹å¼•ç”¨
};

// OtherRegionsTableå†…éƒ¨ç»“æ„
class OtherRegionsTable {
  CHeapBitMap _coarse_map;           // ç²—ç²’åº¦ä½å›¾ï¼ˆRegionçº§ï¼‰
  PerRegionTable** _fine_grain_regions; // ç»†ç²’åº¦PRTæ•°ç»„
  SparsePRT _sparse_prt;             // ç¨€ç–PRTï¼ˆé»˜è®¤ï¼‰
};
```

#### 2. ä¸‰å±‚å­˜å‚¨ç»“æ„

```
                        RSetä¸‰å±‚å­˜å‚¨ç»“æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HeapRegionRemSet                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer 1: Sparse PRT (ç¨€ç–)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ å“ˆå¸Œè¡¨å­˜å‚¨: (region_id, card_idx) pairs  â”‚                  â”‚
â”‚  â”‚ é€‚ç”¨: å°‘é‡å¼•ç”¨ï¼ˆ< é˜ˆå€¼ï¼‰                  â”‚                  â”‚
â”‚  â”‚ ç©ºé—´: O(å¼•ç”¨æ•°)                          â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â†“ è¶…è¿‡é˜ˆå€¼åå‡çº§                        â”‚
â”‚                                                                 â”‚
â”‚  Layer 2: Fine-grain PRT (ç»†ç²’åº¦)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ æ¯ä¸ªå¼•ç”¨Regionä¸€ä¸ªPerRegionTable         â”‚                  â”‚
â”‚  â”‚ PRTå†…éƒ¨: CHeapBitMap (æ¯å¡ä¸€ä½)          â”‚                  â”‚
â”‚  â”‚ é€‚ç”¨: ä¸­ç­‰æ•°é‡å¼•ç”¨                       â”‚                  â”‚
â”‚  â”‚ ç©ºé—´: Regionæ•° Ã— å¡ç‰‡ä½å›¾                â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                         â†“ PRTæ•°é‡è¶…é™åé™çº§                     â”‚
â”‚                                                                 â”‚
â”‚  Layer 3: Coarse Bitmap (ç²—ç²’åº¦)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ ä¸€ä¸ªä½å›¾ï¼Œæ¯Regionä¸€ä½                    â”‚                  â”‚
â”‚  â”‚ åªè®°å½•"æŸRegionå¼•ç”¨äº†æˆ‘"ï¼Œä¸è®°å½•å…·ä½“å¡ç‰‡  â”‚                  â”‚
â”‚  â”‚ é€‚ç”¨: å¤§é‡å¼•ç”¨ï¼ˆçƒ­ç‚¹Regionï¼‰              â”‚                  â”‚
â”‚  â”‚ ç©ºé—´: å›ºå®š = Regionæ•°/8 bytes            â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. PerRegionTableæºç 

```cpp
// heapRegionRemSet.cpp:45
class PerRegionTable: public CHeapObj<mtGC> {
  HeapRegion*     _hr;         // å¼•ç”¨æ¥æºRegion
  CHeapBitMap     _bm;         // å¡ç‰‡ä½å›¾ (4MB/512B = 8192ä½ = 1KB)
  jint            _occupied;   // å ç”¨çš„å¡ç‰‡æ•°
  
  PerRegionTable* _next;       // é“¾è¡¨æŒ‡é’ˆ
  PerRegionTable* _prev;
};
```

#### 4. å­˜å‚¨é€‰æ‹©ç­–ç•¥

| å¼•ç”¨æ•°é‡ | å­˜å‚¨å±‚çº§ | ç©ºé—´æ•ˆç‡ | æŸ¥è¯¢æ•ˆç‡ |
|---------|---------|---------|---------|
| å°‘é‡ (<16) | Sparse PRT | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† |
| ä¸­ç­‰ | Fine-grain PRT | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… |
| å¤§é‡ (çƒ­ç‚¹) | Coarse Bitmap | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜†â˜†â˜† |

---

## é¢è¯•é—®é¢˜ 3ï¼šå¡è¡¨ï¼ˆCardTableï¼‰å’ŒRSetæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "CardTableå’ŒRSetéƒ½æ¶‰åŠ'å¡ç‰‡'æ¦‚å¿µï¼Œå®ƒä»¬æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. æ ¸å¿ƒåŒºåˆ«

| ç‰¹æ€§ | CardTable | RSet |
|------|-----------|------|
| **ç²’åº¦** | å…¨å±€ä¸€ä¸ª | æ¯Regionä¸€ä¸ª |
| **ä½œç”¨** | æ ‡è®°è„å¡ | è®°å½•è·¨Regionå¼•ç”¨ |
| **æ›´æ–°æ—¶æœº** | å†™å±éšœç«‹å³æ›´æ–° | å¹¶å‘ç»†åŒ–çº¿ç¨‹å¼‚æ­¥æ›´æ–° |
| **å­˜å‚¨å†…å®¹** | å¡ç‰‡çŠ¶æ€ | å¼•ç”¨æ¥æº |

#### 2. ååŒå·¥ä½œæµç¨‹

```
                      å†™å±éšœ â†’ CardTable â†’ RSet æ›´æ–°æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. åº”ç”¨çº¿ç¨‹å†™å…¥å¼•ç”¨: old_obj.field = new_obj                   â”‚
â”‚                          â†“                                      â”‚
â”‚  2. Post-write barrier:                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ card_table[addr >> 9] = dirty_card          â”‚             â”‚
â”‚     â”‚ dirty_card_queue.enqueue(card_addr)         â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â†“                                      â”‚
â”‚  3. å¹¶å‘ç»†åŒ–çº¿ç¨‹å¤„ç†:                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ ä»dirty_card_queueå–å‡ºè„å¡                   â”‚             â”‚
â”‚     â”‚ æ‰«æå¡ç‰‡ä¸­çš„å¼•ç”¨                              â”‚             â”‚
â”‚     â”‚ æ›´æ–°ç›®æ ‡Regionçš„RSet                         â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                          â†“                                      â”‚
â”‚  4. GCæ—¶ä½¿ç”¨RSet:                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ éå†CSetä¸­æ¯ä¸ªRegionçš„RSet                    â”‚             â”‚
â”‚     â”‚ æ‰«æRSetæŒ‡å‘çš„å¡ç‰‡                            â”‚             â”‚
â”‚     â”‚ æ‰¾åˆ°æ‰€æœ‰è·¨Regionå¼•ç”¨                          â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. æºç éªŒè¯

**å†™å±éšœæ ‡è®°è„å¡**ï¼š
```cpp
// g1BarrierSet.cpp
template <class T>
void G1BarrierSet::write_ref_field_post(T* field, oop new_val) {
  // è·å–å¡ç‰‡åœ°å€
  volatile jbyte* card = byte_for(field);
  
  // æ ‡è®°ä¸ºè„
  *card = G1CardTable::dirty_card;
  
  // å…¥é˜Ÿç­‰å¾…å¤„ç†
  if (new_val != NULL) {
    dirty_card_queue().enqueue(card);
  }
}
```

**å¹¶å‘ç»†åŒ–æ›´æ–°RSet**ï¼š
```cpp
// g1RemSet.cpp
void G1RemSet::refine_card_concurrently(CardValue* card_ptr, uint worker_i) {
  // æ‰¾åˆ°å¡ç‰‡å¯¹åº”çš„Region
  HeapRegion* card_region = _g1h->heap_region_containing(card_ptr);
  
  // æ‰«æå¡ç‰‡ä¸­çš„å¼•ç”¨
  for each reference in card:
    HeapRegion* to_region = _g1h->heap_region_containing(reference);
    // æ›´æ–°ç›®æ ‡Regionçš„RSet
    to_region->rem_set()->add_reference(card_ptr, worker_i);
}
```

---

## é¢è¯•é—®é¢˜ 4ï¼šå¹¶å‘ç»†åŒ–ï¼ˆConcurrent Refinementï¼‰æ˜¯ä»€ä¹ˆï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "ä»€ä¹ˆæ˜¯å¹¶å‘ç»†åŒ–ï¼Ÿæœ‰å‡ ä¸ªç»†åŒ–çº¿ç¨‹ï¼Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. å¹¶å‘ç»†åŒ–æ¦‚å¿µ

**ç›®çš„**ï¼šå°†è„å¡å¤„ç†ä»GCåœé¡¿ä¸­ç§»å‡ºï¼Œç”±ä¸“é—¨çš„åå°çº¿ç¨‹å¼‚æ­¥æ›´æ–°RSetã€‚

#### 2. ç»†åŒ–çº¿ç¨‹é…ç½®

```
GCæ—¥å¿—:
[gc,ergo,refine] Initial Refinement Zones: green: 13, yellow: 39, red: 65
```

**çº¿ç¨‹æ•°é‡**ï¼š
- é»˜è®¤ = `ParallelGCThreads` (13ä¸ª)
- å¯é…ç½®: `-XX:G1ConcRefinementThreads`

#### 3. ä¸‰åŒºè°ƒåº¦ç­–ç•¥

```cpp
// g1ConcurrentRefine.cpp
class G1ConcurrentRefine {
  // ä¸‰ä¸ªé˜ˆå€¼åŒºåŸŸ
  size_t _green_zone;   // ç»¿åŒºï¼šæ­£å¸¸ï¼Œå•çº¿ç¨‹å¤„ç†
  size_t _yellow_zone;  // é»„åŒºï¼šåŠ é€Ÿï¼Œå¤šçº¿ç¨‹æ¿€æ´»
  size_t _red_zone;     // çº¢åŒºï¼šç´§æ€¥ï¼Œåº”ç”¨çº¿ç¨‹å¸®å¿™
};
```

**é˜ˆå€¼è®¡ç®—**ï¼ˆ8GBå †ï¼Œ2048 Regionï¼‰ï¼š
| Zone | é˜ˆå€¼ | è®¡ç®— | å«ä¹‰ |
|------|------|------|------|
| Green | 13 | Regionæ•°/157 | æ­£å¸¸å¹¶å‘ç»†åŒ– |
| Yellow | 39 | Green Ã— 3 | æ¿€æ´»æ›´å¤šçº¿ç¨‹ |
| Red | 65 | Green Ã— 5 | åº”ç”¨çº¿ç¨‹å‚ä¸ |

#### 4. å·¥ä½œæµç¨‹

```
                     å¹¶å‘ç»†åŒ–Zoneè°ƒåº¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  è„å¡é˜Ÿåˆ—æ·±åº¦                                                   â”‚
â”‚        â†‘                                                        â”‚
â”‚        â”‚                                                        â”‚
â”‚   65 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Red Zone (åº”ç”¨çº¿ç¨‹å¸®å¿™)  â”‚
â”‚        â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                          â”‚
â”‚   39 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Yellow Zone (å¤šçº¿ç¨‹)     â”‚
â”‚        â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                    â”‚
â”‚   13 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Green Zone (å•çº¿ç¨‹)      â”‚
â”‚        â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                              â”‚
â”‚    0 â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´                    â”‚
â”‚                                                                 â”‚
â”‚  Green: ä»…ä¸»ç»†åŒ–çº¿ç¨‹å·¥ä½œ                                        â”‚
â”‚  Yellow: é€æ­¥æ¿€æ´»æ›´å¤šç»†åŒ–çº¿ç¨‹                                    â”‚
â”‚  Red: åº”ç”¨çº¿ç¨‹ä¹Ÿå‚ä¸å¤„ç†ï¼ˆæ€§èƒ½ä¸‹é™ï¼ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5. æºç åˆ†æ

```cpp
// g1ConcurrentRefineThread.cpp:92
void G1ConcurrentRefineThread::run_service() {
  while (!should_terminate()) {
    // ç­‰å¾…è„å¡
    wait_for_completed_buffers();
    
    // å¤„ç†è„å¡
    while (dcqs.has_completed_buffers()) {
      // åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´å¤šçº¿ç¨‹
      if (dcqs.buffers_num() > _yellow_zone && !next_thread_active) {
        activate_next_thread();
      }
      
      // å¤„ç†ä¸€ä¸ªç¼“å†²åŒº
      refine_one_buffer();
      
      // åˆ¤æ–­æ˜¯å¦éœ€è¦é€€å‡º
      if (dcqs.buffers_num() < _green_zone && !is_primary()) {
        deactivate();
        break;
      }
    }
  }
}
```

---

## é¢è¯•é—®é¢˜ 5ï¼šRSetçš„å†…å­˜å¼€é”€æœ‰å¤šå¤§ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "RSetä¼šå ç”¨å¤šå°‘å†…å­˜ï¼Ÿæ˜¯å¦å¯èƒ½æˆä¸ºç“¶é¢ˆï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. å†…å­˜å¼€é”€è®¡ç®—

**å›ºå®šå¼€é”€**ï¼ˆCoarse Bitmapï¼‰ï¼š
```
æ¯ä¸ªRegionä¸€ä½ = 2048 / 8 = 256 bytes/Region
æ€»å›ºå®šå¼€é”€ = 256B Ã— 2048 = 512KB
```

**åŠ¨æ€å¼€é”€**ï¼ˆPRTï¼‰ï¼š
```
æ¯ä¸ªPRT: Regionå†…å¡ç‰‡ä½å›¾ = 4MB / 512B / 8 = 1KB
æ¯ä¸ªRegionæœ€å¤šè‹¥å¹²PRTï¼ˆå–å†³äºå¼•ç”¨æ•°ï¼‰
```

#### 2. NMTå®æµ‹

```
-                        GC (reserved=392627663, committed=392627663)
                            (malloc=39499215 #14819)  â† åŒ…å«RSet
```

**mallocä¸­çº¦38MBåŒ…æ‹¬**ï¼š
- RSet (PerRegionTable, SparsePRT)
- å…¶ä»–GCç®¡ç†ç»“æ„

#### 3. å¯èƒ½çš„ç“¶é¢ˆ

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **RSetå†…å­˜è¿‡å¤§** | å¤§é‡è·¨Regionå¼•ç”¨ | å¢å¤§Regionå¤§å° |
| **å¹¶å‘ç»†åŒ–è·Ÿä¸ä¸Š** | å†™å±éšœå¤ªé¢‘ç¹ | ä¼˜åŒ–å¯¹è±¡åˆ†é…æ¨¡å¼ |
| **Coarseé™çº§** | çƒ­ç‚¹Region | åˆ†æå¼•ç”¨æ¨¡å¼ |

#### 4. ç›‘æ§æ–¹æ³•

```bash
# GCæ—¥å¿—ä¸­æŸ¥çœ‹RSetç»Ÿè®¡
java -Xlog:gc+remset=debug ...

# è¾“å‡ºç¤ºä¾‹
[gc,remset] Remembered Set: 
    Fine: 1234 entries  (ç²¾ç»†PRTæ•°)
    Coarse: 5 entries   (ç²—ç²’åº¦Regionæ•°)
    Sparse: 567 entries (ç¨€ç–æ¡ç›®æ•°)
```

---

## é¢è¯•é—®é¢˜ 6ï¼šGCæ—¶å¦‚ä½•ä½¿ç”¨RSetï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "GCæ—¶æ˜¯å¦‚ä½•åˆ©ç”¨RSetæ¥æ‰«æè·¨Regionå¼•ç”¨çš„ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. Scan RSé˜¶æ®µ

```
GCæ—¥å¿—:
[gc,phases] GC(0)     Scan RS (ms): Min:0.0, Avg:0.0, Max:0.0
```

#### 2. æ‰«ææµç¨‹

```cpp
// g1RemSet.cpp
void G1RemSet::scan_rem_set(...) {
  // å¯¹äºCSetä¸­çš„æ¯ä¸ªRegion
  for each region in collection_set:
    HeapRegionRemSet* rem_set = region->rem_set();
    
    // éå†RSetä¸­çš„æ¡ç›®
    HeapRegionRemSetIterator iter(rem_set);
    while (iter.has_next()) {
      size_t card_idx = iter.next();
      
      // æ‰«æè¯¥å¡ç‰‡ä¸­çš„å¯¹è±¡å¼•ç”¨
      scan_card(card_idx, closure);
    }
}
```

#### 3. ä¸‰å±‚éå†

```
                  RSetæ‰«ææµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                       â”‚
â”‚  1. éå†Coarse Bitmap                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ for each set_bit in coarse_map:     â”‚         â”‚
â”‚     â”‚   scan_entire_region(bit_idx)       â”‚â† æ•´ä¸ªRegionâ”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                       â”‚
â”‚  2. éå†Fine-grain PRTs                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ for each prt in fine_grain_regions: â”‚         â”‚
â”‚     â”‚   for each set_bit in prt->bitmap:  â”‚         â”‚
â”‚     â”‚     scan_card(bit_idx)              â”‚â† å•ä¸ªå¡ç‰‡ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                       â”‚
â”‚  3. éå†Sparse PRT                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚     â”‚ for each entry in sparse_prt:       â”‚         â”‚
â”‚     â”‚   scan_card(entry.card_idx)         â”‚â† å•ä¸ªå¡ç‰‡ â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4. å…³é”®ä¼˜åŒ–

**Coarseæ‰«æä»£ä»·é«˜**ï¼š
```
Coarse Bitmapä¸­çš„ä¸€ä¸ªä½ = éœ€è¦æ‰«ææ•´ä¸ªRegion (4MB / 8B = 512Kå¯¹è±¡)
Fine-grainä¸­çš„ä¸€ä¸ªä½ = åªéœ€æ‰«æä¸€ä¸ªå¡ç‰‡ (512B / 8B = 64å¯¹è±¡)
```

**GCæ—¥å¿—ä¸­ç›‘æ§**ï¼š
```
[gc,remset] GC(5) RSet Scanning: 
    Coarse: 2 regions (bad! éœ€è¦å…¨Regionæ‰«æ)
    Fine: 1234 cards
    Sparse: 56 cards
```

---

## é¢è¯•é—®é¢˜ 7ï¼šå¦‚ä½•ä¼˜åŒ–RSetç›¸å…³çš„æ€§èƒ½é—®é¢˜ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "å¦‚æœå‘ç°Scan RSæ—¶é—´è¿‡é•¿ï¼Œåº”è¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. é—®é¢˜è¯Šæ–­

```
[gc,phases] GC(5)     Scan RS (ms): Min:20.1, Avg:35.5, Max:55.2  â† è¿‡é•¿
```

**å¯èƒ½åŸå› **ï¼š
1. RSetæ¡ç›®è¿‡å¤šï¼ˆå¤§é‡è·¨Regionå¼•ç”¨ï¼‰
2. Coarseé™çº§è¿‡å¤šï¼ˆçƒ­ç‚¹Regionï¼‰
3. å¹¶å‘ç»†åŒ–è·Ÿä¸ä¸Šï¼ˆRSetä¸å®Œæ•´ï¼‰

#### 2. è°ƒä¼˜å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ |
|------|--------|------|
| `-XX:G1HeapRegionSize` | è‡ªåŠ¨ | å¢å¤§Regionå‡å°‘è·¨Regionå¼•ç”¨ |
| `-XX:G1ConcRefinementThreads` | auto | å¢åŠ å¹¶å‘ç»†åŒ–çº¿ç¨‹ |
| `-XX:G1RSetUpdatingPauseTimePercent` | 10% | STWä¸­å¤„ç†è„å¡çš„æ—¶é—´å æ¯” |
| `-XX:G1RSetRegionEntries` | 768 | æ¯Regionæœ€å¤§Fine PRTæ•° |

#### 3. ä¼˜åŒ–ç­–ç•¥

**ç­–ç•¥1ï¼šå¢å¤§Regionå¤§å°**
```bash
# ä»4MBå¢å¤§åˆ°8MB
java -XX:G1HeapRegionSize=8m ...

# æ•ˆæœï¼šè·¨Regionå¼•ç”¨å‡å°‘ä¸€åŠ
```

**ç­–ç•¥2ï¼šä¼˜åŒ–åº”ç”¨ä»£ç **
```java
// é¿å…å¤§é‡å¯¹è±¡è·¨Regionå¼•ç”¨
// Bad: é¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡å¼•ç”¨è€å¯¹è±¡
for (int i = 0; i < 1000000; i++) {
    new TempObject(oldObject);  // æ¯æ¬¡éƒ½äº§ç”Ÿè·¨ä»£å¼•ç”¨
}

// Good: æ‰¹é‡å¤„ç†ï¼Œå‡å°‘ä¸´æ—¶å¯¹è±¡
List<TempObject> batch = new ArrayList<>();
for (int i = 0; i < 1000000; i++) {
    batch.add(new TempObject());
}
processBatch(batch, oldObject);
```

**ç­–ç•¥3ï¼šç›‘æ§å¹¶é¢„è­¦**
```bash
# ç›‘æ§RSetå†…å­˜ä½¿ç”¨
jcmd <pid> GC.heap_info | grep -i remset

# ç›‘æ§å¹¶å‘ç»†åŒ–
jstat -gc <pid> 1000 | grep "DCQS"
```

---

## å®æˆ˜éªŒè¯ï¼šGDBè°ƒè¯•RSet

### 1. æ–­ç‚¹è®¾ç½®

```gdb
# RSetæ·»åŠ å¼•ç”¨
break heapRegionRemSet.cpp:add_reference

# å¹¶å‘ç»†åŒ–
break g1RemSet.cpp:refine_card_concurrently

# Scan RS
break g1RemSet.cpp:scan_rem_set
```

### 2. æŸ¥çœ‹RSetçŠ¶æ€

```gdb
(gdb) p region->rem_set()->_other_regions._n_fine_entries
$1 = 45  # 45ä¸ªFine-grain PRT

(gdb) p region->rem_set()->_other_regions._n_coarse_entries
$2 = 2   # 2ä¸ªCoarseé™çº§

(gdb) p region->rem_set()->mem_size()
$3 = 52480  # RSetå ç”¨çº¦51KB
```

### 3. æŸ¥çœ‹è„å¡é˜Ÿåˆ—

```gdb
(gdb) p G1BarrierSet::dirty_card_queue_set()._completed_buffers_head
(gdb) p G1BarrierSet::dirty_card_queue_set()._n_completed_buffers
$4 = 23  # 23ä¸ªå¾…å¤„ç†ç¼“å†²åŒº
```

---

## æ€»ç»“ï¼šé«˜é¢‘è€ƒç‚¹

| è€ƒç‚¹ | ç­”æ¡ˆè¦ç‚¹ |
|------|----------|
| RSetä½œç”¨ | è®°å½•è·¨Regionå¼•ç”¨ï¼Œé¿å…å…¨å †æ‰«æ |
| ä¸‰å±‚ç»“æ„ | Sparseâ†’Fine-grainâ†’Coarse |
| CardTableå…³ç³» | CardTableæ ‡è®°è„å¡ï¼ŒRSetè®°å½•å¼•ç”¨æ¥æº |
| å¹¶å‘ç»†åŒ– | åå°çº¿ç¨‹å¼‚æ­¥æ›´æ–°RSetï¼Œä¸‰åŒºè°ƒåº¦ |
| å†…å­˜å¼€é”€ | åŠ¨æ€å˜åŒ–ï¼Œå–å†³äºå¼•ç”¨æ¨¡å¼ |
| æ‰«ææµç¨‹ | Coarseå…¨Regionã€Fine/Sparseå•å¡ç‰‡ |
| ä¼˜åŒ–æ–¹æ³• | å¢å¤§Regionã€ä¼˜åŒ–å¼•ç”¨æ¨¡å¼ã€å¢åŠ ç»†åŒ–çº¿ç¨‹ |

---

**ä¸‹ä¸€ç¯‡**: [06-JVMè°ƒä¼˜å®æˆ˜](./06-JVMè°ƒä¼˜å®æˆ˜.md)
