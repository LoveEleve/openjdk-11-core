# JVMæŠ€æœ¯ä¸“å®¶é¢è¯•ä¸“é¡¹ - å¯¹è±¡åˆ†é…ä¸TLABæœºåˆ¶

> **ç¯å¢ƒ**: Linux, -Xms8g -Xmx8g, G1GC, Region=4MB, éå¤§é¡µ, éNUMA
> **éš¾åº¦**: â­â­â­â­â­ JVMæŠ€æœ¯ä¸“å®¶çº§

---

## é¢è¯•é—®é¢˜ 1ï¼šJavaå¯¹è±¡åˆ†é…æœ‰å“ªäº›è·¯å¾„ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "ä¸€ä¸ªnew Object()çš„åˆ†é…è¯·æ±‚ï¼Œåœ¨JVMå†…éƒ¨ä¼šç»è¿‡å“ªäº›åˆ†é…è·¯å¾„ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. å¯¹è±¡åˆ†é…çš„ä¸‰æ¡è·¯å¾„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯¹è±¡åˆ†é…å†³ç­–æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                    new Object()                                 â”‚
â”‚                         â†“                                       â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚              â”‚ size > RegionSize/2 â”‚                           â”‚
â”‚              â”‚    (> 2MB)          â”‚                           â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                   Yes â†“     â†“ No                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â”‚ Humongousâ”‚  â”‚ TLABåˆ†é…å°è¯•      â”‚               â”‚
â”‚              â”‚ åˆ†é…     â”‚  â”‚ (æ— é”ã€æœ€å¿«)      â”‚               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                  æˆåŠŸ â†“     â†“ å¤±è´¥              â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                            â”‚ è¿”å›åœ°å€  â”‚  â”‚ æ…¢é€Ÿåˆ†é…è·¯å¾„   â”‚    â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ (éœ€è¦é”)       â”‚    â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æºç å…¥å£

```cpp
// g1CollectedHeap.hpp:405-436
// ä¸¤ä¸ªä¸»è¦åˆ†é…å…¥å£ï¼š
// 1. allocate_new_tlab() - TLABåˆ†é…
// 2. mem_allocate() - éTLABåˆ†é…

// TLABåˆ†é…å…¥å£
virtual HeapWord* allocate_new_tlab(size_t min_size,
                                    size_t requested_size,
                                    size_t* actual_size);

// éTLABåˆ†é…å…¥å£ï¼ˆåŒ…æ‹¬å¤§å¯¹è±¡ï¼‰
virtual HeapWord* mem_allocate(size_t word_size,
                               bool* gc_overhead_limit_was_exceeded);
```

#### 3. ä¸‰æ¡è·¯å¾„å¯¹æ¯”

| è·¯å¾„ | è§¦å‘æ¡ä»¶ | æ˜¯å¦éœ€è¦é” | æ€§èƒ½ |
|------|----------|------------|------|
| **TLABå¿«é€Ÿåˆ†é…** | size < TLABå‰©ä½™ç©ºé—´ | æ— é” | â˜…â˜…â˜…â˜…â˜… |
| **TLABæ…¢é€Ÿåˆ†é…** | TLABä¸è¶³ã€éœ€è¦æ–°TLAB | Heap_lock | â˜…â˜…â˜…â˜†â˜† |
| **Humongousåˆ†é…** | size > RegionSize/2 | Heap_lock | â˜…â˜†â˜†â˜†â˜† |

---

## é¢è¯•é—®é¢˜ 2ï¼šTLABæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "TLABçš„å…¨ç§°æ˜¯ä»€ä¹ˆï¼Ÿå®ƒè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. TLABåŸºæœ¬æ¦‚å¿µ

**TLAB = Thread Local Allocation Bufferï¼ˆçº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²ï¼‰**

**æ ¸å¿ƒæ€æƒ³**ï¼šç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å—ç§æœ‰çš„å†…å­˜åŒºåŸŸï¼Œåœ¨è¿™å—åŒºåŸŸå†…åˆ†é…å¯¹è±¡**æ— éœ€åŠ é”**ã€‚

#### 2. è§£å†³çš„é—®é¢˜

**æ²¡æœ‰TLABæ—¶**ï¼š
```cpp
// å¤šçº¿ç¨‹åˆ†é…éœ€è¦CASæˆ–é”
HeapWord* allocate(size_t size) {
  while (true) {
    HeapWord* old_top = eden_top;
    HeapWord* new_top = old_top + size;
    if (CAS(&eden_top, old_top, new_top)) {
      return old_top;  // CASæˆåŠŸ
    }
    // CASå¤±è´¥ï¼Œé‡è¯• â†’ é«˜å¹¶å‘ä¸‹æ€§èƒ½å·®
  }
}
```

**æœ‰TLABå**ï¼š
```cpp
// æ¯ä¸ªçº¿ç¨‹ç§æœ‰TLABï¼Œæ— éœ€CAS
HeapWord* allocate_in_tlab(size_t size) {
  HeapWord* result = tlab_top;
  HeapWord* new_top = result + size;
  if (new_top <= tlab_end) {
    tlab_top = new_top;
    return result;  // ç›´æ¥æŒ‡é’ˆç¢°æ’ï¼Œæ— é”
  }
  return slow_allocate(size);
}
```

#### 3. TLABæ•°æ®ç»“æ„

```cpp
// threadLocalAllocBuffer.hpp:46
class ThreadLocalAllocBuffer {
private:
  HeapWord* _start;           // TLABèµ·å§‹åœ°å€
  HeapWord* _top;             // å½“å‰åˆ†é…æŒ‡é’ˆ
  HeapWord* _end;             // é‡‡æ ·ç‚¹æˆ–åˆ†é…ç»“æŸç‚¹
  HeapWord* _allocation_end;  // å®é™…TLABç»“æŸåœ°å€
  
  size_t _desired_size;       // æœŸæœ›å¤§å°
  size_t _refill_waste_limit; // æµªè´¹é˜ˆå€¼
  
  unsigned _number_of_refills;  // é‡å¡«æ¬¡æ•°
  unsigned _slow_allocations;   // æ…¢é€Ÿåˆ†é…æ¬¡æ•°
  unsigned _gc_waste;           // GCæ—¶æµªè´¹é‡
};
```

#### 4. TLABå†…å­˜å¸ƒå±€

```
         TLABåœ¨Eden Regionä¸­çš„ä½ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Eden Region (4MB)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”¤
â”‚ TLAB1 â”‚ TLAB2 â”‚ TLAB3 â”‚       æœªåˆ†é…ç©ºé—´          â”‚ â”‚
â”‚(Threadâ”‚(Threadâ”‚(Threadâ”‚                           â”‚ â”‚
â”‚   1)  â”‚   2)  â”‚   3)  â”‚                           â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”˜

         å•ä¸ªTLABå†…éƒ¨ç»“æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TLAB (é»˜è®¤~256KB)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å·²åˆ†é…å¯¹è±¡  â”‚  _top â†’ ä¸‹æ¬¡åˆ†é…ç‚¹   â”‚    å‰©ä½™ç©ºé—´     â”‚
â”‚   Object1   â”‚                     â”‚                  â”‚
â”‚   Object2   â”‚                     â”‚   â† _end        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _start                            _allocation_end    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é¢è¯•é—®é¢˜ 3ï¼šTLABçš„å¤§å°æ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "TLABå¤§å°æ˜¯å›ºå®šçš„å—ï¼ŸJVMæ˜¯å¦‚ä½•åŠ¨æ€è°ƒæ•´TLABå¤§å°çš„ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. TLABå¤§å°è®¡ç®—

**é»˜è®¤è®¡ç®—å…¬å¼**ï¼š

```cpp
// TLABåˆå§‹å¤§å°
initial_desired_size = Eden / (çº¿ç¨‹æ•° Ã— TLABRefillWasteFraction)

// TLABRefillWasteFractioné»˜è®¤å€¼ = 64
// 8GBå †ï¼ŒEdençº¦5GBï¼Œå‡è®¾10çº¿ç¨‹
// initial_desired_size â‰ˆ 5GB / (10 Ã— 64) â‰ˆ 8MB
```

**å®é™…çº¦æŸ**ï¼š
```cpp
// æœ‰æœ€å¤§é™åˆ¶
_max_size = max(Universe::heap()->max_tlab_size(), MinTLABSize);

// MinTLABSize = 2KB
// max_tlab_size = RegionSize / 2 = 4MB / 2 = 2MB
```

#### 2. åŠ¨æ€è°ƒæ•´ç­–ç•¥

```cpp
// threadLocalAllocBuffer.cpp
void ThreadLocalAllocBuffer::resize() {
  // æ ¹æ®åˆ†é…é‡åŠ¨æ€è°ƒæ•´
  size_t alloc_history = allocations_since_last_gc();
  size_t new_size = compute_size(alloc_history);
  
  // å¹³æ»‘è°ƒæ•´ï¼Œé¿å…å‰§çƒˆå˜åŒ–
  _desired_size = (old_size + new_size) / 2;
}
```

#### 3. çœŸå®GCæ—¥å¿—ä¸­çš„TLABç»Ÿè®¡

```
[gc,tlab] GC(0) TLAB totals: 
    thrds: 6  refills: 19 max: 14 
    slow allocs: 5963 max 5963 
    waste: 22.2% gc: 6356424B max: 2096872B
```

| æŒ‡æ ‡ | å€¼ | å«ä¹‰ |
|------|-----|------|
| thrds | 6 | 6ä¸ªçº¿ç¨‹ä½¿ç”¨äº†TLAB |
| refills | 19 | TLABé‡æ–°å¡«å……19æ¬¡ |
| slow allocs | 5963 | æ…¢é€Ÿåˆ†é…æ¬¡æ•° |
| waste | 22.2% | TLABæµªè´¹ç‡ |
| gc waste | 6MB | GCæ—¶TLABå‰©ä½™ç©ºé—´ |

#### 4. TLABè°ƒä¼˜å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ |
|------|--------|------|
| `-XX:+UseTLAB` | true | å¯ç”¨TLAB |
| `-XX:TLABSize` | 0(è‡ªåŠ¨) | åˆå§‹TLABå¤§å° |
| `-XX:TLABWasteTargetPercent` | 1% | ç›®æ ‡æµªè´¹ç‡ |
| `-XX:TLABRefillWasteFraction` | 64 | æµªè´¹é˜ˆå€¼å› å­ |
| `-XX:-ResizeTLAB` | true | åŠ¨æ€è°ƒæ•´TLAB |

---

## é¢è¯•é—®é¢˜ 4ï¼šä»€ä¹ˆæ˜¯TLABæµªè´¹ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "GCæ—¥å¿—æ˜¾ç¤ºTLABæµªè´¹22.2%ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. TLABæµªè´¹çš„æ¥æº

**åœºæ™¯1ï¼šå¯¹è±¡å¤ªå¤§ï¼ŒTLABæ”¾ä¸ä¸‹**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TLAB                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    å·²åˆ†é…å¯¹è±¡     â”‚  å‰©ä½™ç©ºé—´(100KB)   â”‚
â”‚                  â”‚  â† æµªè´¹            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        æ–°å¯¹è±¡éœ€è¦200KB â†’ TLABæ”¾ä¸ä¸‹
        â†’ ç”³è¯·æ–°TLABï¼Œæ—§TLABå‰©ä½™100KBè¢«æµªè´¹
```

**åœºæ™¯2ï¼šGCæ—¶TLABæœªç”¨å®Œ**
```
GCå‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰çº¿ç¨‹çš„TLABå‰©ä½™ç©ºé—´éƒ½ä¼šè¢«æµªè´¹
gc_waste = Î£(å„çº¿ç¨‹TLABå‰©ä½™ç©ºé—´)
```

#### 2. æµªè´¹ç‡è®¡ç®—

```cpp
waste_rate = (fast_refill_waste + slow_refill_waste + gc_waste) 
           / total_allocated_in_tlab

// æ—¥å¿—ä¸­çš„22.2%è¡¨ç¤ºï¼š
// æ€»å…±åˆ†é…100MBï¼Œæœ‰22.2MBè¢«æµªè´¹
```

#### 3. ä¼˜åŒ–ç­–ç•¥

| æµªè´¹ç±»å‹ | ä¼˜åŒ–æ–¹æ³• |
|----------|----------|
| **refillæµªè´¹é«˜** | å¢å¤§TLAB (-XX:TLABSize) |
| **gc_wasteé«˜** | å‡å°TLAB æˆ– å‡å°‘GCé¢‘ç‡ |
| **slow allocsé«˜** | å¢å¤§TLAB |

**å‚æ•°è°ƒä¼˜ç¤ºä¾‹**ï¼š

```bash
# åœºæ™¯ï¼šslow allocsè¿‡é«˜
java -XX:TLABSize=512k  # å¢å¤§TLAB

# åœºæ™¯ï¼šgc_wasteè¿‡é«˜
java -XX:TLABSize=128k  # å‡å°TLAB

# ç›‘æ§TLAB
java -Xlog:gc+tlab=debug ...
```

---

## é¢è¯•é—®é¢˜ 5ï¼šHumongouså¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•åˆ†é…ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "ä»€ä¹ˆæ˜¯Humongouså¯¹è±¡ï¼Ÿå®ƒæ˜¯å¦‚ä½•åˆ†é…çš„ï¼Ÿæœ‰ä»€ä¹ˆæ³¨æ„äº‹é¡¹ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. Humongouså¯¹è±¡å®šä¹‰

```cpp
// g1CollectedHeap.cpp:99
size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;

// é˜ˆå€¼è®¡ç®—: RegionSize / 2
// 4MB Region â†’ é˜ˆå€¼ = 2MB
// ä»»ä½• â‰¥ 2MB çš„å¯¹è±¡éƒ½æ˜¯Humongouså¯¹è±¡
```

#### 2. åˆ†é…æ–¹å¼

**Humongouså¯¹è±¡ç›´æ¥åœ¨OldåŒºåˆ†é…**ï¼Œä½¿ç”¨è¿ç»­çš„Regionï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Humongouså¯¹è±¡åˆ†é…                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  å¯¹è±¡å¤§å°: 10MB (éœ€è¦ 10/4 = 3ä¸ªRegionï¼Œå‘ä¸Šå–æ•´)              â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ StartsHumongous â”‚ ContinuesHumongous â”‚ ContinuesHumongous â”‚                 â”‚
â”‚  â”‚   Region #100    â”‚     Region #101     â”‚     Region #102     â”‚                 â”‚
â”‚  â”‚   (4MB)         â”‚      (4MB)          â”‚     (2MB + 2MBç©º)   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â†‘                                                     â”‚
â”‚    _humongous_start_region                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. æºç åˆ†æ

```cpp
// g1CollectedHeap.cpp
HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
  // è®¡ç®—éœ€è¦çš„Regionæ•°é‡
  size_t num_regions = calc_regions_for_humongous(word_size);
  
  // å¯»æ‰¾è¿ç»­çš„ç©ºé—²Region
  uint first = find_contiguous_regions(num_regions);
  
  if (first == G1_NO_HRM_INDEX) {
    // æ‰¾ä¸åˆ°è¿ç»­ç©ºé—´ï¼Œè§¦å‘GC
    return NULL;
  }
  
  // åˆå§‹åŒ–Humongous Region
  return humongous_obj_allocate_initialize_regions(first, num_regions, word_size);
}
```

#### 4. æ³¨æ„äº‹é¡¹

| é—®é¢˜ | å½±å“ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **ç¢ç‰‡åŒ–** | å¯èƒ½æ‰¾ä¸åˆ°è¿ç»­Region | å¢å¤§RegionSize |
| **å›æ”¶å»¶è¿Ÿ** | é»˜è®¤ç­‰åˆ°å¹¶å‘æ ‡è®°åæ‰å›æ”¶ | å¯ç”¨Eager Reclaim |
| **Full GCè§¦å‘** | Humongousåˆ†é…å¤±è´¥è§¦å‘Full GC | å‡å°‘å¤§å¯¹è±¡åˆ†é… |

#### 5. Eager Reclaimä¼˜åŒ–

```bash
# JDK8u40+é»˜è®¤å¯ç”¨
-XX:+G1EagerReclaimHumongousObjects

# æ•ˆæœï¼šYoung GCæ—¶å³å¯å›æ”¶æ— å¼•ç”¨çš„Humongouså¯¹è±¡
```

**çœŸå®æ—¥å¿—**ï¼š
```
[gc,phases] GC(0)     Humongous Reclaim: 0.2ms
[gc,phases] GC(0)       Humongous Total: 5
[gc,phases] GC(0)       Humongous Candidate: 3
[gc,phases] GC(0)       Humongous Reclaimed: 2
```

---

## é¢è¯•é—®é¢˜ 6ï¼šå¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šæ™‹å‡åˆ°OldåŒºï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "ä¸€ä¸ªå¯¹è±¡åœ¨YoungåŒºå­˜æ´»åï¼Œä»€ä¹ˆæ¡ä»¶ä¸‹ä¼šæ™‹å‡åˆ°OldåŒºï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. æ™‹å‡æ¡ä»¶

| æ¡ä»¶ | è¯´æ˜ | å‚æ•° |
|------|------|------|
| **å¹´é¾„é˜ˆå€¼** | å¯¹è±¡å¹´é¾„ â‰¥ MaxTenuringThreshold | `-XX:MaxTenuringThreshold=15` |
| **åŠ¨æ€å¹´é¾„åˆ¤å®š** | Survivorä¸­ç›¸åŒå¹´é¾„å¯¹è±¡æ€»å¤§å° > Survivor/2 | è‡ªåŠ¨è°ƒæ•´ |
| **Survivoræº¢å‡º** | Survivoræ”¾ä¸ä¸‹ | - |
| **å¤§å¯¹è±¡ç›´æ¥æ™‹å‡** | å¯¹è±¡å¤ªå¤§TLAB/Survivoræ”¾ä¸ä¸‹ | - |

#### 2. å¹´é¾„è®¡ç®—

```cpp
// å¯¹è±¡å¤´ä¸­çš„å¹´é¾„å­—æ®µï¼ˆ4ä½ï¼Œæœ€å¤§15ï¼‰
class markOop {
  // ... age bits: 4ä½ï¼ŒèŒƒå›´0-15
};

// æ¯æ¬¡GCå­˜æ´»ï¼Œå¹´é¾„+1
oop copy_to_survivor_space(oop obj) {
  obj->incr_age();  // å¹´é¾„+1
  
  if (obj->age() >= tenuring_threshold) {
    // æ™‹å‡åˆ°OldåŒº
    return copy_to_old_space(obj);
  } else {
    // ç»§ç»­ç•™åœ¨Survivor
    return copy_to_survivor(obj);
  }
}
```

#### 3. åŠ¨æ€å¹´é¾„åˆ¤å®š

```cpp
// ageTable.cpp
void compute_tenuring_threshold(size_t survivor_capacity) {
  size_t desired_survivor_size = survivor_capacity * TargetSurvivorRatio / 100;
  size_t total = 0;
  
  for (int age = 1; age <= MaxTenuringThreshold; age++) {
    total += sizes[age];
    if (total > desired_survivor_size) {
      // è¯¥å¹´é¾„åŠä»¥ä¸Šçš„å¯¹è±¡éƒ½æ™‹å‡
      tenuring_threshold = age;
      break;
    }
  }
}
```

#### 4. çœŸå®GCæ—¥å¿—

```
[gc,age] GC(0) Desired survivor size 27262976 bytes (26MB)
[gc,age] GC(0) new threshold 15 (max threshold 15)

[gc,heap] GC(0) Eden regions: 102->0(89)
[gc,heap] GC(0) Survivor regions: 0->13(13)
[gc,heap] GC(0) Old regions: 0->86   â† 86ä¸ªRegionæ™‹å‡
```

**æ™‹å‡ç‡ = 86 / 102 = 84.3%**ï¼Œè¯´æ˜å¤§é‡å¯¹è±¡ç›´æ¥æ™‹å‡ã€‚

---

## é¢è¯•é—®é¢˜ 7ï¼šPLABæ˜¯ä»€ä¹ˆï¼Ÿå’ŒTLABæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

### ğŸ‘¨â€ğŸ’¼ é¢è¯•å®˜æé—®

> "GCæ—¶ä½¿ç”¨çš„PLABæ˜¯ä»€ä¹ˆï¼Ÿå®ƒå’ŒTLABæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"

### ğŸ‘¨â€ğŸ“ é¢è¯•è€…å›ç­”

#### 1. PLABæ¦‚å¿µ

**PLAB = Promotion Local Allocation Bufferï¼ˆæ™‹å‡æœ¬åœ°åˆ†é…ç¼“å†²ï¼‰**

**ä½œç”¨**ï¼šGCæ—¶æ¯ä¸ªWorkerçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„PLABï¼Œé¿å…å¤åˆ¶å¯¹è±¡æ—¶çš„é”ç«äº‰ã€‚

#### 2. TLAB vs PLAB

| ç‰¹æ€§ | TLAB | PLAB |
|------|------|------|
| **å…¨ç§°** | Thread Local Allocation Buffer | Promotion Local Allocation Buffer |
| **ä½¿ç”¨æ—¶æœº** | åº”ç”¨çº¿ç¨‹åˆ†é…æ–°å¯¹è±¡ | GCæ—¶å¤åˆ¶å­˜æ´»å¯¹è±¡ |
| **ä½¿ç”¨è€…** | åº”ç”¨çº¿ç¨‹ï¼ˆMutatorï¼‰ | GC Workerçº¿ç¨‹ |
| **åˆ†é…åŒºåŸŸ** | Eden | Survivor / Old |
| **ç”Ÿå‘½å‘¨æœŸ** | è·¨GC | å•æ¬¡GCå†… |

#### 3. æºç ç»“æ„

```cpp
// g1PLABAllocator.hpp
class G1PLABAllocator {
  // SurvivoråŒºPLAB
  G1PLAB _survivor_plab;
  
  // OldåŒºPLAB
  G1PLAB _old_plab;
  
  HeapWord* allocate_direct_or_new_plab(
      InCSetState dest,
      size_t word_size, 
      bool* plab_refill_failed) {
    
    G1PLAB* plab = dest.is_young() ? &_survivor_plab : &_old_plab;
    HeapWord* result = plab->allocate(word_size);
    
    if (result == NULL) {
      // PLABç”¨å®Œï¼Œç”³è¯·æ–°çš„
      result = allocate_new_plab(dest, word_size);
    }
    return result;
  }
};
```

#### 4. PLABæµç¨‹

```
                GCæ—¶å¯¹è±¡å¤åˆ¶æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                    â”‚
â”‚  Worker 0     Worker 1     Worker 2    ...         â”‚
â”‚     â†“            â†“            â†“                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚PLAB_Sâ”‚    â”‚PLAB_Sâ”‚    â”‚PLAB_Sâ”‚   Survivor PLABsâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚PLAB_Oâ”‚    â”‚PLAB_Oâ”‚    â”‚PLAB_Oâ”‚   Old PLABs    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                    â”‚
â”‚  æ¯ä¸ªWorkerç‹¬ç«‹åˆ†é…ï¼Œæ— é”ç«äº‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®æˆ˜éªŒè¯ï¼šGDBè°ƒè¯•å¯¹è±¡åˆ†é…

### 1. TLABåˆ†é…æ–­ç‚¹

```gdb
# TLABåˆ†é…å…¥å£
break g1CollectedHeap.cpp:395  # allocate_new_tlab

# æ…¢é€Ÿåˆ†é…è·¯å¾„
break g1CollectedHeap.cpp:404  # mem_allocate

# Humongousåˆ†é…
break g1CollectedHeap.cpp:humongous_obj_allocate
```

### 2. æŸ¥çœ‹TLABçŠ¶æ€

```gdb
(gdb) p thread->tlab()._start
$1 = 0x600100000

(gdb) p thread->tlab()._top
$2 = 0x600100400  # å·²åˆ†é…1KB

(gdb) p thread->tlab()._end - thread->tlab()._top
$3 = 262144  # å‰©ä½™256KB
```

### 3. æŸ¥çœ‹Humongousé˜ˆå€¼

```gdb
(gdb) p G1CollectedHeap::_humongous_object_threshold_in_words
$4 = 262144  # = 2MB / 8 = 256K words
```

---

## æ€»ç»“ï¼šé«˜é¢‘è€ƒç‚¹

| è€ƒç‚¹ | ç­”æ¡ˆè¦ç‚¹ |
|------|----------|
| åˆ†é…è·¯å¾„ | TLABå¿«é€Ÿ â†’ TLABæ…¢é€Ÿ â†’ Humongous |
| TLABä½œç”¨ | æ— é”åˆ†é…ï¼Œæ¯çº¿ç¨‹ç§æœ‰ |
| TLABå¤§å° | åŠ¨æ€è°ƒæ•´ï¼Œé»˜è®¤Eden/(çº¿ç¨‹Ã—64) |
| TLABæµªè´¹ | refillæµªè´¹+gc_wasteï¼Œéœ€è¦å¹³è¡¡ |
| Humongous | â‰¥Region/2ï¼Œç›´æ¥OldåŒºï¼Œè¿ç»­Region |
| æ™‹å‡æ¡ä»¶ | å¹´é¾„â‰¥15ã€åŠ¨æ€å¹´é¾„ã€Survivoræº¢å‡º |
| PLAB | GCæ—¶ç”¨ï¼Œæ¯Workerç‹¬ç«‹ï¼Œé¿å…é” |

---

**ä¸‹ä¸€ç¯‡**: [04-å¹¶å‘æ ‡è®°ä¸SATBç®—æ³•](./04-å¹¶å‘æ ‡è®°ä¸SATBç®—æ³•.md)
