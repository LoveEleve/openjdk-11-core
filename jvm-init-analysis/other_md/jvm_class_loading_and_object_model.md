# JVMç±»åŠ è½½ç³»ç»Ÿä¸å¯¹è±¡æ¨¡å‹è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVMç±»åŠ è½½ç³»ç»Ÿå’Œå¯¹è±¡æ¨¡å‹ç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬SystemDictionaryã€ClassLoaderDataã€Klassã€InstanceKlassã€Methodã€ConstantPoolä»¥åŠå¯¹è±¡å¤´ç»“æ„oopDescå’ŒmarkOopã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (é»˜è®¤)

---

## ğŸ“š **1. SystemDictionary - ç³»ç»Ÿç±»å­—å…¸**

### **1.1 æ¦‚è¿°**

`SystemDictionary`æ˜¯ç±»åŠ è½½çš„æ ¸å¿ƒï¼Œç®¡ç†æ‰€æœ‰å·²åŠ è½½çš„ç±»ï¼Œæ˜¯ä¸€ä¸ª`AllStatic`ç±»ã€‚

### **1.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class SystemDictionary : AllStatic {
  // ==================== çŸ¥åç±»æ•°ç»„ ====================
  static InstanceKlass* _well_known_klasses[];
  // åŒ…å«çº¦100ä¸ªé¢„å®šä¹‰çš„ç³»ç»Ÿç±»ï¼Œå¦‚:
  // Object_klass, String_klass, Class_klass, Thread_klass...
  
  // ==================== è£…ç®±ç±»æ•°ç»„ ====================
  static InstanceKlass* _box_klasses[T_VOID+1];
  // Boolean, Byte, Character, Short, Integer, Long, Float, Double, Void
  
  // ==================== å ä½ç¬¦è¡¨ ====================
  static PlaceholderTable* _placeholders;
  // æ­£åœ¨åŠ è½½çš„ç±»å ä½ç¬¦ï¼Œé˜²æ­¢é‡å¤åŠ è½½
  
  // ==================== å…±äº«å­—å…¸ ====================
  static Dictionary* _shared_dictionary;
  // CDSå…±äº«å½’æ¡£ä¸­çš„ç±»å­—å…¸
  
  // ==================== ç±»åŠ è½½å™¨é” ====================
  static oop _system_loader_lock_obj;
  // ç³»ç»Ÿç±»åŠ è½½å™¨é”å¯¹è±¡
  
  // ==================== çº¦æŸè¡¨ ====================
  static LoaderConstraintTable* _loader_constraints;
  // ç±»åŠ è½½å™¨çº¦æŸè¡¨ï¼Œç¡®ä¿ç±»å‹å®‰å…¨
  
  // ==================== è§£æé”™è¯¯è¡¨ ====================
  static ResolutionErrorTable* _resolution_errors;
  // è®°å½•è§£æå¤±è´¥çš„ç±»/æ–¹æ³•/å­—æ®µ
  
  // ==================== JSR 292æ”¯æŒ ====================
  static SymbolPropertyTable* _invoke_method_table;
  // MethodHandleè°ƒç”¨æ–¹æ³•è¡¨
  
  // ==================== ä¿æŠ¤åŸŸç¼“å­˜ ====================
  static ProtectionDomainCacheTable* _pd_cache_table;
  
  // ==================== å¼±å¼•ç”¨å­˜å‚¨ ====================
  static OopStorage* _vm_weak_oop_storage;
  
  // ==================== ç±»åŠ è½½å™¨å®ä¾‹ ====================
  static oop _java_system_loader;       // ç³»ç»Ÿç±»åŠ è½½å™¨
  static oop _java_platform_loader;     // å¹³å°ç±»åŠ è½½å™¨
};
```

### **1.3 çŸ¥åç±»åˆ—è¡¨ (éƒ¨åˆ†)**

```cpp
// é€šè¿‡å®WK_KLASSES_DOå®šä¹‰
#define WK_KLASSES_DO(do_klass)                                             \
  /* æ ¸å¿ƒç±» */                                                               \
  do_klass(Object_klass,                java_lang_Object               )    \
  do_klass(String_klass,                java_lang_String               )    \
  do_klass(Class_klass,                 java_lang_Class                )    \
  do_klass(Cloneable_klass,             java_lang_Cloneable            )    \
  do_klass(ClassLoader_klass,           java_lang_ClassLoader          )    \
  do_klass(Serializable_klass,          java_io_Serializable           )    \
  do_klass(System_klass,                java_lang_System               )    \
  /* å¼‚å¸¸ç±» */                                                               \
  do_klass(Throwable_klass,             java_lang_Throwable            )    \
  do_klass(Error_klass,                 java_lang_Error                )    \
  do_klass(Exception_klass,             java_lang_Exception            )    \
  do_klass(RuntimeException_klass,      java_lang_RuntimeException     )    \
  /* çº¿ç¨‹ç±» */                                                               \
  do_klass(Thread_klass,                java_lang_Thread               )    \
  do_klass(ThreadGroup_klass,           java_lang_ThreadGroup          )    \
  /* å¼•ç”¨ç±» */                                                               \
  do_klass(Reference_klass,             java_lang_ref_Reference        )    \
  do_klass(SoftReference_klass,         java_lang_ref_SoftReference    )    \
  do_klass(WeakReference_klass,         java_lang_ref_WeakReference    )    \
  do_klass(FinalReference_klass,        java_lang_ref_FinalReference   )    \
  do_klass(PhantomReference_klass,      java_lang_ref_PhantomReference )    \
  /* JSR 292 */                                                              \
  do_klass(MethodHandle_klass,          java_lang_invoke_MethodHandle  )    \
  do_klass(MethodType_klass,            java_lang_invoke_MethodType    )    \
  // ... çº¦100ä¸ªç±»
```

### **1.4 ç±»åŠ è½½æµç¨‹**

```
ç±»åŠ è½½æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥SystemDictionary                                     â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ å·²åŠ è½½? â†’ è¿”å›Klass                                   â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ æœªåŠ è½½? â†’ ç»§ç»­                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. æ£€æŸ¥PlaceholderTable                                     â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ æ­£åœ¨åŠ è½½? â†’ ç­‰å¾…                                      â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ æœªåœ¨åŠ è½½? â†’ æ·»åŠ å ä½ç¬¦                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. è°ƒç”¨ç±»åŠ è½½å™¨                                              â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ Bootstrap â†’ ä»rt.jar/modulesåŠ è½½                     â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ Platform â†’ ä»å¹³å°æ¨¡å—åŠ è½½                             â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ Application â†’ ä»classpathåŠ è½½                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. è§£æç±»æ–‡ä»¶                                                â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ ClassFileParser::parseClassFile()                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. åˆ›å»ºInstanceKlass                                        â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ åˆ†é…Metaspaceå†…å­˜                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. é“¾æ¥ç±»                                                    â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ éªŒè¯                                                  â”‚
â”‚    â”œâ”€â”€ å‡†å¤‡ (åˆ†é…é™æ€å­—æ®µ)                                   â”‚
â”‚    â””â”€â”€ è§£æ (ç¬¦å·å¼•ç”¨â†’ç›´æ¥å¼•ç”¨)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. æ·»åŠ åˆ°Dictionary                                         â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ ç§»é™¤å ä½ç¬¦                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ **2. ClassLoaderData - ç±»åŠ è½½å™¨æ•°æ®**

### **2.1 æ¦‚è¿°**

æ¯ä¸ªç±»åŠ è½½å™¨æ‹¥æœ‰ä¸€ä¸ª`ClassLoaderData`å®ä¾‹ï¼Œå°è£…äº†ç±»åŠ è½½å™¨çš„å…ƒæ•°æ®åˆ†é…ç©ºé—´å’Œç±»å®šä¹‰ã€‚

### **2.2 ClassLoaderDataGraph**

```cpp
class ClassLoaderDataGraph : AllStatic {
  // ==================== CLDé“¾è¡¨ ====================
  static ClassLoaderData* _head;        // CLDé“¾è¡¨å¤´
  static ClassLoaderData* _unloading;   // æ­£åœ¨å¸è½½çš„CLDé“¾è¡¨
  static ClassLoaderData* _saved_head;  // CMSæ”¯æŒ
  
  // ==================== çŠ¶æ€æ ‡å¿— ====================
  static bool _should_purge;            // æ˜¯å¦åº”è¯¥æ¸…ç†
  static bool _metaspace_oom;           // å…ƒç©ºé—´OOMæ ‡å¿—
  
  // ==================== ç»Ÿè®¡ ====================
  static volatile size_t _num_instance_classes;  // å®ä¾‹ç±»è®¡æ•°
  static volatile size_t _num_array_classes;     // æ•°ç»„ç±»è®¡æ•°
};
```

### **2.3 ClassLoaderDataå®ä¾‹æˆå‘˜**

```cpp
class ClassLoaderData : public CHeapObj<mtClass> {
  // ==================== Bootstrap CLD ====================
  static ClassLoaderData* _the_null_class_loader_data;
  // Bootstrapç±»åŠ è½½å™¨çš„CLD (null loader)
  
  // ==================== ç”Ÿå‘½å‘¨æœŸç®¡ç† ====================
  WeakHandle _holder;                   // å†³å®šæ­¤CLDç”Ÿå‘½å‘¨æœŸçš„oop
  OopHandle _class_loader;              // java.lang.ClassLoaderå®ä¾‹
  
  // ==================== å…ƒç©ºé—´ ====================
  ClassLoaderMetaspace* volatile _metaspace;  // å…ƒç©ºé—´
  Mutex* _metaspace_lock;               // å…ƒç©ºé—´é”
  
  // ==================== çŠ¶æ€ ====================
  bool _unloading;                      // æ˜¯å¦æ­£åœ¨å¸è½½
  bool _is_anonymous;                   // æ˜¯å¦ä¸ºåŒ¿åç±»
  
  // ==================== ç±»é“¾è¡¨ ====================
  Klass* volatile _klasses;             // æ­¤ç±»åŠ è½½å™¨å®šä¹‰çš„ç±»é“¾è¡¨
  
  // ==================== æ¨¡å—å’ŒåŒ… ====================
  PackageEntryTable* volatile _packages;  // åŒ…è¡¨
  ModuleEntryTable* volatile _modules;    // æ¨¡å—è¡¨
  ModuleEntry* _unnamed_module;           // æœªå‘½åæ¨¡å—
  
  // ==================== ç±»å­—å…¸ ====================
  Dictionary* _dictionary;              // å·²åŠ è½½çš„InstanceKlasså­—å…¸
  
  // ==================== JNIæ”¯æŒ ====================
  JNIMethodBlock* _jmethod_ids;         // JNIæ–¹æ³•IDå—
  
  // ==================== å¾…é‡Šæ”¾åˆ—è¡¨ ====================
  GrowableArray<Metadata*>* _deallocate_list;
  
  // ==================== é“¾è¡¨é“¾æ¥ ====================
  ClassLoaderData* _next;               // é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªCLD
  
  // ==================== ä¿æ´»è®¡æ•° ====================
  s2 _keep_alive;                       // ä¿æ´»è®¡æ•°
  
  // ==================== GCæ”¯æŒ ====================
  volatile int _claimed;                // GCå£°æ˜æ ‡å¿—
};
```

### **2.4 CLDå±‚æ¬¡ç»“æ„**

```
ClassLoaderDataå±‚æ¬¡ç»“æ„:

ClassLoaderDataGraph._head
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bootstrap CLD   â”‚â”€â”€â”€â”€â–ºâ”‚ Platform CLD    â”‚â”€â”€â”€â”€â–ºâ”‚ System CLD      â”‚
â”‚ (_the_null_...  â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚  class_loader_  â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚  data)          â”‚     â”‚                 â”‚     â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _class_loader:  â”‚     â”‚ _class_loader:  â”‚     â”‚ _class_loader:  â”‚
â”‚   NULL          â”‚     â”‚ PlatformCLå®ä¾‹  â”‚     â”‚ AppClassLoader â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _klasses:       â”‚     â”‚ _klasses:       â”‚     â”‚ _klasses:       â”‚
â”‚ Object,String,  â”‚     â”‚ å¹³å°æ¨¡å—ç±»      â”‚     â”‚ ç”¨æˆ·ç±»          â”‚
â”‚ Class,Thread... â”‚     â”‚                 â”‚     â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _metaspace:     â”‚     â”‚ _metaspace:     â”‚     â”‚ _metaspace:     â”‚
â”‚ ~10MB           â”‚     â”‚ ~2MB            â”‚     â”‚ ~5MB            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ **3. Klass - ç±»å…ƒæ•°æ®åŸºç±»**

### **3.1 æ¦‚è¿°**

`Klass`æ˜¯æ‰€æœ‰ç±»å…ƒæ•°æ®çš„åŸºç±»ï¼Œå­˜å‚¨åœ¨Metaspaceä¸­ã€‚

### **3.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Klass : public Metadata {
  // ==================== å¸ƒå±€æè¿° ====================
  jint _layout_helper;
  // å¯¹è±¡å¸ƒå±€æè¿°ç¬¦:
  // æ­£æ•°: å®ä¾‹å¤§å°(å­—èŠ‚)
  // è´Ÿæ•°: æ•°ç»„ç±»å‹ç¼–ç 
  
  // ==================== ç±»å‹æ ‡è¯† ====================
  KlassID _id;
  // ç”¨äºè™šæ‹ŸåŒ–oopé—­åŒ…åˆ†å‘
  
  // ==================== å­ç±»å‹æ£€æŸ¥ ====================
  juint _super_check_offset;            // å¿«é€Ÿå­ç±»å‹æ£€æŸ¥åç§»
  Symbol* _name;                        // ç±»å (å¦‚java/lang/String)
  Klass* _secondary_super_cache;        // æœ€è¿‘è§‚å¯Ÿåˆ°çš„æ¬¡çº§è¶…ç±»
  Array<Klass*>* _secondary_supers;     // æ‰€æœ‰æ¬¡çº§è¶…ç±»æ•°ç»„
  Klass* _primary_supers[8];            // ä¸»è¦è¶…ç±»åˆ—è¡¨ (æœ€å¤š8ä¸ª)
  
  // ==================== Javaé•œåƒ ====================
  OopHandle _java_mirror;               // java.lang.Classå®ä¾‹
  
  // ==================== ç»§æ‰¿å…³ç³» ====================
  Klass* _super;                        // çˆ¶ç±»
  Klass* _subklass;                     // ç¬¬ä¸€ä¸ªå­ç±»
  Klass* _next_sibling;                 // å…„å¼Ÿç±»é“¾æ¥
  
  // ==================== ç±»åŠ è½½å™¨ ====================
  ClassLoaderData* _class_loader_data;  // ç±»åŠ è½½å™¨æ•°æ®
  
  // ==================== è®¿é—®æ ‡å¿— ====================
  jint _modifier_flags;                 // å¤„ç†åçš„è®¿é—®æ ‡å¿—
  AccessFlags _access_flags;            // åŸå§‹è®¿é—®æ ‡å¿—
  
  // ==================== åå‘é” ====================
  markOop _prototype_header;            // åå‘é”åŸå‹å¤´
  
  // ==================== è™šè¡¨ ====================
  int _vtable_len;                      // è™šè¡¨é•¿åº¦
};
```

### **3.3 Klasså±‚æ¬¡ç»“æ„**

```
Klass
    â”‚
    â”œâ”€â”€ InstanceKlass (å®ä¾‹ç±»)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ InstanceRefKlass (å¼•ç”¨ç±»)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ InstanceMirrorKlass (Classç±»)
    â”‚       â”‚
    â”‚       â””â”€â”€ InstanceClassLoaderKlass (ClassLoaderç±»)
    â”‚
    â”œâ”€â”€ ArrayKlass (æ•°ç»„ç±»)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ TypeArrayKlass (åŸºæœ¬ç±»å‹æ•°ç»„)
    â”‚       â”‚
    â”‚       â””â”€â”€ ObjArrayKlass (å¯¹è±¡æ•°ç»„)
    â”‚
    â””â”€â”€ (å…¶ä»–ç‰¹æ®ŠKlass)
```

### **3.4 layout_helperè¯¦è§£**

```cpp
// layout_helperç¼–ç :
// 
// å®ä¾‹ç±» (æ­£æ•°):
//   layout_helper = instance_size (å­—èŠ‚æ•°)
//   ä¾‹: Objectçš„layout_helper = 16 (å¯¹è±¡å¤´)
//
// æ•°ç»„ç±» (è´Ÿæ•°):
//   bit 31: 1 (è¡¨ç¤ºæ•°ç»„)
//   bit 30: 0=åŸºæœ¬ç±»å‹æ•°ç»„, 1=å¯¹è±¡æ•°ç»„
//   bit 29-24: log2(element_size)
//   bit 23-16: header_size
//   bit 15-0: ä¿ç•™

// å¿«é€Ÿè®¡ç®—æ•°ç»„å¤§å°:
// size = header_size + length << log2_element_size
```

---

## ğŸ¢ **4. InstanceKlass - å®ä¾‹ç±»å…ƒæ•°æ®**

### **4.1 æ¦‚è¿°**

`InstanceKlass`è¡¨ç¤ºJavaç±»çš„å®Œæ•´å…ƒæ•°æ®ï¼Œæ˜¯æœ€é‡è¦çš„Klasså­ç±»ã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class InstanceKlass : public Klass {
  // ==================== æ³¨è§£ ====================
  Annotations* _annotations;            // ç±»çš„æ³¨è§£ä¿¡æ¯
  
  // ==================== åŒ…å’Œæ¨¡å— ====================
  PackageEntry* _package_entry;         // ç±»æ‰€å±çš„åŒ…
  
  // ==================== æ•°ç»„ç±» ====================
  Klass* _array_klasses;                // ä»¥æ­¤ç±»ä¸ºå…ƒç´ çš„æ•°ç»„ç±»
  
  // ==================== å¸¸é‡æ±  ====================
  ConstantPool* _constants;             // å¸¸é‡æ± 
  
  // ==================== å†…éƒ¨ç±» ====================
  Array<jushort>* _inner_classes;       // å†…éƒ¨ç±»å±æ€§
  
  // ==================== åµŒå¥—ç±» ====================
  Array<jushort>* _nest_members;        // åµŒå¥—æˆå‘˜å±æ€§
  InstanceKlass* _nest_host;            // åµŒå¥—å®¿ä¸»ç±»
  
  // ==================== å­—æ®µä¿¡æ¯ ====================
  int _nonstatic_field_size;            // éé™æ€å­—æ®µå¤§å°(å­—)
  int _static_field_size;               // é™æ€å­—æ®µå¤§å°(å­—)
  u2 _java_fields_count;                // Javaå£°æ˜çš„å­—æ®µæ•°é‡
  
  // ==================== æ¥å£è¡¨ ====================
  int _itable_len;                      // æ¥å£è¡¨é•¿åº¦
  
  // ==================== åˆå§‹åŒ–çŠ¶æ€ ====================
  u1 _init_state;                       // ç±»åˆå§‹åŒ–çŠ¶æ€
  Thread* _init_thread;                 // æ­£åœ¨æ‰§è¡Œåˆå§‹åŒ–çš„çº¿ç¨‹
  
  // ==================== OopMapç¼“å­˜ ====================
  OopMapCache* _oop_map_cache;          // OopMapç¼“å­˜
  
  // ==================== æ–¹æ³• ====================
  Array<Method*>* _methods;             // æ–¹æ³•æ•°ç»„
  Array<Method*>* _default_methods;     // é»˜è®¤æ–¹æ³•æ•°ç»„
  
  // ==================== æ¥å£ ====================
  Array<Klass*>* _local_interfaces;     // æœ¬åœ°å£°æ˜çš„æ¥å£
  Array<Klass*>* _transitive_interfaces;// ä¼ é€’å®ç°çš„æ¥å£
  
  // ==================== å­—æ®µ ====================
  Array<u2>* _fields;                   // å­—æ®µä¿¡æ¯æ•°ç»„
  
  // ==================== OSR ====================
  nmethod* _osr_nmethods_head;          // æ ˆä¸Šæ›¿æ¢nmethodé“¾è¡¨
  
  // ==================== æºæ–‡ä»¶ ====================
  const char* _source_debug_extension;  // æºç è°ƒè¯•æ‰©å±•
};
```

### **4.3 ClassStateæšä¸¾**

```cpp
enum ClassState {
  allocated,            // å·²åˆ†é…ä½†æœªé“¾æ¥
  loaded,               // å·²åŠ è½½å¹¶æ’å…¥ç±»å±‚æ¬¡ç»“æ„
  linked,               // å·²æˆåŠŸé“¾æ¥/éªŒè¯
  being_initialized,    // æ­£åœ¨è¿è¡Œç±»åˆå§‹åŒ–å™¨
  fully_initialized,    // å®Œå…¨åˆå§‹åŒ–æˆåŠŸ
  initialization_error  // åˆå§‹åŒ–å‡ºé”™
};
```

### **4.4 InstanceKlasså†…å­˜å¸ƒå±€**

```
InstanceKlasså†…å­˜å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KlassåŸºç±»éƒ¨åˆ†                            â”‚
â”‚ (_layout_helper, _name, _super, _java_mirror, ...)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    InstanceKlassæ‰©å±•éƒ¨åˆ†                    â”‚
â”‚ (_constants, _methods, _fields, _init_state, ...)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    è™šè¡¨ (vtable)                            â”‚
â”‚ vtable[0] = Object.finalize()                              â”‚
â”‚ vtable[1] = Object.equals()                                â”‚
â”‚ vtable[2] = Object.hashCode()                              â”‚
â”‚ vtable[3] = Object.toString()                              â”‚
â”‚ vtable[4] = Object.clone()                                 â”‚
â”‚ ... (å­ç±»æ–¹æ³•)                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ¥å£è¡¨ (itable)                          â”‚
â”‚ itable[0] = (Comparable, offset)                           â”‚
â”‚ itable[1] = (Serializable, offset)                         â”‚
â”‚ ...                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    OopMapBlock                              â”‚
â”‚ (æè¿°å¯¹è±¡ä¸­oopå­—æ®µçš„ä½ç½®)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    é™æ€å­—æ®µ                                 â”‚
â”‚ (ç±»çš„é™æ€å˜é‡å­˜å‚¨åŒº)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **5. Method - æ–¹æ³•å…ƒæ•°æ®**

### **5.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Method : public Metadata {
  // ==================== åªè¯»æ•°æ® ====================
  ConstMethod* _constMethod;            // æ–¹æ³•åªè¯»æ•°æ®
  
  // ==================== æ€§èƒ½æ•°æ® ====================
  MethodData* _method_data;             // æ–¹æ³•æ€§èƒ½æ•°æ®(JITç”¨)
  MethodCounters* _method_counters;     // æ–¹æ³•è®¡æ•°å™¨
  
  // ==================== è®¿é—®æ ‡å¿— ====================
  AccessFlags _access_flags;            // è®¿é—®æ ‡å¿—
  
  // ==================== è™šè¡¨ç´¢å¼• ====================
  int _vtable_index;                    // è™šè¡¨ç´¢å¼•
  // ç‰¹æ®Šå€¼:
  // -1: éè™šæ–¹æ³•
  // -2: æ¥å£æ–¹æ³•
  // >=0: è™šè¡¨æ§½ä½
  
  // ==================== å†…å»ºå‡½æ•° ====================
  u2 _intrinsic_id;                     // å†…å»ºå‡½æ•°ID
  
  // ==================== æ ‡å¿— ====================
  u2 _flags;
  // _caller_sensitive: è°ƒç”¨è€…æ•æ„Ÿ
  // _force_inline: å¼ºåˆ¶å†…è”
  // _dont_inline: ç¦æ­¢å†…è”
  // _hidden: éšè—æ–¹æ³•
  // _intrinsic_candidate: å†…å»ºå€™é€‰
  
  // ==================== å…¥å£ç‚¹ ====================
  address _i2i_entry;                   // è§£é‡Šå™¨åˆ°è§£é‡Šå™¨å…¥å£
  address _from_compiled_entry;         // ä»ç¼–è¯‘ä»£ç è°ƒç”¨çš„å…¥å£
  CompiledMethod* _code;                // ç¼–è¯‘åçš„æœ¬åœ°ä»£ç 
  address _from_interpreted_entry;      // ä»è§£é‡Šå™¨è°ƒç”¨çš„å…¥å£
};
```

### **5.2 ConstMethodè¯¦è§£**

```cpp
class ConstMethod : public MetaspaceObj {
  // ==================== ç­¾åæŒ‡çº¹ ====================
  uint64_t _fingerprint;                // æ–¹æ³•ç­¾åæŒ‡çº¹
  
  // ==================== å¸¸é‡æ±  ====================
  ConstantPool* _constants;             // å¸¸é‡æ± å¼•ç”¨
  
  // ==================== æ ˆæ˜ å°„ ====================
  Array<u1>* _stackmap_data;            // æ ˆæ˜ å°„è¡¨æ•°æ®
  
  // ==================== é€‚é…å™¨ ====================
  AdapterHandlerEntry* _adapter;        // i2c/c2ié€‚é…å™¨
  
  // ==================== å¤§å°ä¿¡æ¯ ====================
  int _constMethod_size;                // ConstMethodå¤§å°
  u2 _flags;                            // æ ‡å¿—ä½
  u1 _result_type;                      // è¿”å›ç±»å‹
  u2 _code_size;                        // å­—èŠ‚ç å¤§å°
  
  // ==================== åç§°å’Œç­¾å ====================
  u2 _name_index;                       // æ–¹æ³•åç´¢å¼•
  u2 _signature_index;                  // æ–¹æ³•ç­¾åç´¢å¼•
  
  // ==================== æ–¹æ³•ID ====================
  u2 _method_idnum;                     // æ–¹æ³•å”¯ä¸€ID
  
  // ==================== æ ˆä¿¡æ¯ ====================
  u2 _max_stack;                        // æœ€å¤§æ“ä½œæ•°æ ˆæ·±åº¦
  u2 _max_locals;                       // æœ€å¤§å±€éƒ¨å˜é‡æ•°
  u2 _size_of_parameters;               // å‚æ•°å—å¤§å°
  
  // ==================== åµŒå…¥å¼æ•°æ® (ç´§è·Ÿç»“æ„ä½“å) ====================
  // 1. å­—èŠ‚ç 
  // 2. å‹ç¼©è¡Œå·è¡¨
  // 3. å±€éƒ¨å˜é‡è¡¨
  // 4. å¼‚å¸¸è¡¨
  // 5. æ£€æŸ¥å¼‚å¸¸è¡¨
  // 6. æ–¹æ³•å‚æ•°
  // 7. æ³›å‹ç­¾åç´¢å¼•
  // 8. æ³¨è§£æ•°ç»„
};
```

### **5.3 æ–¹æ³•è°ƒç”¨å…¥å£ç‚¹**

```
æ–¹æ³•è°ƒç”¨å…¥å£ç‚¹:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨åœºæ™¯                â”‚ å…¥å£ç‚¹                â”‚ è¯´æ˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§£é‡Šå™¨â†’è§£é‡Šå™¨           â”‚ _i2i_entry            â”‚ æœ€æ…¢      â”‚
â”‚ è§£é‡Šå™¨â†’ç¼–è¯‘ä»£ç          â”‚ _from_interpreted_entryâ”‚ i2cé€‚é…å™¨â”‚
â”‚ ç¼–è¯‘ä»£ç â†’è§£é‡Šå™¨         â”‚ (c2ié€‚é…å™¨)           â”‚ åä¼˜åŒ–   â”‚
â”‚ ç¼–è¯‘ä»£ç â†’ç¼–è¯‘ä»£ç        â”‚ _from_compiled_entry  â”‚ æœ€å¿«     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å…¥å£ç‚¹é€‰æ‹©:
if (_code != NULL) {
    // æœ‰ç¼–è¯‘ä»£ç ï¼Œä½¿ç”¨ç¼–è¯‘å…¥å£
    _from_interpreted_entry = _code->verified_entry_point();
} else {
    // æ— ç¼–è¯‘ä»£ç ï¼Œä½¿ç”¨è§£é‡Šå™¨å…¥å£
    _from_interpreted_entry = _i2i_entry;
}
```

---

## ğŸ—ƒï¸ **6. ConstantPool - å¸¸é‡æ± **

### **6.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class ConstantPool : public Metadata {
  // ==================== æ ‡ç­¾æ•°ç»„ ====================
  Array<u1>* _tags;                     // æ ‡ç­¾æ•°ç»„ï¼Œæè¿°å¸¸é‡ç±»å‹
  
  // ==================== ç¼“å­˜ ====================
  ConstantPoolCache* _cache;            // è§£é‡Šå™¨è¿è¡Œæ—¶ç¼“å­˜
  
  // ==================== æŒæœ‰è€… ====================
  InstanceKlass* _pool_holder;          // æŒæœ‰æ­¤å¸¸é‡æ± çš„ç±»
  
  // ==================== æ“ä½œæ•° ====================
  Array<u2>* _operands;                 // InvokeDynamicç­‰å˜é•¿æ•°æ®
  
  // ==================== å·²è§£æçš„ç±» ====================
  Array<Klass*>* _resolved_klasses;     // å·²è§£æçš„ç±»æ•°ç»„
  
  // ==================== æ ‡å¿— ====================
  int _flags;
  // _has_preresolution: æœ‰é¢„è§£æ
  // _on_stack: åœ¨æ ˆä¸Š
  // _is_shared: å…±äº«
  // _has_dynamic_constant: æœ‰åŠ¨æ€å¸¸é‡
  
  // ==================== å¤§å° ====================
  int _length;                          // å¸¸é‡æ± å…ƒç´ æ•°é‡
  
  // ==================== ç‰ˆæœ¬ ====================
  int _version;                         // ç‰ˆæœ¬å·(ç±»é‡å®šä¹‰ç”¨)
};
```

### **6.2 å¸¸é‡æ± æ ‡ç­¾ç±»å‹**

```cpp
enum {
  JVM_CONSTANT_Utf8               = 1,   // UTF-8å­—ç¬¦ä¸²
  JVM_CONSTANT_Integer            = 3,   // intå¸¸é‡
  JVM_CONSTANT_Float              = 4,   // floatå¸¸é‡
  JVM_CONSTANT_Long               = 5,   // longå¸¸é‡
  JVM_CONSTANT_Double             = 6,   // doubleå¸¸é‡
  JVM_CONSTANT_Class              = 7,   // ç±»å¼•ç”¨
  JVM_CONSTANT_String             = 8,   // å­—ç¬¦ä¸²å¸¸é‡
  JVM_CONSTANT_Fieldref           = 9,   // å­—æ®µå¼•ç”¨
  JVM_CONSTANT_Methodref          = 10,  // æ–¹æ³•å¼•ç”¨
  JVM_CONSTANT_InterfaceMethodref = 11,  // æ¥å£æ–¹æ³•å¼•ç”¨
  JVM_CONSTANT_NameAndType        = 12,  // åç§°å’Œç±»å‹
  JVM_CONSTANT_MethodHandle       = 15,  // æ–¹æ³•å¥æŸ„
  JVM_CONSTANT_MethodType         = 16,  // æ–¹æ³•ç±»å‹
  JVM_CONSTANT_Dynamic            = 17,  // åŠ¨æ€å¸¸é‡
  JVM_CONSTANT_InvokeDynamic      = 18,  // invokedynamic
  JVM_CONSTANT_Module             = 19,  // æ¨¡å—
  JVM_CONSTANT_Package            = 20,  // åŒ…
};
```

---

## ğŸ­ **7. oopDesc - å¯¹è±¡æè¿°ç¬¦**

### **7.1 æ¦‚è¿°**

`oopDesc`æ˜¯æ‰€æœ‰Javaå¯¹è±¡çš„C++è¡¨ç¤ºï¼Œå®šä¹‰äº†å¯¹è±¡å¤´ç»“æ„ã€‚

### **7.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class oopDesc {
  // ==================== æ ‡è®°å­— ====================
  volatile markOop _mark;               // å¯¹è±¡å¤´ç¬¬ä¸€éƒ¨åˆ†
  // åŒ…å«: é”çŠ¶æ€ã€GCå¹´é¾„ã€èº«ä»½å“ˆå¸Œç ã€åå‘çº¿ç¨‹ID
  
  // ==================== ç±»æŒ‡é’ˆ ====================
  union _metadata {
    Klass* _klass;                      // ç±»æŒ‡é’ˆ(éå‹ç¼©)
    narrowKlass _compressed_klass;      // å‹ç¼©ç±»æŒ‡é’ˆ
  } _metadata;
};

// å¯¹è±¡å¤´å¤§å°:
// éå‹ç¼©: 16å­—èŠ‚ (8å­—èŠ‚mark + 8å­—èŠ‚klass)
// å‹ç¼©:   12å­—èŠ‚ (8å­—èŠ‚mark + 4å­—èŠ‚compressed_klass)
```

### **7.3 å¯¹è±¡å†…å­˜å¸ƒå±€**

```
Javaå¯¹è±¡å†…å­˜å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯¹è±¡å¤´ (Header)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mark Word (8å­—èŠ‚)                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æœªé”å®š:   unused:25 | hash:31 | unused:1 | age:4 | 01   â”‚ â”‚
â”‚ â”‚ åå‘é”:   thread:54 | epoch:2 | unused:1 | age:4 | 101  â”‚ â”‚
â”‚ â”‚ è½»é‡çº§é”: ptr_to_lock_record:62                    | 00  â”‚ â”‚
â”‚ â”‚ é‡é‡çº§é”: ptr_to_heavyweight_monitor:62            | 10  â”‚ â”‚
â”‚ â”‚ GCæ ‡è®°:   forwarding_address:62                    | 11  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Klass Pointer (4æˆ–8å­—èŠ‚)                                    â”‚
â”‚ æŒ‡å‘InstanceKlass                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å®ä¾‹æ•°æ® (Instance Data)                 â”‚
â”‚ å­—æ®µæŒ‰ç±»å‹åˆ†ç»„:                                             â”‚
â”‚ â€¢ long/double (8å­—èŠ‚å¯¹é½)                                   â”‚
â”‚ â€¢ int/float (4å­—èŠ‚)                                         â”‚
â”‚ â€¢ short/char (2å­—èŠ‚)                                        â”‚
â”‚ â€¢ byte/boolean (1å­—èŠ‚)                                      â”‚
â”‚ â€¢ oop (å¼•ç”¨ï¼Œ4æˆ–8å­—èŠ‚)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å¯¹é½å¡«å…… (Padding)                       â”‚
â”‚ ç¡®ä¿å¯¹è±¡å¤§å°æ˜¯8å­—èŠ‚çš„å€æ•°                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **7.4 æ•°ç»„å¯¹è±¡å¸ƒå±€**

```
æ•°ç»„å¯¹è±¡å†…å­˜å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯¹è±¡å¤´ (Header)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mark Word (8å­—èŠ‚)                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Klass Pointer (4æˆ–8å­—èŠ‚)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Array Length (4å­—èŠ‚)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å¡«å……] (å¦‚æœéœ€è¦å¯¹é½)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°ç»„å…ƒç´                                  â”‚
â”‚ element[0]                                                  â”‚
â”‚ element[1]                                                  â”‚
â”‚ ...                                                         â”‚
â”‚ element[length-1]                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å¯¹é½å¡«å……                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ **8. markOop - å¯¹è±¡æ ‡è®°å­—**

### **8.1 ä½æ ¼å¼è¯¦è§£**

```cpp
// 64ä½Mark Wordæ ¼å¼:

// æœªé”å®šçŠ¶æ€ (lock = 01):
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ unused:25 â”‚ identity_hash:31 â”‚ unused:1 â”‚ age:4 â”‚ 0 â”‚ 01  â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//   bit 63-39    bit 38-8           bit 7     bit 6-3  bit 2  bit 1-0

// åå‘é”çŠ¶æ€ (lock = 01, biased = 1):
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ JavaThread*:54 â”‚ epoch:2 â”‚ unused:1 â”‚ age:4 â”‚ 1 â”‚ 01       â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//   bit 63-10        bit 9-8   bit 7      bit 6-3  bit 2  bit 1-0

// è½»é‡çº§é”çŠ¶æ€ (lock = 00):
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ptr_to_lock_record:62                               â”‚ 00   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//   bit 63-2                                              bit 1-0

// é‡é‡çº§é”çŠ¶æ€ (lock = 10):
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ptr_to_heavyweight_monitor:62                       â”‚ 10   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//   bit 63-2                                              bit 1-0

// GCæ ‡è®°çŠ¶æ€ (lock = 11):
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ forwarding_address:62                               â”‚ 11   â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//   bit 63-2                                              bit 1-0
```

### **8.2 å…³é”®å¸¸é‡**

```cpp
class markOopDesc : public oopDesc {
  enum {
    // ä½æ•°
    age_bits          = 4,    // GCå¹´é¾„ä½æ•°
    lock_bits         = 2,    // é”çŠ¶æ€ä½æ•°
    biased_lock_bits  = 1,    // åå‘é”ä½æ•°
    hash_bits         = 31,   // å“ˆå¸Œç ä½æ•°
    epoch_bits        = 2,    // åå‘é”epochä½æ•°
    
    // é”çŠ¶æ€å€¼
    locked_value             = 0,  // 00 - è½»é‡çº§é”
    unlocked_value           = 1,  // 01 - æœªé”å®š
    monitor_value            = 2,  // 10 - é‡é‡çº§é”
    marked_value             = 3,  // 11 - GCæ ‡è®°
    biased_lock_pattern      = 5,  // 101 - åå‘é”
    
    // æœ€å¤§å€¼
    max_age                  = 15, // æœ€å¤§GCå¹´é¾„ (4ä½)
    max_hash                 = (1 << hash_bits) - 1,
  };
};
```

### **8.3 é”çŠ¶æ€è½¬æ¢**

```
é”çŠ¶æ€è½¬æ¢å›¾:

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ— é”çŠ¶æ€   â”‚
                    â”‚  (01, 0)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åå‘é”   â”‚    â”‚ è½»é‡çº§é”  â”‚    â”‚ é‡é‡çº§é”  â”‚
    â”‚ (01, 1)   â”‚â”€â”€â”€â–ºâ”‚   (00)    â”‚â”€â”€â”€â–ºâ”‚   (10)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â”‚                â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  GCæ ‡è®°    â”‚
                    â”‚   (11)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **9. å¯¹è±¡å…³ç³»æ€»å›¾**

```
ç±»åŠ è½½å’Œå¯¹è±¡æ¨¡å‹å…³ç³»:

SystemDictionary (é™æ€ç±»)
         â”‚
         â”œâ”€â”€ _well_known_klasses[] â”€â”€â–º InstanceKlass[]
         â”‚                                   â”‚
         â”œâ”€â”€ _java_system_loader â”€â”€â–º oop    â”‚
         â”‚                                   â”‚
         â””â”€â”€ ClassLoaderDataGraph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚                      â”‚                  â”‚
                      â–¼                      â”‚                  â”‚
              ClassLoaderDataé“¾è¡¨            â”‚                  â”‚
                      â”‚                      â”‚                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                  â”‚
         â”‚            â”‚            â”‚         â”‚                  â”‚
         â–¼            â–¼            â–¼         â”‚                  â”‚
    Bootstrap     Platform      System       â”‚                  â”‚
       CLD          CLD          CLD         â”‚                  â”‚
         â”‚            â”‚            â”‚         â”‚                  â”‚
         â–¼            â–¼            â–¼         â”‚                  â”‚
    _klasses      _klasses      _klasses     â”‚                  â”‚
         â”‚            â”‚            â”‚         â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                                   â”‚                            â”‚
                                   â–¼                            â”‚
                            InstanceKlass â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚                         â”‚
         â–¼                         â–¼                         â–¼
    _constants              _methods[]               _java_mirror
    (ConstantPool)          (Method[])               (oop)
         â”‚                         â”‚                         â”‚
         â”‚                         â–¼                         â”‚
         â”‚                   _constMethod                    â”‚
         â”‚                   (ConstMethod)                   â”‚
         â”‚                         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                              Javaå¯¹è±¡
                              (oopDesc)
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              â”‚              â”‚
                    â–¼              â–¼              â–¼
                 _mark        _metadata      å®ä¾‹æ•°æ®
               (markOop)      (Klass*)      (å­—æ®µå€¼)
```

---

## ğŸ¯ **10. æ€»ç»“**

### **10.1 å…³é”®å¯¹è±¡æ•°é‡ (JVMå¯åŠ¨å)**

| å¯¹è±¡ç±»å‹ | æ•°é‡ | å†…å­˜å ç”¨ |
|---------|------|---------|
| ClassLoaderData | 3+ | ~3KB |
| InstanceKlass | ~1500 | ~1.5MB |
| Method | ~15000 | ~3MB |
| ConstantPool | ~1500 | ~3MB |
| ConstMethod | ~15000 | ~5MB |
| æ€»è®¡ | ~33000 | ~13MB |

### **10.2 è®¾è®¡äº®ç‚¹**

1. **åˆ†å±‚è®¾è®¡**: Klassâ†’InstanceKlassâ†’Methodå±‚æ¬¡æ¸…æ™°
2. **å‹ç¼©æŒ‡é’ˆ**: å‡å°‘64ä½ç³»ç»Ÿçš„å†…å­˜å¼€é”€
3. **å¸¸é‡æ± ç¼“å­˜**: åŠ é€Ÿè¿è¡Œæ—¶ç¬¦å·è§£æ
4. **åå‘é”ä¼˜åŒ–**: å‡å°‘æ— ç«äº‰åœºæ™¯çš„é”å¼€é”€
5. **CLDéš”ç¦»**: ç±»åŠ è½½å™¨çº§åˆ«çš„å…ƒæ•°æ®éš”ç¦»

### **10.3 å­¦ä¹ å»ºè®®**

1. å…ˆç†è§£oopDescå’ŒmarkOopçš„å¯¹è±¡å¤´ç»“æ„
2. æŒæ¡Klasså’ŒInstanceKlassçš„ç»§æ‰¿å…³ç³»
3. ç†è§£Methodå’ŒConstMethodçš„åˆ†ç¦»è®¾è®¡
4. å­¦ä¹ ClassLoaderDataçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
5. æœ€åç†è§£SystemDictionaryçš„ç±»åŠ è½½æœºåˆ¶