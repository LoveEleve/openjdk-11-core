# JVMåŒæ­¥æœºåˆ¶ä¸æœåŠ¡ç›‘æ§å¯¹è±¡è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVMåŒæ­¥æœºåˆ¶å’ŒæœåŠ¡ç›‘æ§ç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬ObjectMonitorã€SafepointSynchronizeã€Mutex/Monitorã€JvmtiExportã€Managementå’ŒPerfDataç­‰ã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (é»˜è®¤)

---

## ğŸ—ï¸ **1. åŒæ­¥æœºåˆ¶æ¶æ„æ€»è§ˆ**

### **1.1 åŒæ­¥æœºåˆ¶ç»„ä»¶å…³ç³»**

```
JVMåŒæ­¥æœºåˆ¶æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           JVMåŒæ­¥æœºåˆ¶                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Javaå±‚åŒæ­¥ (synchronized)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚  åå‘é”      â”‚â”€â”€â–ºâ”‚  è½»é‡çº§é”    â”‚â”€â”€â–ºâ”‚  é‡é‡çº§é”    â”‚               â”‚   â”‚
â”‚  â”‚  â”‚ (Biased Lock)â”‚  â”‚ (Thin Lock)  â”‚  â”‚(ObjectMonitor)â”‚              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    VMå±‚åŒæ­¥                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚    Mutex     â”‚  â”‚   Monitor    â”‚  â”‚  ParkEvent   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  (äº’æ–¥é”)    â”‚  â”‚  (ç›‘è§†å™¨)    â”‚  â”‚  (åœè½¦äº‹ä»¶)  â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å…¨å±€åŒæ­¥ç‚¹                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              SafepointSynchronize (å®‰å…¨ç‚¹åŒæ­¥)                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              - å°†æ‰€æœ‰JavaThreadæ¨è¿›åˆ°å®‰å…¨ç‚¹                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              - ç”¨äºGCã€åä¼˜åŒ–ã€ç±»é‡å®šä¹‰ç­‰                     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ **2. ObjectMonitor - å¯¹è±¡ç›‘è§†å™¨**

### **2.1 æ¦‚è¿°**

`ObjectMonitor`æ˜¯Javaå¯¹è±¡ç›‘è§†å™¨çš„é‡é‡çº§å®ç°ï¼Œå½“è½»é‡çº§é”å› ç«äº‰æˆ–è°ƒç”¨`Object.wait()`è€Œè†¨èƒ€æ—¶ä½¿ç”¨ã€‚æ¯ä¸ª`ObjectMonitor`å…³è”ä¸€ä¸ªJavaå¯¹è±¡ã€‚

### **2.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class ObjectMonitor {
  // ==================== å¯¹è±¡å¤´å’Œå¼•ç”¨ ====================
  volatile markOop _header;                    // ä½ç§»çš„å¯¹è±¡å¤´(displaced header)
                                               // å¿…é¡»åœ¨åç§»é‡0å¤„
  void* volatile _object;                      // åå‘å¯¹è±¡æŒ‡é’ˆï¼ŒæŒ‡å‘å…³è”çš„Javaå¯¹è±¡
  
  // ==================== ç©ºé—²é“¾è¡¨ ====================
  ObjectMonitor* FreeNext;                     // ç©ºé—²é“¾è¡¨é“¾æ¥æŒ‡é’ˆ
  
  // ==================== é”æ‹¥æœ‰è€… ====================
  void* volatile _owner;                       // æŒ‡å‘æ‹¥æœ‰é”çš„çº¿ç¨‹æˆ–BasicLock
  volatile jlong _previous_owner_tid;          // å‰ä¸€ä¸ªé”æ‹¥æœ‰è€…çš„çº¿ç¨‹ID
  volatile intptr_t _recursions;               // é€’å½’è®¡æ•°ï¼Œé¦–æ¬¡è¿›å…¥ä¸º0
  
  // ==================== ç­‰å¾…é˜Ÿåˆ— ====================
  ObjectWaiter* volatile _EntryList;           // é˜»å¡åœ¨entryæˆ–reentryçš„çº¿ç¨‹é˜Ÿåˆ—
  ObjectWaiter* volatile _cxq;                 // æœ€è¿‘åˆ°è¾¾çš„é˜»å¡çº¿ç¨‹é“¾è¡¨(ç«äº‰é˜Ÿåˆ—)
  ObjectWaiter* volatile _WaitSet;             // è°ƒç”¨wait()ç­‰å¾…çš„çº¿ç¨‹é“¾è¡¨
  volatile jint _waiters;                      // ç­‰å¾…çº¿ç¨‹æ•°é‡
  volatile int _WaitSetLock;                   // ä¿æŠ¤ç­‰å¾…é˜Ÿåˆ—çš„ç®€å•è‡ªæ—‹é”
  
  // ==================== ç»§æ‰¿äººå’Œä¼˜åŒ– ====================
  Thread* volatile _succ;                      // ç»§æ‰¿äººçº¿ç¨‹ï¼Œç”¨äºæ— æ•ˆå”¤é†’èŠ‚æµ
  Thread* volatile _Responsible;               // è´Ÿè´£çº¿ç¨‹
  volatile int _Spinner;                       // ç”¨äºexit->spinneråˆ‡æ¢ä¼˜åŒ–
  volatile int _SpinDuration;                  // è‡ªæ—‹æŒç»­æ—¶é—´
  
  // ==================== å¼•ç”¨è®¡æ•° ====================
  volatile jint _count;                        // å¼•ç”¨è®¡æ•°ï¼Œé˜²æ­¢åœ¨STWæ—¶å›æ”¶/æ”¶ç¼©
};
```

### **2.3 ObjectWaiterç»“æ„**

```cpp
// ç­‰å¾…çº¿ç¨‹çš„å°è£…
class ObjectWaiter : public StackObj {
  ObjectWaiter* volatile _next;                // ä¸‹ä¸€ä¸ªç­‰å¾…è€…
  ObjectWaiter* volatile _prev;                // ä¸Šä¸€ä¸ªç­‰å¾…è€…
  Thread* _thread;                             // ç­‰å¾…çš„çº¿ç¨‹
  jlong _notifier_tid;                         // é€šçŸ¥è€…çº¿ç¨‹ID
  ParkEvent* _event;                           // åœè½¦äº‹ä»¶
  volatile int _notified;                      // æ˜¯å¦å·²è¢«é€šçŸ¥
  volatile TStates TState;                     // ç­‰å¾…çŠ¶æ€
  volatile bool _active;                       // æ˜¯å¦æ´»è·ƒ
};
```

### **2.4 é”çŠ¶æ€è½¬æ¢**

```
Javaå¯¹è±¡é”çŠ¶æ€è½¬æ¢:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚   æ— é”çŠ¶æ€    â”‚                                            â”‚
â”‚    â”‚  (Unlocked)   â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚            â”‚ é¦–æ¬¡è·å–é”                                         â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚   åå‘é”      â”‚ â—„â”€â”€â”€ åŒä¸€çº¿ç¨‹å†æ¬¡è·å–                      â”‚
â”‚    â”‚ (Biased Lock) â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚            â”‚ å…¶ä»–çº¿ç¨‹ç«äº‰                                       â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚  è½»é‡çº§é”     â”‚ â—„â”€â”€â”€ æ— ç«äº‰æ—¶CASè·å–                       â”‚
â”‚    â”‚ (Thin Lock)   â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚            â”‚ ç«äº‰æ¿€çƒˆæˆ–è°ƒç”¨wait()                               â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚  é‡é‡çº§é”     â”‚                                            â”‚
â”‚    â”‚(ObjectMonitor)â”‚                                            â”‚
â”‚    â”‚               â”‚                                            â”‚
â”‚    â”‚ â€¢ _owner      â”‚ â—„â”€â”€â”€ é”æ‹¥æœ‰è€…                              â”‚
â”‚    â”‚ â€¢ _EntryList  â”‚ â—„â”€â”€â”€ ç­‰å¾…è·å–é”çš„çº¿ç¨‹                      â”‚
â”‚    â”‚ â€¢ _WaitSet    â”‚ â—„â”€â”€â”€ è°ƒç”¨wait()çš„çº¿ç¨‹                      â”‚
â”‚    â”‚ â€¢ _cxq        â”‚ â—„â”€â”€â”€ æ–°åˆ°è¾¾çš„ç«äº‰çº¿ç¨‹                      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.5 é™æ€æ€§èƒ½è®¡æ•°å™¨**

```cpp
// ObjectMonitoræ€§èƒ½ç»Ÿè®¡
static PerfCounter* _sync_ContendedLockAttempts;  // ç«äº‰é”å°è¯•æ¬¡æ•°
static PerfCounter* _sync_FutileWakeups;          // æ— æ•ˆå”¤é†’æ¬¡æ•°
static PerfCounter* _sync_Parks;                  // parkæ“ä½œæ¬¡æ•°
static PerfCounter* _sync_Notifications;          // é€šçŸ¥æ¬¡æ•°
static PerfCounter* _sync_Inflations;             // è†¨èƒ€æ¬¡æ•°
static PerfCounter* _sync_Deflations;             // æ”¶ç¼©æ¬¡æ•°
static PerfLongVariable* _sync_MonExtant;         // ç°å­˜ç›‘è§†å™¨æ•°é‡
```

### **2.6 8GBå †ç¯å¢ƒä¸‹çš„ObjectMonitorç»Ÿè®¡**

```
ObjectMonitorç»Ÿè®¡ (8GBå †, å…¸å‹åº”ç”¨):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å…¸å‹å€¼        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ObjectMonitorå¤§å°       â”‚ ~128B         â”‚ æ¯ä¸ªç›‘è§†å™¨            â”‚
â”‚ æ´»è·ƒç›‘è§†å™¨æ•°é‡          â”‚ 100-10000     â”‚ å–å†³äºå¹¶å‘ç¨‹åº¦        â”‚
â”‚ ç›‘è§†å™¨æ± å¤§å°            â”‚ åŠ¨æ€          â”‚ æŒ‰éœ€åˆ†é…              â”‚
â”‚ è†¨èƒ€å¼€é”€                â”‚ ~1-10Î¼s       â”‚ è½»é‡çº§é”â†’é‡é‡çº§é”     â”‚
â”‚ æ”¶ç¼©é¢‘ç‡                â”‚ æ¯æ¬¡å®‰å…¨ç‚¹    â”‚ SafepointSynchronize  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â¸ï¸ **3. SafepointSynchronize - å®‰å…¨ç‚¹åŒæ­¥**

### **3.1 æ¦‚è¿°**

`SafepointSynchronize`å®ç°äº†å®‰å…¨ç‚¹åŒæ­¥æœºåˆ¶ï¼Œç”¨äºå°†æ‰€æœ‰JavaThreadæ¨è¿›åˆ°å®‰å…¨ç‚¹ã€‚å®‰å…¨ç‚¹æ˜¯JVMæ‰§è¡ŒGCã€ç±»é‡å®šä¹‰ã€åä¼˜åŒ–ç­‰æ“ä½œçš„å‰ææ¡ä»¶ã€‚

### **3.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class SafepointSynchronize : AllStatic {
  // ==================== åŒæ­¥çŠ¶æ€ ====================
  static volatile SynchronizeState _state;     // åŒæ­¥çŠ¶æ€
  // çŠ¶æ€å€¼:
  // _not_synchronized = 0  - æœªåŒæ­¥
  // _synchronizing = 1     - æ­£åœ¨åŒæ­¥
  // _synchronized = 2      - å·²åŒæ­¥
  
  // ==================== ç­‰å¾…è®¡æ•° ====================
  static volatile int _waiting_to_block;       // ç­‰å¾…é˜»å¡çš„çº¿ç¨‹æ•°é‡
  static int _current_jni_active_count;        // å®‰å…¨ç‚¹æœŸé—´æ´»è·ƒçš„ä¸´ç•Œnativeè°ƒç”¨æ•°
  
  // ==================== é…ç½® ====================
  static int _defer_thr_suspend_loop_count;    // é˜»å¡VMçº¿ç¨‹å‰çš„è¿­ä»£æ¬¡æ•°
  
  // ==================== è®¡æ•°å™¨ ====================
  static volatile int _safepoint_counter;      // å®‰å…¨ç‚¹è®¡æ•°å™¨
                                               // å¶æ•°è¡¨ç¤ºæ— å®‰å…¨ç‚¹æ“ä½œ
  
  // ==================== æ—¶é—´ç»Ÿè®¡ ====================
  static long _end_of_last_safepoint;          // ä¸Šæ¬¡å®‰å…¨ç‚¹ç»“æŸæ—¶é—´(æ¯«ç§’)
  static jlong _safepoint_begin_time;          // å®‰å…¨ç‚¹å¼€å§‹æ—¶é—´
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  static SafepointStats* _safepoint_stats;     // å®‰å…¨ç‚¹ç»Ÿè®¡æ•°ç»„
  static int _cur_stat_index;                  // å½“å‰ç»Ÿè®¡æ•°ç»„ç´¢å¼•
  static julong _safepoint_reasons[];          // æ¯ç§VMæ“ä½œçš„å®‰å…¨ç‚¹è®¡æ•°
  static julong _coalesced_vmop_count;         // åˆå¹¶çš„vmopè®¡æ•°
  static jlong _max_sync_time;                 // æœ€å¤§åŒæ­¥æ—¶é—´(çº³ç§’)
  static jlong _max_vmop_time;                 // æœ€å¤§VMæ“ä½œæ—¶é—´(çº³ç§’)
};
```

### **3.3 SafepointStatsç»“æ„ä½“**

```cpp
typedef struct {
  float  _time_stamp;                          // å½“å‰å®‰å…¨ç‚¹å‘ç”Ÿæ—¶é—´(ç§’)
  int    _vmop_type;                           // è§¦å‘å®‰å…¨ç‚¹çš„VMæ“ä½œç±»å‹
  int    _nof_total_threads;                   // Javaçº¿ç¨‹æ€»æ•°
  int    _nof_initial_running_threads;         // åˆå§‹è¿è¡Œçº¿ç¨‹æ•°
  int    _nof_threads_wait_to_block;           // ç­‰å¾…é˜»å¡çš„çº¿ç¨‹æ•°
  int    _nof_threads_hit_page_trap;           // å‘½ä¸­é¡µé™·é˜±çš„çº¿ç¨‹æ•°
  jlong  _time_to_spin;                        // è‡ªæ—‹è€—æ—¶(æ¯«ç§’)
  jlong  _time_to_wait_to_block;               // ç­‰å¾…é˜»å¡è€—æ—¶(æ¯«ç§’)
  jlong  _time_to_do_cleanups;                 // æ¸…ç†è€—æ—¶(æ¯«ç§’)
  jlong  _time_to_sync;                        // åŒæ­¥è€—æ—¶(æ¯«ç§’)
  jlong  _time_to_exec_vmop;                   // VMæ“ä½œæ‰§è¡Œè€—æ—¶(æ¯«ç§’)
} SafepointStats;
```

### **3.4 å®‰å…¨ç‚¹æ¸…ç†ä»»åŠ¡**

```cpp
enum SafepointCleanupTasks {
  SAFEPOINT_CLEANUP_DEFLATE_MONITORS,          // æ”¶ç¼©ç›‘è§†å™¨
  SAFEPOINT_CLEANUP_UPDATE_INLINE_CACHES,      // æ›´æ–°å†…è”ç¼“å­˜
  SAFEPOINT_CLEANUP_COMPILATION_POLICY,        // ç¼–è¯‘ç­–ç•¥
  SAFEPOINT_CLEANUP_SYMBOL_TABLE_REHASH,       // ç¬¦å·è¡¨é‡å“ˆå¸Œ
  SAFEPOINT_CLEANUP_STRING_TABLE_REHASH,       // å­—ç¬¦ä¸²è¡¨é‡å“ˆå¸Œ
  SAFEPOINT_CLEANUP_CLD_PURGE,                 // ç±»åŠ è½½å™¨æ•°æ®æ¸…ç†
  SAFEPOINT_CLEANUP_SYSTEM_DICTIONARY_RESIZE   // ç³»ç»Ÿå­—å…¸è°ƒæ•´å¤§å°
};
```

### **3.5 å®‰å…¨ç‚¹åŒæ­¥æµç¨‹**

```
å®‰å…¨ç‚¹åŒæ­¥æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. å‘èµ·å®‰å…¨ç‚¹è¯·æ±‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ VMThreadè°ƒç”¨SafepointSynchronize::begin()               â”‚   â”‚
â”‚  â”‚ è®¾ç½®_state = _synchronizing                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  2. é€šçŸ¥æ‰€æœ‰JavaThread                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ è®¾ç½®è½®è¯¢é¡µä¸ºä¸å¯è®¿é—® (è§¦å‘SIGSEGV)                    â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ç½®è§£é‡Šå™¨åˆ†å‘è¡¨ä¸ºå®‰å…¨ç‚¹ç‰ˆæœ¬                          â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ç½®ç¼–è¯‘ä»£ç çš„è½®è¯¢æ ‡å¿—                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  3. ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å®‰å…¨ç‚¹                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ çº¿ç¨‹çŠ¶æ€:                                               â”‚   â”‚
â”‚  â”‚ â€¢ è§£é‡Šæ‰§è¡Œ: åœ¨ä¸‹ä¸€ä¸ªå­—èŠ‚ç è¾¹ç•Œæ£€æŸ¥                      â”‚   â”‚
â”‚  â”‚ â€¢ ç¼–è¯‘æ‰§è¡Œ: åœ¨è½®è¯¢ç‚¹æ£€æŸ¥                                â”‚   â”‚
â”‚  â”‚ â€¢ Nativeæ‰§è¡Œ: è¿”å›æ—¶æ£€æŸ¥                                â”‚   â”‚
â”‚  â”‚ â€¢ é˜»å¡çŠ¶æ€: å·²ç»åœ¨å®‰å…¨ç‚¹                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  4. æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾ï¼Œæ‰§è¡ŒVMæ“ä½œ                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ _state = _synchronized                                  â”‚   â”‚
â”‚  â”‚ æ‰§è¡ŒGCã€ç±»é‡å®šä¹‰ã€åä¼˜åŒ–ç­‰æ“ä½œ                          â”‚   â”‚
â”‚  â”‚ æ‰§è¡Œå®‰å…¨ç‚¹æ¸…ç†ä»»åŠ¡                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  5. ç»“æŸå®‰å…¨ç‚¹                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SafepointSynchronize::end()                             â”‚   â”‚
â”‚  â”‚ _state = _not_synchronized                              â”‚   â”‚
â”‚  â”‚ æ¢å¤è½®è¯¢é¡µå’Œåˆ†å‘è¡¨                                      â”‚   â”‚
â”‚  â”‚ å”¤é†’æ‰€æœ‰é˜»å¡çš„çº¿ç¨‹                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3.6 8GBå †ç¯å¢ƒä¸‹çš„å®‰å…¨ç‚¹ç»Ÿè®¡**

```
å®‰å…¨ç‚¹ç»Ÿè®¡ (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å…¸å‹å€¼        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®‰å…¨ç‚¹åŒæ­¥æ—¶é—´          â”‚ 1-50ms        â”‚ å–å†³äºçº¿ç¨‹æ•°å’ŒçŠ¶æ€    â”‚
â”‚ å®‰å…¨ç‚¹æ¸…ç†æ—¶é—´          â”‚ 1-10ms        â”‚ ç›‘è§†å™¨æ”¶ç¼©ç­‰          â”‚
â”‚ å®‰å…¨ç‚¹é¢‘ç‡              â”‚ 10-100æ¬¡/ç§’   â”‚ å–å†³äºGCå’ŒVMæ“ä½œ      â”‚
â”‚ çº¿ç¨‹åˆ°è¾¾å»¶è¿Ÿ            â”‚ <1ms          â”‚ å¤§å¤šæ•°æƒ…å†µ            â”‚
â”‚ æœ€å¤§åŒæ­¥æ—¶é—´            â”‚ å¯èƒ½>100ms    â”‚ é•¿æ—¶é—´Nativeè°ƒç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” **4. Mutex/Monitor - VMå†…éƒ¨åŒæ­¥**

### **4.1 æ¦‚è¿°**

`Monitor`æ˜¯HotSpotå†…éƒ¨ä½¿ç”¨çš„ç›‘è§†å™¨ç±»ï¼Œ`Mutex`æ˜¯å…¶é€€åŒ–å½¢å¼ï¼ˆéšè—äº†wait/notifyï¼‰ã€‚è¿™äº›æ˜¯VMå†…éƒ¨ä½¿ç”¨çš„åŒæ­¥åŸè¯­ï¼Œä¸åŒäºJavaå±‚çš„synchronizedã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Monitor : public CHeapObj<mtInternal> {
  // ==================== é”å­—å’Œç«äº‰é˜Ÿåˆ— ====================
  SplitWord _LockWord;                         // ç«äº‰é˜Ÿåˆ—(cxq)ä¸é”å­—èŠ‚çš„è”åˆä½“
  
  // ==================== é”æ‹¥æœ‰è€… ====================
  Thread* volatile _owner;                     // é”çš„æ‹¥æœ‰è€…çº¿ç¨‹
  
  // ==================== ç­‰å¾…é˜Ÿåˆ— ====================
  ParkEvent* volatile _EntryList;              // ç­‰å¾…è¿›å…¥çš„çº¿ç¨‹åˆ—è¡¨
  ParkEvent* volatile _OnDeck;                 // ç»§æ‰¿äºº(heir-presumptive)
  volatile intptr_t _WaitLock[1];              // ä¿æŠ¤_WaitSetçš„é”
  ParkEvent* volatile _WaitSet;                // ParkEventç­‰å¾…é“¾è¡¨
  
  // ==================== ä¼˜åŒ–æ ‡å¿— ====================
  volatile bool _snuck;                        // ç”¨äºå·å·è·å–é”(sneaky locking)
  
  // ==================== è°ƒè¯•ä¿¡æ¯ ====================
  char _name[64];                              // ç›‘è§†å™¨åç§°(ç”¨äºè°ƒè¯•)
  bool _allow_vm_block;                        // æ˜¯å¦å…è®¸VMé˜»å¡(ä»…éPRODUCT)
  
  // ==================== æ­»é”æ£€æµ‹ (ä»…debug) ====================
  int _rank;                                   // é”ç­‰çº§
  Monitor* _next;                              // çº¿ç¨‹æ‹¥æœ‰çš„é”é“¾è¡¨
  Thread* _last_owner;                         // ä¸Šä¸€ä¸ªæ‹¥æœ‰è€…
};
```

### **4.3 é”ç­‰çº§æšä¸¾**

```cpp
enum lock_types {
  event,                                       // äº‹ä»¶çº§åˆ«
  access         = event + 1,                  // å†…å­˜è®¿é—®çº§åˆ«
  tty            = access + 2,                 // ttyçº§åˆ«
  special        = tty + 1,                    // ç‰¹æ®Šçº§åˆ«(ä¸ä¼šé˜»å¡)
  suspend_resume = special + 1,                // æŒ‚èµ·/æ¢å¤çº§åˆ«
  vmweak         = suspend_resume + 2,         // VMå¼±å¼•ç”¨çº§åˆ«
  leaf           = vmweak + 2,                 // å¶å­çº§åˆ«
  safepoint      = leaf + 10,                  // å®‰å…¨ç‚¹çº§åˆ«
  barrier        = safepoint + 1,              // å±éšœçº§åˆ«
  nonleaf        = barrier + 1,                // éå¶å­çº§åˆ«
  max_nonleaf    = nonleaf + 900,              // æœ€å¤§éå¶å­çº§åˆ«
  native         = max_nonleaf + 1             // JVM_RawMonitorCreateä½¿ç”¨
};
```

### **4.4 å¸¸è§VMé”**

```
å¸¸è§VMé”åˆ—è¡¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”åç§°                  â”‚ ç”¨é€”                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Heap_lock               â”‚ å †åˆ†é…ä¿æŠ¤                            â”‚
â”‚ Threads_lock            â”‚ çº¿ç¨‹åˆ—è¡¨ä¿æŠ¤                          â”‚
â”‚ CGC_lock                â”‚ å¹¶å‘GCæ“ä½œ                            â”‚
â”‚ Compile_lock            â”‚ ç¼–è¯‘é˜Ÿåˆ—ä¿æŠ¤                          â”‚
â”‚ MethodData_lock         â”‚ æ–¹æ³•æ•°æ®ä¿æŠ¤                          â”‚
â”‚ Patching_lock           â”‚ ä»£ç ä¿®è¡¥ä¿æŠ¤                          â”‚
â”‚ CompiledIC_lock         â”‚ ç¼–è¯‘å†…è”ç¼“å­˜ä¿æŠ¤                      â”‚
â”‚ InlineCacheBuffer_lock  â”‚ å†…è”ç¼“å­˜ç¼“å†²åŒºä¿æŠ¤                    â”‚
â”‚ VMStatistic_lock        â”‚ VMç»Ÿè®¡ä¿æŠ¤                            â”‚
â”‚ JNIHandleBlockFreeList_lockâ”‚ JNIå¥æŸ„å—ç©ºé—²åˆ—è¡¨ä¿æŠ¤              â”‚
â”‚ JNICritical_lock        â”‚ JNIä¸´ç•ŒåŒºä¿æŠ¤                         â”‚
â”‚ JvmtiThreadState_lock   â”‚ JVMTIçº¿ç¨‹çŠ¶æ€ä¿æŠ¤                     â”‚
â”‚ Management_lock         â”‚ ç®¡ç†æ¥å£ä¿æŠ¤                          â”‚
â”‚ Monitor_lock            â”‚ ç›‘è§†å™¨åˆ—è¡¨ä¿æŠ¤                        â”‚
â”‚ Safepoint_lock          â”‚ å®‰å…¨ç‚¹æ“ä½œä¿æŠ¤                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ **5. JvmtiExport - JVMTIå¯¼å‡ºæ¥å£**

### **5.1 æ¦‚è¿°**

`JvmtiExport`æ˜¯JVMTIï¼ˆJVM Tool Interfaceï¼‰ä¸HotSpotå…¶ä»–éƒ¨åˆ†çš„æ¥å£ç±»ï¼Œæä¾›è°ƒè¯•ã€ç›‘æ§å’Œåˆ†æå·¥å…·æ‰€éœ€çš„åŠŸèƒ½ã€‚

### **5.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class JvmtiExport : AllStatic {
  // ==================== è®¡æ•°å™¨ ====================
  static int _field_access_count;              // å­—æ®µè®¿é—®è®¡æ•°
  static int _field_modification_count;        // å­—æ®µä¿®æ”¹è®¡æ•°
  
  // ==================== èƒ½åŠ›æ ‡å¿— ====================
  static bool _can_access_local_variables;     // æ˜¯å¦å¯ä»¥è®¿é—®å±€éƒ¨å˜é‡
  static bool _can_hotswap_or_post_breakpoint; // æ˜¯å¦å¯ä»¥çƒ­æ›¿æ¢æˆ–å‘é€æ–­ç‚¹
  static bool _can_modify_any_class;           // æ˜¯å¦å¯ä»¥ä¿®æ”¹ä»»æ„ç±»
  static bool _can_walk_any_space;             // æ˜¯å¦å¯ä»¥éå†ä»»æ„ç©ºé—´
  
  // ==================== çŠ¶æ€æ ‡å¿— ====================
  static bool _has_redefined_a_class;          // æ˜¯å¦æ›¾ç»é‡å®šä¹‰è¿‡ç±»
  static bool _all_dependencies_are_recorded;  // æ˜¯å¦è®°å½•äº†æ‰€æœ‰ä¾èµ–
  
  // ==================== é’©å­æ ‡å¿— ====================
  static bool _should_post_class_file_load_hook; // æ˜¯å¦å‘é€ç±»æ–‡ä»¶åŠ è½½é’©å­
};
```

### **5.3 JVMTIæ”¯æŒæ ‡å¿—**

```cpp
// é€šè¿‡å®JVMTI_SUPPORT_FLAGå®šä¹‰çš„èƒ½åŠ›æ ‡å¿—
JVMTI_SUPPORT_FLAG(can_get_source_debug_extension)     // è·å–æºç è°ƒè¯•æ‰©å±•
JVMTI_SUPPORT_FLAG(can_maintain_original_method_order) // ç»´æŠ¤åŸå§‹æ–¹æ³•é¡ºåº
JVMTI_SUPPORT_FLAG(can_post_interpreter_events)        // å‘é€è§£é‡Šå™¨äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_on_exceptions)             // å‘é€å¼‚å¸¸äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_breakpoint)                // å‘é€æ–­ç‚¹äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_field_access)              // å‘é€å­—æ®µè®¿é—®äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_field_modification)        // å‘é€å­—æ®µä¿®æ”¹äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_method_entry)              // å‘é€æ–¹æ³•è¿›å…¥äº‹ä»¶
JVMTI_SUPPORT_FLAG(can_post_method_exit)               // å‘é€æ–¹æ³•é€€å‡ºäº‹ä»¶

// é€šè¿‡å®JVMTI_SHOULD_POST_FLAGå®šä¹‰çš„å‘é€æ ‡å¿—
JVMTI_SHOULD_POST_FLAG(should_post_single_step)        // å‘é€å•æ­¥äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_class_load)         // å‘é€ç±»åŠ è½½äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_class_prepare)      // å‘é€ç±»å‡†å¤‡äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_class_unload)       // å‘é€ç±»å¸è½½äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_monitor_contended_enter)  // å‘é€ç›‘è§†å™¨ç«äº‰è¿›å…¥äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_monitor_contended_entered)// å‘é€ç›‘è§†å™¨ç«äº‰å·²è¿›å…¥äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_garbage_collection_start) // å‘é€GCå¼€å§‹äº‹ä»¶
JVMTI_SHOULD_POST_FLAG(should_post_garbage_collection_finish)// å‘é€GCç»“æŸäº‹ä»¶
```

### **5.4 JVMTIäº‹ä»¶å›è°ƒ**

```
JVMTIäº‹ä»¶å›è°ƒæµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Javaä»£ç æ‰§è¡Œ                                                   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ£€æŸ¥JVMTIæ ‡å¿—                                           â”‚   â”‚
â”‚  â”‚ if (JvmtiExport::should_post_xxx())                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚ æ˜¯                                                      â”‚
â”‚       â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è°ƒç”¨JvmtiExport::post_xxx()                             â”‚   â”‚
â”‚  â”‚ â€¢ æ”¶é›†äº‹ä»¶ä¿¡æ¯                                          â”‚   â”‚
â”‚  â”‚ â€¢ è°ƒç”¨æ³¨å†Œçš„å›è°ƒå‡½æ•°                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚                                                         â”‚
â”‚       â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JVMTI Agentå¤„ç†äº‹ä»¶                                     â”‚   â”‚
â”‚  â”‚ â€¢ è°ƒè¯•å™¨æ–­ç‚¹å¤„ç†                                        â”‚   â”‚
â”‚  â”‚ â€¢ æ€§èƒ½åˆ†ææ•°æ®æ”¶é›†                                      â”‚   â”‚
â”‚  â”‚ â€¢ ç›‘æ§å·¥å…·æ•°æ®æ›´æ–°                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **6. Management - JMXç®¡ç†æ¥å£**

### **6.1 æ¦‚è¿°**

`Management`ç±»æä¾›JVMç®¡ç†å’Œç›‘æ§åŠŸèƒ½çš„æ¥å£ï¼Œæ˜¯JMXï¼ˆJava Management Extensionsï¼‰çš„åº•å±‚æ”¯æŒã€‚

### **6.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Management : AllStatic {
  // ==================== æ—¶é—´æˆ³ ====================
  static PerfVariable* _begin_vm_creation_time;  // VMåˆ›å»ºå¼€å§‹æ—¶é—´
  static PerfVariable* _end_vm_creation_time;    // VMåˆ›å»ºç»“æŸæ—¶é—´
  static PerfVariable* _vm_init_done_time;       // VMåˆå§‹åŒ–å®Œæˆæ—¶é—´
  
  // ==================== å¯é€‰æ”¯æŒ ====================
  static jmmOptionalSupport _optional_support;   // å¯é€‰æ”¯æŒåŠŸèƒ½
  
  // ==================== æ—¶é—´æˆ³ ====================
  static TimeStamp _stamp;                       // VMåˆå§‹åŒ–å®Œæˆåçš„æ—¶é—´æˆ³
};
```

### **6.3 ç®¡ç†ç›¸å…³çš„KlassæŒ‡é’ˆ**

```cpp
// Managementç±»æŒæœ‰çš„Klasså¼•ç”¨
static InstanceKlass* _diagnosticCommandImpl_klass;   // è¯Šæ–­å‘½ä»¤å®ç°ç±»
static InstanceKlass* _garbageCollectorExtImpl_klass; // GCæ‰©å±•å®ç°ç±»
static InstanceKlass* _garbageCollectorMXBean_klass;  // GC MXBeanç±»
static InstanceKlass* _gcInfo_klass;                  // GCä¿¡æ¯ç±»
static InstanceKlass* _managementFactoryHelper_klass; // ç®¡ç†å·¥å‚å¸®åŠ©ç±»
static InstanceKlass* _memoryManagerMXBean_klass;     // å†…å­˜ç®¡ç†å™¨MXBeanç±»
static InstanceKlass* _memoryPoolMXBean_klass;        // å†…å­˜æ± MXBeanç±»
static InstanceKlass* _memoryUsage_klass;             // å†…å­˜ä½¿ç”¨ç±»
static InstanceKlass* _sensor_klass;                  // ä¼ æ„Ÿå™¨ç±»
static InstanceKlass* _threadInfo_klass;              // çº¿ç¨‹ä¿¡æ¯ç±»
```

### **6.4 JMX MBeanæ¶æ„**

```
JMX MBeanæ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       JMXå¹³å°MBean                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ MemoryMXBean     â”‚  â”‚ ThreadMXBean     â”‚                    â”‚
â”‚  â”‚ â€¢ å †å†…å­˜ä½¿ç”¨     â”‚  â”‚ â€¢ çº¿ç¨‹æ•°é‡       â”‚                    â”‚
â”‚  â”‚ â€¢ éå †å†…å­˜ä½¿ç”¨   â”‚  â”‚ â€¢ çº¿ç¨‹çŠ¶æ€       â”‚                    â”‚
â”‚  â”‚ â€¢ GCè§¦å‘        â”‚  â”‚ â€¢ æ­»é”æ£€æµ‹       â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚GarbageCollectorMXBeanâ”‚ â”‚MemoryPoolMXBean â”‚                   â”‚
â”‚  â”‚ â€¢ GCæ¬¡æ•°         â”‚  â”‚ â€¢ å†…å­˜æ± ä½¿ç”¨     â”‚                    â”‚
â”‚  â”‚ â€¢ GCæ—¶é—´         â”‚  â”‚ â€¢ å³°å€¼ä½¿ç”¨       â”‚                    â”‚
â”‚  â”‚ â€¢ GCä¿¡æ¯         â”‚  â”‚ â€¢ é˜ˆå€¼ç®¡ç†       â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ ClassLoadingMXBeanâ”‚ â”‚ CompilationMXBean â”‚                   â”‚
â”‚  â”‚ â€¢ å·²åŠ è½½ç±»æ•°     â”‚  â”‚ â€¢ ç¼–è¯‘æ—¶é—´       â”‚                    â”‚
â”‚  â”‚ â€¢ å·²å¸è½½ç±»æ•°     â”‚  â”‚ â€¢ ç¼–è¯‘å™¨åç§°     â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ RuntimeMXBean    â”‚  â”‚ OperatingSystemMXBeanâ”‚                â”‚
â”‚  â”‚ â€¢ VMåç§°/ç‰ˆæœ¬    â”‚  â”‚ â€¢ OSä¿¡æ¯         â”‚                    â”‚
â”‚  â”‚ â€¢ å¯åŠ¨æ—¶é—´       â”‚  â”‚ â€¢ ç³»ç»Ÿè´Ÿè½½       â”‚                    â”‚
â”‚  â”‚ â€¢ è¾“å…¥å‚æ•°       â”‚  â”‚ â€¢ CPUä½¿ç”¨        â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ **7. PerfData - æ€§èƒ½è®¡æ•°å™¨**

### **7.1 æ¦‚è¿°**

`PerfData`æ˜¯æ€§èƒ½æ•°æ®çš„åŸºç±»ï¼Œç”¨äºåˆ›å»ºã€è®¿é—®å’Œæ›´æ–°å¯èƒ½ä½œä¸ºå…±äº«å†…å­˜è®¿é—®çš„æ€§èƒ½æ•°æ®ã€‚è¿™äº›æ•°æ®å¯ä»¥è¢«å¤–éƒ¨å·¥å…·ï¼ˆå¦‚jstatï¼‰è¯»å–ã€‚

### **7.2 PerfDataåŸºç±»æˆå‘˜å˜é‡**

```cpp
class PerfData : public CHeapObj<mtInternal> {
  // ==================== æ ‡è¯†ä¿¡æ¯ ====================
  char* _name;                                 // æ€§èƒ½æ•°æ®é¡¹åç§°
  
  // ==================== åˆ†ç±»ä¿¡æ¯ ====================
  Variability _v;                              // å˜åŒ–æ€§åˆ†ç±»
  Units _u;                                    // å•ä½
  
  // ==================== å†…å­˜ç®¡ç† ====================
  bool _on_c_heap;                             // æ˜¯å¦åœ¨Cå †ä¸Šåˆ†é…
  Flags _flags;                                // æ ‡å¿—
  
  // ==================== æ•°æ®å­˜å‚¨ ====================
  PerfDataEntry* _pdep;                        // æ€§èƒ½æ•°æ®æ¡ç›®æŒ‡é’ˆ
  void* _valuep;                               // æ•°æ®å€¼æŒ‡é’ˆ
};
```

### **7.3 å˜åŒ–æ€§æšä¸¾**

```cpp
enum Variability {
  V_Constant = 1,   // å¸¸é‡ï¼šåˆ›å»ºæ—¶å†™å…¥ä¸€æ¬¡ï¼Œä¹‹åä¸å˜
  V_Monotonic = 2,  // å•è°ƒï¼šå€¼å•è°ƒå˜åŒ–(åªå¢åŠ æˆ–åªå‡å°‘)
  V_Variable = 3    // å˜é‡ï¼šå¯è‡ªç”±ä¿®æ”¹
};
```

### **7.4 å•ä½æšä¸¾**

```cpp
enum Units {
  U_None = 1,       // æ— å•ä½
  U_Bytes = 2,      // å­—èŠ‚
  U_Ticks = 3,      // æ—¶é’Ÿæ»´ç­”
  U_Events = 4,     // äº‹ä»¶æ•°
  U_String = 5,     // å­—ç¬¦ä¸²
  U_Hertz = 6       // é¢‘ç‡
};
```

### **7.5 PerfDataç±»å±‚æ¬¡ç»“æ„**

```
PerfDataç±»å±‚æ¬¡ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  PerfData (æŠ½è±¡åŸºç±»)                                            â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”œâ”€â”€ PerfLong (æŠ½è±¡)                                        â”‚
â”‚      â”‚       â”‚                                                  â”‚
â”‚      â”‚       â”œâ”€â”€ PerfLongConstant (åˆ«å: PerfConstant)          â”‚
â”‚      â”‚       â”‚   â€¢ å¸¸é‡å€¼ï¼Œåˆ›å»ºåä¸å˜                           â”‚
â”‚      â”‚       â”‚                                                  â”‚
â”‚      â”‚       â””â”€â”€ PerfLongVariant (æŠ½è±¡)                         â”‚
â”‚      â”‚               â”‚                                          â”‚
â”‚      â”‚               â”œâ”€â”€ PerfLongVariable (åˆ«å: PerfVariable)  â”‚
â”‚      â”‚               â”‚   â€¢ å¯å˜å€¼ï¼Œå¯è‡ªç”±ä¿®æ”¹                   â”‚
â”‚      â”‚               â”‚                                          â”‚
â”‚      â”‚               â””â”€â”€ PerfLongCounter (åˆ«å: PerfCounter)    â”‚
â”‚      â”‚                   â€¢ è®¡æ•°å™¨ï¼Œå•è°ƒé€’å¢                     â”‚
â”‚      â”‚                                                          â”‚
â”‚      â””â”€â”€ PerfByteArray (æŠ½è±¡)                                   â”‚
â”‚              â”‚                                                  â”‚
â”‚              â””â”€â”€ PerfString (æŠ½è±¡)                              â”‚
â”‚                      â”‚                                          â”‚
â”‚                      â”œâ”€â”€ PerfStringVariable                     â”‚
â”‚                      â”‚   â€¢ å¯å˜å­—ç¬¦ä¸²                           â”‚
â”‚                      â”‚                                          â”‚
â”‚                      â””â”€â”€ PerfStringConstant                     â”‚
â”‚                          â€¢ å¸¸é‡å­—ç¬¦ä¸²                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **7.6 PerfDataManager**

```cpp
class PerfDataManager : AllStatic {
  // ==================== æ•°æ®åˆ—è¡¨ ====================
  static PerfDataList* _all;                   // æ‰€æœ‰å·²çŸ¥PerfDataé¡¹åˆ—è¡¨
  static PerfDataList* _sampled;               // éœ€è¦é‡‡æ ·çš„PerfDataåˆ—è¡¨
  static PerfDataList* _constants;             // å¸¸é‡ç±»å‹PerfDataåˆ—è¡¨
  
  // ==================== å‘½åç©ºé—´ ====================
  static const char* _name_spaces[];           // å‘½åç©ºé—´å­—ç¬¦ä¸²æ•°ç»„
  
  // ==================== çŠ¶æ€æ ‡å¿— ====================
  static volatile bool _has_PerfData;          // æ˜¯å¦æœ‰PerfData
};
```

### **7.7 å¸¸è§æ€§èƒ½è®¡æ•°å™¨**

```
å¸¸è§æ€§èƒ½è®¡æ•°å™¨ (é€šè¿‡jstatå¯æŸ¥çœ‹):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¡æ•°å™¨åç§°              â”‚ è¯´æ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sun.gc.generation.0.space.0.used â”‚ EdenåŒºä½¿ç”¨é‡               â”‚
â”‚ sun.gc.generation.0.space.1.used â”‚ Survivor0åŒºä½¿ç”¨é‡          â”‚
â”‚ sun.gc.generation.0.space.2.used â”‚ Survivor1åŒºä½¿ç”¨é‡          â”‚
â”‚ sun.gc.generation.1.space.0.used â”‚ è€å¹´ä»£ä½¿ç”¨é‡               â”‚
â”‚ sun.gc.collector.0.invocations   â”‚ Young GCæ¬¡æ•°               â”‚
â”‚ sun.gc.collector.0.time          â”‚ Young GCæ€»æ—¶é—´             â”‚
â”‚ sun.gc.collector.1.invocations   â”‚ Old GCæ¬¡æ•°                 â”‚
â”‚ sun.gc.collector.1.time          â”‚ Old GCæ€»æ—¶é—´               â”‚
â”‚ java.cls.loadedClasses           â”‚ å·²åŠ è½½ç±»æ•°é‡               â”‚
â”‚ java.cls.unloadedClasses         â”‚ å·²å¸è½½ç±»æ•°é‡               â”‚
â”‚ java.threads.live                â”‚ æ´»è·ƒçº¿ç¨‹æ•°                 â”‚
â”‚ java.threads.daemon              â”‚ å®ˆæŠ¤çº¿ç¨‹æ•°                 â”‚
â”‚ sun.ci.totalCompiles             â”‚ æ€»ç¼–è¯‘æ¬¡æ•°                 â”‚
â”‚ sun.ci.totalTime                 â”‚ æ€»ç¼–è¯‘æ—¶é—´                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¬ **8. JfrThreadSampler - JFRçº¿ç¨‹é‡‡æ ·å™¨**

### **8.1 æ¦‚è¿°**

`JfrThreadSampler`æ˜¯JFRï¼ˆJava Flight Recorderï¼‰çš„çº¿ç¨‹é‡‡æ ·å™¨ï¼Œç”¨äºå‘¨æœŸæ€§é‡‡æ ·Javaçº¿ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ï¼Œç”ŸæˆCPUåˆ†ææ•°æ®ã€‚

### **8.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class JfrThreadSampler : public NonJavaThread {
  // ==================== åŒæ­¥ ====================
  Semaphore _sample;                           // é‡‡æ ·ä¿¡å·é‡
  Thread* _sampler_thread;                     // é‡‡æ ·å™¨çº¿ç¨‹
  
  // ==================== æ ˆå¸§å­˜å‚¨ ====================
  JfrStackFrame* const _frames;                // æ ˆå¸§æ•°ç»„(ç”¨äºå­˜å‚¨é‡‡æ ·çš„æ ˆå¸§)
  
  // ==================== ä¸Šæ¬¡é‡‡æ ·çº¿ç¨‹ ====================
  JavaThread* _last_thread_java;               // ä¸Šæ¬¡Javaé‡‡æ ·çš„çº¿ç¨‹
  JavaThread* _last_thread_native;             // ä¸Šæ¬¡Nativeé‡‡æ ·çš„çº¿ç¨‹
  
  // ==================== é‡‡æ ·é—´éš” ====================
  size_t _interval_java;                       // Javaé‡‡æ ·é—´éš”(æ¯«ç§’)
  size_t _interval_native;                     // Nativeé‡‡æ ·é—´éš”(æ¯«ç§’)
  
  // ==================== ç´¢å¼• ====================
  int _cur_index;                              // å½“å‰çº¿ç¨‹ç´¢å¼•
  
  // ==================== é…ç½® ====================
  const u4 _max_frames;                        // æœ€å¤§æ ˆå¸§æ•°
  
  // ==================== çŠ¶æ€ ====================
  volatile bool _disenrolled;                  // æ˜¯å¦å·²å–æ¶ˆæ³¨å†Œ
};
```

### **8.3 JFRé‡‡æ ·æµç¨‹**

```
JFRçº¿ç¨‹é‡‡æ ·æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. å¯åŠ¨é‡‡æ ·å™¨                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JfrThreadSampler::enroll()                              â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ç½®é‡‡æ ·é—´éš”                                          â”‚   â”‚
â”‚  â”‚ â€¢ å¯åŠ¨é‡‡æ ·çº¿ç¨‹                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  2. å‘¨æœŸæ€§é‡‡æ ·                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¾ªç¯:                                                   â”‚   â”‚
â”‚  â”‚ â€¢ ç­‰å¾…é‡‡æ ·é—´éš”                                          â”‚   â”‚
â”‚  â”‚ â€¢ é€‰æ‹©ç›®æ ‡çº¿ç¨‹                                          â”‚   â”‚
â”‚  â”‚ â€¢ æŒ‚èµ·ç›®æ ‡çº¿ç¨‹                                          â”‚   â”‚
â”‚  â”‚ â€¢ è·å–æ ˆè·Ÿè¸ª                                            â”‚   â”‚
â”‚  â”‚ â€¢ æ¢å¤ç›®æ ‡çº¿ç¨‹                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  3. è®°å½•é‡‡æ ·æ•°æ®                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ åˆ›å»ºJFRäº‹ä»¶                                           â”‚   â”‚
â”‚  â”‚ â€¢ è®°å½•çº¿ç¨‹IDã€çŠ¶æ€ã€æ ˆå¸§                                â”‚   â”‚
â”‚  â”‚ â€¢ å†™å…¥JFRç¼“å†²åŒº                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  4. åœæ­¢é‡‡æ ·å™¨                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ JfrThreadSampler::disenroll()                           â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ç½®_disenrolled = true                               â”‚   â”‚
â”‚  â”‚ â€¢ ç­‰å¾…é‡‡æ ·çº¿ç¨‹é€€å‡º                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— **9. åŒæ­¥ä¸ç›‘æ§å¯¹è±¡å…³ç³»å›¾**

```
åŒæ­¥ä¸ç›‘æ§å¯¹è±¡å…³ç³»å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Javaå±‚åŒæ­¥                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚   â”‚
â”‚  â”‚  â”‚ Java Object  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ (synchronized)â”‚                                     â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚            â”‚   â”‚
â”‚  â”‚         â”‚ è†¨èƒ€                                         â”‚            â”‚   â”‚
â”‚  â”‚         â–¼                                              â–¼            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚ObjectMonitor â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ObjectWaiter  â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ _owner     â”‚                              â”‚ (ç­‰å¾…çº¿ç¨‹)   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ _EntryList â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ _WaitSet   â”‚                                                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      VMå±‚åŒæ­¥                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚  â”‚    Mutex     â”‚          â”‚   Monitor    â”‚                         â”‚   â”‚
â”‚  â”‚  â”‚  (äº’æ–¥é”)    â”‚          â”‚  (ç›‘è§†å™¨)    â”‚                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚         â”‚                          â”‚                                â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚   â”‚
â”‚  â”‚                    â–¼                                                â”‚   â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚   â”‚
â”‚  â”‚            â”‚  ParkEvent   â”‚                                         â”‚   â”‚
â”‚  â”‚            â”‚ (åœè½¦äº‹ä»¶)   â”‚                                         â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      å…¨å±€åŒæ­¥                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              SafepointSynchronize                            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚              (å®‰å…¨ç‚¹åŒæ­¥)                                    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      ç›‘æ§ä¸è¯Šæ–­                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ JvmtiExport  â”‚  â”‚  Management  â”‚  â”‚   PerfData   â”‚               â”‚   â”‚
â”‚  â”‚  â”‚  (JVMTI)     â”‚  â”‚   (JMX)      â”‚  â”‚ (æ€§èƒ½è®¡æ•°å™¨) â”‚               â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚   â”‚
â”‚  â”‚  â”‚JfrThreadSamplerâ”‚                                                 â”‚   â”‚
â”‚  â”‚  â”‚ (JFRé‡‡æ ·å™¨)  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **10. 8GBå †ç¯å¢ƒä¸‹çš„åŒæ­¥ä¸ç›‘æ§ç»Ÿè®¡**

### **10.1 å¯¹è±¡æ•°é‡ç»Ÿè®¡**

| å¯¹è±¡ç±»å‹ | å®ä¾‹æ•° | å•ä¸ªå¤§å° | æ€»å†…å­˜ | è¯´æ˜ |
|---------|--------|---------|--------|------|
| **ObjectMonitor** | 100-10000 | ~128B | ~1.3MB | é‡é‡çº§é” |
| **SafepointSynchronize** | 1 (é™æ€ç±») | ~1KB | ~1KB | å®‰å…¨ç‚¹åŒæ­¥ |
| **Mutex/Monitor** | ~100 | ~200B | ~20KB | VMå†…éƒ¨é” |
| **JvmtiExport** | 1 (é™æ€ç±») | ~1KB | ~1KB | JVMTIå¯¼å‡º |
| **Management** | 1 (é™æ€ç±») | ~1KB | ~1KB | JMXç®¡ç† |
| **PerfData** | ~500 | ~100B | ~50KB | æ€§èƒ½è®¡æ•°å™¨ |
| **JfrThreadSampler** | 0-1 | ~4KB | ~4KB | JFRé‡‡æ ·å™¨ |

### **10.2 åŒæ­¥æ€§èƒ½åŸºå‡†**

```
åŒæ­¥æ€§èƒ½åŸºå‡† (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œ                    â”‚ å…¸å‹å»¶è¿Ÿ      â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åå‘é”è·å–              â”‚ ~1ns          â”‚ æ— ç«äº‰ï¼ŒåŒä¸€çº¿ç¨‹      â”‚
â”‚ è½»é‡çº§é”è·å–            â”‚ ~10ns         â”‚ æ— ç«äº‰ï¼ŒCASæ“ä½œ       â”‚
â”‚ é‡é‡çº§é”è·å–(æ— ç«äº‰)    â”‚ ~100ns        â”‚ ObjectMonitor         â”‚
â”‚ é‡é‡çº§é”è·å–(æœ‰ç«äº‰)    â”‚ ~1-100Î¼s      â”‚ éœ€è¦é˜»å¡ç­‰å¾…          â”‚
â”‚ å®‰å…¨ç‚¹åŒæ­¥              â”‚ ~1-50ms       â”‚ å–å†³äºçº¿ç¨‹æ•°          â”‚
â”‚ ç›‘è§†å™¨è†¨èƒ€              â”‚ ~1-10Î¼s       â”‚ è½»é‡çº§â†’é‡é‡çº§         â”‚
â”‚ ç›‘è§†å™¨æ”¶ç¼©              â”‚ ~100ns/ä¸ª     â”‚ å®‰å…¨ç‚¹æ—¶æ‰§è¡Œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **11. æ€»ç»“**

### **11.1 åŒæ­¥ä¸ç›‘æ§æ ¸å¿ƒå¯¹è±¡**

1. **ObjectMonitor**: Javaå¯¹è±¡çš„é‡é‡çº§é”å®ç°ï¼Œæ”¯æŒwait/notify
2. **SafepointSynchronize**: å…¨å±€å®‰å…¨ç‚¹åŒæ­¥ï¼Œç”¨äºGCå’Œå…¶ä»–VMæ“ä½œ
3. **Mutex/Monitor**: HotSpotå†…éƒ¨ä½¿ç”¨çš„åŒæ­¥åŸè¯­
4. **JvmtiExport**: JVMTIè°ƒè¯•å’Œç›‘æ§æ¥å£
5. **Management**: JMXç®¡ç†æ¥å£æ”¯æŒ
6. **PerfData**: æ€§èƒ½è®¡æ•°å™¨å’Œç›‘æ§æ•°æ®
7. **JfrThreadSampler**: JFRçº¿ç¨‹é‡‡æ ·å™¨

### **11.2 å…³é”®è®¾è®¡æ€æƒ³**

- **é”å‡çº§**: åå‘é”â†’è½»é‡çº§é”â†’é‡é‡çº§é”ï¼ŒæŒ‰éœ€å‡çº§
- **å®‰å…¨ç‚¹**: å…¨å±€åŒæ­¥ç‚¹ï¼Œç¡®ä¿VMæ“ä½œçš„ä¸€è‡´æ€§
- **åˆ†å±‚ç›‘æ§**: JVMTI(åº•å±‚)ã€JMX(é«˜å±‚)ã€JFR(å…¨é¢)
- **æ€§èƒ½è®¡æ•°å™¨**: å…±äº«å†…å­˜è®¿é—®ï¼Œå¤–éƒ¨å·¥å…·å¯è¯»å–

### **11.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®**

```
åŒæ­¥ä¸ç›‘æ§è°ƒä¼˜å»ºè®® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                    â”‚ å»ºè®®                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‡å°‘é”ç«äº‰              â”‚ ä½¿ç”¨ç»†ç²’åº¦é”ã€æ— é”æ•°æ®ç»“æ„            â”‚
â”‚ å‡å°‘å®‰å…¨ç‚¹åœé¡¿          â”‚ é¿å…é•¿æ—¶é—´Nativeè°ƒç”¨                  â”‚
â”‚ ç›‘æ§é”ç«äº‰              â”‚ -XX:+PrintSafepointStatistics         â”‚
â”‚ åˆ†æé”é—®é¢˜              â”‚ jstackã€JFRé”åˆ†æ                     â”‚
â”‚ ç¦ç”¨åå‘é”              â”‚ -XX:-UseBiasedLocking (é«˜ç«äº‰åœºæ™¯)    â”‚
â”‚ è°ƒæ•´è‡ªæ—‹æ¬¡æ•°            â”‚ -XX:PreBlockSpin=10                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
