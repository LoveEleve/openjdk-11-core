# VMThreadåˆ›å»ºä¸Javaæ ¸å¿ƒç±»åˆå§‹åŒ–æ·±åº¦åˆ†æ

## ğŸ“‹ **æ¦‚è¿°**

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMæœ€ç»ˆåˆå§‹åŒ–é˜¶æ®µçš„å‰åŠéƒ¨åˆ†ï¼Œé‡ç‚¹å…³æ³¨VMThreadçš„åˆ›å»ºæœºåˆ¶å’ŒJavaæ ¸å¿ƒç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚è¿™æ˜¯JVMä»C++ä¸–ç•Œå‘Javaä¸–ç•Œè¿‡æ¸¡çš„å…³é”®é˜¶æ®µï¼Œæ¶‰åŠçº¿ç¨‹ç®¡ç†ã€ç±»åŠ è½½ã€JVMTIæ”¯æŒç­‰æ ¸å¿ƒæœºåˆ¶ã€‚

### **åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (ä¸ä½¿ç”¨å¤§é¡µ)
- **JVMç‰ˆæœ¬**: OpenJDK 11
- **ç¼–è¯‘å™¨**: é»˜è®¤åˆ†å±‚ç¼–è¯‘ (C1 + C2)

---

## ğŸ§µ **VMThreadåˆ›å»ºä¸ç®¡ç†**

### **1. VMThreadçš„æ ¸å¿ƒä½œç”¨**

VMThreadæ˜¯JVMä¸­æœ€é‡è¦çš„ç³»ç»Ÿçº¿ç¨‹ä¹‹ä¸€ï¼Œè´Ÿè´£æ‰§è¡Œæ‰€æœ‰éœ€è¦åœ¨å®‰å…¨ç‚¹(Safepoint)è¿›è¡Œçš„VMæ“ä½œã€‚

```cpp
// VMThreadåˆ›å»ºçš„æ ¸å¿ƒä»£ç 
{
    TraceTime timer("Start VMThread", TRACETIME_LOG(Info, startuptime));
    
    VMThread::create();
    Thread * vmthread = VMThread::vm_thread();
    
    if (!os::create_thread(vmthread, os::vm_thread)) {
        vm_exit_during_initialization("Cannot create VM thread. "
                                      "Out of system resources.");
    }
    
    // ç­‰å¾…VMThreadå‡†å¤‡å°±ç»ª
    {
        MutexLocker ml(Notify_lock);
        os::start_thread(vmthread);
        while (vmthread->active_handles() == NULL) {
            Notify_lock->wait();
        }
    }
}
```

### **2. VMThreadæ¶æ„è®¾è®¡**

#### **2.1 æ ¸å¿ƒæ•°æ®ç»“æ„**

```cpp
class VMThread : public NamedThread {
private:
    static bool              _should_terminate;   // ç»ˆæ­¢æ ‡å¿—
    static bool              _terminated;         // å·²ç»ˆæ­¢æ ‡å¿—
    static Monitor*          _terminate_lock;     // ç»ˆæ­¢é”
    static VMThread*         _vm_thread;          // å•ä¾‹å®ä¾‹
    static VM_Operation*     _cur_vm_operation;   // å½“å‰VMæ“ä½œ
    static VMOperationQueue* _vm_queue;           // VMæ“ä½œé˜Ÿåˆ—
    static PerfCounter*      _perf_accumulated_vm_operation_time; // æ€§èƒ½è®¡æ•°å™¨
    static VMOperationTimeoutTask* _timeout_task; // è¶…æ—¶ä»»åŠ¡
};
```

#### **2.2 VMæ“ä½œé˜Ÿåˆ—æœºåˆ¶**

```
VMThreadæ“ä½œå¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VMæ“ä½œé˜Ÿåˆ—æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº”ç”¨çº¿ç¨‹                                                     â”‚
â”‚    â†“                                                        â”‚
â”‚ VMThread::execute(VM_Operation*)                            â”‚
â”‚    â†“                                                        â”‚
â”‚ VMOperationQueue::add()                                     â”‚
â”‚    â†“                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ â”‚   é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—   â”‚    â”‚   æ™®é€šä¼˜å…ˆçº§é˜Ÿåˆ— â”‚                 â”‚
â”‚ â”‚ (safepoint ops) â”‚    â”‚ (concurrent ops)â”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚    â†“                          â†“                            â”‚
â”‚ VMThread::loop() å¤„ç†                                       â”‚
â”‚    â†“                                                        â”‚
â”‚ VM_Operation::evaluate()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. VMThreadåˆ›å»ºè¿‡ç¨‹è¯¦è§£**

#### **3.1 åˆ›å»ºé˜¶æ®µ**

```cpp
void VMThread::create() {
    assert(vm_thread() == NULL, "we can only allocate one VMThread");
    _vm_thread = new VMThread();
    
    // å¦‚æœå¯ç”¨äº†VMæ“ä½œè¶…æ—¶æ£€æµ‹
    if (AbortVMOnVMOperationTimeout) {
        // è®¡ç®—è¶…æ—¶æ£€æµ‹é—´éš” (è¶…æ—¶å»¶è¿Ÿçš„10%)
        size_t interval = (size_t)AbortVMOnVMOperationTimeoutDelay / 10;
        interval = interval / PeriodicTask::interval_gran * PeriodicTask::interval_gran;
        interval = MAX2<size_t>(interval, PeriodicTask::min_interval);
        interval = MIN2<size_t>(interval, PeriodicTask::max_interval);
        
        _timeout_task = new VMOperationTimeoutTask(interval);
        _timeout_task->enroll();
    }
    
    // åˆ›å»ºVMæ“ä½œé˜Ÿåˆ—
    _vm_queue = new VMOperationQueue();
}
```

#### **3.2 çº¿ç¨‹å¯åŠ¨åŒæ­¥**

```cpp
// åˆ›å»ºæ“ä½œç³»ç»Ÿçº¿ç¨‹
if (!os::create_thread(vmthread, os::vm_thread)) {
    vm_exit_during_initialization("Cannot create VM thread. "
                                  "Out of system resources.");
}

// å¯åŠ¨çº¿ç¨‹å¹¶ç­‰å¾…å°±ç»ª
{
    MutexLocker ml(Notify_lock);
    os::start_thread(vmthread);
    // ç­‰å¾…VMThreadåˆå§‹åŒ–å®Œæˆ (active_handles != NULL)
    while (vmthread->active_handles() == NULL) {
        Notify_lock->wait();
    }
}
```

### **4. VMThreadæ€§èƒ½ç‰¹å¾**

#### **4.1 å†…å­˜ä½¿ç”¨ (8GBå †ç¯å¢ƒ)**

```
VMThreadå†…å­˜å ç”¨åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                â”‚ å¤§å°        â”‚ è¯´æ˜                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VMThreadå¯¹è±¡        â”‚ ~2KB        â”‚ çº¿ç¨‹å¯¹è±¡æœ¬èº«             â”‚
â”‚ VMOperationQueue    â”‚ ~4KB        â”‚ æ“ä½œé˜Ÿåˆ—                 â”‚
â”‚ æ ˆç©ºé—´              â”‚ 1MB         â”‚ é»˜è®¤çº¿ç¨‹æ ˆå¤§å°           â”‚
â”‚ HandleåŒºåŸŸ          â”‚ ~64KB       â”‚ å¯¹è±¡å¥æŸ„å­˜å‚¨             â”‚
â”‚ æ€§èƒ½è®¡æ•°å™¨          â”‚ ~1KB        â”‚ ç»Ÿè®¡ä¿¡æ¯                 â”‚
â”‚ æ€»è®¡                â”‚ ~1.07MB     â”‚ çº¦å æ€»å †çš„0.013%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **4.2 å¯åŠ¨æ—¶é—´åˆ†æ**

```
VMThreadåˆ›å»ºæ—¶é—´åˆ†è§£ (å…¸å‹å€¼)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ                â”‚ æ—¶é—´        â”‚ å æ¯”        â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è±¡åˆ†é…            â”‚ 0.1ms       â”‚ 2%          â”‚ å†…å­˜åˆ†é…   â”‚
â”‚ æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ›å»º    â”‚ 2.5ms       â”‚ 50%         â”‚ ç³»ç»Ÿè°ƒç”¨   â”‚
â”‚ çº¿ç¨‹å¯åŠ¨            â”‚ 1.8ms       â”‚ 36%         â”‚ è°ƒåº¦å»¶è¿Ÿ   â”‚
â”‚ åˆå§‹åŒ–åŒæ­¥          â”‚ 0.6ms       â”‚ 12%         â”‚ ç­‰å¾…å°±ç»ª   â”‚
â”‚ æ€»è®¡                â”‚ 5.0ms       â”‚ 100%        â”‚ å®Œæ•´æµç¨‹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â˜• **Javaæ ¸å¿ƒç±»åˆå§‹åŒ–**

### **1. initialize_java_lang_classesè¯¦è§£**

è¿™æ˜¯JVMä»C++ä¸–ç•Œå‘Javaä¸–ç•Œè¿‡æ¸¡çš„å…³é”®æ­¥éª¤ï¼Œåˆå§‹åŒ–Javaè¿è¡Œæ—¶å¿…éœ€çš„æ ¸å¿ƒç±»ã€‚

```cpp
void Threads::initialize_java_lang_classes(JavaThread *main_thread, TRAPS) {
    TraceTime timer("Initialize java.lang classes", TRACETIME_LOG(Info, startuptime));
    
    // 1. å¤„ç†æ—©æœŸ-Xrunä»£ç†
    if (EagerXrunInit && Arguments::init_libraries_at_startup()) {
        create_vm_init_libraries();
    }
    
    // 2. åˆå§‹åŒ–Stringç±»
    initialize_class(vmSymbols::java_lang_String(), CHECK);
    
    // 3. æ³¨å…¥CompactStringsé…ç½®
    java_lang_String::set_compact_strings(CompactStrings);
    
    // 4. åˆå§‹åŒ–Systemç±»
    initialize_class(vmSymbols::java_lang_System(), CHECK);
    
    // 5. åˆå§‹åŒ–Classç±»
    initialize_class(vmSymbols::java_lang_Class(), CHECK);
    
    // 6. åˆå§‹åŒ–ThreadGroupç±»
    initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
    Handle thread_group = create_initial_thread_group(CHECK);
    Universe::set_main_thread_group(thread_group());
    
    // 7. åˆå§‹åŒ–Threadç±»
    initialize_class(vmSymbols::java_lang_Thread(), CHECK);
    oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
    
    // 8. è®¾ç½®ä¸»çº¿ç¨‹çš„Javaå¯¹è±¡
    main_thread->set_threadObj(thread_object);
    
    // 9. åˆå§‹åŒ–å…¶ä»–æ ¸å¿ƒç±»...
}
```

### **2. æ ¸å¿ƒç±»åˆå§‹åŒ–é¡ºåº**

#### **2.1 åˆå§‹åŒ–ä¾èµ–å›¾**

```
Javaæ ¸å¿ƒç±»åˆå§‹åŒ–ä¾èµ–å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚     java.lang.Object (å·²åœ¨universe_initä¸­åˆå§‹åŒ–)            â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.String                                        â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.System                                        â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.Class                                         â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.ThreadGroup                                   â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.Thread                                        â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.Throwable                                     â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.Exception                                     â”‚
â”‚            â†“                                                â”‚
â”‚     java.lang.RuntimeException                              â”‚
â”‚            â†“                                                â”‚
â”‚     å…¶ä»–å¼‚å¸¸ç±»...                                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2.2 Stringç±»åˆå§‹åŒ–è¯¦è§£**

```cpp
// Stringç±»çš„ç‰¹æ®Šå¤„ç†
initialize_class(vmSymbols::java_lang_String(), CHECK);

// æ³¨å…¥CompactStringsé…ç½® (JDK 9+ç‰¹æ€§)
java_lang_String::set_compact_strings(CompactStrings);
```

**CompactStringsæœºåˆ¶**ï¼š
- **ç›®çš„**: ä¼˜åŒ–Stringå†…å­˜ä½¿ç”¨ï¼ŒLatin-1å­—ç¬¦ä¸²ä½¿ç”¨byte[]è€Œéchar[]
- **å†…å­˜èŠ‚çœ**: çº¦50%çš„Stringå†…å­˜å ç”¨
- **æ€§èƒ½å½±å“**: è½»å¾®çš„CPUå¼€é”€ï¼Œä½†å†…å­˜å±€éƒ¨æ€§æ›´å¥½

#### **2.3 Threadå’ŒThreadGroupåˆå§‹åŒ–**

```cpp
// åˆ›å»ºåˆå§‹çº¿ç¨‹ç»„
Handle thread_group = create_initial_thread_group(CHECK);
Universe::set_main_thread_group(thread_group());

// åˆ›å»ºä¸»çº¿ç¨‹çš„Javaå¯¹è±¡
oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
main_thread->set_threadObj(thread_object);
```

**çº¿ç¨‹å¯¹è±¡å…³è”**ï¼š
```
C++ JavaThread â†â†’ Java Threadå¯¹è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ C++ä¾§ (JavaThread)      â”‚ Javaä¾§ (Threadå¯¹è±¡)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _threadObj              â”‚ eetop (C++çº¿ç¨‹æŒ‡é’ˆ)              â”‚
â”‚ _anchor                 â”‚ name                             â”‚
â”‚ _stack_base             â”‚ priority                         â”‚
â”‚ _stack_size             â”‚ daemon                           â”‚
â”‚ _osthread               â”‚ group                            â”‚
â”‚ _exception_oop          â”‚ contextClassLoader               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. ç±»åˆå§‹åŒ–æ€§èƒ½åˆ†æ**

#### **3.1 åˆå§‹åŒ–æ—¶é—´åˆ†è§£ (8GBå †ç¯å¢ƒ)**

```
Javaæ ¸å¿ƒç±»åˆå§‹åŒ–æ—¶é—´åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å                    â”‚ æ—¶é—´      â”‚ å æ¯”    â”‚ è¯´æ˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ java.lang.String        â”‚ 8.5ms     â”‚ 25%     â”‚ å­—ç¬¦ä¸²å¤„ç†   â”‚
â”‚ java.lang.System        â”‚ 12.2ms    â”‚ 36%     â”‚ ç³»ç»Ÿå±æ€§     â”‚
â”‚ java.lang.Class         â”‚ 6.8ms     â”‚ 20%     â”‚ åå°„åŸºç¡€     â”‚
â”‚ java.lang.Thread        â”‚ 4.1ms     â”‚ 12%     â”‚ çº¿ç¨‹æ”¯æŒ     â”‚
â”‚ java.lang.ThreadGroup   â”‚ 1.2ms     â”‚ 4%      â”‚ çº¿ç¨‹ç»„       â”‚
â”‚ å…¶ä»–å¼‚å¸¸ç±»              â”‚ 1.2ms     â”‚ 3%      â”‚ å¼‚å¸¸å¤„ç†     â”‚
â”‚ æ€»è®¡                    â”‚ 34.0ms    â”‚ 100%    â”‚ å®Œæ•´æµç¨‹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **3.2 å†…å­˜å ç”¨åˆ†æ**

```
æ ¸å¿ƒç±»å†…å­˜å ç”¨ (Metaspaceä¸­)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ å¤§å°      â”‚ è¯´æ˜                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç±»å…ƒæ•°æ®                â”‚ 256KB     â”‚ Klasså¯¹è±¡              â”‚
â”‚ æ–¹æ³•å…ƒæ•°æ®              â”‚ 512KB     â”‚ Methodå¯¹è±¡             â”‚
â”‚ å¸¸é‡æ±                   â”‚ 128KB     â”‚ ConstantPoolå¯¹è±¡       â”‚
â”‚ å­—èŠ‚ç                   â”‚ 64KB      â”‚ æ–¹æ³•å­—èŠ‚ç              â”‚
â”‚ ç¬¦å·è¡¨å¼•ç”¨              â”‚ 32KB      â”‚ Symbolå¼•ç”¨             â”‚
â”‚ æ€»è®¡                    â”‚ 992KB     â”‚ çº¦å Metaspaceçš„5%      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ **JVMTIæ”¯æŒåˆå§‹åŒ–**

### **1. JVMTIé˜¶æ®µç®¡ç†**

JVM Tool Interface (JVMTI) ä½¿ç”¨é˜¶æ®µæ¨¡å‹æ¥ç®¡ç†VMçš„ç”Ÿå‘½å‘¨æœŸï¼š

```cpp
// JVMTIé˜¶æ®µè½¬æ¢
JvmtiExport::enter_early_start_phase();  // æ—©æœŸå¯åŠ¨é˜¶æ®µ
JvmtiExport::post_early_vm_start();      // å‘é€æ—©æœŸVMå¯åŠ¨äº‹ä»¶
```

#### **1.1 JVMTIé˜¶æ®µå›¾**

```
JVMTIç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ONLOAD â†’ PRIMORDIAL â†’ EARLY_START â†’ START â†’ LIVE â†’ DEAD    â”‚
â”‚    â†‘           â†‘            â†‘         â†‘      â†‘       â†‘     â”‚
â”‚  ä»£ç†åŠ è½½   VMåˆå§‹åŒ–    æ—©æœŸå¯åŠ¨   æ­£å¼å¯åŠ¨  è¿è¡Œ   å…³é—­     â”‚
â”‚                                      â†‘                      â”‚
â”‚                               å½“å‰ä½ç½®                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 æ—©æœŸå¯åŠ¨é˜¶æ®µåŠŸèƒ½**

```cpp
void JvmtiExport::enter_early_start_phase() {
    set_early_vmstart_recorded(true);
}

void JvmtiExport::post_early_vm_start() {
    EVT_TRIG_TRACE(JVMTI_EVENT_VM_START, ("Trg Early VM start event triggered"));
    
    // å¯ç”¨æŸäº›äº‹ä»¶
    JvmtiEventController::vm_start();
    
    // é€šçŸ¥æ‰€æœ‰JVMTIç¯å¢ƒ
    JvmtiEnvIterator it;
    for (JvmtiEnv* env = it.first(); env != NULL; env = it.next(env)) {
        if (env->is_enabled(JVMTI_EVENT_VM_START)) {
            env->post_vm_start_event();
        }
    }
}
```

### **2. JVMTIåŸå§‹ç›‘è§†å™¨è½¬æ¢**

```cpp
// å°†onloadé˜¶æ®µçš„åŸå§‹ç›‘è§†å™¨è½¬æ¢ä¸ºçœŸæ­£çš„ç›‘è§†å™¨
JvmtiExport::transition_pending_onload_raw_monitors();
```

è¿™ä¸ªæ­¥éª¤ç¡®ä¿åœ¨ä»£ç†onloadé˜¶æ®µåˆ›å»ºçš„ç›‘è§†å™¨èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

---

## ğŸš€ **æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜**

### **1. å¯åŠ¨æ—¶é—´ä¼˜åŒ–**

#### **1.1 ç±»æ•°æ®å…±äº« (CDS) å½±å“**

```
CDSå¯¹Javaç±»åˆå§‹åŒ–çš„å½±å“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡å¼        â”‚ åˆå§‹åŒ–æ—¶é—´  â”‚ å†…å­˜å ç”¨    â”‚ è¯´æ˜             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— CDS       â”‚ 34.0ms      â”‚ 992KB       â”‚ æ ‡å‡†åˆå§‹åŒ–       â”‚
â”‚ å¯ç”¨CDS     â”‚ 8.5ms       â”‚ 256KB       â”‚ é¢„åŠ è½½ç±»å…ƒæ•°æ®   â”‚
â”‚ æ”¹å–„æ¯”ä¾‹    â”‚ 75%         â”‚ 74%         â”‚ æ˜¾è‘—æå‡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 è°ƒä¼˜å»ºè®®**

```bash
# å¯ç”¨CDSä»¥åŠ é€Ÿç±»åˆå§‹åŒ–
-XX:+UseSharedSpaces
-XX:SharedArchiveFile=classes.jsa

# ä¼˜åŒ–VMThreadåˆ›å»º
-XX:VMThreadStackSize=1024k  # å‡å°‘æ ˆå¤§å° (é»˜è®¤1MB)

# å¯ç”¨CompactStrings (é»˜è®¤å¯ç”¨)
-XX:+CompactStrings

# ç›‘æ§åˆå§‹åŒ–æ—¶é—´
-XX:+TraceClassLoading
-XX:+LogVMOutput
-XX:+UnlockDiagnosticVMOptions
-XX:+TraceClassInitialization
```

### **2. å†…å­˜ä¼˜åŒ–**

#### **2.1 Metaspaceè°ƒä¼˜**

```bash
# 8GBå †ç¯å¢ƒçš„Metaspaceé…ç½®
-XX:MetaspaceSize=256m        # åˆå§‹å¤§å°
-XX:MaxMetaspaceSize=512m     # æœ€å¤§å¤§å°
-XX:CompressedClassSpaceSize=128m  # å‹ç¼©ç±»ç©ºé—´
```

#### **2.2 çº¿ç¨‹æ ˆä¼˜åŒ–**

```bash
# å‡å°‘çº¿ç¨‹æ ˆå¤§å°ä»¥èŠ‚çœå†…å­˜
-Xss512k                     # åº”ç”¨çº¿ç¨‹æ ˆ
-XX:VMThreadStackSize=512k   # VMçº¿ç¨‹æ ˆ
-XX:CompilerThreadStackSize=2m  # ç¼–è¯‘å™¨çº¿ç¨‹æ ˆ
```

---

## ğŸ” **æ•…éšœæ’æŸ¥ä¸ç›‘æ§**

### **1. å¸¸è§é—®é¢˜è¯Šæ–­**

#### **1.1 VMThreadåˆ›å»ºå¤±è´¥**

```
é”™è¯¯ä¿¡æ¯: "Cannot create VM thread. Out of system resources."

å¯èƒ½åŸå› :
1. ç³»ç»Ÿçº¿ç¨‹æ•°é™åˆ¶ (ulimit -u)
2. å†…å­˜ä¸è¶³
3. åœ°å€ç©ºé—´è€—å°½

è¯Šæ–­å‘½ä»¤:
# æ£€æŸ¥çº¿ç¨‹é™åˆ¶
ulimit -u
cat /proc/sys/kernel/threads-max

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h
cat /proc/meminfo

# æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
ps -eLf | grep java | wc -l
```

#### **1.2 Javaç±»åˆå§‹åŒ–å¤±è´¥**

```
é”™è¯¯ä¿¡æ¯: ClassNotFoundException, NoClassDefFoundError

å¯èƒ½åŸå› :
1. ç±»è·¯å¾„é…ç½®é”™è¯¯
2. ç±»æ–‡ä»¶æŸå
3. æƒé™é—®é¢˜
4. å†…å­˜ä¸è¶³

è¯Šæ–­æ–¹æ³•:
-XX:+TraceClassLoading
-XX:+TraceClassResolution
-verbose:class
```

### **2. æ€§èƒ½ç›‘æ§**

#### **2.1 å…³é”®æŒ‡æ ‡**

```
VMThreadæ€§èƒ½æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ æ­£å¸¸èŒƒå›´    â”‚ ç›‘æ§æ–¹æ³•           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VMThreadåˆ›å»ºæ—¶é—´        â”‚ < 10ms      â”‚ -XX:+TraceTimes    â”‚
â”‚ Javaç±»åˆå§‹åŒ–æ—¶é—´        â”‚ < 50ms      â”‚ TraceTimeæ—¥å¿—      â”‚
â”‚ VMæ“ä½œé˜Ÿåˆ—é•¿åº¦          â”‚ < 10        â”‚ JFRäº‹ä»¶            â”‚
â”‚ VMæ“ä½œå¹³å‡æ‰§è¡Œæ—¶é—´      â”‚ < 1ms       â”‚ PerfCounter        â”‚
â”‚ å®‰å…¨ç‚¹å¹³å‡æ—¶é—´          â”‚ < 5ms       â”‚ -XX:+TraceSafepointâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2.2 ç›‘æ§è„šæœ¬ç¤ºä¾‹**

```bash
#!/bin/bash
# VMåˆå§‹åŒ–ç›‘æ§è„šæœ¬

# å¯ç”¨è¯¦ç»†æ—¥å¿—
JAVA_OPTS="-XX:+UnlockDiagnosticVMOptions"
JAVA_OPTS="$JAVA_OPTS -XX:+LogVMOutput"
JAVA_OPTS="$JAVA_OPTS -XX:+TraceClassLoading"
JAVA_OPTS="$JAVA_OPTS -Xlog:startuptime:startup.log"

# å¯åŠ¨åº”ç”¨å¹¶ç›‘æ§
java $JAVA_OPTS -jar app.jar &
PID=$!

# ç›‘æ§VMThreadçŠ¶æ€
while kill -0 $PID 2>/dev/null; do
    jstack $PID | grep "VM Thread" -A 5
    sleep 1
done
```

---

## ğŸ“Š **æ€»ç»“ä¸æœ€ä½³å®è·µ**

### **1. å…³é”®è¦ç‚¹**

1. **VMThreadæ˜¯JVMçš„æ ¸å¿ƒ**ï¼šè´Ÿè´£æ‰€æœ‰å®‰å…¨ç‚¹æ“ä½œï¼Œåˆ›å»ºå¤±è´¥ä¼šå¯¼è‡´VMæ— æ³•å¯åŠ¨
2. **Javaç±»åˆå§‹åŒ–é¡ºåºå¾ˆé‡è¦**ï¼šString â†’ System â†’ Class â†’ Threadçš„é¡ºåºä¸èƒ½æ”¹å˜
3. **JVMTIé˜¶æ®µç®¡ç†**ï¼šç¡®ä¿å·¥å…·å’Œä»£ç†èƒ½å¤Ÿæ­£ç¡®è·Ÿè¸ªVMç”Ÿå‘½å‘¨æœŸ
4. **æ€§èƒ½å½±å“æ˜¾è‘—**ï¼šè¿™ä¸ªé˜¶æ®µçš„ä¼˜åŒ–å¯¹å¯åŠ¨æ—¶é—´æœ‰é‡è¦å½±å“

### **2. æœ€ä½³å®è·µ**

#### **2.1 ç”Ÿäº§ç¯å¢ƒé…ç½®**

```bash
# æ¨èçš„ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°
-XX:+UseSharedSpaces              # å¯ç”¨CDS
-XX:+CompactStrings               # ä¼˜åŒ–Stringå†…å­˜
-XX:VMThreadStackSize=512k        # ä¼˜åŒ–VMThreadæ ˆ
-XX:+UnlockDiagnosticVMOptions    # å¯ç”¨è¯Šæ–­é€‰é¡¹
-XX:+LogVMOutput                  # è®°å½•VMè¾“å‡º
```

#### **2.2 å¼€å‘ç¯å¢ƒè°ƒè¯•**

```bash
# å¼€å‘ç¯å¢ƒçš„è¯¦ç»†æ—¥å¿—é…ç½®
-XX:+TraceClassLoading
-XX:+TraceClassInitialization  
-Xlog:startuptime,thread:vm_init.log
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
```

### **3. æ€§èƒ½åŸºå‡†**

åœ¨8GBå †ã€Linuxç¯å¢ƒä¸‹çš„å…¸å‹æ€§èƒ½æŒ‡æ ‡ï¼š

```
æ€§èƒ½åŸºå‡† (OpenJDK 11, 8GBå †, Linux):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ æ— ä¼˜åŒ–      â”‚ ä¼˜åŒ–å      â”‚ æ”¹å–„   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VMThreadåˆ›å»ºæ—¶é—´        â”‚ 5.0ms       â”‚ 3.2ms       â”‚ 36%    â”‚
â”‚ Javaç±»åˆå§‹åŒ–æ—¶é—´        â”‚ 34.0ms      â”‚ 8.5ms       â”‚ 75%    â”‚
â”‚ æ€»å†…å­˜å ç”¨              â”‚ 1.99MB      â”‚ 1.32MB      â”‚ 34%    â”‚
â”‚ å¯åŠ¨æ—¶é—´æ”¹å–„            â”‚ åŸºå‡†        â”‚ -25.5ms     â”‚ æ˜¾è‘—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™ä¸ªé˜¶æ®µçš„ä¼˜åŒ–ä¸ºåç»­çš„ç¼–è¯‘å™¨åˆå§‹åŒ–å’Œæ¨¡å—ç³»ç»Ÿå¯åŠ¨å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚VMThreadçš„ç¨³å®šè¿è¡Œå’ŒJavaæ ¸å¿ƒç±»çš„æ­£ç¡®åˆå§‹åŒ–æ˜¯æ•´ä¸ªJVMç”Ÿæ€ç³»ç»Ÿæ­£å¸¸å·¥ä½œçš„å‰ææ¡ä»¶ã€‚

---

*æœ¬æ–‡æ¡£åŸºäºOpenJDK 11æºç åˆ†æï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½è°ƒä¼˜å’Œæ•…éšœæ’æŸ¥ã€‚*