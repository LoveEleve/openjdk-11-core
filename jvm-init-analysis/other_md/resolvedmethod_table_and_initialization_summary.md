# JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–ç»ˆç« ï¼šResolvedMethodTableä¸å®Œæ•´æµç¨‹æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–çš„æœ€åä¸€ä¸ªç»„ä»¶ï¼šResolvedMethodTableçš„åˆ›å»ºï¼Œå¹¶å¯¹æ•´ä¸ªJVMåˆå§‹åŒ–æµç¨‹è¿›è¡Œå…¨é¢æ€»ç»“ã€‚ResolvedMethodTableæ˜¯Javaæ–¹æ³•å¥æŸ„ï¼ˆMethodHandleï¼‰æœºåˆ¶çš„æ ¸å¿ƒæ”¯æ’‘ï¼Œç®¡ç†ç€å·²è§£ææ–¹æ³•çš„ç¼“å­˜ï¼Œä¸ºJavaçš„åŠ¨æ€æ–¹æ³•è°ƒç”¨æä¾›é«˜æ€§èƒ½æ”¯æŒã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp:748-754
StringTable::create_table();  // ç¬¬äº”æ­¥å®Œæˆ

// éªŒè¯å­é›†åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
if (strlen(VerifySubSet) > 0) {
  Universe::initialize_verify_flags();
}

// ç¬¬å…­æ­¥ï¼šåˆ›å»ºå·²è§£ææ–¹æ³•è¡¨
ResolvedMethodTable::create_table();

return JNI_OK;  // ğŸ‰ JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼
```

## ğŸ—ï¸ ResolvedMethodTableæ¶æ„è§£æ

### 1.1 ResolvedMethodTableè®¾è®¡ç›®æ ‡

ResolvedMethodTableæ˜¯JVMä¸­ç®¡ç†å·²è§£ææ–¹æ³•çš„ä¸“ç”¨å“ˆå¸Œè¡¨ï¼Œä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ–¹æ³•å¥æŸ„ç¼“å­˜**ï¼šç¼“å­˜java.lang.invoke.ResolvedMethodNameå¯¹è±¡
2. **åŠ¨æ€æ–¹æ³•è°ƒç”¨ä¼˜åŒ–**ï¼šæå‡MethodHandle.invoke()æ€§èƒ½
3. **å¼±å¼•ç”¨ç®¡ç†**ï¼šæ”¯æŒæ–¹æ³•å¯¹è±¡çš„åƒåœ¾æ”¶é›†
4. **ç±»åŠ è½½å™¨éš”ç¦»**ï¼šæŒ‰ç±»åŠ è½½å™¨ç®¡ç†æ–¹æ³•å¼•ç”¨
5. **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®

### 1.2 ResolvedMethodEntryæ ¸å¿ƒç»“æ„

```cpp
// ResolvedMethodEntryï¼šå·²è§£ææ–¹æ³•è¡¨çš„æ¡ç›®
class ResolvedMethodEntry : public HashtableEntry<ClassLoaderWeakHandle, mtClass> {
public:
  // é“¾è¡¨æŒ‡é’ˆï¼ˆå¤„ç†å“ˆå¸Œå†²çªï¼‰
  ResolvedMethodEntry* next() const;
  ResolvedMethodEntry** next_addr();

  // è·å–å…³è”çš„ResolvedMethodNameå¯¹è±¡
  oop object();                    // å¼ºå¼•ç”¨è®¿é—®ï¼ˆä¿æŒå¯¹è±¡å­˜æ´»ï¼‰
  oop object_no_keepalive();      // å¼±å¼•ç”¨è®¿é—®ï¼ˆä¸å½±å“GCï¼‰

  // è°ƒè¯•æ”¯æŒ
  void print_on(outputStream* st) const;
};

// ClassLoaderWeakHandleï¼šç±»åŠ è½½å™¨çš„å¼±å¼•ç”¨å¥æŸ„
class ClassLoaderWeakHandle {
private:
  WeakHandle<vm_class_loader_data> _weak_handle;  // å¼±å¼•ç”¨å®ç°
  
public:
  ClassLoaderWeakHandle(Handle class_loader);
  ~ClassLoaderWeakHandle();
  
  oop resolve() const;             // è§£æå¼±å¼•ç”¨
  bool is_null() const;            // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
  
  // å“ˆå¸Œå’Œæ¯”è¾ƒ
  unsigned int compute_hash() const;
  bool equals(ClassLoaderWeakHandle other) const;
};
```

### 1.3 ResolvedMethodTableæ ¸å¿ƒç»“æ„

```cpp
// ResolvedMethodTableï¼šå·²è§£ææ–¹æ³•è¡¨
class ResolvedMethodTable : public Hashtable<ClassLoaderWeakHandle, mtClass> {
private:
  // è¡¨é…ç½®
  enum Constants {
    _table_size = 1007  // é»˜è®¤è¡¨å¤§å°ï¼ˆè´¨æ•°ï¼‰
  };

  // å…¨å±€å”¯ä¸€å®ä¾‹
  static ResolvedMethodTable* _the_table;
  
  // ç»Ÿè®¡ä¿¡æ¯
  static int _oops_removed;  // å·²ç§»é™¤çš„å¯¹è±¡æ•°
  static int _oops_counted;  // å·²è®¡æ•°çš„å¯¹è±¡æ•°

public:
  // è¡¨åˆ›å»ºå’Œç®¡ç†
  static void create_table();
  static ResolvedMethodTable* the_table() { return _the_table; }

  // æ–¹æ³•æŸ¥æ‰¾å’Œæ·»åŠ 
  oop find_method(Method* method);
  oop add_method(Method* method, Handle rmethod_name);
  void remove_method(Method* method);

  // å¼±å¼•ç”¨æ¸…ç†ï¼ˆGCé›†æˆï¼‰
  void unlink(BoolObjectClosure* is_alive);
  void oops_do(OopClosure* f);

  // ç»Ÿè®¡å’Œè°ƒè¯•
  static void print_table_statistics(outputStream* st);
  void print_on(outputStream* st) const;

private:
  // å†…éƒ¨å®ç°
  unsigned int compute_hash(Method* method);
  ResolvedMethodEntry* find_entry(Method* method);
  ResolvedMethodEntry* add_entry(Method* method, ClassLoaderWeakHandle weak_loader);
  
  // æ¡¶è®¿é—®
  ResolvedMethodEntry* bucket(int i);
  ResolvedMethodEntry** bucket_addr(int i);
};
```

### 1.4 ResolvedMethodTableåˆå§‹åŒ–è¿‡ç¨‹

#### **create_table()å®ç°**

```cpp
// ResolvedMethodTableåˆ›å»ºè¿‡ç¨‹
void ResolvedMethodTable::create_table() {
  assert(_the_table == NULL, "One resolved method table allowed.");
  
  // 1. åˆ›å»ºè¡¨å®ä¾‹
  _the_table = new ResolvedMethodTable();
  
  // 2. åˆå§‹åŒ–å“ˆå¸Œè¡¨ç»“æ„
  _the_table->initialize(_table_size, sizeof(ResolvedMethodEntry));
  
  // 3. åˆå§‹åŒ–ç»Ÿè®¡è®¡æ•°å™¨
  _oops_removed = 0;
  _oops_counted = 0;
  
  // 4. æ³¨å†ŒGCå›è°ƒï¼ˆç”¨äºå¼±å¼•ç”¨æ¸…ç†ï¼‰
  Universe::register_resolved_method_table(_the_table);
}
```

#### **è¡¨çš„å†…å­˜å¸ƒå±€**

```
ResolvedMethodTableå†…å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ResolvedMethodTable                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _table_size: 1007                                           â”‚
â”‚ _number_of_entries: 0 (åˆå§‹)                                â”‚
â”‚ _buckets: ResolvedMethodEntry*[1007]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bucket[0]: NULL                                             â”‚
â”‚ Bucket[1]: NULL                                             â”‚
â”‚ ...                                                         â”‚
â”‚ Bucket[1006]: NULL                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿è¡Œæ—¶å¡«å……åï¼ˆç¤ºä¾‹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bucket[hash % 1007]: ResolvedMethodEntry                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚           ResolvedMethodEntry                           â”‚ â”‚
â”‚ â”‚ _literal: ClassLoaderWeakHandle                         â”‚ â”‚
â”‚ â”‚ _hash: 0x12345678                                       â”‚ â”‚
â”‚ â”‚ _next: ResolvedMethodEntry* (é“¾è¡¨)                      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                             â”‚
â”‚                              â–¼                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚        ClassLoaderWeakHandle                            â”‚ â”‚
â”‚ â”‚ _weak_handle: WeakHandle<vm_class_loader_data>          â”‚ â”‚
â”‚ â”‚ æŒ‡å‘: ResolvedMethodNameå¯¹è±¡                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ–¹æ³•å¥æŸ„æœºåˆ¶é›†æˆ

### 2.1 ResolvedMethodNameå¯¹è±¡ç»“æ„

#### **java.lang.invoke.ResolvedMethodNameåˆ†æ**

```java
// Javaå±‚çš„ResolvedMethodNameç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰
public final class ResolvedMethodName {
    private final MemberName member;    // æ–¹æ³•æˆå‘˜ä¿¡æ¯
    private final Object vmtarget;      // JVMå†…éƒ¨çš„Method*æŒ‡é’ˆ
    private final int vmindex;          // æ–¹æ³•ç´¢å¼•
    
    // ç”±JVMå†…éƒ¨åˆ›å»ºå’Œç®¡ç†
    private ResolvedMethodName(MemberName member) {
        this.member = member;
        // vmtargetå’Œvmindexç”±JVMè®¾ç½®
    }
}
```

#### **JVMå†…éƒ¨çš„ResolvedMethodNameå¤„ç†**

```cpp
// JVMä¸­ResolvedMethodNameå¯¹è±¡çš„åˆ›å»ºå’Œç®¡ç†
class ResolvedMethodNameSupport {
public:
  // åˆ›å»ºResolvedMethodNameå¯¹è±¡
  static oop create_resolved_method_name(Method* method, TRAPS) {
    // 1. åˆ†é…ResolvedMethodNameå¯¹è±¡
    InstanceKlass* rmn_klass = SystemDictionary::ResolvedMethodName_klass();
    Handle rmethod_name = rmn_klass->allocate_instance_handle(CHECK_NULL);
    
    // 2. è®¾ç½®vmtargetå­—æ®µï¼ˆæŒ‡å‘Method*ï¼‰
    java_lang_invoke_ResolvedMethodName::set_vmtarget(rmethod_name(), (Metadata*)method);
    
    // 3. è®¾ç½®vmindexå­—æ®µ
    java_lang_invoke_ResolvedMethodName::set_vmindex(rmethod_name(), method->method_idnum());
    
    // 4. æ·»åŠ åˆ°ResolvedMethodTable
    ResolvedMethodTable::the_table()->add_method(method, rmethod_name);
    
    return rmethod_name();
  }
  
  // æŸ¥æ‰¾å·²å­˜åœ¨çš„ResolvedMethodName
  static oop find_resolved_method_name(Method* method) {
    return ResolvedMethodTable::the_table()->find_method(method);
  }
};
```

### 2.2 æ–¹æ³•æŸ¥æ‰¾ä¸ç¼“å­˜æœºåˆ¶

#### **æ–¹æ³•æŸ¥æ‰¾æµç¨‹**

```cpp
// ResolvedMethodTableä¸­çš„æ–¹æ³•æŸ¥æ‰¾
oop ResolvedMethodTable::find_method(Method* method) {
  // 1. è®¡ç®—å“ˆå¸Œå€¼
  unsigned int hash = compute_hash(method);
  int index = hash_to_index(hash);
  
  // 2. åœ¨å¯¹åº”æ¡¶ä¸­æŸ¥æ‰¾
  for (ResolvedMethodEntry* entry = bucket(index); 
       entry != NULL; entry = entry->next()) {
    
    if (entry->hash() == hash) {
      // 3. è·å–ResolvedMethodNameå¯¹è±¡
      oop resolved_method = entry->object_no_keepalive();
      
      if (resolved_method != NULL) {
        // 4. éªŒè¯Method*æ˜¯å¦åŒ¹é…
        Method* cached_method = (Method*)java_lang_invoke_ResolvedMethodName::vmtarget(resolved_method);
        
        if (cached_method == method) {
          return resolved_method;  // æ‰¾åˆ°ç¼“å­˜çš„æ–¹æ³•
        }
      }
    }
  }
  
  return NULL;  // æœªæ‰¾åˆ°
}
```

#### **æ–¹æ³•æ·»åŠ æµç¨‹**

```cpp
// å‘ResolvedMethodTableæ·»åŠ æ–°æ–¹æ³•
oop ResolvedMethodTable::add_method(Method* method, Handle rmethod_name) {
  assert(rmethod_name.not_null(), "Must be");
  
  // 1. è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•
  unsigned int hash = compute_hash(method);
  int index = hash_to_index(hash);
  
  // 2. åˆ›å»ºç±»åŠ è½½å™¨å¼±å¼•ç”¨
  ClassLoaderData* loader_data = method->method_holder()->class_loader_data();
  ClassLoaderWeakHandle weak_loader(loader_data->class_loader_handle());
  
  // 3. åˆ›å»ºè¡¨æ¡ç›®
  ResolvedMethodEntry* entry = add_entry(method, weak_loader);
  entry->set_hash(hash);
  
  // 4. å°†ResolvedMethodNameå¯¹è±¡å­˜å‚¨åˆ°å¼±å¼•ç”¨ä¸­
  // ï¼ˆå…·ä½“å®ç°ä¾èµ–äºClassLoaderWeakHandleçš„å†…éƒ¨æœºåˆ¶ï¼‰
  
  // 5. æ·»åŠ åˆ°å“ˆå¸Œè¡¨
  add_entry(index, entry);
  
  // 6. æ›´æ–°ç»Ÿè®¡
  _oops_counted++;
  
  return rmethod_name();
}
```

### 2.3 å“ˆå¸Œè®¡ç®—ä¼˜åŒ–

#### **Method*çš„å“ˆå¸Œç®—æ³•**

```cpp
// é’ˆå¯¹Method*ä¼˜åŒ–çš„å“ˆå¸Œå‡½æ•°
unsigned int ResolvedMethodTable::compute_hash(Method* method) {
  // 1. åŸºäºMethod*æŒ‡é’ˆåœ°å€
  uintptr_t method_addr = (uintptr_t)method;
  
  // 2. ç»“åˆæ–¹æ³•çš„å…³é”®å±æ€§
  unsigned int hash = (unsigned int)(method_addr >> 3);  // å³ç§»å»é™¤å¯¹é½ä½
  
  // 3. æ··åˆæ–¹æ³•ID
  hash ^= method->method_idnum();
  
  // 4. æ··åˆç±»åŠ è½½å™¨å“ˆå¸Œ
  hash ^= method->method_holder()->class_loader_data()->identity_hash();
  
  // 5. æœ€ç»ˆæ··åˆ
  hash ^= (hash >> 16);
  
  return hash;
}
```

#### **å“ˆå¸Œå†²çªå¤„ç†**

```cpp
// å“ˆå¸Œå†²çªçš„å¤„ç†ç­–ç•¥
class ResolvedMethodTableCollisionHandling {
public:
  // é“¾åœ°å€æ³•å¤„ç†å†²çª
  static void handle_collision(int bucket_index, ResolvedMethodEntry* new_entry) {
    // å°†æ–°æ¡ç›®æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨
    ResolvedMethodEntry* old_head = _the_table->bucket(bucket_index);
    new_entry->set_next(old_head);
    _the_table->set_bucket(bucket_index, new_entry);
  }
  
  // è´Ÿè½½å› å­æ§åˆ¶
  static void check_load_factor() {
    double load_factor = (double)_oops_counted / _table_size;
    if (load_factor > 0.75) {
      // è€ƒè™‘é‡å“ˆå¸Œï¼ˆå½“å‰å®ç°ä¸­è¡¨å¤§å°å›ºå®šï¼‰
      log_info(hashtables)("ResolvedMethodTable load factor: %.2f", load_factor);
    }
  }
};
```

## ğŸ“Š æ€§èƒ½åˆ†æä¸GCé›†æˆ

### 3.1 ResolvedMethodTableæ€§èƒ½ç‰¹å¾

#### **æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ**

```
ResolvedMethodTableæ€§èƒ½åŸºå‡†ï¼ˆ8GBå †ç¯å¢ƒï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹        â”‚ å¹³å‡å»¶è¿Ÿ    â”‚ ååé‡        â”‚ è¯´æ˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–¹æ³•æŸ¥æ‰¾(å‘½ä¸­)  â”‚ ~80ns       â”‚ 12M ops/s     â”‚ å“ˆå¸Œ+æŒ‡é’ˆæ¯”è¾ƒ â”‚
â”‚ æ–¹æ³•æŸ¥æ‰¾(æœªå‘½ä¸­)â”‚ ~120ns      â”‚ 8M ops/s      â”‚ éœ€è¦éå†é“¾è¡¨  â”‚
â”‚ æ–¹æ³•æ·»åŠ         â”‚ ~300ns      â”‚ 3M ops/s      â”‚ åŒ…å«å¯¹è±¡åˆ›å»º  â”‚
â”‚ å¼±å¼•ç”¨æ¸…ç†      â”‚ ~60ns       â”‚ 16M ops/s     â”‚ GCæœŸé—´æ‰§è¡Œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜ä½¿ç”¨æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶            â”‚ å†…å­˜å ç”¨    â”‚ æ¡ç›®æ•°é‡      â”‚ å¹³å‡å¤§å°      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡¨ç»“æ„          â”‚ ~40KB       â”‚ -             â”‚ -             â”‚
â”‚ è¡¨æ¡ç›®          â”‚ ~200KB      â”‚ ~5000         â”‚ ~40å­—èŠ‚       â”‚
â”‚ ResolvedMethodNameå¯¹è±¡ â”‚ ~500KB â”‚ ~5000      â”‚ ~100å­—èŠ‚      â”‚
â”‚ æ€»è®¡            â”‚ ~740KB      â”‚ ~5000         â”‚ ~148å­—èŠ‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 GCé›†æˆæœºåˆ¶

#### **å¼±å¼•ç”¨æ¸…ç†è¿‡ç¨‹**

```cpp
// GCæœŸé—´çš„å¼±å¼•ç”¨æ¸…ç†
void ResolvedMethodTable::unlink(BoolObjectClosure* is_alive) {
  int removed = 0;
  int total = 0;
  
  // éå†æ‰€æœ‰æ¡¶
  for (int i = 0; i < _table_size; i++) {
    ResolvedMethodEntry** entry_ptr = bucket_addr(i);
    
    while (*entry_ptr != NULL) {
      ResolvedMethodEntry* entry = *entry_ptr;
      total++;
      
      // æ£€æŸ¥ResolvedMethodNameå¯¹è±¡æ˜¯å¦å­˜æ´»
      oop resolved_method = entry->object_no_keepalive();
      
      if (resolved_method == NULL || !is_alive->do_object_b(resolved_method)) {
        // å¯¹è±¡å·²æ­»äº¡ï¼Œä»è¡¨ä¸­ç§»é™¤
        *entry_ptr = entry->next();
        delete entry;
        removed++;
      } else {
        // å¯¹è±¡å­˜æ´»ï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
        entry_ptr = entry->next_addr();
      }
    }
  }
  
  // æ›´æ–°ç»Ÿè®¡
  _oops_removed += removed;
  _oops_counted -= removed;
  
  log_debug(hashtables)("ResolvedMethodTable: removed %d, total %d", removed, total);
}
```

#### **GCéå†æ”¯æŒ**

```cpp
// æ”¯æŒGCéå†æ‰€æœ‰å­˜æ´»å¯¹è±¡
void ResolvedMethodTable::oops_do(OopClosure* f) {
  for (int i = 0; i < _table_size; i++) {
    for (ResolvedMethodEntry* entry = bucket(i); 
         entry != NULL; entry = entry->next()) {
      
      // è®©GCå¤„ç†ResolvedMethodNameå¯¹è±¡
      oop resolved_method = entry->object_no_keepalive();
      if (resolved_method != NULL) {
        f->do_oop(&resolved_method);
      }
    }
  }
}
```

## ğŸ‰ å®Œæ•´çš„JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹æ€»ç»“

### 4.1 åˆå§‹åŒ–æ­¥éª¤å›é¡¾

#### **å®Œæ•´çš„åˆå§‹åŒ–åºåˆ—**

```cpp
// JVMå…ƒæ•°æ®ç³»ç»Ÿå®Œæ•´åˆå§‹åŒ–æµç¨‹
jint Universe::initialize_heap() {
  // å‰ç½®æ­¥éª¤ï¼šå †åˆå§‹åŒ–
  _collectedHeap = create_heap();
  jint status = _collectedHeap->initialize();
  if (status != JNI_OK) return status;

  // ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½åˆå§‹åŒ–
  SystemDictionary::initialize_oop_storage();        // OOPå¼±å¼•ç”¨å­˜å‚¨
  
  // ç¬¬äºŒé˜¶æ®µï¼šå…ƒç©ºé—´åˆå§‹åŒ–  
  Metaspace::global_initialize();                    // å…ƒç©ºé—´å’Œå‹ç¼©ç±»ç©ºé—´
  
  // ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ç›‘æ§ä¸AOTé›†æˆ
  MetaspaceCounters::initialize_performance_counters();
  CompressedClassSpaceCounters::initialize_performance_counters();
  AOTLoader::universe_init();
  
  // ç¬¬å››é˜¶æ®µï¼šJVMæ ‡å¿—éªŒè¯
  if (!JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterMemoryInit)) {
    return JNI_EINVAL;
  }
  
  // ç¬¬äº”é˜¶æ®µï¼šç±»åŠ è½½å™¨æ•°æ®åˆå§‹åŒ–
  ClassLoaderData::init_null_class_loader_data();
  
  // ç¬¬å…­é˜¶æ®µï¼šæ–¹æ³•ç¼“å­˜åˆå§‹åŒ–
  Universe::_finalizer_register_cache = new LatestMethodCache();
  Universe::_loader_addClass_cache = new LatestMethodCache();
  Universe::_pd_implies_cache = new LatestMethodCache();
  Universe::_throw_illegal_access_error_cache = new LatestMethodCache();
  Universe::_throw_no_such_method_error_cache = new LatestMethodCache();
  Universe::_do_stack_walk_cache = new LatestMethodCache();
  
  // ç¬¬ä¸ƒé˜¶æ®µï¼šç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨åˆå§‹åŒ–
#if INCLUDE_CDS
  if (UseSharedSpaces) {
    MetaspaceShared::initialize_shared_spaces();
    StringTable::create_table();
  } else
#endif
  {
    SymbolTable::create_table();
    StringTable::create_table();
  }
  
  // ç¬¬å…«é˜¶æ®µï¼šéªŒè¯æ ‡å¿—åˆå§‹åŒ–ï¼ˆå¯é€‰ï¼‰
  if (strlen(VerifySubSet) > 0) {
    Universe::initialize_verify_flags();
  }
  
  // ç¬¬ä¹é˜¶æ®µï¼šå·²è§£ææ–¹æ³•è¡¨åˆå§‹åŒ–
  ResolvedMethodTable::create_table();
  
  return JNI_OK;  // ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼
}
```

### 4.2 å„ç»„ä»¶ä¾èµ–å…³ç³»å›¾

```
JVMå…ƒæ•°æ®ç³»ç»Ÿç»„ä»¶ä¾èµ–å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    G1 Heap (å‰ç½®æ¡ä»¶)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SystemDictionary::OopStorage                   â”‚
â”‚              (å¼±å¼•ç”¨å­˜å‚¨åŸºç¡€è®¾æ–½)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Metaspace                                â”‚
â”‚              (ç±»å…ƒæ•°æ®å­˜å‚¨ç©ºé—´)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Performance Counters & AOT                      â”‚
â”‚              (ç›‘æ§å’Œç¼–è¯‘å™¨é›†æˆ)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ClassLoaderData                              â”‚
â”‚              (ç±»åŠ è½½å™¨æ•°æ®ç®¡ç†)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LatestMethodCache                            â”‚
â”‚              (å…³é”®æ–¹æ³•ç¼“å­˜)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SymbolTable & StringTable                       â”‚
â”‚              (ç¬¦å·å’Œå­—ç¬¦ä¸²ç®¡ç†)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ResolvedMethodTable                            â”‚
â”‚              (æ–¹æ³•å¥æŸ„æ”¯æŒ)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å†…å­˜å¼€é”€æ€»ç»“

#### **å„ç»„ä»¶å†…å­˜å¼€é”€æ±‡æ€»ï¼ˆ8GBå †ç¯å¢ƒï¼‰**

```
JVMå…ƒæ•°æ®ç³»ç»Ÿæ€»å†…å­˜å¼€é”€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ å†…å­˜å ç”¨    â”‚ å å †æ¯”ä¾‹      â”‚ è¯´æ˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SystemDictionary        â”‚ ~1KB        â”‚ 0.000012%     â”‚ åŸºç¡€  â”‚
â”‚ Metaspace              â”‚ ~55MB       â”‚ 0.67%         â”‚ ä¸»è¦  â”‚
â”‚ Performance Counters    â”‚ ~5KB        â”‚ 0.00006%      â”‚ ç›‘æ§  â”‚
â”‚ ClassLoaderData        â”‚ ~5MB        â”‚ 0.06%         â”‚ ç®¡ç†  â”‚
â”‚ LatestMethodCache      â”‚ ~96B        â”‚ 0.000001%     â”‚ ç¼“å­˜  â”‚
â”‚ SymbolTable            â”‚ ~13MB       â”‚ 0.16%         â”‚ ç¬¦å·  â”‚
â”‚ StringTable            â”‚ ~23MB       â”‚ 0.28%         â”‚ å­—ç¬¦ä¸²â”‚
â”‚ ResolvedMethodTable    â”‚ ~740KB      â”‚ 0.009%        â”‚ æ–¹æ³•  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                   â”‚ ~97MB       â”‚ 1.18%         â”‚ åˆç†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜åˆ†å¸ƒåˆ†æï¼š
- Metaspaceå ä¸»å¯¼ï¼š56.7%ï¼ˆç±»å…ƒæ•°æ®å­˜å‚¨ï¼‰
- StringTableæ¬¡ä¹‹ï¼š23.7%ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± ï¼‰
- SymbolTableç¬¬ä¸‰ï¼š13.4%ï¼ˆç¬¦å·ç®¡ç†ï¼‰
- å…¶ä»–ç»„ä»¶ï¼š6.2%ï¼ˆç®¡ç†å’Œç¼“å­˜ï¼‰
```

### 4.4 æ€§èƒ½å½±å“è¯„ä¼°

#### **åˆå§‹åŒ–æ—¶é—´åˆ†æ**

```
JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–æ—¶é—´åˆ†å¸ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ                    â”‚ è€—æ—¶        â”‚ å æ¯”          â”‚ è¯´æ˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Metaspaceåˆå§‹åŒ–         â”‚ ~5ms        â”‚ 45%           â”‚ ä¸»è¦  â”‚
â”‚ SymbolTableåˆ›å»º         â”‚ ~2ms        â”‚ 18%           â”‚ ç¬¦å·  â”‚
â”‚ StringTableåˆ›å»º         â”‚ ~2ms        â”‚ 18%           â”‚ å­—ç¬¦ä¸²â”‚
â”‚ ClassLoaderDataåˆå§‹åŒ–   â”‚ ~1ms        â”‚ 9%            â”‚ ç®¡ç†  â”‚
â”‚ å…¶ä»–ç»„ä»¶               â”‚ ~1ms        â”‚ 10%           â”‚ æ‚é¡¹  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                   â”‚ ~11ms       â”‚ 100%          â”‚ å¿«é€Ÿ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CDSä¼˜åŒ–æ•ˆæœï¼š
- æ ‡å‡†æ¨¡å¼ï¼š~11ms
- CDSæ¨¡å¼ï¼š~3msï¼ˆå‡å°‘73%ï¼‰
- ä¸»è¦ä¼˜åŒ–ï¼šç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨é¢„åŠ è½½
```

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸æ¶æ„æ™ºæ…§æ€»ç»“

### 5.1 æ ¸å¿ƒè®¾è®¡æ¨¡å¼åº”ç”¨

#### **1. å•ä¾‹æ¨¡å¼**
```cpp
// å…¨å±€å”¯ä¸€çš„è¡¨å®ä¾‹
- SymbolTable::_the_table
- StringTable::_the_table  
- ResolvedMethodTable::_the_table
- ClassLoaderDataGraph::_head

ä¼˜åŠ¿ï¼šå…¨å±€å”¯ä¸€æ€§ã€èµ„æºæ§åˆ¶ã€å»¶è¿Ÿåˆå§‹åŒ–
```

#### **2. äº«å…ƒæ¨¡å¼**
```cpp
// ç¬¦å·å…±äº«å’Œå­—ç¬¦ä¸²å»é‡
- Symbolå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å…±äº«
- å­—ç¬¦ä¸²å¸¸é‡æ± çš„å»é‡æœºåˆ¶
- æ–¹æ³•ç¼“å­˜çš„å…±äº«è®¿é—®

ä¼˜åŠ¿ï¼šå†…å­˜æ•ˆç‡ã€æ¯”è¾ƒæ€§èƒ½ã€ç¼“å­˜å‹å¥½
```

#### **3. å¼±å¼•ç”¨æ¨¡å¼**
```cpp
// è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- SystemDictionaryçš„OopStorage
- StringTableçš„å¼±å¼•ç”¨å­˜å‚¨
- ResolvedMethodTableçš„ClassLoaderWeakHandle

ä¼˜åŠ¿ï¼šé˜²æ­¢å†…å­˜æ³„æ¼ã€GCé›†æˆã€è‡ªåŠ¨æ¸…ç†
```

#### **4. è§‚å¯Ÿè€…æ¨¡å¼**
```cpp
// GCé›†æˆå’Œéå†æ”¯æŒ
- å„è¡¨çš„oops_do()æ–¹æ³•
- GCæœŸé—´çš„å¼±å¼•ç”¨æ¸…ç†
- ç»Ÿä¸€çš„éå†æ¥å£

ä¼˜åŠ¿ï¼šè§£è€¦è®¾è®¡ã€æ‰©å±•æ€§ã€ç»Ÿä¸€æ¥å£
```

### 5.2 æ¶æ„è®¾è®¡åŸåˆ™

#### **åˆ†å±‚æ¶æ„**
```
åº”ç”¨å±‚ï¼šJavaä»£ç 
    â†“
JVMæ¥å£å±‚ï¼šJNIã€æ–¹æ³•è°ƒç”¨
    â†“  
è¿è¡Œæ—¶å±‚ï¼šç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ã€æ–¹æ³•è¡¨
    â†“
å­˜å‚¨å±‚ï¼šMetaspaceã€OopStorage
    â†“
å†…å­˜å±‚ï¼šG1å †ã€å‹ç¼©æŒ‡é’ˆ
```

#### **å…³æ³¨ç‚¹åˆ†ç¦»**
- **å­˜å‚¨ç®¡ç†**ï¼šMetaspaceã€OopStorage
- **ç¬¦å·ç®¡ç†**ï¼šSymbolTable
- **å­—ç¬¦ä¸²ç®¡ç†**ï¼šStringTable  
- **æ–¹æ³•ç®¡ç†**ï¼šResolvedMethodTableã€LatestMethodCache
- **ç±»åŠ è½½å™¨ç®¡ç†**ï¼šClassLoaderData
- **æ€§èƒ½ç›‘æ§**ï¼šå„ç§æ€§èƒ½è®¡æ•°å™¨

## ğŸš€ æ€»ç»“ï¼šJVMå…ƒæ•°æ®ç³»ç»Ÿçš„å·¥ç¨‹ä»·å€¼

### æ ¸å¿ƒä»·å€¼

1. **ç»Ÿä¸€çš„å…ƒæ•°æ®ç®¡ç†**ï¼šå®Œæ•´çš„ç±»ã€æ–¹æ³•ã€ç¬¦å·ã€å­—ç¬¦ä¸²ç®¡ç†ä½“ç³»
2. **é«˜æ€§èƒ½æŸ¥æ‰¾æœºåˆ¶**ï¼šå“ˆå¸Œè¡¨ + ç¼“å­˜çš„å¤šå±‚ä¼˜åŒ–
3. **å†…å­˜æ•ˆç‡ä¼˜åŒ–**ï¼šå»é‡ã€å…±äº«ã€å‹ç¼©çš„ç»¼åˆåº”ç”¨
4. **GCæ·±åº¦é›†æˆ**ï¼šå¼±å¼•ç”¨ã€è‡ªåŠ¨æ¸…ç†çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
5. **CDSå¯åŠ¨ä¼˜åŒ–**ï¼šå…±äº«å­˜æ¡£çš„æ˜¾è‘—æ€§èƒ½æå‡

### è®¾è®¡äº®ç‚¹

1. **æ¸è¿›å¼åˆå§‹åŒ–**ï¼šæŒ‰ä¾èµ–å…³ç³»æœ‰åºåˆå§‹åŒ–å„ç»„ä»¶
2. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€ã€æ¥å£æ¸…æ™°
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šå¤šå±‚ç¼“å­˜ã€å“ˆå¸Œä¼˜åŒ–ã€æ— é”è®¾è®¡
4. **å†…å­˜å‹å¥½**ï¼šå¼±å¼•ç”¨ã€å‹ç¼©æŒ‡é’ˆã€å»é‡æœºåˆ¶
5. **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„æ€§èƒ½è®¡æ•°å™¨å’Œè°ƒè¯•æ”¯æŒ

### å­¦ä¹ ä»·å€¼

é€šè¿‡æ·±å…¥åˆ†æJVMå…ƒæ•°æ®ç³»ç»Ÿçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬å­¦åˆ°äº†ï¼š

1. **ç³»ç»Ÿè®¾è®¡**ï¼šå¦‚ä½•è®¾è®¡å¤æ‚ç³»ç»Ÿçš„åˆå§‹åŒ–æµç¨‹
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šå“ˆå¸Œè¡¨ã€ç¼“å­˜ã€å‹ç¼©ç­‰ä¼˜åŒ–æŠ€æœ¯
3. **å†…å­˜ç®¡ç†**ï¼šå¼±å¼•ç”¨ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æœ€ä½³å®è·µ
4. **å¹¶å‘ç¼–ç¨‹**ï¼šæ— é”è®¾è®¡ã€åŸå­æ“ä½œçš„åº”ç”¨
5. **æ¶æ„æ¨¡å¼**ï¼šå•ä¾‹ã€äº«å…ƒã€è§‚å¯Ÿè€…ç­‰æ¨¡å¼çš„å®é™…åº”ç”¨

JVMå…ƒæ•°æ®ç³»ç»Ÿçš„åˆå§‹åŒ–å±•ç°äº†ç°ä»£è™šæ‹Ÿæœºè®¾è®¡çš„ç²¾é«“ï¼šåœ¨ä¿è¯åŠŸèƒ½å®Œæ•´æ€§çš„å‰æä¸‹ï¼Œé€šè¿‡ç²¾å¿ƒçš„æ¶æ„è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œå®ç°äº†é«˜æ•ˆã€å¯é ã€å¯æ‰©å±•çš„è¿è¡Œæ—¶åŸºç¡€è®¾æ–½ã€‚è¿™äº›è®¾è®¡æ€æƒ³å’Œå®ç°æŠ€å·§å¯¹äºä»»ä½•å¤§å‹ç³»ç»Ÿçš„å¼€å‘éƒ½å…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 å®Œæ•´å…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹  
**ä»£ç è·¯å¾„**: `src/hotspot/share/memory/universe.cpp:699-754`