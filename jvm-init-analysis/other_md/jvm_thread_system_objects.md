# JVMçº¿ç¨‹ç³»ç»Ÿå¯¹è±¡è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVMçº¿ç¨‹ç®¡ç†ç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬Threadsã€JavaThreadã€VMThreadã€ServiceThreadã€WatcherThreadå’ŒCompilerThreadç­‰ã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (é»˜è®¤)

---

## ğŸ§µ **1. Threadç±»å±‚æ¬¡ç»“æ„**

### **1.1 ç»§æ‰¿å…³ç³»**

```
Thread (åŸºç±»)
    â”‚
    â”œâ”€â”€ JavaThread (Javaçº¿ç¨‹)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ CompilerThread (ç¼–è¯‘çº¿ç¨‹)
    â”‚       â”‚
    â”‚       â”œâ”€â”€ CodeCacheSweeperThread (ä»£ç ç¼“å­˜æ¸…æ‰«çº¿ç¨‹)
    â”‚       â”‚
    â”‚       â””â”€â”€ ServiceThread (æœåŠ¡çº¿ç¨‹)
    â”‚
    â””â”€â”€ NonJavaThread (éJavaçº¿ç¨‹)
            â”‚
            â”œâ”€â”€ NamedThread
            â”‚       â”‚
            â”‚       â”œâ”€â”€ VMThread (VMçº¿ç¨‹)
            â”‚       â”‚
            â”‚       â”œâ”€â”€ ConcurrentGCThread (å¹¶å‘GCçº¿ç¨‹)
            â”‚       â”‚       â”‚
            â”‚       â”‚       â”œâ”€â”€ G1ConcurrentMarkThread
            â”‚       â”‚       â”‚
            â”‚       â”‚       â””â”€â”€ G1ConcurrentRefineThread
            â”‚       â”‚
            â”‚       â””â”€â”€ WorkerThread (å·¥ä½œçº¿ç¨‹)
            â”‚               â”‚
            â”‚               â””â”€â”€ GangWorker (å¹¶è¡Œå·¥ä½œçº¿ç¨‹)
            â”‚
            â”œâ”€â”€ WatcherThread (ç›‘æ§çº¿ç¨‹)
            â”‚
            â””â”€â”€ JfrThreadSampler (JFRé‡‡æ ·çº¿ç¨‹)
```

---

## ğŸ”§ **2. ThreadåŸºç±»**

### **2.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Thread : public ThreadShadow {
  // ==================== GCæ”¯æŒ ====================
  GCThreadLocalData _gc_data;           // GCä¸“ç”¨çš„çº¿ç¨‹æœ¬åœ°æ•°æ®
  // å¤§å°: sizeof(GCThreadLocalData) å­—èŠ‚
  
  // ==================== çº¿ç¨‹åŒæ­¥ ====================
  Monitor* _SR_lock;                    // æŒ‚èµ·/æ¢å¤é”
  volatile uint32_t _suspend_flags;     // æŒ‚èµ·çŠ¶æ€æ ‡å¿—
  
  // ==================== JNIå¥æŸ„ ====================
  JNIHandleBlock* _active_handles;      // æ´»è·ƒçš„JNIå¥æŸ„å—
  
  // ==================== TLAB ====================
  ThreadLocalAllocBuffer _tlab;         // çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº
  jlong _allocated_bytes;               // ç´¯è®¡åˆ†é…çš„å­—èŠ‚æ•°
  
  // ==================== OSçº¿ç¨‹ ====================
  OSThread* _osthread;                  // å¹³å°ç‰¹å®šçš„çº¿ç¨‹ä¿¡æ¯
  
  // ==================== èµ„æºç®¡ç† ====================
  ResourceArea* _resource_area;         // çº¿ç¨‹æœ¬åœ°èµ„æºåŒº
  HandleArea* _handle_area;             // çº¿ç¨‹æœ¬åœ°å¥æŸ„åŒº
  
  // ==================== æ ˆä¿¡æ¯ ====================
  address _stack_base;                  // çº¿ç¨‹æ ˆçš„é«˜åœ°å€
  size_t _stack_size;                   // çº¿ç¨‹æ ˆå¤§å°
  
  // ==================== å®‰å…¨ç‚¹æ”¯æŒ ====================
  volatile void* _polling_page;         // è½®è¯¢é¡µ
  
  // ==================== ç›‘è§†å™¨ ====================
  ObjectMonitor* _current_pending_monitor;  // å½“å‰ç­‰å¾…çš„ç›‘è§†å™¨
  ObjectMonitor* _current_waiting_monitor;  // å½“å‰Object.waitçš„ç›‘è§†å™¨
  ObjectMonitor* omFreeList;            // ç©ºé—²ç›‘è§†å™¨é“¾è¡¨
  ObjectMonitor* omInUseList;           // ä½¿ç”¨ä¸­ç›‘è§†å™¨é“¾è¡¨
  int omFreeCount;                      // ç©ºé—²ç›‘è§†å™¨è®¡æ•°
  int omInUseCount;                     // ä½¿ç”¨ä¸­ç›‘è§†å™¨è®¡æ•°
  
  // ==================== çº¿ç¨‹æœ¬åœ°å­˜å‚¨ ====================
  static THREAD_LOCAL Thread* _thr_current;  // å½“å‰çº¿ç¨‹
};
```

### **2.2 GCThreadLocalDataè¯¦è§£**

```cpp
// GCçº¿ç¨‹æœ¬åœ°æ•°æ® (æ¯ä¸ªGCå®ç°ä¸åŒ)
// G1GCçš„å®ç°:
class G1ThreadLocalData {
  SATBMarkQueue _satb_mark_queue;       // SATBæ ‡è®°é˜Ÿåˆ—
  G1DirtyCardQueue _dirty_card_queue;   // è„å¡é˜Ÿåˆ—
};

// SATBæ ‡è®°é˜Ÿåˆ—ç”¨äºå¹¶å‘æ ‡è®°æœŸé—´è®°å½•å¼•ç”¨ä¿®æ”¹
// è„å¡é˜Ÿåˆ—ç”¨äºè®°å½•è·¨Regionå¼•ç”¨çš„å†™æ“ä½œ
```

### **2.3 çº¿ç¨‹æ ˆå¸ƒå±€**

```
çº¿ç¨‹æ ˆå†…å­˜å¸ƒå±€ (ä»ä½åœ°å€åˆ°é«˜åœ°å€):

ä½åœ°å€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ P1 â”€ stack_end()                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Red Zone (ä¸å¯è®¿é—®)                                         â”‚
â”‚  â€¢ è§¦å‘SIGSEGVï¼Œç”¨äºæ£€æµ‹æ ˆæº¢å‡º                               â”‚
â”‚  â€¢ å¤§å°: StackRedPages * page_size                          â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Yellow Zone (ä¿æŠ¤åŒº)                                        â”‚
â”‚  â€¢ è§¦å‘StackOverflowError                                   â”‚
â”‚  â€¢ å¤§å°: StackYellowPages * page_size                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Reserved Zone (ä¿ç•™åŒº)                                      â”‚
â”‚  â€¢ ç”¨äºå…³é”®ä»£ç æ‰§è¡Œ                                          â”‚
â”‚  â€¢ å¤§å°: StackReservedPages * page_size                     â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”€ stack_reserved_zone_base()                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Shadow Zone (å½±å­åŒº)                                        â”‚
â”‚  â€¢ è½¯ä»¶æ£€æµ‹ç‚¹: _stack_overflow_limit                        â”‚
â”‚  â€¢ å¤§å°: StackShadowPages * page_size                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Normal Stack (æ­£å¸¸æ ˆåŒº)                                     â”‚
â”‚  â€¢ æ–¹æ³•è°ƒç”¨æ ˆå¸§                                              â”‚
â”‚  â€¢ å±€éƒ¨å˜é‡                                                  â”‚
â”‚  â€¢ æ“ä½œæ•°æ ˆ                                                  â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ P2 â”€ stack_base()                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é«˜åœ°å€

// é»˜è®¤æ ˆå¤§å°é…ç½® (Linux x86_64):
// -Xss1m (1MB)
// StackRedPages = 1
// StackYellowPages = 2
// StackReservedPages = 1
// StackShadowPages = 20
```

---

## â˜• **3. JavaThread - Javaçº¿ç¨‹**

### **3.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class JavaThread : public Thread {
  // ==================== é“¾è¡¨é“¾æ¥ ====================
  JavaThread* _next;                    // Threadsé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª
  
  // ==================== Javaå¯¹è±¡å…³è” ====================
  oop _threadObj;                       // java.lang.Threadå¯¹è±¡
  
  // ==================== æ ˆå¸§é”šç‚¹ ====================
  JavaFrameAnchor _anchor;              // å½“å‰Javaå¸§çš„é”šç‚¹
  // ç”¨äºæ ˆéå†ï¼ŒåŒ…å«:
  // - _last_Java_sp: æœ€åJavaæ ˆæŒ‡é’ˆ
  // - _last_Java_pc: æœ€åJavaç¨‹åºè®¡æ•°å™¨
  // - _last_Java_fp: æœ€åJavaå¸§æŒ‡é’ˆ (x86)
  
  // ==================== JNIç¯å¢ƒ ====================
  JNIEnv _jni_environment;              // JNIç¯å¢ƒ
  
  // ==================== çº¿ç¨‹çŠ¶æ€ ====================
  volatile JavaThreadState _thread_state;  // çº¿ç¨‹çŠ¶æ€
  // çŠ¶æ€å€¼:
  // _thread_uninitialized  = 0,  // æœªåˆå§‹åŒ–
  // _thread_new            = 2,  // æ–°å»º
  // _thread_new_trans      = 3,  // æ–°å»ºè¿‡æ¸¡
  // _thread_in_native      = 4,  // æ‰§è¡Œnativeä»£ç 
  // _thread_in_native_trans= 5,  // nativeè¿‡æ¸¡
  // _thread_in_vm          = 6,  // æ‰§è¡ŒVMä»£ç 
  // _thread_in_vm_trans    = 7,  // VMè¿‡æ¸¡
  // _thread_in_Java        = 8,  // æ‰§è¡ŒJavaä»£ç 
  // _thread_in_Java_trans  = 9,  // Javaè¿‡æ¸¡
  // _thread_blocked        = 10, // é˜»å¡
  // _thread_blocked_trans  = 11  // é˜»å¡è¿‡æ¸¡
  
  // ==================== å®‰å…¨ç‚¹çŠ¶æ€ ====================
  ThreadSafepointState* _safepoint_state;  // å®‰å…¨ç‚¹æœŸé—´çš„çº¿ç¨‹çŠ¶æ€
  
  // ==================== VMè°ƒç”¨ç»“æœ ====================
  oop _vm_result;                       // VMè°ƒç”¨çš„oopç»“æœ
  Metadata* _vm_result_2;               // VMè°ƒç”¨çš„éoopç»“æœ
  
  // ==================== å¼‚å¸¸å¤„ç† ====================
  volatile oop _exception_oop;          // ç¼–è¯‘ä»£ç ä¸­æŠ›å‡ºçš„å¼‚å¸¸
  volatile address _exception_pc;       // å¼‚å¸¸å‘ç”Ÿçš„PC
  
  // ==================== æ ˆæº¢å‡ºä¿æŠ¤ ====================
  address _stack_overflow_limit;        // æ ˆæº¢å‡ºæ£€æµ‹é™åˆ¶
  address _reserved_stack_activation;   // ä¿ç•™æ ˆæ¿€æ´»åœ°å€
  StackGuardState _stack_guard_state;   // æ ˆä¿æŠ¤é¡µçŠ¶æ€
  
  // ==================== æ¡æ‰‹æ“ä½œ ====================
  HandshakeState _handshake;            // çº¿ç¨‹æ¡æ‰‹æ“ä½œæ”¯æŒ
  
  // ==================== JSR166æ”¯æŒ ====================
  Parker* _parker;                      // LockSupport.park/unparkæ”¯æŒ
  
  // ==================== ç¼–è¯‘ç›¸å…³ ====================
  int _in_deopt_handler;                // æ˜¯å¦åœ¨åä¼˜åŒ–å¤„ç†ä¸­
  
  // ==================== JNIå…³é”®åŒº ====================
  volatile jint _jni_active_critical;   // JNIå…³é”®åŒºè®¡æ•°
  
  // ==================== å®‰å…¨ç‚¹æ£€æŸ¥ ====================
  volatile address _polling_page;       // è½®è¯¢é¡µåœ°å€
};
```

### **3.2 JavaFrameAnchorè¯¦è§£**

```cpp
class JavaFrameAnchor {
  // æœ€åJavaæ ˆæŒ‡é’ˆ (å¿…é¡»åœ¨åç§»é‡0å¤„)
  intptr_t* volatile _last_Java_sp;
  
  // æœ€åJavaç¨‹åºè®¡æ•°å™¨ (ç”¨äºæ ˆéå†)
  volatile address _last_Java_pc;
  
  // x86ç‰¹æœ‰: æœ€åJavaå¸§æŒ‡é’ˆ
  intptr_t* volatile _last_Java_fp;
};

// ç”¨é€”:
// 1. ä»nativeä»£ç è¿”å›Javaæ—¶æ¢å¤æ ˆçŠ¶æ€
// 2. GCæ—¶éå†Javaæ ˆ
// 3. å¼‚å¸¸å¤„ç†æ—¶å±•å¼€æ ˆ
```

### **3.3 ThreadSafepointStateè¯¦è§£**

```cpp
class ThreadSafepointState : public CHeapObj<mtThread> {
  volatile bool _at_poll_safepoint;     // æ˜¯å¦åœ¨è½®è¯¢å®‰å…¨ç‚¹
  bool _has_called_back;                // æ˜¯å¦å·²å›è°ƒ
  JavaThread* _thread;                  // å…³è”çš„Javaçº¿ç¨‹
  volatile suspend_type _type;          // çŠ¶æ€ç±»å‹
  JavaThreadState _orig_thread_state;   // åŸå§‹çº¿ç¨‹çŠ¶æ€
};

// suspend_type:
// _running        = 0,  // è¿è¡Œä¸­
// _at_safepoint   = 1,  // åœ¨å®‰å…¨ç‚¹
// _call_back      = 2   // éœ€è¦å›è°ƒ
```

### **3.4 çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾**

```
JavaThreadçŠ¶æ€è½¬æ¢:

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ _thread_new     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ start()
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                       â”‚
         â–¼                                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚ _thread_in_Java â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚    â”‚
         â”‚ JNIè°ƒç”¨                           â”‚    â”‚
         â–¼                                   â”‚    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     VMè°ƒç”¨      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”
â”‚_thread_in_nativeâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ _thread_in_vm  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚ è¿”å›Java                          â”‚ è¿”å›Java
         â”‚                                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ å®‰å…¨ç‚¹/é˜»å¡
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ _thread_blocked â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–¥ï¸ **4. VMThread - VMæ“ä½œçº¿ç¨‹**

### **4.1 æ¦‚è¿°**

`VMThread`æ˜¯JVMçš„æ ¸å¿ƒçº¿ç¨‹ï¼Œè´Ÿè´£æ‰§è¡Œæ‰€æœ‰éœ€è¦åœ¨å®‰å…¨ç‚¹æ‰§è¡Œçš„VMæ“ä½œã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class VMThread : public NamedThread {
  // ==================== å•ä¾‹ ====================
  static VMThread* _vm_thread;          // VMçº¿ç¨‹å•ä¾‹
  
  // ==================== å½“å‰æ“ä½œ ====================
  static VM_Operation* _cur_vm_operation;  // å½“å‰æ‰§è¡Œçš„VMæ“ä½œ
  
  // ==================== æ“ä½œé˜Ÿåˆ— ====================
  static VMOperationQueue* _vm_queue;   // VMæ“ä½œé˜Ÿåˆ—
  
  // ==================== ç»ˆæ­¢æ§åˆ¶ ====================
  static bool _should_terminate;        // æ˜¯å¦åº”è¯¥ç»ˆæ­¢
  static bool _terminated;              // æ˜¯å¦å·²ç»ˆæ­¢
  static Monitor* _terminate_lock;      // ç»ˆæ­¢é”
  
  // ==================== ä¼˜å…ˆçº§ ====================
  static ThreadPriority _current_priority;  // å½“å‰ä¼˜å…ˆçº§
  
  // ==================== è¶…æ—¶ä»»åŠ¡ ====================
  static VMOperationTimeoutTask* _timeout_task;  // æ“ä½œè¶…æ—¶ä»»åŠ¡
};
```

### **4.3 VMOperationQueueè¯¦è§£**

```cpp
class VMOperationQueue : public CHeapObj<mtInternal> {
  // é˜Ÿåˆ—æ•°ç»„ (æŒ‰ä¼˜å…ˆçº§åˆ†ç±»)
  VM_Operation* _queue[nof_priorities];
  
  // é˜Ÿåˆ—å¤´å°¾
  VM_Operation* _queue_head[nof_priorities];
  VM_Operation* _queue_tail[nof_priorities];
  
  // æ’ç©ºè®¡æ•°
  int _drain_list_length;
  VM_Operation* _drain_list;
};

// ä¼˜å…ˆçº§ç­‰çº§
enum Priorities {
  SafepointPriority,      // å®‰å…¨ç‚¹ä¼˜å…ˆçº§ (æœ€é«˜)
  MediumPriority,         // ä¸­ç­‰ä¼˜å…ˆçº§
  nof_priorities          // ä¼˜å…ˆçº§æ•°é‡
};
```

### **4.4 å¸¸è§VM_Operationç±»å‹**

```cpp
// VMæ“ä½œç±»å‹æšä¸¾
enum VMOp_Type {
  // GCç›¸å…³
  VM_GC_Operation,
  VM_G1CollectForAllocation,
  VM_G1CollectFull,
  VM_G1ConcurrentMark,
  
  // ç±»åŠ è½½
  VM_ClassLoaderStatsOperation,
  
  // åå‘é”
  VM_RevokeBias,
  VM_BulkRevokeBias,
  
  // åä¼˜åŒ–
  VM_Deoptimize,
  VM_DeoptimizeFrame,
  
  // çº¿ç¨‹æ“ä½œ
  VM_ThreadStop,
  VM_ThreadDump,
  
  // è°ƒè¯•
  VM_PrintThreads,
  VM_PrintJNI,
  
  // å…¶ä»–
  VM_Exit,
  VM_Halt,
  // ...
};
```

### **4.5 VMThreadæ‰§è¡Œå¾ªç¯**

```
VMThreadä¸»å¾ªç¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ while (!should_terminate()) {                               â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 1. ç­‰å¾…VMæ“ä½œè¯·æ±‚                                    â”‚
â”‚     â”‚       wait_for_operation()                            â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 2. è·å–ä¸‹ä¸€ä¸ªæ“ä½œ                                    â”‚
â”‚     â”‚       op = vm_queue->remove_next()                    â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 3. å¦‚æœéœ€è¦å®‰å…¨ç‚¹                                    â”‚
â”‚     â”‚       if (op->evaluate_at_safepoint()) {              â”‚
â”‚     â”‚           SafepointSynchronize::begin()               â”‚
â”‚     â”‚       }                                               â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 4. æ‰§è¡Œæ“ä½œ                                          â”‚
â”‚     â”‚       op->evaluate()                                  â”‚
â”‚     â”‚                                                       â”‚
â”‚     â”œâ”€â”€ 5. ç»“æŸå®‰å…¨ç‚¹                                        â”‚
â”‚     â”‚       if (at_safepoint) {                             â”‚
â”‚     â”‚           SafepointSynchronize::end()                 â”‚
â”‚     â”‚       }                                               â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€ 6. é€šçŸ¥è¯·æ±‚è€…å®Œæˆ                                    â”‚
â”‚             op->notify_complete()                           â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ **5. ServiceThread - æœåŠ¡çº¿ç¨‹**

### **5.1 æ¦‚è¿°**

`ServiceThread`æ˜¯ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„åå°çº¿ç¨‹ï¼Œå¤„ç†å„ç§å»¶è¿Ÿä»»åŠ¡ã€‚

### **5.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class ServiceThread : public JavaThread {
  // ==================== å•ä¾‹ ====================
  static ServiceThread* _instance;
  
  // ==================== JVMTIäº‹ä»¶ ====================
  static JvmtiDeferredEvent* _jvmti_event;
  static JvmtiDeferredEventQueue _jvmti_service_queue;
};
```

### **5.3 æœåŠ¡ä»»åŠ¡åˆ—è¡¨**

```
ServiceThreadå¤„ç†çš„ä»»åŠ¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç±»å‹                    â”‚ è§¦å‘æ¡ä»¶                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ JVMTIå»¶è¿Ÿäº‹ä»¶               â”‚ ç¼–è¯‘æ–¹æ³•åŠ è½½/å¸è½½             â”‚
â”‚ ä½å†…å­˜æ£€æµ‹                  â”‚ å†…å­˜æ± è¶…è¿‡é˜ˆå€¼                â”‚
â”‚ GCé€šçŸ¥                      â”‚ GCå®Œæˆå                      â”‚
â”‚ å­—ç¬¦ä¸²è¡¨æ¸…ç†                â”‚ å­—ç¬¦ä¸²è¡¨éœ€è¦é‡å“ˆå¸Œ            â”‚
â”‚ ç¬¦å·è¡¨æ¸…ç†                  â”‚ ç¬¦å·è¡¨éœ€è¦é‡å“ˆå¸Œ              â”‚
â”‚ ä¿æŠ¤åŸŸç¼“å­˜æ¸…ç†              â”‚ éœ€è¦æ¸…ç†æ— æ•ˆæ¡ç›®              â”‚
â”‚ è§£æé”™è¯¯è¡¨æ¸…ç†              â”‚ éœ€è¦æ¸…ç†æ— æ•ˆæ¡ç›®              â”‚
â”‚ ç±»å¸è½½é€šçŸ¥                  â”‚ ç±»åŠ è½½å™¨è¢«å¸è½½                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **5.4 ServiceThreadå·¥ä½œå¾ªç¯**

```cpp
void ServiceThread::service_thread_entry(JavaThread* jt, TRAPS) {
  while (true) {
    // ç­‰å¾…ä»»åŠ¡
    {
      MonitorLocker ml(Service_lock, Mutex::_no_safepoint_check_flag);
      while (!has_work()) {
        ml.wait();
      }
    }
    
    // å¤„ç†JVMTIäº‹ä»¶
    if (JvmtiDeferredEventQueue::has_events()) {
      JvmtiDeferredEventQueue::process_events(jt);
    }
    
    // å¤„ç†ä½å†…å­˜æ£€æµ‹
    if (LowMemoryDetector::has_pending_requests()) {
      LowMemoryDetector::process_pending_requests();
    }
    
    // å¤„ç†GCé€šçŸ¥
    if (GCNotifier::has_pending_notifications()) {
      GCNotifier::notify_all();
    }
    
    // å¤„ç†å­—ç¬¦ä¸²è¡¨æ¸…ç†
    if (StringTable::has_work()) {
      StringTable::do_concurrent_work(jt);
    }
    
    // ... å…¶ä»–ä»»åŠ¡
  }
}
```

---

## â° **6. WatcherThread - ç›‘æ§çº¿ç¨‹**

### **6.1 æ¦‚è¿°**

`WatcherThread`æ˜¯VMå‘¨æœŸæ€§ä»»åŠ¡çº¿ç¨‹ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚

### **6.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class WatcherThread : public NonJavaThread {
  // ==================== å•ä¾‹ ====================
  static WatcherThread* _watcher_thread;
  
  // ==================== å¯åŠ¨æ§åˆ¶ ====================
  static bool _startable;               // æ˜¯å¦å¯å¯åŠ¨
  
  // ==================== ç»ˆæ­¢æ§åˆ¶ ====================
  volatile static bool _should_terminate;  // æ˜¯å¦åº”è¯¥ç»ˆæ­¢
  
  // ==================== å¸¸é‡ ====================
  enum SomeConstants {
    delay_interval = 10                 // ä¸­æ–­å»¶è¿Ÿé—´éš”(æ¯«ç§’)
  };
};
```

### **6.3 å‘¨æœŸæ€§ä»»åŠ¡**

```cpp
// PeriodicTaskåŸºç±»
class PeriodicTask : public CHeapObj<mtInternal> {
  size_t _counter;                      // è®¡æ•°å™¨
  size_t _interval;                     // æ‰§è¡Œé—´éš”(æ¯«ç§’)
  
  virtual void task() = 0;              // ä»»åŠ¡å®ç°
};

// å·²æ³¨å†Œçš„å‘¨æœŸæ€§ä»»åŠ¡:
// 1. CompilationPolicy::tick() - ç¼–è¯‘ç­–ç•¥æ›´æ–°
// 2. StatSampler::collect_sample() - ç»Ÿè®¡é‡‡æ ·
// 3. MemProfiler::engage() - å†…å­˜åˆ†æ
// 4. JniPeriodicChecker::check() - JNIæ£€æŸ¥
// 5. Chunk::clean() - å†…å­˜å—æ¸…ç†
```

### **6.4 WatcherThreadå·¥ä½œå¾ªç¯**

```cpp
void WatcherThread::run() {
  while (!should_terminate()) {
    // ç¡çœ ä¸€ä¸ªé—´éš”
    int remaining = sleep(delay_interval);
    
    if (remaining == 0) {
      // æ‰§è¡Œæ‰€æœ‰åˆ°æœŸçš„å‘¨æœŸæ€§ä»»åŠ¡
      PeriodicTask::real_time_tick(delay_interval);
    }
  }
}

// é»˜è®¤æ¯10mså”¤é†’ä¸€æ¬¡ï¼Œæ£€æŸ¥å¹¶æ‰§è¡Œåˆ°æœŸä»»åŠ¡
```

---

## ğŸ”¨ **7. CompilerThread - ç¼–è¯‘çº¿ç¨‹**

### **7.1 æ¦‚è¿°**

`CompilerThread`æ˜¯JITç¼–è¯‘çº¿ç¨‹ï¼Œè´Ÿè´£å°†çƒ­ç‚¹å­—èŠ‚ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ã€‚

### **7.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CompilerThread : public JavaThread {
  // ==================== ç¼–è¯‘è®¡æ•°å™¨ ====================
  CompilerCounters* _counters;
  
  // ==================== ç¼–è¯‘ç¯å¢ƒ ====================
  ciEnv* _env;                          // ç¼–è¯‘å™¨ç¯å¢ƒ
  
  // ==================== ç¼–è¯‘æ—¥å¿— ====================
  CompileLog* _log;
  
  // ==================== å½“å‰ä»»åŠ¡ ====================
  CompileTask* volatile _task;          // å½“å‰ç¼–è¯‘ä»»åŠ¡
  
  // ==================== ç¼–è¯‘é˜Ÿåˆ— ====================
  CompileQueue* _queue;
  
  // ==================== ç¼“å†²åŒº ====================
  BufferBlob* _buffer_blob;             // ç¼–è¯‘ç¼“å†²åŒº
  
  // ==================== ç¼–è¯‘å™¨ ====================
  AbstractCompiler* _compiler;          // C1/C2/Graal
  
  // ==================== ç©ºé—²æ—¶é—´ ====================
  TimeStamp _idle_time;
  
#ifndef PRODUCT
  // ==================== è°ƒè¯• ====================
  IdealGraphPrinter* _ideal_graph_printer;
#endif
};
```

### **7.3 ç¼–è¯‘å™¨ç±»å‹**

```cpp
// ç¼–è¯‘å™¨å±‚æ¬¡ (åˆ†å±‚ç¼–è¯‘)
enum CompLevel {
  CompLevel_none              = 0,  // è§£é‡Šæ‰§è¡Œ
  CompLevel_simple            = 1,  // C1ç®€å•ç¼–è¯‘
  CompLevel_limited_profile   = 2,  // C1å¸¦æœ‰é™profiling
  CompLevel_full_profile      = 3,  // C1å¸¦å®Œæ•´profiling
  CompLevel_full_optimization = 4,  // C2å®Œå…¨ä¼˜åŒ–
};

// ç¼–è¯‘å™¨å®ä¾‹
// C1ç¼–è¯‘å™¨: å¿«é€Ÿç¼–è¯‘ï¼Œé€‚åº¦ä¼˜åŒ–
// C2ç¼–è¯‘å™¨: æ…¢é€Ÿç¼–è¯‘ï¼Œæ·±åº¦ä¼˜åŒ–
// Graalç¼–è¯‘å™¨: JVMCIå®ç° (å¯é€‰)
```

### **7.4 CompileTaskè¯¦è§£**

```cpp
class CompileTask : public CHeapObj<mtCompiler> {
  // ==================== æ–¹æ³•ä¿¡æ¯ ====================
  Method* _method;                      // è¦ç¼–è¯‘çš„æ–¹æ³•
  int _osr_bci;                         // OSRå…¥å£BCI (-1è¡¨ç¤ºéOSR)
  
  // ==================== ç¼–è¯‘é…ç½® ====================
  int _comp_level;                      // ç¼–è¯‘çº§åˆ«
  int _compile_id;                      // ç¼–è¯‘ID
  
  // ==================== çŠ¶æ€ ====================
  bool _is_complete;                    // æ˜¯å¦å®Œæˆ
  bool _is_success;                     // æ˜¯å¦æˆåŠŸ
  
  // ==================== é“¾è¡¨é“¾æ¥ ====================
  CompileTask* _next;                   // é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª
  CompileTask* _prev;                   // é˜Ÿåˆ—ä¸­çš„å‰ä¸€ä¸ª
  
  // ==================== çƒ­åº¦ ====================
  int _hot_count;                       // çƒ­åº¦è®¡æ•°
  
  // ==================== é˜»å¡çº¿ç¨‹ ====================
  JavaThread* _blocking_thread;         // ç­‰å¾…ç¼–è¯‘å®Œæˆçš„çº¿ç¨‹
};
```

### **7.5 8GBå †çš„ç¼–è¯‘çº¿ç¨‹é…ç½®**

```
ç¼–è¯‘çº¿ç¨‹é…ç½® (8GBå †, 8æ ¸CPU):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ å€¼          â”‚ è¯´æ˜                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CICompilerCount         â”‚ 4           â”‚ ç¼–è¯‘çº¿ç¨‹æ€»æ•°        â”‚
â”‚ C1çº¿ç¨‹æ•°                â”‚ 1           â”‚ C1ç¼–è¯‘çº¿ç¨‹          â”‚
â”‚ C2çº¿ç¨‹æ•°                â”‚ 3           â”‚ C2ç¼–è¯‘çº¿ç¨‹          â”‚
â”‚ CompileThreshold        â”‚ 10000       â”‚ ç¼–è¯‘é˜ˆå€¼            â”‚
â”‚ TieredCompilation       â”‚ true        â”‚ åˆ†å±‚ç¼–è¯‘            â”‚
â”‚ Tier3InvocationThresholdâ”‚ 200         â”‚ Tier3è°ƒç”¨é˜ˆå€¼       â”‚
â”‚ Tier4InvocationThresholdâ”‚ 5000        â”‚ Tier4è°ƒç”¨é˜ˆå€¼       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ **8. Threadsç±» - çº¿ç¨‹ç®¡ç†å™¨**

### **8.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Threads : AllStatic {
  // ==================== çº¿ç¨‹é“¾è¡¨ ====================
  static JavaThread* _thread_list;      // æ‰€æœ‰JavaThreadçš„é“¾è¡¨å¤´
  
  // ==================== è®¡æ•° ====================
  static int _number_of_threads;        // æ´»è·ƒçº¿ç¨‹æ€»æ•°
  static int _number_of_non_daemon_threads;  // éå®ˆæŠ¤çº¿ç¨‹æ•°
  
  // ==================== GCæ”¯æŒ ====================
  static int _thread_claim_parity;      // çº¿ç¨‹å£°æ˜å¥‡å¶æ ¡éªŒ
  
  // ==================== è¿”å›åœ°å€ ====================
  static uintx _return_code;            // è¿”å›ç 
};
```

### **8.2 çº¿ç¨‹é“¾è¡¨æ“ä½œ**

```cpp
// æ·»åŠ çº¿ç¨‹åˆ°é“¾è¡¨
static void add(JavaThread* p, bool force_daemon = false) {
  MutexLocker ml(Threads_lock);
  
  // æ·»åŠ åˆ°é“¾è¡¨å¤´
  p->set_next(_thread_list);
  _thread_list = p;
  
  // æ›´æ–°è®¡æ•°
  _number_of_threads++;
  if (!p->is_daemon()) {
    _number_of_non_daemon_threads++;
  }
}

// ä»é“¾è¡¨ç§»é™¤çº¿ç¨‹
static void remove(JavaThread* p) {
  MutexLocker ml(Threads_lock);
  
  // ä»é“¾è¡¨ä¸­ç§»é™¤
  // ... é“¾è¡¨æ“ä½œ
  
  // æ›´æ–°è®¡æ•°
  _number_of_threads--;
  if (!p->is_daemon()) {
    _number_of_non_daemon_threads--;
  }
}
```

---

## ğŸ–§ **9. OSThread - æ“ä½œç³»ç»Ÿçº¿ç¨‹**

### **9.1 å…³é”®æˆå‘˜å˜é‡**

```cpp
class OSThread : public CHeapObj<mtThread> {
  // ==================== å¯åŠ¨ä¿¡æ¯ ====================
  OSThreadStartFunc _start_proc;        // çº¿ç¨‹å¯åŠ¨ä¾‹ç¨‹
  void* _start_parm;                    // çº¿ç¨‹å¯åŠ¨å‚æ•°
  
  // ==================== çŠ¶æ€ ====================
  volatile ThreadState _state;          // çº¿ç¨‹çŠ¶æ€
  
  // ==================== ä¸­æ–­ ====================
  volatile jint _interrupted;           // ä¸­æ–­çŠ¶æ€ (0æˆ–1)
  
  // ==================== çº¿ç¨‹ID ====================
  thread_id_t _thread_id;               // å†…æ ¸çº¿ç¨‹ID (pthread_t)
  
  // ==================== Linuxç‰¹æœ‰ ====================
  pthread_t _pthread_id;                // POSIXçº¿ç¨‹ID
  sigset_t _caller_sigmask;             // è°ƒç”¨è€…ä¿¡å·æ©ç 
  
  // ==================== åŒæ­¥ ====================
  Monitor* _startThread_lock;           // å¯åŠ¨åŒæ­¥é”
};
```

### **9.2 ThreadStateæšä¸¾**

```cpp
enum ThreadState {
  ALLOCATED,      // å†…å­˜å·²åˆ†é…ä½†æœªåˆå§‹åŒ–
  INITIALIZED,    // å·²åˆå§‹åŒ–ä½†æœªå¯åŠ¨
  RUNNABLE,       // å·²å¯åŠ¨å¯è¿è¡Œ
  MONITOR_WAIT,   // ç­‰å¾…ç«äº‰çš„ç›‘è§†å™¨é”
  CONDVAR_WAIT,   // ç­‰å¾…æ¡ä»¶å˜é‡
  OBJECT_WAIT,    // Object.wait() è°ƒç”¨ä¸­
  BREAKPOINTED,   // åœ¨æ–­ç‚¹å¤„æŒ‚èµ·
  SLEEPING,       // Thread.sleep() ä¸­
  ZOMBIE          // å·²å®Œæˆä½†æœªå›æ”¶
};
```

---

## ğŸ“Š **10. çº¿ç¨‹å¯¹è±¡å…³ç³»å›¾**

```
çº¿ç¨‹ç³»ç»Ÿå¯¹è±¡å…³ç³»:

Threads (é™æ€ç±»)
    â”‚
    â””â”€â”€ _thread_list â”€â”€â–º JavaThreadé“¾è¡¨
                              â”‚
                              â”œâ”€â”€ main_thread
                              â”‚       â”‚
                              â”‚       â”œâ”€â”€ _threadObj â”€â”€â–º java.lang.Thread
                              â”‚       â”œâ”€â”€ _jni_environment â”€â”€â–º JNIEnv
                              â”‚       â”œâ”€â”€ _tlab â”€â”€â–º TLAB
                              â”‚       â”œâ”€â”€ _anchor â”€â”€â–º JavaFrameAnchor
                              â”‚       â”œâ”€â”€ _osthread â”€â”€â–º OSThread
                              â”‚       â”‚                    â”‚
                              â”‚       â”‚                    â””â”€â”€ _pthread_id
                              â”‚       â”‚
                              â”‚       â””â”€â”€ _safepoint_state â”€â”€â–º ThreadSafepointState
                              â”‚
                              â”œâ”€â”€ CompilerThread[0..3]
                              â”‚       â”‚
                              â”‚       â”œâ”€â”€ _compiler â”€â”€â–º C1/C2
                              â”‚       â”œâ”€â”€ _task â”€â”€â–º CompileTask
                              â”‚       â””â”€â”€ _queue â”€â”€â–º CompileQueue
                              â”‚
                              â””â”€â”€ ServiceThread
                                      â”‚
                                      â””â”€â”€ _jvmti_service_queue

VMThread (å•ä¾‹)
    â”‚
    â”œâ”€â”€ _vm_queue â”€â”€â–º VMOperationQueue
    â”‚                       â”‚
    â”‚                       â””â”€â”€ VM_Operationé“¾è¡¨
    â”‚
    â””â”€â”€ _cur_vm_operation â”€â”€â–º å½“å‰VMæ“ä½œ

WatcherThread (å•ä¾‹)
    â”‚
    â””â”€â”€ å‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œ (PeriodicTask)
```

---

## ğŸ¯ **11. æ€»ç»“**

### **11.1 JVMå¯åŠ¨åçš„çº¿ç¨‹**

| çº¿ç¨‹ç±»å‹ | æ•°é‡ | ä½œç”¨ |
|---------|------|------|
| **main** | 1 | ä¸»çº¿ç¨‹ï¼Œæ‰§è¡Œmainæ–¹æ³• |
| **VMThread** | 1 | æ‰§è¡ŒVMæ“ä½œ |
| **ServiceThread** | 1 | åå°æœåŠ¡ä»»åŠ¡ |
| **WatcherThread** | 1 | å‘¨æœŸæ€§ä»»åŠ¡ |
| **CompilerThread** | 4 | JITç¼–è¯‘ |
| **G1 Main Marker** | 1 | G1å¹¶å‘æ ‡è®° |
| **G1 Refine** | 4 | G1å¹¶å‘ç»†åŒ– |
| **Signal Dispatcher** | 1 | ä¿¡å·åˆ†å‘ |
| **Reference Handler** | 1 | å¼•ç”¨å¤„ç† |
| **Finalizer** | 1 | ç»ˆç»“å™¨ |
| **æ€»è®¡** | ~16 | |

### **11.2 å†…å­˜å ç”¨**

| ç»„ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| çº¿ç¨‹æ ˆ | 1MB/çº¿ç¨‹ | é»˜è®¤æ ˆå¤§å° |
| Threadç»“æ„ | ~4KB/çº¿ç¨‹ | çº¿ç¨‹å¯¹è±¡ |
| TLAB | ~780KB/çº¿ç¨‹ | çº¿ç¨‹æœ¬åœ°åˆ†é… |
| æ€»è®¡ | ~30MB | 16ä¸ªçº¿ç¨‹ |

### **11.3 å…³é”®è®¾è®¡ç‚¹**

1. **çº¿ç¨‹çŠ¶æ€æœº**: ç²¾ç¡®çš„çŠ¶æ€è½¬æ¢æ”¯æŒå®‰å…¨ç‚¹
2. **VMThreadå•ä¾‹**: é›†ä¸­å¤„ç†æ‰€æœ‰VMæ“ä½œ
3. **åˆ†å±‚ç¼–è¯‘**: C1å¿«é€Ÿç¼–è¯‘ + C2æ·±åº¦ä¼˜åŒ–
4. **å‘¨æœŸæ€§ä»»åŠ¡**: WatcherThreadç»Ÿä¸€ç®¡ç†
5. **TLABä¼˜åŒ–**: çº¿ç¨‹æœ¬åœ°åˆ†é…é¿å…é”ç«äº‰