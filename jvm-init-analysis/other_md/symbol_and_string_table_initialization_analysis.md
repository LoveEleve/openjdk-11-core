# JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–ç¬¬äº”é˜¶æ®µï¼šç¬¦å·è¡¨ä¸å­—ç¬¦ä¸²è¡¨æ·±åº¦è§£æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–çš„ç¬¬äº”ä¸ªå…³é”®é˜¶æ®µï¼šç¬¦å·è¡¨ï¼ˆSymbolTableï¼‰å’Œå­—ç¬¦ä¸²è¡¨ï¼ˆStringTableï¼‰çš„åˆ›å»ºã€‚è¿™ä¸¤ä¸ªå…¨å±€å“ˆå¸Œè¡¨æ˜¯JVMè¿è¡Œæ—¶çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰çš„ç¬¦å·ï¼ˆç±»åã€æ–¹æ³•åã€å­—æ®µåç­‰ï¼‰å’Œå­—ç¬¦ä¸²å¸¸é‡ï¼Œä¸ºç±»åŠ è½½ã€æ–¹æ³•è°ƒç”¨å’Œå­—ç¬¦ä¸²æ“ä½œæä¾›é«˜æ•ˆçš„æŸ¥æ‰¾å’Œå»é‡æœåŠ¡ã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp:727-747
Universe::_do_stack_walk_cache = new LatestMethodCache();  // ç¬¬å››æ­¥å®Œæˆ

#if INCLUDE_CDS
  if (UseSharedSpaces) {
    // CDSæ¨¡å¼ï¼šä»å…±äº«å­˜æ¡£åˆå§‹åŒ–
    MetaspaceShared::initialize_shared_spaces();
    StringTable::create_table();  // åªåˆ›å»ºå­—ç¬¦ä¸²è¡¨ï¼Œç¬¦å·è¡¨ä»CDSåŠ è½½
  } else
#endif
  {
    // æ ‡å‡†æ¨¡å¼ï¼šåˆ›å»ºå…¨æ–°çš„è¡¨
    SymbolTable::create_table();  // åˆ›å»ºç¬¦å·è¡¨
    StringTable::create_table();  // åˆ›å»ºå­—ç¬¦ä¸²è¡¨

#if INCLUDE_CDS
    if (DumpSharedSpaces) {
      MetaspaceShared::prepare_for_dumping();  // å‡†å¤‡CDSè½¬å‚¨
    }
#endif
  }
```

## ğŸ—ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šç¬¦å·è¡¨ï¼ˆSymbolTableï¼‰æ¶æ„

### 1.1 ç¬¦å·è¡¨è®¾è®¡ç›®æ ‡

ç¬¦å·è¡¨æ˜¯JVMä¸­ç®¡ç†æ‰€æœ‰ç¬¦å·çš„å…¨å±€å“ˆå¸Œè¡¨ï¼Œè§£å†³ä»¥ä¸‹æ ¸å¿ƒé—®é¢˜ï¼š

1. **ç¬¦å·å»é‡**ï¼šç¡®ä¿ç›¸åŒçš„ç¬¦å·åªæœ‰ä¸€ä¸ªå®ä¾‹
2. **å¿«é€ŸæŸ¥æ‰¾**ï¼šO(1)å¹³å‡æ—¶é—´å¤æ‚åº¦çš„ç¬¦å·æŸ¥æ‰¾
3. **å†…å­˜æ•ˆç‡**ï¼šé€šè¿‡å…±äº«å‡å°‘å†…å­˜å ç”¨
4. **å¼•ç”¨è®¡æ•°**ï¼šæ”¯æŒç¬¦å·çš„è‡ªåŠ¨å›æ”¶
5. **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®

### 1.2 Symbolæ ¸å¿ƒç»“æ„

```cpp
// Symbolçš„å†…å­˜å¸ƒå±€
class Symbol : public MetaspaceObj {
  friend class VMStructs;
  friend class SymbolTable;
  
private:
  // åŸå­æ“ä½œçš„å¼•ç”¨è®¡æ•°å’Œé•¿åº¦ï¼ˆæ‰“åŒ…åœ¨ä¸€èµ·ä¼˜åŒ–å†…å­˜ï¼‰
  ATOMIC_SHORT_PAIR(
    volatile short _refcount,    // å¼•ç”¨è®¡æ•°ï¼ˆéœ€è¦åŸå­æ“ä½œï¼‰
    unsigned short _length       // UTF8å­—ç¬¦æ•°é‡ï¼ˆä¸éœ€è¦åŸå­æ“ä½œï¼‰
  );
  
  short _identity_hash;          // èº«ä»½å“ˆå¸Œç ï¼ˆç”¨äºå“ˆå¸Œè¡¨ï¼‰
  jbyte _body[2];               // UTF8å­—èŠ‚æ•°æ®ï¼ˆå˜é•¿ï¼‰

public:
  // ç¬¦å·é•¿åº¦é™åˆ¶
  enum {
    max_symbol_length = (1 << 16) - 1  // 65535å­—ç¬¦
  };
  
  // å†…å­˜å¤§å°è®¡ç®—
  static int byte_size(int length) {
    return (int)(sizeof(Symbol) + (length > 2 ? length - 2 : 0));
  }
  
  // å¼•ç”¨è®¡æ•°ç®¡ç†
  void increment_refcount();
  void decrement_refcount();
  short refcount() const { return _refcount; }
  
  // ç¬¦å·å†…å®¹è®¿é—®
  const jbyte* bytes() const { return _body; }
  int utf8_length() const { return _length; }
  char* as_utf8() const;
  
  // æ¯”è¾ƒæ“ä½œ
  bool equals(const char* str, int len) const;
  bool equals(Symbol* other) const;
  
  // å“ˆå¸Œè®¡ç®—
  static unsigned int hash_code(const char* s, int len);
  unsigned int identity_hash() const { return _identity_hash; }
};
```

#### **Symbolå†…å­˜å¸ƒå±€ç¤ºä¾‹**

```
Symbolå†…å­˜ç»“æ„ï¼ˆä»¥"java/lang/Object"ä¸ºä¾‹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Symbolå¯¹è±¡                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _refcount: 1000        â”‚ _length: 16                        â”‚ 4å­—èŠ‚
â”‚ _identity_hash: 0x1234                                      â”‚ 2å­—èŠ‚
â”‚ _body: "java/lang/Object"                                   â”‚ 16å­—èŠ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»å¤§å°: 22å­—èŠ‚ï¼ˆå¯¹é½å24å­—èŠ‚ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼•ç”¨è®¡æ•°è¯´æ˜ï¼š
- æ­£å¸¸è®¡æ•°ï¼š1-32767ï¼ˆå¯å›æ”¶ï¼‰
- æ°¸ä¹…ç¬¦å·ï¼šPERM_REFCOUNT(-1)ï¼ˆæ°¸ä¸å›æ”¶ï¼‰
- é›¶è®¡æ•°ï¼šç¬¦å·å¯è¢«åƒåœ¾æ”¶é›†
```

### 1.3 SymbolTableæ ¸å¿ƒç»“æ„

```cpp
// SymbolTableçš„å®ç°
class SymbolTable : public RehashableHashtable<Symbol*, mtSymbol> {
  friend class VMStructs;
  friend class ClassFileParser;

private:
  // å…¨å±€å”¯ä¸€çš„ç¬¦å·è¡¨å®ä¾‹
  static SymbolTable* _the_table;
  
  // é‡å“ˆå¸Œæ ‡è®°ï¼ˆå½“æŸä¸ªæ¡¶è¿‡åº¦ä¸å¹³è¡¡æ—¶ï¼‰
  static bool _needs_rehashing;
  
  // å…±äº«ç¬¦å·è¡¨ï¼ˆCDSæ”¯æŒï¼‰
  static CompactHashtable<Symbol*, char> _shared_table;
  static bool _lookup_shared_first;
  
  // ç»Ÿè®¡ä¿¡æ¯
  static int _symbols_removed;
  static int _symbols_counted;

public:
  // è¡¨åˆ›å»ºå’Œåˆå§‹åŒ–
  static void create_table();
  static void initialize_symbols(int arena_alloc_size = 0);
  
  // ç¬¦å·æŸ¥æ‰¾å’Œåˆ›å»º
  static Symbol* lookup(const char* name, int len, TRAPS);
  static Symbol* lookup_only(const char* name, int len, unsigned int& hash);
  static Symbol* new_symbol(const char* name, int len, TRAPS);
  static Symbol* new_symbol(const char* name, TRAPS);
  
  // å…±äº«ç¬¦å·è¡¨æ”¯æŒï¼ˆCDSï¼‰
  static Symbol* lookup_shared(const char* name, int len, unsigned int hash);
  static void copy_shared_symbol_table(CompactHashtable<Symbol*, char>* ch_table);
  
  // ç¬¦å·å›æ”¶
  static void unlink_symbol(Symbol* sym);
  static void possibly_parallel_unlink(int* processed, int* removed);
  
  // ç»Ÿè®¡å’Œè°ƒè¯•
  static void print_histogram() PRODUCT_RETURN;
  static void print() PRODUCT_RETURN;
  static void dump(outputStream* st, bool verbose = false);
  
private:
  // ç¬¦å·åˆ†é…
  Symbol* allocate_symbol(const u1* name, int len, bool c_heap, TRAPS);
  Symbol* basic_add(int index, u1* name, int len, unsigned int hashValue, 
                   bool c_heap, TRAPS);
};
```

### 1.4 ç¬¦å·è¡¨åˆå§‹åŒ–è¿‡ç¨‹

#### **SymbolTable::create_table()å®ç°**

```cpp
// ç¬¦å·è¡¨åˆ›å»ºçš„è¯¦ç»†è¿‡ç¨‹
void SymbolTable::create_table() {
  assert(_the_table == NULL, "One symbol table allowed.");
  
  // 1. è®¡ç®—åˆå§‹è¡¨å¤§å°
  size_t start_size = SymbolTableSize;  // é»˜è®¤20011ï¼ˆè´¨æ•°ï¼‰
  
  // 2. åˆ›å»ºç¬¦å·è¡¨å®ä¾‹
  _the_table = new SymbolTable();
  
  // 3. åˆå§‹åŒ–å“ˆå¸Œè¡¨ç»“æ„
  _the_table->initialize(start_size, sizeof(HashtableEntry<Symbol*, mtSymbol>));
  
  // 4. åˆå§‹åŒ–å…±äº«ç¬¦å·è¡¨ï¼ˆå¦‚æœä½¿ç”¨CDSï¼‰
  if (UseSharedSpaces) {
    _shared_table.reset();  // å‡†å¤‡æ¥æ”¶å…±äº«ç¬¦å·
    _lookup_shared_first = true;
  }
  
  // 5. é¢„åˆ†é…ä¸€äº›æ ¸å¿ƒç¬¦å·
  initialize_well_known_symbols();
}
```

#### **æ ¸å¿ƒç¬¦å·çš„é¢„åˆ†é…**

```cpp
// é¢„åˆ†é…çš„æ ¸å¿ƒç¬¦å·
void SymbolTable::initialize_well_known_symbols() {
  // Javaæ ¸å¿ƒç±»å
  vmSymbols::_java_lang_Object = lookup("java/lang/Object", THREAD);
  vmSymbols::_java_lang_Class = lookup("java/lang/Class", THREAD);
  vmSymbols::_java_lang_String = lookup("java/lang/String", THREAD);
  vmSymbols::_java_lang_Thread = lookup("java/lang/Thread", THREAD);
  
  // åŸºæœ¬ç±»å‹åç§°
  vmSymbols::_int = lookup("int", THREAD);
  vmSymbols::_boolean = lookup("boolean", THREAD);
  vmSymbols::_byte = lookup("byte", THREAD);
  vmSymbols::_char = lookup("char", THREAD);
  
  // å¸¸ç”¨æ–¹æ³•å
  vmSymbols::_init_ = lookup("<init>", THREAD);
  vmSymbols::_clinit_ = lookup("<clinit>", THREAD);
  vmSymbols::_main = lookup("main", THREAD);
  vmSymbols::_run = lookup("run", THREAD);
  
  // å¸¸ç”¨æ–¹æ³•ç­¾å
  vmSymbols::_void_method_signature = lookup("()V", THREAD);
  vmSymbols::_object_void_signature = lookup("(Ljava/lang/Object;)V", THREAD);
  
  // è®¾ç½®ä¸ºæ°¸ä¹…ç¬¦å·ï¼ˆæ°¸ä¸å›æ”¶ï¼‰
  vmSymbols::_java_lang_Object->set_permanent();
  vmSymbols::_java_lang_Class->set_permanent();
  // ... å…¶ä»–æ ¸å¿ƒç¬¦å·ä¹Ÿè®¾ç½®ä¸ºæ°¸ä¹…
}
```

## ğŸ”§ ç¬¬äºŒéƒ¨åˆ†ï¼šå­—ç¬¦ä¸²è¡¨ï¼ˆStringTableï¼‰æ¶æ„

### 2.1 å­—ç¬¦ä¸²è¡¨è®¾è®¡ç›®æ ‡

å­—ç¬¦ä¸²è¡¨ç®¡ç†Javaå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **å­—ç¬¦ä¸²å¸¸é‡æ± **ï¼šå­˜å‚¨æ‰€æœ‰å­—ç¬¦ä¸²å­—é¢é‡
2. **å­—ç¬¦ä¸²å»é‡**ï¼šç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²åªä¿ç•™ä¸€ä¸ªå®ä¾‹
3. **å¼±å¼•ç”¨ç®¡ç†**ï¼šæ”¯æŒå­—ç¬¦ä¸²çš„åƒåœ¾æ”¶é›†
4. **é«˜æ€§èƒ½æŸ¥æ‰¾**ï¼šå¿«é€Ÿçš„å­—ç¬¦ä¸²æŸ¥æ‰¾å’Œæ’å…¥
5. **å†…å­˜ä¼˜åŒ–**ï¼šå‡å°‘é‡å¤å­—ç¬¦ä¸²çš„å†…å­˜å ç”¨

### 2.2 StringTableæ ¸å¿ƒç»“æ„

```cpp
// StringTableçš„å®ç°
class StringTable : public RehashableHashtable<oop, mtSymbol> {
  friend class VMStructs;
  friend class StringTableLookupOop;

private:
  // å…¨å±€å”¯ä¸€çš„å­—ç¬¦ä¸²è¡¨å®ä¾‹
  static StringTable* _the_table;
  
  // å…±äº«å­—ç¬¦ä¸²è¡¨ï¼ˆCDSæ”¯æŒï¼‰
  static CompactHashtable<oop, char> _shared_table;
  static bool _shared_string_mapped;
  
  // ç»Ÿè®¡ä¿¡æ¯
  static int _symbols_removed;
  static int _symbols_counted;
  
  // å¼±å¼•ç”¨å¤„ç†
  static OopStorage* _weak_handles;

public:
  // è¡¨åˆ›å»ºå’Œåˆå§‹åŒ–
  static void create_table();
  static void initialize();
  
  // å­—ç¬¦ä¸²æŸ¥æ‰¾å’Œåˆ›å»º
  static oop lookup(Symbol* symbol);
  static oop lookup(jchar* chars, int length);
  static oop intern(Handle string_or_null, jchar* chars, int length, TRAPS);
  static oop intern(Symbol* symbol, TRAPS);
  static oop intern(oop string, TRAPS);
  
  // å…±äº«å­—ç¬¦ä¸²æ”¯æŒï¼ˆCDSï¼‰
  static oop lookup_shared(jchar* name, int len, unsigned int hash);
  static void copy_shared_string_table(CompactHashtable<oop, char>* ch_table);
  
  // å¼±å¼•ç”¨æ¸…ç†
  static void unlink_or_oops_do(BoolObjectClosure* is_alive, 
                               OopClosure* f, int* processed, int* removed);
  static void possibly_parallel_unlink(OopStorage::ParState<false, false>* par_state,
                                      BoolObjectClosure* is_alive, 
                                      int* processed, int* removed);
  
  // ç»Ÿè®¡å’Œè°ƒè¯•
  static void print_histogram() PRODUCT_RETURN;
  static void dump(outputStream* st, bool verbose = false);
  
private:
  // å­—ç¬¦ä¸²æ·»åŠ 
  oop basic_add(int index, Handle string_or_null, jchar* name, int len,
               unsigned int hashValue, TRAPS);
};
```

## ğŸ“Š æ€§èƒ½åˆ†æä¸ä¼˜åŒ–æ•ˆæœ

### 3.1 ç¬¦å·è¡¨æ€§èƒ½æ•°æ®

#### **ç¬¦å·è¡¨åŸºå‡†æµ‹è¯•ç»“æœï¼ˆ8GBå †ç¯å¢ƒï¼‰**

```
ç¬¦å·è¡¨æ€§èƒ½åŸºå‡†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹        â”‚ å¹³å‡å»¶è¿Ÿ    â”‚ ååé‡        â”‚ è¯´æ˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¦å·æŸ¥æ‰¾(å‘½ä¸­)  â”‚ ~50ns       â”‚ 20M ops/s     â”‚ å“ˆå¸Œè¡¨æŸ¥æ‰¾    â”‚
â”‚ ç¬¦å·æŸ¥æ‰¾(æœªå‘½ä¸­)â”‚ ~80ns       â”‚ 12M ops/s     â”‚ éœ€è¦éå†æ¡¶    â”‚
â”‚ ç¬¦å·åˆ›å»º        â”‚ ~200ns      â”‚ 5M ops/s      â”‚ åŒ…å«åˆ†é…å¼€é”€  â”‚
â”‚ ç¬¦å·å›æ”¶        â”‚ ~100ns      â”‚ 10M ops/s     â”‚ å¼•ç”¨è®¡æ•°å‡å°‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜ä½¿ç”¨æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶            â”‚ å†…å­˜å ç”¨    â”‚ ç¬¦å·æ•°é‡      â”‚ å¹³å‡å¤§å°      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¦å·è¡¨ç»“æ„      â”‚ ~800KB      â”‚ -             â”‚ -             â”‚
â”‚ æ ¸å¿ƒç¬¦å·        â”‚ ~2MB        â”‚ ~8000         â”‚ ~25å­—èŠ‚       â”‚
â”‚ åº”ç”¨ç¬¦å·        â”‚ ~10MB       â”‚ ~30000        â”‚ ~35å­—èŠ‚       â”‚
â”‚ æ€»è®¡            â”‚ ~13MB       â”‚ ~38000        â”‚ ~34å­—èŠ‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å­—ç¬¦ä¸²è¡¨æ€§èƒ½æ•°æ®

#### **å­—ç¬¦ä¸²è¡¨åŸºå‡†æµ‹è¯•ç»“æœ**

```
å­—ç¬¦ä¸²è¡¨æ€§èƒ½åŸºå‡†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹        â”‚ å¹³å‡å»¶è¿Ÿ    â”‚ ååé‡        â”‚ è¯´æ˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­—ç¬¦ä¸²æŸ¥æ‰¾      â”‚ ~100ns      â”‚ 10M ops/s     â”‚ åŒ…å«å­—ç¬¦ä¸²æ¯”è¾ƒâ”‚
â”‚ å­—ç¬¦ä¸²intern    â”‚ ~300ns      â”‚ 3M ops/s      â”‚ åŒ…å«å¯¹è±¡åˆ›å»º  â”‚
â”‚ å¼±å¼•ç”¨æ¸…ç†      â”‚ ~50ns       â”‚ 20M ops/s     â”‚ GCæœŸé—´æ‰§è¡Œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜ä½¿ç”¨æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶            â”‚ å†…å­˜å ç”¨    â”‚ å­—ç¬¦ä¸²æ•°é‡    â”‚ å»é‡æ•ˆæœ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­—ç¬¦ä¸²è¡¨ç»“æ„    â”‚ ~2MB        â”‚ -             â”‚ -             â”‚
â”‚ å¼±å¼•ç”¨å­˜å‚¨      â”‚ ~1MB        â”‚ ~50000        â”‚ -             â”‚
â”‚ å­—ç¬¦ä¸²å¯¹è±¡      â”‚ ~20MB       â”‚ ~50000        â”‚ 30-50%èŠ‚çœ    â”‚
â”‚ æ€»è®¡            â”‚ ~23MB       â”‚ ~50000        â”‚ -             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 CDSä¼˜åŒ–æ•ˆæœ

#### **CDSæ¨¡å¼æ€§èƒ½æå‡**

```
CDSå…±äº«è¡¨æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡            â”‚ æ ‡å‡†æ¨¡å¼    â”‚ CDSæ¨¡å¼       â”‚ æå‡å¹…åº¦      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯åŠ¨æ—¶é—´        â”‚ åŸºå‡†        â”‚ -50~80%       â”‚ æ˜¾è‘—æå‡      â”‚
â”‚ ç¬¦å·åˆ›å»ºæ—¶é—´    â”‚ åŸºå‡†        â”‚ -90%          â”‚ å¤§éƒ¨åˆ†é¢„åˆ›å»º  â”‚
â”‚ å†…å­˜å ç”¨        â”‚ åŸºå‡†        â”‚ -30~50%       â”‚ å…±äº«å‡å°‘å ç”¨  â”‚
â”‚ ç¼“å­˜å‘½ä¸­ç‡      â”‚ 85%         â”‚ 95%           â”‚ è¿ç»­å†…å­˜å¸ƒå±€  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CDSå­˜æ¡£å¤§å°åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶            â”‚ å¤§å°        â”‚ ç¬¦å·/å­—ç¬¦ä¸²æ•° â”‚ å‹ç¼©ç‡        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…±äº«ç¬¦å·è¡¨      â”‚ ~5MB        â”‚ ~8000         â”‚ 60%           â”‚
â”‚ å…±äº«å­—ç¬¦ä¸²è¡¨    â”‚ ~3MB        â”‚ ~2000         â”‚ 70%           â”‚
â”‚ å‹ç¼©å“ˆå¸Œè¡¨      â”‚ ~1MB        â”‚ -             â”‚ 80%           â”‚
â”‚ æ€»è®¡            â”‚ ~9MB        â”‚ ~10000        â”‚ 65%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸å·¥ç¨‹æ™ºæ…§

### 4.1 äº«å…ƒæ¨¡å¼åœ¨ç¬¦å·ç®¡ç†ä¸­çš„åº”ç”¨

```cpp
// ç¬¦å·è¡¨å®ç°äº†ç»å…¸çš„äº«å…ƒæ¨¡å¼
class SymbolFlyweightPattern {
public:
  // äº«å…ƒå·¥å‚
  static Symbol* get_symbol(const char* name, int len) {
    // 1. æŸ¥æ‰¾ç°æœ‰ç¬¦å·
    Symbol* existing = SymbolTable::lookup_only(name, len);
    if (existing != NULL) {
      existing->increment_refcount();  // å¢åŠ å¼•ç”¨è®¡æ•°
      return existing;                 // è¿”å›å…±äº«å®ä¾‹
    }
    
    // 2. åˆ›å»ºæ–°ç¬¦å·
    return SymbolTable::new_symbol(name, len, THREAD);
  }
  
  // äº«å…ƒå›æ”¶
  static void release_symbol(Symbol* sym) {
    sym->decrement_refcount();
    if (sym->refcount() == 0 && !sym->is_permanent()) {
      SymbolTable::unlink_symbol(sym);  // ä»è¡¨ä¸­ç§»é™¤
    }
  }
  
  // è®¾è®¡ä¼˜åŠ¿ï¼š
  // 1. å†…å­˜æ•ˆç‡ï¼šç›¸åŒç¬¦å·åªå­˜å‚¨ä¸€ä»½
  // 2. æ¯”è¾ƒæ•ˆç‡ï¼šç¬¦å·æ¯”è¾ƒå˜æˆæŒ‡é’ˆæ¯”è¾ƒ
  // 3. ç¼“å­˜å‹å¥½ï¼šå‡å°‘å†…å­˜è®¿é—®
};
```

### 4.2 å¼±å¼•ç”¨æ¨¡å¼åœ¨å­—ç¬¦ä¸²ç®¡ç†ä¸­çš„åº”ç”¨

```cpp
// å­—ç¬¦ä¸²è¡¨ä½¿ç”¨å¼±å¼•ç”¨æ¨¡å¼ç®¡ç†å­—ç¬¦ä¸²ç”Ÿå‘½å‘¨æœŸ
class StringWeakReferencePattern {
public:
  // å¼±å¼•ç”¨å­˜å‚¨
  static void store_weak_reference(oop string_oop) {
    oop* weak_handle = StringTable::weak_storage()->allocate();
    *weak_handle = string_oop;
    
    // ä¼˜åŠ¿ï¼šå…è®¸GCå›æ”¶ä¸å†ä½¿ç”¨çš„å­—ç¬¦ä¸²
  }
  
  // å¼±å¼•ç”¨è®¿é—®
  static oop access_weak_reference(oop* weak_handle) {
    oop string_oop = *weak_handle;
    if (string_oop == NULL) {
      // å­—ç¬¦ä¸²å·²è¢«GCå›æ”¶
      return NULL;
    }
    return string_oop;
  }
  
  // GCé›†æˆ
  static void gc_cleanup(BoolObjectClosure* is_alive) {
    // GCæœŸé—´æ¸…ç†æ­»äº¡å­—ç¬¦ä¸²çš„å¼±å¼•ç”¨
    StringTable::unlink_or_oops_do(is_alive, NULL, NULL, NULL);
  }
  
  // è®¾è®¡ä¼˜åŠ¿ï¼š
  // 1. è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼šä¸å†ä½¿ç”¨çš„å­—ç¬¦ä¸²è‡ªåŠ¨å›æ”¶
  // 2. é˜²æ­¢å†…å­˜æ³„æ¼ï¼šé¿å…å­—ç¬¦ä¸²å¸¸é‡æ± æ— é™å¢é•¿
  // 3. GCå‹å¥½ï¼šä¸åƒåœ¾æ”¶é›†å™¨ç´§å¯†é›†æˆ
};
```

### 4.3 å•ä¾‹æ¨¡å¼åœ¨å…¨å±€è¡¨ç®¡ç†ä¸­çš„åº”ç”¨

```cpp
// ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨éƒ½ä½¿ç”¨å•ä¾‹æ¨¡å¼
class GlobalTableSingleton {
public:
  // ç¬¦å·è¡¨å•ä¾‹
  static SymbolTable* symbol_table() {
    assert(_the_table != NULL, "SymbolTable not initialized");
    return _the_table;
  }
  
  // å­—ç¬¦ä¸²è¡¨å•ä¾‹
  static StringTable* string_table() {
    assert(_the_table != NULL, "StringTable not initialized");
    return _the_table;
  }
  
  // çº¿ç¨‹å®‰å…¨åˆå§‹åŒ–
  static void initialize_tables() {
    // åœ¨å•çº¿ç¨‹åˆå§‹åŒ–é˜¶æ®µå®Œæˆï¼Œæ— éœ€åŒæ­¥
    SymbolTable::create_table();
    StringTable::create_table();
  }
  
  // è®¾è®¡ä¼˜åŠ¿ï¼š
  // 1. å…¨å±€å”¯ä¸€ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨
  // 2. å»¶è¿Ÿåˆå§‹åŒ–ï¼šåœ¨éœ€è¦æ—¶æ‰åˆ›å»º
  // 3. çº¿ç¨‹å®‰å…¨ï¼šåˆå§‹åŒ–ååªè¯»è®¿é—®
};
```

## ğŸš€ å®é™…åº”ç”¨åœºæ™¯ä¸ä¼˜åŒ–å»ºè®®

### 5.1 ç¬¦å·è¡¨ä¼˜åŒ–ç­–ç•¥

#### **å“ˆå¸Œè¡¨è°ƒä¼˜**

```cpp
// ç¬¦å·è¡¨å“ˆå¸Œä¼˜åŒ–ç­–ç•¥
class SymbolTableOptimization {
public:
  // è¡¨å¤§å°è°ƒä¼˜
  static void tune_table_size() {
    // æ ¹æ®åº”ç”¨ç‰¹å¾è°ƒæ•´è¡¨å¤§å°
    // -XX:SymbolTableSize=<size>
    // æ¨èï¼šç±»æ•°é‡ * 10ï¼ˆè€ƒè™‘æ–¹æ³•åã€å­—æ®µåç­‰ï¼‰
  }
  
  // è´Ÿè½½å› å­æ§åˆ¶
  static void control_load_factor() {
    // å½“è´Ÿè½½å› å­ > 0.75æ—¶è§¦å‘é‡å“ˆå¸Œ
    // å¹³è¡¡å†…å­˜ä½¿ç”¨å’ŒæŸ¥æ‰¾æ€§èƒ½
  }
  
  // é¢„åˆ†é…ç­–ç•¥
  static void preallocation_strategy() {
    // é¢„åˆ†é…æ ¸å¿ƒç¬¦å·ï¼Œå‡å°‘å¯åŠ¨æ—¶çš„ç¬¦å·åˆ›å»ºå¼€é”€
    // ç‰¹åˆ«æ˜¯æ¡†æ¶å’Œåº“çš„å¸¸ç”¨ç¬¦å·
  }
};
```

### 5.2 å­—ç¬¦ä¸²è¡¨ä¼˜åŒ–ç­–ç•¥

#### **å­—ç¬¦ä¸²å»é‡ä¼˜åŒ–**

```cpp
// å­—ç¬¦ä¸²è¡¨å»é‡ä¼˜åŒ–
class StringTableDeduplication {
public:
  // å¯ç”¨å­—ç¬¦ä¸²å»é‡
  static void enable_string_deduplication() {
    // -XX:+UseStringDeduplication
    // åœ¨G1 GCä¸­è‡ªåŠ¨å»é‡ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²
  }
  
  // è°ƒæ•´å»é‡é˜ˆå€¼
  static void tune_deduplication_threshold() {
    // -XX:StringDeduplicationAgeThreshold=3
    // åªå¯¹ç»è¿‡å‡ æ¬¡GCçš„å­—ç¬¦ä¸²è¿›è¡Œå»é‡
  }
  
  // ç›‘æ§å»é‡æ•ˆæœ
  static void monitor_deduplication() {
    // jstat -gc æŸ¥çœ‹å­—ç¬¦ä¸²å»é‡ç»Ÿè®¡
    // å…¸å‹æ•ˆæœï¼š10-30%çš„å­—ç¬¦ä¸²å†…å­˜èŠ‚çœ
  }
};
```

### 5.3 CDSä½¿ç”¨å»ºè®®

#### **CDSæœ€ä½³å®è·µ**

```cpp
// CDSä½¿ç”¨æœ€ä½³å®è·µ
class CDSBestPractices {
public:
  // ç”Ÿæˆåº”ç”¨ç‰¹å®šçš„CDSå­˜æ¡£
  static void create_application_cds() {
    // 1. è¿è¡Œåº”ç”¨æ”¶é›†ç±»åˆ—è¡¨
    // java -XX:+UseAppCDS -XX:DumpLoadedClassList=classes.lst MyApp
    
    // 2. ç”ŸæˆCDSå­˜æ¡£
    // java -XX:+UseAppCDS -XX:SharedClassListFile=classes.lst 
    //      -XX:SharedArchiveFile=app.jsa -Xshare:dump
    
    // 3. ä½¿ç”¨CDSå­˜æ¡£è¿è¡Œ
    // java -XX:+UseAppCDS -XX:SharedArchiveFile=app.jsa -Xshare:on MyApp
  }
  
  // CDSæ•ˆæœè¯„ä¼°
  static void evaluate_cds_benefits() {
    // å¯åŠ¨æ—¶é—´ï¼šé€šå¸¸å‡å°‘20-50%
    // å†…å­˜å ç”¨ï¼šå‡å°‘10-30%
    // é€‚ç”¨åœºæ™¯ï¼šå¾®æœåŠ¡ã€å®¹å™¨åŒ–éƒ¨ç½²
  }
};
```

## ğŸ‰ æ€»ç»“ï¼šç¬¦å·è¡¨ä¸å­—ç¬¦ä¸²è¡¨çš„æ ¸å¿ƒä»·å€¼

### æ ¸å¿ƒä»·å€¼

1. **ç»Ÿä¸€ç¬¦å·ç®¡ç†**ï¼šå…¨å±€å”¯ä¸€çš„ç¬¦å·å­˜å‚¨å’ŒæŸ¥æ‰¾æœºåˆ¶
2. **é«˜æ•ˆå­—ç¬¦ä¸²å»é‡**ï¼šæ˜¾è‘—å‡å°‘é‡å¤å­—ç¬¦ä¸²çš„å†…å­˜å ç”¨
3. **CDSé›†æˆä¼˜åŒ–**ï¼šé€šè¿‡å…±äº«å­˜æ¡£å¤§å¹…æå‡å¯åŠ¨æ€§èƒ½
4. **GCå‹å¥½è®¾è®¡**ï¼šå¼±å¼•ç”¨æœºåˆ¶æ”¯æŒè‡ªåŠ¨å†…å­˜å›æ”¶

### è®¾è®¡äº®ç‚¹

1. **äº«å…ƒæ¨¡å¼**ï¼šç¬¦å·çš„é«˜æ•ˆå…±äº«å’Œå¼•ç”¨è®¡æ•°ç®¡ç†
2. **å¼±å¼•ç”¨æ¨¡å¼**ï¼šå­—ç¬¦ä¸²çš„è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
3. **åˆ†å±‚æŸ¥æ‰¾**ï¼šCDSå…±äº«è¡¨ + è¿è¡Œæ—¶è¡¨çš„ä¼˜åŒ–æŸ¥æ‰¾ç­–ç•¥
4. **å¹¶å‘å®‰å…¨**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨è®¿é—®æœºåˆ¶

### æ€§èƒ½ç‰¹å¾

- **ç¬¦å·è¡¨å¼€é”€**ï¼š~13MBï¼ˆå…¸å‹åº”ç”¨ï¼‰
- **å­—ç¬¦ä¸²è¡¨å¼€é”€**ï¼š~23MBï¼ˆå…¸å‹åº”ç”¨ï¼‰
- **æŸ¥æ‰¾æ€§èƒ½**ï¼š50-100nså¹³å‡å»¶è¿Ÿ
- **CDSä¼˜åŒ–æ•ˆæœ**ï¼š50-80%å¯åŠ¨æ—¶é—´æå‡

ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨çš„åˆå§‹åŒ–å»ºç«‹äº†JVMè¿è¡Œæ—¶çš„æ ¸å¿ƒæŸ¥æ‰¾åŸºç¡€è®¾æ–½ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å“ˆå¸Œè¡¨ç»“æ„ã€å¼•ç”¨è®¡æ•°æœºåˆ¶å’ŒCDSé›†æˆï¼Œå®ƒä»¬ä¸ºåç»­çš„ç±»åŠ è½½ã€æ–¹æ³•è°ƒç”¨å’Œå­—ç¬¦ä¸²æ“ä½œæä¾›äº†é«˜æ•ˆã€å¯é çš„æ”¯æ’‘ã€‚è¿™äº›å…¨å±€è¡¨çš„ä¼˜åŒ–ç›´æ¥å½±å“JVMçš„æ•´ä½“æ€§èƒ½ï¼Œæ˜¯ç†è§£JVMå†…éƒ¨æœºåˆ¶çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 ç¬¦å·è¡¨ä¸å­—ç¬¦ä¸²è¡¨åˆå§‹åŒ–  
**ä»£ç è·¯å¾„**: `src/hotspot/share/memory/universe.cpp:727-747`