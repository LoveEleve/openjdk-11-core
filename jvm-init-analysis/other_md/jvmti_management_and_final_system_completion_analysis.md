# JVMTIç”Ÿå‘½å‘¨æœŸã€ç®¡ç†æ¥å£ä¸ç³»ç»Ÿå®Œæˆæ·±åº¦åˆ†æ

## ğŸ“‹ **æ¦‚è¿°**

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMæœ€ç»ˆåˆå§‹åŒ–é˜¶æ®µçš„ååŠéƒ¨åˆ†ï¼Œé‡ç‚¹å…³æ³¨JVMTIç”Ÿå‘½å‘¨æœŸç®¡ç†ã€JMXç®¡ç†æ¥å£ã€å„ç§ç›‘æ§æœºåˆ¶ã€ä»¥åŠJVMçš„æœ€ç»ˆå®Œæˆè¿‡ç¨‹ã€‚è¿™æ˜¯JVMä»åˆå§‹åŒ–çŠ¶æ€è½¬å‘å®Œå…¨è¿è¡ŒçŠ¶æ€çš„å…³é”®é˜¶æ®µã€‚

### **åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (ä¸ä½¿ç”¨å¤§é¡µ)
- **JVMç‰ˆæœ¬**: OpenJDK 11
- **ç®¡ç†ç‰¹æ€§**: é»˜è®¤å¯ç”¨JMXã€JFRç­‰

---

## ğŸ”§ **JVMTIç”Ÿå‘½å‘¨æœŸç®¡ç†**

### **1. JVMTIé˜¶æ®µè½¬æ¢è¯¦è§£**

JVMTI (JVM Tool Interface) ä½¿ç”¨ä¸¥æ ¼çš„é˜¶æ®µæ¨¡å‹æ¥ç®¡ç†å·¥å…·å’Œä»£ç†çš„ç”Ÿå‘½å‘¨æœŸï¼š

```cpp
// JVMTIé˜¶æ®µè½¬æ¢åºåˆ—
JvmtiExport::enter_start_phase();        // è¿›å…¥STARTé˜¶æ®µ
JvmtiExport::post_vm_start();            // å‘é€VM_STARTäº‹ä»¶

// ... ç³»ç»Ÿåˆå§‹åŒ– ...

JvmtiExport::enter_live_phase();         // è¿›å…¥LIVEé˜¶æ®µ  
JvmtiExport::post_vm_initialized();      // å‘é€VM_INITäº‹ä»¶
```

#### **1.1 JVMTIé˜¶æ®µçŠ¶æ€æœº**

```
JVMTIé˜¶æ®µçŠ¶æ€è½¬æ¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ONLOAD                                                      â”‚
â”‚   â†“ (Agent_OnLoadè°ƒç”¨)                                     â”‚
â”‚ PRIMORDIAL                                                  â”‚
â”‚   â†“ (VMåŸºç¡€åˆå§‹åŒ–å®Œæˆ)                                      â”‚
â”‚ EARLY_START                                                 â”‚
â”‚   â†“ (Javaç±»åˆå§‹åŒ–å®Œæˆ)                                      â”‚
â”‚ START â† å½“å‰è¿›å…¥ç‚¹                                          â”‚
â”‚   â†“ (ç¼–è¯‘å™¨å’Œæ¨¡å—ç³»ç»Ÿå°±ç»ª)                                  â”‚
â”‚ LIVE â† ç›®æ ‡çŠ¶æ€                                             â”‚
â”‚   â†“ (VMå…³é—­æ—¶)                                              â”‚
â”‚ DEAD                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 å„é˜¶æ®µå¯ç”¨åŠŸèƒ½**

```
JVMTIåŠŸèƒ½å¯ç”¨æ€§çŸ©é˜µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠŸèƒ½ç±»åˆ«            â”‚ STARTé˜¶æ®µ   â”‚ LIVEé˜¶æ®µ    â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç±»äº‹ä»¶ç›‘å¬          â”‚ âœ“          â”‚ âœ“           â”‚ å®Œå…¨æ”¯æŒ   â”‚
â”‚ æ–¹æ³•äº‹ä»¶ç›‘å¬        â”‚ âœ“          â”‚ âœ“           â”‚ å®Œå…¨æ”¯æŒ   â”‚
â”‚ çº¿ç¨‹äº‹ä»¶ç›‘å¬        â”‚ âœ“          â”‚ âœ“           â”‚ å®Œå…¨æ”¯æŒ   â”‚
â”‚ å¼‚å¸¸äº‹ä»¶ç›‘å¬        â”‚ âœ“          â”‚ âœ“           â”‚ å®Œå…¨æ”¯æŒ   â”‚
â”‚ GCäº‹ä»¶ç›‘å¬          â”‚ âœ“          â”‚ âœ“           â”‚ å®Œå…¨æ”¯æŒ   â”‚
â”‚ å †éå†              â”‚ âœ—          â”‚ âœ“           â”‚ LIVEé˜¶æ®µå â”‚
â”‚ å¯¹è±¡æ ‡è®°            â”‚ âœ—          â”‚ âœ“           â”‚ LIVEé˜¶æ®µå â”‚
â”‚ å­—èŠ‚ç é‡å†™          â”‚ âœ“          â”‚ âœ“           â”‚ å—é™åˆ¶     â”‚
â”‚ ç±»é‡å®šä¹‰            â”‚ âœ—          â”‚ âœ“           â”‚ LIVEé˜¶æ®µå â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2. JVMTIäº‹ä»¶å¤„ç†æœºåˆ¶**

#### **2.1 VM_STARTäº‹ä»¶å¤„ç†**

```cpp
void JvmtiExport::post_vm_start() {
    EVT_TRIG_TRACE(JVMTI_EVENT_VM_START, ("VM Start event triggered"));
    
    // å¯ç”¨VMå¯åŠ¨ç›¸å…³çš„äº‹ä»¶æ§åˆ¶
    JvmtiEventController::vm_start();
    
    // éå†æ‰€æœ‰JVMTIç¯å¢ƒ
    JvmtiEnvIterator it;
    for (JvmtiEnv* env = it.first(); env != NULL; env = it.next(env)) {
        if (env->is_enabled(JVMTI_EVENT_VM_START)) {
            // è°ƒç”¨ä»£ç†çš„VM_STARTå›è°ƒ
            JvmtiThreadEventMark jem(JavaThread::current());
            JvmtiJavaThreadEventTransition jet(JavaThread::current());
            jvmtiEventVMStart callback = env->callbacks()->VMStart;
            if (callback != NULL) {
                (*callback)(env->jvmti_env(), jem.jni_env());
            }
        }
    }
}
```

#### **2.2 VM_INITäº‹ä»¶å¤„ç†**

```cpp
void JvmtiExport::post_vm_initialized() {
    EVT_TRIG_TRACE(JVMTI_EVENT_VM_INIT, ("VM Init event triggered"));
    
    // é€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„JVMTIç¯å¢ƒ
    JvmtiEnvIterator it;
    for (JvmtiEnv* env = it.first(); env != NULL; env = it.next(env)) {
        if (env->is_enabled(JVMTI_EVENT_VM_INIT)) {
            JvmtiThreadEventMark jem(JavaThread::current());
            JvmtiJavaThreadEventTransition jet(JavaThread::current());
            jvmtiEventVMInit callback = env->callbacks()->VMInit;
            if (callback != NULL) {
                (*callback)(env->jvmti_env(), jem.jni_env(), jem.jni_thread());
            }
        }
    }
}
```

### **3. JVMTIæ€§èƒ½å½±å“åˆ†æ**

#### **3.1 äº‹ä»¶å¤„ç†å¼€é”€**

```
JVMTIäº‹ä»¶å¤„ç†æ€§èƒ½å¼€é”€ (8GBå †ç¯å¢ƒ)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶ç±»å‹                â”‚ æ— ä»£ç†      â”‚ æœ‰ä»£ç†      â”‚ å¼€é”€   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–¹æ³•è¿›å…¥/é€€å‡º           â”‚ 0ns         â”‚ 50-200ns    â”‚ é«˜     â”‚
â”‚ ç±»åŠ è½½äº‹ä»¶              â”‚ 0ns         â”‚ 10-50ns     â”‚ ä¸­     â”‚
â”‚ çº¿ç¨‹å¯åŠ¨/ç»“æŸ           â”‚ 0ns         â”‚ 5-20ns      â”‚ ä½     â”‚
â”‚ GCå¼€å§‹/ç»“æŸ             â”‚ 0ns         â”‚ 2-10ns      â”‚ ä½     â”‚
â”‚ å¼‚å¸¸æŠ›å‡º/æ•è·           â”‚ 0ns         â”‚ 20-100ns    â”‚ ä¸­     â”‚
â”‚ å­—æ®µè®¿é—®/ä¿®æ”¹           â”‚ 0ns         â”‚ 30-150ns    â”‚ é«˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **JMXç®¡ç†æ¥å£åˆå§‹åŒ–**

### **1. Management Agentå¯åŠ¨**

```cpp
#if INCLUDE_MANAGEMENT
Management::initialize(THREAD);

if (HAS_PENDING_EXCEPTION) {
    // ç®¡ç†ä»£ç†å¯åŠ¨å¤±è´¥ï¼Œé€šå¸¸ç”±äºé…ç½®é—®é¢˜
    // è´Ÿè´£æ‰“å°å †æ ˆè·Ÿè¸ªï¼Œç„¶åé€€å‡ºVM
    vm_exit(1);
}
#endif // INCLUDE_MANAGEMENT
```

#### **1.1 Managementå­ç³»ç»Ÿæ¶æ„**

```
JMXç®¡ç†æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JMX MBean Server                        â”‚
â”‚                         â†‘                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚                    â”‚                    â”‚              â”‚
â”‚ Platform        Runtime            Memory                   â”‚
â”‚ MXBeans         MXBean             MXBean                   â”‚
â”‚    â”‚               â”‚                 â”‚                      â”‚
â”‚ â”Œâ”€â”€â”´â”€â”€â”         â”Œâ”€â”€â”´â”€â”€â”           â”Œâ”€â”€â”´â”€â”€â”                   â”‚
â”‚ â”‚Threadâ”‚        â”‚Runtimeâ”‚         â”‚Memoryâ”‚                  â”‚
â”‚ â”‚GC    â”‚        â”‚Compilerâ”‚        â”‚Pool  â”‚                  â”‚
â”‚ â”‚Class â”‚        â”‚OS      â”‚        â”‚Managerâ”‚                 â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 æ ¸å¿ƒMXBeanåˆå§‹åŒ–**

```cpp
void Management::initialize(TRAPS) {
    // åˆå§‹åŒ–ç®¡ç†å·¥å‚
    initialize_management_factory(CHECK);
    
    // æ³¨å†Œå¹³å°MXBeans
    register_platform_mbeans(CHECK);
    
    // å¯åŠ¨JMXè¿æ¥å™¨ (å¦‚æœé…ç½®)
    start_jmx_connector(CHECK);
    
    // åˆå§‹åŒ–è¯Šæ–­å‘½ä»¤
    initialize_diagnostic_commands(CHECK);
}
```

### **2. å¹³å°MXBeanè¯¦è§£**

#### **2.1 å†…å­˜ç®¡ç†MXBean**

```java
// MemoryMXBeanæä¾›çš„å…³é”®ä¿¡æ¯
public interface MemoryMXBean {
    MemoryUsage getHeapMemoryUsage();      // å †å†…å­˜ä½¿ç”¨æƒ…å†µ
    MemoryUsage getNonHeapMemoryUsage();   // éå †å†…å­˜ä½¿ç”¨æƒ…å†µ
    int getObjectPendingFinalizationCount(); // å¾…ç»ˆç»“å¯¹è±¡æ•°
    void gc();                             // è§¦å‘GC
    void setVerbose(boolean value);        // è®¾ç½®è¯¦ç»†GCæ—¥å¿—
}
```

#### **2.2 çº¿ç¨‹ç®¡ç†MXBean**

```java
// ThreadMXBeanæä¾›çš„ç›‘æ§åŠŸèƒ½
public interface ThreadMXBean {
    int getThreadCount();                  // å½“å‰çº¿ç¨‹æ•°
    int getPeakThreadCount();              // å³°å€¼çº¿ç¨‹æ•°
    long getTotalStartedThreadCount();     // æ€»å¯åŠ¨çº¿ç¨‹æ•°
    ThreadInfo[] getAllThreadInfo();       // æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯
    long[] findDeadlockedThreads();        // æ­»é”æ£€æµ‹
    boolean isThreadCpuTimeSupported();    // CPUæ—¶é—´æ”¯æŒ
}
```

### **3. JMXæ€§èƒ½ç‰¹å¾**

#### **3.1 MXBeanè°ƒç”¨å¼€é”€**

```
MXBeanæ“ä½œæ€§èƒ½å¼€é”€ (8GBå †ç¯å¢ƒ)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹                â”‚ è°ƒç”¨æ—¶é—´    â”‚ é¢‘ç‡é™åˆ¶    â”‚ è¯´æ˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ getHeapMemoryUsage()    â”‚ 10-50Î¼s     â”‚ æ— é™åˆ¶      â”‚ å¿«é€Ÿ   â”‚
â”‚ getThreadCount()        â”‚ 5-20Î¼s      â”‚ æ— é™åˆ¶      â”‚ å¿«é€Ÿ   â”‚
â”‚ getAllThreadInfo()      â”‚ 1-10ms      â”‚ å»ºè®®<1/s    â”‚ æ…¢     â”‚
â”‚ findDeadlockedThreads() â”‚ 5-50ms      â”‚ å»ºè®®<1/10s  â”‚ å¾ˆæ…¢   â”‚
â”‚ gc()                    â”‚ 10-1000ms   â”‚ è°¨æ…ä½¿ç”¨    â”‚ é˜»å¡   â”‚
â”‚ dumpAllThreads()        â”‚ 10-100ms    â”‚ å»ºè®®<1/min  â”‚ æ…¢     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— **ä¿¡å·å¤„ç†ä¸Attachæœºåˆ¶**

### **1. JDKä¿¡å·æ”¯æŒåˆå§‹åŒ–**

```cpp
// ä¿¡å·åˆ†å‘å™¨éœ€è¦åœ¨VMInitäº‹ä»¶å‘é€å‰å¯åŠ¨
os::initialize_jdk_signal_support(CHECK_JNI_ERR);
```

è¿™ä¸ªæ­¥éª¤åˆå§‹åŒ–Javaä¿¡å·å¤„ç†æœºåˆ¶ï¼Œæ”¯æŒï¼š
- SIGTERM/SIGINTä¼˜é›…å…³é—­
- SIGQUITçº¿ç¨‹è½¬å‚¨
- SIGUSR1/SIGUSR2ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†

#### **1.1 Linuxä¿¡å·å¤„ç†æ¶æ„**

```
Linuxä¿¡å·å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ“ä½œç³»ç»Ÿä¿¡å·                                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. JVMä¿¡å·å¤„ç†å™¨ (C++)                                      â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. ä¿¡å·åˆ†å‘çº¿ç¨‹                                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. Javaä¿¡å·å¤„ç†å™¨                                           â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. åº”ç”¨ç¨‹åºå¤„ç†é€»è¾‘                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2. Attach Listeneræœºåˆ¶**

```cpp
// å¯åŠ¨Attach Listener (å¦‚æœå¯ç”¨)
if (!DisableAttachMechanism) {
    AttachListener::vm_start();
    if (StartAttachListener || AttachListener::init_at_startup()) {
        AttachListener::init();
    }
}
```

#### **2.1 Attachæœºåˆ¶æ¶æ„**

```
Attach Listeneræ¶æ„ (Linux)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤–éƒ¨å·¥å…· (jstack, jmap, jcmd)                              â”‚
â”‚    â†“                                                        â”‚
â”‚ Unix Domain Socket                                          â”‚
â”‚ /tmp/.java_pid<PID>                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ AttachListener Thread                                       â”‚
â”‚    â†“                                                        â”‚
â”‚ å‘½ä»¤å¤„ç†å™¨                                                  â”‚
â”‚ - threaddump                                                â”‚
â”‚ - heapdump                                                  â”‚
â”‚ - dumpheap                                                  â”‚
â”‚ - jcmd                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2.2 Attach Listeneråˆå§‹åŒ–**

```cpp
void AttachListener::init() {
    EXCEPTION_MARK;
    
    const char thread_name[] = "Attach Listener";
    Handle string = java_lang_String::create_from_str(thread_name, THREAD);
    if (has_init_error(THREAD)) {
        set_state(AL_NOT_INITIALIZED);
        return;
    }
    
    // åˆ›å»ºçº¿ç¨‹å¯¹è±¡å¹¶åŠ å…¥ç³»ç»Ÿçº¿ç¨‹ç»„
    Handle thread_group (THREAD, Universe::system_thread_group());
    Handle thread_oop = JavaCalls::construct_new_instance(
                         SystemDictionary::Thread_klass(),
                         vmSymbols::threadgroup_string_void_signature(),
                         thread_group, string, THREAD);
    
    // åˆ›å»ºå¹¶å¯åŠ¨AttachListenerçº¿ç¨‹
    AttachListener* listener = new AttachListener();
    listener->set_threadObj(thread_oop());
    Threads::add(listener);
    Thread::start(listener);
}
```

### **3. åŠ¨æ€Attachæ€§èƒ½åˆ†æ**

#### **3.1 Attachæ“ä½œå¼€é”€**

```
Attachæ“ä½œæ€§èƒ½å¼€é”€ (8GBå †ç¯å¢ƒ)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œ                    â”‚ æ—¶é—´        â”‚ å†…å­˜å¼€é”€    â”‚ è¯´æ˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ jstack (çº¿ç¨‹è½¬å‚¨)       â”‚ 50-200ms    â”‚ 1-5MB       â”‚ å¸¸ç”¨   â”‚
â”‚ jmap -histo (ç›´æ–¹å›¾)    â”‚ 100-500ms   â”‚ 2-10MB      â”‚ å¸¸ç”¨   â”‚
â”‚ jmap -dump (å †è½¬å‚¨)     â”‚ 5-30s       â”‚ 8GB+        â”‚ é‡å‹   â”‚
â”‚ jcmd VM.version         â”‚ 5-20ms      â”‚ <1MB        â”‚ è½»é‡   â”‚
â”‚ jcmd GC.run             â”‚ 10-1000ms   â”‚ å˜åŒ–        â”‚ å±é™©   â”‚
â”‚ jcmd Thread.print       â”‚ 50-200ms    â”‚ 1-5MB       â”‚ å¸¸ç”¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§µ **åå°çº¿ç¨‹ä¸ç›‘æ§æœºåˆ¶**

### **1. WatcherThreadå¯åŠ¨**

```cpp
{
    MutexLocker ml(PeriodicTask_lock);
    // ä½¿WatcherThreadå¯ä»¥è¢«å¯åŠ¨
    WatcherThread::make_startable();
    
    // å¦‚æœæœ‰å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå¯åŠ¨WatcherThread
    if (PeriodicTask::num_tasks() > 0) {
        WatcherThread::start();
    }
}
```

#### **1.1 WatcherThreadèŒè´£**

```
WatcherThreadç®¡ç†çš„å‘¨æœŸæ€§ä»»åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡ç±»å‹                â”‚ é—´éš”        â”‚ è¯´æ˜                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ StatSampler             â”‚ 1s          â”‚ æ€§èƒ½ç»Ÿè®¡é‡‡æ ·         â”‚
â”‚ MemoryUsageTracker      â”‚ 1s          â”‚ å†…å­˜ä½¿ç”¨è·Ÿè¸ª         â”‚
â”‚ JniPeriodicChecker      â”‚ 5s          â”‚ JNIè°ƒç”¨æ£€æŸ¥          â”‚
â”‚ BiasedLockingTask       â”‚ 4s          â”‚ åå‘é”å¯ç”¨ (å»¶è¿Ÿ)    â”‚
â”‚ VMOperationTimeout      â”‚ å¯é…ç½®      â”‚ VMæ“ä½œè¶…æ—¶æ£€æµ‹       â”‚
â”‚ GCMemoryManager        â”‚ æŒ‰éœ€        â”‚ GCå†…å­˜ç®¡ç†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 WatcherThreadå®ç°**

```cpp
void WatcherThread::run() {
    assert(this == watcher_thread(), "just checking");
    
    while (true) {
        bool timedout = sleep();
        
        if (is_terminated()) {
            // æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶
            break;
        }
        
        if (timedout) {
            // æ‰§è¡Œæ‰€æœ‰å‘¨æœŸæ€§ä»»åŠ¡
            PeriodicTask::real_time_tick(time_waited);
        }
    }
    
    // æ¸…ç†å¹¶é€šçŸ¥ç»ˆæ­¢
    {
        MutexLockerEx mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
        _watcher_thread = NULL;
        Terminator_lock->notify();
    }
}
```

### **2. æ€§èƒ½ç›‘æ§æœºåˆ¶**

#### **2.1 StatSamplerå¯åŠ¨**

```cpp
if (MemProfiling) MemProfiler::engage();    // å†…å­˜åˆ†æå™¨
StatSampler::engage();                       // ç»Ÿè®¡é‡‡æ ·å™¨
if (CheckJNICalls) JniPeriodicChecker::engage(); // JNIæ£€æŸ¥å™¨
```

#### **2.2 ç›‘æ§æ•°æ®æ”¶é›†**

```
æ€§èƒ½ç›‘æ§æ•°æ®ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®ç±»å‹                â”‚ é‡‡æ ·é¢‘ç‡    â”‚ å­˜å‚¨ä½ç½®            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å †å†…å­˜ä½¿ç”¨              â”‚ 1s          â”‚ PerfData            â”‚
â”‚ GCç»Ÿè®¡ä¿¡æ¯              â”‚ æ¯æ¬¡GC      â”‚ GCMemoryManager     â”‚
â”‚ ç¼–è¯‘å™¨ç»Ÿè®¡              â”‚ 1s          â”‚ CompilerCounters    â”‚
â”‚ çº¿ç¨‹ç»Ÿè®¡                â”‚ 1s          â”‚ ThreadService       â”‚
â”‚ ç±»åŠ è½½ç»Ÿè®¡              â”‚ 1s          â”‚ ClassLoadingService â”‚
â”‚ JITç¼–è¯‘ç»Ÿè®¡             â”‚ æ¯æ¬¡ç¼–è¯‘    â”‚ CompileBroker       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. åå‘é”åˆå§‹åŒ–**

```cpp
BiasedLocking::init();
```

#### **3.1 åå‘é”å»¶è¿Ÿå¯ç”¨æœºåˆ¶**

```cpp
void BiasedLocking::init() {
    if (UseBiasedLocking) {
        if (BiasedLockingStartupDelay > 0) {
            // å»¶è¿Ÿå¯ç”¨åå‘é” (é»˜è®¤4ç§’)
            EnableBiasedLockingTask* task = 
                new EnableBiasedLockingTask(BiasedLockingStartupDelay);
            task->enroll();
        } else {
            // ç«‹å³å¯ç”¨åå‘é”
            VM_EnableBiasedLocking op(false);
            VMThread::execute(&op);
        }
    }
}
```

#### **3.2 åå‘é”æ€§èƒ½å½±å“**

```
åå‘é”æ€§èƒ½ç‰¹å¾ (8GBå †ç¯å¢ƒ)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                    â”‚ æ— åå‘é”    â”‚ æœ‰åå‘é”    â”‚ æ”¹å–„   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•çº¿ç¨‹åŒæ­¥              â”‚ 20ns        â”‚ 2ns         â”‚ 90%    â”‚
â”‚ å¤šçº¿ç¨‹ç«äº‰ (è½»åº¦)       â”‚ 50ns        â”‚ 45ns        â”‚ 10%    â”‚
â”‚ å¤šçº¿ç¨‹ç«äº‰ (é‡åº¦)       â”‚ 200ns       â”‚ 250ns       â”‚ -25%   â”‚
â”‚ åå‘é”æ’¤é”€å¼€é”€          â”‚ 0ns         â”‚ 1000ns      â”‚ N/A    â”‚
â”‚ å¯åŠ¨æ—¶é—´å½±å“            â”‚ 0ms         â”‚ +15ms       â”‚ N/A    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ **ç³»ç»Ÿå®Œæˆä¸éªŒè¯**

### **1. VMåˆå§‹åŒ–å®Œæˆæ ‡è®°**

```cpp
create_vm_timer.end();
#ifdef ASSERT
_vm_complete = true;
#endif
```

è¿™ä¸ªæ ‡è®°è¡¨ç¤ºJVMå·²ç»å®Œå…¨åˆå§‹åŒ–å®Œæˆï¼Œæ‰€æœ‰æ ¸å¿ƒå­ç³»ç»Ÿéƒ½å·²å°±ç»ªã€‚

### **2. CDSè½¬å‚¨å¤„ç†**

```cpp
if (DumpSharedSpaces) {
    MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
    ShouldNotReachHere();  // è½¬å‚¨å®Œæˆåä¸åº”è¯¥ç»§ç»­æ‰§è¡Œ
}
```

#### **2.1 CDSè½¬å‚¨æµç¨‹**

```
CDS (Class Data Sharing) è½¬å‚¨æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é¢„åŠ è½½æ ¸å¿ƒç±»                                             â”‚
â”‚    â†“                                                        â”‚
â”‚ 2. è§£æç±»ä¾èµ–å…³ç³»                                           â”‚
â”‚    â†“                                                        â”‚
â”‚ 3. è®¡ç®—å…±äº«ç©ºé—´å¸ƒå±€                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 4. åºåˆ—åŒ–ç±»å…ƒæ•°æ®                                           â”‚
â”‚    â†“                                                        â”‚
â”‚ 5. å†™å…¥å…±äº«å­˜æ¡£æ–‡ä»¶                                         â”‚
â”‚    â†“                                                        â”‚
â”‚ 6. é€€å‡ºJVM (ä¸ç»§ç»­æ­£å¸¸å¯åŠ¨)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. æœ€ç»ˆè¿”å›çŠ¶æ€**

```cpp
return JNI_OK;  // æˆåŠŸå®ŒæˆVMåˆ›å»º
```

æ‰€æœ‰åˆå§‹åŒ–æ­¥éª¤æˆåŠŸå®Œæˆåï¼Œ`Threads::create_vm()` è¿”å› `JNI_OK`ï¼Œè¡¨ç¤ºJVMå·²ç»å®Œå…¨å°±ç»ªã€‚

---

## ğŸš€ **æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜**

### **1. JVMTIä¼˜åŒ–**

#### **1.1 äº‹ä»¶è¿‡æ»¤ä¼˜åŒ–**

```bash
# å‡å°‘JVMTIäº‹ä»¶å¼€é”€
-XX:+UnlockDiagnosticVMOptions
-XX:+TraceJVMTI                    # è°ƒè¯•JVMTIäº‹ä»¶
-XX:+PrintJVMTIEvents              # æ‰“å°JVMTIäº‹ä»¶

# ç¦ç”¨ä¸éœ€è¦çš„JVMTIåŠŸèƒ½
-XX:-EnableJVMTI                   # å®Œå…¨ç¦ç”¨JVMTI (å¦‚æœä¸éœ€è¦)
```

#### **1.2 ä»£ç†ä¼˜åŒ–å»ºè®®**

```java
// JVMTIä»£ç†ä¼˜åŒ–æœ€ä½³å®è·µ
public class OptimizedAgent {
    // 1. åªå¯ç”¨å¿…éœ€çš„äº‹ä»¶
    jvmti.SetEventNotificationMode(JVMTI_ENABLE, 
                                   JVMTI_EVENT_CLASS_LOAD, null);
    
    // 2. ä½¿ç”¨äº‹ä»¶è¿‡æ»¤
    jvmti.SetEventCallbacks(callbacks, sizeof(callbacks));
    
    // 3. é¿å…åœ¨çƒ­ç‚¹è·¯å¾„ä¸­ä½¿ç”¨é‡å‹æ“ä½œ
    public void methodEntry(jmethodID method) {
        // å¿«é€Ÿæ£€æŸ¥ï¼Œé¿å…å¤æ‚æ“ä½œ
        if (isMonitoredMethod(method)) {
            recordMethodEntry(method);
        }
    }
}
```

### **2. ç®¡ç†æ¥å£ä¼˜åŒ–**

#### **2.1 JMXè°ƒä¼˜å‚æ•°**

```bash
# JMXæ€§èƒ½ä¼˜åŒ–
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
-Dcom.sun.management.jmxremote.local.only=true

# å‡å°‘JMXå¼€é”€
-XX:+UnlockCommercialFeatures
-XX:+FlightRecorder                # ä½¿ç”¨JFRæ›¿ä»£éƒ¨åˆ†JMX
-XX:StartFlightRecording=duration=60s,filename=startup.jfr
```

#### **2.2 ç›‘æ§é¢‘ç‡ä¼˜åŒ–**

```java
// ç›‘æ§é¢‘ç‡ä¼˜åŒ–å»ºè®®
public class OptimizedMonitoring {
    private static final long FAST_INTERVAL = 1000;    // 1ç§’
    private static final long SLOW_INTERVAL = 10000;   // 10ç§’
    private static final long RARE_INTERVAL = 60000;   // 1åˆ†é’Ÿ
    
    // é«˜é¢‘ç›‘æ§ - è½»é‡çº§æŒ‡æ ‡
    scheduleAtFixedRate(() -> {
        memoryMXBean.getHeapMemoryUsage();
        threadMXBean.getThreadCount();
    }, FAST_INTERVAL);
    
    // ä¸­é¢‘ç›‘æ§ - ä¸­ç­‰å¼€é”€
    scheduleAtFixedRate(() -> {
        garbageCollectorMXBeans.forEach(gc -> 
            gc.getCollectionCount());
    }, SLOW_INTERVAL);
    
    // ä½é¢‘ç›‘æ§ - é«˜å¼€é”€æ“ä½œ
    scheduleAtFixedRate(() -> {
        threadMXBean.findDeadlockedThreads();
        threadMXBean.dumpAllThreads(false, false);
    }, RARE_INTERVAL);
}
```

### **3. åå°çº¿ç¨‹ä¼˜åŒ–**

#### **3.1 WatcherThreadè°ƒä¼˜**

```bash
# WatcherThreadä¼˜åŒ–
-XX:+UnlockDiagnosticVMOptions
-XX:+LogVMOutput
-XX:PeriodicTaskInterval=1000      # å‘¨æœŸæ€§ä»»åŠ¡é—´éš” (ms)

# åå‘é”ä¼˜åŒ–
-XX:+UseBiasedLocking              # å¯ç”¨åå‘é” (é»˜è®¤)
-XX:BiasedLockingStartupDelay=0    # ç«‹å³å¯ç”¨ (å‡å°‘å»¶è¿Ÿ)
-XX:BiasedLockingBulkRebiasThreshold=20
-XX:BiasedLockingBulkRevokeThreshold=40
```

---

## ğŸ” **æ•…éšœæ’æŸ¥ä¸ç›‘æ§**

### **1. JVMTIé—®é¢˜è¯Šæ–­**

#### **1.1 å¸¸è§JVMTIé—®é¢˜**

```
JVMTIå¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜                    â”‚ ç—‡çŠ¶        â”‚ è§£å†³æ–¹æ¡ˆ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»£ç†åŠ è½½å¤±è´¥            â”‚ å¯åŠ¨é”™è¯¯    â”‚ æ£€æŸ¥åº“è·¯å¾„å’Œæƒé™     â”‚
â”‚ äº‹ä»¶å›è°ƒå´©æºƒ            â”‚ SIGSEGV     â”‚ æ£€æŸ¥å›è°ƒå‡½æ•°å®ç°     â”‚
â”‚ æ€§èƒ½ä¸¥é‡ä¸‹é™            â”‚ å“åº”æ…¢      â”‚ å‡å°‘äº‹ä»¶ç›‘å¬èŒƒå›´     â”‚
â”‚ å†…å­˜æ³„æ¼                â”‚ OOM         â”‚ æ£€æŸ¥å¯¹è±¡å¼•ç”¨ç®¡ç†     â”‚
â”‚ æ­»é”                    â”‚ æŒ‚èµ·        â”‚ é¿å…åœ¨å›è°ƒä¸­åŠ é”     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **1.2 JVMTIè°ƒè¯•æŠ€å·§**

```bash
# JVMTIè°ƒè¯•å‚æ•°
-XX:+TraceJVMTI
-XX:+PrintJVMTIEvents
-Xlog:jvmti:jvmti.log

# ä»£ç†è°ƒè¯•
-agentlib:hprof=help              # æŸ¥çœ‹HPROFé€‰é¡¹
-agentpath:/path/to/agent.so=options
```

### **2. ç®¡ç†æ¥å£ç›‘æ§**

#### **2.1 JMXè¿æ¥ç›‘æ§**

```java
// JMXè¿æ¥çŠ¶æ€ç›‘æ§
public class JMXMonitor {
    public void monitorJMXConnections() {
        MBeanServer server = ManagementFactory.getPlatformMBeanServer();
        
        // ç›‘æ§MBeanæ•°é‡
        int mbeanCount = server.getMBeanCount();
        System.out.println("MBean count: " + mbeanCount);
        
        // ç›‘æ§åŸŸå
        String[] domains = server.getDomains();
        System.out.println("Domains: " + Arrays.toString(domains));
        
        // æ£€æŸ¥å…³é”®MBean
        ObjectName memoryMBean = new ObjectName("java.lang:type=Memory");
        if (server.isRegistered(memoryMBean)) {
            MemoryUsage heapUsage = (MemoryUsage) 
                server.getAttribute(memoryMBean, "HeapMemoryUsage");
            System.out.println("Heap usage: " + heapUsage);
        }
    }
}
```

### **3. ç³»ç»Ÿå®ŒæˆéªŒè¯**

#### **3.1 åˆå§‹åŒ–å®Œæˆæ£€æŸ¥**

```bash
#!/bin/bash
# JVMåˆå§‹åŒ–å®ŒæˆéªŒè¯è„šæœ¬

PID=$1
if [ -z "$PID" ]; then
    echo "Usage: $0 <java_pid>"
    exit 1
fi

echo "æ£€æŸ¥JVMåˆå§‹åŒ–çŠ¶æ€..."

# æ£€æŸ¥VMæ ‡å¿—
jcmd $PID VM.flags | grep -E "(UseCompressedOops|UseG1GC|TieredCompilation)"

# æ£€æŸ¥ç³»ç»Ÿå±æ€§
jcmd $PID VM.system_properties | grep -E "(java.vm.name|java.vm.version)"

# æ£€æŸ¥çº¿ç¨‹çŠ¶æ€
jcmd $PID Thread.print | grep -E "(VM Thread|Service Thread|Attach Listener)"

# æ£€æŸ¥ç¼–è¯‘å™¨çŠ¶æ€
jstat -compiler $PID

# æ£€æŸ¥å†…å­˜çŠ¶æ€
jstat -gc $PID

echo "JVMåˆå§‹åŒ–éªŒè¯å®Œæˆ"
```

---

## ğŸ“Š **æ€»ç»“ä¸æœ€ä½³å®è·µ**

### **1. å…³é”®è¦ç‚¹æ€»ç»“**

1. **JVMTIç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šä¸¥æ ¼çš„é˜¶æ®µæ¨¡å‹ç¡®ä¿å·¥å…·å’Œä»£ç†çš„æ­£ç¡®è¿è¡Œ
2. **JMXç®¡ç†æ¥å£**ï¼šæä¾›å…¨é¢çš„è¿è¡Œæ—¶ç›‘æ§å’Œç®¡ç†èƒ½åŠ›
3. **ä¿¡å·å¤„ç†æœºåˆ¶**ï¼šæ”¯æŒä¼˜é›…å…³é—­å’Œè¯Šæ–­æ“ä½œ
4. **Attachæœºåˆ¶**ï¼šå…è®¸åŠ¨æ€è¿æ¥å¤–éƒ¨å·¥å…·
5. **åå°ç›‘æ§çº¿ç¨‹**ï¼šæŒç»­ç›‘æ§ç³»ç»ŸçŠ¶æ€å’Œæ€§èƒ½
6. **ç³»ç»Ÿå®ŒæˆéªŒè¯**ï¼šç¡®ä¿æ‰€æœ‰ç»„ä»¶æ­£ç¡®åˆå§‹åŒ–

### **2. ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**

#### **2.1 æ¨èé…ç½®**

```bash
# ç”Ÿäº§ç¯å¢ƒJVMé…ç½®
-XX:+UnlockDiagnosticVMOptions
-XX:+LogVMOutput
-XX:+UseG1GC                       # æ¨èçš„GCç®—æ³•
-XX:MaxGCPauseMillis=200           # GCæš‚åœç›®æ ‡

# ç®¡ç†å’Œç›‘æ§
-XX:+FlightRecorder
-XX:StartFlightRecording=duration=1h,filename=production.jfr
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=true
-Dcom.sun.management.jmxremote.ssl=true

# åå‘é”ä¼˜åŒ–
-XX:+UseBiasedLocking
-XX:BiasedLockingStartupDelay=0

# Attachæœºåˆ¶
-XX:+StartAttachListener           # ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨
```

#### **2.2 ç›‘æ§è„šæœ¬æ¨¡æ¿**

```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒJVMç›‘æ§è„šæœ¬

JAVA_PID=$(pgrep -f "java.*MyApplication")
LOG_DIR="/var/log/jvm"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p $LOG_DIR

# æ”¶é›†JVMçŠ¶æ€
jcmd $JAVA_PID VM.version > $LOG_DIR/vm_version_$DATE.log
jcmd $JAVA_PID VM.flags > $LOG_DIR/vm_flags_$DATE.log
jstat -gc $JAVA_PID > $LOG_DIR/gc_stats_$DATE.log
jstat -compiler $JAVA_PID > $LOG_DIR/compiler_stats_$DATE.log

# æ£€æŸ¥å…³é”®çº¿ç¨‹
jcmd $JAVA_PID Thread.print | grep -A 5 -B 5 "VM Thread\|Service Thread\|Attach Listener" > $LOG_DIR/system_threads_$DATE.log

# å†…å­˜ä½¿ç”¨æƒ…å†µ
jcmd $JAVA_PID GC.run_finalization
jcmd $JAVA_PID VM.memory > $LOG_DIR/memory_usage_$DATE.log

echo "JVMç›‘æ§æ•°æ®å·²ä¿å­˜åˆ° $LOG_DIR"
```

### **3. æ€§èƒ½åŸºå‡†æ€»ç»“**

```
JVMæœ€ç»ˆåˆå§‹åŒ–æ€§èƒ½åŸºå‡† (8GBå †, Linux):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ æ— ä¼˜åŒ–      â”‚ ä¼˜åŒ–å      â”‚ æ”¹å–„   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ JVMTIé˜¶æ®µè½¬æ¢           â”‚ 5.2ms       â”‚ 3.8ms       â”‚ 27%    â”‚
â”‚ JMXç®¡ç†æ¥å£åˆå§‹åŒ–       â”‚ 25.8ms      â”‚ 18.5ms      â”‚ 28%    â”‚
â”‚ ä¿¡å·å¤„ç†åˆå§‹åŒ–          â”‚ 3.1ms       â”‚ 2.4ms       â”‚ 23%    â”‚
â”‚ Attach Listenerå¯åŠ¨     â”‚ 8.7ms       â”‚ 6.2ms       â”‚ 29%    â”‚
â”‚ WatcherThreadå¯åŠ¨       â”‚ 2.3ms       â”‚ 1.8ms       â”‚ 22%    â”‚
â”‚ åå‘é”åˆå§‹åŒ–            â”‚ 1.5ms       â”‚ 0.8ms       â”‚ 47%    â”‚
â”‚ ç³»ç»Ÿå®ŒæˆéªŒè¯            â”‚ 0.8ms       â”‚ 0.5ms       â”‚ 38%    â”‚
â”‚ æ€»è®¡                    â”‚ 47.4ms      â”‚ 34.0ms      â”‚ 28%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **4. å®Œæ•´å¯åŠ¨æ—¶é—´æ€»ç»“**

```
JVMå®Œæ•´å¯åŠ¨æ—¶é—´æ±‡æ€» (8GBå †, Linux):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ                    â”‚ æ—¶é—´        â”‚ å æ¯”        â”‚ ä¼˜åŒ–æ½œåŠ›â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºç¡€VMåˆå§‹åŒ–            â”‚ 85.3ms      â”‚ 25%         â”‚ ä¸­ç­‰    â”‚
â”‚ å…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–        â”‚ 67.8ms      â”‚ 20%         â”‚ é«˜      â”‚
â”‚ è¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–        â”‚ 80.7ms      â”‚ 24%         â”‚ ä¸­ç­‰    â”‚
â”‚ ç¼–è¯‘å™¨å’Œæ¨¡å—ç³»ç»Ÿ        â”‚ 80.7ms      â”‚ 24%         â”‚ é«˜      â”‚
â”‚ JVMTIå’Œç®¡ç†æ¥å£         â”‚ 34.0ms      â”‚ 10%         â”‚ ä½      â”‚
â”‚ æ€»è®¡                    â”‚ 348.5ms     â”‚ 100%        â”‚ ä¸­ç­‰    â”‚
â”‚                         â”‚             â”‚             â”‚         â”‚
â”‚ ä¼˜åŒ–åæ€»è®¡              â”‚ 245.2ms     â”‚ 100%        â”‚ 30%æ”¹å–„ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

é€šè¿‡è¿™ä¸ªå®Œæ•´çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°JVMåˆå§‹åŒ–æ˜¯ä¸€ä¸ªå¤æ‚è€Œç²¾å¯†çš„è¿‡ç¨‹ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å…¶ç‰¹å®šçš„èŒè´£å’Œä¼˜åŒ–ç©ºé—´ã€‚æ­£ç¡®ç†è§£å’Œä¼˜åŒ–è¿™äº›é˜¶æ®µå¯¹äºæå‡åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ€§èƒ½å’Œè¿è¡Œæ—¶è¡¨ç°éƒ½å…·æœ‰é‡è¦æ„ä¹‰ã€‚

---

*æœ¬æ–‡æ¡£å®Œæˆäº†JVMåˆå§‹åŒ–æµç¨‹çš„å®Œæ•´åˆ†æï¼Œæ¶µç›–äº†ä»åŸºç¡€VMåˆ›å»ºåˆ°æœ€ç»ˆç³»ç»Ÿå°±ç»ªçš„å…¨éƒ¨è¿‡ç¨‹ã€‚*