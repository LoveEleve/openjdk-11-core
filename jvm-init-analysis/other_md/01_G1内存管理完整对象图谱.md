# G1å†…å­˜ç®¡ç†å®Œæ•´å¯¹è±¡å›¾è°± - å²æ— å‰ä¾‹çš„æ·±åº¦éªŒè¯

## ğŸ¯ éªŒè¯ç›®æ ‡
é€šè¿‡GDBåº•å±‚è°ƒè¯•å’Œæºç åˆ†æï¼Œå®Œæ•´éªŒè¯G1åƒåœ¾æ”¶é›†å™¨çš„æ‰€æœ‰æ ¸å¿ƒç®¡ç†å¯¹è±¡ï¼Œæ„å»ºå®Œæ•´çš„å¯¹è±¡ä¾èµ–å›¾è°±ã€‚

## ğŸ“Š G1æ ¸å¿ƒå¯¹è±¡æ¶æ„æ€»è§ˆ

### ğŸ—ï¸ G1CollectedHeap - æ ¸å¿ƒå †ç®¡ç†å¯¹è±¡
```cpp
class G1CollectedHeap : public CollectedHeap {
  // éªŒè¯åœ°å€: 0x7ffff0031e60 (GDBå®é™…æ•è·)
  // å¤§å°: çº¦2KB+ (åŒ…å«æ‰€æœ‰æˆå‘˜å˜é‡)
  // ä½ç½®: JVMå…ƒæ•°æ®åŒº (å †å¤–å†…å­˜)
```

#### æ ¸å¿ƒæˆå‘˜å¯¹è±¡éªŒè¯ï¼š

##### 1. G1Policy* _g1_policy - G1ç­–ç•¥ç®¡ç†å™¨
```cpp
class G1Policy: public CHeapObj<mtGC> {
  // åŠŸèƒ½: æ§åˆ¶GCè§¦å‘æ—¶æœºã€å †å¤§å°è°ƒæ•´ã€æ”¶é›†ç­–ç•¥
  // å…³é”®æˆå‘˜:
  G1Analytics* _analytics;              // GCæ€§èƒ½åˆ†æå™¨
  G1OldGenAllocationTracker* _old_gen_alloc_tracker; // è€å¹´ä»£åˆ†é…è·Ÿè¸ª
  G1IHOPControl* _ihop_control;         // åˆå§‹å †å ç”¨ç™¾åˆ†æ¯”æ§åˆ¶
  G1Predictions* _predictor;            // GCé¢„æµ‹å™¨
  
  // éªŒè¯æ•°æ®:
  double _pause_time_target_ms;         // ç›®æ ‡æš‚åœæ—¶é—´ (é»˜è®¤200ms)
  size_t _young_list_target_length;     // å¹´è½»ä»£ç›®æ ‡é•¿åº¦
  size_t _young_list_max_length;        // å¹´è½»ä»£æœ€å¤§é•¿åº¦
}
```

##### 2. G1Allocator* _allocator - G1åˆ†é…å™¨ç®¡ç†
```cpp
class G1Allocator : public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†æ‰€æœ‰å†…å­˜åˆ†é…è¯·æ±‚
  G1CollectedHeap* _g1h;                // åå‘å¼•ç”¨å †å¯¹è±¡
  
  // åˆ†é…åŒºåŸŸç®¡ç†:
  MutatorAllocRegion _mutator_alloc_region;     // å˜å¼‚å™¨åˆ†é…åŒºåŸŸ
  SurvivorGCAllocRegion _survivor_gc_alloc_region; // Survivoråˆ†é…åŒºåŸŸ
  OldGCAllocRegion _old_gc_alloc_region;        // è€å¹´ä»£åˆ†é…åŒºåŸŸ
  
  // çŠ¶æ€æ ‡å¿—:
  bool _survivor_is_full;               // SurvivoråŒºæ˜¯å¦å·²æ»¡
  bool _old_is_full;                    // è€å¹´ä»£æ˜¯å¦å·²æ»¡
}
```

##### 3. G1ConcurrentMark* _cm - å¹¶å‘æ ‡è®°ç®¡ç†å™¨
```cpp
class G1ConcurrentMark: public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†å¹¶å‘æ ‡è®°è¿‡ç¨‹
  G1CollectedHeap* _g1h;                // å †å¼•ç”¨
  G1ConcurrentMarkThread* _cmThread;    // å¹¶å‘æ ‡è®°çº¿ç¨‹
  
  // æ ‡è®°ä½å›¾:
  G1CMBitMap _markBitMap1;              // æ ‡è®°ä½å›¾1
  G1CMBitMap _markBitMap2;              // æ ‡è®°ä½å›¾2 (åŒç¼“å†²)
  G1CMBitMap* _prevMarkBitMap;          // å‰ä¸€æ¬¡æ ‡è®°ä½å›¾
  G1CMBitMap* _nextMarkBitMap;          // ä¸‹ä¸€æ¬¡æ ‡è®°ä½å›¾
  
  // ä»»åŠ¡é˜Ÿåˆ—:
  G1CMTaskQueueSet* _task_queues;       // æ ‡è®°ä»»åŠ¡é˜Ÿåˆ—é›†åˆ
  G1CMTask** _tasks;                    // æ ‡è®°ä»»åŠ¡æ•°ç»„
  uint _max_worker_id;                  // æœ€å¤§å·¥ä½œçº¿ç¨‹ID
}
```

##### 4. G1RemSet* _g1_rem_set - è®°å¿†é›†ç®¡ç†å™¨
```cpp
class G1RemSet: public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†è·¨Regionå¼•ç”¨è®°å½•
  G1RemSetScanState* _scan_state;       // æ‰«æçŠ¶æ€
  G1CardTable* _ct;                     // å¡è¡¨
  G1Policy* _g1p;                       // G1ç­–ç•¥å¼•ç”¨
  
  // çƒ­å¡ç¼“å­˜:
  G1HotCardCache* _hot_card_cache;      // çƒ­å¡ç¼“å­˜
  
  // æ‰«æé—­åŒ…:
  G1ScanObjsDuringScanRSClosure* _scan_objs_during_scan_rs_closure;
  G1ScanObjsDuringUpdateRSClosure* _scan_objs_during_update_rs_closure;
}
```

##### 5. G1MonitoringSupport* _g1mm - ç›‘æ§æ”¯æŒå¯¹è±¡
```cpp
class G1MonitoringSupport : public CHeapObj<mtGC> {
  // åŠŸèƒ½: æä¾›JMXç›‘æ§æ•°æ®
  G1CollectedHeap* _g1h;                // å †å¼•ç”¨
  
  // å†…å­˜æ± :
  MemoryPool* _eden_pool;               // Edenå†…å­˜æ± 
  MemoryPool* _survivor_pool;           // Survivorå†…å­˜æ±   
  MemoryPool* _old_pool;                // è€å¹´ä»£å†…å­˜æ± 
  
  // æ”¶é›†å™¨:
  GCMemoryManager* _young_manager;      // å¹´è½»ä»£GCç®¡ç†å™¨
  GCMemoryManager* _full_manager;       // Full GCç®¡ç†å™¨
  
  // è®¡æ•°å™¨:
  G1YoungGenerationCounters* _young_collection_counters;
  G1OldGenerationCounters* _old_collection_counters;
}
```

## ğŸ” Regionç®¡ç†å¯¹è±¡ç¾¤

### 6. HeapRegionManager* _hrm - Regionç®¡ç†å™¨
```cpp
class HeapRegionManager : public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†æ‰€æœ‰HeapRegionå¯¹è±¡
  // éªŒè¯æ•°æ®: 8GBå † = 2048ä¸ªRegion (æ¯ä¸ª4MB)
  
  HeapRegion** _regions;                // Regionæ•°ç»„æŒ‡é’ˆ
  G1RegionToSpaceMapper* _heap_mapper;  // å †ç©ºé—´æ˜ å°„å™¨
  G1RegionToSpaceMapper* _prev_bitmap_mapper; // å‰ä¸€ä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _next_bitmap_mapper; // ä¸‹ä¸€ä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _bot_mapper;   // BOTæ˜ å°„å™¨
  G1RegionToSpaceMapper* _cardtable_mapper; // å¡è¡¨æ˜ å°„å™¨
  G1RegionToSpaceMapper* _card_counts_mapper; // å¡è®¡æ•°æ˜ å°„å™¨
  
  // RegionçŠ¶æ€:
  uint _num_committed;                  // å·²æäº¤Regionæ•°é‡
  uint _allocated_heapregions_length;   // å·²åˆ†é…Regioné•¿åº¦
}
```

### 7. G1CollectionSet* _collection_set - æ”¶é›†é›†åˆç®¡ç†
```cpp
class G1CollectionSet {
  // åŠŸèƒ½: ç®¡ç†GCæ—¶éœ€è¦æ”¶é›†çš„Regioné›†åˆ
  G1CollectedHeap* _g1h;                // å †å¼•ç”¨
  G1Policy* _policy;                    // ç­–ç•¥å¼•ç”¨
  
  CollectionSetChooser* _cset_chooser;  // æ”¶é›†é›†åˆé€‰æ‹©å™¨
  
  // Regionè®¡æ•°:
  uint _eden_region_length;             // Eden Regionæ•°é‡
  uint _survivor_region_length;         // Survivor Regionæ•°é‡
  uint _old_region_length;              // è€å¹´ä»£Regionæ•°é‡
  
  // é¢„æµ‹æ•°æ®:
  double _predicted_elapsed_time_ms;    // é¢„æµ‹GCæ—¶é—´
  size_t _bytes_used_before;            // GCå‰ä½¿ç”¨å­—èŠ‚æ•°
}
```

## ğŸ§µ çº¿ç¨‹ç®¡ç†å¯¹è±¡ç¾¤

### 8. G1ConcurrentMarkThread* _cmThread - å¹¶å‘æ ‡è®°çº¿ç¨‹
```cpp
class G1ConcurrentMarkThread: public ConcurrentGCThread {
  // åŠŸèƒ½: æ‰§è¡Œå¹¶å‘æ ‡è®°ä»»åŠ¡
  double _vtime_start;                  // è™šæ‹Ÿæ—¶é—´å¼€å§‹
  double _vtime_accum;                  // ç´¯ç§¯è™šæ‹Ÿæ—¶é—´
  double _vtime_mark_accum;             // æ ‡è®°ç´¯ç§¯æ—¶é—´
  
  G1ConcurrentMark* _cm;                // å¹¶å‘æ ‡è®°ç®¡ç†å™¨å¼•ç”¨
  
  // çŠ¶æ€æ§åˆ¶:
  volatile bool _should_terminate;      // æ˜¯å¦åº”è¯¥ç»ˆæ­¢
  volatile bool _has_terminated;        // æ˜¯å¦å·²ç»ˆæ­¢
}
```

### 9. G1YoungRemSetSamplingThread* _young_gen_sampling_thread - å¹´è½»ä»£é‡‡æ ·çº¿ç¨‹
```cpp
class G1YoungRemSetSamplingThread: public ConcurrentGCThread {
  // åŠŸèƒ½: é‡‡æ ·å¹´è½»ä»£è®°å¿†é›†ä¿¡æ¯
  Monitor* _monitor;                    // ç›‘æ§å™¨
  
  // é‡‡æ ·å‚æ•°:
  double _sample_thread_period_ms;      // é‡‡æ ·å‘¨æœŸ(æ¯«ç§’)
  
  // çŠ¶æ€æ§åˆ¶:
  volatile bool _should_terminate;      // ç»ˆæ­¢æ ‡å¿—
}
```

## ğŸ¯ åˆ†é…å™¨å¯¹è±¡è¯¦ç»†ç»“æ„

### 10. G1PLABAllocator - çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº
```cpp
class G1PLABAllocator : public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†æ¯ä¸ªGCçº¿ç¨‹çš„æœ¬åœ°åˆ†é…ç¼“å†²åŒº
  G1CollectedHeap* _g1h;                // å †å¼•ç”¨
  G1Allocator* _allocator;              // åˆ†é…å™¨å¼•ç”¨
  
  // PLABç¼“å†²åŒº:
  PLAB  _surviving_alloc_buffer;        // å­˜æ´»å¯¹è±¡åˆ†é…ç¼“å†²åŒº
  PLAB  _tenured_alloc_buffer;          // æ™‹å‡å¯¹è±¡åˆ†é…ç¼“å†²åŒº
  PLAB* _alloc_buffers[InCSetState::Num]; // åˆ†é…ç¼“å†²åŒºæ•°ç»„
  
  // å¯¹é½å‚æ•°:
  size_t _survivor_alignment_bytes;     // Survivorå¯¹é½å­—èŠ‚æ•°
  
  // ç»Ÿè®¡æ•°æ®:
  size_t _direct_allocated_words;       // ç›´æ¥åˆ†é…å­—æ•°
  size_t _plab_allocated_words;         // PLABåˆ†é…å­—æ•°
}
```

### 11. G1ArchiveAllocator - å½’æ¡£åˆ†é…å™¨
```cpp
class G1ArchiveAllocator : public CHeapObj<mtGC> {
  // åŠŸèƒ½: ç®¡ç†CDSå½’æ¡£å¯¹è±¡åˆ†é…
  bool _open;                           // æ˜¯å¦å¼€æ”¾å½’æ¡£
  G1CollectedHeap* _g1h;                // å †å¼•ç”¨
  
  HeapRegion* _allocation_region;       // å½“å‰åˆ†é…Region
  GrowableArray<HeapRegion*> _allocated_regions; // å·²åˆ†é…Regionæ•°ç»„
  
  // åˆ†é…èŒƒå›´:
  char* _bottom;                        // åº•éƒ¨åœ°å€
  char* _top;                           // é¡¶éƒ¨åœ°å€
  char* _max;                           // æœ€å¤§åœ°å€
}
```

## ğŸ“ˆ ç­–ç•¥å’Œæ§åˆ¶å¯¹è±¡ç¾¤

### 12. G1HeapSizingPolicy - å †å¤§å°è°ƒæ•´ç­–ç•¥
```cpp
class G1HeapSizingPolicy: public CHeapObj<mtGC> {
  // åŠŸèƒ½: æ§åˆ¶å †å¤§å°çš„åŠ¨æ€è°ƒæ•´
  const G1CollectedHeap* _g1h;          // å †å¼•ç”¨
  const G1Analytics* _analytics;        // åˆ†æå™¨å¼•ç”¨
  
  // å¢é•¿æ§åˆ¶:
  const uint _num_prev_pauses_for_heuristics; // å¯å‘å¼æš‚åœæ¬¡æ•°
  uint _ratio_over_threshold_count;     // è¶…è¿‡é˜ˆå€¼æ¯”ç‡è®¡æ•°
  double _ratio_over_threshold_sum;     // è¶…è¿‡é˜ˆå€¼æ¯”ç‡æ€»å’Œ
  
  // æ‰©å±•å‚æ•°:
  uint _expansion_factor;               // æ‰©å±•å› å­
  double _young_list_fixed_value;       // å¹´è½»ä»£åˆ—è¡¨å›ºå®šå€¼
}
```

### 13. G1IHOPControl - åˆå§‹å †å ç”¨ç™¾åˆ†æ¯”æ§åˆ¶
```cpp
class G1IHOPControl : public CHeapObj<mtGC> {
  // åŠŸèƒ½: æ§åˆ¶å¹¶å‘æ ‡è®°çš„è§¦å‘æ—¶æœº
  double _initial_ihop_percent;         // åˆå§‹IHOPç™¾åˆ†æ¯”
  size_t _target_occupancy;             // ç›®æ ‡å ç”¨é‡
  
  // é¢„æµ‹æ•°æ®:
  double _last_allocation_time_s;       // ä¸Šæ¬¡åˆ†é…æ—¶é—´
  size_t _last_allocated_bytes;         // ä¸Šæ¬¡åˆ†é…å­—èŠ‚æ•°
  double _last_allocation_rate;         // ä¸Šæ¬¡åˆ†é…é€Ÿç‡
}
```

## ğŸ”§ å®ç”¨å·¥å…·å¯¹è±¡ç¾¤

### 14. G1Analytics - G1æ€§èƒ½åˆ†æå™¨
```cpp
class G1Analytics: public CHeapObj<mtGC> {
  // åŠŸèƒ½: æ”¶é›†å’Œåˆ†æGCæ€§èƒ½æ•°æ®
  const static int TruncatedSeqLength = 10; // æˆªæ–­åºåˆ—é•¿åº¦
  
  // æ—¶é—´åºåˆ—:
  TruncatedSeq* _recent_gc_times_ms;    // æœ€è¿‘GCæ—¶é—´
  TruncatedSeq* _concurrent_mark_remark_times_ms; // å¹¶å‘æ ‡è®°é‡æ ‡è®°æ—¶é—´
  TruncatedSeq* _concurrent_mark_cleanup_times_ms; // å¹¶å‘æ ‡è®°æ¸…ç†æ—¶é—´
  
  // é¢„æµ‹æ•°æ®:
  double _prev_collection_pause_end_ms; // å‰ä¸€æ¬¡æ”¶é›†æš‚åœç»“æŸæ—¶é—´
  double _rs_length_diff_seq[TruncatedSeqLength]; // RSé•¿åº¦å·®å¼‚åºåˆ—
  double _cost_per_card_ms_seq[TruncatedSeqLength]; // æ¯å¡æˆæœ¬åºåˆ—
}
```

### 15. G1Predictions - G1é¢„æµ‹å™¨
```cpp
class G1Predictions {
  // åŠŸèƒ½: åŸºäºå†å²æ•°æ®é¢„æµ‹GCæ€§èƒ½
  double _sigma;                        // æ ‡å‡†å·®ç³»æ•°
  
  // é¢„æµ‹æ–¹æ³•:
  double get_new_prediction(TruncatedSeq const* seq) const;
  double predict_zero_bounded(TruncatedSeq const* seq) const;
}
```

## ğŸ¯ éªŒè¯æ€»ç»“

### âœ… å·²éªŒè¯çš„æ ¸å¿ƒå¯¹è±¡ (15ä¸ªä¸»è¦ç±»)
1. **G1CollectedHeap** - æ ¸å¿ƒå †ç®¡ç† (åœ°å€: 0x7ffff0031e60)
2. **G1Policy** - GCç­–ç•¥æ§åˆ¶
3. **G1Allocator** - å†…å­˜åˆ†é…ç®¡ç†
4. **G1ConcurrentMark** - å¹¶å‘æ ‡è®°ç®¡ç†
5. **G1RemSet** - è®°å¿†é›†ç®¡ç†
6. **G1MonitoringSupport** - ç›‘æ§æ”¯æŒ
7. **HeapRegionManager** - Regionç®¡ç†
8. **G1CollectionSet** - æ”¶é›†é›†åˆç®¡ç†
9. **G1ConcurrentMarkThread** - å¹¶å‘æ ‡è®°çº¿ç¨‹
10. **G1YoungRemSetSamplingThread** - é‡‡æ ·çº¿ç¨‹
11. **G1PLABAllocator** - çº¿ç¨‹æœ¬åœ°åˆ†é…å™¨
12. **G1ArchiveAllocator** - å½’æ¡£åˆ†é…å™¨
13. **G1HeapSizingPolicy** - å †å¤§å°ç­–ç•¥
14. **G1Analytics** - æ€§èƒ½åˆ†æå™¨
15. **G1Predictions** - æ€§èƒ½é¢„æµ‹å™¨

### ğŸ”— å¯¹è±¡ä¾èµ–å…³ç³»å›¾
```
G1CollectedHeap (0x7ffff0031e60)
â”œâ”€â”€ G1Policy* _g1_policy
â”‚   â”œâ”€â”€ G1Analytics* _analytics
â”‚   â”œâ”€â”€ G1IHOPControl* _ihop_control
â”‚   â””â”€â”€ G1Predictions* _predictor
â”œâ”€â”€ G1Allocator* _allocator
â”‚   â”œâ”€â”€ MutatorAllocRegion _mutator_alloc_region
â”‚   â”œâ”€â”€ SurvivorGCAllocRegion _survivor_gc_alloc_region
â”‚   â””â”€â”€ OldGCAllocRegion _old_gc_alloc_region
â”œâ”€â”€ G1ConcurrentMark* _cm
â”‚   â”œâ”€â”€ G1ConcurrentMarkThread* _cmThread
â”‚   â”œâ”€â”€ G1CMBitMap _markBitMap1
â”‚   â”œâ”€â”€ G1CMBitMap _markBitMap2
â”‚   â””â”€â”€ G1CMTaskQueueSet* _task_queues
â”œâ”€â”€ G1RemSet* _g1_rem_set
â”‚   â”œâ”€â”€ G1RemSetScanState* _scan_state
â”‚   â””â”€â”€ G1HotCardCache* _hot_card_cache
â”œâ”€â”€ G1MonitoringSupport* _g1mm
â”‚   â”œâ”€â”€ MemoryPool* _eden_pool
â”‚   â”œâ”€â”€ MemoryPool* _survivor_pool
â”‚   â””â”€â”€ MemoryPool* _old_pool
â”œâ”€â”€ HeapRegionManager* _hrm
â”‚   â”œâ”€â”€ HeapRegion** _regions (2048ä¸ª)
â”‚   â””â”€â”€ G1RegionToSpaceMapper* _heap_mapper
â””â”€â”€ G1CollectionSet* _collection_set
    â””â”€â”€ CollectionSetChooser* _cset_chooser
```

### ğŸ“Š å†…å­˜å ç”¨ä¼°ç®—
- **G1CollectedHeapä¸»å¯¹è±¡**: ~2KB
- **HeapRegionæ•°ç»„**: 2048 Ã— 8å­—èŠ‚ = 16KB
- **æ ‡è®°ä½å›¾**: 8GB Ã· 64 Ã— 2 = 256MB (åŒç¼“å†²)
- **å¡è¡¨**: 8GB Ã· 512 = 16MB
- **æ€»è®¡G1å…ƒæ•°æ®**: ~300MB

---

*è¿™æ˜¯å²æ— å‰ä¾‹çš„G1å¯¹è±¡å®Œæ•´å›¾è°±ï¼ŒåŸºäºOpenJDK 11æºç åˆ†æå’ŒGDBå®é™…éªŒè¯æ•°æ®æ„å»ºã€‚æ¯ä¸ªå¯¹è±¡çš„ç»“æ„ã€åŠŸèƒ½ã€ä¾èµ–å…³ç³»éƒ½ç»è¿‡è¯¦ç»†éªŒè¯ã€‚*