# JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µï¼šSystemDictionaryä¸OopStorageæ·±åº¦è§£æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMåœ¨G1å †åˆå§‹åŒ–å®Œæˆåçš„ç¬¬ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼šSystemDictionaryçš„OopStorageåˆå§‹åŒ–ã€‚è¿™æ˜¯JVMå…ƒæ•°æ®ç®¡ç†ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ï¼Œä¸ºåç»­çš„ç±»åŠ è½½ã€ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ç­‰æ ¸å¿ƒç»„ä»¶æä¾›åº•å±‚çš„å¯¹è±¡å¼•ç”¨å­˜å‚¨æœåŠ¡ã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp:699
jint status = Universe::initialize_heap();  // G1å †åˆå§‹åŒ–å®Œæˆ
if (status != JNI_OK) {
    return status;
}

// ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–SystemDictionaryçš„OopStorage
SystemDictionary::initialize_oop_storage();
```

### SystemDictionary::initialize_oop_storage()å®ç°

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/classfile/systemDictionary.cpp:3045-3050
void SystemDictionary::initialize_oop_storage() {
  _vm_weak_oop_storage =
    new OopStorage("VM Weak Oop Handles",     // å­˜å‚¨åç§°
                   VMWeakAlloc_lock,          // åˆ†é…é”
                   VMWeakActive_lock);        // æ´»è·ƒå—é”
}
```

## ğŸ—ï¸ OopStorageæ ¸å¿ƒæ¶æ„è§£æ

### 1.1 OopStorageè®¾è®¡ç›®æ ‡

OopStorageæ˜¯JVMä¸­ç”¨äºç®¡ç†å¯¹è±¡å¼•ç”¨çš„é«˜æ€§èƒ½ã€çº¿ç¨‹å®‰å…¨çš„å­˜å‚¨ç³»ç»Ÿï¼Œä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¼±å¼•ç”¨ç®¡ç†**ï¼šæ”¯æŒGCå¯ä»¥å›æ”¶çš„å¼±å¼•ç”¨å­˜å‚¨
2. **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®å’ŒGCå¹¶å‘éå†
3. **å†…å­˜æ•ˆç‡**ï¼šå—çŠ¶åˆ†é…ï¼Œå‡å°‘å†…å­˜ç¢ç‰‡
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæœ€å°åŒ–é”ç«äº‰ï¼Œæ”¯æŒæ— é”å¿«é€Ÿè·¯å¾„

### 1.2 OopStorageå†…éƒ¨ç»“æ„

```cpp
class OopStorage : public CHeapObj<mtGC> {
private:
  const char* _name;                    // å­˜å‚¨åç§°ï¼ˆç”¨äºè°ƒè¯•å’Œç›‘æ§ï¼‰
  Mutex* _allocation_mutex;             // åˆ†é…æ“ä½œçš„äº’æ–¥é”
  Mutex* _active_mutex;                 // æ´»è·ƒå—ç®¡ç†çš„äº’æ–¥é”
  
  ActiveArray* _active_array;           // å½“å‰æ´»è·ƒçš„å—æ•°ç»„
  AllocationList _allocation_list;      // å¯åˆ†é…çš„å—é“¾è¡¨
  size_t _allocation_count;             // å·²åˆ†é…çš„æ¡ç›®æ•°é‡
  
  // ç»Ÿè®¡ä¿¡æ¯
  volatile size_t _concurrent_iteration_count;  // å¹¶å‘è¿­ä»£è®¡æ•°
  bool _needs_cleanup;                  // æ˜¯å¦éœ€è¦æ¸…ç†
};
```

#### **ActiveArrayï¼ˆæ´»è·ƒå—æ•°ç»„ï¼‰**

```cpp
class ActiveArray {
private:
  size_t _size;                         // æ•°ç»„å¤§å°
  Block** _blocks;                      // å—æŒ‡é’ˆæ•°ç»„
  volatile uintx _refcount;             // å¼•ç”¨è®¡æ•°ï¼ˆæ”¯æŒå¹¶å‘è®¿é—®ï¼‰
  
public:
  Block* at(size_t index) const;        // è·å–æŒ‡å®šç´¢å¼•çš„å—
  void increment_refcount();            // åŸå­å¢åŠ å¼•ç”¨è®¡æ•°
  bool decrement_refcount();            // åŸå­å‡å°‘å¼•ç”¨è®¡æ•°ï¼Œè¿”å›æ˜¯å¦ä¸º0
};
```

#### **Blockï¼ˆå­˜å‚¨å—ï¼‰**

```cpp
class Block {
private:
  static const size_t _data_size = 64;  // æ¯ä¸ªå—64ä¸ªoopæŒ‡é’ˆ
  oop _data[_data_size];                // oopæŒ‡é’ˆæ•°ç»„
  volatile uintx _allocated_bitmask;    // åˆ†é…ä½æ©ç ï¼ˆ64ä½ï¼‰
  Block* _next;                         // é“¾è¡¨æŒ‡é’ˆ
  Block* _prev;                         // åŒå‘é“¾è¡¨æŒ‡é’ˆ
  
public:
  oop* allocate();                      // åˆ†é…ä¸€ä¸ªoopæŒ‡é’ˆæ§½ä½
  void release(oop* ptr);               // é‡Šæ”¾ä¸€ä¸ªoopæŒ‡é’ˆæ§½ä½
  bool is_empty() const;                // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
  bool is_full() const;                 // æ£€æŸ¥æ˜¯å¦å·²æ»¡
};
```

### 1.3 OopStorageå†…å­˜å¸ƒå±€

```
OopStorageå†…å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OopStorageå¯¹è±¡                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _name: "VM Weak Oop Handles"                               â”‚
â”‚ _allocation_mutex: VMWeakAlloc_lock                         â”‚
â”‚ _active_mutex: VMWeakActive_lock                            â”‚
â”‚ _active_array: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ _allocation_list: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                â”‚                          â”‚
                â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ActiveArray           â”‚ â”‚        AllocationList           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _size: 8 (åˆå§‹å¤§å°)              â”‚ â”‚ _head: Block*                   â”‚
â”‚ _blocks: Block*[8]              â”‚ â”‚ _tail: Block*                   â”‚
â”‚ _refcount: 1                    â”‚ â”‚ _size: 0 (åˆå§‹ä¸ºç©º)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ [0]: Block* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ [1]: NULL                     â”‚ â”‚
â”‚ [2]: NULL                     â”‚ â”‚
â”‚ ...                           â”‚ â”‚
â”‚ [7]: NULL                     â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”˜
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            Block                â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ _data: oop[64]                  â”‚
                    â”‚ [0]: NULL                       â”‚
                    â”‚ [1]: NULL                       â”‚
                    â”‚ ...                             â”‚
                    â”‚ [63]: NULL                      â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ _allocated_bitmask: 0x0         â”‚
                    â”‚ _next: NULL                     â”‚
                    â”‚ _prev: NULL                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ OopStorageæ ¸å¿ƒæ“ä½œæœºåˆ¶

### 2.1 åˆ†é…æ“ä½œï¼ˆallocateï¼‰

```cpp
oop* OopStorage::allocate() {
  MutexLockerEx ml(_allocation_mutex, Mutex::_no_safepoint_check_flag);
  
  // 1. å°è¯•ä»ç°æœ‰å—åˆ†é…
  for (AllocationList::Iterator it = _allocation_list.begin();
       it != _allocation_list.end(); ++it) {
    Block* block = *it;
    oop* result = block->allocate();
    if (result != NULL) {
      ++_allocation_count;
      if (block->is_full()) {
        _allocation_list.unlink(*it);  // ä»å¯åˆ†é…åˆ—è¡¨ç§»é™¤æ»¡å—
      }
      return result;
    }
  }
  
  // 2. éœ€è¦æ–°å»ºå—
  Block* new_block = Block::new_block(this);
  if (new_block == NULL) {
    return NULL;  // å†…å­˜ä¸è¶³
  }
  
  // 3. å°†æ–°å—æ·»åŠ åˆ°æ´»è·ƒæ•°ç»„å’Œåˆ†é…åˆ—è¡¨
  add_block(new_block);
  oop* result = new_block->allocate();
  ++_allocation_count;
  return result;
}
```

#### **Block::allocate()å®ç°**

```cpp
oop* Block::allocate() {
  // ä½¿ç”¨åŸå­æ“ä½œæŸ¥æ‰¾å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªç©ºé—²ä½
  uintx allocated = OrderAccess::load_acquire(&_allocated_bitmask);
  
  while (true) {
    // æŸ¥æ‰¾ç¬¬ä¸€ä¸ª0ä½ï¼ˆç©ºé—²æ§½ä½ï¼‰
    int index = count_trailing_ones(allocated);
    if (index >= _data_size) {
      return NULL;  // å—å·²æ»¡
    }
    
    uintx new_allocated = allocated | (uintx(1) << index);
    uintx current = Atomic::cmpxchg(new_allocated, &_allocated_bitmask, allocated);
    
    if (current == allocated) {
      // CASæˆåŠŸï¼Œåˆ†é…æˆåŠŸ
      return &_data[index];
    }
    
    // CASå¤±è´¥ï¼Œé‡è¯•
    allocated = current;
  }
}
```

### 2.2 é‡Šæ”¾æ“ä½œï¼ˆreleaseï¼‰

```cpp
void OopStorage::release(oop* ptr) {
  Block* block = find_block_or_null(ptr);
  assert(block != NULL, "Invalid pointer");
  
  block->release(ptr);
  
  MutexLockerEx ml(_allocation_mutex, Mutex::_no_safepoint_check_flag);
  --_allocation_count;
  
  if (block->is_empty()) {
    // ç©ºå—å¯ä»¥è¢«åˆ é™¤ï¼ˆå»¶è¿Ÿåˆ é™¤ç­–ç•¥ï¼‰
    _needs_cleanup = true;
  } else if (block->was_full()) {
    // ä¹‹å‰æ»¡çš„å—ç°åœ¨æœ‰ç©ºé—²ç©ºé—´ï¼Œé‡æ–°åŠ å…¥åˆ†é…åˆ—è¡¨
    _allocation_list.push_front(block);
  }
}
```

#### **Block::release()å®ç°**

```cpp
void Block::release(oop* ptr) {
  assert(ptr >= _data && ptr < _data + _data_size, "Invalid pointer");
  
  size_t index = ptr - _data;
  uintx mask = ~(uintx(1) << index);
  
  // æ¸…é™¤å¯¹åº”ä½ï¼Œå¹¶æ¸…ç©ºoopæŒ‡é’ˆ
  *ptr = NULL;
  OrderAccess::release_store(&_allocated_bitmask, 
                            OrderAccess::load_acquire(&_allocated_bitmask) & mask);
}
```

### 2.3 å¹¶å‘è¿­ä»£æ”¯æŒ

OopStorageæ”¯æŒGCçº¿ç¨‹å¹¶å‘éå†æ‰€æœ‰å­˜å‚¨çš„oopï¼Œè¿™æ˜¯å…¶æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼š

```cpp
template<typename Closure>
void OopStorage::oops_do(Closure* cl) {
  // è·å–å½“å‰æ´»è·ƒæ•°ç»„çš„å¿«ç…§
  WithActiveArray waa(this);
  ActiveArray& active_array = waa.active_array();
  
  // éå†æ‰€æœ‰å—
  for (size_t i = 0; i < active_array.size(); ++i) {
    Block* block = active_array.at(i);
    if (block != NULL) {
      block->oops_do(cl);
    }
  }
}
```

#### **Block::oops_do()å®ç°**

```cpp
template<typename Closure>
void Block::oops_do(Closure* cl) {
  uintx allocated = OrderAccess::load_acquire(&_allocated_bitmask);
  
  // éå†æ‰€æœ‰å·²åˆ†é…çš„æ§½ä½
  for (size_t i = 0; i < _data_size; ++i) {
    if ((allocated & (uintx(1) << i)) != 0) {
      cl->do_oop(&_data[i]);
    }
  }
}
```

## ğŸ“Š VM Weak Oop Storageçš„ç”¨é€”

### 3.1 å¼±å¼•ç”¨ç±»å‹

SystemDictionaryçš„VM Weak Oop Storageä¸»è¦ç”¨äºå­˜å‚¨ä»¥ä¸‹ç±»å‹çš„å¼±å¼•ç”¨ï¼š

```cpp
enum WeakHandleType { 
  vm_class_loader_data,     // ç±»åŠ è½½å™¨æ•°æ®çš„å¼±å¼•ç”¨
  vm_string,                // å­—ç¬¦ä¸²çš„å¼±å¼•ç”¨
  vm_string_table_data      // å­—ç¬¦ä¸²è¡¨æ•°æ®çš„å¼±å¼•ç”¨
};
```

### 3.2 å…¸å‹ä½¿ç”¨åœºæ™¯

#### **ç±»åŠ è½½å™¨å¼±å¼•ç”¨**

```cpp
// ClassLoaderDataä¸­çš„å¼±å¼•ç”¨å­˜å‚¨
class ClassLoaderData {
private:
  WeakHandle<vm_class_loader_data> _class_loader;  // å¯¹ClassLoaderå¯¹è±¡çš„å¼±å¼•ç”¨
  
public:
  oop class_loader() const {
    return _class_loader.resolve();  // è§£æå¼±å¼•ç”¨ï¼Œå¯èƒ½è¿”å›NULL
  }
};
```

#### **å­—ç¬¦ä¸²è¡¨å¼±å¼•ç”¨**

```cpp
// StringTableä¸­çš„å¼±å¼•ç”¨å­˜å‚¨
class StringTable {
private:
  static void add_weak_string(oop string_oop) {
    WeakHandle<vm_string> weak_string(string_oop);
    // å­˜å‚¨åˆ°VM Weak Oop Storageä¸­
  }
};
```

### 3.3 GCäº¤äº’æœºåˆ¶

VM Weak Oop Storageä¸GCçš„äº¤äº’æ˜¯å…¶æ ¸å¿ƒä»·å€¼ï¼š

```cpp
// GCæœŸé—´çš„å¼±å¼•ç”¨å¤„ç†
void G1CollectedHeap::process_weak_oops() {
  // 1. éå†VM Weak Oop Storage
  SystemDictionary::vm_weak_oop_storage()->weak_oops_do(&is_alive, &clean_closure);
  
  // 2. æ¸…ç†æ­»äº¡å¯¹è±¡çš„å¼•ç”¨
  // is_alive.do_object_b(oop) è¿”å›falseçš„å¯¹è±¡ä¼šè¢«clean_closureæ¸…ç†
}
```

#### **å¼±å¼•ç”¨æ¸…ç†è¿‡ç¨‹**

```
GCå¼±å¼•ç”¨å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GCæ ‡è®°é˜¶æ®µ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ ‡è®°æ‰€æœ‰å¼ºå¼•ç”¨å¯è¾¾çš„å¯¹è±¡                                   â”‚
â”‚ 2. ä¸é€šè¿‡å¼±å¼•ç”¨è¿›è¡Œæ ‡è®°ä¼ æ’­                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¼±å¼•ç”¨å¤„ç†é˜¶æ®µ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. éå†VM Weak Oop Storageä¸­çš„æ‰€æœ‰oop*                      â”‚
â”‚ 2. æ£€æŸ¥æ¯ä¸ªoopæ˜¯å¦è¢«æ ‡è®°ä¸ºå­˜æ´»                               â”‚
â”‚ 3. æœªæ ‡è®°çš„å¯¹è±¡ï¼šè®¾ç½®oop* = NULL                             â”‚
â”‚ 4. å·²æ ‡è®°çš„å¯¹è±¡ï¼šä¿æŒå¼•ç”¨ä¸å˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¸…ç†å®Œæˆ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼±å¼•ç”¨ç°åœ¨åªæŒ‡å‘å­˜æ´»å¯¹è±¡æˆ–NULL                                â”‚
â”‚ åº”ç”¨ç¨‹åºéœ€è¦æ£€æŸ¥å¼±å¼•ç”¨æ˜¯å¦ä¸ºNULL                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–

### 4.1 å†…å­˜æ•ˆç‡

#### **å†…å­˜å¼€é”€è®¡ç®—ï¼ˆ8GBå †ç¯å¢ƒï¼‰**

```
VM Weak Oop Storageåˆå§‹å†…å­˜å¼€é”€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ å¤§å°        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OopStorageå¯¹è±¡          â”‚ ~200B       â”‚ ä¸»è¦æ•°æ®ç»“æ„           â”‚
â”‚ ActiveArray (åˆå§‹)      â”‚ ~100B       â”‚ 8ä¸ªBlock*æŒ‡é’ˆ         â”‚
â”‚ ç¬¬ä¸€ä¸ªBlock             â”‚ ~600B       â”‚ 64ä¸ªoop* + å…ƒæ•°æ®     â”‚
â”‚ é”å¯¹è±¡                  â”‚ ~100B       â”‚ ä¸¤ä¸ªMutexå¯¹è±¡         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                    â”‚ ~1KB        â”‚ åˆå§‹å¼€é”€              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿è¡Œæ—¶å¢é•¿ï¼ˆå‡è®¾10000ä¸ªå¼±å¼•ç”¨ï¼‰ï¼š
- éœ€è¦Blockæ•°ï¼š10000 / 64 â‰ˆ 157ä¸ªBlock
- Blockå†…å­˜ï¼š157 * 600B â‰ˆ 94KB
- ActiveArrayæ‰©å±•ï¼š~2KB
- æ€»å†…å­˜ï¼š~97KB
- å 8GBå †æ¯”ä¾‹ï¼š0.0012%
```

### 4.2 å¹¶å‘æ€§èƒ½

#### **åˆ†é…æ€§èƒ½ç‰¹å¾**

```cpp
// å¿«é€Ÿè·¯å¾„ï¼šå—æœ‰ç©ºé—²ç©ºé—´
oop* allocate_fast_path() {
  // 1. è·å–åˆ†é…é”ï¼š~50ns
  // 2. æŸ¥æ‰¾ç©ºé—²æ§½ä½ï¼š~10ns (ä½æ“ä½œ)
  // 3. åŸå­CASè®¾ç½®ä½ï¼š~5ns
  // 4. é‡Šæ”¾é”ï¼š~10ns
  // æ€»è®¡ï¼š~75ns
}

// æ…¢é€Ÿè·¯å¾„ï¼šéœ€è¦æ–°å»ºå—
oop* allocate_slow_path() {
  // 1. è·å–åˆ†é…é”ï¼š~50ns
  // 2. åˆ†é…æ–°Blockï¼š~1Î¼s (malloc + åˆå§‹åŒ–)
  // 3. æ‰©å±•ActiveArrayï¼š~500ns (å¯èƒ½éœ€è¦)
  // 4. æ›´æ–°æ•°æ®ç»“æ„ï¼š~100ns
  // 5. é‡Šæ”¾é”ï¼š~10ns
  // æ€»è®¡ï¼š~1.7Î¼s
}
```

#### **å¹¶å‘è¿­ä»£æ€§èƒ½**

```cpp
// GCå¹¶å‘éå†æ€§èƒ½
void concurrent_iteration_performance() {
  // æ¯ä¸ªBlockéå†ï¼š~200ns
  // 10000ä¸ªå¼±å¼•ç”¨ï¼ˆ157ä¸ªBlockï¼‰ï¼š157 * 200ns = 31.4Î¼s
  // å¹¶å‘å¤„ç†ï¼ˆ8ä¸ªGCçº¿ç¨‹ï¼‰ï¼š31.4Î¼s / 8 â‰ˆ 4Î¼s
  
  // å¼±å¼•ç”¨æ¸…ç†ï¼šæ¯ä¸ªå¼•ç”¨~50ns
  // æ€»æ¸…ç†æ—¶é—´ï¼š10000 * 50ns = 500Î¼s
  // å¹¶å‘æ¸…ç†ï¼š500Î¼s / 8 â‰ˆ 62.5Î¼s
}
```

### 4.3 é”ç«äº‰ä¼˜åŒ–

OopStorageä½¿ç”¨åŒé”è®¾è®¡æ¥æœ€å°åŒ–é”ç«äº‰ï¼š

```cpp
class OopStorage {
private:
  Mutex* _allocation_mutex;     // ä¿æŠ¤åˆ†é…æ“ä½œå’Œ_allocation_list
  Mutex* _active_mutex;         // ä¿æŠ¤_active_arrayçš„æ›¿æ¢æ“ä½œ
  
  // é”åˆ†ç¦»çš„å¥½å¤„ï¼š
  // 1. åˆ†é…æ“ä½œä¸ä¼šé˜»å¡å¹¶å‘è¿­ä»£
  // 2. å¹¶å‘è¿­ä»£ä¸ä¼šé˜»å¡åˆ†é…æ“ä½œ
  // 3. åªæœ‰ActiveArrayæ‰©å±•æ—¶æ‰éœ€è¦_active_mutex
};
```

#### **é”ç«äº‰åˆ†æ**

```
é”ä½¿ç”¨åœºæ™¯åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹        â”‚ ä½¿ç”¨çš„é”           â”‚ é¢‘ç‡    â”‚ æŒé”æ—¶é—´    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†é…oop*        â”‚ _allocation_mutex  â”‚ é«˜      â”‚ ~75ns      â”‚
â”‚ é‡Šæ”¾oop*        â”‚ _allocation_mutex  â”‚ é«˜      â”‚ ~50ns      â”‚
â”‚ å¹¶å‘è¿­ä»£        â”‚ _active_mutex      â”‚ ä¸­      â”‚ ~10ns      â”‚
â”‚ æ‰©å±•ActiveArray â”‚ ä¸¤ä¸ªé”éƒ½éœ€è¦        â”‚ ä½      â”‚ ~1Î¼s       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é”ç«äº‰æ¦‚ç‡ï¼š
- _allocation_mutexï¼šä¸­ç­‰ï¼ˆåº”ç”¨çº¿ç¨‹é—´ç«äº‰ï¼‰
- _active_mutexï¼šä½ï¼ˆä¸»è¦æ˜¯GCçº¿ç¨‹ä½¿ç”¨ï¼‰
- æ­»é”é£é™©ï¼šæ— ï¼ˆé”è·å–é¡ºåºå›ºå®šï¼‰
```

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸å·¥ç¨‹æ™ºæ…§

### 5.1 å¼•ç”¨è®¡æ•°ä¸Copy-on-Write

ActiveArrayä½¿ç”¨å¼•ç”¨è®¡æ•°å®ç°å®‰å…¨çš„å¹¶å‘è®¿é—®ï¼š

```cpp
class ActiveArray {
private:
  volatile uintx _refcount;
  
public:
  void increment_refcount() {
    Atomic::inc(&_refcount);
  }
  
  bool decrement_refcount() {
    return Atomic::dec(&_refcount) == 0;
  }
};

// ä½¿ç”¨RAIIç®¡ç†å¼•ç”¨è®¡æ•°
class WithActiveArray : public StackObj {
private:
  const OopStorage* _storage;
  ActiveArray* _active_array;
  
public:
  WithActiveArray(const OopStorage* storage) :
    _storage(storage),
    _active_array(storage->obtain_active_array())  // å¢åŠ å¼•ç”¨è®¡æ•°
  {}
  
  ~WithActiveArray() {
    _storage->relinquish_block_array(_active_array);  // å‡å°‘å¼•ç”¨è®¡æ•°
  }
};
```

### 5.2 ä½å›¾ä¼˜åŒ–

Blockä½¿ç”¨64ä½ä½å›¾æ¥é«˜æ•ˆç®¡ç†æ§½ä½åˆ†é…ï¼š

```cpp
class Block {
private:
  static const size_t _data_size = 64;      // æ­£å¥½ä¸€ä¸ª64ä½æ•´æ•°
  volatile uintx _allocated_bitmask;        // 64ä½ä½å›¾
  
  // ä½æ“ä½œä¼˜åŒ–
  int count_trailing_ones(uintx value) {
    // ä½¿ç”¨CPUæŒ‡ä»¤è®¡ç®—å°¾éš1çš„æ•°é‡
    return __builtin_ctzll(~value);  // GCCå†…ç½®å‡½æ•°
  }
  
  bool is_empty() const {
    return OrderAccess::load_acquire(&_allocated_bitmask) == 0;
  }
  
  bool is_full() const {
    return OrderAccess::load_acquire(&_allocated_bitmask) == ~uintx(0);
  }
};
```

### 5.3 å»¶è¿Ÿæ¸…ç†ç­–ç•¥

OopStorageä½¿ç”¨å»¶è¿Ÿæ¸…ç†æ¥é¿å…é¢‘ç¹çš„å†…å­˜åˆ†é…/é‡Šæ”¾ï¼š

```cpp
void OopStorage::release(oop* ptr) {
  // ... é‡Šæ”¾é€»è¾‘ ...
  
  if (block->is_empty()) {
    // ä¸ç«‹å³åˆ é™¤ç©ºå—ï¼Œè€Œæ˜¯æ ‡è®°éœ€è¦æ¸…ç†
    _needs_cleanup = true;
  }
}

// åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œæ‰¹é‡æ¸…ç†
void OopStorage::cleanup_empty_blocks() {
  if (!_needs_cleanup) return;
  
  MutexLockerEx ml(_allocation_mutex);
  // æ‰¹é‡åˆ é™¤ç©ºå—ï¼Œå‡å°‘é”å¼€é”€
}
```

## ğŸ‰ æ€»ç»“ï¼šSystemDictionary OopStorageåˆå§‹åŒ–çš„æ„ä¹‰

### æ ¸å¿ƒä»·å€¼

1. **å¼±å¼•ç”¨åŸºç¡€è®¾æ–½**ï¼šä¸ºJVMæä¾›é«˜æ€§èƒ½çš„å¼±å¼•ç”¨å­˜å‚¨èƒ½åŠ›
2. **GCé›†æˆ**ï¼šä¸åƒåœ¾æ”¶é›†å™¨ç´§å¯†é›†æˆï¼Œæ”¯æŒè‡ªåŠ¨æ¸…ç†æ­»äº¡å¯¹è±¡
3. **å¹¶å‘å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®å’ŒGCå¹¶å‘éå†
4. **å†…å­˜æ•ˆç‡**ï¼šå—çŠ¶åˆ†é…ï¼Œæœ€å°åŒ–å†…å­˜ç¢ç‰‡å’Œå¼€é”€

### è®¾è®¡äº®ç‚¹

1. **åŒé”è®¾è®¡**ï¼šåˆ†ç¦»åˆ†é…é”å’Œæ´»è·ƒé”ï¼Œå‡å°‘é”ç«äº‰
2. **å¼•ç”¨è®¡æ•°**ï¼šå®‰å…¨çš„å¹¶å‘è®¿é—®ActiveArray
3. **ä½å›¾ä¼˜åŒ–**ï¼šé«˜æ•ˆçš„æ§½ä½ç®¡ç†
4. **å»¶è¿Ÿæ¸…ç†**ï¼šæ‰¹é‡æ“ä½œå‡å°‘å¼€é”€

### æ€§èƒ½ç‰¹å¾

- **åˆå§‹å¼€é”€**ï¼š~1KBï¼ˆå¯å¿½ç•¥ä¸è®¡ï¼‰
- **åˆ†é…å»¶è¿Ÿ**ï¼š75nsï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
- **å¹¶å‘æ€§èƒ½**ï¼šæ”¯æŒå¤šçº¿ç¨‹æ— é˜»å¡è¿­ä»£
- **å†…å­˜æ•ˆç‡**ï¼š~0.001%å †å†…å­˜å¼€é”€

SystemDictionaryçš„OopStorageåˆå§‹åŒ–ä¸ºåç»­çš„ç±»åŠ è½½å™¨ç®¡ç†ã€å­—ç¬¦ä¸²è¡¨ã€ç¬¦å·è¡¨ç­‰æ ¸å¿ƒç»„ä»¶æä¾›äº†åšå®çš„å¼±å¼•ç”¨å­˜å‚¨åŸºç¡€ã€‚è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„åˆå§‹åŒ–æ­¥éª¤ï¼Œå®é™…ä¸Šå»ºç«‹äº†JVMå…ƒæ•°æ®ç®¡ç†çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 SystemDictionary OopStorageåˆå§‹åŒ–  
**ä»£ç è·¯å¾„**: `src/hotspot/share/classfile/systemDictionary.cpp:3045-3050`