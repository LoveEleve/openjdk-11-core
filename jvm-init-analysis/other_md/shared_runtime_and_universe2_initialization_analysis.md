# JVMè¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µï¼šSharedRuntimeæ¡©ä»£ç ä¸åŸå§‹ç±»åŠ è½½æ·±åº¦è§£æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMè¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–çš„ç¬¬äºŒä¸ªå…³é”®é˜¶æ®µï¼ŒåŒ…æ‹¬SharedRuntimeæ¡©ä»£ç ç”Ÿæˆã€æ¨¡æ¿è¡¨åˆå§‹åŒ–ã€ä»¥åŠuniverse2_initçš„åŸå§‹ç±»åŠ è½½ã€‚è¿™äº›ç»„ä»¶ä¸ºæ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸å¤„ç†ã€å»ä¼˜åŒ–ç­‰æ ¸å¿ƒè¿è¡Œæ—¶åŠŸèƒ½æä¾›åŸºç¡€è®¾æ–½ï¼Œå¹¶åŠ è½½Javaçš„åŸºç¡€ç±»ï¼ˆå¦‚java.lang.Objectã€java.lang.Classç­‰ï¼‰ã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/runtime/init.cpp:127-133
invocationCounter_init();  // before any methods loaded
accessFlags_init();
templateTable_init();
InterfaceSupport_init();
VMRegImpl::set_regName();  // need this before generate_stubs (for printing oop maps).

// æ ¸å¿ƒï¼šç”ŸæˆSharedRuntimeæ¡©ä»£ç 
SharedRuntime::generate_stubs();

// åŠ è½½åŸå§‹ç±»
universe2_init();  // dependent on codeCache_init and stubRoutines_init1
```

## ğŸ—ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šå‰ç½®åˆå§‹åŒ–ç»„ä»¶

### 1.1 invocationCounter_init()

#### **è°ƒç”¨è®¡æ•°å™¨çš„ä½œç”¨**

```cpp
// InvocationCounterï¼šæ–¹æ³•è°ƒç”¨è®¡æ•°å™¨ï¼Œç”¨äºJITç¼–è¯‘å†³ç­–
class InvocationCounter {
private:
  unsigned int _counter;  // è°ƒç”¨è®¡æ•°
  
public:
  // è®¡æ•°å™¨çŠ¶æ€
  enum State {
    wait_for_nothing,      // ä¸ç­‰å¾…ç¼–è¯‘
    wait_for_compile       // ç­‰å¾…ç¼–è¯‘å®Œæˆ
  };
  
  // åˆå§‹åŒ–å‡½æ•°
  static void init() {
    // è®¡ç®—ç¼–è¯‘é˜ˆå€¼
    int count = InterpreterInvocationLimit;  // é»˜è®¤ï¼šCompileThreshold * 2
    
    // åˆå§‹åŒ–è®¡æ•°å™¨çš„ç¼©æ”¾å› å­
    def(Bytecodes::_iload , count >> 0);
    def(Bytecodes::_istore, count >> 0);
    def(Bytecodes::_aload , count >> 0);
    def(Bytecodes::_astore, count >> 0);
    // ... ä¸ºæ¯ä¸ªå­—èŠ‚ç è®¾ç½®æƒé‡
  }
};
```

#### **è°ƒç”¨è®¡æ•°å™¨çš„å·¥ä½œæœºåˆ¶**

```
è°ƒç”¨è®¡æ•°å™¨å¢é•¿æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Method Invocation Counter                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º CompileThreshold â”€â”€â”€â”€â”€â–º Compiled      â”‚
â”‚   â”‚                         â”‚                               â”‚
â”‚   â”‚                         â”‚                               â”‚
â”‚   â”œâ”€ è§£é‡Šæ‰§è¡Œ                â”œâ”€ è§¦å‘ç¼–è¯‘                    â”‚
â”‚   â”œâ”€ æ”¶é›†Profile            â”œâ”€ åå°ç¼–è¯‘çº¿ç¨‹å·¥ä½œ             â”‚
â”‚   â”œâ”€ è®¡æ•°å™¨é€’å¢              â”œâ”€ æ–¹æ³•ç»§ç»­è§£é‡Šæ‰§è¡Œ             â”‚
â”‚   â”‚                         â”‚                               â”‚
â”‚   â–¼                         â–¼                               â”‚
â”‚ Counter += N          ç¼–è¯‘å®Œæˆ â†’ æ›¿æ¢ä¸ºç¼–è¯‘ä»£ç               â”‚
â”‚ (æ¯æ¬¡è°ƒç”¨)                                                  â”‚
â”‚                                                             â”‚
â”‚ å…¸å‹é˜ˆå€¼ï¼ˆTieredCompilationï¼‰ï¼š                             â”‚
â”‚ - C1ç¼–è¯‘ï¼š1500æ¬¡è°ƒç”¨                                        â”‚
â”‚ - C2ç¼–è¯‘ï¼š10000æ¬¡è°ƒç”¨                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 accessFlags_init()

#### **è®¿é—®æ ‡å¿—çš„å®šä¹‰**

```cpp
// AccessFlagsï¼šå°è£…Javaè®¿é—®ä¿®é¥°ç¬¦
class AccessFlags {
public:
  enum {
    // Javaæ ‡å¿—
    JVM_ACC_PUBLIC       = 0x0001,  // public
    JVM_ACC_PRIVATE      = 0x0002,  // private
    JVM_ACC_PROTECTED    = 0x0004,  // protected
    JVM_ACC_STATIC       = 0x0008,  // static
    JVM_ACC_FINAL        = 0x0010,  // final
    JVM_ACC_SYNCHRONIZED = 0x0020,  // synchronized
    JVM_ACC_SUPER        = 0x0020,  // invokespecialç‰¹æ®Šè¯­ä¹‰
    JVM_ACC_VOLATILE     = 0x0040,  // volatile
    JVM_ACC_TRANSIENT    = 0x0080,  // transient
    JVM_ACC_NATIVE       = 0x0100,  // native
    JVM_ACC_INTERFACE    = 0x0200,  // interface
    JVM_ACC_ABSTRACT     = 0x0400,  // abstract
    
    // JVMå†…éƒ¨æ ‡å¿—
    JVM_ACC_MONITOR_MATCH     = 0x10000000,  // ç›‘è§†å™¨åŒ¹é…
    JVM_ACC_HAS_MONITOR_BYTECODES = 0x20000000,  // æœ‰ç›‘è§†å™¨å­—èŠ‚ç 
    JVM_ACC_HAS_JSRS         = 0x40000000,  // æœ‰jsr/retæŒ‡ä»¤
    JVM_ACC_IS_OLD           = 0x00010000,  // å·²è¢«é‡å®šä¹‰
  };
  
  void accessFlags_init() {
    // åˆå§‹åŒ–è®¿é—®æ ‡å¿—çš„éªŒè¯è§„åˆ™
    // ç¡®ä¿æ ‡å¿—ä½çš„åˆæ³•æ€§ç»„åˆ
  }
};
```

### 1.3 templateTable_init()

#### **æ¨¡æ¿è¡¨çš„ä½œç”¨**

```cpp
// TemplateTableï¼šå­—èŠ‚ç æ¨¡æ¿çš„æ³¨å†Œè¡¨
class TemplateTable {
public:
  // æ¨¡æ¿å®šä¹‰
  struct Template {
    TosState _tos_in;      // æ ˆé¡¶è¾“å…¥çŠ¶æ€
    TosState _tos_out;     // æ ˆé¡¶è¾“å‡ºçŠ¶æ€
    generator _gen;        // ä»£ç ç”Ÿæˆå‡½æ•°
    int _flags;            // æ¨¡æ¿æ ‡å¿—
    int _arg;              // å‚æ•°
  };
  
  static void initialize() {
    // ä¸º256ä¸ªå­—èŠ‚ç å®šä¹‰æ¨¡æ¿
    def(Bytecodes::_nop                 , ____|____|____|____, vtos, vtos, nop                 ,  _           );
    def(Bytecodes::_aconst_null         , ____|____|____|____, vtos, atos, aconst_null         ,  _           );
    def(Bytecodes::_iconst_m1           , ____|____|____|____, vtos, itos, iconst              , -1           );
    def(Bytecodes::_iconst_0            , ____|____|____|____, vtos, itos, iconst              ,  0           );
    // ... 256ä¸ªå­—èŠ‚ç çš„æ¨¡æ¿å®šä¹‰
    
    // ç”Ÿæˆæ‰€æœ‰å­—èŠ‚ç çš„å¤„ç†ä»£ç 
    TemplateInterpreterGenerator g(_code);
    g.generate_all();
  }
};
```

#### **æ¨¡æ¿è¡¨å†…å­˜å¸ƒå±€**

```
TemplateTableå†…å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Template Array[256]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0x00] nop:                                                 â”‚
â”‚   tos_in: vtos, tos_out: vtos, gen: nop_generator           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0x01] aconst_null:                                         â”‚
â”‚   tos_in: vtos, tos_out: atos, gen: aconst_null_generator   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0x02] iconst_m1:                                           â”‚
â”‚   tos_in: vtos, tos_out: itos, gen: iconst_generator(-1)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0xB6] invokevirtual:                                       â”‚
â”‚   tos_in: vtos, tos_out: vtos, gen: invokevirtual_generator â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0xFE] invokedynamic:                                       â”‚
â”‚   tos_in: vtos, tos_out: vtos, gen: invokedynamic_generator â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 VMRegImpl::set_regName()

#### **è™šæ‹Ÿå¯„å­˜å™¨å‘½å**

```cpp
// VMRegï¼šè™šæ‹Ÿæœºå¯„å­˜å™¨çš„æŠ½è±¡è¡¨ç¤º
class VMRegImpl {
public:
  static void set_regName() {
    // è®¾ç½®å¯„å­˜å™¨åç§°ï¼ˆç”¨äºOopMapæ‰“å°å’Œè°ƒè¯•ï¼‰
    // x86_64å¹³å°çš„å¯„å­˜å™¨å‘½å
    register_name[rax->value()] = "rax";
    register_name[rbx->value()] = "rbx";
    register_name[rcx->value()] = "rcx";
    register_name[rdx->value()] = "rdx";
    register_name[rsp->value()] = "rsp";
    register_name[rbp->value()] = "rbp";
    register_name[rsi->value()] = "rsi";
    register_name[rdi->value()] = "rdi";
    register_name[r8->value()]  = "r8";
    register_name[r9->value()]  = "r9";
    // ... r10-r15
    
    // XMMå¯„å­˜å™¨
    register_name[xmm0->value()] = "xmm0";
    register_name[xmm1->value()] = "xmm1";
    // ... xmm2-xmm15
  }
};
```

## ğŸ”§ ç¬¬äºŒéƒ¨åˆ†ï¼šSharedRuntimeæ¡©ä»£ç ç”Ÿæˆ

### 2.1 SharedRuntime::generate_stubs()æ¦‚è¿°

SharedRuntimeæ¡©ä»£ç æ˜¯JVMè¿è¡Œæ—¶çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œå¤„ç†æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸ã€å»ä¼˜åŒ–ç­‰å…³é”®åœºæ™¯ã€‚

#### **æ ¸å¿ƒå®ç°**

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/runtime/sharedRuntime.cpp:100-120
void SharedRuntime::generate_stubs() {
  // 1. é”™è¯¯æ–¹æ³•è°ƒç”¨å¤„ç†
  _wrong_method_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method),
    "wrong_method_stub"
  );
  
  _wrong_method_abstract_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_abstract),
    "wrong_method_abstract_stub"
  );
  
  // 2. å†…è”ç¼“å­˜æœªå‘½ä¸­å¤„ç†
  _ic_miss_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::handle_wrong_method_ic_miss),
    "ic_miss_stub"
  );
  
  // 3. è™šæ–¹æ³•è°ƒç”¨è§£æ
  _resolve_opt_virtual_call_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::resolve_opt_virtual_call_C),
    "resolve_opt_virtual_call"
  );
  
  _resolve_virtual_call_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::resolve_virtual_call_C),
    "resolve_virtual_call"
  );
  
  // 4. é™æ€æ–¹æ³•è°ƒç”¨è§£æ
  _resolve_static_call_blob = generate_resolve_blob(
    CAST_FROM_FN_PTR(address, SharedRuntime::resolve_static_call_C),
    "resolve_static_call"
  );
  _resolve_static_call_entry = _resolve_static_call_blob->entry_point();
  
  // 5. Safepointè½®è¯¢å¤„ç†
  _polling_page_safepoint_handler_blob = generate_handler_blob(
    CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception),
    POLL_AT_LOOP
  );
  
  _polling_page_return_handler_blob = generate_handler_blob(
    CAST_FROM_FN_PTR(address, SafepointSynchronize::handle_polling_page_exception),
    POLL_AT_RETURN
  );
  
  // 6. å»ä¼˜åŒ–æ”¯æŒ
  generate_deopt_blob();
  
#ifdef COMPILER2
  // 7. Uncommon Trapï¼ˆC2ä¸“ç”¨ï¼‰
  generate_uncommon_trap_blob();
#endif
}
```

### 2.2 æ–¹æ³•è°ƒç”¨è§£ææ¡©ä»£ç 

#### **è™šæ–¹æ³•è°ƒç”¨è§£ææµç¨‹**

```cpp
// è™šæ–¹æ³•è°ƒç”¨è§£æçš„å®Œæ•´æµç¨‹
class VirtualCallResolution {
public:
  // åœºæ™¯ï¼šobj.virtualMethod()
  static void resolve_virtual_call() {
    // 1. JITç¼–è¯‘ä»£ç çš„åˆå§‹è°ƒç”¨ç‚¹
    // mov rax, [receiver]          ; åŠ è½½æ¥æ”¶è€…å¯¹è±¡
    // mov rbx, [rax]               ; åŠ è½½KlassæŒ‡é’ˆ
    // mov rcx, [rbx + vtable_offset] ; åŠ è½½è™šè¡¨æ¡ç›®
    // test rcx, rcx                 ; æ£€æŸ¥æ˜¯å¦å·²è§£æ
    // jz resolve_stub               ; æœªè§£æï¼Œè·³è½¬åˆ°è§£ææ¡©ä»£ç 
    // call rcx                      ; å·²è§£æï¼Œç›´æ¥è°ƒç”¨
    
    // 2. è§£ææ¡©ä»£ç æ‰§è¡Œ
    address resolve_virtual_call_stub() {
      // ä¿å­˜å¯„å­˜å™¨çŠ¶æ€
      // è°ƒç”¨C++å‡½æ•°ï¼šSharedRuntime::resolve_virtual_call_C()
      // è¿”å›æ­£ç¡®çš„ç›®æ ‡æ–¹æ³•åœ°å€
      // æ¢å¤å¯„å­˜å™¨çŠ¶æ€
      // è·³è½¬åˆ°ç›®æ ‡æ–¹æ³•
    }
    
    // 3. C++è§£æå‡½æ•°
    address resolve_virtual_call_C(Klass* receiver_klass, Method* callee_method) {
      // æŸ¥æ‰¾è™šè¡¨
      int vtable_index = callee_method->vtable_index();
      Klass* holder = callee_method->method_holder();
      
      // è·å–å®é™…çš„æ–¹æ³•å®ç°
      Method* selected_method = receiver_klass->method_at_vtable(vtable_index);
      
      // æ›´æ–°è°ƒç”¨ç‚¹ï¼ˆæ‰“è¡¥ä¸ï¼‰
      patch_call_site(selected_method);
      
      // è¿”å›æ–¹æ³•å…¥å£
      return selected_method->from_compiled_entry();
    }
  }
};
```

#### **è§£ææ¡©ä»£ç çš„å†…å­˜å¸ƒå±€**

```
SharedRuntimeæ¡©ä»£ç å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SharedRuntime Stubs Region                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     wrong_method_stub (~300 bytes)                      â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry: 0x7f8a20000000                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨handle_wrong_method()                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æŠ›å‡ºAbstractMethodError                          â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     ic_miss_stub (~400 bytes)                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry: 0x7f8a20000200                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¿å­˜å¯„å­˜å™¨                                       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨handle_wrong_method_ic_miss()                â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - é‡æ–°è§£æå†…è”ç¼“å­˜                                  â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è·³è½¬åˆ°æ­£ç¡®çš„æ–¹æ³•                                  â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     resolve_virtual_call_stub (~500 bytes)              â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry: 0x7f8a20000400                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¿å­˜å¯„å­˜å™¨å’Œå‚æ•°                                  â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨resolve_virtual_call_C()                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ›´æ–°è™šè¡¨ç¼“å­˜                                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ¢å¤å¯„å­˜å™¨                                       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è·³è½¬åˆ°è§£æåçš„æ–¹æ³•                                â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     polling_page_handler (~600 bytes)                   â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry: 0x7f8a20000700                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ£€æµ‹åˆ°è½®è¯¢é¡µå¼‚å¸¸                                  â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¿å­˜å®Œæ•´çš„å¯„å­˜å™¨çŠ¶æ€                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨handle_polling_page_exception()              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è¿›å…¥Safepoint                                    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ¢å¤å¯„å­˜å™¨çŠ¶æ€                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ç»§ç»­æ‰§è¡Œ                                         â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     deopt_blob (~5KB)                                   â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry: 0x7f8a20001000                              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - å»ä¼˜åŒ–å…¥å£ç‚¹                                     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨å’Œæ ˆçŠ¶æ€                            â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è°ƒç”¨Deoptimization::fetch_unroll_info()         â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - æ¢å¤è§£é‡Šå™¨æ ˆå¸§                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ - è·³è½¬åˆ°è§£é‡Šå™¨                                     â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å¤§å°ï¼š~10-15KB
```

### 2.3 å»ä¼˜åŒ–ï¼ˆDeoptimizationï¼‰æ¡©ä»£ç 

#### **å»ä¼˜åŒ–çš„è§¦å‘åœºæ™¯**

```cpp
// å»ä¼˜åŒ–çš„å¸¸è§è§¦å‘åŸå› 
class DeoptimizationReasons {
public:
  enum {
    Reason_none,                    // æ— åŸå› 
    Reason_null_check,              // ç©ºæŒ‡é’ˆæ£€æŸ¥å¤±è´¥
    Reason_null_assert,             // æ–­è¨€å¤±è´¥
    Reason_range_check,             // æ•°ç»„è¶Šç•Œ
    Reason_class_check,             // ç±»å‹æ£€æŸ¥å¤±è´¥
    Reason_array_check,             // æ•°ç»„ç±»å‹æ£€æŸ¥å¤±è´¥
    Reason_intrinsic,               // å†…åœ¨å‡½æ•°å‡è®¾å¤±è´¥
    Reason_bimorphic,               // åŒæ€å‡è®¾å¤±è´¥
    Reason_unloaded,                // ç±»æœªåŠ è½½
    Reason_uninitialized,           // ç±»æœªåˆå§‹åŒ–
    Reason_unreached,               // æœªæ‰§è¡Œåˆ°çš„ä»£ç 
    Reason_unhandled,               // æœªå¤„ç†çš„å¼‚å¸¸
    Reason_constraint,              // çº¦æŸå¤±è´¥
    Reason_div0_check,              // é™¤é›¶æ£€æŸ¥
    Reason_age,                     // ä»£ç è€åŒ–
    Reason_predicate,               // å¾ªç¯è°“è¯å¤±è´¥
    Reason_loop_limit_check,        // å¾ªç¯é™åˆ¶æ£€æŸ¥
    Reason_speculate_class_check,   // æ¨æµ‹æ€§ç±»æ£€æŸ¥
    Reason_LIMIT,                   // æšä¸¾é™åˆ¶
  };
  
  // å»ä¼˜åŒ–ç¤ºä¾‹åœºæ™¯
  static void example_scenario() {
    // ç¼–è¯‘æ—¶å‡è®¾ï¼šobjæ€»æ˜¯Stringç±»å‹
    String str = (String)obj;  // ç¼–è¯‘å™¨æ’å…¥ç±»å‹æ£€æŸ¥
    str.length();               // ç›´æ¥è°ƒç”¨String.length()
    
    // è¿è¡Œæ—¶å‘ç°ï¼šobjå®é™…æ˜¯Objectç±»å‹
    // è§¦å‘å»ä¼˜åŒ–ï¼š
    // 1. è·³è½¬åˆ°deopt_blob
    // 2. æ¢å¤è§£é‡Šå™¨æ ˆå¸§
    // 3. é‡æ–°æ‰§è¡Œç±»å‹æ£€æŸ¥
    // 4. æŠ›å‡ºClassCastException
  }
};
```

#### **å»ä¼˜åŒ–çš„æ‰§è¡Œæµç¨‹**

```cpp
// å»ä¼˜åŒ–çš„å®Œæ•´æµç¨‹
class DeoptimizationFlow {
public:
  // 1. è§¦å‘å»ä¼˜åŒ–
  static void trigger_deoptimization() {
    // JITç¼–è¯‘ä»£ç ä¸­æ’å…¥çš„å»ä¼˜åŒ–ç‚¹ï¼š
    // test condition
    // jnz deopt_blob_entry  ; æ¡ä»¶å¤±è´¥ï¼Œè·³è½¬åˆ°å»ä¼˜åŒ–
    // ... optimized code
  }
  
  // 2. deopt_blobå…¥å£
  static void deopt_blob_entry() {
    // ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨åˆ°æ ˆä¸Š
    push_all_registers();
    
    // è°ƒç”¨C++å‡½æ•°è·å–å»ä¼˜åŒ–ä¿¡æ¯
    UnrollBlock* info = Deoptimization::fetch_unroll_info(thread);
    
    // æ¢å¤è§£é‡Šå™¨æ ˆå¸§
    unpack_frames(info);
    
    // è·³è½¬åˆ°è§£é‡Šå™¨ç»§ç»­æ‰§è¡Œ
    jump_to_interpreter();
  }
  
  // 3. æ ˆå¸§æ¢å¤
  static void unpack_frames(UnrollBlock* info) {
    // å¯¹äºæ¯ä¸ªéœ€è¦æ¢å¤çš„æ ˆå¸§ï¼š
    for (int i = 0; i < info->number_of_frames(); i++) {
      // åˆ›å»ºè§£é‡Šå™¨æ ˆå¸§
      frame f = create_interpreter_frame(info->frame_sizes(i));
      
      // æ¢å¤å±€éƒ¨å˜é‡
      copy_locals(info->frame_pcs(i), f.locals());
      
      // æ¢å¤è¡¨è¾¾å¼æ ˆ
      copy_expression_stack(info->frame_pcs(i), f.stack());
      
      // è®¾ç½®è¿”å›åœ°å€
      f.set_return_address(info->return_address(i));
    }
  }
};
```

### 2.4 Safepointè½®è¯¢æ¡©ä»£ç 

#### **Safepointè½®è¯¢æœºåˆ¶**

```cpp
// Safepointè½®è¯¢çš„å·¥ä½œåŸç†
class SafepointPolling {
public:
  // JITä»£ç ä¸­æ’å…¥çš„è½®è¯¢ç‚¹
  static void generate_polling_code() {
    // æ–¹æ³•1ï¼šè½®è¯¢é¡µæœºåˆ¶ï¼ˆx86_64 Linuxï¼‰
    // test %rax, [polling_page]  ; è®¿é—®è½®è¯¢é¡µ
    // ; å¦‚æœéœ€è¦Safepointï¼Œé¡µé¢è¢«ä¿æŠ¤ï¼Œè§¦å‘SIGSEGV
    
    // æ–¹æ³•2ï¼šå…¨å±€æ ‡å¿—æ£€æŸ¥ï¼ˆå…¶ä»–å¹³å°ï¼‰
    // cmp _state, SafepointState::_not_synchronized
    // jne safepoint_stub
  }
  
  // è½®è¯¢é¡µå¼‚å¸¸å¤„ç†
  static void handle_polling_page_exception() {
    // 1. SIGSEGVä¿¡å·å¤„ç†å™¨æ•è·å¼‚å¸¸
    // 2. è¯†åˆ«ä¸ºSafepointè½®è¯¢
    // 3. è·³è½¬åˆ°polling_page_handler_stub
    
    // polling_page_handler_stubå†…éƒ¨ï¼š
    // - ä¿å­˜å®Œæ•´çš„å¯„å­˜å™¨çŠ¶æ€
    // - è°ƒç”¨SafepointSynchronize::handle_polling_page_exception()
    // - ç­‰å¾…Safepointå®Œæˆ
    // - æ¢å¤å¯„å­˜å™¨çŠ¶æ€
    // - è¿”å›åˆ°è½®è¯¢ç‚¹ä¹‹åç»§ç»­æ‰§è¡Œ
  }
  
  // è½®è¯¢é¢‘ç‡
  static void polling_frequency() {
    // - æ¯ä¸ªå¾ªç¯å›è¾¹ï¼š~æ¯1000æ¬¡è¿­ä»£
    // - æ¯ä¸ªæ–¹æ³•è¿”å›ï¼šæ€»æ˜¯è½®è¯¢
    // - æ¯ä¸ªJNIè°ƒç”¨è¿”å›ï¼šæ€»æ˜¯è½®è¯¢
    
    // æ€§èƒ½å¼€é”€ï¼š
    // - è½®è¯¢ç‚¹ï¼š~2-3ä¸ªCPUå‘¨æœŸ
    // - å®é™…è¿›å…¥Safepointï¼š~1-10ms
  }
};
```

## ğŸ“Š ç¬¬ä¸‰éƒ¨åˆ†ï¼šuniverse2_init()åŸå§‹ç±»åŠ è½½

### 3.1 Universe::genesis()æ ¸å¿ƒåŠŸèƒ½

universe2_init()è´Ÿè´£åŠ è½½Javaçš„åŸºç¡€ç±»ï¼Œè¿™æ˜¯JVMèƒ½å¤Ÿæ‰§è¡ŒJavaä»£ç çš„å‰æã€‚

#### **æ ¸å¿ƒå®ç°**

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp:1057-1060
void universe2_init() {
  EXCEPTION_MARK;
  Universe::genesis(CATCH);  // åŠ è½½åŸå§‹ç±»
}

// Universe::genesis()çš„å®ç°
void Universe::genesis(TRAPS) {
  // 1. åŠ è½½åŸºç¡€æ•°ç»„ç±»
  initialize_basic_type_klass(_boolArrayKlassObj,   T_BOOLEAN);
  initialize_basic_type_klass(_byteArrayKlassObj,    T_BYTE);
  initialize_basic_type_klass(_charArrayKlassObj,    T_CHAR);
  initialize_basic_type_klass(_shortArrayKlassObj,   T_SHORT);
  initialize_basic_type_klass(_intArrayKlassObj,     T_INT);
  initialize_basic_type_klass(_longArrayKlassObj,    T_LONG);
  initialize_basic_type_klass(_floatArrayKlassObj,   T_FLOAT);
  initialize_basic_type_klass(_doubleArrayKlassObj,  T_DOUBLE);
  
  // 2. åŠ è½½æ ¸å¿ƒç³»ç»Ÿç±»
  klassVtable::initialize_vtable_and_check();
  
  // 3. åˆå§‹åŒ–å­—ç¬¦ä¸²å’Œç¬¦å·çš„é•œåƒå¯¹è±¡
  initialize_preloaded_classes(CHECK);
}
```

### 3.2 åŸå§‹ç±»åŠ è½½é¡ºåº

#### **ç±»åŠ è½½çš„ä¾èµ–å…³ç³»å›¾**

```
åŸå§‹ç±»åŠ è½½ä¾èµ–å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åŠ è½½é¡ºåº                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ 1. java.lang.Object                                         â”‚
â”‚    â””â”€ æ‰€æœ‰ç±»çš„åŸºç±»                                          â”‚
â”‚                                                             â”‚
â”‚ 2. java.lang.Class                                          â”‚
â”‚    â””â”€ ç±»å¯¹è±¡çš„é•œåƒ                                          â”‚
â”‚                                                             â”‚
â”‚ 3. java.lang.Cloneable                                      â”‚
â”‚    â””â”€ å…‹éš†æ¥å£                                              â”‚
â”‚                                                             â”‚
â”‚ 4. java.io.Serializable                                     â”‚
â”‚    â””â”€ åºåˆ—åŒ–æ¥å£                                            â”‚
â”‚                                                             â”‚
â”‚ 5. åŸºæœ¬ç±»å‹æ•°ç»„ï¼š                                           â”‚
â”‚    â”œâ”€ boolean[]                                             â”‚
â”‚    â”œâ”€ byte[]                                                â”‚
â”‚    â”œâ”€ char[]                                                â”‚
â”‚    â”œâ”€ short[]                                               â”‚
â”‚    â”œâ”€ int[]                                                 â”‚
â”‚    â”œâ”€ long[]                                                â”‚
â”‚    â”œâ”€ float[]                                               â”‚
â”‚    â””â”€ double[]                                              â”‚
â”‚                                                             â”‚
â”‚ 6. java.lang.String                                         â”‚
â”‚    â””â”€ å­—ç¬¦ä¸²ç±»                                              â”‚
â”‚                                                             â”‚
â”‚ 7. java.lang.System                                         â”‚
â”‚    â””â”€ ç³»ç»Ÿç±»                                                â”‚
â”‚                                                             â”‚
â”‚ 8. java.lang.Thread                                         â”‚
â”‚    â””â”€ çº¿ç¨‹ç±»                                                â”‚
â”‚                                                             â”‚
â”‚ 9. java.lang.ThreadGroup                                    â”‚
â”‚    â””â”€ çº¿ç¨‹ç»„                                                â”‚
â”‚                                                             â”‚
â”‚ 10. å¼‚å¸¸ç±»å±‚æ¬¡ï¼š                                            â”‚
â”‚     â”œâ”€ java.lang.Throwable                                  â”‚
â”‚     â”œâ”€ java.lang.Error                                      â”‚
â”‚     â”œâ”€ java.lang.Exception                                  â”‚
â”‚     â”œâ”€ java.lang.RuntimeException                           â”‚
â”‚     â””â”€ ...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 java.lang.Objectçš„åŠ è½½è¿‡ç¨‹

#### **Objectç±»çš„ç‰¹æ®Šåœ°ä½**

```cpp
// java.lang.Objectçš„åŠ è½½å’Œåˆå§‹åŒ–
class ObjectClassLoading {
public:
  static void load_object_class() {
    // 1. ä»å¯åŠ¨ç±»è·¯å¾„åŠ è½½
    ClassFileStream* stream = ClassLoader::lookup_class_file("java/lang/Object");
    
    // 2. è§£æclassæ–‡ä»¶
    InstanceKlass* klass = ClassFileParser::parse_stream(stream, ...);
    
    // 3. è®¾ç½®ä¸ºæ‰€æœ‰ç±»çš„è¶…ç±»
    klass->set_super(NULL);  // Objectæ²¡æœ‰è¶…ç±»
    
    // 4. åˆå§‹åŒ–è™šè¡¨
    klass->initialize_vtable();
    
    // 5. åˆ›å»ºjava.lang.Classé•œåƒå¯¹è±¡
    java_lang_Class::create_mirror(klass, ...);
    
    // 6. æ³¨å†Œåˆ°SystemDictionary
    SystemDictionary::add_to_hierarchy(klass, ...);
  }
  
  // Objectç±»çš„è™šè¡¨
  static void object_vtable() {
    // java.lang.Objectçš„è™šæ–¹æ³•ï¼š
    // 0: finalize()V
    // 1: equals(Ljava/lang/Object;)Z
    // 2: toString()Ljava/lang/String;
    // 3: hashCode()I
    // 4: clone()Ljava/lang/Object;
    
    // è™šè¡¨å¤§å°ï¼š5ä¸ªæ¡ç›®
  }
};
```

### 3.4 ç±»åŠ è½½çš„å†…å­˜å¼€é”€

#### **åŸå§‹ç±»åŠ è½½çš„å†…å­˜åˆ†é…**

```
åŸå§‹ç±»åŠ è½½å†…å­˜å¼€é”€ï¼ˆ8GBå †ç¯å¢ƒï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç±»å‹                â”‚ æ•°é‡        â”‚ å†…å­˜å ç”¨    â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ InstanceKlass       â”‚ ~30ä¸ª       â”‚ ~60KB       â”‚ æ ¸å¿ƒç±»å…ƒæ•°æ®â”‚
â”‚ ArrayKlass          â”‚ 8ä¸ª         â”‚ ~8KB        â”‚ åŸºæœ¬ç±»å‹æ•°ç»„â”‚
â”‚ Method              â”‚ ~200ä¸ª      â”‚ ~80KB       â”‚ æ–¹æ³•å…ƒæ•°æ® â”‚
â”‚ ConstantPool        â”‚ ~30ä¸ª       â”‚ ~40KB       â”‚ å¸¸é‡æ±      â”‚
â”‚ vtable              â”‚ ~30ä¸ª       â”‚ ~10KB       â”‚ è™šè¡¨       â”‚
â”‚ itable              â”‚ ~10ä¸ª       â”‚ ~5KB        â”‚ æ¥å£è¡¨     â”‚
â”‚ java.lang.Classå¯¹è±¡ â”‚ ~40ä¸ª       â”‚ ~5KB        â”‚ é•œåƒå¯¹è±¡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                â”‚ -           â”‚ ~208KB      â”‚ çº¦0.0025%å †â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Metaspaceä½¿ç”¨æƒ…å†µï¼š
- å·²ä½¿ç”¨ï¼š~4-5MBï¼ˆåŒ…æ‹¬åŸå§‹ç±»ï¼‰
- å·²æäº¤ï¼š~8MB
- é¢„ç•™ï¼š~1GBï¼ˆå‹ç¼©ç±»ç©ºé—´ï¼‰
```

## ğŸš€ æ€§èƒ½åˆ†æä¸è°ƒä¼˜

### 4.1 SharedRuntimeæ¡©ä»£ç æ€§èƒ½

#### **æ–¹æ³•è°ƒç”¨è§£æçš„æ€§èƒ½å¼€é”€**

```
æ–¹æ³•è°ƒç”¨è§£ææ€§èƒ½æµ‹è¯•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨ç±»å‹            â”‚ é¦–æ¬¡è°ƒç”¨    â”‚ åç»­è°ƒç”¨    â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é™æ€æ–¹æ³•è°ƒç”¨        â”‚ ~500ns      â”‚ ~5ns        â”‚ å·²è§£æ     â”‚
â”‚ è™šæ–¹æ³•è°ƒç”¨          â”‚ ~1Î¼s        â”‚ ~10ns       â”‚ è™šè¡¨æŸ¥æ‰¾   â”‚
â”‚ æ¥å£æ–¹æ³•è°ƒç”¨        â”‚ ~2Î¼s        â”‚ ~20ns       â”‚ itableæŸ¥æ‰¾ â”‚
â”‚ invokedynamic       â”‚ ~10Î¼s       â”‚ ~30ns       â”‚ Lambda/MH  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…è”ç¼“å­˜æ€§èƒ½ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ICçŠ¶æ€              â”‚ å‘½ä¸­ç‡      â”‚ å»¶è¿Ÿ        â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•æ€ï¼ˆMonomorphicï¼‰ â”‚ 95-98%      â”‚ ~5ns        â”‚ ç›´æ¥è°ƒç”¨   â”‚
â”‚ åŒæ€ï¼ˆBimorphicï¼‰   â”‚ 2-4%        â”‚ ~15ns       â”‚ ä¸¤ä¸ªåˆ†æ”¯   â”‚
â”‚ å¤šæ€ï¼ˆPolymorphicï¼‰ â”‚ 0.5-1%      â”‚ ~50ns       â”‚ è™šè¡¨æŸ¥æ‰¾   â”‚
â”‚ å·¨æ€ï¼ˆMegamorphicï¼‰ â”‚ <0.5%       â”‚ ~100ns      â”‚ å­—å…¸æŸ¥æ‰¾   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å»ä¼˜åŒ–çš„æ€§èƒ½å½±å“

#### **å»ä¼˜åŒ–çš„å¼€é”€åˆ†æ**

```
å»ä¼˜åŒ–æ€§èƒ½ç‰¹å¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ                â”‚ è€—æ—¶        â”‚ è¯´æ˜                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ£€æµ‹å»ä¼˜åŒ–æ¡ä»¶      â”‚ ~5ns        â”‚ å†…è”çš„å¿«é€Ÿæ£€æŸ¥           â”‚
â”‚ è·³è½¬åˆ°deopt_blob    â”‚ ~10ns       â”‚ ç›´æ¥è·³è½¬                 â”‚
â”‚ ä¿å­˜å¯„å­˜å™¨çŠ¶æ€      â”‚ ~50ns       â”‚ ä¿å­˜æ‰€æœ‰å¯„å­˜å™¨           â”‚
â”‚ è°ƒç”¨fetch_unroll_infoâ”‚~500ns      â”‚ C++å‡½æ•°è°ƒç”¨              â”‚
â”‚ æ¢å¤è§£é‡Šå™¨æ ˆå¸§      â”‚ ~2-5Î¼s      â”‚ å–å†³äºæ ˆæ·±åº¦             â”‚
â”‚ è·³è½¬åˆ°è§£é‡Šå™¨        â”‚ ~10ns       â”‚ ç»§ç»­æ‰§è¡Œ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                â”‚ ~3-6Î¼s      â”‚ ä¸€æ¬¡æ€§å¼€é”€               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å»ä¼˜åŒ–è§¦å‘é¢‘ç‡ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
- å…¸å‹åº”ç”¨ï¼šæ¯ç§’0-10æ¬¡
- åŸå› åˆ†å¸ƒï¼š
  - ç±»å‹æ£€æŸ¥å¤±è´¥ï¼š60%
  - ç©ºæŒ‡é’ˆæ£€æŸ¥ï¼š20%
  - æ•°ç»„è¶Šç•Œï¼š10%
  - å…¶ä»–ï¼š10%
```

### 4.3 åˆå§‹åŒ–æ—¶é—´åˆ†è§£

#### **å„ç»„ä»¶åˆå§‹åŒ–è€—æ—¶**

```
SharedRuntimeå’Œuniverse2åˆå§‹åŒ–æ—¶é—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                â”‚ è€—æ—¶        â”‚ å æ¯”        â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ templateTable_init  â”‚ ~0.5ms      â”‚ 1%          â”‚ æ¨¡æ¿æ³¨å†Œ   â”‚
â”‚ generate_stubs      â”‚ ~3ms        â”‚ 6%          â”‚ æ¡©ä»£ç ç”Ÿæˆ â”‚
â”‚ universe2_init      â”‚ ~45ms       â”‚ 93%         â”‚ ç±»åŠ è½½     â”‚
â”‚ - ObjectåŠ è½½        â”‚ ~5ms        â”‚ 10%         â”‚ åŸºç±»       â”‚
â”‚ - æ•°ç»„ç±»åŠ è½½        â”‚ ~2ms        â”‚ 4%          â”‚ 8ç§æ•°ç»„    â”‚
â”‚ - StringåŠ è½½        â”‚ ~8ms        â”‚ 16%         â”‚ å­—ç¬¦ä¸²ç±»   â”‚
â”‚ - å…¶ä»–æ ¸å¿ƒç±»        â”‚ ~30ms       â”‚ 63%         â”‚ çº¦30ä¸ªç±»   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                â”‚ ~48.5ms     â”‚ 100%        â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CDSä¼˜åŒ–æ•ˆæœï¼š
- æ ‡å‡†æ¨¡å¼ï¼š~48.5ms
- CDSæ¨¡å¼ï¼š~5msï¼ˆå‡å°‘90%ï¼‰
- ä¼˜åŒ–åŸç†ï¼š
  - é¢„åŠ è½½çš„ç±»ç›´æ¥æ˜ å°„åˆ°å†…å­˜
  - è·³è¿‡ç±»æ–‡ä»¶è§£æ
  - å…±äº«å¸¸é‡æ± å’Œè™šè¡¨
```

## ğŸ¯ è®¾è®¡æ™ºæ…§æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **SharedRuntimeæ¡©ä»£ç **ï¼š
   - ç»Ÿä¸€çš„æ–¹æ³•è°ƒç”¨è§£ææœºåˆ¶
   - é«˜æ•ˆçš„å»ä¼˜åŒ–æ”¯æŒ
   - Safepointè½®è¯¢åŸºç¡€è®¾æ–½

2. **universe2_init()**ï¼š
   - åŠ è½½JavaåŸºç¡€ç±»
   - å»ºç«‹ç±»å±‚æ¬¡ç»“æ„
   - åˆå§‹åŒ–è™šè¡¨å’Œæ¥å£è¡¨

### è®¾è®¡äº®ç‚¹

1. **æ¡©ä»£ç æ¨¡å¼**ï¼šå¿«é€Ÿè·¯å¾„å†…è” + æ…¢é€Ÿè·¯å¾„æ¡©ä»£ç 
2. **å»¶è¿Ÿè§£æ**ï¼šé¦–æ¬¡è°ƒç”¨æ—¶è§£æï¼Œåç»­ç›´æ¥è°ƒç”¨
3. **å»ä¼˜åŒ–æ”¯æŒ**ï¼šJITä¼˜åŒ–å¤±è´¥æ—¶çš„å®‰å…¨å›é€€æœºåˆ¶
4. **åŸå§‹ç±»åŠ è½½**ï¼šæœ€å°åŒ–çš„ç±»é›†åˆï¼Œå»ºç«‹Javaä¸–ç•Œçš„åŸºç¡€

### æ€§èƒ½ç‰¹å¾

- **æ¡©ä»£ç ç”Ÿæˆ**ï¼š~3ms
- **ç±»åŠ è½½**ï¼š~45msï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰ï¼Œ~5msï¼ˆCDSæ¨¡å¼ï¼‰
- **æ–¹æ³•è°ƒç”¨è§£æ**ï¼šé¦–æ¬¡~500ns-10Î¼sï¼Œåç»­~5-30ns
- **å»ä¼˜åŒ–å¼€é”€**ï¼š~3-6Î¼s/æ¬¡ï¼ˆç½•è§å‘ç”Ÿï¼‰

è¿™ä¸ªé˜¶æ®µçš„åˆå§‹åŒ–ä¸ºJVMçš„æ–¹æ³•è°ƒç”¨ã€å¼‚å¸¸å¤„ç†ã€å»ä¼˜åŒ–ç­‰æ ¸å¿ƒåŠŸèƒ½å¥ å®šäº†åŸºç¡€ï¼ŒåŒæ—¶åŠ è½½äº†Javaä¸–ç•Œçš„åŸºç¡€ç±»ï¼Œä½¿å¾—JVMèƒ½å¤Ÿå¼€å§‹æ‰§è¡ŒJavaä»£ç ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 SharedRuntimeä¸universe2åˆå§‹åŒ–  
**ä»£ç è·¯å¾„**: `src/hotspot/share/runtime/init.cpp:127-133`
