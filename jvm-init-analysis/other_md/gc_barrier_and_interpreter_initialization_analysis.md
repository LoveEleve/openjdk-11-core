# JVMè¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–ç¬¬ä¸€é˜¶æ®µï¼šGCå±éšœæ¡©ä»£ç ä¸è§£é‡Šå™¨æ·±åº¦è§£æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMè¿è¡Œæ—¶ç³»ç»Ÿåˆå§‹åŒ–çš„ç¬¬ä¸€ä¸ªå…³é”®é˜¶æ®µï¼ŒåŒ…æ‹¬GCå±éšœæ¡©ä»£ç ï¼ˆGC Barrier Stubsï¼‰å’Œè§£é‡Šå™¨ï¼ˆInterpreterï¼‰çš„åˆå§‹åŒ–ã€‚è¿™ä¸¤ä¸ªç»„ä»¶æ˜¯JVMæ‰§è¡ŒJavaå­—èŠ‚ç çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œåˆ†åˆ«è´Ÿè´£åƒåœ¾æ”¶é›†çš„å†™å±éšœæ”¯æŒå’Œå­—èŠ‚ç çš„è§£é‡Šæ‰§è¡Œã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/runtime/init.cpp:124-129
jint status = universe_init();  // universeåˆå§‹åŒ–å®Œæˆ
if (status != JNI_OK) return status;

// ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–GCå±éšœæ¡©ä»£ç 
gc_barrier_stubs_init();   // depends on universe_init, must be before interpreter_init

// ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–è§£é‡Šå™¨
interpreter_init();        // before any methods loaded

// ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–è°ƒç”¨è®¡æ•°å™¨
invocationCounter_init();  // before any methods loaded

// ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–è®¿é—®æ ‡å¿—
accessFlags_init();

// ç¬¬äº”æ­¥ï¼šåˆå§‹åŒ–æ¨¡æ¿è¡¨
templateTable_init();

// ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–æ¥å£æ”¯æŒ
InterfaceSupport_init();
```

## ğŸ—ï¸ ç¬¬ä¸€éƒ¨åˆ†ï¼šGCå±éšœæ¡©ä»£ç åˆå§‹åŒ–

### 1.1 GCå±éšœæ¦‚å¿µä¸ä½œç”¨

GCå±éšœï¼ˆGC Barrierï¼‰æ˜¯åƒåœ¾æ”¶é›†å™¨çš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œç”¨äºè¿½è¸ªå¯¹è±¡å¼•ç”¨çš„ä¿®æ”¹ï¼š

```cpp
// GCå±éšœçš„æ ¸å¿ƒä½œç”¨
class GCBarrierPurpose {
public:
  // 1. å†™å±éšœï¼ˆWrite Barrierï¼‰
  static void write_barrier_purpose() {
    // å½“å¯¹è±¡Açš„å­—æ®µè¢«ä¿®æ”¹ä¸ºæŒ‡å‘å¯¹è±¡Bæ—¶ï¼Œè®°å½•è¿™ä¸ªå¼•ç”¨å…³ç³»
    // ç”¨é€”ï¼š
    // - ç»´æŠ¤è®°å¿†é›†ï¼ˆRemembered Setï¼‰
    // - æ”¯æŒå¢é‡/å¹¶å‘åƒåœ¾æ”¶é›†
    // - è¿½è¸ªè·¨ä»£å¼•ç”¨ï¼ˆè€å¹´ä»£â†’æ–°ç”Ÿä»£ï¼‰
  }
  
  // 2. è¯»å±éšœï¼ˆRead Barrierï¼‰
  static void read_barrier_purpose() {
    // æŸäº›GCç®—æ³•ï¼ˆå¦‚Shenandoahã€ZGCï¼‰åœ¨è¯»å–å¯¹è±¡å¼•ç”¨æ—¶éœ€è¦å¤„ç†
    // ç”¨é€”ï¼š
    // - å¹¶å‘æ ‡è®°æ—¶çš„å¼•ç”¨æ›´æ–°
    // - å¹¶å‘å‹ç¼©æ—¶çš„å¯¹è±¡è½¬å‘
  }
  
  // 3. G1 GCçš„å†™å±éšœç‰¹ç‚¹
  static void g1_write_barrier() {
    // G1ä½¿ç”¨å†™å‰å±éšœï¼ˆPre-Write Barrierï¼‰å’Œå†™åå±éšœï¼ˆPost-Write Barrierï¼‰
    // - Pre-Write Barrierï¼šSATBï¼ˆSnapshot-At-The-Beginningï¼‰æ ‡è®°
    // - Post-Write Barrierï¼šç»´æŠ¤RSetï¼ˆè®°å¿†é›†ï¼‰
  }
};
```

### 1.2 gc_barrier_stubs_init()å®ç°

#### **æ ¸å¿ƒå®ç°ä»£ç **

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/gc/shared/barrierSet.cpp:47-53
void gc_barrier_stubs_init() {
  // 1. è·å–å½“å‰çš„BarrierSetå®ä¾‹
  BarrierSet* bs = BarrierSet::barrier_set();
  
#ifndef ZERO
  // 2. è·å–BarrierSetçš„æ±‡ç¼–ç”Ÿæˆå™¨
  BarrierSetAssembler* bs_assembler = bs->barrier_set_assembler();
  
  // 3. ç”Ÿæˆå±éšœæ¡©ä»£ç 
  bs_assembler->barrier_stubs_init();
#endif
}
```

#### **BarrierSetæ¶æ„**

```cpp
// BarrierSetï¼šGCå±éšœçš„æŠ½è±¡åŸºç±»
class BarrierSet : public CHeapObj<mtGC> {
private:
  // å…¨å±€å”¯ä¸€çš„å±éšœé›†å®ä¾‹
  static BarrierSet* _barrier_set;
  
  // å±éšœé›†çš„åç§°
  const BarrierSetName _kind;
  
public:
  // è·å–å±éšœé›†æ±‡ç¼–ç”Ÿæˆå™¨
  virtual BarrierSetAssembler* barrier_set_assembler() = 0;
  
  // è·å–C1ç¼–è¯‘å™¨çš„å±éšœé›†
  virtual BarrierSetC1* barrier_set_c1() { return NULL; }
  
  // è·å–C2ç¼–è¯‘å™¨çš„å±éšœé›†
  virtual BarrierSetC2* barrier_set_c2() { return NULL; }
  
  // çº¿ç¨‹åˆ›å»ºæ—¶çš„å›è°ƒ
  virtual void on_thread_create(Thread* thread) {}
  
  // çº¿ç¨‹é”€æ¯æ—¶çš„å›è°ƒ
  virtual void on_thread_destroy(Thread* thread) {}
};
```

### 1.3 G1BarrierSetAssembleræ¡©ä»£ç ç”Ÿæˆ

#### **G1å†™å±éšœæ¡©ä»£ç **

```cpp
// G1BarrierSetAssembler::barrier_stubs_init()çš„å…·ä½“å®ç°
void G1BarrierSetAssembler::barrier_stubs_init() {
  // 1. ç”Ÿæˆå†™åå±éšœçš„æ…¢é€Ÿè·¯å¾„æ¡©ä»£ç 
  generate_c1_post_barrier_runtime_stub();
  
  // 2. ç”Ÿæˆå†™å‰å±éšœçš„æ…¢é€Ÿè·¯å¾„æ¡©ä»£ç 
  generate_c1_pre_barrier_runtime_stub();
}

// å†™åå±éšœæ…¢é€Ÿè·¯å¾„ï¼ˆç»´æŠ¤RSetï¼‰
void G1BarrierSetAssembler::generate_c1_post_barrier_runtime_stub() {
  // æ¡©ä»£ç åŠŸèƒ½ï¼š
  // 1. ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡
  // 2. è°ƒç”¨G1BarrierSet::write_ref_field_post_entry()
  // 3. å°†ä¿®æ”¹çš„å¡ç‰‡æ ‡è®°ä¸ºè„å¡
  // 4. æ·»åŠ åˆ°è„å¡é˜Ÿåˆ—
  // 5. æ¢å¤å¯„å­˜å™¨ä¸Šä¸‹æ–‡å¹¶è¿”å›
}

// å†™å‰å±éšœæ…¢é€Ÿè·¯å¾„ï¼ˆSATBæ ‡è®°ï¼‰
void G1BarrierSetAssembler::generate_c1_pre_barrier_runtime_stub() {
  // æ¡©ä»£ç åŠŸèƒ½ï¼š
  // 1. ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡
  // 2. è¯»å–æ—§çš„å¯¹è±¡å¼•ç”¨
  // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦SATBæ ‡è®°
  // 4. å°†æ—§å¼•ç”¨åŠ å…¥SATBé˜Ÿåˆ—
  // 5. æ¢å¤å¯„å­˜å™¨ä¸Šä¸‹æ–‡å¹¶è¿”å›
}
```

#### **æ¡©ä»£ç çš„å†…å­˜å¸ƒå±€**

```
GCå±éšœæ¡©ä»£ç å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CodeBlobåŒºåŸŸ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚         Post-Write Barrier Stubï¼ˆå†™åå±éšœï¼‰             â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry Point: 0x7f8a12345000                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ Size: ~200 bytes                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 1. push %rbx, %rcx, %rdx (ä¿å­˜å¯„å­˜å™¨)          â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 2. mov %r9, %rdi        (å‚æ•°ï¼šå¯¹è±¡åœ°å€)       â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 3. call write_ref_field_post_entry             â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 4. pop %rdx, %rcx, %rbx (æ¢å¤å¯„å­˜å™¨)           â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 5. ret                                          â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚         Pre-Write Barrier Stubï¼ˆå†™å‰å±éšœï¼‰              â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ Entry Point: 0x7f8a12345100                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ Size: ~180 bytes                                   â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 1. push %rbx, %rcx, %rdx (ä¿å­˜å¯„å­˜å™¨)          â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 2. mov (%r9), %rdi      (è¯»å–æ—§å¼•ç”¨)           â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 3. test %rdi, %rdi      (æ£€æŸ¥æ˜¯å¦ä¸ºNULL)       â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 4. jz skip              (NULLåˆ™è·³è¿‡)           â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 5. call satb_enqueue                           â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 6. skip: pop %rdx, %rcx, %rbx                  â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â”‚ 7. ret                                          â”‚ â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 å†™å±éšœçš„å®Œæ•´æ‰§è¡Œæµç¨‹

#### **å†…è”å¿«é€Ÿè·¯å¾„ + æ¡©ä»£ç æ…¢é€Ÿè·¯å¾„**

```cpp
// å®Œæ•´çš„G1å†™å±éšœæ‰§è¡Œæµç¨‹
class G1WriteBarrierFlow {
public:
  // JITç”Ÿæˆçš„å†…è”å¿«é€Ÿè·¯å¾„
  static void inline_fast_path() {
    // ä¼ªæ±‡ç¼–ä»£ç ï¼š
    // store %rax, [%rbx + offset]   ; å®é™…çš„å­—æ®µå†™å…¥
    // 
    // ; å†™åå±éšœå¿«é€Ÿè·¯å¾„
    // shr $9, %rbx                   ; è®¡ç®—å¡ç‰‡ç´¢å¼•ï¼ˆé™¤ä»¥512ï¼‰
    // movb $0, (%r15 + %rbx)        ; æ ‡è®°å¡ç‰‡ä¸ºè„ï¼ˆ0 = dirtyï¼‰
    // 
    // ; æ£€æŸ¥æ˜¯å¦éœ€è¦æ…¢é€Ÿè·¯å¾„
    // cmpb $0, card_table[%rbx]
    // jne slow_path                  ; å¦‚æœå·²ç»æ˜¯è„å¡ï¼Œè·³è½¬åˆ°æ…¢é€Ÿè·¯å¾„
    // 
    // continue:
    // ; å¿«é€Ÿè·¯å¾„å®Œæˆ
  }
  
  // æ¡©ä»£ç æ…¢é€Ÿè·¯å¾„
  static void stub_slow_path() {
    // 1. è¿›å…¥æ¡©ä»£ç 
    // slow_path:
    //   push registers
    //   call post_write_barrier_stub
    //   pop registers
    //   jmp continue
    
    // 2. æ¡©ä»£ç å†…éƒ¨
    void post_write_barrier_stub(HeapWord* addr) {
      // è®¡ç®—å¡ç‰‡åœ°å€
      CardTableBarrierSet* ct = (CardTableBarrierSet*)BarrierSet::barrier_set();
      jbyte* card_addr = ct->byte_for(addr);
      
      // æ£€æŸ¥å¡ç‰‡çŠ¶æ€
      if (*card_addr != G1CardTable::dirty_card_val()) {
        *card_addr = G1CardTable::dirty_card_val();
        
        // æ·»åŠ åˆ°è„å¡é˜Ÿåˆ—
        G1ThreadLocalData* tld = G1ThreadLocalData::data(Thread::current());
        G1DirtyCardQueue& dcq = tld->dirty_card_queue();
        dcq.enqueue(card_addr);
      }
    }
  }
  
  // æ€§èƒ½ç‰¹å¾
  static void performance_characteristics() {
    // å¿«é€Ÿè·¯å¾„ï¼š~5-10ä¸ªCPUå‘¨æœŸ
    // - å†…è”åœ¨JITä»£ç ä¸­
    // - æ— å‡½æ•°è°ƒç”¨å¼€é”€
    // - å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ‰§è¡Œå¿«é€Ÿè·¯å¾„
    
    // æ…¢é€Ÿè·¯å¾„ï¼š~100-200ns
    // - éœ€è¦è°ƒç”¨æ¡©ä»£ç 
    // - æ¶‰åŠé˜Ÿåˆ—æ“ä½œ
    // - çº¦1-2%çš„å†™æ“ä½œä¼šè¿›å…¥æ…¢é€Ÿè·¯å¾„
  }
};
```

## ğŸ”§ ç¬¬äºŒéƒ¨åˆ†ï¼šè§£é‡Šå™¨åˆå§‹åŒ–

### 2.1 è§£é‡Šå™¨æ¶æ„æ¦‚è¿°

è§£é‡Šå™¨æ˜¯JVMæ‰§è¡ŒJavaå­—èŠ‚ç çš„åŸºç¡€å¼•æ“ï¼š

```cpp
// è§£é‡Šå™¨çš„æ ¸å¿ƒç»„ä»¶
class InterpreterArchitecture {
public:
  // 1. æ¨¡æ¿è§£é‡Šå™¨ï¼ˆTemplate Interpreterï¼‰
  static void template_interpreter() {
    // ä¸ºæ¯ä¸ªå­—èŠ‚ç æŒ‡ä»¤ç”Ÿæˆä¸“é—¨çš„æœºå™¨ç æ¨¡æ¿
    // ä¼˜ç‚¹ï¼šé«˜æ€§èƒ½ï¼ˆæ¯”çº¯è§£é‡Šå¿«3-5å€ï¼‰
    // ç¼ºç‚¹ï¼šä»£ç ä½“ç§¯å¤§ï¼ˆ~1MBï¼‰
  }
  
  // 2. C++è§£é‡Šå™¨ï¼ˆC++ Interpreterï¼ŒZEROå¹³å°ï¼‰
  static void cpp_interpreter() {
    // ä½¿ç”¨C++å‡½æ•°å®ç°å­—èŠ‚ç é€»è¾‘
    // ä¼˜ç‚¹ï¼šæ˜“ç§»æ¤ã€ä»£ç å°
    // ç¼ºç‚¹ï¼šæ€§èƒ½è¾ƒä½
  }
  
  // 3. è§£é‡Šå™¨çš„èŒè´£
  static void responsibilities() {
    // - è§£é‡Šæ‰§è¡Œå­—èŠ‚ç 
    // - ç®¡ç†è§£é‡Šæ ˆå¸§
    // - å®ç°æ–¹æ³•è°ƒç”¨å’Œè¿”å›
    // - æ”¶é›†æ€§èƒ½æ•°æ®ï¼ˆç”¨äºJITç¼–è¯‘å†³ç­–ï¼‰
    // - ä¸JITç¼–è¯‘å™¨åä½œ
  }
};
```

### 2.2 interpreter_init()å®ç°

#### **æ ¸å¿ƒåˆå§‹åŒ–æµç¨‹**

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/interpreter/interpreter.cpp:115-130
void interpreter_init() {
  // 1. åˆå§‹åŒ–è§£é‡Šå™¨æ ¸å¿ƒ
  Interpreter::initialize();
  
#ifndef PRODUCT
  // 2. è°ƒè¯•æ”¯æŒï¼šå­—èŠ‚ç è¿½è¸ª
  if (TraceBytecodes) {
    BytecodeTracer::set_closure(BytecodeTracer::std_closure());
  }
#endif
  
  // 3. æ³¨å†Œåˆ°Forte profiler
  Forte::register_stub(
    "Interpreter",
    AbstractInterpreter::code()->code_start(),
    AbstractInterpreter::code()->code_end()
  );
  
  // 4. é€šçŸ¥JVMTIï¼šç”Ÿæˆäº†åŠ¨æ€ä»£ç 
  if (JvmtiExport::should_post_dynamic_code_generated()) {
    JvmtiExport::post_dynamic_code_generated(
      "Interpreter",
      AbstractInterpreter::code()->code_start(),
      AbstractInterpreter::code()->code_end()
    );
  }
}
```

### 2.3 Interpreter::initialize()è¯¦ç»†åˆ†æ

#### **è§£é‡Šå™¨ä»£ç ç”Ÿæˆ**

```cpp
// æ¨¡æ¿è§£é‡Šå™¨çš„åˆå§‹åŒ–è¿‡ç¨‹
class TemplateInterpreterInitialization {
public:
  static void initialize() {
    // 1. åˆ†é…ä»£ç ç¼“å†²åŒº
    int code_size = platform_dependent_size();  // Linux x86_64: ~140KB
    
    // 2. åˆ›å»ºStubQueueæ¥å­˜å‚¨è§£é‡Šå™¨ä»£ç 
    AbstractInterpreter::_code = new StubQueue(
      new InterpreterCodeletInterface,
      code_size,
      "Interpreter"
    );
    
    // 3. ç”Ÿæˆå„ç§è§£é‡Šå™¨å…¥å£
    TemplateInterpreterGenerator g(AbstractInterpreter::_code);
    
    // 4. ç”Ÿæˆæ–¹æ³•å…¥å£ï¼ˆæŒ‰è¿”å›ç±»å‹åˆ†ç±»ï¼‰
    g.generate_all();
  }
  
  // ç”Ÿæˆçš„å…¥å£ç±»å‹
  static void entry_types() {
    // - zerolocalsï¼šæ— å±€éƒ¨å˜é‡çš„æ–¹æ³•
    // - zerolocals_synchronizedï¼šåŒæ­¥æ–¹æ³•ï¼Œæ— å±€éƒ¨å˜é‡
    // - emptyï¼šç©ºæ–¹æ³•ï¼ˆç›´æ¥è¿”å›ï¼‰
    // - accessorï¼šgetteræ–¹æ³•ï¼ˆåªè¯»å–å­—æ®µï¼‰
    // - abstractï¼šæŠ½è±¡æ–¹æ³•ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰
    // - nativeï¼šæœ¬åœ°æ–¹æ³•ï¼ˆè°ƒç”¨JNIï¼‰
    // - native_synchronizedï¼šåŒæ­¥æœ¬åœ°æ–¹æ³•
    // - java_lang_math_sin/cos/tan...ï¼šæ•°å­¦åº“å¿«é€Ÿè·¯å¾„
    // - normalï¼šæ™®é€šæ–¹æ³•
  }
};
```

#### **è§£é‡Šå™¨ä»£ç çš„å†…å­˜å¸ƒå±€**

```
è§£é‡Šå™¨ä»£ç ç¼“å†²åŒºå¸ƒå±€ï¼ˆ140KBï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Interpreter Code Buffer                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Method Entry Stubs                         â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ zerolocals_entry         (~500 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ zerolocals_synchronized  (~600 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ empty_entry              (~50 bytes)               â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ accessor_entry           (~200 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ abstract_entry           (~100 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ java_lang_math_sin       (~300 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ normal_entry             (~800 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ native_entry             (~1KB)                    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ ...                                                â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ æ€»å¤§å°: ~20KB                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚           Bytecode Dispatch Table                      â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ 0x00 (nop)       â†’ handler_0x00 (~20 bytes)        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ 0x01 (aconst_null) â†’ handler_0x01 (~30 bytes)     â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ 0x02 (iconst_m1) â†’ handler_0x02 (~25 bytes)       â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ ...                                                â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ 0xFE (invokedynamic) â†’ handler_0xFE (~2KB)        â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ æ€»å¤§å°: ~100KB (256ä¸ªå­—èŠ‚ç  Ã— å¹³å‡~400å­—èŠ‚)             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚              Helper Routines                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ stack_overflow_handler   (~500 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ throw_exception          (~800 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ monitorenter_helper      (~1KB)                    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ monitorexit_helper       (~1KB)                    â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ method_entry_point       (~600 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ return_from_native       (~400 bytes)              â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ ...                                                â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ æ€»å¤§å°: ~20KB                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å­—èŠ‚ç åˆ†å‘æœºåˆ¶

#### **æ¨¡æ¿è¡¨é©±åŠ¨çš„å­—èŠ‚ç æ‰§è¡Œ**

```cpp
// å­—èŠ‚ç åˆ†å‘çš„æ ¸å¿ƒæœºåˆ¶
class BytecodeDispatch {
public:
  // æ–¹æ³•1ï¼šè·³è½¬è¡¨åˆ†å‘ï¼ˆé»˜è®¤ï¼‰
  static void jump_table_dispatch() {
    // ä¼ªæ±‡ç¼–ä»£ç ï¼š
    // mov bytecode, %rax          ; è¯»å–å½“å‰å­—èŠ‚ç 
    // lea dispatch_table, %rbx    ; åŠ è½½åˆ†å‘è¡¨åœ°å€
    // jmp [%rbx + %rax * 8]       ; è·³è½¬åˆ°å¯¹åº”çš„å­—èŠ‚ç å¤„ç†å™¨
    
    // æ€§èƒ½ï¼š~1-2ä¸ªCPUå‘¨æœŸ
    // ä¼˜ç‚¹ï¼šæå¿«ã€åˆ†æ”¯é¢„æµ‹å‹å¥½
    // ç¼ºç‚¹ï¼šéœ€è¦å¤§é‡å†…å­˜ï¼ˆ256ä¸ªå…¥å£ç‚¹ï¼‰
  }
  
  // æ–¹æ³•2ï¼šå¼€å…³åˆ†å‘ï¼ˆC++è§£é‡Šå™¨ï¼‰
  static void switch_dispatch() {
    // C++ä»£ç ï¼š
    // switch (bytecode) {
    //   case 0x00: handle_nop(); break;
    //   case 0x01: handle_aconst_null(); break;
    //   ...
    // }
    
    // æ€§èƒ½ï¼š~10-20ä¸ªCPUå‘¨æœŸ
    // ä¼˜ç‚¹ï¼šä»£ç å°ã€æ˜“ç»´æŠ¤
    // ç¼ºç‚¹ï¼šæ…¢ã€åˆ†æ”¯é¢„æµ‹å›°éš¾
  }
  
  // å…¸å‹å­—èŠ‚ç å¤„ç†å™¨ç¤ºä¾‹
  static void bytecode_handler_example() {
    // ä»¥iaddï¼ˆæ•´æ•°åŠ æ³•ï¼‰ä¸ºä¾‹ï¼š
    // 
    // iadd_handler:
    //   pop %eax                ; å¼¹å‡ºæ ˆé¡¶å…ƒç´ 
    //   pop %ebx                ; å¼¹å‡ºæ¬¡æ ˆé¡¶å…ƒç´ 
    //   add %ebx, %eax          ; æ‰§è¡ŒåŠ æ³•
    //   push %eax               ; ç»“æœå‹æ ˆ
    //   movzbl 1(%r13), %ebx    ; è¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚ç 
    //   lea 1(%r13), %r13       ; æ›´æ–°å­—èŠ‚ç æŒ‡é’ˆ
    //   jmp *dispatch_table[%ebx*8]  ; åˆ†å‘åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚ç 
    //   
    // æ€»è®¡ï¼š~10æ¡æŒ‡ä»¤ï¼Œçº¦5-8ä¸ªCPUå‘¨æœŸ
  }
};
```

### 2.5 è§£é‡Šå™¨æ ˆå¸§å¸ƒå±€

#### **è§£é‡Šæ ˆå¸§çš„ç»“æ„**

```
è§£é‡Šå™¨æ ˆå¸§å¸ƒå±€ï¼ˆx86_64 Linuxï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Stack Frame                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é«˜åœ°å€                                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Caller's Stack                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Return Address (8 bytes)                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Saved RBP (8 bytes)                            â”‚ â”‚ â† RBP
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Interpreter State (32 bytes)                   â”‚ â”‚
â”‚ â”‚  - Method*                                              â”‚ â”‚
â”‚ â”‚  - Bytecode pointer (BCP, %r13)                         â”‚ â”‚
â”‚ â”‚  - Local variables pointer (locals, %r14)               â”‚ â”‚
â”‚ â”‚  - Constant pool cache pointer                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Local Variables (N * 8 bytes)                  â”‚ â”‚
â”‚ â”‚  locals[0] = this (æˆ–ç¬¬ä¸€ä¸ªå‚æ•°)                         â”‚ â”‚
â”‚ â”‚  locals[1] = å‚æ•°1                                      â”‚ â”‚
â”‚ â”‚  locals[2] = å‚æ•°2                                      â”‚ â”‚
â”‚ â”‚  ...                                                    â”‚ â”‚
â”‚ â”‚  locals[N-1] = å±€éƒ¨å˜é‡N                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â† R14 (locals)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚          Expression Stack (åŠ¨æ€å¢é•¿)                     â”‚ â”‚
â”‚ â”‚  [ç©ºé—²ç©ºé—´]                                             â”‚ â”‚
â”‚ â”‚  stack[2]                                               â”‚ â”‚
â”‚ â”‚  stack[1]                                               â”‚ â”‚
â”‚ â”‚  stack[0]  â† æ ˆé¡¶                                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â† RSP (æ ˆé¡¶)
â”‚ ä½åœ°å€                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®å¯„å­˜å™¨åˆ†é…ï¼š
- RSP: è¡¨è¾¾å¼æ ˆé¡¶æŒ‡é’ˆ
- RBP: æ ˆå¸§åŸºå€æŒ‡é’ˆ
- R13: å­—èŠ‚ç æŒ‡é’ˆï¼ˆBCP, Bytecode Pointerï¼‰
- R14: å±€éƒ¨å˜é‡æŒ‡é’ˆï¼ˆLocals Pointerï¼‰
- R15: çº¿ç¨‹æŒ‡é’ˆï¼ˆThread Pointerï¼‰
```

## ğŸ“Š æ€§èƒ½åˆ†æä¸ä¼˜åŒ–æ•ˆæœ

### 3.1 GCå±éšœæ€§èƒ½å¼€é”€

#### **å†™å±éšœæ€§èƒ½æµ‹è¯•ç»“æœï¼ˆ8GBå †ç¯å¢ƒï¼‰**

```
G1 GCå†™å±éšœæ€§èƒ½ç‰¹å¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                â”‚ å¿«é€Ÿè·¯å¾„    â”‚ æ…¢é€Ÿè·¯å¾„    â”‚ å¹³å‡å¼€é”€   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­—æ®µå†™å…¥ï¼ˆæ— å±éšœï¼‰  â”‚ åŸºå‡†        â”‚ -           â”‚ åŸºå‡†       â”‚
â”‚ å­—æ®µå†™å…¥ï¼ˆæœ‰å±éšœï¼‰  â”‚ +5-8å‘¨æœŸ    â”‚ +100-200ns  â”‚ +2-5%      â”‚
â”‚ æ•°ç»„å†™å…¥ï¼ˆæ‰¹é‡ï¼‰    â”‚ +3-5å‘¨æœŸ    â”‚ +50-100ns   â”‚ +1-3%      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å±éšœè§¦å‘é¢‘ç‡ï¼ˆå…¸å‹Webåº”ç”¨ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹            â”‚ é¢‘ç‡        â”‚ å¿«é€Ÿè·¯å¾„æ¯”ä¾‹â”‚ æ…¢é€Ÿè·¯å¾„æ¯”ä¾‹â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­—æ®µå†™å…¥            â”‚ 10M/s       â”‚ 98-99%      â”‚ 1-2%       â”‚
â”‚ æ•°ç»„å…ƒç´ å†™å…¥        â”‚ 50M/s       â”‚ 99-99.5%    â”‚ 0.5-1%     â”‚
â”‚ é™æ€å­—æ®µå†™å…¥        â”‚ 100K/s      â”‚ 95-98%      â”‚ 2-5%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»ä½“æ€§èƒ½å½±å“ï¼š
- CPUå¼€é”€ï¼š+2-4%ï¼ˆåº”ç”¨çº§åˆ«ï¼‰
- GCæ•ˆç‡æå‡ï¼š+30-50%ï¼ˆå¾—ç›Šäºå‡†ç¡®çš„RSetï¼‰
- å‡€æ”¶ç›Šï¼šæ­£é¢ï¼ˆGCæš‚åœæ—¶é—´æ˜¾è‘—å‡å°‘ï¼‰
```

### 3.2 è§£é‡Šå™¨æ€§èƒ½ç‰¹å¾

#### **è§£é‡Šå™¨æ‰§è¡Œæ€§èƒ½ï¼ˆvs JITç¼–è¯‘ä»£ç ï¼‰**

```
è§£é‡Šå™¨ vs JITç¼–è¯‘å™¨æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                â”‚ è§£é‡Šå™¨      â”‚ C1ç¼–è¯‘å™¨    â”‚ C2ç¼–è¯‘å™¨   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­—èŠ‚ç /æŒ‡ä»¤æ¯”       â”‚ 1:8-15      â”‚ 1:5-10      â”‚ 1:3-8      â”‚
â”‚ æ‰§è¡Œé€Ÿåº¦            â”‚ åŸºå‡†(1x)    â”‚ 5-10x       â”‚ 10-50x     â”‚
â”‚ å¯åŠ¨å¼€é”€            â”‚ 0ms         â”‚ 10-50ms     â”‚ 50-500ms   â”‚
â”‚ å†…å­˜å ç”¨            â”‚ ~1MB        â”‚ +10-50MB    â”‚ +50-200MB  â”‚
â”‚ ä»£ç è´¨é‡            â”‚ é€šç”¨        â”‚ è‰¯å¥½        â”‚ ä¼˜ç§€       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­—èŠ‚ç æ‰§è¡Œæ€§èƒ½ï¼ˆæ¨¡æ¿è§£é‡Šå™¨ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—èŠ‚ç ç±»å‹          â”‚ æ‰§è¡Œæ—¶é—´    â”‚ æŒ‡ä»¤æ•°      â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®€å•æ“ä½œ(iadd)      â”‚ 5-8ns       â”‚ 8-12æ¡     â”‚ æ ˆæ“ä½œ+åˆ†å‘â”‚
â”‚ å­—æ®µè®¿é—®(getfield)  â”‚ 20-50ns     â”‚ 20-30æ¡    â”‚ å«ç©ºæ£€æŸ¥   â”‚
â”‚ æ–¹æ³•è°ƒç”¨(invokevirtual)â”‚100-300ns â”‚ 50-100æ¡   â”‚ å«è™šè¡¨æŸ¥æ‰¾ â”‚
â”‚ å¯¹è±¡åˆ›å»º(new)       â”‚ 500-1000ns  â”‚ 100-200æ¡  â”‚ å«åˆ†é…+åˆå§‹åŒ–â”‚
â”‚ å¼‚å¸¸æŠ›å‡º(athrow)    â”‚ 2-10Î¼s      â”‚ 500+æ¡     â”‚ å«æ ˆå±•å¼€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 åˆå§‹åŒ–æ—¶é—´åˆ†æ

#### **åˆå§‹åŒ–è€—æ—¶åˆ†è§£**

```
GCå±éšœå’Œè§£é‡Šå™¨åˆå§‹åŒ–æ—¶é—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                â”‚ è€—æ—¶        â”‚ å æ¯”        â”‚ è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gc_barrier_stubs    â”‚ ~0.5ms      â”‚ 2%          â”‚ æ¡©ä»£ç ç”Ÿæˆ â”‚
â”‚ interpreter_init    â”‚ ~25ms       â”‚ 98%         â”‚ æ¨¡æ¿ç”Ÿæˆ   â”‚
â”‚ - ä»£ç ç¼“å†²åŒºåˆ†é…    â”‚ ~1ms        â”‚ 4%          â”‚ å†…å­˜åˆ†é…   â”‚
â”‚ - å…¥å£ç‚¹ç”Ÿæˆ        â”‚ ~3ms        â”‚ 12%         â”‚ æ±‡ç¼–ä»£ç    â”‚
â”‚ - å­—èŠ‚ç å¤„ç†å™¨ç”Ÿæˆ  â”‚ ~18ms       â”‚ 72%         â”‚ 256ä¸ªæ¨¡æ¿  â”‚
â”‚ - è¾…åŠ©å‡½æ•°ç”Ÿæˆ      â”‚ ~3ms        â”‚ 12%         â”‚ å¼‚å¸¸å¤„ç†ç­‰ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡                â”‚ ~25.5ms     â”‚ 100%        â”‚ å¿«é€Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–æŠ€å·§ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
- CDSå…±äº«è§£é‡Šå™¨ä»£ç ï¼šå‡å°‘70-80%åˆå§‹åŒ–æ—¶é—´
- AOTé¢„ç¼–è¯‘ï¼šç›´æ¥è·³è¿‡è§£é‡Šå™¨æ‰§è¡Œ
- Tiered Compilationï¼šå¿«é€Ÿä»è§£é‡Šå™¨åˆ‡æ¢åˆ°JIT
```

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸å·¥ç¨‹æ™ºæ…§

### 4.1 ç­–ç•¥æ¨¡å¼åœ¨GCå±éšœä¸­çš„åº”ç”¨

```cpp
// BarrierSetä½¿ç”¨ç­–ç•¥æ¨¡å¼æ”¯æŒä¸åŒGCç®—æ³•
class BarrierSetStrategyPattern {
public:
  // æŠ½è±¡ç­–ç•¥
  class BarrierSetAssembler {
  public:
    virtual void load_at(...) = 0;
    virtual void store_at(...) = 0;
  };
  
  // å…·ä½“ç­–ç•¥1ï¼šG1BarrierSetAssembler
  class G1BarrierSetAssembler : public BarrierSetAssembler {
  public:
    void store_at(...) override {
      // G1ç‰¹å®šçš„å†™å±éšœé€»è¾‘
      // - å†™å‰å±éšœï¼ˆSATBï¼‰
      // - å†™åå±éšœï¼ˆRSetç»´æŠ¤ï¼‰
    }
  };
  
  // å…·ä½“ç­–ç•¥2ï¼šCardTableBarrierSetAssembler
  class CardTableBarrierSetAssembler : public BarrierSetAssembler {
  public:
    void store_at(...) override {
      // å¡è¡¨å±éšœé€»è¾‘ï¼ˆCMS/Serial GCï¼‰
      // - ç®€å•çš„å¡ç‰‡æ ‡è®°
    }
  };
  
  // ä¸Šä¸‹æ–‡
  class BarrierSet {
  private:
    BarrierSetAssembler* _assembler;
  public:
    void generate_code() {
      _assembler->store_at(...);  // åŠ¨æ€åˆ†å‘
    }
  };
};
```

### 4.2 æ¨¡æ¿æ–¹æ³•æ¨¡å¼åœ¨è§£é‡Šå™¨ä¸­çš„åº”ç”¨

```cpp
// æ¨¡æ¿è§£é‡Šå™¨ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç”Ÿæˆå­—èŠ‚ç å¤„ç†å™¨
class TemplateMethodPattern {
public:
  // æŠ½è±¡æ¨¡æ¿æ–¹æ³•
  class TemplateTable {
  public:
    static void define(Bytecodes::Code code, 
                      int flags, 
                      TosState in, 
                      TosState out, 
                      void (*gen)(int arg), 
                      int arg) {
      // æ¨¡æ¿æ–¹æ³•æ¡†æ¶
      // 1. è®¾ç½®å­—èŠ‚ç å…ƒæ•°æ®
      // 2. è°ƒç”¨å…·ä½“ç”Ÿæˆå‡½æ•°
      // 3. å®‰è£…åˆ°åˆ†å‘è¡¨
    }
  };
  
  // å…·ä½“å®ç°
  static void generate_iadd_handler() {
    // 1. å…¬å…±å‰ç½®æ“ä½œ
    transition(itos, itos);  // æ ˆçŠ¶æ€è½¬æ¢
    
    // 2. å­—èŠ‚ç ç‰¹å®šé€»è¾‘
    __ pop_i(rbx);           // å¼¹å‡ºæ“ä½œæ•°1
    __ addl(rax, rbx);       // æ‰§è¡ŒåŠ æ³•
    
    // 3. å…¬å…±åç½®æ“ä½œ
    __ dispatch_next();      // åˆ†å‘åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚ç 
  }
};
```

### 4.3 äº«å…ƒæ¨¡å¼åœ¨ä»£ç ç¼“å­˜ä¸­çš„åº”ç”¨

```cpp
// è§£é‡Šå™¨ä»£ç å’ŒGCå±éšœæ¡©ä»£ç å…±äº«CodeBlob
class CodeBlobFlyweight {
public:
  // äº«å…ƒå·¥å‚
  class CodeCache {
  public:
    static RuntimeStub* create_stub(const char* name, address entry) {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
      RuntimeStub* existing = find_blob(entry);
      if (existing != NULL) {
        return existing;  // è¿”å›å…±äº«å®ä¾‹
      }
      
      // åˆ›å»ºæ–°stub
      RuntimeStub* stub = new RuntimeStub(name, ...);
      register_blob(stub);
      return stub;
    }
  };
  
  // ä¼˜åŠ¿ï¼š
  // - å‡å°‘å†…å­˜å ç”¨
  // - æé«˜ä»£ç å±€éƒ¨æ€§
  // - ç®€åŒ–ç®¡ç†
};
```

## ğŸš€ å®é™…åº”ç”¨ä¸è°ƒä¼˜å»ºè®®

### 5.1 GCå±éšœè°ƒä¼˜

#### **å‡å°‘å±éšœå¼€é”€çš„ç­–ç•¥**

```cpp
// GCå±éšœä¼˜åŒ–æŠ€å·§
class GCBarrierOptimization {
public:
  // 1. æ‰¹é‡æ›´æ–°ä¼˜åŒ–
  static void batch_update_optimization() {
    // é”™è¯¯åšæ³•ï¼šé€ä¸ªæ›´æ–°ï¼ˆæ¯æ¬¡è§¦å‘å±éšœï¼‰
    for (int i = 0; i < 1000; i++) {
      array[i] = new_values[i];  // 1000æ¬¡å±éšœ
    }
    
    // æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ‰¹é‡æ“ä½œï¼ˆå‡å°‘å±éšœæ¬¡æ•°ï¼‰
    System.arraycopy(new_values, 0, array, 0, 1000);  // ä¼˜åŒ–çš„å±éšœ
  }
  
  // 2. é¿å…ä¸å¿…è¦çš„å†™å…¥
  static void avoid_unnecessary_writes() {
    // é”™è¯¯åšæ³•ï¼šæ€»æ˜¯å†™å…¥
    object.field = value;
    
    // æ­£ç¡®åšæ³•ï¼šå…ˆæ£€æŸ¥
    if (object.field != value) {
      object.field = value;  // å‡å°‘å±éšœè§¦å‘
    }
  }
  
  // 3. åˆ©ç”¨å±€éƒ¨æ€§
  static void locality_optimization() {
    // ç›¸é‚»å­—æ®µçš„å†™å…¥ï¼Œå±éšœå¼€é”€å¯ä»¥åˆ†æ‘Š
    object.field1 = value1;
    object.field2 = value2;  // å¯èƒ½ä½¿ç”¨ç›¸åŒçš„å¡ç‰‡
  }
};
```

### 5.2 è§£é‡Šå™¨æ€§èƒ½ä¼˜åŒ–

#### **å‡å°‘è§£é‡Šå™¨æ‰§è¡Œæ—¶é—´**

```cpp
// è§£é‡Šå™¨æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
class InterpreterOptimization {
public:
  // 1. å¿«é€Ÿå¯ç”¨JITç¼–è¯‘
  static void enable_tiered_compilation() {
    // JVMå‚æ•°ï¼š
    // -XX:+TieredCompilation
    // -XX:TieredStopAtLevel=1  // åªä½¿ç”¨C1ï¼ˆå¿«é€Ÿç¼–è¯‘ï¼‰
    // -XX:CompileThreshold=1500 // é™ä½ç¼–è¯‘é˜ˆå€¼
  }
  
  // 2. ä½¿ç”¨è§£é‡Šå™¨å¿«é€Ÿè·¯å¾„
  static void use_fast_paths() {
    // æŸäº›æ–¹æ³•æœ‰ä¼˜åŒ–çš„è§£é‡Šå™¨å…¥å£ï¼š
    // - ç®€å•getter/setterï¼šaccessor entry
    // - ç©ºæ–¹æ³•ï¼šempty entry
    // - æ•°å­¦å‡½æ•°ï¼šintrinsic entry
  }
  
  // 3. é¢„ç¼–è¯‘çƒ­ç‚¹ä»£ç 
  static void precompile_hot_methods() {
    // JVMå‚æ•°ï¼š
    // -XX:CompileOnly=com.example.HotClass::*
    // -Xcomp  // ç¼–è¯‘æ‰€æœ‰ä»£ç ï¼ˆä¸æ¨èï¼Œä»…æµ‹è¯•ç”¨ï¼‰
  }
  
  // 4. CDSå…±äº«è§£é‡Šå™¨
  static void use_cds() {
    // å‡å°‘è§£é‡Šå™¨åˆå§‹åŒ–å¼€é”€
    // å‚è§ä¹‹å‰çš„CDSåˆ†æ
  }
};
```

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **GCå±éšœæ¡©ä»£ç **ï¼š
   - æ”¯æŒå¹¶å‘/å¢é‡åƒåœ¾æ”¶é›†
   - ç»´æŠ¤è®°å¿†é›†çš„å‡†ç¡®æ€§
   - å†…è”å¿«é€Ÿè·¯å¾„ + æ¡©ä»£ç æ…¢é€Ÿè·¯å¾„çš„ä¼˜åŒ–è®¾è®¡

2. **è§£é‡Šå™¨**ï¼š
   - é›¶å¯åŠ¨æˆæœ¬çš„å­—èŠ‚ç æ‰§è¡Œ
   - ä¸ºJITç¼–è¯‘å™¨æ”¶é›†æ€§èƒ½æ•°æ®
   - æ¨¡æ¿é©±åŠ¨çš„é«˜æ€§èƒ½å®ç°

### è®¾è®¡äº®ç‚¹

1. **åˆ†å±‚ä¼˜åŒ–**ï¼šå¿«é€Ÿè·¯å¾„ + æ…¢é€Ÿè·¯å¾„çš„è®¾è®¡
2. **æ¨¡æ¿åŒ–ä»£ç ç”Ÿæˆ**ï¼šè§£é‡Šå™¨çš„256ä¸ªå­—èŠ‚ç æ¨¡æ¿
3. **ç­–ç•¥æ¨¡å¼**ï¼šæ”¯æŒä¸åŒGCç®—æ³•çš„å±éšœå®ç°
4. **æ€§èƒ½æƒè¡¡**ï¼šå¯åŠ¨é€Ÿåº¦ vs æ‰§è¡Œé€Ÿåº¦çš„å¹³è¡¡

### æ€§èƒ½ç‰¹å¾

- **GCå±éšœå¼€é”€**ï¼š2-4% CPUï¼ˆåº”ç”¨çº§åˆ«ï¼‰
- **è§£é‡Šå™¨é€Ÿåº¦**ï¼šæ¯”JITæ…¢10-50å€ï¼Œä½†é›¶å¯åŠ¨æˆæœ¬
- **åˆå§‹åŒ–æ—¶é—´**ï¼š~25msï¼ˆè§£é‡Šå™¨å ä¸»å¯¼ï¼‰
- **å†…å­˜å ç”¨**ï¼š~1MBï¼ˆè§£é‡Šå™¨ä»£ç ï¼‰+ å‡ KBï¼ˆå±éšœæ¡©ä»£ç ï¼‰

è¿™ä¸¤ä¸ªç»„ä»¶çš„åˆå§‹åŒ–ä¸ºJVMçš„å­—èŠ‚ç æ‰§è¡Œå’Œåƒåœ¾æ”¶é›†å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œå±•ç°äº†ç°ä»£è™šæ‹Ÿæœºåœ¨æ€§èƒ½ä¼˜åŒ–å’Œå·¥ç¨‹è®¾è®¡ä¸Šçš„ç²¾å¦™å¹³è¡¡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 GCå±éšœä¸è§£é‡Šå™¨åˆå§‹åŒ–  
**ä»£ç è·¯å¾„**: `src/hotspot/share/runtime/init.cpp:124-129`
