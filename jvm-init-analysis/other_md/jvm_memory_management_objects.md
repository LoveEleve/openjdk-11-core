# JVMå†…å­˜ç®¡ç†å¯¹è±¡è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVMå†…å­˜ç®¡ç†ç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬Universeã€G1CollectedHeapã€Metaspaceã€CodeCacheã€HeapRegionå’ŒTLABç­‰ã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (é»˜è®¤)

---

## ğŸŒ **1. Universe - å…¨å±€å‘½åç©ºé—´**

### **1.1 æ¦‚è¿°**

`Universe`æ˜¯ä¸€ä¸ª`AllStatic`ç±»ï¼Œä½œä¸ºJVMçš„å…¨å±€å…¥å£ç‚¹ï¼ŒæŒæœ‰æ‰€æœ‰ç³»ç»Ÿçº§å¼•ç”¨å’ŒçŸ¥åå¯¹è±¡ã€‚

### **1.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Universe: AllStatic {
  // ==================== å †ç®¡ç† ====================
  static CollectedHeap* _collectedHeap;      // å †å®ä¾‹ (G1CollectedHeap)
  
  // ==================== åŸºæœ¬ç±»å‹æ•°ç»„Klass ====================
  static Klass* _typeArrayKlassObjs[T_VOID+1];  // ç±»å‹æ•°ç»„Klassè¡¨
  // åŒ…æ‹¬: _boolArrayKlassObj, _byteArrayKlassObj, _charArrayKlassObj,
  //       _intArrayKlassObj, _shortArrayKlassObj, _longArrayKlassObj,
  //       _floatArrayKlassObj, _doubleArrayKlassObj
  
  static Klass* _objectArrayKlassObj;        // Object[]çš„Klass
  
  // ==================== åŸºæœ¬ç±»å‹é•œåƒ ====================
  static oop _int_mirror;                    // int.class
  static oop _float_mirror;                  // float.class
  static oop _double_mirror;                 // double.class
  static oop _byte_mirror;                   // byte.class
  static oop _bool_mirror;                   // boolean.class
  static oop _char_mirror;                   // char.class
  static oop _long_mirror;                   // long.class
  static oop _short_mirror;                  // short.class
  static oop _void_mirror;                   // void.class
  
  // ==================== çº¿ç¨‹ç»„ ====================
  static oop _main_thread_group;             // ä¸»çº¿ç¨‹ç»„
  static oop _system_thread_group;           // ç³»ç»Ÿçº¿ç¨‹ç»„
  
  // ==================== é¢„åˆ†é…å¼‚å¸¸å¯¹è±¡ ====================
  static oop _out_of_memory_error_java_heap;        // Javaå †OOM
  static oop _out_of_memory_error_metaspace;        // Metaspace OOM
  static oop _out_of_memory_error_class_metaspace;  // ç±»Metaspace OOM
  static oop _out_of_memory_error_array_size;       // æ•°ç»„å¤§å°OOM
  static oop _out_of_memory_error_gc_overhead_limit;// GCå¼€é”€è¶…é™OOM
  static oop _out_of_memory_error_realloc_objects;  // é‡åˆ†é…å¯¹è±¡OOM
  
  // ==================== å‹ç¼©æŒ‡é’ˆé…ç½® ====================
  static NarrowPtrStruct _narrow_oop;        // å‹ç¼©æ™®é€šå¯¹è±¡æŒ‡é’ˆ
  static NarrowPtrStruct _narrow_klass;      // å‹ç¼©ç±»æŒ‡é’ˆ
  
  // ==================== å¼•ç”¨å¤„ç† ====================
  static oop _reference_pending_list;        // å¾…å¤„ç†çš„å¼•ç”¨åˆ—è¡¨
  
  // ==================== çŠ¶æ€æ ‡å¿— ====================
  static bool _bootstrapping;                // æ˜¯å¦åœ¨å¼•å¯¼é˜¶æ®µ
  static bool _fully_initialized;            // æ˜¯å¦å®Œå…¨åˆå§‹åŒ–
  
  // ==================== GCç»Ÿè®¡ ====================
  static size_t _heap_capacity_at_last_gc;   // ä¸Šæ¬¡GCæ—¶çš„å †å®¹é‡
  static size_t _heap_used_at_last_gc;       // ä¸Šæ¬¡GCæ—¶çš„å †ä½¿ç”¨é‡
};
```

### **1.3 NarrowPtrStructè¯¦è§£**

```cpp
// å‹ç¼©æŒ‡é’ˆç»“æ„ (ç”¨äºå‹ç¼©oopå’Œå‹ç¼©klass)
struct NarrowPtrStruct {
  address _base;           // åŸºåœ°å€
  int     _shift;          // ç§»ä½é‡ (é€šå¸¸ä¸º3ï¼Œå³8å­—èŠ‚å¯¹é½)
  bool    _use_implicit_null_checks;  // æ˜¯å¦ä½¿ç”¨éšå¼ç©ºæ£€æŸ¥
};

// 8GBå †é…ç½®ä¸‹çš„å‹ç¼©æŒ‡é’ˆ:
// _narrow_oop._base  = 0 (é›¶åŸºå‹ç¼©)
// _narrow_oop._shift = 3 (8å­—èŠ‚å¯¹é½)
// å¯å¯»å€èŒƒå›´: 32GB (2^32 * 8)
```

### **1.4 Universeåˆå§‹åŒ–æµç¨‹**

```
Universeåˆå§‹åŒ–æ—¶é—´çº¿:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ              â”‚ æ“ä½œ                    â”‚ åˆ›å»ºçš„å¯¹è±¡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ genesis()         â”‚ åˆ›å»ºå †                  â”‚ G1CollectedHeapâ”‚
â”‚                   â”‚ åˆå§‹åŒ–å‹ç¼©æŒ‡é’ˆ          â”‚ NarrowPtrStructâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ initialize_heap() â”‚ å †åŒºåŸŸåˆå§‹åŒ–            â”‚ HeapRegion[]   â”‚
â”‚                   â”‚ å¡è¡¨åˆå§‹åŒ–              â”‚ G1CardTable    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ init_1()          â”‚ åˆ›å»ºåŸºæœ¬ç±»å‹æ•°ç»„Klass   â”‚ TypeArrayKlass â”‚
â”‚                   â”‚ åˆ›å»ºObject[]Klass       â”‚ ObjArrayKlass  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ init_2()          â”‚ åˆ›å»ºåŸºæœ¬ç±»å‹é•œåƒ        â”‚ java.lang.Classâ”‚
â”‚                   â”‚ åˆ›å»ºçº¿ç¨‹ç»„              â”‚ ThreadGroup    â”‚
â”‚                   â”‚ é¢„åˆ†é…OOMå¼‚å¸¸           â”‚ OOMEå¯¹è±¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **1.5 å†…å­˜å ç”¨**

| ç»„ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| é™æ€æˆå‘˜ | ~2KB | æŒ‡é’ˆå’Œæ ‡å¿— |
| é¢„åˆ†é…OOM | ~5KB | 6ä¸ªé¢„åˆ†é…å¼‚å¸¸å¯¹è±¡ |
| ç±»å‹æ•°ç»„Klass | ~10KB | 9ä¸ªåŸºæœ¬ç±»å‹æ•°ç»„Klass |

---

## ğŸ—„ï¸ **2. G1CollectedHeap - G1åƒåœ¾æ”¶é›†å †**

### **2.1 æ¦‚è¿°**

`G1CollectedHeap`æ˜¯G1åƒåœ¾æ”¶é›†å™¨çš„å †å®ç°ï¼Œä½¿ç”¨åŸºäºRegionçš„å†…å­˜ç®¡ç†ã€‚

### **2.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class G1CollectedHeap : public CollectedHeap {
  // ==================== å †åŒºåŸŸç®¡ç† ====================
  HeapRegionManager _hrm;                    // å †åŒºåŸŸç®¡ç†å™¨
  // 8GBå † = 4096ä¸ªRegionï¼Œæ¯ä¸ª2MB
  
  // ==================== åˆ†é…å™¨ ====================
  G1Allocator* _allocator;                   // å¯¹è±¡åˆ†é…å™¨
  
  // ==================== ä»£ç®¡ç† ====================
  HeapRegionSet _old_set;                    // è€å¹´ä»£åŒºåŸŸé›†åˆ
  HeapRegionSet _humongous_set;              // å·¨å‹å¯¹è±¡åŒºåŸŸé›†åˆ
  G1EdenRegions _eden;                       // EdenåŒºåŸŸåˆ—è¡¨
  G1SurvivorRegions _survivor;               // SurvivoråŒºåŸŸåˆ—è¡¨
  
  // ==================== å¹¶å‘æ ‡è®° ====================
  G1ConcurrentMark* _cm;                     // å¹¶å‘æ ‡è®°å™¨
  G1ConcurrentMarkThread* _cm_thread;        // å¹¶å‘æ ‡è®°çº¿ç¨‹
  
  // ==================== å¹¶å‘ç»†åŒ– ====================
  G1ConcurrentRefine* _cr;                   // å¹¶å‘ç»†åŒ–å™¨
  
  // ==================== è®°å¿†é›† ====================
  G1RemSet* _g1_rem_set;                     // G1è®°å¿†é›†
  G1HotCardCache* _hot_card_cache;           // çƒ­å¡ç¼“å­˜
  
  // ==================== ç­–ç•¥ ====================
  G1Policy* _g1_policy;                      // G1æ”¶é›†ç­–ç•¥
  
  // ==================== æ”¶é›†é›† ====================
  G1CollectionSet _collection_set;           // æ”¶é›†é›†åˆ
  G1InCSetStateFastTestBiasedMappedArray _in_cset_fast_test;  // CSetå¿«é€Ÿæµ‹è¯•
  
  // ==================== å—åç§»è¡¨å’Œå¡è¡¨ ====================
  G1BlockOffsetTable* _bot;                  // å—åç§»è¡¨
  G1CardTable* _card_table;                  // å¡è¡¨
  
  // ==================== å¼•ç”¨å¤„ç† ====================
  ReferenceProcessor* _ref_processor_stw;    // STWå¼•ç”¨å¤„ç†å™¨
  ReferenceProcessor* _ref_processor_cm;     // å¹¶å‘æ ‡è®°å¼•ç”¨å¤„ç†å™¨
  
  // ==================== å¹¶è¡Œä»»åŠ¡ ====================
  RefToScanQueueSet* _task_queues;           // ä»»åŠ¡é˜Ÿåˆ—é›†
  
  // ==================== çŠ¶æ€ ====================
  bool _evacuation_failed;                   // ç–æ•£æ˜¯å¦å¤±è´¥
  G1CollectorState _collector_state;         // æ”¶é›†å™¨çŠ¶æ€
  volatile uint _old_marking_cycles_started; // è€å¹´ä»£æ ‡è®°å‘¨æœŸå¼€å§‹è®¡æ•°
  volatile uint _old_marking_cycles_completed;// è€å¹´ä»£æ ‡è®°å‘¨æœŸå®Œæˆè®¡æ•°
  
  // ==================== å·¨å‹å¯¹è±¡å›æ”¶ ====================
  HumongousReclaimCandidates _humongous_reclaim_candidates;
};
```

### **2.3 HeapRegionManagerè¯¦è§£**

```cpp
class HeapRegionManager : public CHeapObj<mtGC> {
  // Regionæ•°ç»„
  HeapRegion** _regions;           // RegionæŒ‡é’ˆæ•°ç»„
  uint _num_committed;             // å·²æäº¤çš„Regionæ•°é‡
  uint _length;                    // Regionæ€»æ•° (4096 for 8GB)
  
  // ç©ºé—²åˆ—è¡¨
  FreeRegionList _free_list;       // ç©ºé—²Regioné“¾è¡¨
  
  // ä½å›¾
  G1RegionToSpaceMapper* _heap_mapper;        // å †æ˜ å°„å™¨
  G1RegionToSpaceMapper* _prev_bitmap_mapper; // å‰æ ‡è®°ä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _next_bitmap_mapper; // åæ ‡è®°ä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _bot_mapper;         // BOTæ˜ å°„å™¨
  G1RegionToSpaceMapper* _cardtable_mapper;   // å¡è¡¨æ˜ å°„å™¨
  G1RegionToSpaceMapper* _card_counts_mapper; // å¡è®¡æ•°æ˜ å°„å™¨
};
```

### **2.4 8GBå †çš„G1é…ç½®**

```
G1å †é…ç½® (8GB):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ å€¼          â”‚ è®¡ç®—æ–¹å¼            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HeapRegionSize          â”‚ 2MB         â”‚ è‡ªåŠ¨è®¡ç®—            â”‚
â”‚ Regionæ•°é‡              â”‚ 4096        â”‚ 8GB / 2MB           â”‚
â”‚ æœ€å¤§æ–°ç”Ÿä»£æ¯”ä¾‹          â”‚ 60%         â”‚ G1MaxNewSizePercent â”‚
â”‚ åˆå§‹æ–°ç”Ÿä»£æ¯”ä¾‹          â”‚ 5%          â”‚ G1NewSizePercent    â”‚
â”‚ åˆå§‹Eden Regionæ•°       â”‚ ~200        â”‚ 5% * 4096           â”‚
â”‚ æœ€å¤§Eden Regionæ•°       â”‚ ~2400       â”‚ 60% * 4096          â”‚
â”‚ ç›®æ ‡æš‚åœæ—¶é—´            â”‚ 200ms       â”‚ MaxGCPauseMillis    â”‚
â”‚ å¹¶å‘æ ‡è®°çº¿ç¨‹æ•°          â”‚ 2           â”‚ ConcGCThreads       â”‚
â”‚ å¹¶è¡ŒGCçº¿ç¨‹æ•°            â”‚ 8           â”‚ ParallelGCThreads   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.5 å†…å­˜å ç”¨**

| ç»„ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| G1CollectedHeapç»“æ„ | ~8KB | ä¸»ç»“æ„ä½“ |
| HeapRegionæ•°ç»„ | ~1MB | 4096ä¸ªRegionæè¿°ç¬¦ |
| æ ‡è®°ä½å›¾ | ~256KB | æ¯ä¸ªRegion 128å­—èŠ‚ |
| å¡è¡¨ | ~16MB | æ¯512å­—èŠ‚ä¸€ä¸ªå¡ |
| BOT | ~4MB | å—åç§»è¡¨ |
| è®°å¿†é›† | ~100MB+ | æŒ‰éœ€å¢é•¿ |

---

## ğŸ“¦ **3. Metaspace - å…ƒç©ºé—´**

### **3.1 æ¦‚è¿°**

`Metaspace`å­˜å‚¨ç±»çš„å…ƒæ•°æ®ï¼Œæ›¿ä»£äº†JDK 7åŠä¹‹å‰çš„æ°¸ä¹…ä»£ã€‚

### **3.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class Metaspace : AllStatic {
  // ==================== è™šæ‹Ÿç©ºé—´ç®¡ç† ====================
  static VirtualSpaceList* _space_list;          // éç±»å…ƒæ•°æ®ç©ºé—´åˆ—è¡¨
  static VirtualSpaceList* _class_space_list;    // ç±»å…ƒæ•°æ®ç©ºé—´åˆ—è¡¨
  
  // ==================== å—ç®¡ç† ====================
  static ChunkManager* _chunk_manager_metadata;  // å…ƒæ•°æ®å—ç®¡ç†å™¨
  static ChunkManager* _chunk_manager_class;     // ç±»å—ç®¡ç†å™¨
  
  // ==================== é…ç½® ====================
  static size_t _compressed_class_space_size;    // å‹ç¼©ç±»ç©ºé—´å¤§å° (1GB)
  static size_t _first_chunk_word_size;          // ç¬¬ä¸€ä¸ªå—çš„å­—å¤§å°
  static size_t _first_class_chunk_word_size;    // ç¬¬ä¸€ä¸ªç±»å—çš„å­—å¤§å°
  
  // ==================== å¯¹é½ ====================
  static size_t _commit_alignment;               // æäº¤å¯¹é½
  static size_t _reserve_alignment;              // ä¿ç•™å¯¹é½
  
  // ==================== è·Ÿè¸ª ====================
  static const MetaspaceTracer* _tracer;         // å…ƒç©ºé—´è·Ÿè¸ªå™¨
  static bool _initialized;                      // æ˜¯å¦å·²åˆå§‹åŒ–
};
```

### **3.3 ClassLoaderMetaspaceè¯¦è§£**

æ¯ä¸ªç±»åŠ è½½å™¨æ‹¥æœ‰ä¸€ä¸ª`ClassLoaderMetaspace`å®ä¾‹ï¼š

```cpp
class ClassLoaderMetaspace : public CHeapObj<mtClass> {
  SpaceManager* _vsm;           // éç±»å…ƒæ•°æ®ç©ºé—´ç®¡ç†å™¨
  SpaceManager* _class_vsm;     // ç±»å…ƒæ•°æ®ç©ºé—´ç®¡ç†å™¨
  MetaspaceType _space_type;    // å…ƒç©ºé—´ç±»å‹
  Mutex* _lock;                 // å…ƒç©ºé—´é”
};

// å…ƒç©ºé—´ç±»å‹
enum MetaspaceType {
  StandardMetaspaceType,              // æ ‡å‡†ç±»åŠ è½½å™¨
  BootMetaspaceType,                  // Bootstrapç±»åŠ è½½å™¨
  UnsafeAnonymousMetaspaceType,       // åŒ¿åç±»
  ReflectionMetaspaceType             // åå°„ç±»
};
```

### **3.4 å—å¤§å°å±‚æ¬¡**

```cpp
// Metachunkå¤§å°ç­‰çº§
enum ChunkIndex {
  ZeroIndex = 0,
  SpecializedIndex = ZeroIndex,  // 128å­— (1KB)
  SmallIndex = SpecializedIndex + 1,  // 512å­— (4KB)
  MediumIndex = SmallIndex + 1,       // 8Kå­— (64KB)
  HumongousIndex = MediumIndex + 1,   // å¤§äº64KB
  NumberOfFreeLists = 3,
  NumberOfInUseLists = 4
};
```

### **3.5 å†…å­˜å¸ƒå±€**

```
Metaspaceå†…å­˜å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‹ç¼©ç±»ç©ºé—´ (1GB)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ VirtualSpaceNode â†’ VirtualSpaceNode â†’ ...           â”‚    â”‚
â”‚  â”‚       â”‚                   â”‚                         â”‚    â”‚
â”‚  â”‚       â–¼                   â–¼                         â”‚    â”‚
â”‚  â”‚   Metachunk[]         Metachunk[]                   â”‚    â”‚
â”‚  â”‚   (InstanceKlass)     (InstanceKlass)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    éç±»å…ƒç©ºé—´ (æ— é™åˆ¶)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ VirtualSpaceNode â†’ VirtualSpaceNode â†’ ...           â”‚    â”‚
â”‚  â”‚       â”‚                   â”‚                         â”‚    â”‚
â”‚  â”‚       â–¼                   â–¼                         â”‚    â”‚
â”‚  â”‚   Metachunk[]         Metachunk[]                   â”‚    â”‚
â”‚  â”‚   (Method, CP)        (Method, CP)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3.6 åˆå§‹å†…å­˜å ç”¨**

| ç»„ä»¶ | åˆå§‹å¤§å° | æœ€å¤§å¤§å° |
|------|---------|---------|
| å‹ç¼©ç±»ç©ºé—´ | ~5MB | 1GB |
| éç±»å…ƒç©ºé—´ | ~15MB | æ— é™åˆ¶ |
| ç®¡ç†ç»“æ„ | ~1MB | ~5MB |

---

## ğŸ’» **4. CodeCache - ä»£ç ç¼“å­˜**

### **4.1 æ¦‚è¿°**

`CodeCache`å­˜å‚¨JITç¼–è¯‘åçš„æœ¬åœ°ä»£ç ã€è¿è¡Œæ—¶å­˜æ ¹å’Œé€‚é…å™¨ã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CodeCache : AllStatic {
  // ==================== ä»£ç å † ====================
  static GrowableArray<CodeHeap*>* _heaps;           // æ‰€æœ‰ä»£ç å †
  static GrowableArray<CodeHeap*>* _compiled_heaps;  // ç¼–è¯‘ä»£ç å †
  static GrowableArray<CodeHeap*>* _nmethod_heaps;   // nmethodå †
  static GrowableArray<CodeHeap*>* _allocable_heaps; // å¯åˆ†é…çš„å †
  
  // ==================== åœ°å€è¾¹ç•Œ ====================
  static address _low_bound;                         // åœ°å€ä¸‹ç•Œ
  static address _high_bound;                        // åœ°å€ä¸Šç•Œ
  
  // ==================== ç»Ÿè®¡ ====================
  static int _number_of_nmethods_with_dependencies;  // æœ‰ä¾èµ–çš„nmethodæ•°
  static bool _needs_cache_clean;                    // æ˜¯å¦éœ€è¦æ¸…ç†
  
  // ==================== Scavengeæ”¯æŒ ====================
  static nmethod* _scavenge_root_nmethods;           // éœ€è¦scavengeçš„nmethod
  
  // ==================== å¸è½½æ”¯æŒ ====================
  static volatile int _unloading_threshold;          // å¸è½½é˜ˆå€¼
};
```

### **4.3 ä»£ç å †ç±»å‹**

```cpp
// ä»£ç å †åˆ†æ®µ (åˆ†å±‚ç¼–è¯‘å¯ç”¨æ—¶)
enum CodeBlobType {
  CodeBlobType_NonNMethod,    // énmethodä»£ç  (stub, adapter)
  CodeBlobType_MethodNonProfiled,  // éprofiled nmethod (C1 tier1, C2)
  CodeBlobType_MethodProfiled,     // profiled nmethod (C1 tier2/3)
  CodeBlobType_All,                // ä¸åˆ†æ®µæ—¶çš„ç»Ÿä¸€å †
  CodeBlobType_NumTypes
};
```

### **4.4 8GBå †çš„CodeCacheé…ç½®**

```
CodeCacheé…ç½®:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å †ç±»å‹              â”‚ åˆå§‹å¤§å°  â”‚ æœ€å¤§å¤§å°  â”‚ å­˜å‚¨å†…å®¹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ NonNMethod          â”‚ 5MB       â”‚ 5MB       â”‚ Stub, Adapter â”‚
â”‚ MethodProfiled      â”‚ 21MB      â”‚ 120MB     â”‚ C1 tier2/3    â”‚
â”‚ MethodNonProfiled   â”‚ 21MB      â”‚ 120MB     â”‚ C1 tier1, C2  â”‚
â”‚ æ€»è®¡                â”‚ 47MB      â”‚ 245MB     â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å…³é”®å‚æ•°:
// -XX:ReservedCodeCacheSize=245MB (é»˜è®¤)
// -XX:InitialCodeCacheSize=2496KB
// -XX:CodeCacheExpansionSize=64KB
```

### **4.5 CodeBlobå±‚æ¬¡ç»“æ„**

```
CodeBlob (ä»£ç å—åŸºç±»)
    â”‚
    â”œâ”€â”€ BufferBlob (ç¼“å†²åŒºå—)
    â”‚       â”œâ”€â”€ AdapterBlob (é€‚é…å™¨)
    â”‚       â””â”€â”€ MethodHandlesAdapterBlob
    â”‚
    â”œâ”€â”€ RuntimeBlob (è¿è¡Œæ—¶å—)
    â”‚       â”œâ”€â”€ SingletonBlob
    â”‚       â”‚       â”œâ”€â”€ DeoptimizationBlob (åä¼˜åŒ–)
    â”‚       â”‚       â”œâ”€â”€ UncommonTrapBlob (ä¸å¸¸è§é™·é˜±)
    â”‚       â”‚       â””â”€â”€ ExceptionBlob (å¼‚å¸¸å¤„ç†)
    â”‚       â””â”€â”€ RuntimeStub (è¿è¡Œæ—¶å­˜æ ¹)
    â”‚
    â””â”€â”€ CompiledMethod (ç¼–è¯‘æ–¹æ³•)
            â””â”€â”€ nmethod (æœ¬åœ°æ–¹æ³•)
```

---

## ğŸ§± **5. HeapRegion - G1å †åŒºåŸŸ**

### **5.1 æ¦‚è¿°**

`HeapRegion`æ˜¯G1æ”¶é›†å™¨ä¸­å¯ç‹¬ç«‹å›æ”¶çš„æœ€å°å †å•å…ƒã€‚

### **5.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class HeapRegion : public G1ContiguousSpace {
  // ==================== æ ‡è¯† ====================
  uint _hrm_index;                    // åœ¨å †åŒºåŸŸåºåˆ—ä¸­çš„ç´¢å¼•
  HeapRegionType _type;               // åŒºåŸŸç±»å‹
  
  // ==================== å·¨å‹å¯¹è±¡ ====================
  HeapRegion* _humongous_start_region;// å·¨å‹å¯¹è±¡çš„èµ·å§‹åŒºåŸŸ
  
  // ==================== ç–æ•£çŠ¶æ€ ====================
  bool _evacuation_failed;            // ç–æ•£æ˜¯å¦å¤±è´¥
  
  // ==================== é“¾è¡¨é“¾æ¥ ====================
  HeapRegion* _next;                  // ä¸‹ä¸€ä¸ªåŒºåŸŸ
  HeapRegion* _prev;                  // å‰ä¸€ä¸ªåŒºåŸŸ
  
  // ==================== è®°å¿†é›† ====================
  HeapRegionRemSet* _rem_set;         // è¯¥åŒºåŸŸçš„è®°å¿†é›†
  
  // ==================== å­˜æ´»å­—èŠ‚ç»Ÿè®¡ ====================
  size_t _prev_marked_bytes;          // ä¸Šæ¬¡æ ‡è®°å·²çŸ¥çš„å­˜æ´»å­—èŠ‚
  size_t _next_marked_bytes;          // å½“å‰æ ‡è®°ä¸­çš„å­˜æ´»å­—èŠ‚
  
  // ==================== GCæ•ˆç‡ ====================
  double _gc_efficiency;              // è®¡ç®—çš„GCæ•ˆç‡
  
  // ==================== å¹´è½»ä»£ä¿¡æ¯ ====================
  int _young_index_in_cset;           // åœ¨æ”¶é›†é›†ä¸­çš„å¹´è½»ä»£ç´¢å¼•
  SurvRateGroup* _surv_rate_group;    // å­˜æ´»ç‡ç»„
  int _age_index;                     // å¹´é¾„ç´¢å¼•
  
  // ==================== æ ‡è®°æ”¯æŒ ====================
  HeapWord* _prev_top_at_mark_start;  // ä¸Šæ¬¡æ ‡è®°å¼€å§‹æ—¶çš„top
  HeapWord* _next_top_at_mark_start;  // å½“å‰æ ‡è®°å¼€å§‹æ—¶çš„top
  
  // ==================== é¢„æµ‹ ====================
  size_t _recorded_rs_length;         // è®°å½•çš„RSeté•¿åº¦
  double _predicted_elapsed_time_ms;  // é¢„æµ‹çš„è€—æ—¶
};
```

### **5.3 HeapRegionTypeè¯¦è§£**

```cpp
class HeapRegionType {
  // ç±»å‹æ ‡ç­¾
  typedef enum {
    FreeTag       = 0,    // ç©ºé—²åŒºåŸŸ
    YoungMask     = 2,    // å¹´è½»ä»£æ©ç 
    EdenTag       = YoungMask,      // EdenåŒºåŸŸ
    SusrTag       = YoungMask + 1,  // SurvivoråŒºåŸŸ
    HumongousMask = 4,    // å·¨å‹å¯¹è±¡æ©ç 
    StartsHumongousTag = HumongousMask,     // å·¨å‹å¯¹è±¡èµ·å§‹
    ContinuesHumongousTag = HumongousMask + 1, // å·¨å‹å¯¹è±¡ç»§ç»­
    OldMask       = 8,    // è€å¹´ä»£æ©ç 
    OldTag        = OldMask,        // æ™®é€šè€å¹´ä»£
    ArchiveTag    = OldMask + 1,    // å½’æ¡£åŒºåŸŸ
    OpenArchiveTag = OldMask + 2,   // å¼€æ”¾å½’æ¡£åŒºåŸŸ
  } Tag;
  
  Tag _tag;
};
```

### **5.4 Regionå†…å­˜å¸ƒå±€**

```
å•ä¸ªHeapRegionå¸ƒå±€ (2MB):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½åœ°å€                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å·²åˆ†é…å¯¹è±¡åŒºåŸŸ                                              â”‚
â”‚  (ä»bottomåˆ°top)                                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Object1 â”‚ â”‚ Object2 â”‚ â”‚ Object3 â”‚ ...                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â† top (æœ€ååˆ†é…åçš„åœ°å€)                                    â”‚
â”‚                                                             â”‚
â”‚  ç©ºé—²åŒºåŸŸ                                                    â”‚
â”‚  (ä»topåˆ°end)                                               â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é«˜åœ°å€ (end)                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å…³é”®æŒ‡é’ˆ:
// bottom: åŒºåŸŸèµ·å§‹åœ°å€
// top: æœ€ååˆ†é…åçš„åœ°å€
// end: åŒºåŸŸç»“æŸåœ°å€
// å·²ç”¨ç©ºé—´ = top - bottom
// ç©ºé—²ç©ºé—´ = end - top
```

### **5.5 é™æ€é…ç½®**

```cpp
// HeapRegioné™æ€é…ç½® (8GBå †)
static int    LogOfHRGrainBytes = 21;   // log2(2MB) = 21
static int    LogOfHRGrainWords = 18;   // log2(256K words) = 18
static size_t GrainBytes = 2 * 1024 * 1024;  // 2MB
static size_t GrainWords = 256 * 1024;       // 256K words
static size_t CardsPerRegion = 4096;         // 2MB / 512B
```

---

## ğŸ§µ **6. ThreadLocalAllocBuffer (TLAB) - çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²**

### **6.1 æ¦‚è¿°**

`TLAB`æ˜¯çº¿ç¨‹ç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼Œç”¨äºå¿«é€Ÿæ— é”å¯¹è±¡åˆ†é…ã€‚

### **6.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class ThreadLocalAllocBuffer : public CHeapObj<mtThread> {
  // ==================== åœ°å€è¾¹ç•Œ ====================
  HeapWord* _start;                  // TLABèµ·å§‹åœ°å€
  HeapWord* _top;                    // æœ€ååˆ†é…åçš„åœ°å€
  HeapWord* _pf_top;                 // åˆ†é…é¢„å–æ°´ä½çº¿
  HeapWord* _end;                    // åˆ†é…ç»“æŸç‚¹
  HeapWord* _allocation_end;         // å®é™…TLABç»“æŸ
  
  // ==================== å¤§å°é…ç½® ====================
  size_t _desired_size;              // æœŸæœ›å¤§å°
  size_t _refill_waste_limit;        // é‡å¡«æµªè´¹é™åˆ¶
  
  // ==================== ç»Ÿè®¡ ====================
  size_t _allocated_before_last_gc;  // ä¸Šæ¬¡GCå‰çš„æ€»åˆ†é…
  size_t _bytes_since_last_sample_point;  // ä¸Šæ¬¡é‡‡æ ·åçš„å­—èŠ‚æ•°
  
  // ==================== é‡å¡«ç»Ÿè®¡ ====================
  unsigned _number_of_refills;       // é‡å¡«æ¬¡æ•°
  unsigned _fast_refill_waste;       // å¿«é€Ÿé‡å¡«æµªè´¹
  unsigned _slow_refill_waste;       // æ…¢é€Ÿé‡å¡«æµªè´¹
  unsigned _gc_waste;                // GCæµªè´¹
  unsigned _slow_allocations;        // æ…¢é€Ÿåˆ†é…æ¬¡æ•°
  
  // ==================== åˆ†é…æ¯”ä¾‹ ====================
  AdaptiveWeightedAverage _allocation_fraction;  // Edenä¸­TLABåˆ†é…æ¯”ä¾‹
};
```

### **6.3 TLABåˆ†é…æµç¨‹**

```
TLABå¿«é€Ÿåˆ†é…è·¯å¾„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ top + size <= end                                   â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ æ˜¯: å¿«é€Ÿåˆ†é…                                          â”‚
â”‚    â”‚       obj = top                                        â”‚
â”‚    â”‚       top = top + size                                 â”‚
â”‚    â”‚       return obj                                       â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ å¦: æ…¢é€Ÿè·¯å¾„                                          â”‚
â”‚            â”‚                                                â”‚
â”‚            â”œâ”€â”€ æ£€æŸ¥å‰©ä½™ç©ºé—´æ˜¯å¦å€¼å¾—ä¿ç•™                       â”‚
â”‚            â”‚   (free() > refill_waste_limit)                â”‚
â”‚            â”‚                                                â”‚
â”‚            â”œâ”€â”€ æ˜¯: ç›´æ¥åœ¨Edenåˆ†é…                            â”‚
â”‚            â”‚                                                â”‚
â”‚            â””â”€â”€ å¦: é‡æ–°å¡«å……TLAB                              â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â”œâ”€â”€ è®°å½•æµªè´¹ç»Ÿè®¡                          â”‚
â”‚                    â”œâ”€â”€ ä»Edenç”³è¯·æ–°TLAB                      â”‚
â”‚                    â””â”€â”€ åœ¨æ–°TLABä¸­åˆ†é…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **6.4 TLABå¤§å°è®¡ç®—**

```cpp
// TLABå¤§å°è®¡ç®— (8GBå †)
// é»˜è®¤å‚æ•°:
// -XX:TLABSize=0 (è‡ªåŠ¨è®¡ç®—)
// -XX:MinTLABSize=2KB
// -XX:TLABRefillWasteFraction=64
// -XX:TLABWasteTargetPercent=1

// è®¡ç®—å…¬å¼:
// desired_size = Eden_size / (çº¿ç¨‹æ•° * TLABRefillWasteFraction)
// 
// ç¤ºä¾‹ (8GBå †, 8çº¿ç¨‹):
// Edenåˆå§‹ = 400MB
// desired_size = 400MB / (8 * 64) = ~780KB
// 
// å®é™…TLABå¤§å°ä¼šæ ¹æ®çº¿ç¨‹åˆ†é…é€Ÿç‡åŠ¨æ€è°ƒæ•´
```

### **6.5 é™æ€é…ç½®**

```cpp
// TLABé™æ€é…ç½®
static size_t   _max_size;           // æœ€å¤§TLABå¤§å° (Edençš„ä¸€åŠ)
static int      _reserve_for_allocation_prefetch;  // é¢„å–ä¿ç•™
static unsigned _target_refills;     // ç›®æ ‡é‡å¡«æ¬¡æ•° (é»˜è®¤50)
```

---

## ğŸ“Š **7. å†…å­˜ç®¡ç†å¯¹è±¡å…³ç³»æ€»å›¾**

```
å†…å­˜ç®¡ç†å¯¹è±¡å…³ç³»:

Universe (å…¨å±€å…¥å£)
    â”‚
    â”œâ”€â”€ _collectedHeap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                        â”‚
    â”‚                                                        â–¼
    â”‚                                              G1CollectedHeap
    â”‚                                                        â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   â”‚                                                    â”‚                â”‚
    â”‚   â–¼                                                    â–¼                â–¼
    â”‚ _hrm                                               _cm              _g1_rem_set
    â”‚ (HeapRegionManager)                          (G1ConcurrentMark)    (G1RemSet)
    â”‚   â”‚                                                    â”‚                â”‚
    â”‚   â–¼                                                    â”‚                â–¼
    â”‚ HeapRegion[4096]                                       â”‚            _ct (G1CardTable)
    â”‚   â”‚                                                    â”‚
    â”‚   â”œâ”€â”€ _rem_set (HeapRegionRemSet)                      â”‚
    â”‚   â””â”€â”€ _type (Eden/Survivor/Old/Humongous)              â”‚
    â”‚                                                        â”‚
    â”‚                                                        â–¼
    â”‚                                              _mark_bitmap_1/_2
    â”‚
    â”œâ”€â”€ (Metaspace - é™æ€ç±») â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                        â”‚
    â”‚                                                        â–¼
    â”‚                                              VirtualSpaceList
    â”‚                                                        â”‚
    â”‚                                                        â–¼
    â”‚                                              ChunkManager
    â”‚
    â””â”€â”€ (CodeCache - é™æ€ç±») â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                             â”‚
                                                             â–¼
                                                    CodeHeap[3]
                                                    (NonNMethod, Profiled, NonProfiled)

JavaThread
    â”‚
    â””â”€â”€ _tlab (ThreadLocalAllocBuffer)
              â”‚
              â””â”€â”€ ä» HeapRegion (Eden) åˆ†é…
```

---

## ğŸ¯ **8. æ€»ç»“**

### **8.1 å…³é”®å¯¹è±¡æ•°é‡**

| å¯¹è±¡ | æ•°é‡ | å†…å­˜å ç”¨ |
|------|------|---------|
| Universe | 1 | ~2KB |
| G1CollectedHeap | 1 | ~8KB |
| HeapRegion | 4096 | ~1MB |
| Metaspaceç®¡ç†ç»“æ„ | 1 | ~1KB |
| ClassLoaderMetaspace | 3+ | ~3KB |
| CodeHeap | 3 | ~300B |
| TLAB | æ¯çº¿ç¨‹1ä¸ª | ~200B |

### **8.2 å†…å­˜åˆ†é…æ€»è§ˆ**

| åŒºåŸŸ | å¤§å° | ç”¨é€” |
|------|------|------|
| Javaå † | 8GB | å¯¹è±¡å­˜å‚¨ |
| Metaspace | ~20MBåˆå§‹ | ç±»å…ƒæ•°æ® |
| CodeCache | ~240MB | ç¼–è¯‘ä»£ç  |
| å¡è¡¨ | ~16MB | è·¨ä»£å¼•ç”¨è·Ÿè¸ª |
| æ ‡è®°ä½å›¾ | ~256KB | GCæ ‡è®° |

### **8.3 è®¾è®¡äº®ç‚¹**

1. **RegionåŒ–è®¾è®¡**: G1é€šè¿‡Regionå®ç°å¢é‡å¼å›æ”¶
2. **åˆ†å±‚CodeCache**: ä¸åŒç¼–è¯‘çº§åˆ«çš„ä»£ç åˆ†å¼€å­˜å‚¨
3. **TLABä¼˜åŒ–**: çº¿ç¨‹æœ¬åœ°åˆ†é…é¿å…é”ç«äº‰
4. **å‹ç¼©æŒ‡é’ˆ**: å‡å°‘64ä½ç³»ç»Ÿçš„å†…å­˜å¼€é”€
5. **é¢„åˆ†é…OOM**: ç¡®ä¿å†…å­˜ä¸è¶³æ—¶èƒ½æŠ¥å‘Šé”™è¯¯