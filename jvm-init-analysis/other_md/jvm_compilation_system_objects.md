# JVMç¼–è¯‘ç³»ç»Ÿä¸ä»£ç ç¼“å­˜å¯¹è±¡è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVMç¼–è¯‘ç³»ç»Ÿç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬CompileBrokerã€CompileQueueã€AbstractCompilerã€C1/C2ç¼–è¯‘å™¨ã€CompileTaskã€nmethodå’ŒCodeHeapç­‰ã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (é»˜è®¤)
- **ç¼–è¯‘å™¨**: åˆ†å±‚ç¼–è¯‘ (C1 + C2)

---

## ğŸ—ï¸ **1. ç¼–è¯‘ç³»ç»Ÿæ¶æ„æ€»è§ˆ**

### **1.1 ç¼–è¯‘ç³»ç»Ÿç»„ä»¶å…³ç³»**

```
ç¼–è¯‘ç³»ç»Ÿæ¶æ„å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           JVMç¼–è¯‘ç³»ç»Ÿ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    CompileBroker (ç¼–è¯‘ä»£ç†)                          â”‚   â”‚
â”‚  â”‚                    - ç¼–è¯‘ç³»ç»Ÿçš„æ ¸å¿ƒåè°ƒè€…                             â”‚   â”‚
â”‚  â”‚                    - ç®¡ç†ç¼–è¯‘é˜Ÿåˆ—å’Œç¼–è¯‘çº¿ç¨‹                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚              â–¼               â–¼               â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  CompileQueue    â”‚ â”‚  CompileQueue    â”‚ â”‚ AbstractCompiler â”‚            â”‚
â”‚  â”‚    (C1é˜Ÿåˆ—)      â”‚ â”‚    (C2é˜Ÿåˆ—)      â”‚ â”‚    (ç¼–è¯‘å™¨åŸºç±»)  â”‚            â”‚
â”‚  â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚            â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
â”‚  â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”‚  Compiler    â”‚ â”‚            â”‚
â”‚  â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”‚   (C1)       â”‚ â”‚            â”‚
â”‚  â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”‚ CompileTask  â”‚ â”‚ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚            â”‚
â”‚  â”‚ â”‚    ...       â”‚ â”‚ â”‚ â”‚    ...       â”‚ â”‚ â”‚ â”‚  C2Compiler  â”‚ â”‚            â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚              â”‚ â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼ ç¼–è¯‘äº§ç”Ÿ                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                       CompiledMethod                                 â”‚   â”‚
â”‚  â”‚                          â”‚                                           â”‚   â”‚
â”‚  â”‚                          â–¼                                           â”‚   â”‚
â”‚  â”‚                       nmethod (å·²ç¼–è¯‘çš„Javaæ–¹æ³•)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚ å­˜å‚¨äº                                       â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    CodeCache (ä»£ç ç¼“å­˜)                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚  â”‚  CodeHeap    â”‚ â”‚  CodeHeap    â”‚ â”‚  CodeHeap    â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚ (non-method) â”‚ â”‚ (profiled)   â”‚ â”‚(non-profiled)â”‚                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ **2. CompileBroker - ç¼–è¯‘ä»£ç†**

### **2.1 æ¦‚è¿°**

`CompileBroker`æ˜¯ç¼–è¯‘ç³»ç»Ÿçš„æ ¸å¿ƒåè°ƒè€…ï¼Œæ˜¯ä¸€ä¸ª`AllStatic`ç±»ï¼ˆæ‰€æœ‰æˆå‘˜éƒ½æ˜¯é™æ€çš„ï¼‰ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰ç¼–è¯‘è¯·æ±‚ã€ç¼–è¯‘é˜Ÿåˆ—å’Œç¼–è¯‘çº¿ç¨‹ã€‚

### **2.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CompileBroker: AllStatic {
  // ==================== åˆå§‹åŒ–çŠ¶æ€ ====================
  static bool _initialized;                    // ç¼–è¯‘ç³»ç»Ÿæ˜¯å¦å·²åˆå§‹åŒ–
  static volatile bool _should_block;          // æ§åˆ¶ç¼–è¯‘çº¿ç¨‹æ˜¯å¦åº”è¯¥é˜»å¡
  static volatile jint _should_compile_new_jobs; // æ§åˆ¶æ˜¯å¦æ¥å—æ–°çš„ç¼–è¯‘ä»»åŠ¡
  
  // ==================== ç¼–è¯‘å™¨å®ä¾‹ ====================
  static AbstractCompiler* _compilers[2];      // å·²å®‰è£…çš„ç¼–è¯‘å™¨æ•°ç»„
                                               // _compilers[0] = C1ç¼–è¯‘å™¨
                                               // _compilers[1] = C2ç¼–è¯‘å™¨
  
  // ==================== ç¼–è¯‘çº¿ç¨‹æ•°é‡ ====================
  static int _c1_count;                        // C1ç¼–è¯‘çº¿ç¨‹çš„æœ€å¤§æ•°é‡
  static int _c2_count;                        // C2ç¼–è¯‘çº¿ç¨‹çš„æœ€å¤§æ•°é‡
  
  // ==================== ç¼–è¯‘é˜Ÿåˆ— ====================
  static CompileQueue* _c1_compile_queue;      // C1ç¼–è¯‘ä»»åŠ¡é˜Ÿåˆ—
  static CompileQueue* _c2_compile_queue;      // C2ç¼–è¯‘ä»»åŠ¡é˜Ÿåˆ—
  
  // ==================== ç¼–è¯‘IDè®¡æ•°å™¨ ====================
  static volatile jint _compilation_id;        // æ™®é€šç¼–è¯‘IDè®¡æ•°å™¨
  static volatile jint _osr_compilation_id;    // OSRç¼–è¯‘IDè®¡æ•°å™¨
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  static int _total_compile_count;             // æ€»ç¼–è¯‘æ¬¡æ•°
  static int _total_bailout_count;             // ç¼–è¯‘å¤±è´¥(bailout)æ¬¡æ•°
  static int _total_invalidated_count;         // æ— æ•ˆåŒ–æ¬¡æ•°
  static int _total_native_compile_count;      // æœ¬åœ°æ–¹æ³•ç¼–è¯‘æ¬¡æ•°
  static int _total_osr_compile_count;         // OSRç¼–è¯‘æ¬¡æ•°
  static int _total_standard_compile_count;    // æ ‡å‡†ç¼–è¯‘æ¬¡æ•°
  
  // ==================== ä»£ç å¤§å°ç»Ÿè®¡ ====================
  static int _sum_osr_bytes_compiled;          // OSRç¼–è¯‘çš„å­—èŠ‚ç æ€»é‡
  static int _sum_standard_bytes_compiled;     // æ ‡å‡†ç¼–è¯‘çš„å­—èŠ‚ç æ€»é‡
  static int _sum_nmethod_size;                // æ‰€æœ‰nmethodçš„æ€»å¤§å°
  static int _sum_nmethod_code_size;           // æ‰€æœ‰nmethodä»£ç çš„æ€»å¤§å°
  
  // ==================== æ—¶é—´ç»Ÿè®¡ ====================
  static long _peak_compilation_time;          // å³°å€¼ç¼–è¯‘æ—¶é—´
  static elapsedTimer _t_total_compilation;    // æ€»ç¼–è¯‘æ—¶é—´è®¡æ—¶å™¨
  static elapsedTimer _t_osr_compilation;      // OSRç¼–è¯‘æ—¶é—´è®¡æ—¶å™¨
  static elapsedTimer _t_standard_compilation; // æ ‡å‡†ç¼–è¯‘æ—¶é—´è®¡æ—¶å™¨
};
```

### **2.3 ç¼–è¯‘ç±»å‹æšä¸¾**

```cpp
enum CompileType {
  no_compile,      // ä¸ç¼–è¯‘
  normal_compile,  // æ™®é€šç¼–è¯‘
  osr_compile,     // æ ˆä¸Šæ›¿æ¢(OSR)ç¼–è¯‘
  native_compile   // æœ¬åœ°æ–¹æ³•ç¼–è¯‘
};
```

### **2.4 8GBå †ç¯å¢ƒä¸‹çš„ç¼–è¯‘çº¿ç¨‹é…ç½®**

```
ç¼–è¯‘çº¿ç¨‹é…ç½® (8GBå †, åˆ†å±‚ç¼–è¯‘å¯ç”¨):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ é»˜è®¤å€¼        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CICompilerCount         â”‚ 4-12          â”‚ æ€»ç¼–è¯‘çº¿ç¨‹æ•°(CPUç›¸å…³) â”‚
â”‚ C1çº¿ç¨‹æ•°                â”‚ çº¦1/3         â”‚ å¿«é€Ÿç¼–è¯‘              â”‚
â”‚ C2çº¿ç¨‹æ•°                â”‚ çº¦2/3         â”‚ ä¼˜åŒ–ç¼–è¯‘              â”‚
â”‚                         â”‚               â”‚                       â”‚
â”‚ ç¤ºä¾‹(8æ ¸CPU):           â”‚               â”‚                       â”‚
â”‚   C1çº¿ç¨‹                â”‚ 3             â”‚                       â”‚
â”‚   C2çº¿ç¨‹                â”‚ 5             â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.5 åˆå§‹åŒ–æµç¨‹**

```
CompileBrokeråˆå§‹åŒ–æ—¶é—´çº¿:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é˜¶æ®µ                    â”‚ æ“ä½œ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. åˆå§‹åŒ–ç¼–è¯‘å™¨         â”‚ åˆ›å»ºC1å’ŒC2ç¼–è¯‘å™¨å®ä¾‹                  â”‚
â”‚ 2. åˆ›å»ºç¼–è¯‘é˜Ÿåˆ—         â”‚ åˆ›å»º_c1_compile_queueå’Œ_c2_compile_queueâ”‚
â”‚ 3. å¯åŠ¨ç¼–è¯‘çº¿ç¨‹         â”‚ åˆ›å»ºC1å’ŒC2ç¼–è¯‘çº¿ç¨‹                    â”‚
â”‚ 4. è®¾ç½®åˆå§‹åŒ–æ ‡å¿—       â”‚ _initialized = true                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ **3. CompileQueue - ç¼–è¯‘é˜Ÿåˆ—**

### **3.1 æ¦‚è¿°**

`CompileQueue`æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å¾…ç¼–è¯‘çš„ä»»åŠ¡ã€‚æ¯ä¸ªç¼–è¯‘çº§åˆ«ï¼ˆC1å’ŒC2ï¼‰éƒ½æœ‰ç‹¬ç«‹çš„ç¼–è¯‘é˜Ÿåˆ—ã€‚

### **3.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CompileQueue : public CHeapObj<mtCompiler> {
  // ==================== é˜Ÿåˆ—æ ‡è¯† ====================
  const char* const _name;                     // é˜Ÿåˆ—åç§° ("C1 compile queue"/"C2 compile queue")
  
  // ==================== é“¾è¡¨ç®¡ç† ====================
  CompileTask* _first;                         // é˜Ÿåˆ—å¤´æŒ‡é’ˆ
  CompileTask* _last;                          // é˜Ÿåˆ—å°¾æŒ‡é’ˆ
  CompileTask* _first_stale;                   // è¿‡æœŸä»»åŠ¡é“¾è¡¨å¤´
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  int _size;                                   // é˜Ÿåˆ—ä¸­ä»»åŠ¡æ•°é‡
  
  // ==================== åŒæ­¥ ====================
  Monitor* _lock;                              // é˜Ÿåˆ—é”
};
```

### **3.3 é˜Ÿåˆ—æ“ä½œ**

```
CompileQueueæ“ä½œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œ                    â”‚ è¯´æ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ add(task)               â”‚ å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—å°¾éƒ¨                  â”‚
â”‚ get()                   â”‚ ä»é˜Ÿåˆ—å¤´éƒ¨è·å–ä»»åŠ¡                    â”‚
â”‚ make_stale(task)        â”‚ å°†ä»»åŠ¡æ ‡è®°ä¸ºè¿‡æœŸ                      â”‚
â”‚ remove(task)            â”‚ ä»é˜Ÿåˆ—ä¸­ç§»é™¤ä»»åŠ¡                      â”‚
â”‚ is_empty()              â”‚ æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º                      â”‚
â”‚ size()                  â”‚ è·å–é˜Ÿåˆ—å¤§å°                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ **4. AbstractCompiler - æŠ½è±¡ç¼–è¯‘å™¨åŸºç±»**

### **4.1 æ¦‚è¿°**

`AbstractCompiler`æ˜¯æ‰€æœ‰ç¼–è¯‘å™¨çš„æŠ½è±¡åŸºç±»ï¼Œå®šä¹‰äº†ç¼–è¯‘å™¨çš„é€šç”¨æ¥å£ã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class AbstractCompiler : public CHeapObj<mtCompiler> {
  // ==================== çº¿ç¨‹ç®¡ç† ====================
  volatile int _num_compiler_threads;          // ç¼–è¯‘å™¨çº¿ç¨‹æ•°é‡
  
  // ==================== çŠ¶æ€ç®¡ç† ====================
  volatile int _compiler_state;                // ç¼–è¯‘å™¨çŠ¶æ€
  
  // ==================== ç±»å‹æ ‡è¯† ====================
  const CompilerType _type;                    // ç¼–è¯‘å™¨ç±»å‹
  
  // ==================== ç»Ÿè®¡ (JVMCI) ====================
  CompilerStatistics _stats;                   // ç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯
};
```

### **4.3 ç¼–è¯‘å™¨çŠ¶æ€æšä¸¾**

```cpp
enum CompilerState {
  uninitialized,  // æœªåˆå§‹åŒ–
  initializing,   // æ­£åœ¨åˆå§‹åŒ–
  initialized,    // å·²åˆå§‹åŒ–
  failed,         // åˆå§‹åŒ–å¤±è´¥
  shut_down       // å·²å…³é—­
};
```

### **4.4 ç¼–è¯‘å™¨ç±»å‹æšä¸¾**

```cpp
enum CompilerType {
  compiler_none,
  compiler_c1,       // C1ç¼–è¯‘å™¨
  compiler_c2,       // C2ç¼–è¯‘å™¨
  compiler_jvmci,    // JVMCIç¼–è¯‘å™¨
  compiler_number_of_types
};
```

---

## âš¡ **5. C1 Compiler - å®¢æˆ·ç«¯ç¼–è¯‘å™¨**

### **5.1 æ¦‚è¿°**

C1ç¼–è¯‘å™¨ï¼ˆä¹Ÿç§°ä¸ºå®¢æˆ·ç«¯ç¼–è¯‘å™¨ï¼‰æ˜¯ä¸€ä¸ªå¿«é€Ÿä½†ä¼˜åŒ–ç¨‹åº¦è¾ƒä½çš„ç¼–è¯‘å™¨ï¼Œç»§æ‰¿è‡ª`AbstractCompiler`ã€‚

### **5.2 ç±»å®šä¹‰**

```cpp
class Compiler: public AbstractCompiler {
  // C1ç¼–è¯‘å™¨ç‰¹æœ‰æˆå‘˜è¾ƒå°‘ï¼Œä¸»è¦ä¾èµ–åŸºç±»
  
  // å…³é”®ç‰¹æ€§:
  // - ç¼–è¯‘å™¨åç§°: "C1"
  // - æ”¯æŒnativeæ–¹æ³•ç¼–è¯‘
  // - æ”¯æŒOSR(æ ˆä¸Šæ›¿æ¢)ç¼–è¯‘
  // - æ¯ä¸ªCompilerThreadæœ‰ä¸€ä¸ªå®ä¾‹
};
```

### **5.3 C1ç¼–è¯‘ç‰¹ç‚¹**

```
C1ç¼–è¯‘å™¨ç‰¹ç‚¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§                    â”‚ è¯´æ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼–è¯‘é€Ÿåº¦                â”‚ å¿« (çº¦1-5ms/æ–¹æ³•)                     â”‚
â”‚ ä»£ç è´¨é‡                â”‚ ä¸­ç­‰ (åŸºç¡€ä¼˜åŒ–)                       â”‚
â”‚ ç¼–è¯‘çº§åˆ«                â”‚ Level 1, 2, 3                         â”‚
â”‚ ä¼˜åŒ–æŠ€æœ¯                â”‚ å†…è”ã€å¸¸é‡æŠ˜å ã€æ­»ä»£ç æ¶ˆé™¤            â”‚
â”‚ Profileæ”¶é›†             â”‚ æ”¯æŒ (Level 3)                        â”‚
â”‚ å†…å­˜å ç”¨                â”‚ è¾ƒä½                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ **6. C2 Compiler - æœåŠ¡ç«¯ç¼–è¯‘å™¨**

### **6.1 æ¦‚è¿°**

C2ç¼–è¯‘å™¨ï¼ˆä¹Ÿç§°ä¸ºæœåŠ¡ç«¯ç¼–è¯‘å™¨æˆ–ä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰æ˜¯é«˜åº¦ä¼˜åŒ–çš„ç¼–è¯‘å™¨ï¼Œç»§æ‰¿è‡ª`AbstractCompiler`ã€‚

### **6.2 ç±»å®šä¹‰**

```cpp
class C2Compiler : public AbstractCompiler {
  // C2ç¼–è¯‘å™¨ç‰¹æœ‰æˆå‘˜
  
  // å…³é”®ç‰¹æ€§:
  // - ç¼–è¯‘å™¨åç§°: "C2"
  // - æ”¯æŒé‡è¯•æœºåˆ¶(ç¼–è¯‘å¤±è´¥æ—¶å¯ä»¥ç¦ç”¨æŸäº›ä¼˜åŒ–é‡è¯•)
};
```

### **6.3 é‡è¯•æœºåˆ¶**

```cpp
// C2ç¼–è¯‘å¤±è´¥æ—¶çš„é‡è¯•åŸå› 
static const char* retry_no_subsuming_loads();      // ç¦ç”¨å­è¡¨è¾¾å¼åŠ è½½ä¼˜åŒ–
static const char* retry_no_escape_analysis();      // ç¦ç”¨é€ƒé€¸åˆ†æ
static const char* retry_no_locks_coarsening();     // ç¦ç”¨é”ç²—åŒ–
static const char* retry_class_loading_during_parsing(); // è§£ææ—¶ç±»åŠ è½½é—®é¢˜
```

### **6.4 C2ç¼–è¯‘ç‰¹ç‚¹**

```
C2ç¼–è¯‘å™¨ç‰¹ç‚¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§                    â”‚ è¯´æ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼–è¯‘é€Ÿåº¦                â”‚ æ…¢ (çº¦50-500ms/æ–¹æ³•)                  â”‚
â”‚ ä»£ç è´¨é‡                â”‚ é«˜ (æ¿€è¿›ä¼˜åŒ–)                         â”‚
â”‚ ç¼–è¯‘çº§åˆ«                â”‚ Level 4                               â”‚
â”‚ ä¼˜åŒ–æŠ€æœ¯                â”‚ é€ƒé€¸åˆ†æã€æ ‡é‡æ›¿æ¢ã€å¾ªç¯ä¼˜åŒ–ã€å‘é‡åŒ–  â”‚
â”‚ Profileä½¿ç”¨             â”‚ åˆ©ç”¨C1æ”¶é›†çš„Profile                   â”‚
â”‚ å†…å­˜å ç”¨                â”‚ è¾ƒé«˜ (ç¼–è¯‘æœŸé—´)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **7. CompileTask - ç¼–è¯‘ä»»åŠ¡**

### **7.1 æ¦‚è¿°**

`CompileTask`è¡¨ç¤ºç¼–è¯‘é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªç¼–è¯‘ä»»åŠ¡ï¼ŒåŒ…å«å¾…ç¼–è¯‘æ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ã€‚

### **7.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CompileTask : public CHeapObj<mtCompiler> {
  // ==================== ä»»åŠ¡æ ‡è¯† ====================
  uint _compile_id;                            // ç¼–è¯‘ä»»åŠ¡å”¯ä¸€ID
  
  // ==================== å¾…ç¼–è¯‘æ–¹æ³• ====================
  Method* _method;                             // å¾…ç¼–è¯‘çš„æ–¹æ³•
  int _osr_bci;                                // OSRç¼–è¯‘çš„å­—èŠ‚ç ç´¢å¼• (-1è¡¨ç¤ºéOSR)
  
  // ==================== ç¼–è¯‘çŠ¶æ€ ====================
  bool _is_complete;                           // ç¼–è¯‘æ˜¯å¦å®Œæˆ
  bool _is_success;                            // ç¼–è¯‘æ˜¯å¦æˆåŠŸ
  bool _is_blocking;                           // æ˜¯å¦é˜»å¡å¼ç¼–è¯‘
  
  // ==================== ç¼–è¯‘é…ç½® ====================
  int _comp_level;                             // ç¼–è¯‘çº§åˆ« (1-4)
  int _num_inlined_bytecodes;                  // å†…è”çš„å­—èŠ‚ç æ•°é‡
  
  // ==================== ç¼–è¯‘ç»“æœ ====================
  nmethodLocker* _code_handle;                 // ç¼–è¯‘ç»“æœçš„æŒæœ‰è€…
  
  // ==================== é“¾è¡¨ç®¡ç† ====================
  CompileTask* _next;                          // ä¸‹ä¸€ä¸ªä»»åŠ¡
  CompileTask* _prev;                          // ä¸Šä¸€ä¸ªä»»åŠ¡
  
  // ==================== æ—¶é—´ä¿¡æ¯ ====================
  jlong _time_queued;                          // å…¥é˜Ÿæ—¶é—´
  jlong _time_started;                         // ç¼–è¯‘å¼€å§‹æ—¶é—´
  
  // ==================== çƒ­ç‚¹ä¿¡æ¯ ====================
  Method* _hot_method;                         // è§¦å‘ç¼–è¯‘çš„çƒ­ç‚¹æ–¹æ³•
  int _hot_count;                              // è°ƒç”¨è®¡æ•°
  
  // ==================== ç¼–è¯‘åŸå›  ====================
  CompileReason _compile_reason;               // ç¼–è¯‘åŸå› 
  const char* _failure_reason;                 // å¤±è´¥åŸå› 
};
```

### **7.3 ç¼–è¯‘åŸå› æšä¸¾**

```cpp
enum CompileReason {
  Reason_None,              // æ— åŸå› 
  Reason_InvocationCount,   // è°ƒç”¨æ¬¡æ•°è§¦å‘
  Reason_BackedgeCount,     // å›è¾¹è®¡æ•°è§¦å‘
  Reason_Tiered,            // åˆ†å±‚ç¼–è¯‘è§¦å‘
  Reason_CTW,               // Compile the World
  Reason_Replay,            // ciReplay
  Reason_Whitebox,          // Whitebox API
  Reason_MustBeCompiled,    // å¿…é¡»ç¼–è¯‘
  Reason_Bootstrap,         // JVMCIå¼•å¯¼
  Reason_Count
};
```

### **7.4 ç¼–è¯‘çº§åˆ«è¯´æ˜**

```
åˆ†å±‚ç¼–è¯‘çº§åˆ«:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº§åˆ« â”‚ ç¼–è¯‘å™¨ â”‚ Profile â”‚ è¯´æ˜                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0    â”‚ è§£é‡Šå™¨ â”‚ æ—       â”‚ è§£é‡Šæ‰§è¡Œ                             â”‚
â”‚ 1    â”‚ C1     â”‚ æ—       â”‚ ç®€å•C1ç¼–è¯‘ï¼Œæ— Profile                â”‚
â”‚ 2    â”‚ C1     â”‚ æœ‰é™    â”‚ C1ç¼–è¯‘ï¼Œæœ‰é™Profile(è°ƒç”¨è®¡æ•°)        â”‚
â”‚ 3    â”‚ C1     â”‚ å®Œæ•´    â”‚ C1ç¼–è¯‘ï¼Œå®Œæ•´Profile                  â”‚
â”‚ 4    â”‚ C2     â”‚ ä½¿ç”¨    â”‚ C2ä¼˜åŒ–ç¼–è¯‘ï¼Œä½¿ç”¨Profile              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ **8. CompiledMethod - å·²ç¼–è¯‘æ–¹æ³•åŸºç±»**

### **8.1 æ¦‚è¿°**

`CompiledMethod`æ˜¯æ‰€æœ‰å·²ç¼–è¯‘æ–¹æ³•çš„åŸºç±»ï¼Œç»§æ‰¿è‡ª`CodeBlob`ï¼Œå®šä¹‰äº†å·²ç¼–è¯‘ä»£ç çš„é€šç”¨ç»“æ„ã€‚

### **8.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CompiledMethod : public CodeBlob {
  // ==================== åä¼˜åŒ–çŠ¶æ€ ====================
  MarkForDeoptimizationStatus _mark_for_deoptimization_status;
  
  // ==================== ä»£ç å±æ€§æ ‡å¿— ====================
  bool _is_far_code;                           // ä»£ç æ˜¯å¦è¿œç¦»CodeCache
  unsigned int _has_unsafe_access:1;           // æ˜¯å¦æœ‰ä¸å®‰å…¨è®¿é—®
  unsigned int _has_method_handle_invokes:1;   // æ˜¯å¦æœ‰MethodHandleè°ƒç”¨
  unsigned int _lazy_critical_native:1;        // å»¶è¿ŸJNI critical native
  unsigned int _has_wide_vectors:1;            // æ˜¯å¦æœ‰å®½å‘é‡
  
  // ==================== æ–¹æ³•å¼•ç”¨ ====================
  Method* _method;                             // å¯¹åº”çš„Javaæ–¹æ³•
  
  // ==================== åœ°å€ä¿¡æ¯ ====================
  address _scopes_data_begin;                  // ä½œç”¨åŸŸæ•°æ®èµ·å§‹åœ°å€
  address _deopt_handler_begin;                // åä¼˜åŒ–å¤„ç†å™¨åœ°å€
  address _deopt_mh_handler_begin;             // MethodHandleåä¼˜åŒ–å¤„ç†å™¨åœ°å€
  
  // ==================== PCæè¿°ç¬¦ç¼“å­˜ ====================
  PcDescContainer _pc_desc_container;          // PCæè¿°ç¬¦ç¼“å­˜
  
  // ==================== å¼‚å¸¸ç¼“å­˜ ====================
  ExceptionCache* volatile _exception_cache;   // å¼‚å¸¸ç¼“å­˜
  
  // ==================== GCæ”¯æŒ ====================
  volatile unsigned char _unloading_clock;     // GCå¸è½½æ—¶é’Ÿ
};
```

### **8.3 æ–¹æ³•çŠ¶æ€æšä¸¾**

```cpp
enum State {
  not_installed = -1,  // æ„å»ºä¸­ï¼Œå°šæœªå®‰è£…
  in_use        = 0,   // å¯æ‰§è¡Œ
  not_used      = 1,   // ä¸å†ä½¿ç”¨ä½†å¯æ¢å¤
  not_entrant   = 2,   // æ ‡è®°åä¼˜åŒ–ï¼Œä½†æ¿€æ´»å¸§å¯èƒ½å­˜åœ¨
  zombie        = 3,   // æ— æ¿€æ´»å¸§ï¼Œå‡†å¤‡æ¸…é™¤
  unloaded      = 4    // ä¸åº”è¢«è°ƒç”¨ï¼Œç«‹å³å˜ä¸ºzombie
};
```

### **8.4 çŠ¶æ€è½¬æ¢å›¾**

```
CompiledMethodçŠ¶æ€è½¬æ¢:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚ not_installed â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚   (æ„å»ºä¸­)    â”‚                       â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚                    â”‚
â”‚            â”‚ å®‰è£…å®Œæˆ                      â”‚ å®‰è£…å¤±è´¥           â”‚
â”‚            â–¼                               â–¼                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚    in_use     â”‚                â”‚   unloaded    â”‚           â”‚
â”‚    â”‚  (å¯æ‰§è¡Œ)     â”‚                â”‚   (å·²å¸è½½)    â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚            â”‚ åä¼˜åŒ–                                             â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚  not_entrant  â”‚                                            â”‚
â”‚    â”‚ (ä¸å¯è¿›å…¥)    â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚            â”‚ æ— æ¿€æ´»å¸§                                           â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚    zombie     â”‚                                            â”‚
â”‚    â”‚  (å¾…æ¸…é™¤)     â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚            â”‚ æ¸…é™¤                                               â”‚
â”‚            â–¼                                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚    â”‚   unloaded    â”‚                                            â”‚
â”‚    â”‚   (å·²å¸è½½)    â”‚                                            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **9. nmethod - æœ¬åœ°æ–¹æ³•**

### **9.1 æ¦‚è¿°**

`nmethod`æ˜¯Javaæ–¹æ³•ç¼–è¯‘åçš„æœ¬åœ°ä»£ç è¡¨ç¤ºï¼Œç»§æ‰¿è‡ª`CompiledMethod`ï¼Œæ˜¯JITç¼–è¯‘çš„æœ€ç»ˆäº§ç‰©ã€‚

### **9.2 å†…å­˜å¸ƒå±€**

```
nmethodå†…å­˜å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç§»          â”‚ å†…å®¹                    â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0             â”‚ nmethod header          â”‚ nmethodç»“æ„ä½“æœ¬èº«     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚ [Relocation Section]    â”‚                       â”‚
â”‚ relocation    â”‚ relocation info         â”‚ é‡å®šä½ä¿¡æ¯            â”‚
â”‚               â”‚ constants               â”‚ å¸¸é‡(double/long/float)â”‚
â”‚               â”‚ oop table               â”‚ å¯¹è±¡å¼•ç”¨è¡¨            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚ [Code Section]          â”‚                       â”‚
â”‚ code          â”‚ code body               â”‚ æœºå™¨ä»£ç ä¸»ä½“          â”‚
â”‚               â”‚ exception handler       â”‚ å¼‚å¸¸å¤„ç†å™¨            â”‚
â”‚               â”‚ stub code               â”‚ æ¡©ä»£ç                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚ [Debug Section]         â”‚                       â”‚
â”‚ debug         â”‚ oop array               â”‚ è°ƒè¯•ç”¨oopæ•°ç»„         â”‚
â”‚               â”‚ data array              â”‚ æ•°æ®æ•°ç»„              â”‚
â”‚               â”‚ pc descriptors          â”‚ PCæè¿°ç¬¦              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚ [Exception Table]       â”‚                       â”‚
â”‚ exception     â”‚ handler entry array     â”‚ å¼‚å¸¸å¤„ç†å™¨å…¥å£æ•°ç»„    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               â”‚ [Implicit Null Table]   â”‚                       â”‚
â”‚ null          â”‚ implicit null array     â”‚ éšå¼ç©ºæ£€æŸ¥è¡¨          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **9.3 å…³é”®æˆå‘˜å˜é‡**

```cpp
class nmethod : public CompiledMethod {
  // ==================== OSRæ”¯æŒ ====================
  int _entry_bci;                              // OSRæ–¹æ³•çš„å…¥å£BCI (-1è¡¨ç¤ºéOSR)
  
  // ==================== å…¥å£ç‚¹ ====================
  address _entry_point;                        // å¸¦ç±»æ£€æŸ¥çš„å…¥å£ç‚¹
  address _verified_entry_point;               // æ— ç±»æ£€æŸ¥çš„å…¥å£ç‚¹(å·²éªŒè¯è°ƒç”¨è€…)
  address _osr_entry_point;                    // OSRå…¥å£ç‚¹
  
  // ==================== åç§»é‡è¡¨ ====================
  int _exception_offset;                       // å¼‚å¸¸å¤„ç†å™¨åç§»
  int _unwind_handler_offset;                  // å±•å¼€å¤„ç†å™¨åç§»
  int _consts_offset;                          // å¸¸é‡åŒºåç§»
  int _stub_offset;                            // æ¡©ä»£ç åç§»
  int _oops_offset;                            // oopè¡¨åç§»
  int _metadata_offset;                        // å…ƒæ•°æ®è¡¨åç§»
  int _scopes_data_offset;                     // ä½œç”¨åŸŸæ•°æ®åç§»
  int _scopes_pcs_offset;                      // PCæè¿°ç¬¦åç§»
  int _dependencies_offset;                    // ä¾èµ–ä¿¡æ¯åç§»
  int _handler_table_offset;                   // å¼‚å¸¸å¤„ç†è¡¨åç§»
  int _nul_chk_table_offset;                   // ç©ºæ£€æŸ¥è¡¨åç§»
  int _nmethod_end_offset;                     // nmethodç»“æŸåç§»
  
  // ==================== ç¼–è¯‘ä¿¡æ¯ ====================
  int _compile_id;                             // ç¼–è¯‘ID
  int _comp_level;                             // ç¼–è¯‘çº§åˆ«
  
  // ==================== çŠ¶æ€ç®¡ç† ====================
  volatile signed char _state;                 // çŠ¶æ€ (in_use/not_entrant/zombieç­‰)
  
  // ==================== çƒ­åº¦ç®¡ç† ====================
  int _hotness_counter;                        // çƒ­åº¦è®¡æ•°å™¨
  
  // ==================== GCæ”¯æŒ ====================
  volatile long _stack_traversal_mark;         // æ ˆéå†æ ‡è®°
  volatile jint _lock_count;                   // é”è®¡æ•°ï¼Œé˜²æ­¢è¢«æ¸…é™¤
  
  // ==================== OSRé“¾è¡¨ ====================
  nmethod* volatile _osr_link;                 // OSRé“¾è¡¨æŒ‡é’ˆ
};
```

### **9.4 å…¥å£ç‚¹ç±»å‹**

```
nmethodå…¥å£ç‚¹ç±»å‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¥å£ç‚¹                  â”‚ ç”¨é€”                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _entry_point            â”‚ éœ€è¦ç±»å‹æ£€æŸ¥çš„è°ƒç”¨(å¦‚è™šè°ƒç”¨)          â”‚
â”‚ _verified_entry_point   â”‚ å·²éªŒè¯ç±»å‹çš„è°ƒç”¨(å¦‚é™æ€è°ƒç”¨)          â”‚
â”‚ _osr_entry_point        â”‚ æ ˆä¸Šæ›¿æ¢å…¥å£                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **9.5 8GBå †ç¯å¢ƒä¸‹çš„nmethodç»Ÿè®¡**

```
nmethodç»Ÿè®¡ (8GBå †, å…¸å‹åº”ç”¨):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å…¸å‹å€¼                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹³å‡nmethodå¤§å°         â”‚ 1-5KB                                 â”‚
â”‚ çƒ­ç‚¹æ–¹æ³•nmethodå¤§å°     â”‚ 10-100KB                              â”‚
â”‚ æ€»nmethodæ•°é‡           â”‚ 5000-20000                            â”‚
â”‚ CodeCacheå ç”¨           â”‚ 50-200MB                              â”‚
â”‚ ç¼–è¯‘æ—¶é—´(C1)            â”‚ 1-5ms/æ–¹æ³•                            â”‚
â”‚ ç¼–è¯‘æ—¶é—´(C2)            â”‚ 50-500ms/æ–¹æ³•                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ **10. CodeHeap - ä»£ç å †**

### **10.1 æ¦‚è¿°**

`CodeHeap`ç®¡ç†ç¼–è¯‘åä»£ç çš„å†…å­˜åˆ†é…ï¼Œæ˜¯CodeCacheçš„åº•å±‚å­˜å‚¨ã€‚JDK 9+ä½¿ç”¨åˆ†æ®µCodeCacheï¼Œæœ‰ä¸‰ä¸ªç‹¬ç«‹çš„CodeHeapã€‚

### **10.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class CodeHeap : public CHeapObj<mtCode> {
  // ==================== å†…å­˜ç®¡ç† ====================
  VirtualSpace _memory;                        // å­˜å‚¨ä»£ç å—çš„è™šæ‹Ÿå†…å­˜
  VirtualSpace _segmap;                        // æ®µæ˜ å°„è¡¨å†…å­˜
  
  // ==================== æ®µç®¡ç† ====================
  size_t _number_of_committed_segments;        // å·²æäº¤çš„æ®µæ•°
  size_t _number_of_reserved_segments;         // ä¿ç•™çš„æ®µæ•°
  size_t _segment_size;                        // æ®µå¤§å°
  int _log2_segment_size;                      // æ®µå¤§å°çš„log2å€¼
  size_t _next_segment;                        // ä¸‹ä¸€ä¸ªå¯ç”¨æ®µ
  
  // ==================== ç©ºé—²åˆ—è¡¨ ====================
  FreeBlock* _freelist;                        // ç©ºé—²å—é“¾è¡¨
  size_t _freelist_segments;                   // ç©ºé—²é“¾è¡¨ä¸­çš„æ®µæ•°
  int _freelist_length;                        // ç©ºé—²é“¾è¡¨é•¿åº¦
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  size_t _max_allocated_capacity;              // å³°å€¼åˆ†é…å®¹é‡
  
  // ==================== æ ‡è¯†ä¿¡æ¯ ====================
  const char* _name;                           // å †åç§°
  int _code_blob_type;                         // å­˜å‚¨çš„CodeBlobç±»å‹
  
  // ==================== è®¡æ•°å™¨ ====================
  int _blob_count;                             // CodeBlobæ•°é‡
  int _nmethod_count;                          // nmethodæ•°é‡
  int _adapter_count;                          // adapteræ•°é‡
  int _full_count;                             // å †æ»¡æ¬¡æ•°
};
```

### **10.3 åˆ†æ®µCodeCacheæ¶æ„**

```
åˆ†æ®µCodeCacheæ¶æ„ (JDK 9+):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CodeCache                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   CodeHeap       â”‚  â”‚   CodeHeap       â”‚  â”‚   CodeHeap       â”‚â”‚
â”‚  â”‚  (non-method)    â”‚  â”‚   (profiled)     â”‚  â”‚ (non-profiled)   â”‚â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚â”‚
â”‚  â”‚ â€¢ VMç”Ÿæˆä»£ç      â”‚  â”‚ â€¢ C1ç¼–è¯‘ä»£ç      â”‚  â”‚ â€¢ C2ç¼–è¯‘ä»£ç      â”‚â”‚
â”‚  â”‚ â€¢ æ¡©ä»£ç          â”‚  â”‚ â€¢ å¸¦Profileçš„    â”‚  â”‚ â€¢ ä¼˜åŒ–åçš„ä»£ç    â”‚â”‚
â”‚  â”‚ â€¢ é€‚é…å™¨         â”‚  â”‚   nmethod        â”‚  â”‚ â€¢ æ— Profile      â”‚â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚â”‚
â”‚  â”‚ é»˜è®¤: 5MB        â”‚  â”‚ é»˜è®¤: ~120MB     â”‚  â”‚ é»˜è®¤: ~120MB     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  æ€»å¤§å°: ReservedCodeCacheSize (é»˜è®¤240MB)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **10.4 8GBå †ç¯å¢ƒä¸‹çš„CodeCacheé…ç½®**

```
CodeCacheé…ç½® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ é»˜è®¤å€¼        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ReservedCodeCacheSize   â”‚ 240MB         â”‚ CodeCacheæ€»å¤§å°       â”‚
â”‚ InitialCodeCacheSize    â”‚ 2.5MB         â”‚ åˆå§‹å¤§å°              â”‚
â”‚ CodeCacheExpansionSize  â”‚ 64KB          â”‚ æ‰©å±•æ­¥é•¿              â”‚
â”‚ NonNMethodCodeHeapSize  â”‚ 5MB           â”‚ éæ–¹æ³•ä»£ç å †å¤§å°      â”‚
â”‚ ProfiledCodeHeapSize    â”‚ ~117MB        â”‚ Profileä»£ç å †å¤§å°     â”‚
â”‚ NonProfiledCodeHeapSize â”‚ ~117MB        â”‚ éProfileä»£ç å †å¤§å°   â”‚
â”‚ CodeCacheMinimumFreeSpaceâ”‚ 500KB        â”‚ æœ€å°ç©ºé—²ç©ºé—´          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— **11. ç¼–è¯‘ç³»ç»Ÿå¯¹è±¡å…³ç³»å›¾**

```
ç¼–è¯‘ç³»ç»Ÿå¯¹è±¡å…³ç³»å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                        â”‚  CompileBroker  â”‚                                  â”‚
â”‚                        â”‚   (AllStatic)   â”‚                                  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                 â”‚ ç®¡ç†                                      â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â–¼                  â–¼                  â–¼                        â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚      â”‚ CompileQueue â”‚   â”‚ CompileQueue â”‚   â”‚AbstractCompilerâ”‚                â”‚
â”‚      â”‚   (_c1_)     â”‚   â”‚   (_c2_)     â”‚   â”‚   (åŸºç±»)     â”‚                 â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚             â”‚                  â”‚                  â”‚                         â”‚
â”‚             â–¼                  â–¼                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â–¼         â–¼         â–¼     â”‚
â”‚      â”‚ CompileTask  â”‚   â”‚ CompileTask  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚      â”‚   (é“¾è¡¨)     â”‚   â”‚   (é“¾è¡¨)     â”‚    â”‚Compilerâ”‚ â”‚C2Compilerâ”‚ â”‚JVMCI  â”‚â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  (C1)  â”‚ â”‚        â”‚ â”‚Compilerâ”‚â”‚
â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                   â”‚                         â”‚
â”‚                                       ç¼–è¯‘äº§ç”Ÿ    â–¼                         â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                         â”‚         CompiledMethod              â”‚             â”‚
â”‚                         â”‚            (åŸºç±»)                   â”‚             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                       â”‚                                     â”‚
â”‚                                       â–¼                                     â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                         â”‚            nmethod                  â”‚             â”‚
â”‚                         â”‚      (å·²ç¼–è¯‘çš„Javaæ–¹æ³•)             â”‚             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                       â”‚ å­˜å‚¨äº                              â”‚
â”‚                                       â–¼                                     â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                         â”‚           CodeCache                 â”‚             â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                         â”‚  â”‚ CodeHeap â”‚ â”‚ CodeHeap â”‚ â”‚ CodeHeap â”‚          â”‚
â”‚                         â”‚  â”‚(non-meth)â”‚ â”‚(profiled)â”‚ â”‚(non-prof)â”‚          â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **12. 8GBå †ç¯å¢ƒä¸‹çš„ç¼–è¯‘ç³»ç»Ÿç»Ÿè®¡**

### **12.1 å¯¹è±¡æ•°é‡ç»Ÿè®¡**

| å¯¹è±¡ç±»å‹ | å®ä¾‹æ•° | å•ä¸ªå¤§å° | æ€»å†…å­˜ | è¯´æ˜ |
|---------|--------|---------|--------|------|
| **CompileBroker** | 1 (é™æ€ç±») | ~2KB | ~2KB | ç¼–è¯‘ä»£ç† |
| **CompileQueue** | 2 | ~100B | ~200B | C1å’ŒC2é˜Ÿåˆ— |
| **AbstractCompiler** | 2 | ~200B | ~400B | C1å’ŒC2ç¼–è¯‘å™¨ |
| **CompilerThread** | 4-8 | ~4KB | ~32KB | ç¼–è¯‘çº¿ç¨‹ |
| **CompileTask** | 0-100 | ~200B | ~20KB | å¾…ç¼–è¯‘ä»»åŠ¡ |
| **nmethod** | 5000-20000 | 1-100KB | 50-200MB | å·²ç¼–è¯‘æ–¹æ³• |
| **CodeHeap** | 3 | ~200B | ~600B | ä»£ç å † |

### **12.2 ç¼–è¯‘æ€§èƒ½åŸºå‡†**

```
ç¼–è¯‘æ€§èƒ½åŸºå‡† (8GBå †, 8æ ¸CPU):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ C1ç¼–è¯‘        â”‚ C2ç¼–è¯‘                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹³å‡ç¼–è¯‘æ—¶é—´            â”‚ 1-5ms         â”‚ 50-500ms              â”‚
â”‚ ç¼–è¯‘ååé‡              â”‚ 200-1000/ç§’   â”‚ 2-20/ç§’               â”‚
â”‚ ä»£ç è´¨é‡                â”‚ ä¸­ç­‰          â”‚ é«˜                    â”‚
â”‚ å¯åŠ¨å½±å“                â”‚ ä½            â”‚ é«˜                    â”‚
â”‚ å³°å€¼æ€§èƒ½å½±å“            â”‚ ä¸­ç­‰          â”‚ é«˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **13. æ€»ç»“**

### **13.1 ç¼–è¯‘ç³»ç»Ÿæ ¸å¿ƒå¯¹è±¡**

1. **CompileBroker**: ç¼–è¯‘ç³»ç»Ÿçš„æ ¸å¿ƒåè°ƒè€…ï¼Œç®¡ç†ç¼–è¯‘é˜Ÿåˆ—å’Œç¼–è¯‘çº¿ç¨‹
2. **CompileQueue**: å­˜å‚¨å¾…ç¼–è¯‘ä»»åŠ¡çš„åŒå‘é“¾è¡¨
3. **AbstractCompiler**: ç¼–è¯‘å™¨æŠ½è±¡åŸºç±»ï¼ŒC1å’ŒC2ç»§æ‰¿è‡ªæ­¤
4. **CompileTask**: è¡¨ç¤ºå•ä¸ªç¼–è¯‘ä»»åŠ¡çš„æ‰€æœ‰ä¿¡æ¯
5. **CompiledMethod/nmethod**: ç¼–è¯‘åçš„æœ¬åœ°ä»£ç è¡¨ç¤º
6. **CodeHeap**: ç®¡ç†ç¼–è¯‘ä»£ç çš„å†…å­˜åˆ†é…

### **13.2 å…³é”®è®¾è®¡æ€æƒ³**

- **åˆ†å±‚ç¼–è¯‘**: C1å¿«é€Ÿç¼–è¯‘+C2ä¼˜åŒ–ç¼–è¯‘ï¼Œå¹³è¡¡å¯åŠ¨é€Ÿåº¦å’Œå³°å€¼æ€§èƒ½
- **å¼‚æ­¥ç¼–è¯‘**: ç¼–è¯‘åœ¨åå°çº¿ç¨‹è¿›è¡Œï¼Œä¸é˜»å¡åº”ç”¨æ‰§è¡Œ
- **åˆ†æ®µCodeCache**: ä¸åŒç±»å‹ä»£ç åˆ†å¼€å­˜å‚¨ï¼Œå‡å°‘ç¢ç‰‡åŒ–
- **çƒ­åº¦ç®¡ç†**: é€šè¿‡è®¡æ•°å™¨è¯†åˆ«çƒ­ç‚¹ä»£ç ï¼Œä¼˜å…ˆç¼–è¯‘

### **13.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®**

```
ç¼–è¯‘ç³»ç»Ÿè°ƒä¼˜å»ºè®® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                    â”‚ å»ºè®®                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¿«é€Ÿå¯åŠ¨                â”‚ -XX:TieredStopAtLevel=1 (ä»…C1)        â”‚
â”‚ å³°å€¼æ€§èƒ½                â”‚ -XX:+TieredCompilation (é»˜è®¤)         â”‚
â”‚ å¤§å‹åº”ç”¨                â”‚ å¢åŠ ReservedCodeCacheSize             â”‚
â”‚ å‡å°‘ç¼–è¯‘å¼€é”€            â”‚ å‡å°‘CICompilerCount                   â”‚
â”‚ è°ƒè¯•ç¼–è¯‘é—®é¢˜            â”‚ -XX:+PrintCompilation                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
