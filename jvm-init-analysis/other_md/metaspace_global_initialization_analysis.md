# JVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–ç¬¬äºŒé˜¶æ®µï¼šMetaspaceå…¨å±€åˆå§‹åŒ–æ·±åº¦è§£æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æJVMå…ƒæ•°æ®ç³»ç»Ÿåˆå§‹åŒ–çš„ç¬¬äºŒä¸ªå…³é”®æ­¥éª¤ï¼šMetaspaceå…¨å±€åˆå§‹åŒ–ã€‚Metaspaceæ˜¯JVM 8å¼•å…¥çš„é‡è¦ç‰¹æ€§ï¼Œç”¨äºå­˜å‚¨ç±»çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ›¿ä»£äº†æ°¸ä¹…ä»£ï¼ˆPermGenï¼‰ã€‚è¿™ä¸ªåˆå§‹åŒ–è¿‡ç¨‹å»ºç«‹äº†ç±»å…ƒæ•°æ®çš„å­˜å‚¨åŸºç¡€è®¾æ–½ï¼ŒåŒ…æ‹¬å‹ç¼©ç±»æŒ‡é’ˆç©ºé—´çš„åˆ†é…å’ŒMetaspaceGCçš„åˆå§‹åŒ–ã€‚

## ğŸ¯ æ ¸å¿ƒä»£ç åˆ†æ

### ä»£ç ä½ç½®ä¸ä¸Šä¸‹æ–‡

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/universe.cpp:701
SystemDictionary::initialize_oop_storage();  // ç¬¬ä¸€æ­¥å®Œæˆ

// ç¬¬äºŒæ­¥ï¼šMetaspaceå…¨å±€åˆå§‹åŒ–
Metaspace::global_initialize();
```

### Metaspace::global_initialize()å®ç°

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/metaspace.cpp:1292-1315
void Metaspace::global_initialize() {
  // 1. åˆå§‹åŒ–MetaspaceGC
  MetaspaceGC::initialize();

#if INCLUDE_CDS
  if (DumpSharedSpaces) {
    // CDSè½¬å‚¨æ¨¡å¼ï¼šåˆå§‹åŒ–è½¬å‚¨æ—¶çš„å…±äº«ç©ºé—´
    MetaspaceShared::initialize_dumptime_shared_and_meta_spaces();
  } else if (UseSharedSpaces) {
    // CDSè¿è¡Œæ—¶æ¨¡å¼ï¼šåˆå§‹åŒ–è¿è¡Œæ—¶å…±äº«ç©ºé—´
    MetaspaceShared::initialize_runtime_shared_and_meta_spaces();
  }

  if (!DumpSharedSpaces && !UseSharedSpaces)
#endif // INCLUDE_CDS
  {
    // æ ‡å‡†æ¨¡å¼ï¼šä¸ä½¿ç”¨CDS
#ifdef _LP64
    if (using_class_space()) {
      // è®¡ç®—å‹ç¼©ç±»ç©ºé—´çš„åŸºå€
      char* base = (char*)align_up(Universe::heap()->reserved_region().end(), 
                                   _reserve_alignment);
      // åˆ†é…å‹ç¼©ç±»æŒ‡é’ˆç©ºé—´
      allocate_metaspace_compressed_klass_ptrs(base, 0);
    }
#endif // _LP64
  }
  
  // åç»­åˆå§‹åŒ–...
}
```

## ğŸ—ï¸ MetaspaceGCåˆå§‹åŒ–æœºåˆ¶

### 1.1 MetaspaceGCæ ¸å¿ƒä½œç”¨

MetaspaceGCè´Ÿè´£ç®¡ç†Metaspaceçš„åƒåœ¾æ”¶é›†è§¦å‘æœºåˆ¶ï¼š

```cpp
class MetaspaceGC : AllStatic {
private:
  // GCè§¦å‘é˜ˆå€¼ï¼šå½“å·²æäº¤çš„Metaspaceè¾¾åˆ°æ­¤å€¼æ—¶è§¦å‘GC
  static volatile size_t _capacity_until_GC;
  
  // æ‰©å±•è¯·æ±‚è®¡æ•°å™¨
  static uint _shrink_factor;
  static uint _expand_count;
  
public:
  static void initialize();
  static void post_initialize();
  static bool can_expand(size_t word_size, bool is_class);
  static void inc_capacity_until_GC(size_t v, size_t* new_cap_until_GC = NULL);
};
```

### 1.2 MetaspaceGC::initialize()å®ç°

```cpp
// ä½ç½®ï¼šsrc/hotspot/share/memory/metaspace.cpp:185-189
void MetaspaceGC::initialize() {
  // åœ¨VMåˆå§‹åŒ–æœŸé—´è®¾ç½®é«˜æ°´ä½æ ‡è®°ä¸ºMaxMetaspaceSize
  // å› ä¸ºåˆå§‹åŒ–æœŸé—´ä¸èƒ½è¿›è¡ŒGC
  _capacity_until_GC = MaxMetaspaceSize;
}
```

#### **åˆå§‹åŒ–å‚æ•°åˆ†æ**

```cpp
// å…¸å‹é…ç½®å€¼ï¼ˆ8GBå †ï¼ŒLinux x86_64ï¼‰
MaxMetaspaceSize = SIZE_MAX;              // é»˜è®¤æ— é™åˆ¶ï¼ˆå®é™…å—ç³»ç»Ÿå†…å­˜é™åˆ¶ï¼‰
MetaspaceSize = 21MB;                     // åˆå§‹è§¦å‘GCçš„é˜ˆå€¼
InitialBootClassLoaderMetaspaceSize = 4MB; // å¯åŠ¨ç±»åŠ è½½å™¨åˆå§‹å…ƒç©ºé—´å¤§å°
CompressedClassSpaceSize = 1GB;           // å‹ç¼©ç±»ç©ºé—´å¤§å°ï¼ˆ64ä½å¹³å°ï¼‰
```

#### **åˆå§‹åŒ–åçš„çŠ¶æ€**

```
MetaspaceGCåˆå§‹åŒ–åçŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _capacity_until_GC = MaxMetaspaceSize (SIZE_MAX)            â”‚
â”‚ å«ä¹‰ï¼šVMåˆå§‹åŒ–æœŸé—´ä¸ä¼šè§¦å‘Metaspace GC                       â”‚
â”‚ åŸå› ï¼šåˆå§‹åŒ–æœŸé—´è¿›è¡ŒGCå¯èƒ½å¯¼è‡´VMå´©æºƒ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VMåˆå§‹åŒ–å®Œæˆåï¼ˆpost_initializeï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _capacity_until_GC = MAX(å·²æäº¤å­—èŠ‚æ•°, MetaspaceSize)        â”‚
â”‚ å…¸å‹å€¼ï¼šMAX(~4MB, 21MB) = 21MB                              â”‚
â”‚ å«ä¹‰ï¼šå½“Metaspaceä½¿ç”¨é‡è¾¾åˆ°21MBæ—¶è§¦å‘ç¬¬ä¸€æ¬¡GC               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 MetaspaceGCå·¥ä½œæœºåˆ¶

#### **GCè§¦å‘é€»è¾‘**

```cpp
// Metaspaceåˆ†é…æ—¶çš„GCæ£€æŸ¥
MetaWord* Metaspace::allocate(size_t word_size, MetadataType mdtype) {
  // 1. å°è¯•ä»ç°æœ‰chunkåˆ†é…
  MetaWord* result = current_chunk()->allocate(word_size);
  if (result != NULL) {
    return result;
  }
  
  // 2. éœ€è¦æ–°chunkï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦GC
  size_t committed_bytes = MetaspaceUtils::committed_bytes();
  if (committed_bytes >= MetaspaceGC::capacity_until_GC()) {
    // è§¦å‘Full GCæ¥å›æ”¶Metaspace
    Universe::heap()->collect(GCCause::_metadata_GC_threshold);
  }
  
  // 3. åˆ†é…æ–°chunk
  return allocate_new_chunk(word_size, mdtype);
}
```

#### **GCåçš„è°ƒæ•´æœºåˆ¶**

```cpp
// GCå®Œæˆåè°ƒæ•´capacity_until_GC
void MetaspaceGC::compute_new_size() {
  size_t committed_bytes = MetaspaceUtils::committed_bytes();
  size_t used_bytes = MetaspaceUtils::used_bytes();
  
  // è®¡ç®—æ–°çš„GCè§¦å‘é˜ˆå€¼
  size_t new_capacity_until_GC;
  
  if (used_bytes < committed_bytes * 0.95) {
    // ä½¿ç”¨ç‡ä½ï¼Œå¯ä»¥ç¼©å°é˜ˆå€¼
    new_capacity_until_GC = committed_bytes * 1.2;
  } else {
    // ä½¿ç”¨ç‡é«˜ï¼Œéœ€è¦æ‰©å¤§é˜ˆå€¼
    new_capacity_until_GC = committed_bytes * 1.4;
  }
  
  // åº”ç”¨æ–°é˜ˆå€¼
  _capacity_until_GC = new_capacity_until_GC;
}
```

## ğŸ”§ å‹ç¼©ç±»æŒ‡é’ˆç©ºé—´åˆ†é…

### 2.1 å‹ç¼©ç±»æŒ‡é’ˆæ¦‚å¿µ

å‹ç¼©ç±»æŒ‡é’ˆï¼ˆCompressed Class Pointersï¼‰æ˜¯64ä½å¹³å°çš„é‡è¦ä¼˜åŒ–æŠ€æœ¯ï¼š

```cpp
// æœªå‹ç¼©çš„ç±»æŒ‡é’ˆï¼ˆ64ä½ï¼‰
class Klass* klass_ptr;  // 8å­—èŠ‚

// å‹ç¼©çš„ç±»æŒ‡é’ˆï¼ˆ32ä½ï¼‰
narrowKlass compressed_klass;  // 4å­—èŠ‚

// è§£å‹ç¼©å…¬å¼
Klass* real_klass = narrow_klass_base + (compressed_klass << narrow_klass_shift);
```

#### **å‹ç¼©ç±»æŒ‡é’ˆçš„ä¼˜åŠ¿**

```
å†…å­˜èŠ‚çœæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¯ä¸ªå¯¹è±¡å¤´åŒ…å«ä¸€ä¸ªç±»æŒ‡é’ˆ                                     â”‚
â”‚ 8GBå †ï¼Œå‡è®¾1000ä¸‡ä¸ªå¯¹è±¡ï¼š                                   â”‚
â”‚ - æœªå‹ç¼©ï¼š1000ä¸‡ * 8å­—èŠ‚ = 80MB                            â”‚
â”‚ - å‹ç¼©åï¼š1000ä¸‡ * 4å­—èŠ‚ = 40MB                            â”‚
â”‚ - èŠ‚çœï¼š40MBï¼ˆ0.5%å †å†…å­˜ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼“å­˜æ•ˆç‡æå‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´ç´§å‡‘çš„å¯¹è±¡å¤´ â†’ æ›´å¥½çš„ç¼“å­˜å±€éƒ¨æ€§ â†’ æ›´é«˜çš„è®¿é—®æ€§èƒ½           â”‚
â”‚ å…¸å‹æå‡ï¼š2-5%çš„æ•´ä½“æ€§èƒ½                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å‹ç¼©ç±»ç©ºé—´åˆ†é…ç­–ç•¥

#### **å†…å­˜å¸ƒå±€è§„åˆ’**

```cpp
// Linux x86_64å¹³å°çš„å†…å­˜å¸ƒå±€
void Metaspace::allocate_metaspace_compressed_klass_ptrs(char* requested_addr, address cds_base) {
  // è®¡ç®—å‹ç¼©ç±»ç©ºé—´çš„èµ·å§‹åœ°å€
  char* base = (char*)align_up(Universe::heap()->reserved_region().end(), _reserve_alignment);
  
  // å…¸å‹å†…å­˜å¸ƒå±€ï¼š
  // 0x0000000000000000 - 0x00000000C0000000: Cå †ã€æ ˆã€å…¶ä»–
  // 0x00000000C0000000 - 0x0000000300000000: Javaå †ï¼ˆ8GBï¼‰
  // 0x0000000300000000 - 0x0000000340000000: å‹ç¼©ç±»ç©ºé—´ï¼ˆ1GBï¼‰
  // 0x0000000340000000 - ...: å…¶ä»–Metaspace
}
```

#### **åœ°å€å¯¹é½è¦æ±‚**

```cpp
// å…³é”®å¸¸é‡å®šä¹‰
static const size_t _reserve_alignment = 2 * M;  // 2MBå¯¹é½

// å¯¹é½çš„é‡è¦æ€§ï¼š
// 1. æ»¡è¶³æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜ç®¡ç†è¦æ±‚
// 2. ä¼˜åŒ–TLBï¼ˆTranslation Lookaside Bufferï¼‰æ€§èƒ½
// 3. æ”¯æŒå¤§é¡µï¼ˆå¦‚æœå¯ç”¨ï¼‰
// 4. ç®€åŒ–åœ°å€è®¡ç®—
```

### 2.3 å‹ç¼©ç±»ç©ºé—´åˆ†é…å®ç°

```cpp
void Metaspace::allocate_metaspace_compressed_klass_ptrs(char* requested_addr, address cds_base) {
  assert(using_class_space(), "called improperly");
  assert(UseCompressedClassPointers, "Only use with CompressedKlassPtrs");
  assert(compressed_class_space_size() < KlassEncodingMetaspaceMax, "Metaspace size is too big");
  
  // 1. ä¸ä½¿ç”¨å¤§é¡µï¼ˆç±»ç©ºé—´é€šå¸¸è¾ƒå°ï¼Œå¤§é¡µæ”¶ç›Šæœ‰é™ï¼‰
  bool large_pages = false;
  
  // 2. é¢„ç•™è™šæ‹Ÿåœ°å€ç©ºé—´
  ReservedSpace metaspace_rs = ReservedSpace(compressed_class_space_size(),
                                             _reserve_alignment,
                                             large_pages,
                                             requested_addr);
  
  if (!metaspace_rs.is_reserved()) {
    // åœ¨è¯·æ±‚åœ°å€åˆ†é…å¤±è´¥ï¼Œå°è¯•å…¶ä»–åœ°å€
    metaspace_rs = ReservedSpace(compressed_class_space_size(),
                                 _reserve_alignment,
                                 large_pages);
  }
  
  if (!metaspace_rs.is_reserved()) {
    vm_exit_during_initialization("Could not allocate metaspace", 
                                  "Compressed class space");
    return;
  }
  
  // 3. åˆå§‹åŒ–å‹ç¼©ç±»ç©ºé—´
  initialize_class_space(metaspace_rs);
  
  // 4. è®¾ç½®å‹ç¼©ç±»æŒ‡é’ˆçš„baseå’Œshift
  set_narrow_klass_base_and_shift((address)metaspace_rs.base(), cds_base);
}
```

#### **initialize_class_space()å®ç°**

```cpp
void Metaspace::initialize_class_space(ReservedSpace rs) {
  // åˆ›å»ºå‹ç¼©ç±»ç©ºé—´çš„VirtualSpaceList
  _class_space_list = new VirtualSpaceList(rs);
  
  // åˆ†é…ç¬¬ä¸€ä¸ªVirtualSpace
  VirtualSpaceNode* class_entry = _class_space_list->get_new_node();
  if (class_entry == NULL) {
    vm_exit_during_initialization("Could not initialize class space");
  }
  
  // è®¾ç½®å…¨å±€å‹ç¼©ç±»ç©ºé—´æŒ‡é’ˆ
  _space_list = _class_space_list;
}
```

### 2.4 å‹ç¼©ç±»æŒ‡é’ˆç¼–ç è®¾ç½®

#### **set_narrow_klass_base_and_shift()å®ç°**

```cpp
void Metaspace::set_narrow_klass_base_and_shift(address metaspace_base, address cds_base) {
  address lower_base;
  address higher_address;
  
  if (cds_base != 0) {
    // ä½¿ç”¨CDSæ—¶ï¼Œéœ€è¦è€ƒè™‘CDSå’ŒMetaspaceçš„åœ°å€èŒƒå›´
    lower_base = MIN2(metaspace_base, cds_base);
    higher_address = MAX2(metaspace_base + compressed_class_space_size(),
                         cds_base + MetaspaceShared::core_spaces_size());
  } else {
    // ä¸ä½¿ç”¨CDS
    lower_base = metaspace_base;
    higher_address = metaspace_base + compressed_class_space_size();
  }
  
  // è®¡ç®—ç¼–ç å‚æ•°
  Universe::set_narrow_klass_base(lower_base);
  
  if ((uint64_t)(higher_address - lower_base) <= UnscaledClassSpaceMax) {
    // å¯ä»¥ä½¿ç”¨æ— ç¼©æ”¾æ¨¡å¼
    Universe::set_narrow_klass_shift(0);
  } else {
    // éœ€è¦ä½¿ç”¨ç¼©æ”¾æ¨¡å¼
    Universe::set_narrow_klass_shift(LogKlassAlignmentInBytes);
  }
  
  // è®¾ç½®å‹ç¼©ç±»æŒ‡é’ˆèŒƒå›´
  Universe::set_narrow_klass_range(compressed_class_space_size());
}
```

#### **ç¼–ç æ¨¡å¼é€‰æ‹©**

```cpp
// å‹ç¼©ç±»æŒ‡é’ˆç¼–ç æ¨¡å¼
enum NarrowKlassMode {
  // æ¨¡å¼1ï¼šæ— ç¼©æ”¾ï¼ˆç±»ç©ºé—´ â‰¤ 4GBï¼‰
  UnscaledNarrowKlass,
  // real_klass = narrow_klass_base + compressed_klass
  
  // æ¨¡å¼2ï¼šç¼©æ”¾æ¨¡å¼ï¼ˆç±»ç©ºé—´ > 4GBï¼‰
  ScaledNarrowKlass
  // real_klass = narrow_klass_base + (compressed_klass << LogKlassAlignmentInBytes)
};

// å…¸å‹é…ç½®ï¼ˆ1GBå‹ç¼©ç±»ç©ºé—´ï¼‰
narrow_klass_base = 0x0000000300000000;  // å †ç»“æŸåçš„åœ°å€
narrow_klass_shift = 0;                  // æ— ç¼©æ”¾æ¨¡å¼
narrow_klass_range = 1GB;                // 1GBèŒƒå›´
```

## ğŸ“Š Metaspaceå†…å­˜ç®¡ç†æ¶æ„

### 3.1 åˆ†å±‚å­˜å‚¨ç»“æ„

```
Metaspaceå†…å­˜ç®¡ç†å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Metaspace                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Non-Class Space   â”‚ â”‚      Compressed Class Space     â”‚ â”‚
â”‚ â”‚   (ç±»å…ƒæ•°æ®)         â”‚ â”‚      (Klasså¯¹è±¡)               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                VirtualSpaceList                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ VirtualSpaceNodeâ”‚ â”‚ VirtualSpaceNodeâ”‚ â”‚      ...      â”‚ â”‚
â”‚ â”‚    (1MB-8MB)    â”‚ â”‚    (1MB-8MB)    â”‚ â”‚               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ChunkManager                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚SmallChunk   â”‚ â”‚MediumChunk  â”‚ â”‚     LargeChunk          â”‚ â”‚
â”‚ â”‚  (1KB)      â”‚ â”‚  (4KB)      â”‚ â”‚     (8KB+)              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MetaWordåˆ†é…                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ InstanceKlass, Method, ConstantPool, ç­‰å…ƒæ•°æ®å¯¹è±¡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Chunkå¤§å°ç­–ç•¥

```cpp
// Chunkå¤§å°å®šä¹‰
enum ChunkSizes {
  SmallChunk = 1 * K,      // 1KB - å°å¯¹è±¡
  MediumChunk = 4 * K,     // 4KB - ä¸­ç­‰å¯¹è±¡  
  LargeChunk = 8 * K,      // 8KB+ - å¤§å¯¹è±¡
  HumongousChunk = 64 * K  // 64KB+ - å·¨å‹å¯¹è±¡
};

// åˆ†é…ç­–ç•¥
MetaWord* allocate_chunk(size_t word_size) {
  if (word_size <= SmallChunk / BytesPerWord) {
    return allocate_small_chunk();
  } else if (word_size <= MediumChunk / BytesPerWord) {
    return allocate_medium_chunk();
  } else {
    return allocate_large_chunk(word_size);
  }
}
```

### 3.3 å†…å­˜å›æ”¶æœºåˆ¶

```cpp
// Metaspaceçš„å›æ”¶æœºåˆ¶
class MetaspaceGC {
public:
  // æ£€æŸ¥æ˜¯å¦éœ€è¦GC
  static bool should_concurrent_collect() {
    size_t committed = MetaspaceUtils::committed_bytes();
    size_t capacity_until_GC = MetaspaceGC::capacity_until_GC();
    
    return committed >= capacity_until_GC;
  }
  
  // GCåè°ƒæ•´é˜ˆå€¼
  static void compute_new_size() {
    size_t committed = MetaspaceUtils::committed_bytes();
    size_t used = MetaspaceUtils::used_bytes();
    double utilization = (double)used / committed;
    
    size_t new_capacity_until_GC;
    if (utilization < 0.8) {
      // åˆ©ç”¨ç‡ä½ï¼Œä¿å®ˆå¢é•¿
      new_capacity_until_GC = committed * 1.2;
    } else {
      // åˆ©ç”¨ç‡é«˜ï¼Œç§¯æå¢é•¿
      new_capacity_until_GC = committed * 1.4;
    }
    
    _capacity_until_GC = new_capacity_until_GC;
  }
};
```

## ğŸš€ æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–æ•ˆæœ

### 4.1 å†…å­˜å¼€é”€åˆ†æ

#### **åˆå§‹åŒ–å¼€é”€ï¼ˆ8GBå †ç¯å¢ƒï¼‰**

```
Metaspaceåˆå§‹åŒ–å†…å­˜å¼€é”€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ å¤§å°        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MetaspaceGCå¯¹è±¡         â”‚ ~100B       â”‚ é™æ€å˜é‡å’Œè®¡æ•°å™¨       â”‚
â”‚ å‹ç¼©ç±»ç©ºé—´é¢„ç•™          â”‚ 1GB         â”‚ è™šæ‹Ÿåœ°å€ç©ºé—´é¢„ç•™       â”‚
â”‚ å‹ç¼©ç±»ç©ºé—´å®é™…æäº¤      â”‚ ~4MB        â”‚ åˆå§‹æäº¤çš„ç‰©ç†å†…å­˜     â”‚
â”‚ Non-Class Metaspace     â”‚ ~4MB        â”‚ å¯åŠ¨ç±»åŠ è½½å™¨å…ƒç©ºé—´     â”‚
â”‚ VirtualSpaceList        â”‚ ~1KB        â”‚ ç®¡ç†æ•°æ®ç»“æ„          â”‚
â”‚ ChunkManager            â”‚ ~2KB        â”‚ Chunkç®¡ç†ç»“æ„         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è™šæ‹Ÿåœ°å€ç©ºé—´æ€»è®¡        â”‚ ~1GB        â”‚ ä¸å ç”¨ç‰©ç†å†…å­˜         â”‚
â”‚ ç‰©ç†å†…å­˜æ€»è®¡            â”‚ ~8MB        â”‚ å®é™…å ç”¨ç‰©ç†å†…å­˜       â”‚
â”‚ å 8GBå †æ¯”ä¾‹             â”‚ 0.1%        â”‚ éå¸¸å°çš„å¼€é”€          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å‹ç¼©ç±»æŒ‡é’ˆæ€§èƒ½

#### **ç¼–ç /è§£ç æ€§èƒ½**

```cpp
// å‹ç¼©ç±»æŒ‡é’ˆç¼–ç ï¼ˆå­˜å‚¨æ—¶ï¼‰
narrowKlass encode_klass(Klass* klass) {
  // æ— ç¼©æ”¾æ¨¡å¼ï¼ˆ1GBç±»ç©ºé—´ï¼‰
  return (narrowKlass)((uintptr_t)klass - (uintptr_t)narrow_klass_base());
  // æ€§èƒ½ï¼š1-2ä¸ªCPUå‘¨æœŸ
}

// å‹ç¼©ç±»æŒ‡é’ˆè§£ç ï¼ˆè®¿é—®æ—¶ï¼‰
Klass* decode_klass(narrowKlass compressed_klass) {
  // æ— ç¼©æ”¾æ¨¡å¼
  return (Klass*)((uintptr_t)narrow_klass_base() + compressed_klass);
  // æ€§èƒ½ï¼š1-2ä¸ªCPUå‘¨æœŸ
}
```

#### **å†…å­˜è®¿é—®æ€§èƒ½å¯¹æ¯”**

```
å‹ç¼©ç±»æŒ‡é’ˆæ€§èƒ½å½±å“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œç±»å‹        â”‚ æœªå‹ç¼©     â”‚ å‹ç¼©å     â”‚ æ€§èƒ½å½±å“      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹è±¡å¤´è¯»å–      â”‚ 8å­—èŠ‚      â”‚ 4å­—èŠ‚      â”‚ +ç¼“å­˜æ•ˆç‡     â”‚
â”‚ ç±»æŒ‡é’ˆè§£ç       â”‚ ç›´æ¥è®¿é—®   â”‚ 1-2å‘¨æœŸ    â”‚ -å¾®å°å¼€é”€     â”‚
â”‚ å†…å­˜å¸¦å®½        â”‚ 100%       â”‚ 50%        â”‚ +æ˜¾è‘—æå‡     â”‚
â”‚ ç¼“å­˜å‘½ä¸­ç‡      â”‚ åŸºå‡†       â”‚ +5-10%     â”‚ +æ•´ä½“æ€§èƒ½     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‡€æ€§èƒ½å½±å“      â”‚ åŸºå‡†       â”‚ +2-5%      â”‚ æ­£é¢æ”¶ç›Š      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Metaspace GCæ€§èƒ½

#### **GCè§¦å‘é¢‘ç‡åˆ†æ**

```cpp
// å…¸å‹åº”ç”¨çš„Metaspaceä½¿ç”¨æ¨¡å¼
class MetaspaceUsageAnalysis {
public:
  // å¯åŠ¨é˜¶æ®µï¼ˆ0-30ç§’ï¼‰
  void startup_phase() {
    // å¤§é‡ç±»åŠ è½½ï¼ŒMetaspaceå¿«é€Ÿå¢é•¿
    // å…¸å‹å¢é•¿ï¼š0 â†’ 50MB
    // GCè§¦å‘ï¼š2-3æ¬¡ï¼ˆé˜ˆå€¼è°ƒæ•´ï¼‰
  }
  
  // ç¨³å®šè¿è¡Œé˜¶æ®µï¼ˆ30ç§’åï¼‰
  void steady_state() {
    // å¶å°”çš„ç±»åŠ è½½ï¼ŒMetaspaceç¼“æ…¢å¢é•¿
    // å…¸å‹å¢é•¿ï¼š50MB â†’ 80MBï¼ˆæ•°å°æ—¶ï¼‰
    // GCè§¦å‘ï¼šå¾ˆå°‘ï¼ˆä¸»è¦ç”±å †GCè§¦å‘ï¼‰
  }
};
```

#### **GCå¼€é”€åˆ†æ**

```
Metaspace GCå¼€é”€åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GCé˜¶æ®µ          â”‚ è€—æ—¶        â”‚ é¢‘ç‡        â”‚ æ€»å¼€é”€        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜ˆå€¼æ£€æŸ¥        â”‚ ~1Î¼s        â”‚ æ¯æ¬¡åˆ†é…    â”‚ å¯å¿½ç•¥        â”‚
â”‚ Full GCè§¦å‘     â”‚ 10-100ms    â”‚ å¾ˆå°‘        â”‚ <0.1%         â”‚
â”‚ ç±»å¸è½½          â”‚ 1-10ms      â”‚ å¶å°”        â”‚ <0.01%        â”‚
â”‚ é˜ˆå€¼è°ƒæ•´        â”‚ ~10Î¼s       â”‚ GCå        â”‚ å¯å¿½ç•¥        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»å¼€é”€          â”‚ -           â”‚ -           â”‚ <0.2%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸å·¥ç¨‹æ™ºæ…§

### 5.1 å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼

```cpp
// Metaspaceä½¿ç”¨å»¶è¿Ÿåˆå§‹åŒ–æ¥ä¼˜åŒ–å¯åŠ¨æ€§èƒ½
class Metaspace {
private:
  static VirtualSpaceList* _space_list;
  static VirtualSpaceList* _class_space_list;
  
public:
  static VirtualSpaceList* space_list() {
    if (_space_list == NULL) {
      initialize_space_list();  // å»¶è¿Ÿåˆå§‹åŒ–
    }
    return _space_list;
  }
};
```

### 5.2 åˆ†ç¦»å…³æ³¨ç‚¹

```cpp
// Metaspaceå°†ä¸åŒç±»å‹çš„å…ƒæ•°æ®åˆ†å¼€ç®¡ç†
class MetaspaceManager {
public:
  // Non-Classå…ƒæ•°æ®ï¼šMethod, ConstantPoolç­‰
  static Metaspace* get_non_class_metaspace(ClassLoaderData* cld);
  
  // Classå…ƒæ•°æ®ï¼šInstanceKlassç­‰ï¼ˆä½¿ç”¨å‹ç¼©æŒ‡é’ˆï¼‰
  static Metaspace* get_class_metaspace(ClassLoaderData* cld);
};
```

### 5.3 è‡ªé€‚åº”é˜ˆå€¼è°ƒæ•´

```cpp
// MetaspaceGCä½¿ç”¨è‡ªé€‚åº”ç®—æ³•è°ƒæ•´GCé˜ˆå€¼
class AdaptiveMetaspaceGC {
private:
  static double _growth_factor;
  static uint _shrink_count;
  
public:
  static void adjust_threshold_after_gc() {
    double utilization = calculate_utilization();
    
    if (utilization < 0.7) {
      // åˆ©ç”¨ç‡ä½ï¼Œå‡å°‘å¢é•¿å› å­
      _growth_factor = MAX2(_growth_factor * 0.9, 1.1);
    } else if (utilization > 0.9) {
      // åˆ©ç”¨ç‡é«˜ï¼Œå¢åŠ å¢é•¿å› å­
      _growth_factor = MIN2(_growth_factor * 1.1, 2.0);
    }
    
    size_t new_threshold = committed_bytes() * _growth_factor;
    set_capacity_until_GC(new_threshold);
  }
};
```

## ğŸ‰ æ€»ç»“ï¼šMetaspaceå…¨å±€åˆå§‹åŒ–çš„é‡è¦æ„ä¹‰

### æ ¸å¿ƒä»·å€¼

1. **å…ƒæ•°æ®å­˜å‚¨åŸºç¡€**ï¼šå»ºç«‹äº†ç±»å…ƒæ•°æ®çš„å­˜å‚¨åŸºç¡€è®¾æ–½
2. **å†…å­˜ä¼˜åŒ–**ï¼šé€šè¿‡å‹ç¼©ç±»æŒ‡é’ˆèŠ‚çœå†…å­˜å¹¶æå‡æ€§èƒ½
3. **GCé›†æˆ**ï¼šä¸åƒåœ¾æ”¶é›†å™¨ç´§å¯†é›†æˆï¼Œæ”¯æŒå…ƒæ•°æ®å›æ”¶
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒåŠ¨æ€æ‰©å±•ï¼Œé€‚åº”ä¸åŒè§„æ¨¡çš„åº”ç”¨

### è®¾è®¡äº®ç‚¹

1. **åˆ†å±‚ç®¡ç†**ï¼šVirtualSpace â†’ Chunk â†’ MetaWordçš„åˆ†å±‚æ¶æ„
2. **å‹ç¼©ä¼˜åŒ–**ï¼šå‹ç¼©ç±»æŒ‡é’ˆæŠ€æœ¯èŠ‚çœå†…å­˜
3. **è‡ªé€‚åº”GC**ï¼šåŠ¨æ€è°ƒæ•´GCé˜ˆå€¼ï¼Œå¹³è¡¡æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨
4. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šä¼˜åŒ–å¯åŠ¨æ€§èƒ½

### æ€§èƒ½ç‰¹å¾

- **åˆå§‹å¼€é”€**ï¼š~8MBç‰©ç†å†…å­˜ï¼ˆ0.1%å †å†…å­˜ï¼‰
- **å‹ç¼©æ”¶ç›Š**ï¼š2-5%æ•´ä½“æ€§èƒ½æå‡
- **GCå¼€é”€**ï¼š<0.2%æ€»æ‰§è¡Œæ—¶é—´
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒGBçº§åˆ«çš„å…ƒæ•°æ®å­˜å‚¨

Metaspaceçš„å…¨å±€åˆå§‹åŒ–ä¸ºJVMçš„ç±»åŠ è½½å’Œå…ƒæ•°æ®ç®¡ç†å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚é€šè¿‡å‹ç¼©ç±»æŒ‡é’ˆæŠ€æœ¯å’Œè‡ªé€‚åº”GCæœºåˆ¶ï¼Œå®ƒåœ¨ä¿è¯åŠŸèƒ½å®Œæ•´æ€§çš„åŒæ—¶ï¼Œå®ç°äº†ä¼˜ç§€çš„æ€§èƒ½å’Œå†…å­˜æ•ˆç‡ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2026-01-13  
**åˆ†æèŒƒå›´**: OpenJDK 11 Metaspaceå…¨å±€åˆå§‹åŒ–  
**ä»£ç è·¯å¾„**: `src/hotspot/share/memory/metaspace.cpp:1292-1315`