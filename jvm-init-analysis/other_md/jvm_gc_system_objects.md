# JVM GCç³»ç»Ÿå¯¹è±¡è¯¦è§£

## ğŸ“‹ **æ–‡æ¡£æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æJVM G1åƒåœ¾æ”¶é›†å™¨ç›¸å…³çš„æ ¸å¿ƒå¯¹è±¡ï¼ŒåŒ…æ‹¬G1CollectedHeapã€HeapRegionã€G1ConcurrentMarkã€G1RemSetã€G1CardTableã€G1Policyå’ŒReferenceProcessorç­‰ã€‚

### **ğŸ¯ åˆ†æç¯å¢ƒ**
- **æ“ä½œç³»ç»Ÿ**: Linux x86_64
- **å †å¤§å°**: 8GB (-Xms8g -Xmx8g)
- **GCæ”¶é›†å™¨**: G1GC (JDK 11é»˜è®¤)
- **å¤§é¡µ**: ç¦ç”¨

---

## ğŸ—ï¸ **1. G1 GCæ¶æ„æ€»è§ˆ**

### **1.1 G1 GCç»„ä»¶å…³ç³»**

```
G1 GCæ¶æ„å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           G1CollectedHeap                                   â”‚
â”‚                         (G1åƒåœ¾æ”¶é›†å™¨æ ¸å¿ƒ)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    HeapRegionManager                                 â”‚   â”‚
â”‚  â”‚                    (å †åŒºåŸŸç®¡ç†å™¨)                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚HeapRegionâ”‚ â”‚HeapRegionâ”‚ â”‚HeapRegionâ”‚ â”‚HeapRegionâ”‚ â”‚   ...    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Eden)  â”‚ â”‚(Survivor)â”‚ â”‚  (Old)   â”‚ â”‚(Humongous)â”‚ â”‚          â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   G1CardTable    â”‚  â”‚    G1RemSet      â”‚  â”‚ G1ConcurrentMark â”‚          â”‚
â”‚  â”‚   (å¡è¡¨)         â”‚  â”‚   (è®°å¿†é›†)       â”‚  â”‚   (å¹¶å‘æ ‡è®°)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚    G1Policy      â”‚  â”‚ G1CollectionSet  â”‚  â”‚ReferenceProcessorâ”‚          â”‚
â”‚  â”‚   (GCç­–ç•¥)       â”‚  â”‚   (æ”¶é›†é›†åˆ)     â”‚  â”‚  (å¼•ç”¨å¤„ç†å™¨)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚DirtyCardQueueSet â”‚  â”‚  G1HotCardCache  â”‚  â”‚ G1ConcurrentRefineâ”‚          â”‚
â”‚  â”‚  (è„å¡é˜Ÿåˆ—é›†)    â”‚  â”‚  (çƒ­ç‚¹å¡ç¼“å­˜)    â”‚  â”‚   (å¹¶å‘ç»†åŒ–)     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ **2. G1CollectedHeap - G1å †ç®¡ç†å™¨**

### **2.1 æ¦‚è¿°**

`G1CollectedHeap`æ˜¯G1åƒåœ¾æ”¶é›†å™¨çš„æ ¸å¿ƒå †å®ç°ç±»ï¼Œç»§æ‰¿è‡ª`CollectedHeap`ï¼Œç®¡ç†æ•´ä¸ªJavaå †çš„åˆ†é…å’Œå›æ”¶ã€‚

### **2.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class G1CollectedHeap : public CollectedHeap {
  // ==================== å·¥ä½œçº¿ç¨‹ ====================
  WorkGang* _workers;                          // GCå·¥ä½œçº¿ç¨‹æ± ï¼Œç”¨äºå¹¶è¡ŒGCæ“ä½œ
  
  // ==================== ç­–ç•¥å’Œé…ç½® ====================
  G1CollectorPolicy* _collector_policy;        // æ”¶é›†å™¨ç­–ç•¥
  G1Policy* _g1_policy;                        // G1 GCç­–ç•¥ï¼Œå†³å®šæ”¶é›†è¡Œä¸º
  
  // ==================== å¡è¡¨å’Œè®°å¿†é›† ====================
  G1CardTable* _card_table;                    // G1å¡è¡¨ï¼Œç”¨äºè·Ÿè¸ªè·¨åŒºåŸŸå¼•ç”¨
  G1RemSet* _g1_rem_set;                       // è®°å¿†é›†ï¼Œè·Ÿè¸ªè·¨åŒºåŸŸå¼•ç”¨
  
  // ==================== åŒºåŸŸç®¡ç† ====================
  HeapRegionManager _hrm;                      // å †åŒºåŸŸç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰HeapRegion
  
  // ==================== å†…å­˜åˆ†é… ====================
  G1Allocator* _allocator;                     // å†…å­˜åˆ†é…å™¨
  
  // ==================== åŒºåŸŸé›†åˆ ====================
  HeapRegionSet _old_set;                      // è€å¹´ä»£åŒºåŸŸé›†åˆ
  HeapRegionSet _humongous_set;                // å·¨å‹å¯¹è±¡åŒºåŸŸé›†åˆ
  G1EdenRegions _eden;                         // EdenåŒºåŸŸåˆ—è¡¨
  G1SurvivorRegions _survivor;                 // SurvivoråŒºåŸŸåˆ—è¡¨
  
  // ==================== æ”¶é›†é›†åˆ ====================
  G1CollectionSet _collection_set;             // æ”¶é›†é›†åˆï¼Œå¾…å›æ”¶çš„åŒºåŸŸ
  
  // ==================== å¹¶å‘æ ‡è®° ====================
  G1ConcurrentMark* _cm;                       // å¹¶å‘æ ‡è®°å™¨
  G1ConcurrentMarkThread* _cm_thread;          // å¹¶å‘æ ‡è®°çº¿ç¨‹
  
  // ==================== å¹¶å‘ç»†åŒ– ====================
  G1ConcurrentRefine* _cr;                     // å¹¶å‘ç»†åŒ–å™¨
  
  // ==================== è„å¡å¤„ç† ====================
  DirtyCardQueueSet _dirty_card_queue_set;     // è„å¡é˜Ÿåˆ—é›†åˆ
  G1HotCardCache* _hot_card_cache;             // çƒ­ç‚¹å¡ç¼“å­˜ï¼Œä¼˜åŒ–é¢‘ç¹æ›´æ–°çš„å¡
  
  // ==================== å¼•ç”¨å¤„ç† ====================
  ReferenceProcessor* _ref_processor_stw;      // STWå¼•ç”¨å¤„ç†å™¨
  ReferenceProcessor* _ref_processor_cm;       // å¹¶å‘æ ‡è®°å¼•ç”¨å¤„ç†å™¨
  
  // ==================== å¿«é€Ÿæµ‹è¯• ====================
  G1InCSetStateFastTestBiasedMappedArray _in_cset_fast_test; // å¿«é€Ÿæµ‹è¯•å¯¹è±¡æ˜¯å¦åœ¨æ”¶é›†é›†åˆä¸­
  
  // ==================== å·¨å‹å¯¹è±¡å›æ”¶ ====================
  HumongousReclaimCandidates _humongous_reclaim_candidates; // å·¨å‹å¯¹è±¡å›æ”¶å€™é€‰
  
  // ==================== å—åç§»è¡¨ ====================
  G1BlockOffsetTable* _bot;                    // å—åç§»è¡¨
  
  // ==================== æ”¶é›†å™¨çŠ¶æ€ ====================
  G1CollectorState _collector_state;           // æ”¶é›†å™¨çŠ¶æ€(Young/Mixed GC)
  
  // ==================== ç–æ•£çŠ¶æ€ ====================
  bool _evacuation_failed;                     // ç–æ•£å¤±è´¥æ ‡å¿—
  
  // ==================== å¹¶è¡Œä»»åŠ¡é˜Ÿåˆ— ====================
  RefToScanQueueSet* _task_queues;             // å¹¶è¡Œä»»åŠ¡é˜Ÿåˆ—
};
```

### **2.3 8GBå †ç¯å¢ƒä¸‹çš„G1CollectedHeapé…ç½®**

```
G1CollectedHeapé…ç½® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ å€¼            â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å †å¤§å°                  â”‚ 8GB           â”‚ -Xms8g -Xmx8g         â”‚
â”‚ Regionå¤§å°              â”‚ 2MB           â”‚ è‡ªåŠ¨è®¡ç®—              â”‚
â”‚ Regionæ•°é‡              â”‚ 4096          â”‚ 8GB / 2MB             â”‚
â”‚ å¹¶è¡ŒGCçº¿ç¨‹æ•°            â”‚ 8             â”‚ ParallelGCThreads     â”‚
â”‚ å¹¶å‘æ ‡è®°çº¿ç¨‹æ•°          â”‚ 2             â”‚ ConcGCThreads         â”‚
â”‚ å¹¶å‘ç»†åŒ–çº¿ç¨‹æ•°          â”‚ 8             â”‚ G1ConcRefinementThreadsâ”‚
â”‚ IHOP                    â”‚ 45%           â”‚ InitiatingHeapOccupancyPercentâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.4 G1CollectorStateçŠ¶æ€**

```cpp
class G1CollectorState {
  // æ”¶é›†å™¨çŠ¶æ€æ ‡å¿—
  bool _gcs_are_young;                         // æ˜¯å¦åªæ”¶é›†å¹´è½»ä»£
  bool _last_gc_was_young;                     // ä¸Šæ¬¡GCæ˜¯å¦æ˜¯å¹´è½»ä»£GC
  bool _in_marking_window;                     // æ˜¯å¦åœ¨æ ‡è®°çª—å£å†…
  bool _in_marking_window_im;                  // æ˜¯å¦åœ¨åˆå§‹æ ‡è®°çª—å£å†…
  bool _full_collection;                       // æ˜¯å¦æ˜¯Full GC
};
```

---

## ğŸ“¦ **3. HeapRegion - å †åŒºåŸŸ**

### **3.1 æ¦‚è¿°**

`HeapRegion`æ˜¯G1å †çš„åŸºæœ¬å•å…ƒï¼Œæ¯ä¸ªHeapRegionæ˜¯å¯ç‹¬ç«‹æ”¶é›†çš„æœ€å°å•ä½ã€‚8GBå †ä¸‹ï¼Œæ¯ä¸ªRegionå¤§å°ä¸º2MBï¼Œå…±4096ä¸ªRegionã€‚

### **3.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class HeapRegion : public G1ContiguousSpace {
  // ==================== è®°å¿†é›† ====================
  HeapRegionRemSet* _rem_set;                  // è¯¥åŒºåŸŸçš„è®°å¿†é›†
  
  // ==================== ç´¢å¼•å’Œç±»å‹ ====================
  uint _hrm_index;                             // åœ¨å †åŒºåŸŸåºåˆ—ä¸­çš„ç´¢å¼• (0-4095)
  HeapRegionType _type;                        // åŒºåŸŸç±»å‹(Eden/Survivor/Old/Humongousç­‰)
  
  // ==================== å·¨å‹å¯¹è±¡æ”¯æŒ ====================
  HeapRegion* _humongous_start_region;         // å·¨å‹å¯¹è±¡çš„èµ·å§‹åŒºåŸŸ
  
  // ==================== ç–æ•£çŠ¶æ€ ====================
  bool _evacuation_failed;                     // ç–æ•£å¤±è´¥æ ‡å¿—
  
  // ==================== é“¾è¡¨ç®¡ç† ====================
  HeapRegion* _next;                           // ä¸‹ä¸€ä¸ªåŒºåŸŸ
  HeapRegion* _prev;                           // ä¸Šä¸€ä¸ªåŒºåŸŸ
  
  // ==================== æ ‡è®°ç»Ÿè®¡ ====================
  size_t _prev_marked_bytes;                   // ä¸Šæ¬¡æ ‡è®°çš„å­˜æ´»å­—èŠ‚æ•°
  size_t _next_marked_bytes;                   // å½“å‰æ ‡è®°çš„å­˜æ´»å­—èŠ‚æ•°
  
  // ==================== GCæ•ˆç‡ ====================
  double _gc_efficiency;                       // è®¡ç®—çš„GCæ•ˆç‡ (å›æ”¶æ”¶ç›Š/æˆæœ¬)
  
  // ==================== å¹´è½»ä»£æ”¯æŒ ====================
  int _young_index_in_cset;                    // åœ¨æ”¶é›†é›†åˆä¸­çš„å¹´è½»ä»£ç´¢å¼•
  SurvRateGroup* _surv_rate_group;             // å­˜æ´»ç‡ç»„
  int _age_index;                              // å¹´é¾„ç´¢å¼•
  
  // ==================== æ ‡è®°èµ·å§‹ä½ç½® ====================
  HeapWord* _prev_top_at_mark_start;           // ä¸Šæ¬¡æ ‡è®°å¼€å§‹æ—¶çš„top
  HeapWord* _next_top_at_mark_start;           // å½“å‰æ ‡è®°å¼€å§‹æ—¶çš„top
  
  // ==================== é¢„æµ‹ä¿¡æ¯ ====================
  size_t _recorded_rs_length;                  // è®°å½•çš„RSeté•¿åº¦
  double _predicted_elapsed_time_ms;           // é¢„æµ‹çš„ç–æ•£æ—¶é—´
};
```

### **3.3 HeapRegionTypeç±»å‹**

```cpp
class HeapRegionType {
  // åŒºåŸŸç±»å‹æ ‡ç­¾
  enum Tag {
    FreeTag       = 0,    // ç©ºé—²åŒºåŸŸ
    EdenTag       = 1,    // EdenåŒºåŸŸ
    SurvTag       = 2,    // SurvivoråŒºåŸŸ
    StartsHumongousTag = 3, // å·¨å‹å¯¹è±¡èµ·å§‹åŒºåŸŸ
    ContinuesHumongousTag = 4, // å·¨å‹å¯¹è±¡è¿ç»­åŒºåŸŸ
    OldTag        = 5,    // è€å¹´ä»£åŒºåŸŸ
    OpenArchiveTag = 6,   // å¼€æ”¾å½’æ¡£åŒºåŸŸ
    ClosedArchiveTag = 7  // å…³é—­å½’æ¡£åŒºåŸŸ
  };
  
  Tag _tag;
};
```

### **3.4 HeapRegionå†…å­˜å¸ƒå±€**

```
HeapRegionå†…å­˜å¸ƒå±€ (2MB):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        HeapRegion (2MB)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å¯¹è±¡å­˜å‚¨åŒºåŸŸ                          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º top     â”‚   â”‚
â”‚  â”‚  (èµ·å§‹åœ°å€)                                   (å·²åˆ†é…)  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚                    â—„â”€â”€â”€ å¯åˆ†é…ç©ºé—´ â”€â”€â”€â–º                 â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚                                              end â”€â”€â”€â”€â”€â”€â–ºâ”‚   â”‚
â”‚  â”‚                                              (ç»“æŸåœ°å€) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  å…³é”®åœ°å€:                                                      â”‚
â”‚  â€¢ bottom: åŒºåŸŸèµ·å§‹åœ°å€                                         â”‚
â”‚  â€¢ top: å½“å‰åˆ†é…ä½ç½®                                            â”‚
â”‚  â€¢ end: åŒºåŸŸç»“æŸåœ°å€                                            â”‚
â”‚  â€¢ prev_top_at_mark_start: ä¸Šæ¬¡æ ‡è®°å¼€å§‹æ—¶çš„top                  â”‚
â”‚  â€¢ next_top_at_mark_start: å½“å‰æ ‡è®°å¼€å§‹æ—¶çš„top                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3.5 8GBå †ç¯å¢ƒä¸‹çš„HeapRegionç»Ÿè®¡**

```
HeapRegionç»Ÿè®¡ (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å€¼            â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Regionå¤§å°              â”‚ 2MB           â”‚ GrainBytes            â”‚
â”‚ Regionæ•°é‡              â”‚ 4096          â”‚ 8GB / 2MB             â”‚
â”‚ HeapRegionå¯¹è±¡å¤§å°      â”‚ ~256B         â”‚ å…ƒæ•°æ®                â”‚
â”‚ HeapRegionæ•°ç»„æ€»å¤§å°    â”‚ ~1MB          â”‚ 4096 * 256B           â”‚
â”‚ æ¯ä¸ªRegionçš„å¡æ•°        â”‚ 4096          â”‚ 2MB / 512B            â”‚
â”‚ å·¨å‹å¯¹è±¡é˜ˆå€¼            â”‚ 1MB           â”‚ Regionå¤§å°çš„50%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ **4. HeapRegionManager - å †åŒºåŸŸç®¡ç†å™¨**

### **4.1 æ¦‚è¿°**

`HeapRegionManager`ç®¡ç†æ‰€æœ‰HeapRegionçš„ç”Ÿå‘½å‘¨æœŸå’Œåˆ†é…ï¼Œæ˜¯G1å †çš„æ ¸å¿ƒç®¡ç†ç»„ä»¶ã€‚

### **4.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class HeapRegionManager : public CHeapObj<mtGC> {
  // ==================== åŒºåŸŸæ˜ å°„è¡¨ ====================
  G1HeapRegionTable _regions;                  // å †åœ°å€åˆ°Regionçš„æ˜ å°„è¡¨
  
  // ==================== å†…å­˜æ˜ å°„å™¨ ====================
  G1RegionToSpaceMapper* _heap_mapper;         // å †å†…å­˜æ˜ å°„å™¨
  G1RegionToSpaceMapper* _prev_bitmap_mapper;  // ä¸Šä¸€ä¸ªä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _next_bitmap_mapper;  // ä¸‹ä¸€ä¸ªä½å›¾æ˜ å°„å™¨
  G1RegionToSpaceMapper* _bot_mapper;          // å—åç§»è¡¨æ˜ å°„å™¨
  G1RegionToSpaceMapper* _cardtable_mapper;    // å¡è¡¨æ˜ å°„å™¨
  G1RegionToSpaceMapper* _card_counts_mapper;  // å¡è®¡æ•°æ˜ å°„å™¨
  
  // ==================== ç©ºé—²åˆ—è¡¨ ====================
  FreeRegionList _free_list;                   // ç©ºé—²åŒºåŸŸé“¾è¡¨
  
  // ==================== å¯ç”¨æ€§ç®¡ç† ====================
  CHeapBitMap _available_map;                  // å¯ç”¨åŒºåŸŸä½å›¾
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  uint _num_committed;                         // å·²æäº¤çš„åŒºåŸŸæ•°é‡
  uint _allocated_heapregions_length;          // å·²åˆ†é…HeapRegionå®ä¾‹çš„æ•°é‡
};
```

### **4.3 G1HeapRegionTableç»“æ„**

```cpp
// å †åœ°å€åˆ°HeapRegionçš„æ˜ å°„è¡¨
class G1HeapRegionTable : public G1BiasedMappedArray<HeapRegion*> {
  // é€šè¿‡åœ°å€å¿«é€ŸæŸ¥æ‰¾HeapRegion
  // æŸ¥æ‰¾å¤æ‚åº¦: O(1)
  // å†…å­˜å ç”¨: 4096 * 8B = 32KB (8GBå †)
};
```

### **4.4 åŒºåŸŸåˆ†é…æµç¨‹**

```
HeapRegionManageråŒºåŸŸåˆ†é…æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. æ£€æŸ¥ç©ºé—²åˆ—è¡¨                                                â”‚
â”‚     â”‚                                                           â”‚
â”‚     â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  _free_listéç©º?                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â”‚ æ˜¯                              â”‚ å¦                      â”‚
â”‚     â–¼                                 â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ä»ç©ºé—²åˆ—è¡¨å–å‡º  â”‚           â”‚ æ‰©å±•å †          â”‚              â”‚
â”‚  â”‚ HeapRegion      â”‚           â”‚ (commitæ–°åŒºåŸŸ)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚     â”‚                                 â”‚                         â”‚
â”‚     â–¼                                 â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. åˆå§‹åŒ–HeapRegion                                     â”‚   â”‚
â”‚  â”‚    â€¢ è®¾ç½®ç±»å‹ (Eden/Survivor/Old)                       â”‚   â”‚
â”‚  â”‚    â€¢ é‡ç½®åˆ†é…æŒ‡é’ˆ                                       â”‚   â”‚
â”‚  â”‚    â€¢ æ¸…ç©ºè®°å¿†é›†                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â”‚                                                           â”‚
â”‚     â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. è¿”å›HeapRegionç»™è°ƒç”¨è€…                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸƒ **5. G1CardTable - G1å¡è¡¨**

### **5.1 æ¦‚è¿°**

`G1CardTable`æ˜¯G1çš„å†™å±éšœæ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç»§æ‰¿è‡ª`CardTable`ï¼Œç”¨äºè·Ÿè¸ªå †å†…å­˜çš„ä¿®æ”¹ã€‚æ¯å¼ å¡è¦†ç›–512å­—èŠ‚çš„å †å†…å­˜ã€‚

### **5.2 CardTableåŸºç±»æˆå‘˜å˜é‡**

```cpp
class CardTable : public CHeapObj<mtGC> {
  // ==================== å¡è¡¨é…ç½® ====================
  const bool _scanned_concurrently;            // æ˜¯å¦æ”¯æŒå¹¶å‘æ‰«æ
  const MemRegion _whole_heap;                 // å¡è¡¨è¦†ç›–çš„æ•´ä¸ªå †åŒºåŸŸ
  
  // ==================== ç´¢å¼•ç®¡ç† ====================
  size_t _guard_index;                         // æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•(å®ˆå«å€¼)
  size_t _last_valid_index;                    // æœ€åä¸€ä¸ªæœ‰æ•ˆå…ƒç´ çš„ç´¢å¼•
  
  // ==================== å†…å­˜ç®¡ç† ====================
  const size_t _page_size;                     // æ˜ å°„byte_mapæ—¶ä½¿ç”¨çš„é¡µå¤§å°
  size_t _byte_map_size;                       // å¡æ ‡è®°æ•°ç»„å¤§å°(å­—èŠ‚)
  
  // ==================== æ ¸å¿ƒæ•°æ®ç»“æ„ ====================
  jbyte* _byte_map;                            // **å¡æ ‡è®°æ•°ç»„** - æ ¸å¿ƒæ•°æ®ç»“æ„
  jbyte* _byte_map_base;                       // è°ƒæ•´åçš„å¡æ•°ç»„åŸºåœ°å€
  
  // ==================== è¦†ç›–åŒºåŸŸ ====================
  MemRegion* _covered;                         // è¦†ç›–çš„åŒºåŸŸ
  MemRegion* _committed;                       // å·²æäº¤çš„åŒºåŸŸ
};
```

### **5.3 G1CardTableç‰¹æœ‰æˆå‘˜**

```cpp
class G1CardTable : public CardTable {
  // ==================== ç›‘å¬å™¨ ====================
  G1CardTableChangedListener _listener;        // ç›‘å¬Regionæäº¤äº‹ä»¶ï¼Œè‡ªåŠ¨æ¸…ç†å¡è¡¨
};
```

### **5.4 å¡è¡¨å¸¸é‡**

```cpp
// å¡è¡¨å…³é”®å¸¸é‡
enum {
  card_shift = 9,          // åœ°å€å³ç§»9ä½å¾—åˆ°å¡ç´¢å¼•
  card_size = 512,         // æ¯å¼ å¡è¦†ç›–512å­—èŠ‚å †å†…å­˜
  card_size_in_words = 64  // æ¯å¼ å¡è¦†ç›–64ä¸ªå­—(64ä½ç³»ç»Ÿ)
};

// å¡çŠ¶æ€å€¼
enum CardValue {
  clean_card = -1,         // å¹²å‡€å¡ (æœªä¿®æ”¹)
  dirty_card = 0,          // è„å¡ (å·²ä¿®æ”¹)
  g1_young_gen = 1         // G1ç‰¹æœ‰ï¼šå¹´è½»ä»£å¡
};
```

### **5.5 å¡è¡¨å·¥ä½œåŸç†**

```
å¡è¡¨å·¥ä½œåŸç†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Javaå † (8GB)                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  512B  â”‚  512B  â”‚  512B  â”‚  512B  â”‚  ...  â”‚  512B       â”‚   â”‚
â”‚  â”‚ åŒºåŸŸ0  â”‚ åŒºåŸŸ1  â”‚ åŒºåŸŸ2  â”‚ åŒºåŸŸ3  â”‚       â”‚ åŒºåŸŸN       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚        â”‚        â”‚        â”‚                â”‚            â”‚
â”‚       â–¼        â–¼        â–¼        â–¼                â–¼            â”‚
â”‚  å¡è¡¨ (16MB)                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ å¡0 â”‚ å¡1 â”‚ å¡2 â”‚ å¡3 â”‚      ...        â”‚ å¡N â”‚             â”‚
â”‚  â”‚ 1B  â”‚ 1B  â”‚ 1B  â”‚ 1B  â”‚                 â”‚ 1B  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                 â”‚
â”‚  å¡è¡¨å¤§å°è®¡ç®—:                                                  â”‚
â”‚  8GB / 512B = 16,777,216 å¼ å¡ = 16MB                            â”‚
â”‚                                                                 â”‚
â”‚  åœ°å€åˆ°å¡ç´¢å¼•è½¬æ¢:                                              â”‚
â”‚  card_index = (address - heap_base) >> 9                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **5.6 8GBå †ç¯å¢ƒä¸‹çš„å¡è¡¨ç»Ÿè®¡**

```
å¡è¡¨ç»Ÿè®¡ (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å€¼            â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¡å¤§å°                  â”‚ 512B          â”‚ card_size             â”‚
â”‚ å¡è¡¨å¤§å°                â”‚ 16MB          â”‚ 8GB / 512B            â”‚
â”‚ å¡æ•°é‡                  â”‚ 16,777,216    â”‚ 8GB / 512B            â”‚
â”‚ æ¯ä¸ªRegionçš„å¡æ•°        â”‚ 4096          â”‚ 2MB / 512B            â”‚
â”‚ å¡è¡¨å†…å­˜å ç”¨            â”‚ 16MB          â”‚ 1å­—èŠ‚/å¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **6. G1RemSet - è®°å¿†é›†**

### **6.1 æ¦‚è¿°**

`G1RemSet`ç®¡ç†G1çš„è®°å¿†é›†(Remembered Set)ï¼Œç”¨äºè·Ÿè¸ªä»å…¶ä»–RegionæŒ‡å‘æŸä¸ªRegionçš„å¼•ç”¨ï¼Œæ˜¯G1å®ç°å¢é‡æ”¶é›†çš„å…³é”®ã€‚

### **6.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class G1RemSet : public CHeapObj<mtGC> {
  // ==================== æ‰«æçŠ¶æ€ ====================
  G1RemSetScanState* _scan_state;              // æ‰«æçŠ¶æ€ç®¡ç†
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  G1RemSetSummary _prev_period_summary;        // ä¸Šä¸€å‘¨æœŸçš„ç»Ÿè®¡æ‘˜è¦
  
  // ==================== å¼•ç”¨ ====================
  G1CollectedHeap* _g1h;                       // æŒ‡å‘G1å †
  size_t _num_conc_refined_cards;              // å¹¶å‘ç»†åŒ–çš„å¡æ•°é‡
  
  // ==================== å¡è¡¨ ====================
  G1CardTable* _ct;                            // G1å¡è¡¨
  
  // ==================== ç­–ç•¥ ====================
  G1Policy* _g1p;                              // G1ç­–ç•¥
  
  // ==================== çƒ­ç‚¹å¡ç¼“å­˜ ====================
  G1HotCardCache* _hot_card_cache;             // çƒ­ç‚¹å¡ç¼“å­˜
};
```

### **6.3 HeapRegionRemSetç»“æ„**

```cpp
// æ¯ä¸ªHeapRegionçš„è®°å¿†é›†
class HeapRegionRemSet : public CHeapObj<mtGC> {
  // å­˜å‚¨æŒ‡å‘è¯¥Regionçš„æ‰€æœ‰å¼•ç”¨
  // ç»“æ„: OtherRegionIndex -> CardSet
  
  // å…³é”®æ–¹æ³•:
  // add_reference(oop* from) - æ·»åŠ å¼•ç”¨
  // iterate(closure) - éå†æ‰€æœ‰å¼•ç”¨
  // clear() - æ¸…ç©ºè®°å¿†é›†
};
```

### **6.4 è®°å¿†é›†å·¥ä½œåŸç†**

```
è®°å¿†é›†å·¥ä½œåŸç†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  Region A (è€å¹´ä»£)              Region B (å¹´è½»ä»£)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                     â”‚       â”‚                     â”‚         â”‚
â”‚  â”‚  Object X â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Object Y           â”‚         â”‚
â”‚  â”‚  (å¼•ç”¨Y)            â”‚       â”‚                     â”‚         â”‚
â”‚  â”‚                     â”‚       â”‚                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                        â”‚                        â”‚
â”‚                                        â–¼                        â”‚
â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                                â”‚ Region Bçš„    â”‚                â”‚
â”‚                                â”‚ RemSet        â”‚                â”‚
â”‚                                â”‚               â”‚                â”‚
â”‚                                â”‚ è®°å½•: A->B    â”‚                â”‚
â”‚                                â”‚ (å¡ç´¢å¼•)      â”‚                â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                 â”‚
â”‚  GCæ—¶:                                                          â”‚
â”‚  â€¢ åªéœ€æ‰«æRegion Bçš„RemSet                                     â”‚
â”‚  â€¢ æ‰¾åˆ°æ‰€æœ‰æŒ‡å‘Bçš„å¼•ç”¨                                          â”‚
â”‚  â€¢ ä¸éœ€è¦æ‰«ææ•´ä¸ªå †                                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” **7. G1ConcurrentMark - å¹¶å‘æ ‡è®°**

### **7.1 æ¦‚è¿°**

`G1ConcurrentMark`è´Ÿè´£G1å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ‰€æœ‰æ“ä½œï¼Œæ˜¯G1å®ç°ä½å»¶è¿Ÿçš„å…³é”®ç»„ä»¶ã€‚

### **7.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class G1ConcurrentMark : public CHeapObj<mtGC> {
  // ==================== çº¿ç¨‹ç®¡ç† ====================
  G1ConcurrentMarkThread* _cm_thread;          // æ‰§è¡Œå¹¶å‘æ ‡è®°çš„çº¿ç¨‹
  WorkGang* _concurrent_workers;               // å¹¶å‘å·¥ä½œçº¿ç¨‹
  
  // ==================== å †å¼•ç”¨ ====================
  G1CollectedHeap* _g1h;                       // æŒ‡å‘G1å †
  
  // ==================== æ ‡è®°ä½å›¾ (åŒç¼“å†²) ====================
  G1CMBitMap _mark_bitmap_1;                   // æ ‡è®°ä½å›¾1
  G1CMBitMap _mark_bitmap_2;                   // æ ‡è®°ä½å›¾2
  G1CMBitMap* _prev_mark_bitmap;               // ä¸Šä¸€æ¬¡å®Œæˆçš„æ ‡è®°ä½å›¾
  G1CMBitMap* _next_mark_bitmap;               // æ­£åœ¨æ„å»ºçš„æ ‡è®°ä½å›¾
  
  // ==================== å †è¾¹ç•Œ ====================
  MemRegion const _heap;                       // å †è¾¹ç•Œ
  
  // ==================== æ ¹åŒºåŸŸ ====================
  G1CMRootRegions _root_regions;               // æ ¹åŒºåŸŸè·Ÿè¸ªå’Œå£°æ˜
  
  // ==================== æ ‡è®°æ ˆ ====================
  G1CMMarkStack _global_mark_stack;            // å…¨å±€æ ‡è®°æ ˆ(ç°è‰²å¯¹è±¡)
  
  // ==================== æ‰«ææŒ‡é’ˆ ====================
  HeapWord* volatile _finger;                  // å…¨å±€æ‰«ææŒ‡é’ˆï¼ŒæŒ‡å‘æœ€åå£°æ˜åŒºåŸŸçš„æœ«å°¾
  
  // ==================== ä»»åŠ¡ç®¡ç† ====================
  uint _max_num_tasks;                         // æœ€å¤§æ ‡è®°ä»»åŠ¡æ•°
  uint _num_active_tasks;                      // å½“å‰æ´»è·ƒä»»åŠ¡æ•°
  G1CMTask** _tasks;                           // ä»»åŠ¡é˜Ÿåˆ—æ•°ç»„
  G1CMTaskQueueSet* _task_queues;              // ä»»åŠ¡é˜Ÿåˆ—é›†åˆ
  
  // ==================== ç»ˆæ­¢åè®® ====================
  ParallelTaskTerminator _terminator;          // ç»ˆæ­¢åè®®
  
  // ==================== çŠ¶æ€æ ‡å¿— ====================
  volatile bool _has_overflown;                // å…¨å±€æ ˆæº¢å‡ºæ ‡å¿—
  volatile bool _concurrent;                   // æ˜¯å¦å¤„äºå¹¶å‘æ ‡è®°é˜¶æ®µ
  volatile bool _has_aborted;                  // æ ‡è®°æ˜¯å¦è¢«ä¸­æ­¢
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  G1RegionMarkStats* _region_mark_stats;       // åŒºåŸŸæ ‡è®°ç»Ÿè®¡
  HeapWord* volatile* _top_at_rebuild_starts;  // é‡å»ºRSetæ—¶çš„topæŒ‡é’ˆ
  
  // ==================== è®¡æ—¶å™¨ ====================
  ConcurrentGCTimer* _gc_timer_cm;             // GCè®¡æ—¶å™¨
};
```

### **7.3 G1CMBitMapæ ‡è®°ä½å›¾**

```cpp
class G1CMBitMap : public MarkBitMap {
  // æ¯ä¸ªå¯¹è±¡ç”¨1ä½è¡¨ç¤ºæ˜¯å¦å­˜æ´»
  // ä½å›¾å¤§å° = å †å¤§å° / å¯¹è±¡æœ€å°å¯¹é½ / 8
  // 8GBå †: 8GB / 8B / 8 = 128MB
};
```

### **7.4 å¹¶å‘æ ‡è®°é˜¶æ®µ**

```
G1å¹¶å‘æ ‡è®°é˜¶æ®µ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  é˜¶æ®µ1: åˆå§‹æ ‡è®° (STW)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ ‡è®°GC Rootsç›´æ¥å¯è¾¾çš„å¯¹è±¡                            â”‚   â”‚
â”‚  â”‚ â€¢ è®¾ç½®TAMS (Top At Mark Start)                          â”‚   â”‚
â”‚  â”‚ â€¢ é€šå¸¸ä¸Young GCä¸€èµ·æ‰§è¡Œ                                â”‚   â”‚
â”‚  â”‚ â€¢ è€—æ—¶: ~1-5ms                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  é˜¶æ®µ2: æ ¹åŒºåŸŸæ‰«æ (å¹¶å‘)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ‰«æSurvivoråŒºåŸŸä¸­æŒ‡å‘è€å¹´ä»£çš„å¼•ç”¨                    â”‚   â”‚
â”‚  â”‚ â€¢ å¿…é¡»åœ¨ä¸‹æ¬¡Young GCå‰å®Œæˆ                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  é˜¶æ®µ3: å¹¶å‘æ ‡è®° (å¹¶å‘)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ ä»GC Rootså¼€å§‹ï¼Œéå†å¯¹è±¡å›¾                            â”‚   â”‚
â”‚  â”‚ â€¢ ä½¿ç”¨ä¸‰è‰²æ ‡è®°ç®—æ³•                                      â”‚   â”‚
â”‚  â”‚ â€¢ SATBå¤„ç†å¹¶å‘ä¿®æ”¹                                      â”‚   â”‚
â”‚  â”‚ â€¢ è€—æ—¶: ~100-500ms (å–å†³äºå­˜æ´»å¯¹è±¡æ•°é‡)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  é˜¶æ®µ4: æœ€ç»ˆæ ‡è®° (STW)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å¤„ç†SATBç¼“å†²åŒºä¸­å‰©ä½™çš„å¼•ç”¨                            â”‚   â”‚
â”‚  â”‚ â€¢ å®Œæˆæ ‡è®°                                              â”‚   â”‚
â”‚  â”‚ â€¢ è€—æ—¶: ~1-10ms                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  é˜¶æ®µ5: æ¸…ç† (éƒ¨åˆ†STW)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ ç»Ÿè®¡æ¯ä¸ªRegionçš„å­˜æ´»å¯¹è±¡                              â”‚   â”‚
â”‚  â”‚ â€¢ è¯†åˆ«å®Œå…¨ç©ºé—²çš„Region                                  â”‚   â”‚
â”‚  â”‚ â€¢ é‡ç½®æ ‡è®°æ•°æ®ç»“æ„                                      â”‚   â”‚
â”‚  â”‚ â€¢ è€—æ—¶: ~5-20ms                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **7.5 8GBå †ç¯å¢ƒä¸‹çš„å¹¶å‘æ ‡è®°é…ç½®**

```
å¹¶å‘æ ‡è®°é…ç½® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°                    â”‚ å€¼            â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ‡è®°ä½å›¾å¤§å°            â”‚ 128MB         â”‚ 8GB / 8B / 8          â”‚
â”‚ åŒç¼“å†²ä½å›¾æ€»å¤§å°        â”‚ 256MB         â”‚ 2 * 128MB             â”‚
â”‚ å¹¶å‘æ ‡è®°çº¿ç¨‹æ•°          â”‚ 2             â”‚ ConcGCThreads         â”‚
â”‚ æ ‡è®°æ ˆå¤§å°              â”‚ 4MB           â”‚ MarkStackSize         â”‚
â”‚ SATBç¼“å†²åŒºå¤§å°          â”‚ 256KB         â”‚ æ¯çº¿ç¨‹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **8. G1Policy - G1ç­–ç•¥**

### **8.1 æ¦‚è¿°**

`G1Policy`æ˜¯G1 GCçš„ç­–ç•¥å†³ç­–ç±»ï¼Œå†³å®šä½•æ—¶æ”¶é›†ã€æ”¶é›†å“ªäº›åŒºåŸŸï¼Œæ˜¯G1å®ç°å¯é¢„æµ‹åœé¡¿æ—¶é—´çš„æ ¸å¿ƒã€‚

### **8.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class G1Policy : public CHeapObj<mtGC> {
  // ==================== é¢„æµ‹å™¨ ====================
  G1Predictions _predictor;                    // é¢„æµ‹å™¨
  G1Analytics* _analytics;                     // GCåˆ†ææ•°æ®
  
  // ==================== è·Ÿè¸ªç­–ç•¥ ====================
  G1RemSetTrackingPolicy _remset_tracker;      // RSetè·Ÿè¸ªç­–ç•¥
  G1MMUTracker* _mmu_tracker;                  // MMU(æœ€å°Mutatoråˆ©ç”¨ç‡)è·Ÿè¸ªå™¨
  
  // ==================== åˆ†é…è·Ÿè¸ª ====================
  G1OldGenAllocationTracker _old_gen_alloc_tracker; // è€å¹´ä»£åˆ†é…è·Ÿè¸ª
  
  // ==================== IHOPæ§åˆ¶ ====================
  G1IHOPControl* _ihop_control;                // IHOP(åˆå§‹å †å ç”¨ç™¾åˆ†æ¯”)æ§åˆ¶
  
  // ==================== å¹´è½»ä»£ç®¡ç† ====================
  uint _young_list_target_length;              // å¹´è½»ä»£ç›®æ ‡é•¿åº¦
  uint _young_list_max_length;                 // å¹´è½»ä»£æœ€å¤§é•¿åº¦
  
  // ==================== å­˜æ´»ç‡ç»„ ====================
  SurvRateGroup* _short_lived_surv_rate_group; // çŸ­æœŸå­˜æ´»ç‡ç»„
  SurvRateGroup* _survivor_surv_rate_group;    // Survivorå­˜æ´»ç‡ç»„
  
  // ==================== ä¿ç•™åŒºåŸŸ ====================
  uint _reserve_regions;                       // ä¿ç•™åŒºåŸŸæ•°
  
  // ==================== å¹´è½»ä»£å¤§å°è°ƒæ•´ ====================
  G1YoungGenSizer _young_gen_sizer;            // å¹´è½»ä»£å¤§å°è°ƒæ•´å™¨
  
  // ==================== æ”¶é›†é›†åˆ ====================
  G1CollectionSet* _collection_set;            // æ”¶é›†é›†åˆ
  
  // ==================== å †å¼•ç”¨ ====================
  G1CollectedHeap* _g1h;                       // G1å †å¼•ç”¨
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  G1GCPhaseTimes* _phase_times;                // GCé˜¶æ®µæ—¶é—´ç»Ÿè®¡
  size_t _bytes_copied_during_gc;              // GCæœŸé—´å¤åˆ¶çš„å­—èŠ‚æ•°
  
  // ==================== æ™‹å‡ç®¡ç† ====================
  uint _tenuring_threshold;                    // æ™‹å‡é˜ˆå€¼
  uint _max_survivor_regions;                  // æœ€å¤§SurvivoråŒºåŸŸæ•°
  AgeTable _survivors_age_table;               // Survivorå¹´é¾„è¡¨
};
```

### **8.3 åœé¡¿æ—¶é—´ç›®æ ‡**

```
G1åœé¡¿æ—¶é—´ç›®æ ‡ç®¡ç†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  ç›®æ ‡åœé¡¿æ—¶é—´: MaxGCPauseMillis (é»˜è®¤200ms)                     â”‚
â”‚                                                                 â”‚
â”‚  G1Policyå†³ç­–æµç¨‹:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. é¢„æµ‹æ¯ä¸ªRegionçš„å›æ”¶æ—¶é—´                             â”‚   â”‚
â”‚  â”‚    â€¢ åŸºäºå†å²æ•°æ®                                       â”‚   â”‚
â”‚  â”‚    â€¢ è€ƒè™‘å­˜æ´»å¯¹è±¡æ•°é‡                                   â”‚   â”‚
â”‚  â”‚    â€¢ è€ƒè™‘RSetå¤§å°                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. æŒ‰GCæ•ˆç‡æ’åºRegion                                   â”‚   â”‚
â”‚  â”‚    GCæ•ˆç‡ = å¯å›æ”¶ç©ºé—´ / é¢„æµ‹å›æ”¶æ—¶é—´                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. é€‰æ‹©Regionç›´åˆ°è¾¾åˆ°æ—¶é—´é¢„ç®—                           â”‚   â”‚
â”‚  â”‚    â€¢ ç´¯è®¡é¢„æµ‹æ—¶é—´ < MaxGCPauseMillis                    â”‚   â”‚
â”‚  â”‚    â€¢ ä¼˜å…ˆé€‰æ‹©é«˜æ•ˆç‡Region                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. å½¢æˆCollection Set                                   â”‚   â”‚
â”‚  â”‚    â€¢ æ‰€æœ‰Eden Region (å¿…é¡»)                             â”‚   â”‚
â”‚  â”‚    â€¢ æ‰€æœ‰Survivor Region (å¿…é¡»)                         â”‚   â”‚
â”‚  â”‚    â€¢ é€‰ä¸­çš„Old Region (Mixed GC)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— **9. ReferenceProcessor - å¼•ç”¨å¤„ç†å™¨**

### **9.1 æ¦‚è¿°**

`ReferenceProcessor`å¤„ç†Javaå¼•ç”¨å¯¹è±¡(Soft/Weak/Final/Phantom Reference)ï¼Œæ˜¯GCçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

### **9.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class ReferenceProcessor : public CHeapObj<mtGC> {
  // ==================== æ—¶é’Ÿ ====================
  static jlong _soft_ref_timestamp_clock;      // è½¯å¼•ç”¨ä¸»æ—¶é’Ÿ
  
  // ==================== å‘ç°é…ç½® ====================
  BoolObjectClosure* _is_subject_to_discovery; // åˆ¤æ–­å¯¹è±¡æ˜¯å¦å—æ­¤å¤„ç†å™¨å‘ç°
  bool _discovering_refs;                      // æ˜¯å¦å¯ç”¨å‘ç°
  bool _discovery_is_atomic;                   // å‘ç°æ˜¯å¦åŸå­æ€§
  bool _discovery_is_mt;                       // å‘ç°æ˜¯å¦å¤šçº¿ç¨‹
  
  // ==================== å¤„ç†é…ç½® ====================
  bool _enqueuing_is_done;                     // å…¥é˜Ÿæ˜¯å¦å®Œæˆ
  bool _processing_is_mt;                      // å¤„ç†æ˜¯å¦å¤šçº¿ç¨‹
  
  // ==================== å­˜æ´»åˆ¤æ–­ ====================
  BoolObjectClosure* _is_alive_non_header;     // åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»çš„é—­åŒ…
  
  // ==================== è½¯å¼•ç”¨ç­–ç•¥ ====================
  static ReferencePolicy* _default_soft_ref_policy;      // é»˜è®¤è½¯å¼•ç”¨ç­–ç•¥
  static ReferencePolicy* _always_clear_soft_ref_policy; // "æ¸…é™¤æ‰€æœ‰"ç­–ç•¥
  ReferencePolicy* _current_soft_ref_policy;             // å½“å‰è½¯å¼•ç”¨ç­–ç•¥
  
  // ==================== é˜Ÿåˆ—ç®¡ç† ====================
  uint _num_queues;                            // æ´»è·ƒé˜Ÿåˆ—æ•°
  uint _max_num_queues;                        // æœ€å¤§é˜Ÿåˆ—æ•°
  
  // ==================== å‘ç°çš„å¼•ç”¨ ====================
  DiscoveredList* _discovered_refs;            // å‘ç°çš„å¼•ç”¨ä¸»æ•°ç»„
  DiscoveredList* _discoveredSoftRefs;         // å‘ç°çš„è½¯å¼•ç”¨
  DiscoveredList* _discoveredWeakRefs;         // å‘ç°çš„å¼±å¼•ç”¨
  DiscoveredList* _discoveredFinalRefs;        // å‘ç°çš„Finalå¼•ç”¨
  DiscoveredList* _discoveredPhantomRefs;      // å‘ç°çš„è™šå¼•ç”¨
};
```

### **9.3 å¼•ç”¨ç±»å‹å¤„ç†é¡ºåº**

```
å¼•ç”¨å¤„ç†é¡ºåº:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. è½¯å¼•ç”¨ (SoftReference)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å†…å­˜ä¸è¶³æ—¶æ‰æ¸…é™¤                                      â”‚   â”‚
â”‚  â”‚ â€¢ æ ¹æ®ç­–ç•¥å†³å®šæ˜¯å¦æ¸…é™¤                                  â”‚   â”‚
â”‚  â”‚ â€¢ å¸¸ç”¨äºç¼“å­˜                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  2. å¼±å¼•ç”¨ (WeakReference)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ GCæ—¶æ€»æ˜¯æ¸…é™¤                                          â”‚   â”‚
â”‚  â”‚ â€¢ ä¸å½±å“å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ                                    â”‚   â”‚
â”‚  â”‚ â€¢ å¸¸ç”¨äºWeakHashMap                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  3. Finalå¼•ç”¨ (FinalReference)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æœ‰finalize()æ–¹æ³•çš„å¯¹è±¡                                â”‚   â”‚
â”‚  â”‚ â€¢ éœ€è¦æ‰§è¡Œfinalize()åæ‰èƒ½å›æ”¶                          â”‚   â”‚
â”‚  â”‚ â€¢ ç”±Finalizerçº¿ç¨‹å¤„ç†                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  4. è™šå¼•ç”¨ (PhantomReference)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æœ€å¼±çš„å¼•ç”¨                                            â”‚   â”‚
â”‚  â”‚ â€¢ æ— æ³•é€šè¿‡get()è·å–å¯¹è±¡                                 â”‚   â”‚
â”‚  â”‚ â€¢ ç”¨äºè·Ÿè¸ªå¯¹è±¡å›æ”¶                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¬ **10. DirtyCardQueueSet - è„å¡é˜Ÿåˆ—é›†**

### **10.1 æ¦‚è¿°**

`DirtyCardQueueSet`ç®¡ç†è„å¡é˜Ÿåˆ—ï¼Œç”¨äºè®°å½•éœ€è¦å¤„ç†çš„è„å¡ï¼Œæ˜¯G1å†™å±éšœçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

### **10.2 å…³é”®æˆå‘˜å˜é‡**

```cpp
class DirtyCardQueueSet : public PtrQueueSet {
  // ==================== å…±äº«é˜Ÿåˆ— ====================
  DirtyCardQueue _shared_dirty_card_queue;     // å…±äº«è„å¡é˜Ÿåˆ—
  
  // ==================== IDç®¡ç† ====================
  FreeIdSet* _free_ids;                        // ç©ºé—²IDé›†åˆ
  
  // ==================== ç»Ÿè®¡ä¿¡æ¯ ====================
  jint _processed_buffers_mut;                 // Mutatorå¤„ç†çš„ç¼“å†²åŒºæ•°
  jint _processed_buffers_rs_thread;           // RSçº¿ç¨‹å¤„ç†çš„ç¼“å†²åŒºæ•°
  
  // ==================== å¹¶è¡Œè¿­ä»£ ====================
  BufferNode* volatile _cur_par_buffer_node;   // å½“å‰å¹¶è¡Œè¿­ä»£çš„ç¼“å†²åŒºèŠ‚ç‚¹
};
```

### **10.3 è„å¡å¤„ç†æµç¨‹**

```
è„å¡å¤„ç†æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  1. å†™å±éšœè§¦å‘                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Javaä»£ç : obj.field = newValue;                         â”‚   â”‚
â”‚  â”‚ å†™å±éšœ: mark_card_dirty(card_address);                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  2. è„å¡å…¥é˜Ÿ                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å°†è„å¡åœ°å€åŠ å…¥çº¿ç¨‹æœ¬åœ°DirtyCardQueue                  â”‚   â”‚
â”‚  â”‚ â€¢ ç¼“å†²åŒºæ»¡æ—¶ï¼Œæäº¤åˆ°DirtyCardQueueSet                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  3. å¹¶å‘ç»†åŒ– (G1ConcurrentRefine)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å¹¶å‘ç»†åŒ–çº¿ç¨‹ä»é˜Ÿåˆ—å–å‡ºè„å¡                            â”‚   â”‚
â”‚  â”‚ â€¢ æ‰«æè„å¡å¯¹åº”çš„å†…å­˜åŒºåŸŸ                                â”‚   â”‚
â”‚  â”‚ â€¢ æ›´æ–°ç›®æ ‡Regionçš„RemSet                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  4. GCæ—¶å¤„ç†                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å¤„ç†å‰©ä½™çš„è„å¡                                        â”‚   â”‚
â”‚  â”‚ â€¢ æ‰«æRemSetæ‰¾åˆ°è·¨Regionå¼•ç”¨                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— **11. GCç³»ç»Ÿå¯¹è±¡å…³ç³»å›¾**

```
G1 GCç³»ç»Ÿå¯¹è±¡å…³ç³»å›¾:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                        â”‚  G1CollectedHeap    â”‚                              â”‚
â”‚                        â”‚    (G1å †æ ¸å¿ƒ)       â”‚                              â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                   â”‚                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚     â”‚                             â”‚                             â”‚           â”‚
â”‚     â–¼                             â–¼                             â–¼           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚HeapRegionMgr â”‚          â”‚  G1Policy    â”‚          â”‚G1ConcurrentMarkâ”‚      â”‚
â”‚ â”‚ (åŒºåŸŸç®¡ç†)   â”‚          â”‚  (GCç­–ç•¥)    â”‚          â”‚  (å¹¶å‘æ ‡è®°)   â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚        â”‚                                                    â”‚               â”‚
â”‚        â–¼                                                    â–¼               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ HeapRegion   â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ G1CMBitMap   â”‚        â”‚
â”‚ â”‚ (å †åŒºåŸŸ)     â”‚                                   â”‚ (æ ‡è®°ä½å›¾)   â”‚        â”‚
â”‚ â”‚ â€¢ Eden       â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚ â”‚ â€¢ Survivor   â”‚                                                           â”‚
â”‚ â”‚ â€¢ Old        â”‚                                                           â”‚
â”‚ â”‚ â€¢ Humongous  â”‚                                                           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                           â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â–¼                                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚HeapRegionRemSetâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚  G1RemSet    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ G1CardTable  â”‚       â”‚
â”‚ â”‚ (åŒºåŸŸè®°å¿†é›†) â”‚          â”‚ (è®°å¿†é›†ç®¡ç†) â”‚          â”‚   (å¡è¡¨)     â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                  â”‚                         â”‚               â”‚
â”‚                                  â–¼                         â–¼               â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                          â”‚G1HotCardCacheâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚DirtyCardQueueSetâ”‚     â”‚
â”‚                          â”‚ (çƒ­ç‚¹å¡ç¼“å­˜) â”‚          â”‚ (è„å¡é˜Ÿåˆ—é›†) â”‚        â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                          â”‚ReferenceProcessorâ”‚                               â”‚
â”‚                          â”‚ (å¼•ç”¨å¤„ç†å™¨) â”‚                                   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š **12. 8GBå †ç¯å¢ƒä¸‹çš„GCç³»ç»Ÿç»Ÿè®¡**

### **12.1 å¯¹è±¡æ•°é‡ç»Ÿè®¡**

| å¯¹è±¡ç±»å‹ | å®ä¾‹æ•° | å•ä¸ªå¤§å° | æ€»å†…å­˜ | è¯´æ˜ |
|---------|--------|---------|--------|------|
| **G1CollectedHeap** | 1 | ~8KB | ~8KB | G1å †ç®¡ç†å™¨ |
| **HeapRegionManager** | 1 | ~2KB | ~2KB | åŒºåŸŸç®¡ç†å™¨ |
| **HeapRegion** | 4096 | ~256B | ~1MB | å †åŒºåŸŸ |
| **HeapRegionRemSet** | 4096 | ~64B | ~256KB | åŒºåŸŸè®°å¿†é›† |
| **G1CardTable** | 1 | ~16MB | ~16MB | å¡è¡¨ |
| **G1ConcurrentMark** | 1 | ~4KB | ~4KB | å¹¶å‘æ ‡è®°å™¨ |
| **G1CMBitMap** | 2 | ~128MB | ~256MB | æ ‡è®°ä½å›¾(åŒç¼“å†²) |
| **G1Policy** | 1 | ~2KB | ~2KB | GCç­–ç•¥ |
| **G1RemSet** | 1 | ~1KB | ~1KB | è®°å¿†é›†ç®¡ç†å™¨ |
| **ReferenceProcessor** | 2 | ~1KB | ~2KB | å¼•ç”¨å¤„ç†å™¨ |
| **DirtyCardQueueSet** | 1 | ~1KB | ~1KB | è„å¡é˜Ÿåˆ—é›† |

### **12.2 GCç³»ç»Ÿæ€»å†…å­˜å ç”¨**

```
GCç³»ç»Ÿå†…å­˜å ç”¨ (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»„ä»¶                    â”‚ å†…å­˜å ç”¨      â”‚ å å †æ¯”ä¾‹              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¡è¡¨                    â”‚ 16MB          â”‚ 0.2%                  â”‚
â”‚ æ ‡è®°ä½å›¾(åŒç¼“å†²)        â”‚ 256MB         â”‚ 3.1%                  â”‚
â”‚ HeapRegionå…ƒæ•°æ®        â”‚ ~1MB          â”‚ 0.01%                 â”‚
â”‚ RemSet (ä¼°ç®—)           â”‚ 50-200MB      â”‚ 0.6-2.5%              â”‚
â”‚ å…¶ä»–GCæ•°æ®ç»“æ„          â”‚ ~10MB         â”‚ 0.1%                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ **æ€»è®¡**                â”‚ **~330-480MB**â”‚ **~4-6%**             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **12.3 GCæ€§èƒ½åŸºå‡†**

```
G1 GCæ€§èƒ½åŸºå‡† (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                    â”‚ å…¸å‹å€¼        â”‚ è¯´æ˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Young GCåœé¡¿            â”‚ 10-50ms       â”‚ å–å†³äºEdenå¤§å°        â”‚
â”‚ Mixed GCåœé¡¿            â”‚ 50-200ms      â”‚ å–å†³äºæ”¶é›†Regionæ•°    â”‚
â”‚ å¹¶å‘æ ‡è®°æ—¶é—´            â”‚ 100-500ms     â”‚ å–å†³äºå­˜æ´»å¯¹è±¡æ•°      â”‚
â”‚ Full GCåœé¡¿             â”‚ 1-10s         â”‚ åº”å°½é‡é¿å…            â”‚
â”‚ ç›®æ ‡åœé¡¿æ—¶é—´            â”‚ 200ms         â”‚ MaxGCPauseMillis      â”‚
â”‚ IHOPé˜ˆå€¼                â”‚ 45%           â”‚ è§¦å‘å¹¶å‘æ ‡è®°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ **13. æ€»ç»“**

### **13.1 GCç³»ç»Ÿæ ¸å¿ƒå¯¹è±¡**

1. **G1CollectedHeap**: G1åƒåœ¾æ”¶é›†å™¨çš„æ ¸å¿ƒï¼Œç®¡ç†æ•´ä¸ªJavaå †
2. **HeapRegion**: G1å †çš„åŸºæœ¬å•å…ƒï¼Œå¯ç‹¬ç«‹æ”¶é›†
3. **HeapRegionManager**: ç®¡ç†æ‰€æœ‰HeapRegionçš„ç”Ÿå‘½å‘¨æœŸ
4. **G1CardTable**: å†™å±éšœæ ¸å¿ƒï¼Œè·Ÿè¸ªå †å†…å­˜ä¿®æ”¹
5. **G1RemSet**: è®°å¿†é›†ç®¡ç†ï¼Œè·Ÿè¸ªè·¨Regionå¼•ç”¨
6. **G1ConcurrentMark**: å¹¶å‘æ ‡è®°ï¼Œè¯†åˆ«å­˜æ´»å¯¹è±¡
7. **G1Policy**: GCç­–ç•¥ï¼Œå†³å®šæ”¶é›†è¡Œä¸º
8. **ReferenceProcessor**: å¤„ç†Javaå¼•ç”¨å¯¹è±¡

### **13.2 å…³é”®è®¾è®¡æ€æƒ³**

- **åŸºäºRegion**: å°†å †åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„Regionï¼Œæ”¯æŒå¢é‡æ”¶é›†
- **å¹¶å‘æ ‡è®°**: å¤§éƒ¨åˆ†æ ‡è®°å·¥ä½œä¸åº”ç”¨å¹¶å‘æ‰§è¡Œ
- **å¯é¢„æµ‹åœé¡¿**: é€šè¿‡é€‰æ‹©æ€§æ”¶é›†æ§åˆ¶åœé¡¿æ—¶é—´
- **è®°å¿†é›†**: é¿å…å…¨å †æ‰«æï¼Œæé«˜GCæ•ˆç‡
- **å†™å±éšœ**: ç»´æŠ¤è·¨Regionå¼•ç”¨ä¿¡æ¯

### **13.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®**

```
G1 GCè°ƒä¼˜å»ºè®® (8GBå †):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯                    â”‚ å»ºè®®                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é™ä½åœé¡¿æ—¶é—´            â”‚ å‡å°MaxGCPauseMillis                  â”‚
â”‚ æé«˜ååé‡              â”‚ å¢å¤§MaxGCPauseMillis                  â”‚
â”‚ å‡å°‘Full GC             â”‚ å¢åŠ å †å¤§å°æˆ–è°ƒæ•´IHOP                  â”‚
â”‚ å¤§å¯¹è±¡å¤š                â”‚ å¢å¤§G1HeapRegionSize                  â”‚
â”‚ ç›‘æ§GC                  â”‚ -Xlog:gc*                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
