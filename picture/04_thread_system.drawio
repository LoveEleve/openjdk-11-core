<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="JVM Source Analysis" version="21.0.0" type="device">
  <diagram id="thread-system" name="线程系统">
    <mxGraphModel dx="1600" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="1300" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- 标题 -->
        <mxCell id="title" value="&lt;font style=&quot;font-size: 24px;&quot;&gt;&lt;b&gt;JVM线程系统详解&lt;/b&gt;&lt;/font&gt;&lt;br&gt;源码: thread.hpp, javaThread.hpp, vmThread.hpp, safepoint.hpp" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="550" y="20" width="700" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== JavaThread 结构 ==================== -->
        <mxCell id="jt-title" value="&lt;b&gt;JavaThread (Java线程)&lt;/b&gt;&lt;br&gt;(thread.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="90" width="400" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="javathread" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="130" width="400" height="650" as="geometry" />
        </mxCell>
        
        <!-- 线程标识 -->
        <mxCell id="jt-section1" value="&lt;b&gt;【线程标识】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="140" width="380" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-threadobj" value="&lt;b&gt;_threadObj&lt;/b&gt; : oop&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ java.lang.Thread对象引用&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;Java层Thread和C++层JavaThread的桥梁&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="165" width="380" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-osthread" value="&lt;b&gt;_osthread&lt;/b&gt; : OSThread*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 操作系统线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;包含pthread_t/HANDLE等OS句柄&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="220" width="380" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-tid" value="&lt;b&gt;_tid&lt;/b&gt; : jlong&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;Java线程ID&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="275" width="185" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-priority" value="&lt;b&gt;_priority&lt;/b&gt; : ThreadPriority&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;线程优先级 (1-10)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="275" width="185" height="35" as="geometry" />
        </mxCell>
        
        <!-- 线程状态 -->
        <mxCell id="jt-section2" value="&lt;b&gt;【线程状态】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="315" width="380" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-state" value="&lt;b&gt;_thread_state&lt;/b&gt; : JavaThreadState&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 线程状态 (JVM内部)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;_thread_new / _thread_in_Java / _thread_in_vm / _thread_in_native / _thread_blocked&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="340" width="380" height="55" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-suspend" value="&lt;b&gt;_suspend_flags&lt;/b&gt; : uint32_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;挂起标志&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="400" width="185" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-terminated" value="&lt;b&gt;_terminated&lt;/b&gt; : TerminatedTypes&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;终止状态&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="400" width="185" height="35" as="geometry" />
        </mxCell>
        
        <!-- 栈和帧 -->
        <mxCell id="jt-section3" value="&lt;b&gt;【栈和帧】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="440" width="380" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-anchor" value="&lt;b&gt;_anchor&lt;/b&gt; : JavaFrameAnchor&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 栈帧锚点&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;_last_Java_sp, _last_Java_pc, _last_Java_fp&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;用于栈遍历和GC根扫描&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="465" width="380" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-stack-base" value="&lt;b&gt;_stack_base&lt;/b&gt; : address&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;栈底地址&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="530" width="185" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-stack-size" value="&lt;b&gt;_stack_size&lt;/b&gt; : size_t&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;默认1MB&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="530" width="185" height="35" as="geometry" />
        </mxCell>
        
        <!-- 内存分配 -->
        <mxCell id="jt-section4" value="&lt;b&gt;【内存分配】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="570" width="380" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-tlab" value="&lt;b&gt;_tlab&lt;/b&gt; : ThreadLocalAllocBuffer&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 线程本地分配缓冲区&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;_start, _top, _end, _desired_size&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;无锁快速对象分配&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="595" width="380" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-handle" value="&lt;b&gt;_handle_area&lt;/b&gt; : HandleArea*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;句柄分配区域&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="660" width="185" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-resource" value="&lt;b&gt;_resource_area&lt;/b&gt; : ResourceArea*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;资源分配区域&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="660" width="185" height="35" as="geometry" />
        </mxCell>
        
        <!-- SafePoint -->
        <mxCell id="jt-section5" value="&lt;b&gt;【SafePoint支持】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="700" width="380" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="jt-safepoint" value="&lt;b&gt;_safepoint_state&lt;/b&gt; : ThreadSafepointState*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ SafePoint状态&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;_at_poll_safepoint, _safepoint_safe&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="725" width="380" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== VMThread 结构 ==================== -->
        <mxCell id="vmt-title" value="&lt;b&gt;VMThread (VM线程)&lt;/b&gt;&lt;br&gt;(vmThread.hpp)" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="470" y="90" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="vmthread" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="470" y="130" width="280" height="250" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-vm-thread" value="&lt;b&gt;_vm_thread&lt;/b&gt; : VMThread* (静态)&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 单例VMThread&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;执行所有VM操作&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="140" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-queue" value="&lt;b&gt;_vm_queue&lt;/b&gt; : VMOperationQueue*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ VM操作队列&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;存放待执行的VM_Operation&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="195" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-cur-op" value="&lt;b&gt;_cur_vm_operation&lt;/b&gt; : VM_Operation*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;当前正在执行的操作&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="250" width="260" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-terminated" value="&lt;b&gt;_terminated&lt;/b&gt; : bool&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;是否已终止&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="295" width="125" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-should-term" value="&lt;b&gt;_should_terminate&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;应该终止&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="615" y="295" width="125" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="vmt-ops" value="&lt;b&gt;典型VM_Operation:&lt;/b&gt;&lt;br&gt;VM_GC_Operation (GC)&lt;br&gt;VM_Deoptimize (去优化)&lt;br&gt;VM_ThreadDump (线程转储)&lt;br&gt;VM_PrintThreads (打印线程)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="335" width="260" height="70" as="geometry" />
        </mxCell>
        
        <!-- ==================== SafepointSynchronize 结构 ==================== -->
        <mxCell id="sp-title" value="&lt;b&gt;SafepointSynchronize (安全点)&lt;/b&gt;&lt;br&gt;(safepoint.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="470" y="420" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="safepoint" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="470" y="460" width="280" height="320" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-state" value="&lt;b&gt;_state&lt;/b&gt; : SynchronizeState (静态)&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 安全点状态&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;_not_synchronized / _synchronizing / _synchronized&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="470" width="260" height="55" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-waiting" value="&lt;b&gt;_waiting_to_block&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;等待阻塞的线程数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="530" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-current-op" value="&lt;b&gt;_current_safepoint_operation&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;当前安全点操作&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="570" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-safepoint-counter" value="&lt;b&gt;_safepoint_counter&lt;/b&gt; : uint64_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;安全点计数器&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="610" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-mechanism" value="&lt;b&gt;SafePoint机制:&lt;/b&gt;&lt;br&gt;1. 设置polling page为不可读&lt;br&gt;2. 线程访问时触发SIGSEGV&lt;br&gt;3. 信号处理器让线程阻塞&lt;br&gt;4. 所有线程到达后执行VM操作" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="650" width="260" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="sp-polling" value="&lt;b&gt;Polling位置:&lt;/b&gt;&lt;br&gt;• 方法返回&lt;br&gt;• 循环回边&lt;br&gt;• JNI调用返回" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="480" y="735" width="260" height="40" as="geometry" />
        </mxCell>
        
        <!-- ==================== 服务线程 ==================== -->
        <mxCell id="service-title" value="&lt;b&gt;服务线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="780" y="90" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="service-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="780" y="130" width="280" height="400" as="geometry" />
        </mxCell>
        
        <!-- GC线程 -->
        <mxCell id="gc-threads" value="&lt;b&gt;GC线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="790" y="140" width="260" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="gc-worker" value="&lt;b&gt;GCTaskThread&lt;/b&gt; / &lt;b&gt;G1ParallelGCThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;并行GC工作线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;数量 = ParallelGCThreads (默认CPU核数)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="165" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="gc-conc" value="&lt;b&gt;ConcurrentGCThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;G1ConcurrentMarkThread&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;并发标记线程&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="220" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="gc-refine" value="&lt;b&gt;G1ConcurrentRefineThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;卡表精炼线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;数量 = G1ConcRefinementThreads&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="275" width="260" height="50" as="geometry" />
        </mxCell>
        
        <!-- 编译线程 -->
        <mxCell id="compiler-threads" value="&lt;b&gt;编译线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="790" y="330" width="260" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="c1-thread" value="&lt;b&gt;C1CompilerThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;C1编译器线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;数量 = CICompilerCount / 3&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="355" width="125" height="55" as="geometry" />
        </mxCell>
        
        <mxCell id="c2-thread" value="&lt;b&gt;C2CompilerThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;C2编译器线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;数量 = CICompilerCount * 2/3&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="925" y="355" width="125" height="55" as="geometry" />
        </mxCell>
        
        <!-- 其他服务线程 -->
        <mxCell id="other-threads" value="&lt;b&gt;其他服务线程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="790" y="415" width="260" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="watcher" value="&lt;b&gt;WatcherThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;看门狗线程，周期性任务&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="440" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="service" value="&lt;b&gt;ServiceThread&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;低内存检测、JVMTI事件&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="480" width="260" height="35" as="geometry" />
        </mxCell>
        
        <!-- ==================== Threads 管理类 ==================== -->
        <mxCell id="threads-title" value="&lt;b&gt;Threads (线程管理)&lt;/b&gt;&lt;br&gt;(thread.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="780" y="550" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="threads" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="780" y="590" width="280" height="190" as="geometry" />
        </mxCell>
        
        <mxCell id="t-list" value="&lt;b&gt;_thread_list&lt;/b&gt; : JavaThread* (静态)&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 所有JavaThread链表头&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="600" width="260" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="t-count" value="&lt;b&gt;_number_of_threads&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;线程总数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="645" width="125" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="t-nondaemon" value="&lt;b&gt;_number_of_non_daemon_threads&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;非守护线程数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="925" y="645" width="125" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="t-vmthread" value="&lt;b&gt;_vm_thread&lt;/b&gt; : VMThread*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;VM线程引用&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="685" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="t-methods" value="&lt;b&gt;关键方法:&lt;/b&gt;&lt;br&gt;create_vm() / destroy_vm()&lt;br&gt;add() / remove()&lt;br&gt;threads_do() / oops_do()" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="790" y="725" width="260" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== OSThread 结构 ==================== -->
        <mxCell id="os-title" value="&lt;b&gt;OSThread (OS线程)&lt;/b&gt;&lt;br&gt;(osThread.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="90" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="osthread" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="130" width="280" height="220" as="geometry" />
        </mxCell>
        
        <mxCell id="os-state" value="&lt;b&gt;_state&lt;/b&gt; : ThreadState&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;ALLOCATED/INITIALIZED/RUNNABLE/&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;MONITOR_WAIT/CONDVAR_WAIT/ZOMBIE&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="140" width="260" height="55" as="geometry" />
        </mxCell>
        
        <mxCell id="os-pthread" value="&lt;b&gt;_pthread_id&lt;/b&gt; : pthread_t (Linux)&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ POSIX线程ID&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="200" width="260" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="os-tid" value="&lt;b&gt;_thread_id&lt;/b&gt; : pid_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;LWP ID (gettid)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="245" width="125" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="os-interrupted" value="&lt;b&gt;_interrupted&lt;/b&gt; : bool&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;中断标志&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1235" y="245" width="125" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="os-startproc" value="&lt;b&gt;_start_proc&lt;/b&gt; : OSThreadStartFunc&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;线程启动函数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="290" width="260" height="35" as="geometry" />
        </mxCell>
        
        <!-- ==================== TLAB 详细结构 ==================== -->
        <mxCell id="tlab-title" value="&lt;b&gt;ThreadLocalAllocBuffer (TLAB)&lt;/b&gt;&lt;br&gt;(threadLocalAllocBuffer.hpp)" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="370" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="410" width="280" height="280" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-start" value="&lt;b&gt;_start&lt;/b&gt; : HeapWord*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;TLAB起始地址&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="420" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-top" value="&lt;b&gt;_top&lt;/b&gt; : HeapWord*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 当前分配位置&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;分配时: _top += size&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="460" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-end" value="&lt;b&gt;_end&lt;/b&gt; : HeapWord*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;TLAB结束地址&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="515" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-desired" value="&lt;b&gt;_desired_size&lt;/b&gt; : size_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;期望大小&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;动态调整，默认Eden的1%&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="555" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-refill" value="&lt;b&gt;_refill_waste_limit&lt;/b&gt; : size_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;重填浪费限制&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="610" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="tlab-alloc" value="&lt;b&gt;分配流程:&lt;/b&gt;&lt;br&gt;1. if (_top + size &amp;lt;= _end) { _top += size; return; }&lt;br&gt;2. else 申请新TLAB或走慢速路径" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="650" width="260" height="40" as="geometry" />
        </mxCell>
        
        <!-- ==================== 线程状态转换 ==================== -->
        <mxCell id="state-title" value="&lt;b&gt;线程状态转换&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="710" width="280" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="state-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1090" y="740" width="280" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="st-new" value="_thread_new" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="750" width="80" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="st-java" value="_thread_in_Java" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1190" y="750" width="80" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="st-vm" value="_thread_in_vm" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1280" y="750" width="80" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="st-native" value="_thread_in_native" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1100" y="785" width="80" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="st-blocked" value="_thread_blocked" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1190" y="785" width="80" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="st-note" value="&lt;font color=&quot;#666666&quot;&gt;• _thread_in_Java: 执行Java代码&lt;br&gt;• _thread_in_vm: 执行VM代码&lt;br&gt;• _thread_in_native: 执行JNI&lt;br&gt;• _thread_blocked: 阻塞等待&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="1100" y="815" width="180" height="60" as="geometry" />
        </mxCell>
        
        <!-- 面试要点 -->
        <mxCell id="interview-note" value="&lt;b&gt;面试要点&lt;/b&gt;:&lt;br&gt;1. JavaThread是Java线程的C++表示，_threadObj指向java.lang.Thread&lt;br&gt;2. VMThread是单例，所有需要STW的操作都由它执行&lt;br&gt;3. SafePoint通过polling page机制实现，线程在安全点检查时暂停&lt;br&gt;4. TLAB是线程私有的Eden区，分配只需_top += size，无锁&lt;br&gt;5. _thread_state表示线程当前执行位置，GC时只有_thread_in_Java需要等待&lt;br&gt;6. _anchor保存最后一个Java栈帧，用于栈遍历和GC根扫描" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="800" width="400" height="120" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
