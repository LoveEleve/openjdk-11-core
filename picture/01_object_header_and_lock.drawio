<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="JVM Source Analysis" version="21.0.0" type="device">
  <diagram id="object-header-lock" name="对象头与锁机制">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- 标题 -->
        <mxCell id="title" value="&lt;font style=&quot;font-size: 24px;&quot;&gt;&lt;b&gt;JVM对象头与锁机制详解&lt;/b&gt;&lt;/font&gt;&lt;br&gt;源码: markOop.hpp, oop.hpp, objectMonitor.cpp" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="500" y="20" width="600" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== oopDesc 对象结构 ==================== -->
        <mxCell id="oop-title" value="&lt;b&gt;oopDesc 对象实例结构&lt;/b&gt;&lt;br&gt;(oop.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="90" width="300" height="30" as="geometry" />
        </mxCell>
        
        <!-- oopDesc 主体 -->
        <mxCell id="oopdesc" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="130" width="300" height="280" as="geometry" />
        </mxCell>
        
        <!-- _mark 字段 -->
        <mxCell id="mark-field" value="&lt;b&gt;_mark&lt;/b&gt; : markOop&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;对象头标记字&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;8 bytes (64-bit)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;strokeWidth=2;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="140" width="280" height="60" as="geometry" />
        </mxCell>
        
        <!-- _metadata 字段 -->
        <mxCell id="metadata-field" value="&lt;b&gt;_metadata&lt;/b&gt; : union&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;├─ _klass : Klass* (类型指针)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;└─ _compressed_klass : narrowKlass&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;4 bytes (压缩) / 8 bytes (未压缩)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="210" width="280" height="70" as="geometry" />
        </mxCell>
        
        <!-- 实例数据 -->
        <mxCell id="instance-data" value="&lt;b&gt;实例数据 (Instance Data)&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;对象的成员变量&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;按照分配策略排列(longs/doubles → ints → ...)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;大小由类定义决定&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="290" width="280" height="70" as="geometry" />
        </mxCell>
        
        <!-- 对齐填充 -->
        <mxCell id="padding" value="&lt;b&gt;对齐填充 (Padding)&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;确保对象大小是8字节的倍数&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;0-7 bytes&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="370" width="280" height="30" as="geometry" />
        </mxCell>
        
        <!-- ==================== Mark Word 详细结构 ==================== -->
        <mxCell id="markword-title" value="&lt;b&gt;Mark Word 详细结构 (64-bit)&lt;/b&gt;&lt;br&gt;(markOop.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="90" width="500" height="30" as="geometry" />
        </mxCell>
        
        <!-- Mark Word 无锁状态 -->
        <mxCell id="markword-unlocked" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="130" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="mw-unlocked-label" value="&lt;b&gt;无锁状态&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=right;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="280" y="140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="mw-unused" value="unused&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;25 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=center;" vertex="1" parent="1">
          <mxGeometry x="385" y="135" width="70" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-hashcode" value="&lt;b&gt;hashcode&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;31 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=center;" vertex="1" parent="1">
          <mxGeometry x="460" y="135" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-unused2" value="unused&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;1 bit&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=center;" vertex="1" parent="1">
          <mxGeometry x="585" y="135" width="45" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-age" value="&lt;b&gt;age&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;4 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=center;" vertex="1" parent="1">
          <mxGeometry x="635" y="135" width="55" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-biased" value="biased&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;1 bit&lt;/font&gt;&lt;br&gt;&lt;b&gt;0&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=center;" vertex="1" parent="1">
          <mxGeometry x="695" y="135" width="50" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-lock" value="lock&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;2 bits&lt;/font&gt;&lt;br&gt;&lt;b&gt;01&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="750" y="135" width="50" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-ptr" value="&lt;font color=&quot;#999999&quot;&gt;ptr_to_lock_record&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;62 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=center;" vertex="1" parent="1">
          <mxGeometry x="805" y="135" width="70" height="40" as="geometry" />
        </mxCell>
        
        <!-- Mark Word 偏向锁状态 -->
        <mxCell id="markword-biased" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="190" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="mw-biased-label" value="&lt;b&gt;偏向锁&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=right;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="280" y="200" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="mw-thread" value="&lt;b&gt;thread_id&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;54 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=center;" vertex="1" parent="1">
          <mxGeometry x="385" y="195" width="180" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-epoch" value="&lt;b&gt;epoch&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;2 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="570" y="195" width="60" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-age2" value="&lt;b&gt;age&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;4 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=center;" vertex="1" parent="1">
          <mxGeometry x="635" y="195" width="55" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-biased2" value="biased&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;1 bit&lt;/font&gt;&lt;br&gt;&lt;b&gt;1&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=center;" vertex="1" parent="1">
          <mxGeometry x="695" y="195" width="50" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-lock2" value="lock&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;2 bits&lt;/font&gt;&lt;br&gt;&lt;b&gt;01&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="750" y="195" width="50" height="40" as="geometry" />
        </mxCell>
        
        <!-- Mark Word 轻量级锁状态 -->
        <mxCell id="markword-light" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="250" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="mw-light-label" value="&lt;b&gt;轻量级锁&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=right;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="280" y="260" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="mw-ptr-light" value="&lt;b&gt;ptr_to_lock_record&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;指向栈中Lock Record的指针&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;62 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=center;" vertex="1" parent="1">
          <mxGeometry x="385" y="255" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-lock3" value="lock&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;2 bits&lt;/font&gt;&lt;br&gt;&lt;b&gt;00&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="750" y="255" width="50" height="40" as="geometry" />
        </mxCell>
        
        <!-- Mark Word 重量级锁状态 -->
        <mxCell id="markword-heavy" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="310" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="mw-heavy-label" value="&lt;b&gt;重量级锁&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=right;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="280" y="320" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="mw-ptr-heavy" value="&lt;b&gt;ptr_to_heavyweight_monitor&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;指向ObjectMonitor的指针&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;62 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=center;" vertex="1" parent="1">
          <mxGeometry x="385" y="315" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-lock4" value="lock&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;2 bits&lt;/font&gt;&lt;br&gt;&lt;b&gt;10&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="750" y="315" width="50" height="40" as="geometry" />
        </mxCell>
        
        <!-- Mark Word GC标记状态 -->
        <mxCell id="markword-gc" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="380" y="370" width="500" height="50" as="geometry" />
        </mxCell>
        <mxCell id="mw-gc-label" value="&lt;b&gt;GC标记&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=right;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="280" y="380" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="mw-ptr-gc" value="&lt;b&gt;转发指针 (forwarding pointer)&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;GC复制阶段指向新位置&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;62 bits&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=center;" vertex="1" parent="1">
          <mxGeometry x="385" y="375" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="mw-lock5" value="lock&lt;br&gt;&lt;font color=&quot;#999999&quot;&gt;2 bits&lt;/font&gt;&lt;br&gt;&lt;b&gt;11&lt;/b&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" vertex="1" parent="1">
          <mxGeometry x="750" y="375" width="50" height="40" as="geometry" />
        </mxCell>
        
        <!-- ==================== ObjectMonitor 结构 ==================== -->
        <mxCell id="monitor-title" value="&lt;b&gt;ObjectMonitor 重量级锁结构&lt;/b&gt;&lt;br&gt;(objectMonitor.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="920" y="90" width="300" height="30" as="geometry" />
        </mxCell>
        
        <!-- ObjectMonitor 主体 -->
        <mxCell id="objectmonitor" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="920" y="130" width="300" height="520" as="geometry" />
        </mxCell>
        
        <mxCell id="om-header" value="&lt;b&gt;_header&lt;/b&gt; : markOop&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;保存对象原始的Mark Word&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;用于锁释放时恢复&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="140" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-object" value="&lt;b&gt;_object&lt;/b&gt; : void*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;指向被锁定的对象&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="195" width="280" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="om-owner" value="&lt;b&gt;_owner&lt;/b&gt; : void*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;当前持有锁的线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 核心字段：判断锁归属&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="240" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-recursions" value="&lt;b&gt;_recursions&lt;/b&gt; : intptr_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;重入次数 (可重入锁支持)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;每次重入+1，退出-1&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="295" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-entrylist" value="&lt;b&gt;_EntryList&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;阻塞等待获取锁的线程队列&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 竞争失败的线程在此等待&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="350" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-waitset" value="&lt;b&gt;_WaitSet&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;调用wait()后等待的线程队列&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ notify()从此队列唤醒&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="405" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-cxq" value="&lt;b&gt;_cxq&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;竞争队列 (Contention Queue)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;新来的竞争者先入此队列&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="460" width="280" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-spinfreq" value="&lt;b&gt;_SpinFreq&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;自旋频率&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="515" width="135" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="om-spinduration" value="&lt;b&gt;_SpinDuration&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;自旋持续时间&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1075" y="515" width="135" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="om-count" value="&lt;b&gt;_count&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;等待线程数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="560" width="135" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="om-waiters" value="&lt;b&gt;_waiters&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;waiter数量&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1075" y="560" width="135" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="om-succ" value="&lt;b&gt;_succ&lt;/b&gt; : Thread*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;假定继承者(避免惊群)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="930" y="605" width="280" height="35" as="geometry" />
        </mxCell>
        
        <!-- ==================== 锁升级流程 ==================== -->
        <mxCell id="upgrade-title" value="&lt;b&gt;锁升级流程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="440" width="840" height="30" as="geometry" />
        </mxCell>
        
        <!-- 无锁 -->
        <mxCell id="state-unlocked" value="&lt;b&gt;无锁&lt;/b&gt;&lt;br&gt;lock=01&lt;br&gt;biased=0" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="490" width="100" height="70" as="geometry" />
        </mxCell>
        
        <!-- 偏向锁 -->
        <mxCell id="state-biased" value="&lt;b&gt;偏向锁&lt;/b&gt;&lt;br&gt;lock=01&lt;br&gt;biased=1" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="200" y="490" width="100" height="70" as="geometry" />
        </mxCell>
        
        <!-- 轻量级锁 -->
        <mxCell id="state-light" value="&lt;b&gt;轻量级锁&lt;/b&gt;&lt;br&gt;lock=00" style="ellipse;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="360" y="490" width="100" height="70" as="geometry" />
        </mxCell>
        
        <!-- 重量级锁 -->
        <mxCell id="state-heavy" value="&lt;b&gt;重量级锁&lt;/b&gt;&lt;br&gt;lock=10" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="520" y="490" width="100" height="70" as="geometry" />
        </mxCell>
        
        <!-- 箭头 -->
        <mxCell id="arrow1" value="首次加锁&lt;br&gt;CAS设置thread_id" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="state-unlocked" target="state-biased">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow2" value="其他线程竞争&lt;br&gt;偏向锁撤销" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1" source="state-biased" target="state-light">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow3" value="自旋失败&lt;br&gt;膨胀为Monitor" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#b85450;" edge="1" parent="1" source="state-light" target="state-heavy">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- 关键参数说明 -->
        <mxCell id="params-title" value="&lt;b&gt;关键JVM参数&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="640" y="440" width="240" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="params" value="&lt;div style=&quot;text-align: left;&quot;&gt;&lt;b&gt;-XX:+UseBiasedLocking&lt;/b&gt; (默认开启)&lt;br&gt;&lt;b&gt;-XX:BiasedLockingStartupDelay&lt;/b&gt;=4000ms&lt;br&gt;&lt;b&gt;-XX:BiasedLockingBulkRebiasThreshold&lt;/b&gt;=20&lt;br&gt;&lt;b&gt;-XX:BiasedLockingBulkRevokeThreshold&lt;/b&gt;=40&lt;br&gt;&lt;b&gt;-XX:PreInflateSpin&lt;/b&gt;=10 (膨胀前自旋)&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="640" y="480" width="240" height="100" as="geometry" />
        </mxCell>
        
        <!-- ==================== BasicLock 结构 ==================== -->
        <mxCell id="basiclock-title" value="&lt;b&gt;BasicLock (轻量级锁)&lt;/b&gt;&lt;br&gt;(basicLock.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="590" width="200" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="basiclock" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="630" width="200" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="bl-displaced" value="&lt;b&gt;_displaced_header&lt;/b&gt; : markOop&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;保存对象原始Mark Word&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;解锁时用于CAS恢复&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="640" width="180" height="60" as="geometry" />
        </mxCell>
        
        <!-- ==================== BasicObjectLock 结构 ==================== -->
        <mxCell id="basicobjlock-title" value="&lt;b&gt;BasicObjectLock&lt;/b&gt;&lt;br&gt;(basicLock.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="260" y="590" width="200" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="basicobjlock" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="260" y="630" width="200" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="bol-lock" value="&lt;b&gt;_lock&lt;/b&gt; : BasicLock&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;内嵌的BasicLock&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="270" y="640" width="180" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="bol-obj" value="&lt;b&gt;_obj&lt;/b&gt; : oop&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;指向被锁定的对象&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="270" y="695" width="180" height="45" as="geometry" />
        </mxCell>
        
        <!-- ==================== ObjectWaiter 结构 ==================== -->
        <mxCell id="waiter-title" value="&lt;b&gt;ObjectWaiter&lt;/b&gt;&lt;br&gt;(objectMonitor.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="480" y="590" width="200" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="waiter" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="480" y="630" width="200" height="160" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-next" value="&lt;b&gt;_next&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;链表下一个节点&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="490" y="640" width="180" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-prev" value="&lt;b&gt;_prev&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;链表上一个节点&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="490" y="680" width="180" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-thread" value="&lt;b&gt;_thread&lt;/b&gt; : Thread*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;等待的线程&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="490" y="720" width="180" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-state" value="&lt;b&gt;TState&lt;/b&gt; : TStates&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;TS_RUN/TS_WAIT/TS_ENTER&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="490" y="760" width="180" height="25" as="geometry" />
        </mxCell>
        
        <!-- 连接线 -->
        <mxCell id="conn1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#b85450;dashed=1;" edge="1" parent="1" source="mw-ptr-heavy" target="objectmonitor">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <mxCell id="conn2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6c8ebf;dashed=1;" edge="1" parent="1" source="mw-ptr-light" target="basiclock">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="565" y="430" />
              <mxPoint x="140" y="430" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- 说明框 -->
        <mxCell id="note1" value="&lt;b&gt;面试要点&lt;/b&gt;:&lt;br&gt;1. Mark Word是锁状态的核心&lt;br&gt;2. 偏向锁记录thread_id，无竞争时无CAS&lt;br&gt;3. 轻量级锁通过CAS+自旋避免阻塞&lt;br&gt;4. ObjectMonitor的_EntryList和_WaitSet是重量级锁的核心&lt;br&gt;5. 锁只能升级不能降级(除GC)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="700" y="630" width="280" height="120" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
