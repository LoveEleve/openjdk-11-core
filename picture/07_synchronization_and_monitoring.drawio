<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="JVM Source Analysis" version="21.0.0" type="device">
  <diagram id="sync-monitoring" name="同步与监控">
    <mxGraphModel dx="1600" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1800" pageHeight="1300" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- 标题 -->
        <mxCell id="title" value="&lt;font style=&quot;font-size: 24px;&quot;&gt;&lt;b&gt;JVM同步与监控系统详解&lt;/b&gt;&lt;/font&gt;&lt;br&gt;源码: objectMonitor.hpp, synchronizer.cpp, biasedLocking.cpp, jvmtiExport.hpp" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="550" y="20" width="700" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== 锁升级流程 ==================== -->
        <mxCell id="lock-title" value="&lt;b&gt;synchronized 锁升级流程&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="90" width="750" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="120" width="750" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-none" value="&lt;b&gt;无锁&lt;/b&gt;&lt;br&gt;lock=01&lt;br&gt;biased=0&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;hashCode存储&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="50" y="135" width="100" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-biased" value="&lt;b&gt;偏向锁&lt;/b&gt;&lt;br&gt;lock=01&lt;br&gt;biased=1&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;thread_id+epoch&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="200" y="135" width="110" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-light" value="&lt;b&gt;轻量级锁&lt;/b&gt;&lt;br&gt;lock=00&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;ptr_to_lock_record&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;CAS自旋&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="360" y="135" width="120" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-heavy" value="&lt;b&gt;重量级锁&lt;/b&gt;&lt;br&gt;lock=10&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;ptr_to_monitor&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;OS mutex&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="530" y="135" width="110" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="lock-gc" value="&lt;b&gt;GC标记&lt;/b&gt;&lt;br&gt;lock=11&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;forwarding ptr&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="690" y="135" width="90" height="90" as="geometry" />
        </mxCell>
        
        <mxCell id="arrow-nb" value="首次加锁&lt;br&gt;CAS" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="lock-none" target="lock-biased">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow-bl" value="竞争&lt;br&gt;撤销偏向" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1" source="lock-biased" target="lock-light">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow-lh" value="自旋失败&lt;br&gt;膨胀" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#b85450;" edge="1" parent="1" source="lock-light" target="lock-heavy">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        
        <!-- ==================== ObjectMonitor 结构 ==================== -->
        <mxCell id="om-title" value="&lt;b&gt;ObjectMonitor (重量级锁)&lt;/b&gt;&lt;br&gt;(objectMonitor.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="260" width="350" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="objectmonitor" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="40" y="300" width="350" height="420" as="geometry" />
        </mxCell>
        
        <!-- 核心字段 -->
        <mxCell id="om-section1" value="&lt;b&gt;【核心字段】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="310" width="330" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="om-header" value="&lt;b&gt;_header&lt;/b&gt; : markOop&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 保存对象原始Mark Word&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;解锁时恢复到对象头&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="335" width="330" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-object" value="&lt;b&gt;_object&lt;/b&gt; : void*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;指向被锁定的对象&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="390" width="330" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="om-owner" value="&lt;b&gt;_owner&lt;/b&gt; : void*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 当前持有锁的线程&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;NULL表示锁空闲&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="430" width="330" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-recursions" value="&lt;b&gt;_recursions&lt;/b&gt; : intptr_t&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;重入次数 (可重入锁)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;每次重入+1，退出-1，为0时释放&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="485" width="330" height="50" as="geometry" />
        </mxCell>
        
        <!-- 等待队列 -->
        <mxCell id="om-section2" value="&lt;b&gt;【等待队列】&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="50" y="540" width="330" height="20" as="geometry" />
        </mxCell>
        
        <mxCell id="om-cxq" value="&lt;b&gt;_cxq&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 竞争队列 (Contention Queue)&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;新来的竞争者先入此队列&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="565" width="330" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-entrylist" value="&lt;b&gt;_EntryList&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 阻塞等待队列&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;从cxq迁移过来的等待者&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="620" width="330" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="om-waitset" value="&lt;b&gt;_WaitSet&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ wait()等待队列&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;调用wait()后进入，notify()唤醒&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="50" y="675" width="330" height="50" as="geometry" />
        </mxCell>
        
        <!-- ==================== ObjectWaiter 结构 ==================== -->
        <mxCell id="ow-title" value="&lt;b&gt;ObjectWaiter (等待节点)&lt;/b&gt;&lt;br&gt;(objectMonitor.hpp)" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="420" y="260" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="objectwaiter" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="420" y="300" width="280" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-next" value="&lt;b&gt;_next&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;链表下一个节点&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="310" width="130" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-prev" value="&lt;b&gt;_prev&lt;/b&gt; : ObjectWaiter*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;链表上一个节点&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="570" y="310" width="120" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-thread" value="&lt;b&gt;_thread&lt;/b&gt; : Thread*&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 等待的线程&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="355" width="260" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-event" value="&lt;b&gt;_event&lt;/b&gt; : ParkEvent*&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;park/unpark事件&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="400" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-tstate" value="&lt;b&gt;TState&lt;/b&gt; : TStates&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;TS_RUN / TS_WAIT / TS_ENTER / TS_CXQ&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="440" width="260" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="ow-notified" value="&lt;b&gt;_notified&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;是否被notify&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="485" width="260" height="25" as="geometry" />
        </mxCell>
        
        <!-- ==================== BiasedLocking 结构 ==================== -->
        <mxCell id="bl-title" value="&lt;b&gt;BiasedLocking (偏向锁)&lt;/b&gt;&lt;br&gt;(biasedLocking.hpp)" style="text;html=1;strokeColor=none;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="420" y="520" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="biasedlocking" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="420" y="560" width="280" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="bl-enabled" value="&lt;b&gt;BiasedLockingEnabled&lt;/b&gt; : bool&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;是否启用偏向锁&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;-XX:+UseBiasedLocking (默认开启)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="570" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="bl-delay" value="&lt;b&gt;BiasedLockingStartupDelay&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;启动延迟&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;默认4000ms (JVM启动后4秒才启用)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="625" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="bl-bulk-rebias" value="&lt;b&gt;BiasedLockingBulkRebiasThreshold&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;批量重偏向阈值&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#0066cc&quot;&gt;默认20次撤销后批量重偏向&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="680" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="bl-bulk-revoke" value="&lt;b&gt;BiasedLockingBulkRevokeThreshold&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;默认40次后禁用该类偏向锁&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="430" y="735" width="260" height="25" as="geometry" />
        </mxCell>
        
        <!-- ==================== BasicLock 结构 ==================== -->
        <mxCell id="basic-title" value="&lt;b&gt;BasicLock (轻量级锁)&lt;/b&gt;&lt;br&gt;(basicLock.hpp)" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="730" y="260" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="basiclock" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="730" y="300" width="280" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="basic-displaced" value="&lt;b&gt;_displaced_header&lt;/b&gt; : markOop&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 保存对象原始Mark Word&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;解锁时CAS恢复&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="310" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="basic-note" value="&lt;b&gt;位置:&lt;/b&gt; 存储在线程栈的Lock Record中&lt;br&gt;&lt;b&gt;加锁:&lt;/b&gt; CAS将对象头替换为Lock Record指针" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="365" width="260" height="35" as="geometry" />
        </mxCell>
        
        <!-- ==================== JvmtiExport 结构 ==================== -->
        <mxCell id="jvmti-title" value="&lt;b&gt;JvmtiExport (JVMTI导出)&lt;/b&gt;&lt;br&gt;(jvmtiExport.hpp)" style="text;html=1;strokeColor=none;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="730" y="420" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="jvmtiexport" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="730" y="460" width="280" height="300" as="geometry" />
        </mxCell>
        
        <mxCell id="jvmti-caps" value="&lt;b&gt;_jvmti_capabilities&lt;/b&gt; : JvmtiCapabilities&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;启用的JVMTI能力&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="470" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="jvmti-events" value="&lt;b&gt;启用的事件回调:&lt;/b&gt;&lt;br&gt;• _should_post_class_load&lt;br&gt;• _should_post_class_prepare&lt;br&gt;• _should_post_method_entry&lt;br&gt;• _should_post_method_exit&lt;br&gt;• _should_post_exception&lt;br&gt;• _should_post_breakpoint&lt;br&gt;• _should_post_single_step" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="510" width="260" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="jvmti-methods" value="&lt;b&gt;关键方法:&lt;/b&gt;&lt;br&gt;post_vm_start() - VM启动事件&lt;br&gt;post_class_load() - 类加载事件&lt;br&gt;post_method_entry() - 方法进入&lt;br&gt;post_exception() - 异常事件" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="635" width="260" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="jvmti-note" value="&lt;font color=&quot;#cc0000&quot;&gt;⭐ JVMTI是调试器、Profiler的基础&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="740" y="720" width="260" height="25" as="geometry" />
        </mxCell>
        
        <!-- ==================== ParkEvent 结构 ==================== -->
        <mxCell id="park-title" value="&lt;b&gt;ParkEvent (线程阻塞)&lt;/b&gt;&lt;br&gt;(park.hpp)" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="90" width="280" height="30" as="geometry" />
        </mxCell>
        
        <mxCell id="parkevent" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="130" width="280" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="park-counter" value="&lt;b&gt;_counter&lt;/b&gt; : int&lt;br&gt;&lt;font color=&quot;#cc0000&quot;&gt;⭐ 许可计数&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;0=需要阻塞, &amp;gt;0=可以继续&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="140" width="260" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="park-mutex" value="&lt;b&gt;_mutex&lt;/b&gt; : pthread_mutex_t (Linux)&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;底层互斥锁&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="195" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="park-cond" value="&lt;b&gt;_cond&lt;/b&gt; : pthread_cond_t (Linux)&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;条件变量&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="235" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="park-methods" value="&lt;b&gt;park()&lt;/b&gt; - 阻塞当前线程&lt;br&gt;&lt;b&gt;unpark()&lt;/b&gt; - 唤醒线程" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1050" y="275" width="260" height="40" as="geometry" />
        </mxCell>
        
        <!-- ==================== Monitor 队列流转 ==================== -->
        <mxCell id="flow-title" value="&lt;b&gt;ObjectMonitor 队列流转&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="350" width="280" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="380" width="280" height="200" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-cxq" value="&lt;b&gt;_cxq&lt;/b&gt;&lt;br&gt;竞争队列" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="1050" y="395" width="80" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-entry" value="&lt;b&gt;_EntryList&lt;/b&gt;&lt;br&gt;阻塞队列" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1190" y="395" width="80" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-wait" value="&lt;b&gt;_WaitSet&lt;/b&gt;&lt;br&gt;等待队列" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1120" y="480" width="80" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-owner" value="&lt;b&gt;_owner&lt;/b&gt;&lt;br&gt;持有锁" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1120" y="540" width="80" height="40" as="geometry" />
        </mxCell>
        
        <mxCell id="flow-arr1" value="迁移" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="flow-cxq" target="flow-entry">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="flow-arr2" value="wait()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="flow-owner" target="flow-wait">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1090" y="560" />
              <mxPoint x="1090" y="505" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="flow-arr3" value="notify()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;dashed=1;" edge="1" parent="1" source="flow-wait" target="flow-entry">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1230" y="505" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="flow-arr4" value="获取锁" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;" edge="1" parent="1" source="flow-entry" target="flow-owner">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1230" y="560" />
            </Array>
          </mxGeometry>
        </mxCell>
        
        <!-- ==================== Synchronizer 关键参数 ==================== -->
        <mxCell id="sync-title" value="&lt;b&gt;Synchronizer 关键参数&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="600" width="280" height="25" as="geometry" />
        </mxCell>
        
        <mxCell id="sync-params" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="1040" y="630" width="280" height="160" as="geometry" />
        </mxCell>
        
        <mxCell id="sync-spin" value="&lt;b&gt;-XX:PreInflateSpin&lt;/b&gt;=10&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;膨胀前自旋次数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="640" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sync-spin-count" value="&lt;b&gt;ObjectMonitor::_SpinDuration&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;自旋持续时间 (自适应)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="680" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sync-knob" value="&lt;b&gt;Knob_SpinLimit&lt;/b&gt;=5000&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;最大自旋次数&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="720" width="260" height="35" as="geometry" />
        </mxCell>
        
        <mxCell id="sync-qmode" value="&lt;b&gt;Knob_QMode&lt;/b&gt;=0&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;队列策略 (0=FIFO)&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="760" width="260" height="25" as="geometry" />
        </mxCell>
        
        <!-- 面试要点 -->
        <mxCell id="interview-note" value="&lt;b&gt;面试要点&lt;/b&gt;:&lt;br&gt;1. 锁升级: 无锁→偏向锁→轻量级锁→重量级锁，只能升级不能降级&lt;br&gt;2. 偏向锁: Mark Word存储thread_id，同一线程重入无需CAS&lt;br&gt;3. 轻量级锁: CAS将Mark Word复制到栈上Lock Record，自旋获取&lt;br&gt;4. 重量级锁: 膨胀为ObjectMonitor，_cxq→_EntryList→_owner&lt;br&gt;5. wait/notify: 从_owner进入_WaitSet，notify移到_EntryList&lt;br&gt;6. JVMTI: 调试器、Profiler的基础，通过事件回调实现" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;spacingTop=5;" vertex="1" parent="1">
          <mxGeometry x="40" y="740" width="350" height="130" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
