# ç¬¬3ç« ï¼šç±»åŠ è½½æœºåˆ¶

> **æœ¬ç« ç›®æ ‡**ï¼šç†è§£JVMå¦‚ä½•å°†`.class`æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œè½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ç±»å…ƒæ•°æ®ï¼Œè¿™æ˜¯ä¸€åˆ‡Javaç¨‹åºè¿è¡Œçš„å‰æã€‚

---

## 3.1 ç±»çš„ç”Ÿå‘½å‘¨æœŸ

ä¸€ä¸ªJavaç±»ä»`.class`æ–‡ä»¶åˆ°å¯ç”¨ï¼Œè¦ç»å†å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼ˆ7ä¸ªé˜¶æ®µï¼‰                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  åŠ è½½     â”‚â”€â”€â†’â”‚  éªŒè¯     â”‚â”€â”€â†’â”‚  å‡†å¤‡     â”‚          â”‚
â”‚  â”‚ Loading  â”‚   â”‚Verificationâ”‚  â”‚Preparationâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â†“              â†“              â†“                   â”‚
â”‚  è¯»å–.class     æ£€æŸ¥å­—èŠ‚ç     åˆ†é…é™æ€å˜é‡å†…å­˜           â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  è§£æ     â”‚â”€â”€â†’â”‚  åˆå§‹åŒ–   â”‚â”€â”€â†’â”‚  ä½¿ç”¨     â”‚          â”‚
â”‚  â”‚Resolutionâ”‚   â”‚Initializationâ”‚ â”‚  Using   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â†“              â†“              â†“                   â”‚
â”‚  ç¬¦å·å¼•ç”¨è½¬ç›´æ¥  æ‰§è¡Œ<clinit>    æ­£å¸¸ä½¿ç”¨ç±»              â”‚
â”‚                                                         â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”€â”€â†’â”‚  å¸è½½     â”‚                       â”‚
â”‚                     â”‚ Unloadingâ”‚                       â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                          â†“                              â”‚
â”‚                     ç±»ä¸å†è¢«å¼•ç”¨                         â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‰3ä¸ªé˜¶æ®µï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ï¼‰ç»Ÿç§°ä¸º"é“¾æ¥"ï¼ˆLinkingï¼‰ã€‚**

---

## 3.2 åŠ è½½é˜¶æ®µï¼šä»å­—èŠ‚ç åˆ°å†…å­˜

### 3.2.1 åŠ è½½çš„èŒè´£

åŠ è½½é˜¶æ®µè¦å®Œæˆ3ä»¶äº‹ï¼š

1. **é€šè¿‡ç±»çš„å…¨é™å®šåè·å–äºŒè¿›åˆ¶å­—èŠ‚æµ**
   - ä»`.class`æ–‡ä»¶è¯»å–
   - ä»JAR/WARåŒ…è¯»å–
   - ä»ç½‘ç»œåŠ è½½ï¼ˆAppletï¼‰
   - åŠ¨æ€ç”Ÿæˆï¼ˆåŠ¨æ€ä»£ç†ï¼‰

2. **å°†å­—èŠ‚æµè½¬æ¢ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„**
   - è§£æå­—èŠ‚ç 
   - åˆ›å»º`InstanceKlass`å¯¹è±¡

3. **åœ¨Javaå †ä¸­ç”Ÿæˆ`java.lang.Class`å¯¹è±¡**
   - ä½œä¸ºæ–¹æ³•åŒºæ•°æ®çš„è®¿é—®å…¥å£

### 3.2.2 ç±»åŠ è½½å™¨å±‚æ¬¡ç»“æ„

```cpp
// hotspot/src/share/classfile/classLoader.hpp

ClassLoaderçš„ä¸‰å±‚ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bootstrap ClassLoader (C++å®ç°)   â”‚  â† åŠ è½½æ ¸å¿ƒç±»åº“
â”‚  - rt.jar (java.lang.*)            â”‚     (æ— å¯¹åº”Javaå¯¹è±¡)
â”‚  - ä¸å¯è¢«Javaä»£ç ç›´æ¥å¼•ç”¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Extension (Ext)    â”‚  â† åŠ è½½æ‰©å±•ç±»åº“
        â”‚ ClassLoader        â”‚     (jre/lib/ext/)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Application (App)  â”‚  â† åŠ è½½åº”ç”¨ç±»
        â”‚ ClassLoader        â”‚     (ClassPath)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŒäº²å§”æ´¾æ¨¡å‹**ï¼šå­åŠ è½½å™¨å…ˆå§”æ‰˜çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œçˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥æ‰è‡ªå·±åŠ è½½ã€‚

---

## 3.3 ClassFileParserï¼šå­—èŠ‚ç è§£æå™¨

è¿™æ˜¯ç±»åŠ è½½çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è§£æ`.class`æ–‡ä»¶çš„æ¯ä¸€ä¸ªå­—èŠ‚ã€‚

### 3.3.1 Classæ–‡ä»¶æ ¼å¼å›é¡¾

```
ClassFile {
    u4 magic;                    // é­”æ•°: 0xCAFEBABE
    u2 minor_version;            // æ¬¡ç‰ˆæœ¬å·
    u2 major_version;            // ä¸»ç‰ˆæœ¬å·: Java 11 = 55
    u2 constant_pool_count;      // å¸¸é‡æ± å¤§å°
    cp_info constant_pool[constant_pool_count-1];
    u2 access_flags;             // è®¿é—®æ ‡å¿—: public/final/abstract
    u2 this_class;               // å½“å‰ç±»
    u2 super_class;              // çˆ¶ç±»
    u2 interfaces_count;         // æ¥å£æ•°é‡
    u2 interfaces[interfaces_count];
    u2 fields_count;             // å­—æ®µæ•°é‡
    field_info fields[fields_count];
    u2 methods_count;            // æ–¹æ³•æ•°é‡
    method_info methods[methods_count];
    u2 attributes_count;         // å±æ€§æ•°é‡
    attribute_info attributes[attributes_count];
}
```

### 3.3.2 ClassFileParseræ ¸å¿ƒæ–¹æ³•

```cpp
// hotspot/src/share/classfile/classFileParser.hpp

class ClassFileParser {
 private:
  ClassFileStream* _stream;          // å­—èŠ‚æµ
  Symbol* _requested_name;           // ç±»å
  InstanceKlass* _klass;             // æ­£åœ¨è§£æçš„ç±»
  ConstantPool* _cp;                 // å¸¸é‡æ± 
  
 public:
  // ä¸»è§£æå…¥å£
  InstanceKlass* parseClassFile(Symbol* name,
                                ClassLoaderData* loader_data,
                                Handle protection_domain,
                                TRAPS);
  
 private:
  // è§£æå„ä¸ªéƒ¨åˆ†
  void parse_constant_pool(TRAPS);        // å¸¸é‡æ± 
  void parse_interfaces(TRAPS);           // æ¥å£
  void parse_fields(TRAPS);               // å­—æ®µ
  void parse_methods(TRAPS);              // æ–¹æ³•
  void parse_classfile_attributes(TRAPS); // ç±»å±æ€§
  
  // å­—æ®µå¸ƒå±€
  void layout_fields(InstanceKlass* ik, TRAPS);
};
```

### 3.3.3 è§£ææµç¨‹è¯¦è§£

```cpp
// hotspot/src/share/classfile/classFileParser.cpp

InstanceKlass* ClassFileParser::parseClassFile(
    Symbol* name,
    ClassLoaderData* loader_data,
    Handle protection_domain,
    TRAPS) {
  
  // ã€æ­¥éª¤1ã€‘æ£€æŸ¥é­”æ•°
  u4 magic = _stream->get_u4_fast();
  guarantee(magic == 0xCAFEBABE, "Invalid magic number");
  
  // ã€æ­¥éª¤2ã€‘æ£€æŸ¥ç‰ˆæœ¬å·
  u2 minor_version = _stream->get_u2_fast();
  u2 major_version = _stream->get_u2_fast();
  
  // Java 11 = 55.0
  if (major_version > JAVA_11_VERSION) {
    THROW_MSG_(vmSymbols::java_lang_UnsupportedClassVersionError(),
               "Unsupported class file version", NULL);
  }
  
  // ã€æ­¥éª¤3ã€‘è§£æå¸¸é‡æ± 
  _cp = parse_constant_pool(CHECK_NULL);
  
  // ã€æ­¥éª¤4ã€‘è¯»å–è®¿é—®æ ‡å¿—
  AccessFlags access_flags;
  jint flags = _stream->get_u2_fast() & JVM_RECOGNIZED_CLASS_MODIFIERS;
  access_flags.set_flags(flags);
  
  // ã€æ­¥éª¤5ã€‘è¯»å–ç±»åã€çˆ¶ç±»å
  u2 this_class_index = _stream->get_u2_fast();
  Symbol* class_name = _cp->klass_name_at(this_class_index);
  
  u2 super_class_index = _stream->get_u2_fast();
  InstanceKlass* super_klass = NULL;
  if (super_class_index != 0) {
    super_klass = parse_super_class(super_class_index, CHECK_NULL);
  }
  
  // ã€æ­¥éª¤6ã€‘è§£ææ¥å£
  Array<Klass*>* local_interfaces = parse_interfaces(CHECK_NULL);
  
  // ã€æ­¥éª¤7ã€‘è§£æå­—æ®µ
  Array<u2>* fields = parse_fields(class_name, CHECK_NULL);
  
  // ã€æ­¥éª¤8ã€‘è§£ææ–¹æ³•
  Array<Method*>* methods = parse_methods(CHECK_NULL);
  
  // ã€æ­¥éª¤9ã€‘åˆ›å»ºInstanceKlasså¯¹è±¡
  _klass = InstanceKlass::allocate_instance_klass(loader_data,
                                                   vtable_size,
                                                   itable_size,
                                                   CHECK_NULL);
  
  // ã€æ­¥éª¤10ã€‘è®¾ç½®å„ç§å±æ€§
  _klass->set_name(class_name);
  _klass->set_super(super_klass);
  _klass->set_fields(fields);
  _klass->set_methods(methods);
  _klass->set_local_interfaces(local_interfaces);
  _klass->set_constants(_cp);
  
  // ã€æ­¥éª¤11ã€‘è®¡ç®—å­—æ®µåç§»é‡ï¼ˆå†…å­˜å¸ƒå±€ï¼‰
  layout_fields(_klass, CHECK_NULL);
  
  // ã€æ­¥éª¤12ã€‘è§£æç±»å±æ€§ï¼ˆå¦‚æ³¨è§£ã€InnerClassesç­‰ï¼‰
  parse_classfile_attributes(CHECK_NULL);
  
  return _klass;
}
```

---

## 3.4 å¸¸é‡æ± è§£æ

å¸¸é‡æ± æ˜¯Classæ–‡ä»¶ä¸­æœ€å¤æ‚çš„ç»“æ„ï¼ŒåŒ…å«äº†ç±»çš„æ‰€æœ‰ç¬¦å·å¼•ç”¨ã€‚

### 3.4.1 å¸¸é‡æ± ç±»å‹

```cpp
// hotspot/src/share/classfile/constantPool.hpp

enum ConstantPoolTag {
  JVM_CONSTANT_Utf8               = 1,   // UTF-8å­—ç¬¦ä¸²
  JVM_CONSTANT_Integer            = 3,   // æ•´æ•°
  JVM_CONSTANT_Float              = 4,   // æµ®ç‚¹æ•°
  JVM_CONSTANT_Long               = 5,   // é•¿æ•´æ•°
  JVM_CONSTANT_Double             = 6,   // åŒç²¾åº¦æµ®ç‚¹
  JVM_CONSTANT_Class              = 7,   // ç±»å¼•ç”¨
  JVM_CONSTANT_String             = 8,   // å­—ç¬¦ä¸²å¼•ç”¨
  JVM_CONSTANT_Fieldref           = 9,   // å­—æ®µå¼•ç”¨
  JVM_CONSTANT_Methodref          = 10,  // æ–¹æ³•å¼•ç”¨
  JVM_CONSTANT_InterfaceMethodref = 11,  // æ¥å£æ–¹æ³•å¼•ç”¨
  JVM_CONSTANT_NameAndType        = 12,  // åç§°å’Œç±»å‹
  JVM_CONSTANT_MethodHandle       = 15,  // æ–¹æ³•å¥æŸ„
  JVM_CONSTANT_MethodType         = 16,  // æ–¹æ³•ç±»å‹
  JVM_CONSTANT_Dynamic            = 17,  // åŠ¨æ€å¸¸é‡
  JVM_CONSTANT_InvokeDynamic      = 18,  // invokedynamic
  JVM_CONSTANT_Module             = 19,  // æ¨¡å—ï¼ˆJava 9+ï¼‰
  JVM_CONSTANT_Package            = 20,  // åŒ…ï¼ˆJava 9+ï¼‰
};
```

### 3.4.2 ConstantPoolæ•°æ®ç»“æ„

```cpp
// hotspot/src/share/oops/constantPool.hpp

class ConstantPool : public Metadata {
 private:
  int _length;                        // å¸¸é‡æ± å¤§å°
  InstanceKlass* _pool_holder;        // æ‰€å±çš„ç±»
  Array<u1>* _tags;                   // æ¯ä¸ªæ¡ç›®çš„ç±»å‹
  
  // å¸¸é‡æ± æ•°æ®ï¼ˆç´§è·Ÿåœ¨å¯¹è±¡å¤´ä¹‹åï¼‰
  // u2 _indices[_length];            // ç´¢å¼•æ•°æ®
  // intptr_t _data[_length];         // å®é™…æ•°æ®
  
 public:
  // è·å–ç±»å¼•ç”¨
  Klass* klass_at(int which, TRAPS) {
    CPKlassSlot kslot = klass_slot_at(which);
    return klass_at_impl(kslot, CHECK_NULL);
  }
  
  // è·å–å­—ç¬¦ä¸²
  oop string_at(int which, TRAPS) {
    return resolve_constant_at_impl(which, CHECK_NULL);
  }
  
  // è·å–æ–¹æ³•å¼•ç”¨
  Method* method_at_if_loaded(const constantPoolHandle& cpool, int which);
};
```

### 3.4.3 å¸¸é‡æ± è§£æç¤ºä¾‹

```cpp
void ClassFileParser::parse_constant_pool(TRAPS) {
  u2 length = _stream->get_u2_fast();
  
  // åˆ›å»ºConstantPoolå¯¹è±¡
  _cp = ConstantPool::allocate(_loader_data, length, CHECK);
  
  // è§£ææ¯ä¸ªå¸¸é‡æ± æ¡ç›®
  for (int index = 1; index < length; index++) {
    u1 tag = _stream->get_u1_fast();
    
    switch (tag) {
      case JVM_CONSTANT_Utf8: {
        u2 utf8_length = _stream->get_u2_fast();
        u1* utf8_buffer = _stream->get_u1_buffer();
        Symbol* sym = SymbolTable::new_symbol((char*)utf8_buffer, 
                                              utf8_length, CHECK);
        _cp->symbol_at_put(index, sym);
        break;
      }
      
      case JVM_CONSTANT_Class: {
        u2 name_index = _stream->get_u2_fast();
        _cp->klass_index_at_put(index, name_index);
        break;
      }
      
      case JVM_CONSTANT_Fieldref: {
        u2 class_index = _stream->get_u2_fast();
        u2 name_and_type_index = _stream->get_u2_fast();
        _cp->field_at_put(index, class_index, name_and_type_index);
        break;
      }
      
      // ... å…¶ä»–ç±»å‹
    }
  }
}
```

---

## 3.5 å­—æ®µå¸ƒå±€ï¼šField Layout

JVMéœ€è¦å†³å®šæ¯ä¸ªå­—æ®µåœ¨å¯¹è±¡ä¸­çš„åç§»é‡ï¼ˆoffsetï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå­—æ®µå¸ƒå±€ã€‚

### 3.5.1 å­—æ®µæ’åˆ—åŸåˆ™

```cpp
// hotspot/src/share/classfile/classFileParser.cpp

void ClassFileParser::layout_fields(InstanceKlass* ik, TRAPS) {
  // å­—æ®µæ’åˆ—é¡ºåºï¼ˆä¼˜åŒ–å†…å­˜å¯¹é½ï¼‰ï¼š
  // 1. oopå¼•ç”¨å­—æ®µï¼ˆ8å­—èŠ‚å¯¹é½ï¼‰
  // 2. long/doubleå­—æ®µï¼ˆ8å­—èŠ‚ï¼‰
  // 3. intå­—æ®µï¼ˆ4å­—èŠ‚ï¼‰
  // 4. short/charå­—æ®µï¼ˆ2å­—èŠ‚ï¼‰
  // 5. byte/booleanå­—æ®µï¼ˆ1å­—èŠ‚ï¼‰
  
  // JVMä¼šè‡ªåŠ¨é‡æ’åºå­—æ®µä»¥å‡å°‘å†…å­˜æµªè´¹
  // ï¼ˆé™¤éä½¿ç”¨@Contendedæ³¨è§£ï¼‰
}
```

### 3.5.2 å­—æ®µå¸ƒå±€ç¤ºä¾‹

```java
class Example {
    boolean flag;   // 1å­—èŠ‚
    int id;         // 4å­—èŠ‚
    long timestamp; // 8å­—èŠ‚
    Object obj;     // 8å­—èŠ‚ï¼ˆå¼•ç”¨ï¼‰
}
```

**å®é™…å†…å­˜å¸ƒå±€**ï¼ˆJVMå¯èƒ½é‡æ’åºï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹è±¡å¤´ (12å­—èŠ‚)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Object obj (8å­—èŠ‚)     â”‚  â† å¼•ç”¨å­—æ®µä¼˜å…ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ long timestamp (8å­—èŠ‚) â”‚  â† 8å­—èŠ‚å­—æ®µ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int id (4å­—èŠ‚)         â”‚  â† 4å­—èŠ‚å­—æ®µ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ boolean flag (1å­—èŠ‚)   â”‚  â† 1å­—èŠ‚å­—æ®µ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹é½å¡«å…… (3å­—èŠ‚)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»å¤§å°: 40å­—èŠ‚
```

**ä¸ºä»€ä¹ˆé‡æ’åºï¼Ÿ**
- å‡å°‘å†…å­˜ç©ºæ´
- ä¼˜åŒ–CPUç¼“å­˜è¡Œè®¿é—®
- æé«˜å†…å­˜åˆ©ç”¨ç‡

---

## 3.6 éªŒè¯é˜¶æ®µï¼šå®‰å…¨æ£€æŸ¥

éªŒè¯é˜¶æ®µç¡®ä¿åŠ è½½çš„ç±»ç¬¦åˆJVMè§„èŒƒï¼Œé˜²æ­¢æ¶æ„ä»£ç ã€‚

### 3.6.1 éªŒè¯çš„å››ä¸ªæ­¥éª¤

```
1. æ–‡ä»¶æ ¼å¼éªŒè¯
   - é­”æ•° = 0xCAFEBABE
   - ç‰ˆæœ¬å·åˆæ³•
   - å¸¸é‡æ± åˆæ³•

2. å…ƒæ•°æ®éªŒè¯
   - æ˜¯å¦æœ‰çˆ¶ç±»ï¼ˆé™¤Objectå¤–ï¼‰
   - çˆ¶ç±»æ˜¯å¦å¯ç»§æ‰¿ï¼ˆéfinalï¼‰
   - æ¥å£æ˜¯å¦æ­£ç¡®å®ç°

3. å­—èŠ‚ç éªŒè¯ï¼ˆæœ€å¤æ‚ï¼‰
   - æ•°æ®æµåˆ†æ
   - ç±»å‹æ£€æŸ¥
   - è·³è½¬ç›®æ ‡åˆæ³•

4. ç¬¦å·å¼•ç”¨éªŒè¯
   - ç±»/æ–¹æ³•/å­—æ®µæ˜¯å¦å­˜åœ¨
   - è®¿é—®æƒé™æ˜¯å¦åˆæ³•
```

### 3.6.2 å­—èŠ‚ç éªŒè¯å™¨

```cpp
// hotspot/src/share/classfile/verifier.cpp

class ClassVerifier {
 private:
  InstanceKlass* _klass;
  
 public:
  // éªŒè¯å…¥å£
  static void verify(InstanceKlass* klass, TRAPS) {
    ClassVerifier verifier(klass);
    verifier.verify_class(CHECK);
  }
  
  // éªŒè¯æ¯ä¸ªæ–¹æ³•çš„å­—èŠ‚ç 
  void verify_method(const methodHandle& method, TRAPS) {
    // æ„å»ºæ§åˆ¶æµå›¾
    // æ¨¡æ‹Ÿæ‰§è¡Œå­—èŠ‚ç 
    // æ£€æŸ¥ç±»å‹å®‰å…¨
    // æ£€æŸ¥å¼‚å¸¸å¤„ç†å™¨
  }
};
```

### 3.6.3 ç±»å‹æ¨å¯¼ç¤ºä¾‹

```java
void example(Object obj) {
    String str = (String) obj;  // éœ€è¦éªŒè¯
    str.length();               // éœ€è¦éªŒè¯strä¸ä¸ºnull
}
```

**éªŒè¯å™¨çš„å·¥ä½œ**ï¼š
```
1. objçš„ç±»å‹: Object
2. checkcastæŒ‡ä»¤éªŒè¯: objæ˜¯å¦å¯ä»¥è½¬æ¢ä¸ºString
3. èµ‹å€¼ç»™str: strçš„ç±»å‹æ ‡è®°ä¸ºString
4. invokevirtual: éªŒè¯Stringæœ‰length()æ–¹æ³•
```

---

## 3.7 å‡†å¤‡é˜¶æ®µï¼šåˆ†é…å†…å­˜ä¸åˆå§‹åŒ–

å‡†å¤‡é˜¶æ®µä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®é»˜è®¤å€¼ã€‚

### 3.7.1 é™æ€å˜é‡çš„å‡†å¤‡

```java
class Example {
    private static int count = 100;        // å‡†å¤‡é˜¶æ®µ: count=0
    private static final int MAX = 200;    // å‡†å¤‡é˜¶æ®µ: MAX=200
}
```

**è§„åˆ™**ï¼š
- **æ™®é€šé™æ€å˜é‡**ï¼šåˆ†é…å†…å­˜ï¼Œè®¾ç½®é›¶å€¼ï¼ˆ0/false/nullï¼‰
- **finalé™æ€å¸¸é‡**ï¼šç›´æ¥è®¾ç½®ä¸ºå¸¸é‡å€¼ï¼ˆåœ¨å¸¸é‡æ± ä¸­ï¼‰

### 3.7.2 æºç å®ç°

```cpp
// hotspot/src/share/oops/instanceKlass.cpp

void InstanceKlass::initialize_static_field(fieldDescriptor* fd, TRAPS) {
  // è·å–å­—æ®µç±»å‹
  BasicType type = fd->field_type();
  
  // åˆ†é…å†…å­˜å¹¶è®¾ç½®é›¶å€¼
  switch (type) {
    case T_BOOLEAN: java_mirror()->bool_field_put(offset, false); break;
    case T_BYTE:    java_mirror()->byte_field_put(offset, 0); break;
    case T_CHAR:    java_mirror()->char_field_put(offset, 0); break;
    case T_SHORT:   java_mirror()->short_field_put(offset, 0); break;
    case T_INT:     java_mirror()->int_field_put(offset, 0); break;
    case T_LONG:    java_mirror()->long_field_put(offset, 0L); break;
    case T_FLOAT:   java_mirror()->float_field_put(offset, 0.0f); break;
    case T_DOUBLE:  java_mirror()->double_field_put(offset, 0.0); break;
    case T_OBJECT:  java_mirror()->obj_field_put(offset, NULL); break;
  }
}
```

---

## 3.8 è§£æé˜¶æ®µï¼šç¬¦å·å¼•ç”¨è½¬æ¢

è§£æé˜¶æ®µå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆå†…å­˜åœ°å€ï¼‰ã€‚

### 3.8.1 ç¬¦å·å¼•ç”¨ vs ç›´æ¥å¼•ç”¨

**ç¬¦å·å¼•ç”¨**ï¼ˆSymbolic Referenceï¼‰ï¼š
```
å­—æ®µå¼•ç”¨: java/lang/System.out:Ljava/io/PrintStream;
æ–¹æ³•å¼•ç”¨: java/lang/String.length:()I
ç±»å¼•ç”¨:   java/util/ArrayList
```

**ç›´æ¥å¼•ç”¨**ï¼ˆDirect Referenceï¼‰ï¼š
```
å­—æ®µå¼•ç”¨ â†’ å­—æ®µçš„å†…å­˜åç§»é‡ï¼ˆoffsetï¼‰
æ–¹æ³•å¼•ç”¨ â†’ æ–¹æ³•çš„å…¥å£åœ°å€ï¼ˆMethod*ï¼‰
ç±»å¼•ç”¨   â†’ ç±»çš„å…ƒæ•°æ®æŒ‡é’ˆï¼ˆKlass*ï¼‰
```

### 3.8.2 è§£ææ—¶æœº

JVMé‡‡ç”¨**å»¶è¿Ÿè§£æ**ï¼ˆLazy Resolutionï¼‰ï¼š
- é¦–æ¬¡ä½¿ç”¨æ—¶æ‰è§£æ
- è§£æç»“æœç¼“å­˜åˆ°å¸¸é‡æ± 
- å†æ¬¡ä½¿ç”¨ç›´æ¥ä»ç¼“å­˜è¯»å–

```cpp
// hotspot/src/share/interpreter/linkResolver.cpp

void LinkResolver::resolve_field(FieldAccessInfo& result,
                                 const constantPoolHandle& pool,
                                 int index, TRAPS) {
  // 1. æ£€æŸ¥å¸¸é‡æ± ç¼“å­˜
  if (pool->is_resolved(index)) {
    result = pool->resolved_field_entry_at(index);
    return;
  }
  
  // 2. è§£æç¬¦å·å¼•ç”¨
  Symbol* field_name = pool->name_ref_at(index);
  Symbol* signature = pool->signature_ref_at(index);
  Klass* klass = pool->klass_ref_at(index, CHECK);
  
  // 3. æŸ¥æ‰¾å­—æ®µ
  fieldDescriptor fd;
  InstanceKlass::cast(klass)->find_field(field_name, signature, &fd);
  
  // 4. ç¼“å­˜è§£æç»“æœ
  pool->cache_field(index, fd.offset(), fd.access_flags());
}
```

---

## 3.9 åˆå§‹åŒ–é˜¶æ®µï¼šæ‰§è¡Œ`<clinit>`

åˆå§‹åŒ–æ˜¯ç±»åŠ è½½çš„æœ€åä¸€æ­¥ï¼Œæ‰§è¡Œ`<clinit>`æ–¹æ³•ï¼ˆç±»æ„é€ å™¨ï¼‰ã€‚

### 3.9.1 `<clinit>`çš„ç”Ÿæˆ

ç¼–è¯‘å™¨ä¼šæ”¶é›†ï¼š
1. é™æ€å˜é‡çš„èµ‹å€¼è¯­å¥
2. é™æ€ä»£ç å—

æŒ‰é¡ºåºç»„åˆæˆ`<clinit>`æ–¹æ³•ã€‚

```java
class Example {
    private static int a = 10;         // â‘ 
    
    static {                           // â‘¡
        b = 20;
    }
    
    private static int b = 30;         // â‘¢
    
    // ç¼–è¯‘åç”Ÿæˆçš„<clinit>æ–¹æ³•ï¼š
    // static void <clinit>() {
    //     a = 10;    // â‘ 
    //     b = 20;    // â‘¡
    //     b = 30;    // â‘¢  è¦†ç›–å‰é¢çš„èµ‹å€¼ï¼
    // }
}
```

**æ³¨æ„**ï¼šæœ€ç»ˆ`b`çš„å€¼æ˜¯30ï¼Œä¸æ˜¯20ï¼

### 3.9.2 åˆå§‹åŒ–è§¦å‘æ—¶æœº

**å…­ç§æƒ…å†µä¼šè§¦å‘ç±»åˆå§‹åŒ–**ï¼š

1. **åˆ›å»ºç±»çš„å®ä¾‹**
   ```java
   new Example();
   ```

2. **è®¿é—®ç±»çš„é™æ€å˜é‡**ï¼ˆéfinalï¼‰
   ```java
   System.out.println(Example.count);
   ```

3. **è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•**
   ```java
   Example.staticMethod();
   ```

4. **åå°„è°ƒç”¨**
   ```java
   Class.forName("Example");
   ```

5. **åˆå§‹åŒ–å­ç±»æ—¶ï¼Œçˆ¶ç±»æœªåˆå§‹åŒ–**
   ```java
   new ChildClass();  // å…ˆåˆå§‹åŒ–çˆ¶ç±»
   ```

6. **å¯åŠ¨ç±»ï¼ˆmainæ–¹æ³•æ‰€åœ¨ç±»ï¼‰**
   ```java
   java Example
   ```

### 3.9.3 åˆå§‹åŒ–çš„æºç å®ç°

```cpp
// hotspot/src/share/oops/instanceKlass.cpp

void InstanceKlass::initialize(TRAPS) {
  // 1. åŠ é”ï¼ˆç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡ï¼‰
  ObjectLocker ol(this_mirror, THREAD);
  
  // 2. æ£€æŸ¥çŠ¶æ€
  if (is_initialized()) return;
  if (is_being_initialized() && thread == initializing_thread()) {
    return;  // é€’å½’åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
  }
  
  // 3. åˆå§‹åŒ–çˆ¶ç±»
  InstanceKlass* super = superklass();
  if (super != NULL && !super->is_initialized()) {
    super->initialize(CHECK);
  }
  
  // 4. åˆå§‹åŒ–æ¥å£ï¼ˆJava 8+çš„é»˜è®¤æ–¹æ³•ï¼‰
  initialize_super_interfaces(CHECK);
  
  // 5. è®¾ç½®çŠ¶æ€ä¸º"æ­£åœ¨åˆå§‹åŒ–"
  set_initialization_state_and_notify(being_initialized, CHECK);
  set_initializing_thread(THREAD);
  
  // 6. æ‰§è¡Œ<clinit>æ–¹æ³•
  Method* clinit = find_class_initializer();
  if (clinit != NULL) {
    JavaValue result(T_VOID);
    JavaCalls::call(&result, clinit, CHECK);
  }
  
  // 7. è®¾ç½®çŠ¶æ€ä¸º"å·²åˆå§‹åŒ–"
  set_initialization_state_and_notify(fully_initialized, CHECK);
}
```

### 3.9.4 åˆå§‹åŒ–çš„çº¿ç¨‹å®‰å…¨

JVMä¿è¯**å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç±»åªåˆå§‹åŒ–ä¸€æ¬¡**ï¼š

```java
// çº¿ç¨‹1å’Œçº¿ç¨‹2åŒæ—¶åˆå§‹åŒ–Exampleç±»
Thread t1 = new Thread(() -> new Example());
Thread t2 = new Thread(() -> new Example());
t1.start();
t2.start();

// ç»“æœï¼š<clinit>åªæ‰§è¡Œä¸€æ¬¡ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…
```

**å®ç°æœºåˆ¶**ï¼š
- ä½¿ç”¨`ObjectLocker`å¯¹Classå¯¹è±¡åŠ é”
- ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ`<clinit>`
- å…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…
- åˆå§‹åŒ–å®Œæˆåå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹

---

## 3.10 SystemDictionaryï¼šç±»å­—å…¸

JVMä½¿ç”¨`SystemDictionary`ç®¡ç†æ‰€æœ‰å·²åŠ è½½çš„ç±»ï¼Œç±»ä¼¼ä¸€ä¸ªå…¨å±€çš„ç±»æ³¨å†Œè¡¨ã€‚

### 3.10.1 SystemDictionaryçš„ç»“æ„

```cpp
// hotspot/src/share/classfile/systemDictionary.hpp

class SystemDictionary : AllStatic {
 private:
  // ç±»å­—å…¸å“ˆå¸Œè¡¨
  static Dictionary* _dictionary;
  
  // çŸ¥åç±»ï¼ˆé¢„åŠ è½½çš„æ ¸å¿ƒç±»ï¼‰
  static InstanceKlass* _well_known_klasses[WK_KLASS_ENUM_COUNT];
  
 public:
  // åŠ è½½ç±»ï¼ˆä¸»å…¥å£ï¼‰
  static Klass* resolve_or_fail(Symbol* class_name,
                                Handle class_loader,
                                Handle protection_domain,
                                bool throw_error, TRAPS);
  
  // æ³¨å†Œå·²åŠ è½½çš„ç±»
  static void add_klass(Symbol* class_name, Klass* k);
  
  // æŸ¥æ‰¾å·²åŠ è½½çš„ç±»
  static Klass* find(Symbol* class_name,
                    Handle class_loader,
                    Handle protection_domain, TRAPS);
};
```

### 3.10.2 çŸ¥åç±»ï¼ˆWell-Known Classesï¼‰

JVMå¯åŠ¨æ—¶é¢„åŠ è½½çš„æ ¸å¿ƒç±»ï¼š

```cpp
// hotspot/src/share/classfile/vmSymbols.hpp

enum WellKnownClasses {
  WK_KLASS_ENUM_NAME(Object_klass),               // java.lang.Object
  WK_KLASS_ENUM_NAME(String_klass),               // java.lang.String
  WK_KLASS_ENUM_NAME(Class_klass),                // java.lang.Class
  WK_KLASS_ENUM_NAME(Cloneable_klass),            // java.lang.Cloneable
  WK_KLASS_ENUM_NAME(ClassLoader_klass),          // java.lang.ClassLoader
  WK_KLASS_ENUM_NAME(Thread_klass),               // java.lang.Thread
  WK_KLASS_ENUM_NAME(System_klass),               // java.lang.System
  WK_KLASS_ENUM_NAME(Throwable_klass),            // java.lang.Throwable
  WK_KLASS_ENUM_NAME(StackTraceElement_klass),    // java.lang.StackTraceElement
  // ... æ›´å¤šæ ¸å¿ƒç±»
};
```

### 3.10.3 ç±»åŠ è½½çš„å®Œæ•´æµç¨‹

```cpp
Klass* SystemDictionary::resolve_or_fail(Symbol* class_name, ...) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
  Klass* k = find(class_name, class_loader, protection_domain, THREAD);
  if (k != NULL) return k;
  
  // 2. åŒäº²å§”æ´¾ï¼šå°è¯•çˆ¶åŠ è½½å™¨åŠ è½½
  if (parent_loader.not_null()) {
    k = resolve_or_fail(class_name, parent_loader, ..., THREAD);
    if (k != NULL) return k;
  }
  
  // 3. è‡ªå·±åŠ è½½ï¼šè°ƒç”¨ClassLoader.loadClass()
  JavaCalls::call_virtual(&result,
                         class_loader,
                         SystemDictionary::ClassLoader_klass(),
                         vmSymbols::loadClass_name(),
                         ...);
  
  // 4. è§£æå­—èŠ‚ç 
  ClassFileParser parser(stream, class_name, ...);
  InstanceKlass* ik = parser.parseClassFile(CHECK_NULL);
  
  // 5. é“¾æ¥ï¼ˆéªŒè¯ã€å‡†å¤‡ã€è§£æï¼‰
  ik->link_class(CHECK_NULL);
  
  // 6. æ³¨å†Œåˆ°SystemDictionary
  add_klass(class_name, ik);
  
  return ik;
}
```

---

## 3.11 æ¨¡å—ç³»ç»Ÿï¼ˆJava 9+ï¼‰

Java 9å¼•å…¥äº†æ¨¡å—ç³»ç»Ÿï¼ˆProject Jigsawï¼‰ï¼Œæ”¹å˜äº†ç±»åŠ è½½æœºåˆ¶ã€‚

### 3.11.1 æ¨¡å—çš„æ¦‚å¿µ

**æ¨¡å—ï¼ˆModuleï¼‰**ï¼šä¸€ç»„åŒ…çš„é›†åˆï¼Œå…·æœ‰æ˜ç¡®çš„ä¾èµ–å…³ç³»ã€‚

```
module java.base {
    exports java.lang;
    exports java.util;
    exports java.io;
    // ä¸å¯¼å‡º sun.miscï¼ˆå†…éƒ¨å®ç°ï¼‰
}

module my.app {
    requires java.base;      // ä¾èµ–java.baseæ¨¡å—
    requires java.sql;       // ä¾èµ–java.sqlæ¨¡å—
    exports com.myapp.api;   // å¯¼å‡ºapiåŒ…
}
```

### 3.11.2 ModuleEntryä¸PackageEntry

```cpp
// hotspot/src/share/classfile/moduleEntry.hpp

class ModuleEntry : public HashtableEntry<Symbol*, mtClass> {
 private:
  Symbol* _name;                    // æ¨¡å—åï¼ˆå¦‚"java.base"ï¼‰
  ClassLoaderData* _loader_data;    // ç±»åŠ è½½å™¨
  GrowableArray<ModuleEntry*>* _reads;  // ä¾èµ–çš„æ¨¡å—
  GrowableArray<PackageEntry*>* _exports; // å¯¼å‡ºçš„åŒ…
  
 public:
  bool is_open_to(ModuleEntry* target) const;
  bool exports_package(Symbol* package_name) const;
};

// hotspot/src/share/classfile/packageEntry.hpp

class PackageEntry : public HashtableEntry<Symbol*, mtClass> {
 private:
  Symbol* _name;                    // åŒ…åï¼ˆå¦‚"java.lang"ï¼‰
  ModuleEntry* _module;             // æ‰€å±æ¨¡å—
  bool _is_exported;                // æ˜¯å¦å¯¼å‡º
  
 public:
  bool is_qual_exported_to(ModuleEntry* target) const;
};
```

### 3.11.3 æ¨¡å—å¯è§æ€§æ£€æŸ¥

```cpp
// hotspot/src/share/classfile/systemDictionary.cpp

bool SystemDictionary::is_package_visible(Klass* klass,
                                          ClassLoaderData* loader_data,
                                          bool check_access, TRAPS) {
  PackageEntry* pkg = klass->package();
  ModuleEntry* mod = pkg->module();
  
  // æ£€æŸ¥æ¨¡å—æ˜¯å¦å¯¼å‡ºäº†è¯¥åŒ…
  if (!pkg->is_exported()) {
    return false;
  }
  
  // æ£€æŸ¥ç›®æ ‡æ¨¡å—æ˜¯å¦æœ‰è¯»å–æƒé™
  ModuleEntry* target_mod = loader_data->modules()->unnamed_module();
  if (!mod->is_exported_to(target_mod)) {
    return false;
  }
  
  return true;
}
```

---

## 3.12 ç±»å¸è½½ï¼šä¸å†è¢«å¼•ç”¨çš„ç±»

ç±»ä¹Ÿå¯ä»¥è¢«å¸è½½ï¼ˆUnloadingï¼‰ï¼Œä½†æ¡ä»¶å¾ˆä¸¥æ ¼ã€‚

### 3.12.1 ç±»å¸è½½çš„æ¡ä»¶

ä¸€ä¸ªç±»è¦è¢«å¸è½½ï¼Œå¿…é¡»æ»¡è¶³ï¼š

1. **è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹éƒ½è¢«å›æ”¶**
2. **è¯¥ç±»çš„Classå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨**
3. **åŠ è½½è¯¥ç±»çš„ClassLoaderå·²è¢«å›æ”¶**
4. **è¯¥ç±»å¯¹åº”çš„InstanceKlassæ²¡æœ‰è¢«å¼•ç”¨**

**å®é™…ä¸Š**ï¼šåªæœ‰è‡ªå®šä¹‰ClassLoaderåŠ è½½çš„ç±»æ‰èƒ½è¢«å¸è½½ï¼ŒBootstrap/Ext/AppåŠ è½½çš„ç±»æ°¸ä¸å¸è½½ï¼

### 3.12.2 ç±»å¸è½½çš„æ—¶æœº

ç±»å¸è½½å‘ç”Ÿåœ¨**GCçš„å…ƒç©ºé—´å›æ”¶é˜¶æ®µ**ï¼š

```cpp
// hotspot/src/share/gc/shared/gcVMOperations.cpp

void VM_CollectForMetadataAllocation::doit() {
  // Full GC
  Universe::heap()->collect_as_vm_thread(GCCause::_metadata_GC_threshold);
  
  // æ¸…ç†å…ƒç©ºé—´
  ClassLoaderDataGraph::purge();  // å¸è½½ä¸å¯è¾¾çš„ClassLoader
}
```

### 3.12.3 ClassLoaderDataçš„å›æ”¶

```cpp
// hotspot/src/share/classfile/classLoaderData.cpp

void ClassLoaderDataGraph::purge() {
  ClassLoaderData* data = _head;
  ClassLoaderData* prev = NULL;
  
  while (data != NULL) {
    // æ£€æŸ¥ClassLoaderæ˜¯å¦å¯è¾¾
    if (data->is_alive()) {
      prev = data;
      data = data->next();
    } else {
      // å¸è½½è¯¥ClassLoaderåŠ è½½çš„æ‰€æœ‰ç±»
      ClassLoaderData* to_free = data;
      data = data->next();
      
      if (prev == NULL) {
        _head = data;
      } else {
        prev->set_next(data);
      }
      
      // é‡Šæ”¾å…ƒæ•°æ®
      to_free->free_deallocate_list();
      delete to_free;
    }
  }
}
```

---

## 3.13 GDBéªŒè¯ï¼šHelloWorldç±»åŠ è½½å®Œæ•´è¿‡ç¨‹ â­

> **éªŒè¯ç¯å¢ƒ**: OpenJDK 11 slowdebug  
> **JVMå‚æ•°**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint`  
> **ç›®æ ‡ç±»**: HelloWorld

### 3.13.1 HelloWorldæºç ä¸å­—èŠ‚ç 

```java
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
```

**ç¼–è¯‘åçš„Classæ–‡ä»¶**: 421 bytes, major version 55 (Java 11)

### 3.13.2 ç±»åŠ è½½å®Œæ•´è°ƒç”¨æ ˆ (GDBéªŒè¯)

```
=== ç¬¬ä¸€é˜¶æ®µ: æŸ¥æ‰¾ç±» (Bootstrap ClassLoaderå°è¯•) ===
#0  SystemDictionary::load_instance_class
    at systemDictionary.cpp:1405
#1  SystemDictionary::resolve_instance_class_or_null
    at systemDictionary.cpp:821
#2  SystemDictionary::resolve_or_null
    at systemDictionary.cpp:256
#4  JVM_FindClassFromBootLoader
    at jvm.cpp:782
#5  Java_java_lang_ClassLoader_findBootstrapClass  â† JNIå…¥å£

=== ç¬¬äºŒé˜¶æ®µ: å®šä¹‰ç±» (AppClassLoader) ===
#0  KlassFactory::create_from_stream
    at klassFactory.cpp:172
#1  SystemDictionary::resolve_from_stream
    at systemDictionary.cpp:1088
#2  jvm_define_class_common
    at jvm.cpp:940
#3  JVM_DefineClassWithSource
    at jvm.cpp:966
#4  Java_java_lang_ClassLoader_defineClass1  â† JNIå…¥å£

å…³é”®å‚æ•° (GDBéªŒè¯):
  stream: 0x7ffff7808f60 (ClassFileStream)
  buf: 0x7ffff0f784e0 (classæ–‡ä»¶å†…å®¹ï¼Œé­”æ•° CAFEBABE)
  len: 421 bytes
  source: "file:/data/workspace/"

=== ç¬¬ä¸‰é˜¶æ®µ: è§£æclassæ–‡ä»¶ ===
#0  ClassFileParser::create_instance_klass
    at classFileParser.cpp:5568

GDBéªŒè¯çš„è§£æç»“æœ:
  _this_class_index: 5     (å¸¸é‡æ± #5 = HelloWorld)
  _super_class_index: 6    (å¸¸é‡æ± #6 = java/lang/Object)
  _itfs_len: 0             (æ— æ¥å£)
  _java_fields_count: 0    (æ— å­—æ®µ)
  _vtable_size: 5          (ç»§æ‰¿Objectçš„5ä¸ªè™šæ–¹æ³•)
  _itable_size: 2
  _cp->length: 29          (å¸¸é‡æ± 29é¡¹)
  _methods->length: 2      (<init> + main)
```

### 3.13.3 HelloWorldçš„InstanceKlass (GDBéªŒè¯)

```
InstanceKlassåœ°å€: 0x800092840 (Compressed Class Space)
sizeof(InstanceKlass): 472 bytes

=== ç±»å…ƒä¿¡æ¯ ===
_layout_helper: 16              // å®ä¾‹å¤§å°
_access_flags: 0x20000021       // ACC_PUBLIC | ACC_SUPER
_vtable_len: 5                  // è™šæ–¹æ³•è¡¨é•¿åº¦
_itable_len: 2                  // æ¥å£æ–¹æ³•è¡¨é•¿åº¦
_static_field_size: 0           // æ— é™æ€å­—æ®µ
_nonstatic_field_size: 0        // æ— å®ä¾‹å­—æ®µ

=== ç±»å±‚çº§å…³ç³» ===
_super: 0x800001040             // java/lang/Object
_constants: 0x7fffcefa6068      // ConstantPool
_methods: 0x7fffcefa61d8        // Methodæ•°ç»„
_class_loader_data: 0x7ffff0ef8ba0  // AppClassLoaderçš„CLD
_init_state: 6                  // fully_initialized
```

### 3.13.4 å­˜å‚¨ä½ç½®éªŒè¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨åŒºåŸŸ                    â”‚ åœ°å€                â”‚ å¤§å°           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ InstanceKlass              â”‚ 0x800092840        â”‚ 472 bytes      â”‚
â”‚ (Compressed Class Space)   â”‚                    â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ConstantPool               â”‚ 0x7fffcefa6068     â”‚ ~232 bytes     â”‚
â”‚ (Metaspace Non-class)      â”‚ 29é¡¹               â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CPCache                    â”‚ 0x7fffcefa6348     â”‚ ~96 bytes      â”‚
â”‚ (Metaspace Non-class)      â”‚ 3é¡¹                â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Method (main)              â”‚ 0x7fffcefa62e0     â”‚ ~48 bytes      â”‚
â”‚ (Metaspace Non-class)      â”‚                    â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§£é‡Šå™¨å…¥å£                  â”‚ 0x7fffed010c00     â”‚ (CodeCache)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœ°å€è§„å¾‹ (8GBå †):
- 0x800xxxxxx: Compressed Class Space (InstanceKlass)
- 0x7fffcexxxxxx: Metaspace Non-class (ConstantPool, Method)
- 0x7fffedxxxxxx: CodeCache (è§£é‡Šå™¨stub)
```

### 3.13.5 å¸¸é‡æ± Tags (GDBéªŒè¯)

```
ConstantPoolåœ°å€: 0x7fffcefa6068
length: 29
_cache: 0x7fffcefa6348 (ConstantPoolCache)

CP[ 1] tag=10 (Methodref)      // Object.<init>
CP[ 2] tag= 9 (Fieldref)       // System.out
CP[ 3] tag= 8 (String)         // "Hello World"
CP[ 4] tag=10 (Methodref)      // PrintStream.println
CP[ 5] tag=100 (å·²è§£æClass)    // HelloWorld
CP[ 6] tag=100 (å·²è§£æClass)    // java/lang/Object
CP[ 7] tag= 1 (Utf8)           // "<init>"
CP[11] tag= 1 (Utf8)           // "main"
CP[12] tag= 1 (Utf8)           // "([Ljava/lang/String;)V"
... (çœç•¥å…¶ä»–Utf8å’ŒNameAndType)

æ³¨: tag=100 è¡¨ç¤ºå·²è§£æçš„Classå¼•ç”¨ (JVM_CONSTANT_Class_RESOLVED)
```

### 3.13.6 vtableå¡«å……éªŒè¯ (åˆå§‹åŒ–å)

```
vtableèµ·å§‹åœ°å€ = InstanceKlassåœ°å€ + sizeof(InstanceKlass)
             = 0x800092840 + 472

vtable[0]: 0x7fffceaf1f48 â†’ finalize()    // ç»§æ‰¿è‡ªObject
vtable[1]: 0x7fffceaf18b8 â†’ equals()      // ç»§æ‰¿è‡ªObject  
vtable[2]: 0x7fffceaf1a68 â†’ toString()    // ç»§æ‰¿è‡ªObject
vtable[3]: 0x7fffceaf17c0 â†’ hashCode()    // ç»§æ‰¿è‡ªObject
vtable[4]: 0x7fffceaf1968 â†’ clone()       // ç»§æ‰¿è‡ªObject

invokevirtualæ‰§è¡Œæ—¶:
1. ä»å¯¹è±¡å¤´å–å‡ºå‹ç¼©ç±»æŒ‡é’ˆ
2. è§£å‹å¾—åˆ°InstanceKlassåœ°å€
3. æ ¹æ®vtable_indexæŸ¥è¡¨: Method* = vtable[index]
4. è·³è½¬åˆ°Methodçš„è§£é‡Šå™¨å…¥å£æ‰§è¡Œ
```

### 3.13.7 Methodæ•°æ®ç»“æ„ (GDBéªŒè¯)

```
=== Method[1]: main ===
Method*: 0x7fffcefa62e0
ConstMethod*: 0x7fffcefa6298
code_size: 9 bytes
max_stack: 2
max_locals: 1
name_index: 11       â†’ "main"
signature_index: 12  â†’ "([Ljava/lang/String;)V"

è§£é‡Šå™¨å…¥å£ (è§£é‡Šæ¨¡å¼):
_i2i_entry: 0x7fffed010c00
_from_interpreted_entry: 0x7fffed010c00
_from_compiled_entry: 0x7fffed065b43 (è§£é‡Šæ¨¡å¼ä¸ä½¿ç”¨)

å­—èŠ‚ç  (åŸå§‹):
b2 00 02   getstatic #2      // System.out
12 03      ldc #3            // "Hello World"
b6 00 04   invokevirtual #4  // println
b1         return

å­—èŠ‚ç  (linké˜¶æ®µé‡å†™å):
b2 01 00   getstatic (CPCacheç´¢å¼•)
e6 00      fast_aldc
b6 02 00   invokevirtual (CPCacheç´¢å¼•)
b1         return
```

### 3.13.8 ç±»åŠ è½½æµç¨‹å›¾ (GDBéªŒè¯)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HelloWorld ç±»åŠ è½½å®Œæ•´æµç¨‹ (GDBéªŒè¯)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  main()å…¥å£ / Class.forName()                                               â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ SystemDictionary::resolve_or_null      â”‚ â† åŒäº²å§”æ´¾å…¥å£                    â”‚
â”‚  â”‚ class_name = "HelloWorld"              â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚           â”‚ æŸ¥è¯¢SystemDictionaryç¼“å­˜ â†’ æœªæ‰¾åˆ°                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ Bootstrap ClassLoaderå°è¯•åŠ è½½ â†’ å¤±è´¥    â”‚ JVM_FindClassFromBootLoader     â”‚
â”‚  â”‚ â†“                                      â”‚                                 â”‚
â”‚  â”‚ AppClassLoader.defineClass()           â”‚ è¯»å–HelloWorld.class (421B)     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ KlassFactory::create_from_stream       â”‚ stream=0x7ffff7808f60           â”‚
â”‚  â”‚ ClassFileParser::parse_stream          â”‚ loader_data=0x7ffff0f00b90      â”‚
â”‚  â”‚   - è§£æå¸¸é‡æ±  (29é¡¹)                   â”‚                                 â”‚
â”‚  â”‚   - è§£ææ–¹æ³• (2ä¸ª: <init>, main)        â”‚                                 â”‚
â”‚  â”‚   - è®¡ç®—vtable/itable                  â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ InstanceKlass::link_class_impl         â”‚ 0x800092840                     â”‚
â”‚  â”‚ - éªŒè¯å­—èŠ‚ç                             â”‚                                 â”‚
â”‚  â”‚ - åˆ›å»ºCPCache (3é¡¹)                    â”‚ 0x7fffcefa6348                  â”‚
â”‚  â”‚ - é‡å†™å­—èŠ‚ç  (getstaticâ†’fastç‰ˆæœ¬)       â”‚                                 â”‚
â”‚  â”‚ - å¡«å……vtable (5ä¸ªObjectè™šæ–¹æ³•)          â”‚                                 â”‚
â”‚  â”‚ - è®¾ç½®è§£é‡Šå™¨å…¥å£                        â”‚ 0x7fffed010c00                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ InstanceKlass::initialize_impl         â”‚                                 â”‚
â”‚  â”‚ _init_state = 6 (fully_initialized)   â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ ç±»åŠ è½½å®Œæˆï¼Œè°ƒç”¨mainæ–¹æ³•                â”‚                                 â”‚
â”‚  â”‚ è§£é‡Šå™¨é€æ¡æ‰§è¡Œ9å­—èŠ‚å­—èŠ‚ç                â”‚                                 â”‚
â”‚  â”‚ è¾“å‡º "Hello World"                     â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.13.9 GDBéªŒè¯å‘½ä»¤

```bash
# è¿›å…¥è°ƒè¯•æ¨¡å¼
cd /data/workspace/openjdk11-core/build/linux-x86_64-normal-server-slowdebug/jdk/bin
gdb ./java

# è®¾ç½®æ–­ç‚¹
break InstanceKlass::link_class_impl
break InstanceKlass::initialize_impl
break SystemDictionary::load_instance_class

# è¿è¡Œ (è§£é‡Šæ¨¡å¼)
run -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint -cp /data/workspace HelloWorld

# æŸ¥çœ‹InstanceKlass
print this
print this->_vtable_len
print this->_methods->_length
print this->_constants->_length

# æŸ¥çœ‹vtable
set $vtable = (intptr_t*)((char*)this + sizeof(InstanceKlass))
print (Method*)$vtable[0]

# æŸ¥çœ‹å­—èŠ‚ç 
set $method = (Method*)(this->_methods->_data[1])
set $cm = $method->_constMethod
set $bc = (unsigned char*)((char*)$cm + sizeof(ConstMethod))
x/9bx $bc
```

---

## 3.14 æœ¬ç« å°ç»“

âœ… **ç±»çš„ç”Ÿå‘½å‘¨æœŸ**ï¼šåŠ è½½ â†’ éªŒè¯ â†’ å‡†å¤‡ â†’ è§£æ â†’ åˆå§‹åŒ– â†’ ä½¿ç”¨ â†’ å¸è½½  
âœ… **ClassFileParser**ï¼šå­—èŠ‚ç è§£æçš„æ ¸å¿ƒï¼Œåˆ›å»ºInstanceKlass  
âœ… **å¸¸é‡æ± **ï¼šå­˜å‚¨æ‰€æœ‰ç¬¦å·å¼•ç”¨ï¼Œæ”¯æŒå»¶è¿Ÿè§£æ  
âœ… **å­—æ®µå¸ƒå±€**ï¼šJVMè‡ªåŠ¨é‡æ’åºå­—æ®µä¼˜åŒ–å†…å­˜  
âœ… **`<clinit>`**ï¼šç±»åˆå§‹åŒ–æ–¹æ³•ï¼Œçº¿ç¨‹å®‰å…¨æ‰§è¡Œä¸€æ¬¡  
âœ… **SystemDictionary**ï¼šå…¨å±€ç±»æ³¨å†Œè¡¨ï¼Œç®¡ç†æ‰€æœ‰å·²åŠ è½½ç±»  
âœ… **æ¨¡å—ç³»ç»Ÿ**ï¼šJava 9+çš„å¯è§æ€§æ§åˆ¶æœºåˆ¶  
âœ… **ç±»å¸è½½**ï¼šåªæœ‰è‡ªå®šä¹‰ClassLoaderçš„ç±»æ‰èƒ½å¸è½½

### â­ GDBéªŒè¯æ–°å¢å†…å®¹

| éªŒè¯é¡¹ | GDBæ•°æ® | è¯´æ˜ |
|--------|---------|------|
| InstanceKlass | 0x800092840, 472B | Compressed Class Space |
| ConstantPool | 0x7fffcefa6068, 29é¡¹ | Metaspace Non-class |
| CPCache | 0x7fffcefa6348, 3é¡¹ | å­—èŠ‚ç è§£æç¼“å­˜ |
| vtable | 5é¡¹ | finalize/equals/toString/hashCode/clone |
| è§£é‡Šå™¨å…¥å£ | 0x7fffed010c00 | CodeCache non-nmethods |
| å­—èŠ‚ç é‡å†™ | getstaticâ†’fast_aldc | linké˜¶æ®µä¼˜åŒ– |  

**å…³é”®æºç æ–‡ä»¶**ï¼š
- `hotspot/src/share/classfile/classFileParser.cpp` - å­—èŠ‚ç è§£æ
- `hotspot/src/share/classfile/systemDictionary.cpp` - ç±»åŠ è½½ç®¡ç†
- `hotspot/src/share/oops/constantPool.cpp` - å¸¸é‡æ± 
- `hotspot/src/share/oops/instanceKlass.cpp` - ç±»åˆå§‹åŒ–

---

## ä¸‹ä¸€ç« é¢„å‘Š

ç°åœ¨æˆ‘ä»¬å·²ç»ç†è§£äº†ï¼š
- å¯¹è±¡æ˜¯ä»€ä¹ˆï¼ˆç¬¬2ç« ï¼‰
- ç±»æ˜¯å¦‚ä½•åŠ è½½çš„ï¼ˆç¬¬3ç« ï¼‰

æ¥ä¸‹æ¥è¦ç†è§£ï¼š**ä»£ç æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ**

[**ç¬¬4ç« ï¼šè§£é‡Šå™¨**](./04-è§£é‡Šå™¨.md) å°†å›ç­”ï¼š
- å­—èŠ‚ç æ˜¯å¦‚ä½•è¢«è§£é‡Šæ‰§è¡Œçš„ï¼Ÿ
- æ¨¡æ¿è§£é‡Šå™¨çš„"æ¨¡æ¿"æ˜¯ä»€ä¹ˆï¼Ÿ
- æ–¹æ³•è°ƒç”¨çš„4ç§invokexxxæŒ‡ä»¤æœ‰ä½•åŒºåˆ«ï¼Ÿ
- æ ˆå¸§æ˜¯å¦‚ä½•ç®¡ç†çš„ï¼Ÿ

è¿™æ˜¯ç†è§£JVMæ‰§è¡Œå¼•æ“çš„åŸºç¡€ï¼

---

## ğŸ“– æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆJVMè¦è®¾è®¡åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ**  
   æç¤ºï¼šå®‰å…¨æ€§ã€é¿å…é‡å¤åŠ è½½

2. **å‡†å¤‡é˜¶æ®µå’Œåˆå§‹åŒ–é˜¶æ®µæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**  
   ```java
   static int a = 10;
   static final int B = 20;
   ```

3. **ä¸ºä»€ä¹ˆç±»å¸è½½çš„æ¡ä»¶è¿™ä¹ˆä¸¥æ ¼ï¼Ÿ**  
   æç¤ºï¼šå…ƒæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸ

4. **æ¨¡å—ç³»ç»Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ**  
   æç¤ºï¼šclasspathåœ°ç‹±ã€å†…éƒ¨APIæš´éœ²

ï¼ˆç­”æ¡ˆåœ¨æœ¬ç« å†…å®¹ä¸­ï¼‰
