# ç¬¬2ç« ï¼šå¯¹è±¡æ¨¡å‹ - ä¸€åˆ‡ä»å¯¹è±¡å¼€å§‹

> **æœ¬ç« ç›®æ ‡**ï¼šæ·±å…¥ç†è§£Javaå¯¹è±¡åœ¨JVMä¸­çš„çœŸå®è¡¨ç¤ºï¼Œè¿™æ˜¯ç†è§£GCã€é”ã€å†…å­˜å¸ƒå±€çš„åŸºç¡€ã€‚
> 
> **â­ æœ¬ç« æ›´æ–°**ï¼šåŸºäºGDBè°ƒè¯•éªŒè¯çš„HelloWorldå¯¹è±¡åˆ›å»ºå®Œæ•´æµç¨‹

---

## â­ æœ¬ç« GDBéªŒè¯äº®ç‚¹

| é¡¹ç›® | GDBéªŒè¯å€¼ | è¯´æ˜ |
|------|-----------|------|
| HelloWorldå¯¹è±¡åœ°å€ | `0x7ff41f2b0` | Javaå † (Eden TLAB) |
| å¯¹è±¡å¤§å° | 16 bytes | header(12) + padding(4) |
| mark word | `0x5` | åå‘é”å¯ç”¨çŠ¶æ€ |
| compressed klass | `0x92840` | è§£å‹å`0x800092840` |
| InstanceKlass | `0x800092840` | Compressed Class Space |
| TLAB._topå˜åŒ– | `0x7ff41f2b0 â†’ 0x7ff41f2c0` | bump-the-pointeråˆ†é… |
| TLABå¤§å° | ~2MB | çº¿ç¨‹æœ¬åœ°ç¼“å†² |

---

## 2.1 ä»ä¸€ä¸ªç®€å•çš„Javaå¯¹è±¡è¯´èµ·

```java
class User {
    private int age;
    private String name;
}

User user = new User();
```

è¿™è¡Œä»£ç æ‰§è¡Œåï¼ŒJVMå†…å­˜ä¸­åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Javaå †å†…å­˜                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Userå¯¹è±¡ (user)                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  å¯¹è±¡å¤´ (Object Header)          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Mark Word    â”‚ KlassæŒ‡é’ˆ   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  8å­—èŠ‚       â”‚  4å­—èŠ‚(å‹ç¼©)â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  å®ä¾‹æ•°æ® (Instance Data)        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚  â”‚ int age      â”‚  4å­—èŠ‚        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚   â”‚
â”‚  â”‚  â”‚ String name  â”‚  4å­—èŠ‚(å‹ç¼©)  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  å¯¹é½å¡«å…… (Padding)              â”‚   â”‚
â”‚  â”‚  (ä¿è¯8å­—èŠ‚å¯¹é½)                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        æ€»å¤§å°: 24å­—èŠ‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
1. **å¯¹è±¡å¤´**æ˜¯GCå’Œé”çš„å…³é”®ï¼ˆMark Wordå­˜å‚¨GCå¹´é¾„ã€é”çŠ¶æ€ï¼‰
2. **KlassæŒ‡é’ˆ**æŒ‡å‘ç±»çš„å…ƒæ•°æ®ï¼ˆç±»å‹ä¿¡æ¯ã€æ–¹æ³•è¡¨ï¼‰
3. **å®ä¾‹æ•°æ®**å°±æ˜¯ä½ å®šä¹‰çš„å­—æ®µ
4. **å¯¹é½å¡«å……**ç¡®ä¿å¯¹è±¡å¤§å°æ˜¯8å­—èŠ‚çš„å€æ•°ï¼ˆCPUç¼“å­˜è¡Œä¼˜åŒ–ï¼‰

---

## 2.2 å¯¹è±¡æŒ‡é’ˆï¼šoopå®¶æ—

åœ¨JVMæºç ä¸­ï¼Œæ‰€æœ‰Javaå¯¹è±¡éƒ½ç”¨`oop`ï¼ˆOrdinary Object Pointerï¼‰è¡¨ç¤ºã€‚

### 2.2.1 oopç±»å‹å±‚æ¬¡

```cpp
// hotspot/src/share/oops/oopsHierarchy.hpp

typedef class oopDesc*  oop;           // æ™®é€šå¯¹è±¡æŒ‡é’ˆ
typedef class instanceOopDesc* instanceOop;  // å®ä¾‹å¯¹è±¡
typedef class arrayOopDesc* arrayOop;        // æ•°ç»„å¯¹è±¡
typedef class objArrayOopDesc* objArrayOop;  // å¯¹è±¡æ•°ç»„
typedef class typeArrayOopDesc* typeArrayOop;// åŸºæœ¬ç±»å‹æ•°ç»„
```

**å…³ç³»å›¾**ï¼š
```
oopDesc (åŸºç±»)
  â”œâ”€ instanceOopDesc    â†’ Userå¯¹è±¡ã€Stringå¯¹è±¡
  â””â”€ arrayOopDesc
      â”œâ”€ objArrayOop    â†’ User[] å¯¹è±¡æ•°ç»„
      â””â”€ typeArrayOop   â†’ int[] åŸºæœ¬ç±»å‹æ•°ç»„
```

### 2.2.2 oopDescï¼šå¯¹è±¡çš„å†…å­˜å¸ƒå±€

```cpp
// hotspot/src/share/oops/oop.hpp

class oopDesc {
  friend class VMStructs;
  friend class JVMCIVMStructs;
 private:
  volatile markOop _mark;  // å¯¹è±¡å¤´ï¼šMark Word (8å­—èŠ‚)
  union _metadata {
    Klass* _klass;         // ç±»å…ƒæ•°æ®æŒ‡é’ˆ (8å­—èŠ‚ï¼Œå‹ç¼©å4å­—èŠ‚)
    narrowKlass _compressed_klass;
  } _metadata;

 public:
  // è·å–Mark Word
  markOop mark() const { return _mark; }
  
  // è·å–Klass
  Klass* klass() const { 
    return UseCompressedClassPointers ? 
      decode_klass(_metadata._compressed_klass) : 
      _metadata._klass;
  }
  
  // å¯¹è±¡å¹´é¾„ï¼ˆGCç›¸å…³ï¼‰
  int age() const { return mark()->age(); }
  
  // æ˜¯å¦è¢«é”å®š
  bool is_locked() const { return mark()->is_locked(); }
  
  // ... æ›´å¤šæ–¹æ³•
};
```

**é‡ç‚¹ç†è§£**ï¼š
- `_mark`ï¼šå­˜å‚¨è¿è¡Œæ—¶æ•°æ®ï¼ˆGCå¹´é¾„ã€é”çŠ¶æ€ã€å“ˆå¸Œç ï¼‰
- `_metadata`ï¼šå­˜å‚¨ç±»å‹ä¿¡æ¯ï¼ˆæŒ‡å‘Klassï¼‰
- è¿™ä¸¤ä¸ªå­—æ®µæ„æˆ**å¯¹è±¡å¤´ï¼ˆObject Headerï¼‰**

---

## 2.3 Mark Wordï¼šå¯¹è±¡å¤´çš„ç§˜å¯†

**Mark Wordæ˜¯JVMä¸­æœ€ç²¾å¦™çš„è®¾è®¡ä¹‹ä¸€**ï¼Œå®ƒåœ¨8ä¸ªå­—èŠ‚ï¼ˆ64ä½ï¼‰ä¸­å­˜å‚¨äº†å¤šç§ä¿¡æ¯ã€‚

### 2.3.1 Mark Wordçš„ä½åŸŸç»“æ„

```cpp
// hotspot/src/share/oops/markOop.hpp

// 64ä½JVMçš„Mark Wordå¸ƒå±€ï¼ˆæ ¹æ®é”çŠ¶æ€ä¸åŒè€Œå˜åŒ–ï¼‰

// ã€çŠ¶æ€1ã€‘æ— é”çŠ¶æ€ï¼ˆNormalï¼‰
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
// â”‚ unused (25)   â”‚hash(31) â”‚age â”‚ 0  â”‚ 01 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
//  25ä½æœªä½¿ç”¨      31ä½å“ˆå¸Œ   4ä½  1ä½  2ä½
//                            å¹´é¾„ åå‘ é”æ ‡å¿—

// ã€çŠ¶æ€2ã€‘åå‘é”ï¼ˆBiasedï¼‰
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
// â”‚ thread ID (54)          â”‚age â”‚ 1  â”‚ 01 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
//  54ä½çº¿ç¨‹ID                4ä½  1ä½  2ä½
//                            å¹´é¾„ åå‘ é”æ ‡å¿—

// ã€çŠ¶æ€3ã€‘è½»é‡çº§é”ï¼ˆLightweight Lockedï¼‰
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
// â”‚ ptr to lock record (62)             â”‚ 00 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
//  62ä½æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ              2ä½é”æ ‡å¿—

// ã€çŠ¶æ€4ã€‘é‡é‡çº§é”ï¼ˆHeavyweight Lockedï¼‰
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
// â”‚ ptr to ObjectMonitor (62)           â”‚ 10 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
//  62ä½æŒ‡å‘ObjectMonitorå¯¹è±¡çš„æŒ‡é’ˆ       2ä½é”æ ‡å¿—

// ã€çŠ¶æ€5ã€‘GCæ ‡è®°ï¼ˆMarked for GCï¼‰
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
// â”‚ forwarding pointer (62)             â”‚ 11 â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
//  62ä½è½¬å‘æŒ‡é’ˆï¼ˆGCæ—¶å¯¹è±¡ç§»åŠ¨çš„æ–°åœ°å€ï¼‰  2ä½é”æ ‡å¿—
```

### 2.3.2 Mark Wordçš„æ ¸å¿ƒå¸¸é‡

```cpp
// hotspot/src/share/oops/markOop.hpp

enum {
  // é”çŠ¶æ€ä½ï¼ˆæœ€ä½2ä½ï¼‰
  locked_value             = 0,  // 00 è½»é‡çº§é”
  unlocked_value           = 1,  // 01 æ— é”æˆ–åå‘é”
  monitor_value            = 2,  // 10 é‡é‡çº§é”
  marked_value             = 3,  // 11 GCæ ‡è®°
  
  // åå‘é”ä½ï¼ˆç¬¬3ä½ï¼‰
  biased_lock_bit_in_place = 1 << 2,
  
  // å¹´é¾„ä½ï¼ˆ4-7ä½ï¼Œå…±4ä½ï¼Œæœ€å¤§15ï¼‰
  age_bits                 = 4,
  age_shift                = 3,
  age_mask                 = right_n_bits(age_bits),
  max_age                  = age_mask,  // 15ï¼ˆæ™‹å‡é˜ˆå€¼ï¼‰
  
  // å“ˆå¸Œç ä½ï¼ˆæ— é”æ€ï¼Œ8-38ä½ï¼Œå…±31ä½ï¼‰
  hash_bits                = 31,
  hash_shift               = 8,
  hash_mask                = right_n_bits(hash_bits),
};
```

### 2.3.3 å…³é”®æ–¹æ³•å®ç°

```cpp
class markOopDesc: public oopDesc {
 public:
  // è·å–å¯¹è±¡å¹´é¾„ï¼ˆGCä½¿ç”¨ï¼‰
  int age() const { 
    return (int)mask_bits(value() >> age_shift, age_mask); 
  }
  
  // è®¾ç½®å¯¹è±¡å¹´é¾„
  markOop set_age(int v) const {
    return markOop((value() & ~age_mask_in_place) | 
                   ((v & age_mask) << age_shift));
  }
  
  // åˆ¤æ–­é”çŠ¶æ€
  bool is_unlocked() const {
    return (value() & lock_mask_in_place) == unlocked_value;
  }
  
  bool is_biased() const {
    return (value() & biased_lock_mask_in_place) == biased_lock_pattern;
  }
  
  bool is_locked() const {
    return (value() & lock_mask_in_place) != unlocked_value;
  }
  
  // è·å–å“ˆå¸Œç 
  int hash() const {
    return mask_bits(value() >> hash_shift, hash_mask);
  }
};
```

### 2.3.4 å®é™…ä¾‹å­ï¼šä»Mark Wordè¯»å–GCå¹´é¾„

```cpp
// hotspot/src/share/gc/shared/ageTable.cpp

// å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„åˆ¤æ–­
bool ageTable::should_promote(oop obj, uint threshold) {
  markOop mark = obj->mark();
  
  // ä»Mark Wordè¯»å–å¹´é¾„ï¼ˆ4ä½ï¼Œ0-15ï¼‰
  uint age = mark->age();
  
  // å¦‚æœå¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤15ï¼‰ï¼Œæ™‹å‡åˆ°è€å¹´ä»£
  return age >= threshold;
}
```

**è¿™å°±æ˜¯G1å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦è¯¥æ™‹å‡çš„ï¼**

---

## 2.4 KlassæŒ‡é’ˆï¼šé€šå¾€ç±»å…ƒæ•°æ®çš„æ¡¥æ¢

æ¯ä¸ªå¯¹è±¡çš„å¯¹è±¡å¤´éƒ½æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å®ƒçš„`Klass`ï¼ŒKlasså­˜å‚¨äº†ç±»çš„å…ƒæ•°æ®ã€‚

### 2.4.1 Klassç±»å±‚æ¬¡

```cpp
// hotspot/src/share/oops/klass.hpp

Klass (åŸºç±»)
  â”œâ”€ InstanceKlass       â†’ æ™®é€šJavaç±»ï¼ˆUser.classï¼‰
  â”‚   â”œâ”€ InstanceMirrorKlass   â†’ java.lang.Classå¯¹è±¡
  â”‚   â””â”€ InstanceRefKlass      â†’ Referenceå­ç±»
  â”‚
  â”œâ”€ ArrayKlass          â†’ æ•°ç»„ç±»
  â”‚   â”œâ”€ ObjArrayKlass   â†’ å¯¹è±¡æ•°ç»„ï¼ˆUser[]ï¼‰
  â”‚   â””â”€ TypeArrayKlass  â†’ åŸºæœ¬ç±»å‹æ•°ç»„ï¼ˆint[]ï¼‰
  â”‚
  â””â”€ ... å…¶ä»–ç‰¹æ®Šç±»å‹
```

### 2.4.2 InstanceKlassï¼šJavaç±»çš„å…ƒæ•°æ®

```cpp
// hotspot/src/share/oops/instanceKlass.hpp

class InstanceKlass: public Klass {
 private:
  // ç±»çš„åŸºæœ¬ä¿¡æ¯
  Symbol* _name;                    // ç±»åï¼ˆå¦‚"java/lang/String"ï¼‰
  ClassLoaderData* _class_loader_data;  // ç±»åŠ è½½å™¨
  
  // ç»§æ‰¿å…³ç³»
  InstanceKlass* _super;            // çˆ¶ç±»
  Array<InstanceKlass*>* _local_interfaces;  // å®ç°çš„æ¥å£
  Array<InstanceKlass*>* _transitive_interfaces; // æ‰€æœ‰æ¥å£
  
  // å­—æ®µå’Œæ–¹æ³•
  Array<u2>* _fields;               // å­—æ®µè¡¨
  Array<Method*>* _methods;         // æ–¹æ³•è¡¨
  Array<Method*>* _default_methods; // é»˜è®¤æ–¹æ³•ï¼ˆJava 8+ï¼‰
  
  // å¸¸é‡æ± 
  ConstantPool* _constants;         // è¿è¡Œæ—¶å¸¸é‡æ± 
  
  // è™šæ–¹æ³•è¡¨ï¼ˆç”¨äºåŠ¨æ€åˆ†å‘ï¼‰
  Array<Method*>* _vtable;          // è™šæ–¹æ³•è¡¨
  Array<Method*>* _itable;          // æ¥å£æ–¹æ³•è¡¨
  
  // å†…å­˜å¸ƒå±€ä¿¡æ¯
  int _nonstatic_field_size;        // éé™æ€å­—æ®µå¤§å°
  int _static_field_size;           // é™æ€å­—æ®µå¤§å°
  int _nonstatic_oop_map_size;      // OopMapå¤§å°ï¼ˆGCä½¿ç”¨ï¼‰
  
  // å¯¹è±¡åˆ†é…å…¥å£ï¼ˆé‡è¦ï¼ï¼‰
  instanceOop allocate_instance(TRAPS);
  
  // ...
};
```

### 2.4.3 ä»å¯¹è±¡æ‰¾åˆ°ç±»ä¿¡æ¯

```cpp
// å®é™…åœºæ™¯ï¼šGCæ‰«æå¯¹è±¡æ—¶éœ€è¦çŸ¥é“å¯¹è±¡çš„å¤§å°

// æ–¹å¼1ï¼šé€šè¿‡å¯¹è±¡ â†’ Klass â†’ å¤§å°
oop obj = ...;
Klass* k = obj->klass();
size_t size = k->size_helper();  // å¯¹è±¡å¤§å°ï¼ˆå­—ï¼‰

// æ–¹å¼2ï¼šç›´æ¥è·å–
size_t size = obj->size();  // å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨klass()->size_helper()
```

**ä¸ºä»€ä¹ˆéœ€è¦KlassæŒ‡é’ˆï¼Ÿ**
1. **ç±»å‹è¯†åˆ«**ï¼š`instanceof`ã€ç±»å‹è½¬æ¢æ£€æŸ¥
2. **æ–¹æ³•åˆ†å‘**ï¼šè™šæ–¹æ³•è°ƒç”¨é€šè¿‡vtableæŸ¥æ‰¾
3. **GCæ‰«æ**ï¼šéœ€è¦çŸ¥é“å¯¹è±¡å¤§å°ã€å“ªäº›å­—æ®µæ˜¯å¼•ç”¨
4. **åå°„æ”¯æŒ**ï¼š`Class.forName()`ç­‰

---

## 2.5 å‹ç¼©æŒ‡é’ˆï¼šèŠ‚çœå†…å­˜çš„é»‘ç§‘æŠ€

åœ¨64ä½JVMä¸­ï¼ŒæŒ‡é’ˆæœ¬åº”å 8å­—èŠ‚ï¼Œä½†JVMä½¿ç”¨äº†**å‹ç¼©æŒ‡é’ˆ**æŠ€æœ¯ï¼Œå°†å…¶å‹ç¼©åˆ°4å­—èŠ‚ï¼

### 2.5.1 å‹ç¼©æŒ‡é’ˆçš„åŸç†

**å…³é”®å‡è®¾**ï¼šå †å†…å­˜åœ°å€æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼ˆæ‰€æœ‰å¯¹è±¡åœ°å€çš„æœ€ä½3ä½éƒ½æ˜¯0ï¼‰ã€‚

```
çœŸå®åœ°å€ï¼ˆ64ä½ï¼‰ï¼š0x00007f8a4c000010
                   ^^^^^^^^^^^^^^^^
                   å®é™…åªéœ€è¦è¿™äº›ä½

å‹ç¼©è¡¨ç¤ºï¼ˆ32ä½ï¼‰ï¼š0x4c000002  (å³ç§»3ä½)
                   ^^^^^^^^
                   åªç”¨32ä½å­˜å‚¨
```

**ç¼–ç /è§£ç å…¬å¼**ï¼š
```cpp
// hotspot/src/share/oops/compressedOops.hpp

// å‹ç¼©ï¼ˆå­˜å‚¨åˆ°å †ä¸­ï¼‰
narrowOop encode(oop obj) {
  uintptr_t addr = (uintptr_t)obj;
  return (narrowOop)((addr - _heap_base) >> LogMinObjAlignmentInBytes);
}

// è§£å‹ï¼ˆä»å †ä¸­è¯»å–ï¼‰
oop decode(narrowOop narrow_oop) {
  return (oop)(((uintptr_t)narrow_oop << LogMinObjAlignmentInBytes) + _heap_base);
}

// LogMinObjAlignmentInBytes = 3  (8å­—èŠ‚å¯¹é½ = 2^3)
// _heap_base: å †çš„èµ·å§‹åœ°å€
```

### 2.5.2 å‹ç¼©èŒƒå›´é™åˆ¶

å‹ç¼©æŒ‡é’ˆæœ€å¤šè¡¨ç¤º **32GB** çš„å †å†…å­˜ï¼š

```
32ä½ Ã— 8å­—èŠ‚å¯¹é½ = 2^32 Ã— 2^3 = 2^35 = 32GB
```

**è¶…è¿‡32GBæ€ä¹ˆåŠï¼Ÿ**
- è‡ªåŠ¨ç¦ç”¨å‹ç¼©æŒ‡é’ˆ
- å¯¹è±¡å¤´å˜å¤§ï¼ˆ12å­—èŠ‚ â†’ 16å­—èŠ‚ï¼‰
- å†…å­˜å ç”¨å¢åŠ çº¦30%

**æŸ¥çœ‹æ˜¯å¦å¯ç”¨å‹ç¼©æŒ‡é’ˆ**ï¼š
```bash
java -XX:+PrintFlagsFinal -version | grep UseCompressedOops
# UseCompressedOops = true  (é»˜è®¤å¯ç”¨ï¼Œå †<32GBæ—¶)
```

### 2.5.3 å‹ç¼©æŒ‡é’ˆçš„æ€§èƒ½å½±å“

**å†…å­˜èŠ‚çœ**ï¼š
```
8GBå †ï¼Œ100ä¸‡ä¸ªå¯¹è±¡ï¼š
  ä¸å‹ç¼©ï¼šå¯¹è±¡å¤´16å­—èŠ‚ Ã— 100ä¸‡ = 16MB
  å‹ç¼©ï¼š  å¯¹è±¡å¤´12å­—èŠ‚ Ã— 100ä¸‡ = 12MB
  èŠ‚çœï¼š4MB (25%)
```

**CPUå¼€é”€**ï¼š
- æ¯æ¬¡è®¿é—®å¯¹è±¡å­—æ®µéƒ½éœ€è¦è§£å‹ï¼ˆåŠ æ³•+ç§»ä½ï¼‰
- ä½†ç°ä»£CPUå¾ˆå¿«ï¼Œé€šå¸¸å¯å¿½ç•¥
- å†…å­˜èŠ‚çœå¸¦æ¥çš„ç¼“å­˜å‘½ä¸­ç‡æå‡æ›´é‡è¦

---

## 2.6 å¯¹è±¡åˆ›å»ºæµç¨‹ï¼šä»newåˆ°å†…å­˜ â­ GDBéªŒè¯

è®©æˆ‘ä»¬è¿½è¸ªä¸€æ¬¡å®Œæ•´çš„å¯¹è±¡åˆ›å»ºæµç¨‹ï¼Œ**åŸºäºGDBå®é™…è°ƒè¯•éªŒè¯**ï¼š

```java
// HelloWorld.java
public class HelloWorld {
    public static void main(String[] args) {
        HelloWorld obj = new HelloWorld();
    }
}
```

**ç¼–è¯‘åå­—èŠ‚ç **ï¼š
```
  public static void main(java.lang.String[]);
    Code:
      stack=2, locals=2, args_size=1
         0: new           #2    // class HelloWorld
         3: dup
         4: invokespecial #3    // Method "<init>":()V
         7: astore_1
         8: return
```

### 2.6.1 å¯¹è±¡åˆ›å»ºå®Œæ•´æµç¨‹å›¾ (GDBéªŒè¯)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    new HelloWorld() æ‰§è¡Œæµç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  å­—èŠ‚ç : bb 00 02 (new #2)                                          â”‚
â”‚          â”‚                                                          â”‚
â”‚          â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Stage 1: InterpreterRuntime::_new       â”‚ è§£é‡Šå™¨å…¥å£              â”‚
â”‚  â”‚ - pool=0x7fffcefa6058, index=2          â”‚                        â”‚
â”‚  â”‚ - è§£æå¸¸é‡æ±  â†’ HelloWorld InstanceKlass  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Stage 2: InstanceKlass::allocate_instanceâ”‚ åˆ†é…å…¥å£               â”‚
â”‚  â”‚ - klass=0x800092840 (HelloWorld)        â”‚                        â”‚
â”‚  â”‚ - _layout_helper=16 bytes               â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Stage 3: CollectedHeap::obj_allocate    â”‚ å †åˆ†é…                  â”‚
â”‚  â”‚ - size=2 words (16 bytes)               â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Stage 4: MemAllocator::allocate         â”‚ å†…å­˜åˆ†é…å™¨              â”‚
â”‚  â”‚ - TLABå¿«é€Ÿåˆ†é… (bump-the-pointer)       â”‚                        â”‚
â”‚  â”‚ - è¿”å›å¯¹è±¡åœ°å€: 0x7ff41f2b0             â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚               â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Stage 5: å¯¹è±¡åˆå§‹åŒ–                      â”‚ è®¾ç½®å¯¹è±¡å¤´              â”‚
â”‚  â”‚ - mark word = 0x5 (åå‘é”å¯ç”¨)          â”‚                        â”‚
â”‚  â”‚ - compressed klass = 0x92840            â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚               â–¼                                                     â”‚
â”‚  å­—èŠ‚ç : b7 00 03 (invokespecial #3)                                â”‚
â”‚  è°ƒç”¨ <init> æ„é€ å‡½æ•°                                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6.2 Stage 1: InterpreterRuntime::_new (GDBéªŒè¯)

**GDBéªŒè¯æ•°æ®**ï¼š
```
pool (ConstantPool): 0x7fffcefa6058
index: 2 (å¸¸é‡æ± ç´¢å¼•)
thread: 0x7ffff001f000

å¸¸é‡æ± è§£æ:
  CP#2 = Class HelloWorld
  â†’ è§£æä¸º InstanceKlass* 0x800092840
```

**è°ƒç”¨æ ˆ**ï¼š
```
#0  InterpreterRuntime::_new (thread=0x7ffff001f000, pool=0x7fffcefa6058, index=2)
    at interpreterRuntime.cpp:217
#1  0x00007fffed020909 in ?? ()  â† è§£é‡Šå™¨æ¨¡æ¿ä»£ç 
```

**æºç åˆ†æ**ï¼š
```cpp
// hotspot/src/share/interpreter/bytecodeInterpreter.cpp

CASE(_new): {
  u2 index = Bytes::get_Java_u2(pc+1);
  ConstantPool* constants = METHOD->constants();
  
  // è§£æç±»ç¬¦å·å¼•ç”¨
  Klass* entry = constants->klass_at(index, CHECK);
  InstanceKlass* ik = InstanceKlass::cast(entry);
  
  // ç¡®ä¿ç±»å·²åˆå§‹åŒ–
  ik->check_valid_for_instantiation(true, CHECK);
  
  // åˆ†é…å¯¹è±¡ï¼
  oop obj = ik->allocate_instance(CHECK);
  
  // æ¨å…¥æ“ä½œæ•°æ ˆ
  SET_STACK_OBJECT(obj, 0);
}
```

### 2.6.3 Stage 2: InstanceKlass::allocate_instance (GDBéªŒè¯)

**GDBéªŒè¯æ•°æ®**ï¼š
```
InstanceKlass: 0x800092840
ç±»å: HelloWorld
_layout_helper: 16 bytes (å¯¹è±¡å®ä¾‹å¤§å°)
_vtable_len: 5
_access_flags: 0x20000021 (ACC_PUBLIC | ACC_SUPER)
_super: 0x800001040 (java/lang/Object)
_nonstatic_field_size: 0 words
_init_state: 4 (fully_initialized)
```

**å¯¹è±¡å¤§å°è®¡ç®—**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HelloWorldå¯¹è±¡å†…å­˜å¸ƒå±€ (16 bytes)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [0-7]   mark word          8 bytes                       â”‚
â”‚ [8-11]  compressed klass   4 bytes                       â”‚
â”‚ [12-15] padding            4 bytes (å¯¹é½åˆ°8å­—èŠ‚)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: 16 bytes = 2 words                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¡ç®—å…¬å¼:
_layout_helper = header_size + field_size + padding
              = 12 + 0 + 4 = 16 bytes
```

**æºç åˆ†æ**ï¼š
```cpp
// hotspot/src/share/oops/instanceKlass.cpp

instanceOop InstanceKlass::allocate_instance(TRAPS) {
  int size = size_helper();  // ä»_layout_helperè·å–
  
  // å°è¯•åœ¨TLABä¸­åˆ†é…ï¼ˆThread Local Allocation Bufferï¼‰
  HeapWord* obj = THREAD->tlab().allocate(size);
  
  if (obj != NULL) {
    // TLABåˆ†é…æˆåŠŸï¼ˆå¿«é€Ÿè·¯å¾„ï¼Œæ— é”ï¼‰
    return (instanceOop)obj;
  }
  
  // TLABæ»¡äº†ï¼Œèµ°æ…¢é€Ÿè·¯å¾„
  return allocate_instance_slow(size, CHECK_NULL);
}
```

### 2.6.4 Stage 3-4: TLABåˆ†é… (GDBéªŒè¯) â­

**TLAB (Thread Local Allocation Buffer)** æ˜¯JVMä¸­æœ€é‡è¦çš„ä¼˜åŒ–ä¹‹ä¸€ã€‚

**GDBéªŒè¯æ•°æ®**ï¼š
```
=== TLABçŠ¶æ€ (åˆ†é…å‰) ===
ThreadLocalAllocBuffer: 0x7ffff001f128
_start: 0x7ff400800 (TLABèµ·å§‹)
_top: 0x7ff41f2b0 (ä¸‹æ¬¡åˆ†é…ä½ç½®)
_end: 0x7ff6005c0 (TLABç»“æŸ)
TLABå¤§å°: 2,096,576 bytes (~2MB)
å·²ä½¿ç”¨: 125,616 bytes
å‰©ä½™: 1,970,960 bytes

éœ€è¦åˆ†é…: 16 bytes
åˆ†é…ç­–ç•¥: TLABå¿«é€Ÿåˆ†é… (bump-the-pointer)

=== TLABçŠ¶æ€ (åˆ†é…å) ===
_top: 0x7ff41f2c0 (å¢åŠ 16å­—èŠ‚)
å¯¹è±¡åœ°å€: 0x7ff41f2b0 (åŸ_topä½ç½®)
```

**TLABåˆ†é…ç®—æ³•å›¾ç¤º**ï¼š
```
åˆ†é…å‰:
  _start                    _top                    _end
    â”‚                        â”‚                        â”‚
    â–¼                        â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å·²åˆ†é…å¯¹è±¡            â”‚       ç©ºé—²ç©ºé—´         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†é…16å­—èŠ‚:
  _start                    åŸ_top  æ–°_top          _end
    â”‚                        â”‚       â”‚               â”‚
    â–¼                        â–¼       â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å·²åˆ†é…å¯¹è±¡            â”‚ æ–°obj â”‚   ç©ºé—²ç©ºé—´    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â””â”€ 0x7ff41f2b0 (è¿”å›åœ°å€)

åˆ†é…æ“ä½œ (ä»…éœ€2æ¡æŒ‡ä»¤):
1. result = _top;           // 0x7ff41f2b0
2. _top = _top + size;      // 0x7ff41f2c0
3. return result;
```

**TLABå¿«é€Ÿåˆ†é…æºç **ï¼š
```cpp
// hotspot/src/share/gc/shared/threadLocalAllocBuffer.inline.hpp

inline HeapWord* ThreadLocalAllocBuffer::allocate(size_t size) {
  HeapWord* obj = top();
  
  if (pointer_delta(end(), obj) >= size) {
    // TLABæœ‰è¶³å¤Ÿç©ºé—´
    set_top(obj + size);  // ç§»åŠ¨topæŒ‡é’ˆï¼ˆä»…ä¸€æ¡æŒ‡ä»¤ï¼ï¼‰
    return obj;
  }
  
  return NULL;  // TLABä¸å¤Ÿï¼Œè¿”å›NULL
}
```

**TLABåˆ†é…çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **æ— é”**ï¼šæ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œæ— éœ€ç«äº‰
- **æå¿«**ï¼šä»…ä¸€æ¡æŒ‡é’ˆç§»åŠ¨æŒ‡ä»¤ï¼ˆ~10nsï¼‰
- **å‡å°‘ç¢ç‰‡**ï¼šæ‰¹é‡ä»å †ä¸­ç”³è¯·TLAB

### 2.6.5 Stage 5: å¯¹è±¡å¤´åˆå§‹åŒ– (GDBéªŒè¯) â­

**GDBéªŒè¯çš„å¯¹è±¡å¤´**ï¼š
```
å¯¹è±¡åœ°å€: 0x7ff41f2b0

=== å¯¹è±¡å¤´ (Object Header) ===
mark word (8å­—èŠ‚): 0x0000000000000005
  é”çŠ¶æ€ä½ (bit 0-2): 0x5 (åå‘é”å¯ç”¨)

compressed klass ptr (4å­—èŠ‚): 0x00092840
  å‹ç¼©ç±»æŒ‡é’ˆ: 0x92840
  è§£å‹å: 0x800092840 (HelloWorld InstanceKlass)

å¯¹è±¡æ€»å¤§å°: 16 bytes
  - header: 12 bytes (mark 8 + klass 4)
  - fields: 0 bytes
  - padding: 4 bytes
```

**GDBå†…å­˜æŸ¥çœ‹**ï¼š
```bash
# æŸ¥çœ‹å®Œæ•´å¯¹è±¡ (16å­—èŠ‚)
(gdb) x/2gx 0x7ff41f2b0
0x7ff41f2b0: 0x0000000000000005  0x0000000000092840
              â””â”€ mark word        â””â”€ klass + padding

# å•ç‹¬æŸ¥çœ‹mark word
(gdb) x/1gx 0x7ff41f2b0
0x0000000000000005

# å•ç‹¬æŸ¥çœ‹compressed klass
(gdb) x/1wx 0x7ff41f2b0+8
0x00092840
```

**Mark Wordè¯¦è§£ (0x5)**ï¼š
```
mark word = 0x0000000000000005

äºŒè¿›åˆ¶: 0000...0000 0101
                     ^^^
                     â”‚â”‚â”‚
                     â”‚â”‚â”‚â”€ bit 0: 1 (lock)
                     â”‚â”‚â”€â”€â”€ bit 1: 0 (unused)
                     â”‚â”€â”€â”€â”€ bit 2: 1 (biased_lock)

ç»„åˆ: 101 = åå‘é”å¯ç”¨çŠ¶æ€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0x0000000000000005 è§£æ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ thread_id: 0 (æœªåå‘ä»»ä½•çº¿ç¨‹)                                       â”‚
â”‚ epoch: 0                                                           â”‚
â”‚ age: 0 (GCå¹´é¾„)                                                    â”‚
â”‚ biased_lock: 1 (åå‘é”æ ‡å¿—ä½)                                       â”‚
â”‚ lock: 01                                                           â”‚
â”‚                                                                    â”‚
â”‚ çŠ¶æ€: å¯åå‘ï¼Œä½†å°šæœªåå‘ä»»ä½•çº¿ç¨‹                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‹ç¼©ç±»æŒ‡é’ˆè§£å‹**ï¼š
```
å­˜å‚¨å€¼ (4å­—èŠ‚): 0x00092840

è§£å‹è®¡ç®—:
  base = CompressedKlassPointers::base = 0x800000000
  shift = 0

  real_klass = base + compressed_klass
             = 0x800000000 + 0x92840
             = 0x800092840

éªŒè¯:
  0x800092840 = HelloWorld InstanceKlass åœ°å€ âœ“
```

**å¯¹è±¡å¤´åˆå§‹åŒ–æºç **ï¼š
```cpp
// hotspot/src/share/oops/oop.inline.hpp

void oopDesc::init_mark() {
  // è®¾ç½®Mark Wordä¸ºæ— é”çŠ¶æ€
  set_mark(markOopDesc::prototype());
}

void oopDesc::set_klass(Klass* k) {
  // è®¾ç½®KlassæŒ‡é’ˆ
  if (UseCompressedClassPointers) {
    _metadata._compressed_klass = encode_klass(k);
  } else {
    _metadata._klass = k;
  }
}
```

### 2.6.6 å®Œæ•´è°ƒç”¨æ ˆ (GDBéªŒè¯)

```
#0  InterpreterRuntime::_new
    â”‚  è§£é‡Šå™¨newå­—èŠ‚ç å…¥å£
    â”‚  pool=0x7fffcefa6058, index=2
    â”‚
    â”œâ”€â”€â–º InstanceKlass::allocate_instance
    â”‚    â”‚  this=0x800092840 (HelloWorld)
    â”‚    â”‚
    â”‚    â”œâ”€â”€â–º CollectedHeap::obj_allocate
    â”‚    â”‚    â”‚  klass=0x800092840, size=2 words
    â”‚    â”‚    â”‚
    â”‚    â”‚    â”œâ”€â”€â–º MemAllocator::allocate
    â”‚    â”‚    â”‚    â”‚  _klass=0x800092840, _word_size=2
    â”‚    â”‚    â”‚    â”‚
    â”‚    â”‚    â”‚    â”œâ”€â”€â–º MemAllocator::mem_allocate
    â”‚    â”‚    â”‚    â”‚    â”‚
    â”‚    â”‚    â”‚    â”‚    â””â”€â”€â–º allocate_inside_tlab
    â”‚    â”‚    â”‚    â”‚         â”‚  TLAB bump-the-pointer
    â”‚    â”‚    â”‚    â”‚         â””â”€â”€â–º è¿”å› HeapWord* 0x7ff41f2b0
    â”‚    â”‚    â”‚    â”‚
    â”‚    â”‚    â”‚    â””â”€â”€â–º ObjAllocator::initialize
    â”‚    â”‚    â”‚         â”‚  mem=0x7ff41f2b0
    â”‚    â”‚    â”‚         â”œâ”€â”€â–º mem_clear (æ¸…é›¶å­—æ®µ)
    â”‚    â”‚    â”‚         â””â”€â”€â–º finish (è®¾ç½®å¯¹è±¡å¤´)
    â”‚    â”‚    â”‚              â””â”€â”€â–º è¿”å› oop 0x7ff41f2b0
    â”‚    â”‚    â”‚
    â”‚    â”‚    â””â”€â”€â–º è¿”å› oop 0x7ff41f2b0
    â”‚    â”‚
    â”‚    â””â”€â”€â–º è¿”å› instanceOop 0x7ff41f2b0
    â”‚
    â””â”€â”€â–º thread->set_vm_result(obj)
         å°†å¯¹è±¡å¼•ç”¨æ”¾å…¥è§£é‡Šå™¨æ ˆé¡¶
```

### 2.6.7 G1å †å†…å­˜å¸ƒå±€ (GDBéªŒè¯)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœ°å€ç©ºé—´åˆ†å¸ƒ (8GBå †)                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x600000000 â”€â”€â”€â”€â”€â”€â”€ Javaå †èµ·å§‹                                      â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚ Eden Region (TLABæ‰€åœ¨)                                       â”‚
â”‚      â”‚   â”œâ”€â”€ 0x7ff400800 TLAB._start                                â”‚
â”‚      â”‚   â”œâ”€â”€ 0x7ff41f2b0 HelloWorldå¯¹è±¡                             â”‚
â”‚      â”‚   â””â”€â”€ 0x7ff6005c0 TLAB._end                                  â”‚
â”‚      â”‚                                                              â”‚
â”‚ 0x800000000 â”€â”€â”€â”€â”€â”€â”€ Javaå †ç»“æŸ / Compressed Class Spaceèµ·å§‹         â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚ InstanceKlass                                                â”‚
â”‚      â”‚   â””â”€â”€ 0x800092840 HelloWorld InstanceKlass                   â”‚
â”‚      â”‚                                                              â”‚
â”‚ 0x840000000 â”€â”€â”€â”€â”€â”€â”€ Compressed Class Spaceç»“æŸ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x7fffcxxxxxxx â”€â”€â”€ Metaspace Non-class                              â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚   â”œâ”€â”€ 0x7fffcefa6058 ConstantPool                            â”‚
â”‚      â”‚   â””â”€â”€ 0x7fffcefa62c0 CPCache                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x7fffedxxxxxx â”€â”€â”€ CodeCache                                        â”‚
â”‚      â”‚                                                              â”‚
â”‚      â”‚   â””â”€â”€ è§£é‡Šå™¨æ¨¡æ¿ä»£ç                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2.7 å¯¹è±¡å†…å­˜å¸ƒå±€å®ä¾‹

### ç¤ºä¾‹1ï¼šç®€å•å¯¹è±¡

```java
class Point {
    int x;  // 4å­—èŠ‚
    int y;  // 4å­—èŠ‚
}
```

**å†…å­˜å¸ƒå±€ï¼ˆ64ä½JVMï¼Œå‹ç¼©æŒ‡é’ˆï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mark Word (8å­—èŠ‚)      â”‚  åç§»0
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KlassæŒ‡é’ˆ (4å­—èŠ‚)      â”‚  åç§»8
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int x (4å­—èŠ‚)          â”‚  åç§»12
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int y (4å­—èŠ‚)          â”‚  åç§»16
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¯¹é½å¡«å…… (4å­—èŠ‚)       â”‚  åç§»20
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»å¤§å°: 24å­—èŠ‚ (8çš„å€æ•°)
```

### ç¤ºä¾‹2ï¼šåŒ…å«å¼•ç”¨çš„å¯¹è±¡

```java
class User {
    int age;           // 4å­—èŠ‚
    String name;       // 4å­—èŠ‚ï¼ˆå‹ç¼©æŒ‡é’ˆï¼‰
    Address address;   // 4å­—èŠ‚ï¼ˆå‹ç¼©æŒ‡é’ˆï¼‰
}
```

**å†…å­˜å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mark Word (8å­—èŠ‚)      â”‚  åç§»0
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KlassæŒ‡é’ˆ (4å­—èŠ‚)      â”‚  åç§»8
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int age (4å­—èŠ‚)        â”‚  åç§»12
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ String name (4å­—èŠ‚)    â”‚  åç§»16  â”€â”€â”€â”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚ Address address (4å­—èŠ‚)â”‚  åç§»20  â”€â”€â”€â”¼â”€â”€â†’ æŒ‡å‘å…¶ä»–å¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
æ€»å¤§å°: 24å­—èŠ‚                          â”‚
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â–¼
Stringå¯¹è±¡ï¼ˆåœ¨å †çš„å…¶ä»–ä½ç½®ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mark Word (8å­—èŠ‚)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KlassæŒ‡é’ˆ (4å­—èŠ‚)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ char[] value (4å­—èŠ‚)   â”‚ â”€â”€â”€â†’ å­—ç¬¦æ•°ç»„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int hash (4å­—èŠ‚)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2.8 æ•°ç»„å¯¹è±¡çš„ç‰¹æ®Šæ€§

æ•°ç»„å¯¹è±¡æ¯”æ™®é€šå¯¹è±¡å¤šä¸€ä¸ª**æ•°ç»„é•¿åº¦å­—æ®µ**ï¼ˆ4å­—èŠ‚ï¼‰ã€‚

```java
int[] array = new int[100];
```

**å†…å­˜å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mark Word (8å­—èŠ‚)      â”‚  åç§»0
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ KlassæŒ‡é’ˆ (4å­—èŠ‚)      â”‚  åç§»8
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°ç»„é•¿åº¦ (4å­—èŠ‚)       â”‚  åç§»12  â† é¢å¤–çš„é•¿åº¦å­—æ®µï¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int[0] (4å­—èŠ‚)         â”‚  åç§»16
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int[1] (4å­—èŠ‚)         â”‚  åç§»20
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ...             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ int[99] (4å­—èŠ‚)        â”‚  åç§»412
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»å¤§å°: 416å­—èŠ‚
```

**æºç è¡¨ç¤º**ï¼š
```cpp
// hotspot/src/share/oops/arrayOop.hpp

class arrayOopDesc : public oopDesc {
 private:
  int _length;  // æ•°ç»„é•¿åº¦ï¼ˆåœ¨å¯¹è±¡å¤´ä¹‹åï¼‰
  
 public:
  int length() const { return _length; }
  
  // æ•°ç»„å…ƒç´ èµ·å§‹åœ°å€
  void* base(BasicType type) const {
    return (void*) (((intptr_t)this) + base_offset_in_bytes(type));
  }
};
```

---

## 2.9 å¯¹è±¡å¤§å°è®¡ç®—

### è®¡ç®—å…¬å¼

```
å¯¹è±¡å¤§å° = å¯¹è±¡å¤´ + å®ä¾‹æ•°æ® + å¯¹é½å¡«å……

å¯¹è±¡å¤´å¤§å°:
  - æ™®é€šå¯¹è±¡: 12å­—èŠ‚ (Mark Word 8 + Klass 4ï¼Œå‹ç¼©æ—¶)
  - æ•°ç»„å¯¹è±¡: 16å­—èŠ‚ (Mark Word 8 + Klass 4 + length 4)

å¯¹é½: å‘ä¸Šå–æ•´åˆ°8çš„å€æ•°
```

### æºç å®ç°

```cpp
// hotspot/src/share/oops/instanceKlass.hpp

int InstanceKlass::size_helper() const {
  return align_object_size(layout_helper_to_size_helper(layout_helper()));
}

// å‘ä¸Šå¯¹é½åˆ°8å­—èŠ‚
static int align_object_size(int size) {
  return (size + MinObjAlignmentInBytes - 1) & ~(MinObjAlignmentInBytes - 1);
}
```

### å®ç”¨å·¥å…·ï¼šè®¡ç®—å¯¹è±¡å¤§å°

å¯ä»¥ä½¿ç”¨JOLï¼ˆJava Object Layoutï¼‰å·¥å…·ï¼š

```bash
# æ·»åŠ ä¾èµ–
<dependency>
    <groupId>org.openjdk.jol</groupId>
    <artifactId>jol-core</artifactId>
    <version>0.16</version>
</dependency>
```

```java
import org.openjdk.jol.info.ClassLayout;

class Point {
    int x, y;
}

public class ObjectSizeTest {
    public static void main(String[] args) {
        System.out.println(ClassLayout.parseClass(Point.class).toPrintable());
    }
}
```

**è¾“å‡º**ï¼š
```
Point object internals:
 OFFSET  SIZE   TYPE DESCRIPTION
      0    12        (object header)      # Mark Word(8) + Klass(4)
     12     4    int Point.x
     16     4    int Point.y
     20     4        (loss due to alignment)
Instance size: 24 bytes
```

---

## 2.10 å¯¹è±¡æ¨¡å‹ä¸GCçš„å…³ç³»

ç†è§£å¯¹è±¡æ¨¡å‹å¯¹ç†è§£G1è‡³å…³é‡è¦ï¼š

### 2.10.1 Mark Wordä¸­çš„GCå¹´é¾„

```cpp
// G1åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ™‹å‡åˆ°è€å¹´ä»£

void G1ParScanThreadState::age_and_push_reference(oop obj) {
  markOop m = obj->mark();
  int age = m->age();  // ä»Mark Wordè¯»å–å¹´é¾„
  
  if (age < _tenuring_threshold) {
    // å¹´é¾„+1ï¼Œç•™åœ¨å¹´è½»ä»£
    obj->set_mark(m->incr_age());
    copy_to_survivor_space(obj);
  } else {
    // å¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼Œæ™‹å‡åˆ°è€å¹´ä»£
    copy_to_old_gen(obj);
  }
}
```

### 2.10.2 KlassæŒ‡é’ˆä¸å¯¹è±¡æ‰«æ

```cpp
// G1æ‰«æå¯¹è±¡æ—¶éœ€è¦çŸ¥é“å“ªäº›å­—æ®µæ˜¯å¼•ç”¨

void G1ParScanClosure::do_oop(oop* p) {
  oop obj = oopDesc::load_decode_heap_oop(p);
  if (obj == NULL) return;
  
  // é€šè¿‡Klassè·å–å¯¹è±¡çš„OopMapï¼ˆå¼•ç”¨å­—æ®µä½å›¾ï¼‰
  InstanceKlass* ik = InstanceKlass::cast(obj->klass());
  OopMapBlock* map = ik->start_of_nonstatic_oop_maps();
  
  // éå†æ‰€æœ‰å¼•ç”¨å­—æ®µ
  for (int i = 0; i < ik->nonstatic_oop_map_count(); i++) {
    // å¤„ç†å¼•ç”¨...
  }
}
```

### 2.10.3 å¯¹è±¡å¤§å°ä¸Regionåˆ†é…

```cpp
// G1æ ¹æ®å¯¹è±¡å¤§å°å†³å®šåˆ†é…ç­–ç•¥

oop G1CollectedHeap::allocate_new_tlab(size_t word_size) {
  size_t humongous_threshold = HeapRegion::GrainWords / 2;
  
  if (word_size >= humongous_threshold) {
    // å¤§å¯¹è±¡ï¼ˆâ‰¥ Regionå¤§å°çš„50%ï¼‰
    return allocate_humongous_object(word_size);
  } else {
    // æ™®é€šå¯¹è±¡ï¼Œåœ¨TLABä¸­åˆ†é…
    return allocate_from_tlab(word_size);
  }
}
```

---

## 2.11 æœ¬ç« å°ç»“

âœ… **å¯¹è±¡ = å¯¹è±¡å¤´ + å®ä¾‹æ•°æ® + å¯¹é½å¡«å……**  
âœ… **å¯¹è±¡å¤´ = Mark Word (8B) + KlassæŒ‡é’ˆ (4Bå‹ç¼©)**  
âœ… **Mark Wordå­˜å‚¨**ï¼šGCå¹´é¾„ã€é”çŠ¶æ€ã€å“ˆå¸Œç   
âœ… **KlassæŒ‡é’ˆæŒ‡å‘ç±»å…ƒæ•°æ®**ï¼šæ–¹æ³•è¡¨ã€å­—æ®µè¡¨ã€ç±»å‹ä¿¡æ¯  
âœ… **å‹ç¼©æŒ‡é’ˆèŠ‚çœå†…å­˜**ï¼šå †<32GBæ—¶ï¼ŒæŒ‡é’ˆ4å­—èŠ‚  
âœ… **TLABå¿«é€Ÿåˆ†é…**ï¼šæ— é”ã€çº¿ç¨‹ç§æœ‰ã€ç§»åŠ¨æŒ‡é’ˆ  
âœ… **å¯¹è±¡å¤§å°å½±å“GC**ï¼šå¤§å¯¹è±¡ç‰¹æ®Šå¤„ç†ï¼ˆHumongousï¼‰  

### â­ GDBéªŒè¯æ•°æ®æ€»ç»“

| é˜¶æ®µ | å…³é”®æ•°æ® | GDBéªŒè¯å€¼ |
|------|----------|-----------|
| å¸¸é‡æ± è§£æ | ConstantPool | `0x7fffcefa6058` |
| ç±»å…ƒæ•°æ® | InstanceKlass | `0x800092840` |
| å¯¹è±¡å¤§å° | _layout_helper | 16 bytes |
| TLABåˆ†é… | _topå˜åŒ– | `0x7ff41f2b0 â†’ 0x7ff41f2c0` |
| å¯¹è±¡åœ°å€ | oop | `0x7ff41f2b0` |
| Mark Word | åˆå§‹å€¼ | `0x5` (åå‘é”å¯ç”¨) |
| KlassæŒ‡é’ˆ | å‹ç¼©å€¼ | `0x92840` |

### GDBè°ƒè¯•å‘½ä»¤å‚è€ƒ

```bash
# è¿›å…¥è°ƒè¯•
cd /path/to/openjdk11/build/.../jdk/bin
gdb ./java

# è®¾ç½®æ–­ç‚¹
break InterpreterRuntime::_new
break InstanceKlass::allocate_instance
break MemAllocator::mem_allocate

# è¿è¡Œ
run -Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint -cp /path/to HelloWorld

# æŸ¥çœ‹TLAB
set $thread = (Thread*)thread
set $tlab = &($thread->_tlab)
print $tlab->_top

# æŸ¥çœ‹å¯¹è±¡å¤´
set $obj = <å¯¹è±¡åœ°å€>
x/1gx $obj        # mark word
x/1wx $obj+8      # compressed klass

# éªŒè¯ç±»æŒ‡é’ˆ
set $cklass = *(unsigned int*)($obj+8)
print/x $cklass + 0x800000000  # è§£å‹
```

**å…³é”®æºç æ–‡ä»¶**ï¼š
- `hotspot/src/share/oops/oop.hpp` - å¯¹è±¡æŒ‡é’ˆ
- `hotspot/src/share/oops/markOop.hpp` - Mark Word
- `hotspot/src/share/oops/instanceKlass.hpp` - ç±»å…ƒæ•°æ®
- `hotspot/src/share/gc/shared/threadLocalAllocBuffer.hpp` - TLAB
- `hotspot/src/share/gc/shared/memAllocator.cpp` - å†…å­˜åˆ†é…å™¨

---

## ä¸‹ä¸€ç« é¢„å‘Š

[**ç¬¬3ç« ï¼šç±»åŠ è½½æœºåˆ¶**](./03-ç±»åŠ è½½æœºåˆ¶.md) å°†å›ç­”ï¼š
- `.class`æ–‡ä»¶å¦‚ä½•è¢«è§£ææˆKlassï¼Ÿ
- åŒäº²å§”æ´¾æ¨¡å‹åœ¨æºç ä¸­å¦‚ä½•å®ç°ï¼Ÿ
- ç±»åˆå§‹åŒ–çš„`<clinit>`æ˜¯ä½•æ—¶æ‰§è¡Œçš„ï¼Ÿ
- æ¨¡å—ç³»ç»Ÿï¼ˆJava 9+ï¼‰å¦‚ä½•å·¥ä½œï¼Ÿ

---

## ğŸ“– æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆå¯¹è±¡è¦8å­—èŠ‚å¯¹é½ï¼Ÿ**  
   æç¤ºï¼šCPUç¼“å­˜è¡Œå¤§å°

2. **å¦‚æœå †å†…å­˜æ˜¯40GBï¼Œå‹ç¼©æŒ‡é’ˆè¿˜èƒ½ç”¨å—ï¼Ÿ**  
   æç¤ºï¼š32GBé™åˆ¶

3. **TLABä¸ºä»€ä¹ˆèƒ½æå‡åˆ†é…æ€§èƒ½ï¼Ÿ**  
   æç¤ºï¼šæ— é”ã€æ‰¹é‡ç”³è¯·

4. **Mark Wordä¸ºä»€ä¹ˆè¦è®¾è®¡å¾—è¿™ä¹ˆå¤æ‚ï¼Ÿ**  
   æç¤ºï¼šå¤ç”¨ç©ºé—´ï¼Œä¸åŒçŠ¶æ€å­˜å‚¨ä¸åŒä¿¡æ¯

ï¼ˆç¬¬14ç« ä¼šè¯¦ç»†è®²è§£é”çš„å®ç°ï¼‰
