# ç¬¬4ç« ï¼šè§£é‡Šå™¨ - å­—èŠ‚ç æ‰§è¡Œå¼•æ“

> **æœ¬ç« å¯¼è¯»**ï¼šç±»åŠ è½½å®Œæˆåï¼Œå­—èŠ‚ç æ˜¯å¦‚ä½•å˜æˆæœºå™¨æŒ‡ä»¤çš„ï¼Ÿæœ¬ç« æ·±å…¥HotSpotè§£é‡Šå™¨çš„å®ç°æœºåˆ¶ï¼Œæ­ç¤ºæ¨¡æ¿è§£é‡Šå™¨çš„è®¾è®¡ç²¾é«“ã€‚

---

## 4.1 è§£é‡Šå™¨æ¦‚è¿°

### 4.1.1 ä»€ä¹ˆæ˜¯è§£é‡Šå™¨ï¼Ÿ

**è§£é‡Šå™¨**æ˜¯JVMæ‰§è¡Œå­—èŠ‚ç çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œè´Ÿè´£é€æ¡è§£é‡Šæ‰§è¡ŒJavaå­—èŠ‚ç ã€‚åœ¨JITç¼–è¯‘å™¨ä»‹å…¥å‰ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½ç”±è§£é‡Šå™¨æ‰§è¡Œã€‚

```
Javaæºç  â†’ javac â†’ å­—èŠ‚ç  â†’ è§£é‡Šå™¨ â†’ æœºå™¨æŒ‡ä»¤
```

### 4.1.2 ä¸ºä»€ä¹ˆéœ€è¦è§£é‡Šå™¨ï¼Ÿ

1. **å¿«é€Ÿå¯åŠ¨**ï¼šæ— éœ€ç­‰å¾…ç¼–è¯‘ï¼Œç«‹å³æ‰§è¡Œ
2. **ä»£ç è¦†ç›–**ï¼šå¤„ç†ä¸é€‚åˆç¼–è¯‘çš„ä»£ç ï¼ˆå¦‚åå°„ã€åŠ¨æ€ä»£ç†ï¼‰
3. **çƒ­ç‚¹æ¢æµ‹**ï¼šæ”¶é›†æ–¹æ³•è°ƒç”¨æ¬¡æ•°ï¼Œä¸ºJITæä¾›ä¾æ®
4. **å†…å­˜èŠ‚çº¦**ï¼šé¿å…ç¼–è¯‘æ‰€æœ‰ä»£ç 

### 4.1.3 HotSpotçš„è§£é‡Šå™¨ç±»å‹

HotSpotæ”¯æŒä¸¤ç§è§£é‡Šå™¨ï¼š

| è§£é‡Šå™¨ç±»å‹ | å®ç°æ–¹å¼ | æ€§èƒ½ | ä½¿ç”¨åœºæ™¯ |
|---------|---------|------|---------|
| **æ¨¡æ¿è§£é‡Šå™¨** | é¢„ç”Ÿæˆæ±‡ç¼–ä»£ç  | é«˜ï¼ˆæ¥è¿‘ç¼–è¯‘ä»£ç ï¼‰ | é»˜è®¤ä½¿ç”¨ |
| **C++è§£é‡Šå™¨** | C++æ¨¡æ‹Ÿæ‰§è¡Œ | ä½ï¼ˆä½†å¯ç§»æ¤ï¼‰ | Zero VM |

**æœ¬ç« é‡ç‚¹**ï¼š**æ¨¡æ¿è§£é‡Šå™¨**ï¼ˆTemplateInterpreterï¼‰

---

## 4.2 æ¨¡æ¿è§£é‡Šå™¨çš„è®¾è®¡ç†å¿µ

### 4.2.1 ä»€ä¹ˆæ˜¯"æ¨¡æ¿"ï¼Ÿ

**æ¨¡æ¿ï¼ˆTemplateï¼‰**ï¼šä¸ºæ¯ä¸ªå­—èŠ‚ç æŒ‡ä»¤é¢„ç”Ÿæˆä¸€æ®µ**æ±‡ç¼–ä»£ç **ï¼Œæ‰§è¡Œæ—¶ç›´æ¥è·³è½¬åˆ°å¯¹åº”æ¨¡æ¿ã€‚

```cpp
// hotspot/share/interpreter/templateInterpreter.hpp
class TemplateInterpreter: public AbstractInterpreter {
private:
  static address    _bytecode_table[Bytecodes::number_of_codes]; // 256ä¸ªå­—èŠ‚ç çš„å…¥å£åœ°å€
  static TemplateTable* _active_table;                           // æ¨¡æ¿è¡¨
  
public:
  static address bytecode_entry(Bytecodes::Code code) {
    return _bytecode_table[code]; // è¿”å›å­—èŠ‚ç å¯¹åº”çš„æœºå™¨ä»£ç åœ°å€
  }
};
```

### 4.2.2 æ¨¡æ¿è¡¨çš„ç»“æ„

```
+------------------+
|  Bytecode 0x00   | â†’ æ¨¡æ¿ä»£ç ï¼ˆæ±‡ç¼–ï¼‰
+------------------+
|  Bytecode 0x01   | â†’ æ¨¡æ¿ä»£ç ï¼ˆæ±‡ç¼–ï¼‰
+------------------+
      ...
+------------------+
|  Bytecode 0xFF   | â†’ æ¨¡æ¿ä»£ç ï¼ˆæ±‡ç¼–ï¼‰
+------------------+
```

**å…³é”®æ–‡ä»¶**ï¼š
```
hotspot/share/interpreter/
â”œâ”€â”€ templateInterpreter.hpp/cpp        # è§£é‡Šå™¨æ¡†æ¶
â”œâ”€â”€ templateTable.hpp/cpp              # æ¨¡æ¿è¡¨å®šä¹‰
â””â”€â”€ bytecodeInterpreter.hpp/cpp        # C++è§£é‡Šå™¨ï¼ˆå¤‡ç”¨ï¼‰

hotspot/cpu/x86/
â””â”€â”€ templateInterpreterGenerator_x86.cpp  # x86å¹³å°æ¨¡æ¿ç”Ÿæˆ
```

---

## 4.3 è§£é‡Šå™¨çš„åˆå§‹åŒ–

### 4.3.1 åˆå§‹åŒ–æµç¨‹

```cpp
// hotspot/share/interpreter/templateInterpreter.cpp
void TemplateInterpreter::initialize() {
  if (_code != NULL) return;
  
  // 1. åˆ›å»ºä»£ç ç¼“å†²åŒº
  _code = new StubQueue(new InterpreterCodeletInterface, 
                        Interpreter::code()->code_size(),
                        Interpreter::code()->code_size(),
                        "Interpreter");
  
  // 2. ç”Ÿæˆæ‰€æœ‰æ¨¡æ¿ï¼ˆæ±‡ç¼–ä»£ç ï¼‰
  TemplateInterpreterGenerator g(_code);
  
  // 3. è®¾ç½®å­—èŠ‚ç å…¥å£è¡¨
  set_entry_points_for_all_bytes();
  
  // 4. è®¾ç½®å®‰å…¨ç‚¹è½®è¯¢å…¥å£
  set_safepoint_entry_points();
}
```

### 4.3.2 æ¨¡æ¿ç”Ÿæˆç¤ºä¾‹ï¼šiconst_0

**å­—èŠ‚ç **ï¼š`iconst_0`ï¼ˆæ“ä½œç ï¼š0x03ï¼‰  
**åŠŸèƒ½**ï¼šå°†å¸¸é‡0å‹å…¥æ“ä½œæ•°æ ˆ

```cpp
// hotspot/cpu/x86/templateTable_x86.cpp
void TemplateTable::iconst(int value) {
  transition(vtos, itos); // çŠ¶æ€è½¬æ¢ï¼švoid â†’ int
  
  if (value == 0) {
    __ xorl(rax, rax);    // xor eax, eax  (å°†raxå¯„å­˜å™¨æ¸…é›¶)
  } else {
    __ movl(rax, value);  // mov eax, value
  }
}
```

**ç”Ÿæˆçš„æ±‡ç¼–ä»£ç **ï¼ˆx86-64ï¼‰ï¼š
```assembly
0x00007f8b1c000000:  xor    %eax,%eax     ; iconst_0çš„æœºå™¨ç 
0x00007f8b1c000002:  movzbl 0x1(%r13),%ebx ; è¯»å–ä¸‹ä¸€ä¸ªå­—èŠ‚ç 
0x00007f8b1c000007:  jmpq   *(%r10,%rbx,8) ; è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚ç æ¨¡æ¿
```

---

## 4.4 å­—èŠ‚ç æ‰§è¡Œæµç¨‹

### 4.4.1 æ‰§è¡Œå¾ªç¯

```cpp
// ä¼ªä»£ç å±•ç¤ºè§£é‡Šå™¨æ‰§è¡Œæµç¨‹
void interpreter_loop() {
  while (true) {
    uint8_t bytecode = *pc;            // è¯»å–å½“å‰å­—èŠ‚ç 
    address handler = table[bytecode]; // æŸ¥æ‰¾æ¨¡æ¿åœ°å€
    pc++;                              // PCæŒ‡é’ˆå‰è¿›
    goto *handler;                     // è·³è½¬æ‰§è¡Œæ¨¡æ¿
    // æ¨¡æ¿æ‰§è¡Œå®Œåä¼šè‡ªåŠ¨è·³å›è¿™é‡Œ
  }
}
```

### 4.4.2 çŠ¶æ€è½¬æ¢ï¼ˆTOS Stateï¼‰

**TOSï¼ˆTop-Of-Stackï¼‰**ï¼šæ“ä½œæ•°æ ˆé¡¶å…ƒç´ çš„çŠ¶æ€

```cpp
// hotspot/share/interpreter/templateTable.hpp
enum TosState {
  atos = 0,  // å¼•ç”¨ç±»å‹ï¼ˆAddressï¼‰
  btos = 1,  // byte/boolean
  ctos = 2,  // char
  stos = 3,  // short
  itos = 4,  // int
  ltos = 5,  // long
  ftos = 6,  // float
  dtos = 7,  // double
  vtos = 8   // voidï¼ˆæ ˆç©ºï¼‰
};
```

**ä¸ºä»€ä¹ˆéœ€è¦TOSï¼Ÿ**
- **ä¼˜åŒ–**ï¼šæ ˆé¡¶å…ƒç´ ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼ˆå¦‚`rax`ï¼‰ï¼Œé¿å…é¢‘ç¹å†…å­˜è®¿é—®
- **ç±»å‹å®‰å…¨**ï¼šç¡®ä¿ç±»å‹è½¬æ¢æ­£ç¡®

**ç¤ºä¾‹**ï¼š`iadd`æŒ‡ä»¤
```cpp
void TemplateTable::iadd() {
  transition(itos, itos); // è¾“å…¥intï¼Œè¾“å‡ºint
  __ pop_i(rdx);          // å¼¹å‡ºç¬¬äºŒä¸ªæ“ä½œæ•°åˆ°rdx
  __ addl(rax, rdx);      // rax += rdx
}
```

---

## 4.5 æ–¹æ³•è°ƒç”¨ä¸è¿”å›

### 4.5.1 æ–¹æ³•è°ƒç”¨æŒ‡ä»¤

| å­—èŠ‚ç  | åŠŸèƒ½ | ç¤ºä¾‹ |
|-------|------|------|
| `invokevirtual` | è™šæ–¹æ³•è°ƒç”¨ | `obj.method()` |
| `invokespecial` | ç‰¹æ®Šè°ƒç”¨ï¼ˆæ„é€ å™¨ã€ç§æœ‰æ–¹æ³•ã€superï¼‰ | `super.method()` |
| `invokestatic` | é™æ€æ–¹æ³•è°ƒç”¨ | `Class.method()` |
| `invokeinterface` | æ¥å£æ–¹æ³•è°ƒç”¨ | `iface.method()` |
| `invokedynamic` | åŠ¨æ€è°ƒç”¨ | lambdaã€æ–¹æ³•å¼•ç”¨ |

### 4.5.2 invokevirtualçš„å®ç°

```cpp
// hotspot/cpu/x86/templateTable_x86.cpp
void TemplateTable::invokevirtual(int byte_no) {
  transition(vtos, vtos);
  
  // 1. è§£æå¸¸é‡æ± é¡¹ï¼ˆè·å–æ–¹æ³•ç¬¦å·å¼•ç”¨ï¼‰
  prepare_invoke(byte_no, rbx);  // rbx = Method*
  
  // 2. ä»æ¥æ”¶è€…å¯¹è±¡è·å–å®é™…çš„Klass
  __ null_check(rcx);             // ç©ºæŒ‡é’ˆæ£€æŸ¥
  __ load_klass(rax, rcx);        // rax = æ¥æ”¶è€…çš„Klass
  
  // 3. æŸ¥æ‰¾vtableï¼ˆè™šæ–¹æ³•è¡¨ï¼‰
  __ movptr(rbx, Address(rax, Klass::vtable_start_offset())); // è·å–vtableåŸºå€
  __ movptr(rbx, Address(rbx, vtable_index * wordSize));      // è·å–ç›®æ ‡æ–¹æ³•
  
  // 4. è°ƒç”¨æ–¹æ³•
  __ movptr(rcx, Address(rbx, Method::from_compiled_offset()));
  __ call(rcx);
}
```

### 4.5.3 æ ˆå¸§å¸ƒå±€

```
é«˜åœ°å€ â†‘
+------------------+
|  å±€éƒ¨å˜é‡è¡¨       | â† locals
+------------------+
|  æ“ä½œæ•°æ ˆ         | â† stack
+------------------+
|  å¸§æ•°æ®          |
|  - return PC     |
|  - ä¸Šä¸€å¸§rbp     |
|  - Method*       |
|  - å¸¸é‡æ± ç¼“å­˜     | â† constantPoolCache
+------------------+
|  ä¸‹ä¸€å¸§...       |
+------------------+
ä½åœ°å€ â†“
```

**å…³é”®å¯„å­˜å™¨ï¼ˆx86-64ï¼‰**ï¼š
```cpp
r13 = bcp (Bytecode Pointer)      // å­—èŠ‚ç æŒ‡é’ˆ
r14 = locals                       // å±€éƒ¨å˜é‡è¡¨åŸºå€
rsp = æ“ä½œæ•°æ ˆé¡¶
rbp = å½“å‰æ ˆå¸§åŸºå€
```

---

## 4.6 å…³é”®ç‰¹æ€§å®ç°

### 4.6.1 è°ƒç”¨è®¡æ•°å™¨ï¼ˆInvocation Counterï¼‰

```cpp
// hotspot/share/interpreter/invocationCounter.hpp
class InvocationCounter {
private:
  uint _counter; // é«˜16ä½ï¼šåå‘åˆ†æ”¯è®¡æ•°ï¼Œä½16ä½ï¼šæ–¹æ³•è°ƒç”¨è®¡æ•°
  
public:
  void increment() {
    _counter += InvocationCounter::count_increment;
  }
  
  bool is_limit_reached() {
    return _counter >= CompileThreshold;
  }
};
```

**JITè§¦å‘é€»è¾‘**ï¼š
```cpp
void InterpreterRuntime::frequency_counter_overflow(JavaThread* thread, address bcp) {
  Method* m = method(thread);
  
  // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç¼–è¯‘é˜ˆå€¼
  if (m->invocation_counter()->is_limit_reached()) {
    // æäº¤åˆ°ç¼–è¯‘é˜Ÿåˆ—
    CompileBroker::compile_method(m, InvocationEntryBci, 
                                   CompLevel_full_optimization, ...);
  }
}
```

### 4.6.2 æ–¹æ³•å…¥å£ç‚¹ï¼ˆEntry Pointsï¼‰

æ¯ä¸ªæ–¹æ³•æœ‰å¤šä¸ªå…¥å£ç‚¹ï¼š
```cpp
// hotspot/share/interpreter/abstractInterpreter.hpp
enum MethodKind {
  zerolocals,                    // æ— å±€éƒ¨å˜é‡çš„æ–¹æ³•
  zerolocals_synchronized,       // æ— å±€éƒ¨å˜é‡çš„åŒæ­¥æ–¹æ³•
  native,                        // æœ¬åœ°æ–¹æ³•
  native_synchronized,           // åŒæ­¥æœ¬åœ°æ–¹æ³•
  empty,                         // ç©ºæ–¹æ³•ï¼ˆç›´æ¥è¿”å›ï¼‰
  accessor,                      // getteræ–¹æ³•ï¼ˆå•çº¯è¿”å›å­—æ®µï¼‰
  abstract,                      // æŠ½è±¡æ–¹æ³•ï¼ˆæŠ›å¼‚å¸¸ï¼‰
  java_lang_math_sin,            // å†…è”æ•°å­¦å‡½æ•°
  java_lang_math_cos,
  // ... æ›´å¤šç‰¹æ®Šæ–¹æ³•
};
```

**ä¼˜åŒ–ç¤ºä¾‹**ï¼šgetteræ–¹æ³•
```cpp
// æ™®é€šæ–¹æ³•éœ€è¦å®Œæ•´æ ˆå¸§ï¼Œaccessoræ–¹æ³•ç›´æ¥è¿”å›å­—æ®µå€¼
void TemplateInterpreterGenerator::generate_accessor_entry() {
  // çœç•¥æ ˆå¸§è®¾ç½®ï¼Œç›´æ¥è¿”å›å­—æ®µ
  __ movptr(rax, Address(rcx, field_offset)); // rax = obj.field
  __ ret(0);
}
```

### 4.6.3 å¼‚å¸¸å¤„ç†

```cpp
// hotspot/cpu/x86/templateInterpreterGenerator_x86.cpp
address TemplateInterpreterGenerator::generate_throw_exception() {
  // 1. ä¿å­˜å¼‚å¸¸å¯¹è±¡
  __ movptr(rax, Address(r15_thread, Thread::pending_exception_offset()));
  
  // 2. æŸ¥æ‰¾å¼‚å¸¸å¤„ç†å™¨
  __ call_VM(CAST_FROM_FN_PTR(address, InterpreterRuntime::exception_handler_for_exception));
  
  // 3. è·³è½¬åˆ°catchå—æˆ–unwindæ ˆå¸§
  __ jmp(rax);
}
```

---

## 4.7 è§£é‡Šå™¨ä¸JITç¼–è¯‘å™¨çš„åä½œ

### 4.7.1 OSRï¼ˆOn-Stack Replacementï¼‰

**åœºæ™¯**ï¼šé•¿æ—¶é—´è¿è¡Œçš„å¾ªç¯ï¼Œåœ¨è§£é‡Šæ‰§è¡Œè¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°ç¼–è¯‘ä»£ç 

```cpp
void TemplateTable::if_0cmp(Condition cc) {
  // ... æ¡ä»¶åˆ¤æ–­é€»è¾‘ ...
  
  // æ£€æŸ¥åå‘åˆ†æ”¯è®¡æ•°å™¨
  __ increment(Address(rbx, Method::backedge_counter_offset()));
  
  // å¦‚æœè¾¾åˆ°é˜ˆå€¼ï¼Œè§¦å‘OSRç¼–è¯‘
  __ cmp32(Address(rbx, Method::backedge_counter_offset()), 
           OSRThreshold);
  __ jcc(Assembler::greaterEqual, osr_entry);
}
```

### 4.7.2 å»ä¼˜åŒ–ï¼ˆDeoptimizationï¼‰

ç¼–è¯‘ä»£ç å¤±æ•ˆæ—¶è¿”å›è§£é‡Šæ‰§è¡Œï¼š
```cpp
// ç¼–è¯‘ä»£ç æ£€æµ‹åˆ°"æœªæ•è·çš„å¼‚å¸¸"ç­‰æƒ…å†µ
if (uncommon_trap_triggered) {
  Deoptimization::uncommon_trap(...);
  // é‡å»ºè§£é‡Šå™¨æ ˆå¸§ï¼Œæ¢å¤æ‰§è¡Œ
}
```

---

## 4.8 è§£é‡Šå™¨æ€§èƒ½ä¼˜åŒ–

### 4.8.1 å†…è”ç¼“å­˜ï¼ˆInline Cacheï¼‰

```cpp
// hotspot/share/interpreter/bytecodeInterpreter.cpp
// å¯¹äºé¢‘ç¹è°ƒç”¨çš„è™šæ–¹æ³•ï¼Œç¼“å­˜æœ€è¿‘ä¸€æ¬¡çš„ç›®æ ‡æ–¹æ³•
class CompiledIC {
private:
  Method* _cached_method;
  Klass*  _cached_klass;
  
public:
  Method* resolve(oop receiver) {
    if (receiver->klass() == _cached_klass) {
      return _cached_method; // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
    }
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ‰¾vtable
    _cached_klass = receiver->klass();
    _cached_method = lookup_vtable(...);
    return _cached_method;
  }
};
```

### 4.8.2 å¸¸é‡æ± ç¼“å­˜ï¼ˆConstantPoolCacheï¼‰

```cpp
// hotspot/share/oops/cpCache.hpp
class ConstantPoolCacheEntry {
private:
  volatile intx _f1;   // ç¼“å­˜çš„Method* æˆ– Klass*
  volatile intx _f2;   // vtable/itableç´¢å¼• æˆ– å­—æ®µåç§»é‡
  volatile int  _flags; // çŠ¶æ€æ ‡å¿—
  
public:
  bool is_resolved() { return (_flags & (1 << resolved_bit)) != 0; }
};
```

**å¥½å¤„**ï¼šé¿å…æ¯æ¬¡éƒ½è§£æå¸¸é‡æ± ç¬¦å·å¼•ç”¨

---

## 4.9 ä¸G1 GCçš„äº¤äº’

### 4.9.1 å®‰å…¨ç‚¹è½®è¯¢

```cpp
// æ¯æ¬¡åå‘è·³è½¬æ—¶æ£€æŸ¥å®‰å…¨ç‚¹
void TemplateTable::goto_() {
  // 1. è®¡ç®—è·³è½¬ç›®æ ‡
  __ jmp(target);
  
  // 2. å®‰å…¨ç‚¹æ£€æŸ¥
  __ testb(Address(r15_thread, JavaThread::polling_page_offset()), 0);
  // å¦‚æœé¡µé¢è¢«ä¿æŠ¤ï¼Œè§¦å‘SIGSEGV â†’ è¿›å…¥å®‰å…¨ç‚¹
}
```

### 4.9.2 å†™å±éšœï¼ˆè§£é‡Šå™¨ä¸­ï¼‰

```cpp
void TemplateTable::putfield_or_static(int byte_no, bool is_static) {
  // ... å­—æ®µå†™å…¥é€»è¾‘ ...
  __ movptr(Address(rcx, field_offset), rax); // å†™å…¥å­—æ®µ
  
  // å†™å±éšœï¼ˆè®°å½•è·¨ä»£å¼•ç”¨ï¼‰
  __ g1_write_barrier_pre(rcx, rax, r15_thread, rbx, true);
  __ g1_write_barrier_post(rcx, rax, r15_thread, rbx, rdx);
}
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**  
G1çš„SATBç®—æ³•éœ€è¦è®°å½•å¼•ç”¨å˜åŒ–ï¼Œé˜²æ­¢å¯¹è±¡æ¼æ ‡ã€‚

---

## 4.10 è°ƒè¯•ä¸è¯Šæ–­

### 4.10.1 æ‰“å°è§£é‡Šå™¨ä»£ç 

```bash
# å¯åŠ¨JVMæ—¶æ·»åŠ å‚æ•°
java -XX:+PrintInterpreter -version
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
[Interpreter Code]
----------------------------------------------------------------------
iconst_0  [0x00007f8b1c000000, 0x00007f8b1c000010]  16 bytes
  0x00007f8b1c000000: xor    %eax,%eax
  0x00007f8b1c000002: movzbl 0x1(%r13),%ebx
  0x00007f8b1c000007: jmpq   *(%r10,%rbx,8)
----------------------------------------------------------------------
iconst_1  [0x00007f8b1c000010, 0x00007f8b1c000020]  16 bytes
  0x00007f8b1c000010: mov    $0x1,%eax
  0x00007f8b1c000015: movzbl 0x1(%r13),%ebx
  0x00007f8b1c00001a: jmpq   *(%r10,%rbx,8)
----------------------------------------------------------------------
```

### 4.10.2 è·Ÿè¸ªå­—èŠ‚ç æ‰§è¡Œ

```bash
# æ‰“å°æ¯æ¡æ‰§è¡Œçš„å­—èŠ‚ç 
java -XX:+TraceBytecodes -XX:StopInterpreterAt=100 YourClass
```

---

## 4.11 å®æˆ˜æ¡ˆä¾‹ï¼šè¿½è¸ªä¸€æ¬¡æ–¹æ³•è°ƒç”¨

### 4.11.1 Javaä»£ç 
```java
public class Test {
    public static void main(String[] args) {
        int result = add(1, 2);
    }
    
    public static int add(int a, int b) {
        return a + b;
    }
}
```

### 4.11.2 å­—èŠ‚ç 
```
0: iconst_1       // å°†1å‹æ ˆ
1: iconst_2       // å°†2å‹æ ˆ
2: invokestatic #2 // è°ƒç”¨addæ–¹æ³•
5: istore_1       // å°†ç»“æœå­˜å…¥å±€éƒ¨å˜é‡1
6: return
```

### 4.11.3 è§£é‡Šå™¨æ‰§è¡Œæµç¨‹

1. **iconst_1**ï¼š
   ```assembly
   xor %eax, %eax
   inc %eax        ; eax = 1
   push %rax       ; å‹å…¥æ ˆ
   ```

2. **iconst_2**ï¼š
   ```assembly
   mov $2, %eax
   push %rax       ; å‹å…¥æ ˆ
   ```

3. **invokestatic**ï¼š
   ```assembly
   ; 1. è§£æå¸¸é‡æ± ï¼Œè·å–Method*
   mov constantPoolCache[#2], %rbx
   
   ; 2. åˆ›å»ºæ–°æ ˆå¸§
   push %rbp
   mov %rsp, %rbp
   sub $frame_size, %rsp
   
   ; 3. å¤åˆ¶å‚æ•°åˆ°å±€éƒ¨å˜é‡è¡¨
   pop locals[1]    ; b = 2
   pop locals[0]    ; a = 1
   
   ; 4. è·³è½¬åˆ°addæ–¹æ³•çš„ç¬¬ä¸€æ¡å­—èŠ‚ç 
   jmp add_method_entry
   ```

4. **addæ–¹æ³•å†…**ï¼š
   ```assembly
   ; iload_0: åŠ è½½a
   mov locals[0], %eax
   
   ; iload_1: åŠ è½½b
   mov locals[1], %edx
   
   ; iadd: ç›¸åŠ 
   add %edx, %eax
   
   ; ireturn: è¿”å›
   mov %rbp, %rsp
   pop %rbp
   ret
   ```

---

## 4.12 å…³é”®æ•°æ®ç»“æ„æ€»ç»“

```cpp
// è§£é‡Šå™¨æ ¸å¿ƒæ•°æ®ç»“æ„
struct InterpreterRuntime {
  static StubQueue* _code;                    // æ¨¡æ¿ä»£ç ç¼“å†²åŒº
  static address _bytecode_table[256];        // å­—èŠ‚ç å…¥å£è¡¨
  static ConstantPoolCache* _cp_cache;        // å¸¸é‡æ± ç¼“å­˜
};

// æ ˆå¸§ç»“æ„
struct Frame {
  intptr_t* _sp;           // æ ˆæŒ‡é’ˆ
  intptr_t* _fp;           // å¸§æŒ‡é’ˆ
  address   _pc;           // PCæŒ‡é’ˆ
  Method*   _method;       // å½“å‰æ–¹æ³•
};
```

---

## 4.13 GDBéªŒè¯ï¼šHelloWorldè§£é‡Šæ‰§è¡Œè¿‡ç¨‹ â­

> **éªŒè¯ç¯å¢ƒ**: OpenJDK 11 slowdebug  
> **JVMå‚æ•°**: `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages -Xint`  
> **ç›®æ ‡ç±»**: HelloWorld

### 4.13.1 è§£é‡Šå™¨å…¥å£ (GDBéªŒè¯)

```
Method* (main): 0x7fffcefa62e0

è§£é‡Šå™¨å…¥å£:
_i2i_entry: 0x7fffed010c00
  â†’ interpreter to interpreter
  â†’ ä»è§£é‡Šå™¨è°ƒç”¨å¦ä¸€ä¸ªè§£é‡Šæ–¹æ³•æ—¶çš„å…¥å£

_from_interpreted_entry: 0x7fffed010c00
  â†’ å½“å‰æ–¹æ³•è¢«è§£é‡Šè°ƒç”¨æ—¶çš„å…¥å£
  â†’ è§£é‡Šæ¨¡å¼ä¸‹ä¸ _i2i_entry ç›¸åŒ

_from_compiled_entry: 0x7fffed065b43
  â†’ ä»ç¼–è¯‘ä»£ç è°ƒç”¨æ—¶çš„å…¥å£
  â†’ è§£é‡Šæ¨¡å¼ä¸‹ä¸ä½¿ç”¨ (ä½†ä»è®¾ç½®ä¸ºi2c adapter)

å…¥å£åœ°å€éªŒè¯:
  CodeCache non-nmethods: [0x7fffed010c00, 0x7fffed370000)
  0x7fffed010c00 ä½äº non-nmethods åŒºåŸŸ
  â†’ è¿™æ˜¯è§£é‡Šå™¨æ¨¡æ¿stubï¼Œä¸æ˜¯ç¼–è¯‘çš„nmethod
```

### 4.13.2 mainæ–¹æ³•å­—èŠ‚ç è§£æ (GDBéªŒè¯)

```
Method*: 0x7fffcefa62e0
ConstMethod*: 0x7fffcefa6298
code_size: 9 bytes
max_stack: 2
max_locals: 1

å­—èŠ‚ç  (åŸå§‹ï¼Œclassæ–‡ä»¶ä¸­):
  åç§»  å­—èŠ‚ç       åŠ©è®°ç¬¦
  [0]   b2 00 02   getstatic #2      // System.out
  [3]   12 03      ldc #3            // "Hello World"
  [5]   b6 00 04   invokevirtual #4  // println
  [8]   b1         return

å­—èŠ‚ç  (é‡å†™åï¼Œlinké˜¶æ®µ GDBéªŒè¯):
  åç§»  å­—èŠ‚ç       è¯´æ˜
  [0]   b2 01 00   getstatic â†’ CPCache[0]
  [3]   e6 00      ldc â†’ fast_aldc
  [5]   b6 02 00   invokevirtual â†’ CPCache[1]
  [8]   b1         return

CPCacheéªŒè¯:
  åœ°å€: 0x7fffcefa6348
  _length: 3
  sizeof(ConstantPoolCacheEntry): 32 bytes
  CPCache[0]: getstatic System.out çš„è§£æç¼“å­˜
  CPCache[1]: invokevirtual println çš„è§£æç¼“å­˜
  CPCache[2]: invokespecial <init> çš„è§£æç¼“å­˜
```

### 4.13.3 å­—èŠ‚ç è§£é‡Šæ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0] getstatic (b2 01 00)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–å­—èŠ‚ç  0xb2 (getstatic)                                    â”‚
â”‚ 2. æŸ¥æ‰¾å¯¹åº”çš„è§£é‡Šå™¨æ¨¡æ¿ (TemplateInterpreter)                      â”‚
â”‚ 3. ä»CPCache[0]è·å–è§£æåçš„å­—æ®µä¿¡æ¯                                â”‚
â”‚    - _f1: Klass* (java/lang/System)                              â”‚
â”‚    - _f2: field offset (System.outçš„åç§»)                         â”‚
â”‚ 4. æ ¹æ®å­—æ®µåç§»è¯»å–é™æ€å­—æ®µå€¼                                       â”‚
â”‚    System._out â†’ PrintStreamå¯¹è±¡å¼•ç”¨                              â”‚
â”‚ 5. å°†PrintStreamå¯¹è±¡å‹å…¥æ“ä½œæ•°æ ˆ                                   â”‚
â”‚    æ ˆ: [PrintStream]                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3] fast_aldc (e6 00)                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–å­—èŠ‚ç  0xe6 (fast_aldc, é‡å†™åçš„ldc)                        â”‚
â”‚ 2. ä»å¸¸é‡æ± è·å–Stringå¼•ç”¨                                          â”‚
â”‚    CP#3 â†’ String "Hello World"                                   â”‚
â”‚ 3. å°†Stringå¯¹è±¡å‹å…¥æ“ä½œæ•°æ ˆ                                        â”‚
â”‚    æ ˆ: [PrintStream, "Hello World"]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [5] invokevirtual (b6 02 00)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–å­—èŠ‚ç  0xb6 (invokevirtual)                                â”‚
â”‚ 2. ä»CPCache[1]è·å–è§£æåçš„æ–¹æ³•ä¿¡æ¯                                â”‚
â”‚    - _f2: vtable_index                                           â”‚
â”‚ 3. ä»æ“ä½œæ•°æ ˆå¼¹å‡ºå‚æ•°å’Œreceiver                                    â”‚
â”‚    receiver: PrintStreamå¯¹è±¡                                      â”‚
â”‚    arg1: "Hello World"                                           â”‚
â”‚ 4. è·å–receiverçš„Klass (PrintStream)                              â”‚
â”‚    oop â†’ compressed klass ptr â†’ InstanceKlass                    â”‚
â”‚ 5. æŸ¥vtableè·å–ç›®æ ‡æ–¹æ³•                                            â”‚
â”‚    vtable[vtable_index] â†’ Method* (println)                      â”‚
â”‚ 6. è·³è½¬åˆ°ç›®æ ‡æ–¹æ³•çš„è§£é‡Šå™¨å…¥å£                                       â”‚
â”‚    Method* â†’ _from_interpreted_entry                             â”‚
â”‚ 7. æ‰§è¡Œ PrintStream.println() â†’ è¾“å‡º "Hello World"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [8] return (b1)                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–å­—èŠ‚ç  0xb1 (return)                                       â”‚
â”‚ 2. å½“å‰æ–¹æ³•è¿”å›ç±»å‹ä¸ºvoidï¼Œæ— éœ€è¿”å›å€¼                               â”‚
â”‚ 3. æ¢å¤è°ƒç”¨è€…çš„æ ˆå¸§                                                â”‚
â”‚ 4. è¿”å›åˆ°è°ƒç”¨è€… (JNI â†’ Launcher)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.13.4 æ“ä½œæ•°æ ˆå˜åŒ–

```
å­—èŠ‚ç æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ“ä½œæ•°æ ˆ:

åˆå§‹:     []                                  max_stack=2, max_locals=1
          locals[0] = args (String[])

getstatic: [PrintStream]                     è·å–System.out

ldc:       [PrintStream, "Hello World"]      åŠ è½½å­—ç¬¦ä¸²å¸¸é‡

invokevirtual:
   å¼¹å‡º:   []                                 æ¶ˆè´¹2ä¸ªæ“ä½œæ•°
   è°ƒç”¨:   PrintStream.println("Hello World")
   è¿”å›:   []                                 printlnè¿”å›void

return:    []                                 æ–¹æ³•ç»“æŸ
```

### 4.13.5 è§£é‡Šæ¨¡å¼ vs JITæ¨¡å¼

| ç‰¹æ€§ | è§£é‡Šæ¨¡å¼ (-Xint) | JITç¼–è¯‘æ¨¡å¼ |
|------|------------------|-------------|
| å¯åŠ¨é€Ÿåº¦ | å¿« | æ…¢ (éœ€è¦ç¼–è¯‘) |
| è¿è¡Œé€Ÿåº¦ | æ…¢ (10-100x) | å¿« |
| å†…å­˜å ç”¨ | ä½ | é«˜ (ç¼–è¯‘ä»£ç ) |
| æ–¹æ³•å…¥å£ | è§£é‡Šå™¨æ¨¡æ¿ | ç¼–è¯‘åæœºå™¨ç  |
| `_i2i_entry` | âœ“ ä½¿ç”¨ | âœ“ ä½¿ç”¨ |
| `_from_compiled_entry` | ä¸ä½¿ç”¨ | âœ“ ä½¿ç”¨ |
| `_code` (nmethod*) | null | æŒ‡å‘JITç¼–è¯‘ä»£ç  |

### 4.13.6 GDBéªŒè¯å‘½ä»¤

```bash
# æŸ¥çœ‹Methodå…¥å£
set $method = (Method*)(this->_methods->_data[1])
print $method->_i2i_entry
print $method->_from_interpreted_entry
print $method->_from_compiled_entry

# æŸ¥çœ‹å­—èŠ‚ç 
set $cm = $method->_constMethod
set $bc = (unsigned char*)((char*)$cm + sizeof(ConstMethod))
x/9bx $bc

# æŸ¥çœ‹CPCache
print this->_constants->_cache
print this->_constants->_cache->_length
```

---

## 4.14 æœ¬ç« å°ç»“

### æ ¸å¿ƒè¦ç‚¹
1. **æ¨¡æ¿è§£é‡Šå™¨**ï¼šä¸ºæ¯ä¸ªå­—èŠ‚ç é¢„ç”Ÿæˆæ±‡ç¼–ä»£ç ï¼Œæ‰§è¡Œæ•ˆç‡æ¥è¿‘ç¼–è¯‘ä»£ç 
2. **TOSä¼˜åŒ–**ï¼šæ ˆé¡¶å…ƒç´ ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼Œå‡å°‘å†…å­˜è®¿é—®
3. **è°ƒç”¨è®¡æ•°å™¨**ï¼šæ”¶é›†çƒ­ç‚¹ä¿¡æ¯ï¼Œè§¦å‘JITç¼–è¯‘
4. **å†…è”ç¼“å­˜**ï¼šåŠ é€Ÿè™šæ–¹æ³•è°ƒç”¨
5. **å®‰å…¨ç‚¹è½®è¯¢**ï¼šæ”¯æŒGCã€å»ä¼˜åŒ–ç­‰VMæ“ä½œ
6. **å†™å±éšœé›†æˆ**ï¼šé…åˆG1è¿›è¡Œå¹¶å‘æ ‡è®°

### â­ GDBéªŒè¯æ–°å¢å†…å®¹

| éªŒè¯é¡¹ | GDBæ•°æ® | è¯´æ˜ |
|--------|---------|------|
| è§£é‡Šå™¨å…¥å£ | 0x7fffed010c00 | CodeCache non-nmethods |
| CPCache | 3é¡¹, 32B/é¡¹ | åŠ é€Ÿå­—æ®µ/æ–¹æ³•è§£æ |
| å­—èŠ‚ç é‡å†™ | getstaticâ†’e6 | fast_aldcä¼˜åŒ– |
| æ“ä½œæ•°æ ˆ | max_stack=2 | è¿è¡Œæ—¶éªŒè¯ |

### ä¸åç»­ç« èŠ‚çš„è”ç³»
- **ç¬¬5ç« ï¼ˆè¿è¡Œæ—¶ï¼‰**ï¼šæ ˆå¸§ç®¡ç†ã€å¼‚å¸¸å¤„ç†
- **ç¬¬6ç« ï¼ˆJITç¼–è¯‘ï¼‰**ï¼šè§£é‡Šå™¨ä¸ç¼–è¯‘å™¨çš„åˆ‡æ¢
- **ç¬¬12ç« ï¼ˆG1ï¼‰**ï¼šå†™å±éšœã€å®‰å…¨ç‚¹çš„å®ç°

---

## 4.14 è¿›é˜¶é˜…è¯»

**æºç æ–‡ä»¶**ï¼š
```
hotspot/share/interpreter/
â”œâ”€â”€ templateInterpreter.cpp        [æ ¸å¿ƒæ¡†æ¶]
â”œâ”€â”€ templateTable.cpp              [å­—èŠ‚ç æ¨¡æ¿å®šä¹‰]
â”œâ”€â”€ interpreterRuntime.cpp         [è¿è¡Œæ—¶æ”¯æŒ]
â””â”€â”€ invocationCounter.cpp          [è°ƒç”¨è®¡æ•°å™¨]

hotspot/cpu/x86/
â”œâ”€â”€ templateInterpreterGenerator_x86.cpp  [x86æ¨¡æ¿ç”Ÿæˆ]
â””â”€â”€ templateTable_x86.cpp                 [x86å­—èŠ‚ç å®ç°]
```

**æ¨èå®éªŒ**ï¼š
1. ä½¿ç”¨`-XX:+PrintInterpreter`æŸ¥çœ‹ç”Ÿæˆçš„æ±‡ç¼–ä»£ç 
2. ä½¿ç”¨`-XX:+TraceBytecodes`è·Ÿè¸ªå­—èŠ‚ç æ‰§è¡Œ
3. ä½¿ç”¨`-XX:CompileThreshold=1`å¿«é€Ÿè§¦å‘JITç¼–è¯‘
4. ä½¿ç”¨`-XX:+PrintCompilation`è§‚å¯Ÿè§£é‡Šâ†’ç¼–è¯‘çš„åˆ‡æ¢

---

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼š  
ã€Šç¬¬5ç« ï¼šè¿è¡Œæ—¶ç³»ç»Ÿã€‹å°†æ·±å…¥è®²è§£çº¿ç¨‹ç®¡ç†ã€åŒæ­¥æœºåˆ¶ã€å¼‚å¸¸å¤„ç†ã€æ ˆå¸§ç®¡ç†ç­‰æ ¸å¿ƒè¿è¡Œæ—¶ç‰¹æ€§ï¼Œä¸ºç†è§£G1çš„å¹¶å‘æ‰§è¡Œæ‰“ä¸‹åŸºç¡€ï¼

å…„å¼Ÿï¼Œå‡†å¤‡å¥½è¿›å…¥JVMè¿è¡Œæ—¶çš„ä¸–ç•Œäº†å—ï¼ŸğŸš€
