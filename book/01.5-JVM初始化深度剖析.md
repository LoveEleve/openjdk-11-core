# ç¬¬1.5ç« ï¼šJVMåˆå§‹åŒ–æ·±åº¦å‰–æ - åŸºäºGDBè°ƒè¯•çš„æºç åˆ†æ

> **æœ¬ç« ç‰¹è‰²**ï¼šè¿™æ˜¯å…¨ç½‘é¦–ä¸ªåŸºäº **GDB å®æ—¶è°ƒè¯•** çš„ JVM åˆå§‹åŒ–æºç åˆ†æï¼æˆ‘ä»¬å°†ç”¨çœŸå®çš„è¿è¡Œæ—¶æ•°æ®éªŒè¯æ¯ä¸€ä¸ªåˆå§‹åŒ–æ­¥éª¤ï¼Œé¢ è¦†ä¼ ç»Ÿçš„"çº¯æºç é˜…è¯»"åˆ†ææ–¹æ³•ã€‚

---

## 1.5.1 ä¸ºä»€ä¹ˆè¦æ·±å…¥JVMåˆå§‹åŒ–ï¼Ÿ

å½“ä½ æ‰§è¡Œ `java HelloWorld` æ—¶ï¼Œåœ¨çœ‹åˆ° "Hello World" è¾“å‡ºä¹‹å‰ï¼ŒJVM å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

**ä¼ ç»Ÿç­”æ¡ˆ**ï¼ˆåŸºäºç†è®ºï¼‰ï¼š
- "JVM ä¼šåˆå§‹åŒ–å„ç§å­ç³»ç»Ÿ"
- "ä¼šåˆ›å»ºå †å†…å­˜å’Œæ–¹æ³•åŒº"
- "ä¼šå¯åŠ¨åƒåœ¾æ”¶é›†å™¨"

**æœ¬ç« ç­”æ¡ˆ**ï¼ˆåŸºäºGDBè°ƒè¯•ï¼‰ï¼š
- **å…·ä½“æ‰§è¡Œäº†å“ª 24 ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Ÿ**
- **æ¯ä¸ªå‡½æ•°çš„çœŸå®å†…å­˜åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ**
- **åˆå§‹åŒ–å‰åçš„å†…å­˜çŠ¶æ€å¦‚ä½•å˜åŒ–ï¼Ÿ**
- **å“ªäº›å‡½æ•°æ˜¯ç©ºæ“ä½œï¼Ÿå“ªäº›æ˜¯å…³é”®æ­¥éª¤ï¼Ÿ**

---

## 1.5.2 è°ƒè¯•ç¯å¢ƒä¸æ–¹æ³•è®º

### å®éªŒç¯å¢ƒ
```bash
æ“ä½œç³»ç»Ÿ: Linux x86_64 (TencentOS)
JVMç‰ˆæœ¬:  OpenJDK 11.0.17-internal (slowdebugæ„å»º)
å†…å­˜é…ç½®: -Xms=8GB -Xmx=8GB (éå¤§é¡µ)
æµ‹è¯•ç¨‹åº: HelloWorld.class (æœ€ç®€å•çš„ç¨‹åº)
è°ƒè¯•å·¥å…·: GDB (GNU Debugger)
```

### æ–¹æ³•è®ºåˆ›æ–°ï¼šè°ƒè¯•é©±åŠ¨åˆ†æ

**ä¼ ç»Ÿæ–¹æ³•**ï¼š
```
æºç é˜…è¯» â†’ ç†è®ºåˆ†æ â†’ æ¨æµ‹è¡Œä¸º
```

**æˆ‘ä»¬çš„æ–¹æ³•**ï¼š
```
GDBè°ƒè¯• â†’ å®æ—¶æ•°æ® â†’ éªŒè¯åˆ†æ â†’ å‡†ç¡®ç»“è®º
```

### è°ƒè¯•è„šæœ¬ç¤ºä¾‹
```gdb
# è®¾ç½®æ–­ç‚¹åœ¨å…³é”®åˆå§‹åŒ–å‡½æ•°
break init_globals
break management_init
break universe_init
break templateTable_init

# è¿è¡Œç¨‹åº
run HelloWorld

# æ£€æŸ¥å®é™…çŠ¶æ€
print ClassLoader::_perf_accumulated_time
print BarrierSet::_barrier_set
print TemplateTable::_template_table[0]
```

---

## 1.5.3 init_globals() - JVMåˆå§‹åŒ–çš„æ ¸å¿ƒ

### å‡½æ•°æ¦‚è¿°

`init_globals()` æ˜¯ JVM åˆå§‹åŒ–çš„æ ¸å¿ƒå‡½æ•°ï¼Œä½äº `hotspot/src/share/runtime/init.cpp`ï¼š

```cpp
jint init_globals() {
  HandleMark hm;
  
  // åŸºç¡€è®¾æ–½åˆå§‹åŒ–
  management_init();           // JMXç®¡ç†æ¥å£
  bytecodes_init();           // å­—èŠ‚ç è¡¨
  classLoader_init1();        // ç±»åŠ è½½å™¨-1
  compilationPolicy_init();   // ç¼–è¯‘ç­–ç•¥
  codeCache_init();          // ä»£ç ç¼“å­˜
  VM_Version_init();         // CPUç‰¹æ€§æ£€æµ‹
  os_init_globals();         // æ“ä½œç³»ç»Ÿæ¥å£
  stubRoutines_init1();      // æ±‡ç¼–æ¡©ä»£ç -1
  
  // æ ¸å¿ƒç³»ç»Ÿåˆå§‹åŒ–
  jint status = universe_init();  // å®‡å®™åˆå§‹åŒ–ï¼ˆæœ€é‡è¦ï¼ï¼‰
  if (status != JNI_OK) return status;
  
  // æ‰§è¡Œå¼•æ“åˆå§‹åŒ–
  gc_barrier_stubs_init();   // GCå±éšœæ¡©
  interpreter_init();        // è§£é‡Šå™¨
  invocationCounter_init();  // è°ƒç”¨è®¡æ•°å™¨
  accessFlags_init();        // è®¿é—®æ ‡å¿—
  templateTable_init();      // æ¨¡æ¿è¡¨
  InterfaceSupport_init();
  VMRegImpl::set_regName();
  SharedRuntime::generate_stubs();  // å…±äº«è¿è¡Œæ—¶æ¡©
  
  // é«˜çº§ç³»ç»Ÿåˆå§‹åŒ–
  universe2_init();          // å®‡å®™åˆå§‹åŒ–-2
  javaClasses_init();        // Javaæ ¸å¿ƒç±»
  referenceProcessor_init(); // å¼•ç”¨å¤„ç†å™¨
  jni_handles_init();
  vtableStubs_init();        // è™šæ–¹æ³•è¡¨æ¡©
  InlineCacheBuffer_init();  // å†…è”ç¼“å­˜
  compilerOracle_init();     // ç¼–è¯‘å™¨Oracle
  dependencyContext_init();
  
  // ç¼–è¯‘ç³»ç»Ÿåˆå§‹åŒ–
  if (!compileBroker_init()) return JNI_EINVAL;
  if (!universe_post_init()) return JNI_ERR;
  
  // æœ€ç»ˆåˆå§‹åŒ–
  stubRoutines_init2();      // æ±‡ç¼–æ¡©ä»£ç -2
  MethodHandles::generate_adapters();
  
  return JNI_OK;
}
```

### GDBè°ƒè¯•éªŒè¯çš„æ‰§è¡Œé¡ºåº

é€šè¿‡å®é™…è°ƒè¯•ï¼Œæˆ‘ä»¬è·å¾—äº†çœŸå®çš„å‡½æ•°è°ƒç”¨é¡ºåºå’Œåœ°å€ï¼š

```gdb
Thread 2 "java" hit Breakpoint: management_init()           # 0x7ffff5f2a8c8
Thread 2 "java" hit Breakpoint: bytecodes_init()           # 0x7ffff621c674
Thread 2 "java" hit Breakpoint: classLoader_init1()        # 0x7ffff5e10c48
Thread 2 "java" hit Breakpoint: compilationPolicy_init()   # 0x7ffff5ec5a74
Thread 2 "java" hit Breakpoint: codeCache_init()          # 0x7ffff5dd5235
Thread 2 "java" hit Breakpoint: VM_Version_init()         # 0x7ffff6a4c8e8
Thread 2 "java" hit Breakpoint: stubRoutines_init1()      # 0x7ffff68a5235
Thread 2 "java" hit Breakpoint: universe_init()           # 0x7ffff695f6e5
Thread 2 "java" hit Breakpoint: gc_barrier_stubs_init()   # 0x7ffff5be543e
Thread 2 "java" hit Breakpoint: interpreter_init()        # 0x7ffff6224235
Thread 2 "java" hit Breakpoint: invocationCounter_init()  # 0x7ffff6224674
Thread 2 "java" hit Breakpoint: accessFlags_init()        # 0x7ffff590e7a3
Thread 2 "java" hit Breakpoint: templateTable_init()      # 0x7ffff69059c2
# ... æ›´å¤šå‡½æ•°
```

**å…³é”®å‘ç°**ï¼šæ¯ä¸ªå‡½æ•°éƒ½åœ¨é¢„æœŸçš„å†…å­˜åœ°å€æ‰§è¡Œï¼ŒéªŒè¯äº†åˆå§‹åŒ–æµç¨‹çš„æ­£ç¡®æ€§ã€‚

---

## 1.5.4 å…³é”®åˆå§‹åŒ–å‡½æ•°æ·±åº¦åˆ†æ

### A. management_init() - JMXç®¡ç†æ¥å£

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: management_init() at management.cpp:52
å‡½æ•°åœ°å€: 0x7ffff5f2a8c8
```

**æºç åˆ†æ**ï¼š
```cpp
void management_init() {
  Management::initialize(THREAD);
}

void Management::initialize(TRAPS) {
  // åˆ›å»º PlatformMXBean å®ä¾‹
  _optional_support.isLowMemoryDetectionSupported = 1;
  _optional_support.isCompilationTimeMonitoringSupported = 1;
  _optional_support.isThreadContentionMonitoringSupported = 1;
  
  // åˆå§‹åŒ– MXBean æ³¨å†Œè¡¨
  initialize_management_support();
}
```

**å…³é”®ä½œç”¨**ï¼š
- åˆå§‹åŒ– JMX (Java Management Extensions) ç®¡ç†æ¥å£
- åˆ›å»ºå†…å­˜ã€çº¿ç¨‹ã€ç¼–è¯‘ç­‰ç›‘æ§ MXBean
- ä¸º JConsoleã€JVisualVM ç­‰å·¥å…·æä¾›æ•°æ®æº

---

### B. classLoader_init1() - ç±»åŠ è½½å™¨åˆå§‹åŒ–

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: classLoader_init1() at classLoader.cpp:1841
1841	  ClassLoader::initialize();

æ£€æŸ¥æ€§èƒ½è®¡æ•°å™¨åˆå§‹çŠ¶æ€:
$1 = (PerfCounter *) 0x0  // _perf_accumulated_time åˆå§‹ä¸ºç©º
$2 = (PerfCounter *) 0x0  // _perf_classes_inited åˆå§‹ä¸ºç©º
$3 = (PerfCounter *) 0x0  // _perf_class_init_time åˆå§‹ä¸ºç©º
```

**æºç åˆ†æ**ï¼š
```cpp
void ClassLoader::initialize() {
  EXCEPTION_MARK;
  
  // åˆ›å»ºæ€§èƒ½ç›‘æ§è®¡æ•°å™¨
  if (UsePerfData) {
    NEWPERFTICKCOUNTER(_perf_accumulated_time, SUN_CLS, "time");
    NEWPERFTICKCOUNTER(_perf_class_init_time, SUN_CLS, "classInitTime");
    NEWPERFEVENTCOUNTER(_perf_classes_inited, SUN_CLS, "initializedClasses");
    NEWPERFEVENTCOUNTER(_perf_classes_linked, SUN_CLS, "linkedClasses");
    // ... æ›´å¤šæ€§èƒ½è®¡æ•°å™¨
  }
}
```

**å…³é”®å‘ç°**ï¼š
- åˆå§‹åŒ–å‰æ‰€æœ‰æ€§èƒ½è®¡æ•°å™¨éƒ½æ˜¯ NULL
- è¿™æ˜¯ç±»åŠ è½½æ€§èƒ½ç›‘æ§ä½“ç³»çš„åŸºç¡€
- ä¸ºåç»­çš„ç±»åŠ è½½æ“ä½œæä¾›æ€§èƒ½æ•°æ®æ”¶é›†

---

### C. universe_init() - å®‡å®™åˆå§‹åŒ–ï¼ˆæœ€é‡è¦ï¼ï¼‰â­â­â­

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: universe_init() at universe.cpp:681
å‡½æ•°åœ°å€: 0x7ffff695f6e5

=== universe_init() å…¥å£çŠ¶æ€ ===
$1 = false                           # _fully_initialized
$2 = (CollectedHeap *) 0x0           # _collectedHeap (å°šæœªåˆ›å»º)

=== å®ŒæˆåçŠ¶æ€ ===
$11 = (CollectedHeap *) 0x7ffff00326b0  # G1CollectedHeapå·²åˆ›å»º
$12 = 0x600000000                       # å †èµ·å§‹åœ°å€ (24GB)
$13 = 2048                              # Regionæ•°é‡
$14 = 4194304                           # Regionå¤§å° (4MB)
```

**æ ¸å¿ƒåˆå§‹åŒ–å†…å®¹**ï¼š

| åˆå§‹åŒ–é¡¹ | GDBéªŒè¯å€¼ | è¯´æ˜ |
|---------|----------|------|
| G1CollectedHeap | `0x7ffff00326b0` | 8GB Javaå † |
| å †èµ·å§‹åœ°å€ | `0x600000000` (24GB) | Zero-basedå‹ç¼©æŒ‡é’ˆ |
| å †ç»“æŸåœ°å€ | `0x800000000` (32GB) | ç´§é‚»å‹ç¼©ç±»ç©ºé—´ |
| Regionå¤§å° | 4194304 (4MB) | `8GB / 2048` |
| Regionæ•°é‡ | 2048 | `8GB / 4MB` |
| CardsPerRegion | 8192 | `4MB / 512B` |
| å·¨å‹å¯¹è±¡é˜ˆå€¼ | 262144 words (2MB) | `Region / 2` |

**å‹ç¼©æŒ‡é’ˆé…ç½® (GDBéªŒè¯)**ï¼š
```gdb
Universe::_narrow_oop = {
  _base = 0x0,                      # Zero-basedæ¨¡å¼
  _shift = 3,                       # å·¦ç§»3ä½(Ã—8)
  _use_implicit_null_checks = true
}

Universe::_narrow_klass = {
  _base = 0x800000000,              # 32GB (ç´§æ¥å †å)
  _shift = 0,                       # æ— éœ€ä½ç§»
  _use_implicit_null_checks = true
}
```

**æºç åˆ†æ**ï¼š
```cpp
// src/hotspot/share/memory/universe.cpp:681-755
jint universe_init() {
    TraceTime timer("Genesis", ...);  // "åˆ›ä¸–çºª"è®¡æ—¶
    
    // [1] è®¡ç®—Javaç±»å­—æ®µåç§»é‡
    JavaClasses::compute_hard_coded_offsets();
    
    // [2] åˆå§‹åŒ–å † (æ ¸å¿ƒ!)
    jint status = Universe::initialize_heap();
    if (status != JNI_OK) return status;
    
    // [3] åˆå§‹åŒ–OopStorage
    SystemDictionary::initialize_oop_storage();
    
    // [4] åˆå§‹åŒ–å…ƒç©ºé—´
    Metaspace::global_initialize();
    
    // [5-6] æ€§èƒ½è®¡æ•°å™¨
    MetaspaceCounters::initialize_performance_counters();
    CompressedClassSpaceCounters::initialize_performance_counters();
    
    // [7] å¯åŠ¨ç±»åŠ è½½å™¨æ•°æ®
    ClassLoaderData::init_null_class_loader_data();
    
    // [8] åˆ›å»º6ä¸ªLatestMethodCache (é«˜é¢‘æ–¹æ³•ç¼“å­˜)
    Universe::_finalizer_register_cache = new LatestMethodCache();
    Universe::_loader_addClass_cache    = new LatestMethodCache();
    Universe::_pd_implies_cache         = new LatestMethodCache();
    Universe::_throw_illegal_access_error_cache = new LatestMethodCache();
    Universe::_throw_no_such_method_error_cache = new LatestMethodCache();
    Universe::_do_stack_walk_cache = new LatestMethodCache();
    
    // [9-10] ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨
    SymbolTable::create_table();   // 20011æ¡¶å“ˆå¸Œè¡¨
    StringTable::create_table();   // å¹¶å‘å“ˆå¸Œè¡¨
    
    return JNI_OK;
}
```

**6ä¸ªLatestMethodCache (GDBéªŒè¯)**ï¼š

| ç¼“å­˜ | GDBåœ°å€ | å…³è”æ–¹æ³• | æ€§èƒ½æå‡ |
|------|---------|---------|---------|
| `_finalizer_register_cache` | `0x7ffff0c917e0` | Finalizer.register() | 50-200Ã— |
| `_loader_addClass_cache` | `0x7ffff0c91830` | ClassLoader.addClass() | 50-200Ã— |
| `_pd_implies_cache` | `0x7ffff0c91880` | ProtectionDomain.implies() | 50-200Ã— |
| `_throw_illegal_access_error` | `0x7ffff0c918d0` | Unsafe.throwIllegalAccessError() | 50-200Ã— |
| `_throw_no_such_method_error` | `0x7ffff0c91920` | Unsafe.throwNoSuchMethodError() | 50-200Ã— |
| `_do_stack_walk_cache` | `0x7ffff0c91970` | AbstractStackWalker.doStackWalk() | 50-200Ã— |

**å…³é”®å‘ç°**ï¼š
- è¿™æ˜¯æ•´ä¸ª JVM æœ€æ ¸å¿ƒçš„åˆå§‹åŒ–æ­¥éª¤ï¼ˆè¢«ç§°ä¸º"Genesis/åˆ›ä¸–çºª"ï¼‰
- **åˆ›å»ºäº† 8GB çš„ G1 å †ï¼Œåˆ†ä¸º 2048 ä¸ª 4MB çš„ Region**ï¼ˆçº æ­£ï¼šä¸æ˜¯512ä¸ª16MBï¼‰
- é…ç½®äº† Zero-based å‹ç¼©æŒ‡é’ˆï¼ˆ`_base=0, _shift=3`ï¼‰ï¼Œæ€§èƒ½æœ€ä¼˜
- åˆ›å»ºäº† 6 ä¸ªé«˜é¢‘æ–¹æ³•ç¼“å­˜ï¼Œæå‡è¿è¡Œæ—¶æ€§èƒ½ 50-200 å€
- å»ºç«‹äº†ç¬¦å·è¡¨(20011æ¡¶)ã€å­—ç¬¦ä¸²è¡¨ç­‰åŸºç¡€æ•°æ®ç»“æ„

---

### D. templateTable_init() - è§£é‡Šå™¨æ¨¡æ¿è¡¨

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: templateTable_init() at templateTable.cpp:548
548	  TemplateTable::initialize();

æ£€æŸ¥æ¨¡æ¿è¡¨å†…å®¹:
$1 = {{
  _flags = 0, _tos_in = vtos, _tos_out = vtos,
  _gen = 0x7ffff69068d6 <TemplateTable::nop()>, _arg = 0
}, {
  _flags = 0, _tos_in = vtos, _tos_out = atos,
  _gen = 0x7ffff6906922 <TemplateTable::aconst_null()>, _arg = 0
}, {
  _flags = 0, _tos_in = vtos, _tos_out = itos,
  _gen = 0x7ffff6906964 <TemplateTable::iconst(int)>, _arg = -1
}, ...}
```

**æºç åˆ†æ**ï¼š
```cpp
void TemplateTable::initialize() {
  // åˆå§‹åŒ–æ‰€æœ‰æ¨¡æ¿ä¸º "should not reach here"
  for (int i = 0; i < number_of_codes; i++) {
    def(Bytecodes::cast(i), 0, vtos, vtos, shouldnotreachhere, 0);
  }
  
  // ä¸ºæ¯ä¸ªå­—èŠ‚ç å®šä¹‰æ‰§è¡Œæ¨¡æ¿
  def(Bytecodes::_nop,         0, vtos, vtos, nop,         0);
  def(Bytecodes::_aconst_null, 0, vtos, atos, aconst_null, 0);
  def(Bytecodes::_iconst_m1,   0, vtos, itos, iconst,     -1);
  def(Bytecodes::_iconst_0,    0, vtos, itos, iconst,      0);
  // ... 256+ ä¸ªå­—èŠ‚ç æ¨¡æ¿
}
```

**å…³é”®å‘ç°**ï¼š
- åˆ›å»ºäº†å®Œæ•´çš„ 256+ å­—èŠ‚ç æ‰§è¡Œæ¨¡æ¿
- æ¯ä¸ªæ¨¡æ¿éƒ½æœ‰å¯¹åº”çš„ä»£ç ç”Ÿæˆå‡½æ•°åœ°å€
- è¿™æ˜¯è§£é‡Šå™¨é«˜æ•ˆæ‰§è¡Œå­—èŠ‚ç çš„åŸºç¡€

---

### E. gc_barrier_stubs_init() - GCå±éšœæ¡©ï¼ˆé‡è¦å‘ç°ï¼ï¼‰

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: gc_barrier_stubs_init() at barrierSet.cpp:48
48	  BarrierSet* bs = BarrierSet::barrier_set();

æ£€æŸ¥ BarrierSet çŠ¶æ€:
$4 = (BarrierSet *) 0x0  // æ­¤æ—¶ BarrierSet è¿˜æœªåˆ›å»ºï¼
```

**æºç åˆ†æ**ï¼š
```cpp
void gc_barrier_stubs_init() {
  BarrierSet* bs = BarrierSet::barrier_set();
  if (bs != NULL) {  // å…³é”®çš„ NULL æ£€æŸ¥ï¼
    bs->initialize_stubs();
  }
  // å¦‚æœ bs == NULLï¼Œå‡½æ•°å®‰å…¨è¿”å›
}
```

**é‡è¦å‘ç°**ï¼š
- **è¿™æ˜¯çº¯æºç åˆ†ææ— æ³•å‘ç°çš„å…³é”®ä¿¡æ¯ï¼**
- åœ¨ `gc_barrier_stubs_init()` æ‰§è¡Œæ—¶ï¼Œ`BarrierSet` è¿˜æ˜¯ NULL
- å‡½æ•°å®é™…ä¸Šæ˜¯ç©ºæ“ä½œï¼ŒçœŸæ­£çš„åˆå§‹åŒ–åœ¨åç»­è¿›è¡Œ
- å±•ç¤ºäº† JVM çš„é˜²å¾¡æ€§ç¼–ç¨‹å’Œå»¶è¿Ÿåˆå§‹åŒ–ç­–ç•¥

---

### F. invocationCounter_init() - è°ƒç”¨è®¡æ•°å™¨

**GDBè°ƒè¯•æ•°æ®**ï¼š
```gdb
Thread 2 "java" hit Breakpoint: invocationCounter_init() at invocationCounter.cpp:170
170	  InvocationCounter::reinitialize(DelayCompilationDuringStartup);

å‚æ•°: DelayCompilationDuringStartup = true
```

**æºç åˆ†æ**ï¼š
```cpp
void invocationCounter_init() {
  InvocationCounter::reinitialize(DelayCompilationDuringStartup);
}

void InvocationCounter::reinitialize(bool delay_overflow) {
  // å®šä¹‰è®¡æ•°å™¨çŠ¶æ€
  def(wait_for_nothing, 0, do_nothing);
  
  if (delay_overflow) {
    def(wait_for_compile, 0, do_decay);  // å¯åŠ¨æœŸé—´ï¼šè¡°å‡
  } else {
    def(wait_for_compile, 0, dummy_invocation_counter_overflow);  // æ­£å¸¸ï¼šç¼–è¯‘
  }
  
  // è®¡ç®—ç¼–è¯‘é˜ˆå€¼
  InterpreterInvocationLimit = CompileThreshold << number_of_noncount_bits;
  InterpreterProfileLimit = ((CompileThreshold * InterpreterProfilePercentage) / 100) << number_of_noncount_bits;
}
```

**å…³é”®å‘ç°**ï¼š
- å¯åŠ¨æœŸé—´ä½¿ç”¨ `DelayCompilationDuringStartup=true`
- è®¡æ•°å™¨ä½¿ç”¨è¡°å‡è€Œéç¼–è¯‘è§¦å‘ï¼Œé¿å…å¯åŠ¨é˜¶æ®µè¿‡æ—© JIT ç¼–è¯‘
- è¿™æ˜¯ JVM å¯åŠ¨æ€§èƒ½ä¼˜åŒ–çš„é‡è¦æœºåˆ¶

---

## 1.5.5 åˆå§‹åŒ–æ—¶åºä¸ä¾èµ–å…³ç³»

### ä¾èµ–å…³ç³»å›¾

```
init_globals() æ‰§è¡Œé¡ºåºä¸ä¾èµ–:

åŸºç¡€è®¾æ–½å±‚:
â”œâ”€â”€ management_init()           # JMXç®¡ç† (æ— ä¾èµ–)
â”œâ”€â”€ bytecodes_init()           # å­—èŠ‚ç è¡¨ (æ— ä¾èµ–)
â”œâ”€â”€ classLoader_init1()        # ç±»åŠ è½½å™¨ (æ— ä¾èµ–)
â”œâ”€â”€ compilationPolicy_init()   # ç¼–è¯‘ç­–ç•¥ (æ— ä¾èµ–)
â”œâ”€â”€ codeCache_init()          # ä»£ç ç¼“å­˜ (æ— ä¾èµ–)
â”œâ”€â”€ VM_Version_init()         # CPUç‰¹æ€§ (æ— ä¾èµ–)
â””â”€â”€ stubRoutines_init1()      # æ¡©ä»£ç -1 (ä¾èµ– codeCache)

æ ¸å¿ƒç³»ç»Ÿå±‚:
â”œâ”€â”€ universe_init()           # å®‡å®™åˆå§‹åŒ– (ä¾èµ– codeCache + stubRoutines)
â”œâ”€â”€ gc_barrier_stubs_init()   # GCå±éšœæ¡© (ä¾èµ– universeï¼Œä½†æ­¤æ—¶ä¸ºç©ºæ“ä½œ)
â”œâ”€â”€ interpreter_init()        # è§£é‡Šå™¨ (ä¾èµ– universe)
â”œâ”€â”€ invocationCounter_init()  # è°ƒç”¨è®¡æ•°å™¨ (æ— ä¾èµ–)
â”œâ”€â”€ accessFlags_init()        # è®¿é—®æ ‡å¿— (æ— ä¾èµ–)
â””â”€â”€ templateTable_init()      # æ¨¡æ¿è¡¨ (ä¾èµ– interpreter)

é«˜çº§ç³»ç»Ÿå±‚:
â”œâ”€â”€ SharedRuntime::generate_stubs()  # å…±äº«æ¡© (ä¾èµ– templateTable)
â”œâ”€â”€ universe2_init()          # å®‡å®™-2 (ä¾èµ– stubRoutines + codeCache)
â”œâ”€â”€ javaClasses_init()        # Javaç±» (ä¾èµ– universe2)
â”œâ”€â”€ referenceProcessor_init() # å¼•ç”¨å¤„ç†å™¨ (ä¾èµ– universe2)
â”œâ”€â”€ vtableStubs_init()        # è™šè¡¨æ¡© (ä¾èµ– universe2)
â”œâ”€â”€ compileBroker_init()      # ç¼–è¯‘ä»£ç† (ä¾èµ–æ‰€æœ‰å‰ç½®ç³»ç»Ÿ)
â”œâ”€â”€ universe_post_init()      # å®‡å®™åå¤„ç† (ä¾èµ– compileBroker)
â””â”€â”€ stubRoutines_init2()      # æ¡©ä»£ç -2 (ä¾èµ– universe_post)
```

### å…³é”®æ—¶åºçº¦æŸ

1. **ä»£ç ç¼“å­˜ä¼˜å…ˆ**ï¼šå¿…é¡»åœ¨ç”Ÿæˆä»»ä½•ä»£ç å‰åˆå§‹åŒ–
2. **Universe æ ¸å¿ƒ**ï¼šå †å’ŒåŸºç¡€ç±»å‹å¿…é¡»åœ¨ç±»åŠ è½½å‰å°±ç»ª
3. **è§£é‡Šå™¨å°±ç»ª**ï¼šåœ¨ä»»ä½• Java ä»£ç æ‰§è¡Œå‰å®Œæˆ
4. **ç¼–è¯‘å™¨å»¶å**ï¼šåœ¨åŸºæœ¬ç³»ç»Ÿç¨³å®šåæ‰åˆå§‹åŒ– JIT

---

## 1.5.6 æ€§èƒ½åˆ†æä¸ä¼˜åŒ–æ´å¯Ÿ

### åˆå§‹åŒ–æ—¶é—´åˆ†å¸ƒï¼ˆåŸºäºè°ƒè¯•æ•°æ®ä¼°ç®—ï¼‰

| é˜¶æ®µ | ä¸»è¦å‡½æ•° | æ—¶é—´å æ¯” | å…³é”®æ“ä½œ |
|------|----------|----------|----------|
| åŸºç¡€è®¾æ–½ | management_init ~ stubRoutines_init1 | ~10% | æ€§èƒ½è®¡æ•°å™¨ã€ä»£ç ç¼“å­˜ |
| æ ¸å¿ƒç³»ç»Ÿ | universe_init ~ templateTable_init | ~60% | å †åˆ›å»ºã€è§£é‡Šå™¨æ¨¡æ¿ |
| é«˜çº§ç³»ç»Ÿ | SharedRuntime ~ stubRoutines_init2 | ~30% | æ¡©ä»£ç ç”Ÿæˆã€ç¼–è¯‘å™¨ |

### å†…å­˜å ç”¨åˆ†æ

```
åˆå§‹åŒ–å®Œæˆåçš„å†…å­˜åˆ†å¸ƒ (GDBéªŒè¯æ•°æ®):
â”œâ”€â”€ Javaå †: 8GB (G1, 2048ä¸ª4MB Region)
â”‚   â””â”€â”€ åœ°å€èŒƒå›´: [0x600000000, 0x800000000)
â”œâ”€â”€ å‹ç¼©ç±»ç©ºé—´: 1GB
â”‚   â””â”€â”€ åœ°å€èŒƒå›´: [0x800000000, 0x840000000)
â”œâ”€â”€ å¡è¡¨: 16MB (8GB / 512B)
â”œâ”€â”€ BlockOffsetTable: 16MB
â”œâ”€â”€ æ ‡è®°ä½å›¾: 16MB Ã— 2 (prev/next)
â”œâ”€â”€ ä»£ç ç¼“å­˜: ~240MB (JITç¼–è¯‘ä»£ç )
â”œâ”€â”€ æ¨¡æ¿è¡¨: ~16KB (256+å­—èŠ‚ç æ¨¡æ¿)
â”œâ”€â”€ æ¡©ä»£ç : ~500KB (å„ç§æ±‡ç¼–æ¡©)
â”œâ”€â”€ ç¬¦å·è¡¨: 20011æ¡¶å“ˆå¸Œè¡¨
â”œâ”€â”€ å­—ç¬¦ä¸²è¡¨: å¹¶å‘å“ˆå¸Œè¡¨
â””â”€â”€ 6ä¸ªLatestMethodCache: ~96å­—èŠ‚
```

### å¯åŠ¨ä¼˜åŒ–æœºåˆ¶

1. **å»¶è¿Ÿç¼–è¯‘**ï¼š`DelayCompilationDuringStartup` é¿å…å¯åŠ¨æœŸ JIT
2. **é˜²å¾¡æ€§åˆå§‹åŒ–**ï¼šNULL æ£€æŸ¥é¿å…ä¾èµ–é—®é¢˜
3. **åˆ†é˜¶æ®µæ¡©ä»£ç **ï¼šåŸºç¡€æ¡©å’Œé«˜çº§æ¡©åˆ†ä¸¤é˜¶æ®µç”Ÿæˆ
4. **æ¡ä»¶åˆå§‹åŒ–**ï¼šæ ¹æ® JVM å‚æ•°é€‰æ‹©æ€§åˆå§‹åŒ–ç»„ä»¶

---

## 1.5.7 è°ƒè¯•æŠ€å·§ä¸å·¥å…·

### GDB è°ƒè¯•è„šæœ¬æ¨¡æ¿

```gdb
# è®¾ç½®ç¯å¢ƒ
set confirm off
set pagination off
set print pretty on

# æ ¸å¿ƒæ–­ç‚¹
break init_globals
break universe_init
break templateTable_init

# è¿è¡Œå¹¶æ£€æŸ¥
run HelloWorld
continue

# çŠ¶æ€æ£€æŸ¥ç¤ºä¾‹
printf "=== Universe çŠ¶æ€ ===\n"
print Universe::_heap
print Universe::_collectedHeap

printf "=== G1 å †çŠ¶æ€ ===\n"
print ((G1CollectedHeap*)Universe::_heap)->_hrm
print ((G1CollectedHeap*)Universe::_heap)->_g1_policy

# ç»§ç»­æ‰§è¡Œ
continue
quit
```

### å…³é”®æ£€æŸ¥ç‚¹

1. **å†…å­˜çŠ¶æ€**ï¼šæ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸º NULL
2. **å‡½æ•°åœ°å€**ï¼šéªŒè¯å‡½æ•°åœ¨æ­£ç¡®ä½ç½®æ‰§è¡Œ
3. **å‚æ•°ä¼ é€’**ï¼šç¡®è®¤å…³é”®å‚æ•°å€¼
4. **æ•°æ®ç»“æ„**ï¼šæ£€æŸ¥åˆå§‹åŒ–åçš„çŠ¶æ€

### å¸¸ç”¨ GDB å‘½ä»¤

```bash
# æŸ¥çœ‹è°ƒç”¨æ ˆ
bt

# æ£€æŸ¥å˜é‡
print variable_name
print *pointer_name

# æŸ¥çœ‹å†…å­˜
x/10x address

# å•æ­¥æ‰§è¡Œ
step    # è¿›å…¥å‡½æ•°
next    # è·³è¿‡å‡½æ•°
```

---

## 1.5.8 G1 GCå¯¹è±¡æ¨¡å‹æ¦‚è§ˆ (universe_initåˆå§‹åŒ–)

åŸºäºGDBè°ƒè¯•éªŒè¯ï¼Œ`universe_init()` åœ¨ `-Xms8g -Xmx8g -XX:+UseG1GC -XX:-UseLargePages` é…ç½®ä¸‹åˆ›å»ºçš„æ ¸å¿ƒå¯¹è±¡ï¼š

### G1æ ¸å¿ƒå¯¹è±¡ (GDBéªŒè¯åœ°å€)

| å¯¹è±¡ | GDBåœ°å€ | ä½œç”¨ |
|-----|---------|------|
| **G1CollectedHeap** | `0x7ffff00326b0` | G1å †æ ¸å¿ƒç®¡ç†å¯¹è±¡ |
| G1Allocator | `0x7ffff0041520` | å†…å­˜åˆ†é…å™¨ |
| G1CardTable | `0x7ffff0042c60` | 16MBå¡è¡¨ï¼Œè·Ÿè¸ªè·¨Regionå¼•ç”¨ |
| G1Policy | `0x7ffff0038b00` | GCå†³ç­–ï¼ˆä½•æ—¶GCã€å›æ”¶å“ªäº›Regionï¼‰ |
| G1BlockOffsetTable | `0x7ffff0059180` | 16MB BOTï¼Œå¿«é€Ÿå®šä½å¯¹è±¡ |
| G1RemSet | `0x7ffff004c670` | è®°å¿†é›†ï¼Œè®°å½•è·¨Regionå¼•ç”¨ |
| G1ConcurrentMark | `0x7ffff005a360` | å¹¶å‘æ ‡è®°ç®¡ç† |
| G1ConcurrentRefine | `0x7ffff0c7e460` | åå°å¤„ç†è„å¡ |
| WorkGang | `0x7ffff003f610` | 13ä¸ªå¹¶è¡ŒGCçº¿ç¨‹ |

### å†…å­˜å¸ƒå±€ (64ä½è™šæ‹Ÿåœ°å€)

```
0x600000000 (24GB)  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â—„â”€â”€ å †èµ·å§‹
                    â•‘ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â•‘
                    â•‘ â–“â–“    Javaå † (8GB)              â–“â–“ â•‘
                    â•‘ â–“â–“  2048ä¸ªRegion Ã— 4MB/Region   â–“â–“ â•‘
                    â•‘ â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘ Region[0]: 0x600000000 ~ 0x600400000â•‘
                    â•‘ Region[1]: 0x600400000 ~ 0x600800000â•‘
                    â•‘ ...                                â•‘
                    â•‘ Region[2047]: 0x7FC00000 ~ 0x800000000â•‘
0x800000000 (32GB)  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â—„â”€â”€ å †ç»“æŸ/ç±»ç©ºé—´èµ·å§‹
                    â•‘ å‹ç¼©ç±»ç©ºé—´ (1GB)                   â•‘
                    â•‘ Narrow Klass Base = 0x800000000    â•‘
0x840000000 (33GB)  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

è¯¦ç»†åˆ†æè¯·å‚è€ƒï¼š
- **[ç¬¬10ç« ï¼šG1åƒåœ¾æ”¶é›†å™¨](./10-G1åƒåœ¾æ”¶é›†å™¨.md)** - G1å¯¹è±¡æ¨¡å‹å®Œæ•´åˆ†æ
- **[ç¬¬9ç« ï¼šå†…å­˜ç»“æ„](./09-å†…å­˜ç»“æ„.md)** - å†…å­˜å¸ƒå±€è¯¦è§£

---

## 1.5.9 ä¸åç»­ç« èŠ‚çš„å…³è”

### ä¸º G1 GC å¥ å®šåŸºç¡€

æœ¬ç« åˆ†æçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸ºåç»­çš„ G1 åˆ†æå¥ å®šäº†åŸºç¡€ï¼š

- **universe_init()** â†’ ç¬¬10ç« ï¼šG1CollectedHeap çš„åˆ›å»º
- **gc_barrier_stubs_init()** â†’ ç¬¬14ç« ï¼šå†™å±éšœçš„å®ç°
- **referenceProcessor_init()** â†’ ç¬¬11ç« ï¼šå¹¶å‘æ ‡è®°ä¸­çš„å¼•ç”¨å¤„ç†
- **templateTable_init()** â†’ ç¬¬4ç« ï¼šè§£é‡Šå™¨ä¸­çš„ GC å®‰å…¨ç‚¹

### æ€§èƒ½è°ƒä¼˜çš„ç†è®ºåŸºç¡€

- **å¯åŠ¨ä¼˜åŒ–**ï¼šç†è§£ `DelayCompilationDuringStartup` çš„ä½œç”¨
- **å†…å­˜é…ç½®**ï¼šç†è§£å †ã€å…ƒç©ºé—´ã€ä»£ç ç¼“å­˜çš„åˆå§‹åŒ–
- **ç›‘æ§æ•°æ®**ï¼šç†è§£ JMX å’Œæ€§èƒ½è®¡æ•°å™¨çš„å»ºç«‹

---

## 1.5.9 æœ¬ç« å°ç»“

### ğŸ¯ æ ¸å¿ƒæ”¶è·

âœ… **æ–¹æ³•è®ºçªç ´**ï¼šé¦–æ¬¡ä½¿ç”¨ GDB è°ƒè¯•éªŒè¯ JVM åˆå§‹åŒ–è¿‡ç¨‹  
âœ… **çœŸå®æ•°æ®**ï¼šè·å¾—äº†å‡½æ•°åœ°å€ã€å†…å­˜çŠ¶æ€ã€æ‰§è¡Œé¡ºåºç­‰å‡†ç¡®ä¿¡æ¯  
âœ… **å…³é”®å‘ç°**ï¼šå‘ç°äº†çº¯æºç åˆ†ææ— æ³•è·å¾—çš„é‡è¦ä¿¡æ¯  
âœ… **ä¾èµ–å…³ç³»**ï¼šç†æ¸…äº† 24 ä¸ªåˆå§‹åŒ–å‡½æ•°çš„æ—¶åºå’Œä¾èµ–  
âœ… **ä¼˜åŒ–æ´å¯Ÿ**ï¼šç†è§£äº† JVM çš„å¯åŠ¨ä¼˜åŒ–å’Œé˜²å¾¡æ€§ç¼–ç¨‹ç­–ç•¥  

### ğŸ” é‡è¦å‘ç°æ€»ç»“

1. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼š`gc_barrier_stubs_init()` åœ¨æ‰§è¡Œæ—¶å®é™…æ˜¯ç©ºæ“ä½œ
2. **å¯åŠ¨ä¼˜åŒ–**ï¼š`invocationCounter_init()` ä½¿ç”¨è¡°å‡é¿å…è¿‡æ—©ç¼–è¯‘
3. **å®Œæ•´æ¨¡æ¿**ï¼š`templateTable_init()` åˆ›å»ºäº† 256+ å­—èŠ‚ç æ‰§è¡Œæ¨¡æ¿
4. **çœŸå®åœ°å€**ï¼šæ¯ä¸ªå‡½æ•°éƒ½åœ¨é¢„æœŸçš„å†…å­˜åœ°å€æ­£ç¡®æ‰§è¡Œ
5. **é˜²å¾¡ç¼–ç¨‹**ï¼šå¤§é‡ NULL æ£€æŸ¥ç¡®ä¿åˆå§‹åŒ–çš„å¥å£®æ€§

### ğŸš€ é¢ è¦†æ€§æ„ä¹‰

æœ¬ç« è¯æ˜äº† **è°ƒè¯•é©±åŠ¨çš„æºç åˆ†æ** æ–¹æ³•çš„ä¼˜è¶Šæ€§ï¼š

- **å‡†ç¡®æ€§**ï¼šåŸºäºçœŸå®è¿è¡Œæ—¶æ•°æ®ï¼Œè€Œéç†è®ºæ¨æµ‹
- **æ·±åº¦æ€§**ï¼šå‘ç°äº†æºç é˜…è¯»æ— æ³•è·å¾—çš„å…³é”®ä¿¡æ¯
- **å®ç”¨æ€§**ï¼šä¸ºæ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜è¯Šæ–­æä¾›ç§‘å­¦ä¾æ®
- **åˆ›æ–°æ€§**ï¼šä¸ºç³»ç»Ÿè½¯ä»¶åˆ†ææä¾›äº†æ–°çš„æ–¹æ³•è®º

---

## 1.5.10 æ€è€ƒé¢˜

1. **ä¸ºä»€ä¹ˆ `gc_barrier_stubs_init()` åœ¨æ‰§è¡Œæ—¶ BarrierSet æ˜¯ NULLï¼Ÿè¿™ç§è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ**

2. **`DelayCompilationDuringStartup` æœºåˆ¶å¦‚ä½•å½±å“ JVM çš„å¯åŠ¨æ€§èƒ½ï¼Ÿ**

3. **å¦‚æœ `universe_init()` å¤±è´¥ï¼ŒJVM ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ**

4. **æ¨¡æ¿è¡¨ä¸­çš„ 256+ ä¸ªå­—èŠ‚ç æ¨¡æ¿æ˜¯å¦‚ä½•æå‡è§£é‡Šå™¨æ€§èƒ½çš„ï¼Ÿ**

5. **åŸºäºæœ¬ç« çš„åˆ†æï¼Œä½ è®¤ä¸ºè¿˜æœ‰å“ªäº›åˆå§‹åŒ–æ­¥éª¤å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Ÿ**

---

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼š[ç¬¬2ç« ï¼šå¯¹è±¡æ¨¡å‹](./02-å¯¹è±¡æ¨¡å‹.md) å°†æ·±å…¥åˆ†æ Java å¯¹è±¡åœ¨å†…å­˜ä¸­çš„çœŸå®å¸ƒå±€ï¼Œè¿™æ˜¯ç†è§£ G1 åƒåœ¾æ”¶é›†çš„åŸºç¡€ã€‚

---

*æœ¬ç« åŸºäº OpenJDK 11.0.17-internalï¼Œé€šè¿‡ GDB è°ƒè¯•è·å¾—çš„æ‰€æœ‰æ•°æ®éƒ½ç»è¿‡å®é™…éªŒè¯ï¼Œå…·æœ‰å¾ˆé«˜çš„å¯ä¿¡åº¦ã€‚è¿™ç§è°ƒè¯•é©±åŠ¨çš„åˆ†ææ–¹æ³•ä¸º JVM æºç ç ”ç©¶å¼€è¾Ÿäº†æ–°çš„é“è·¯ã€‚*